var Amity=function(e){"use strict";const t=Object.freeze({FILE:"file",IMAGE:"image",VIDEO:"video"}),n=Object.freeze({"1080P":"1080p","720P":"720p","480P":"480p","360P":"360p",ORIGINAL:"original"}),r=Object.freeze({UPLOADED:"uploaded",TRANSCODING:"transcoding",TRANSCODED:"transcoded",TRANSCODE_FAILED:"transcodeFailed"}),s=Object.freeze({LOW:"low",MEDIUM:"medium",HIGH:"high",ORIGINAL:"original"});var i;e.FileAccessTypeEnum=void 0,(i=e.FileAccessTypeEnum||(e.FileAccessTypeEnum={})).PUBLIC="public",i.NETWORK="network";const a=Object.freeze({ONLY_ADMIN_CAN_POST:"ONLY_ADMIN_CAN_POST",ADMIN_REVIEW_POST_REQUIRED:"ADMIN_REVIEW_POST_REQUIRED",ANYONE_CAN_POST:"ANYONE_CAN_POST"}),o=Object.freeze({ONLY_ADMIN_CAN_POST:{needApprovalOnPostCreation:!1,onlyAdminCanPost:!0},ADMIN_REVIEW_POST_REQUIRED:{needApprovalOnPostCreation:!0,onlyAdminCanPost:!1},ANYONE_CAN_POST:{needApprovalOnPostCreation:!1,onlyAdminCanPost:!1}}),l="ONLY_ADMIN_CAN_POST",c=Object.freeze({STORY:"story",CLIP:"clip",CHAT:"chat",POST:"post",MESSAGE:"message"}),d=Object.freeze({TEXT:"text",IMAGE:"image",FILE:"file",VIDEO:"video",AUDIO:"audio",CUSTOM:"custom"}),u=Object.freeze({TEXT:"text",IMAGE:"image",FILE:"file",VIDEO:"video",LIVESTREAM:"liveStream",POLL:"poll"});const h=function(){try{return"v7.3.0-umd"}catch(e){return"__dev__"}}(),f=5,p="cache_then_server",g="For using Live Collection feature you need to enable Cache!",m="Observing unsynced object is not supported by Live Object.",y=-5,v=1e3,b=6e5,w="dead",S=6e4,C=e=>JSON.stringify(e,((e,t)=>{return"object"==typeof t?(n=t,Object.keys(n).sort().reduce(((e,t)=>Object.assign(Object.assign({},e),{[t]:n[t]})),{})):t;var n})),T=e=>JSON.parse(e),E=(e,t)=>e===t||!(!e||!t)&&("object"==typeof e&&Object.keys(e).every((n=>E(e[n],t[n])))),I=e=>[400400,400300].includes(e),k="function"==typeof atob,A="function"==typeof btoa,_="function"==typeof Buffer,R="function"==typeof TextDecoder?new TextDecoder:void 0,O="function"==typeof TextEncoder?new TextEncoder:void 0,L=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),D=(e=>{let t={};return e.forEach(((e,n)=>t[e]=n)),t})(L),x=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,P=String.fromCharCode.bind(String),M="function"==typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):(e,t=(e=>e))=>new Uint8Array(Array.prototype.slice.call(e,0).map(t)),F=e=>e.replace(/[^A-Za-z0-9\+\/]/g,""),U=A?e=>btoa(e):_?e=>Buffer.from(e,"binary").toString("base64"):e=>{let t,n,r,s,i="";const a=e.length%3;for(let a=0;a<e.length;){if((n=e.charCodeAt(a++))>255||(r=e.charCodeAt(a++))>255||(s=e.charCodeAt(a++))>255)throw new TypeError("invalid character found");t=n<<16|r<<8|s,i+=L[t>>18&63]+L[t>>12&63]+L[t>>6&63]+L[63&t]}return a?i.slice(0,a-3)+"===".substring(a):i},N=_?e=>Buffer.from(e).toString("base64"):e=>{let t=[];for(let n=0,r=e.length;n<r;n+=4096)t.push(P.apply(null,e.subarray(n,n+4096)));return U(t.join(""))},B=e=>{if(e.length<2)return(t=e.charCodeAt(0))<128?e:t<2048?P(192|t>>>6)+P(128|63&t):P(224|t>>>12&15)+P(128|t>>>6&63)+P(128|63&t);var t=65536+1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320);return P(240|t>>>18&7)+P(128|t>>>12&63)+P(128|t>>>6&63)+P(128|63&t)},j=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,$=_?e=>Buffer.from(e,"utf8").toString("base64"):O?e=>N(O.encode(e)):e=>U(e.replace(j,B)),q=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,K=e=>{switch(e.length){case 4:var t=((7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3))-65536;return P(55296+(t>>>10))+P(56320+(1023&t));case 3:return P((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return P((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},G=k?e=>atob(F(e)):_?e=>Buffer.from(e,"base64").toString("binary"):e=>{if(e=e.replace(/\s+/g,""),!x.test(e))throw new TypeError("malformed base64.");e+="==".slice(2-(3&e.length));let t,n,r,s="";for(let i=0;i<e.length;)t=D[e.charAt(i++)]<<18|D[e.charAt(i++)]<<12|(n=D[e.charAt(i++)])<<6|(r=D[e.charAt(i++)]),s+=64===n?P(t>>16&255):64===r?P(t>>16&255,t>>8&255):P(t>>16&255,t>>8&255,255&t);return s},H=_?e=>M(Buffer.from(e,"base64")):e=>M(G(e),(e=>e.charCodeAt(0))),V=_?e=>Buffer.from(e,"base64").toString("utf8"):R?e=>R.decode(H(e)):e=>G(e).replace(q,K),z=e=>V(F(e.replace(/[-_]/g,(e=>"-"==e?"+":"/")))),W=e=>["skip"].some((t=>t in e)),Y=e=>["after","before","first","last","limit"].some((t=>t in e)),Q=e=>"limit"in e,X=e=>(null==e?void 0:e.hasOwnProperty("data"))&&(null==e?void 0:e.hasOwnProperty("nextPage"))&&(null==e?void 0:e.hasOwnProperty("prevPage")),J=(e,t)=>{var n;if(!e||!Object.keys(e).length)return;let r={};return"skiplimit"===t?r={skip:null!==(n=e.after)&&void 0!==n?n:0,limit:e.limit}:"afterbefore"===t&&Y(e)?((null==e?void 0:e.before)&&(r=Object.assign(Object.assign({},r),{before:e.before})),(null==e?void 0:e.after)&&(r=Object.assign(Object.assign({},r),{after:e.after})),Number.isNaN(Number(null==e?void 0:e.limit))||(r=Object.assign(Object.assign({},r),{limit:e.limit}))):"afterbeforeraw"===t&&(r=e),Object.keys(r).length?((e,t=!1)=>t?(e=>e.replace(/=/g,"").replace(/[+\/]/g,(e=>"+"==e?"-":"_")))($(e)):$(e))(JSON.stringify(r)):void 0},Z=e=>{if(!e)return;const t=JSON.parse(z(e));if(W(t))return{after:t.skip,limit:t.limit};if(Y(t)){if("before"in t)return{before:t.before,limit:t.last};if("after"in t)return{after:t.after,limit:t.first}}},ee=e=>"locally"in e,te=e=>"optimistically"in e,ne=e=>ee(e)||te(e),re=e=>null==e?void 0:e.hasOwnProperty("cachedAt"),se=(e,t=6e4)=>{var n;return Date.now()-(null!==(n=null==e?void 0:e.cachedAt)&&void 0!==n?n:0)<=t},ie=(e,...t)=>({func:e,args:t}),ae=(e,t=6e4)=>"cache_only"===e?{lifeSpan:1/0}:{lifeSpan:t<S?S:t},oe=({func:e,args:t},n,r=ae("cache_then_server"))=>{let s;const{lifeSpan:i}=ae("cache_then_server",r.lifeSpan);if(ne(e)){try{s=te(e)?e.optimistically(...t):e.locally(...t)}catch(e){null==n||n(le(void 0,{origin:"local",loading:!1,error:e}))}const r=re(s)&&se(s,i);if(null==n||n(le(s,{origin:"local",loading:!(ee(e)&&r)})),r)return}else null==n||n(le(void 0,{origin:"local",loading:!0}));e(...t).then((e=>{null==n||n(le(e,{origin:"server",loading:!1}))})).catch((e=>{null==n||n(le(void 0,{origin:"server",loading:!1,error:e}))}))};function le(e,t){return X(e)||re(e)?Object.assign(Object.assign({},t),e):Object.assign(Object.assign({},t),{data:e})}const ce={user:({userId:e})=>e,file:({fileId:e})=>e,role:({roleId:e})=>e,channel:({channelInternalId:e})=>e,subChannel:({subChannelId:e})=>e,channelUsers:({channelId:e,userId:t})=>`${e}#${t}`,message:({messageId:e,referenceId:t})=>null!=t?t:e,messagePreviewChannel:({channelId:e})=>`${e}`,messagePreviewSubChannel:({subChannelId:e})=>`${e}`,channelUnreadInfo:({channelId:e})=>e,subChannelUnreadInfo:({subChannelId:e})=>e,channelUnread:({channelId:e})=>e,channelMarker:({entityId:e,userId:t})=>`${e}#${t}`,subChannelMarker:({entityId:e,feedId:t,userId:n})=>`${e}#${t}#${n}`,messageMarker:({feedId:e,contentId:t,creatorId:n})=>`${e}#${t}#${n}`,feedMarker:({feedId:e,entityId:t})=>`${e}#${t}`,userMarker:({userId:e})=>e,community:({communityId:e})=>e,category:({categoryId:e})=>e,communityUsers:({communityId:e,userId:t})=>`${e}#${t}`,post:({postId:e})=>e,comment:({commentId:e})=>e,commentChildren:({commentId:e})=>e,poll:({pollId:e})=>e,reaction:({referenceType:e,referenceId:t})=>`${e}#${t}`,reactor:({reactionId:e})=>e,stream:({streamId:e})=>e,streamModeration:({streamId:e})=>e,follow:({from:e,to:t})=>`${e}#${t}`,followInfo:({userId:e})=>e,followCount:({userId:e})=>e,feed:({targetId:e,feedId:t})=>`${e}#${t}`,story:({referenceId:e})=>e,storyTarget:({targetId:e})=>e,ad:({adId:e})=>e,advertiser:({advertiserId:e})=>e,pin:({placement:e,referenceId:t})=>`${e}#${t}`,pinTarget:({targetId:e})=>e,notificationTrayItem:({_id:e})=>e,notificationTraySeen:({userId:e})=>e},de=e=>ce[e],ue={users:"user",files:"file",roles:"role",stories:"story",storyTargets:"storyTarget",channels:"channel",messageFeeds:"subChannel",channelUsers:"channelUsers",messages:"message",messagePreviewChannel:"messagePreviewChannel",messagePreviewSubChannel:"messagePreviewSubChannel",channelUnreadInfo:"channelUnreadInfo",subChannelUnreadInfo:"subChannelUnreadInfo",userEntityMarkers:"channelMarker",userFeedMarkers:"subChannelMarker",contentMarkers:"messageMarker",feedMarkers:"feedMarker",userMarkers:"userMarker",communities:"community",categories:"category",communityUsers:"communityUsers",posts:"post",postChildren:"post",comments:"comment",commentChildren:"comment",polls:"poll",reactors:"reactor",reactions:"reaction",videoStreamings:"stream",videoStreamModerations:"streamModeration",follows:"follow",followCounts:"followCount",feeds:"feed",ads:"ad",advertisers:"advertiser",pinTargets:"pinTarget",pins:"pin",notificationTrayItems:"notificationTrayItem"};function he(e=(new Date).toISOString()){return new Date(new Date(e).getTime()+1).toISOString()}class fe extends Error{constructor(e,t,n){super(`Amity SDK (${t}): ${e}`),this.code=t,this.level=n,this.type="ASC",this.timestamp=Date.now(),Error.captureStackTrace&&Error.captureStackTrace(this,fe)}}class pe extends fe{constructor(e,t,n){super(e,t,n)}}class ge extends fe{constructor(e=8e5,t="fatal"){super("Unexpected error",e,t)}}class me extends fe{constructor(e,t="SDK client is having connection issues"){super(`${t} (${e})`,"disconnected"===e?800211:800210,"error"),this.event=e}}let ye=null;const ve=()=>{if(!ye)throw new fe("There is no active client",8e5,"fatal");return ye},be=e=>{ye=e},we=e=>{const{log:t,cache:n}=ve();if(n)return t("cache/api/queryCache",{key:e}),Object.keys(n.data).filter((t=>{const n=T(t);return E(e,n)})).map((e=>n.data[e]))},Se=e=>{const{log:t,cache:n}=ve();if(!n)return;t("cache/api/pullFromCache",e);const r=C(e);return n.data[r]?n.data[r]:void 0},Ce=(e,t,n={cachedAt:Date.now()})=>{const{log:r,cache:s}=ve();if(!s)return!1;r("cache/api/pushToCache",{key:e,data:t,options:n}),!(null==n?void 0:n.hasOwnProperty("offline"))&&s.persistIf&&(n.offline=s.persistIf(e,t));const i=C(e);return s.data[i]=Object.assign({key:e,data:t},n),!0},Te=(e,t,n)=>{const{log:r,cache:s}=ve();if(!s)return!1;r("cache/api/mergeInCache",{key:e,mutation:t});const i=Se(e);if(!i)return!1;const a="function"==typeof t?t(i.data):Object.assign(Object.assign({},i.data),t);return o=i.data,!("updatedAt"in(l=a)&&"updatedAt"in l&&new Date(l.updatedAt)<new Date(o.updatedAt))&&(Ce(e,a,n),!0);var o,l},Ee=(e,t,n={cachedAt:Date.now()})=>{const{log:r,cache:s}=ve();if(!s)return!1;r("cache/api/upsertInCache",{key:e,data:t,options:n});return Se(e)?Te(e,t,n):Ce(e,t,n)},Ie=(e,t=!1)=>{const{log:n,cache:r}=ve();if(!r)return!1;if(n("cache/api/dropFromCache",{key:e,exact:t}),!t)return Object.keys(r.data).map((e=>T(e))).filter((t=>E(e,t))).map((e=>Ie(e,!0))).every((e=>e));const s=C(e);return s in r.data&&(delete r.data[s],!0)},ke=(e,t,n)=>void 0!==n?e.filter((e=>JSON.stringify(e[t])===JSON.stringify(n))):e,Ae=(e,t,n)=>void 0!==n?e.filter((e=>"string"==typeof e[t]&&"string"==typeof n&&String(e[t]).toLowerCase().match(n.toLowerCase()))):e,_e=(e,t,n)=>(null==n?void 0:n.length)?e.filter((e=>Array.isArray(e[t])&&n.some((n=>e[t].includes(n))))):e,Re=(e,t,n)=>"all"===t?e:e.filter((e=>{var r;if("community"===e.type)return!0;const s=de("channelUsers")({channelId:e.channelPublicId,userId:n}),i=null===(r=Se(["channelUsers","get",s]))||void 0===r?void 0:r.data;return"member"===t?i&&"none"!==i.membership:!i||"none"===i.membership})),Oe=(e,t)=>e.filter((({targetId:e,feedId:n})=>{var r;const s=null===(r=Se(["feed","get",de("feed")({targetId:e,feedId:n})]))||void 0===r?void 0:r.data;return s&&s.feedType===t})),Le=(e,t,n)=>"all"===t?e:e.filter((e=>{var r;const s=de("communityUsers")({communityId:e.communityId,userId:n}),i=null===(r=Se(["communityUsers","get",s]))||void 0===r?void 0:r.data;return"member"===t?i&&"member"===i.communityMembership:!i||"none"!==i.communityMembership})),De=(e,t)=>e.reduce(((e,n)=>{var r;if(null==t?void 0:t.includes(n.dataType))return[...e,n];if(((null==n?void 0:n.children)||[]).length>0){const s=null===(r=Se(["post","get",n.children[0]]))||void 0===r?void 0:r.data;return(null==t?void 0:t.includes(null==s?void 0:s.dataType))?e:[...e,n]}return e}),[]),xe=(e,t)=>{const n=new RegExp(t,"i");return e.filter((e=>{var t;return!!e.userId.match(n)||e.user&&(null===(t=e.user.displayName)||void 0===t?void 0:t.match(n))}))},Pe=({displayName:e},{displayName:t})=>e&&t?e.localeCompare(t):e?-1:1,Me=({name:e},{name:t})=>e&&t?e.localeCompare(t):e?-1:1,Fe=({createdAt:e},{createdAt:t})=>new Date(e).valueOf()-new Date(t).valueOf(),Ue=({localSortingDate:e},{localSortingDate:t})=>new Date(t).getTime()-new Date(e).getTime(),Ne=({createdAt:e},{createdAt:t})=>new Date(t).valueOf()-new Date(e).valueOf(),Be=({updatedAt:e=0},{updatedAt:t=0})=>new Date(e).valueOf()-new Date(t).valueOf(),je=({updatedAt:e=0},{updatedAt:t=0})=>new Date(t).valueOf()-new Date(e).valueOf(),$e=({lastActivity:e},{lastActivity:t})=>new Date(t).valueOf()-new Date(e).valueOf();let qe=null;const Ke=()=>{if(!qe)throw new fe("Connect client first",8e5,"fatal");return qe},Ge=e=>{qe={_id:e._id,userId:e.userId,path:e.path}};let He,Ve=[];const ze=e=>{clearTimeout(He),Ve.push(e),He=setTimeout((()=>{Ve.forEach((e=>e())),Ve=[]}),0)},We=["disconnected","error","connect_error","reconnect_error","reconnect_failed","sessionStateChange","tokenExpired"],Ye=["connect","message","disconnect","error","close","end","reconnect","video-streaming.didStart","video-streaming.didRecord","video-streaming.didStop","video-streaming.didFlag","video-streaming.didTerminate"],Qe=()=>{return{all:e=e||new Map,on:function(t,n){var r=e.get(t);r?r.push(n):e.set(t,[n])},off:function(t,n){var r=e.get(t);r&&(n?r.splice(r.indexOf(n)>>>0,1):e.set(t,[]))},emit:function(t,n){var r=e.get(t);r&&r.slice().map((function(e){e(n)})),(r=e.get("*"))&&r.slice().map((function(e){e(t,n)}))}};var e},Xe=(e,t,n,r)=>{const{log:s,emitter:i}=e,a=Date.now();s(`${t}(tmpid: ${a}) > listen`);const o=(...e)=>{s(`${t}(tmpid: ${a}) > trigger`,e);try{r(...e)}catch(e){s(`${t}(tmpid: ${a}) > error`,e)}};return i.on(n,o),()=>{s(`${t}(tmpid: ${a}) > dispose`),i.off(n,o)}},Je=(e,t)=>{const{emitter:n}=ve();ze((()=>{n.emit(e,t)}))};let Ze,et;async function tt(){var e;const{mqtt:t,emitter:n,token:r}=ve();if(!t)return;const s=null!==(e=null==r?void 0:r.accessToken)&&void 0!==e?e:"",i=Ke();Ze===s&&et===i._id||(Ze=s,et=i._id,await t.connect({accessToken:Ze,userId:et}),((e,t)=>{Ye.forEach((n=>{null==e||e.on(n,((...e)=>{t.emit(n,1===e.length?e[0]:e)}))})),e.on("message",((e,n)=>{const r=JSON.parse(n.toString());t.emit(r.eventType,r.data)}))})(t,n))}var nt;e.SubscriptionLevels=void 0,(nt=e.SubscriptionLevels||(e.SubscriptionLevels={})).COMMUNITY="community",nt.POST="post",nt.COMMENT="comment",nt.POST_AND_COMMENT="post_and_comment",nt.USER="user";const rt=(e,t)=>{switch(t){case"post":return`${e}/post/+`;case"comment":return`${e}/post/+/comment/+`;case"post_and_comment":return`${e}/post/#`;default:return e}},st=e=>e.path.split("/user/")[0],it=({path:t},n=e.SubscriptionLevels.USER)=>rt(n===e.SubscriptionLevels.USER?t:t.replace(/^(\w*)/,"$1/social"),n),at=({channelId:e,subChannelId:t})=>{const n=Ke();return`${st(n)}/marker/channel/${e}/message/${t}`},ot=()=>{const e=Ke();return`${st(e)}/marker/user/${e._id}`},lt=()=>st(Ke()),ct=()=>{const e=Ke();return`${st(e)}/smartfeed/${e._id}/channels`},dt=()=>{const e=Ke();return`${st(e)}/smartfeed/${e._id}/messagefeeds`},ut=()=>{const e=Ke();return`${st(e)}/smartfeed/${e._id}/messages`};function ht(e,t){const{mqtt:n}=ve();return n?(tt(),n.subscribe(e,t)):()=>null}const ft=()=>{const e=Ke();return`${st(e)}/videostreaming`};var pt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function gt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function mt(e){var t=e.default;if("function"==typeof t){var n=function(){return t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})})),n}var yt,vt,bt={exports:{}};function wt(){if(vt)return yt;vt=1;var e=1e3,t=60*e,n=60*t,r=24*n,s=7*r,i=365.25*r;function a(e,t,n,r){var s=t>=1.5*n;return Math.round(e/n)+" "+r+(s?"s":"")}return yt=function(o,l){l=l||{};var c=typeof o;if("string"===c&&o.length>0)return function(a){if((a=String(a)).length>100)return;var o=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(a);if(!o)return;var l=parseFloat(o[1]);switch((o[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return l*i;case"weeks":case"week":case"w":return l*s;case"days":case"day":case"d":return l*r;case"hours":case"hour":case"hrs":case"hr":case"h":return l*n;case"minutes":case"minute":case"mins":case"min":case"m":return l*t;case"seconds":case"second":case"secs":case"sec":case"s":return l*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return l;default:return}}(o);if("number"===c&&isFinite(o))return l.long?function(s){var i=Math.abs(s);if(i>=r)return a(s,i,r,"day");if(i>=n)return a(s,i,n,"hour");if(i>=t)return a(s,i,t,"minute");if(i>=e)return a(s,i,e,"second");return s+" ms"}(o):function(s){var i=Math.abs(s);if(i>=r)return Math.round(s/r)+"d";if(i>=n)return Math.round(s/n)+"h";if(i>=t)return Math.round(s/t)+"m";if(i>=e)return Math.round(s/e)+"s";return s+"ms"}(o);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(o))},yt}var St=function(e){function t(e){let r,s,i,a=null;function o(...e){if(!o.enabled)return;const n=o,s=Number(new Date),i=s-(r||s);n.diff=i,n.prev=r,n.curr=s,r=s,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((r,s)=>{if("%%"===r)return"%";a++;const i=t.formatters[s];if("function"==typeof i){const t=e[a];r=i.call(n,t),e.splice(a,1),a--}return r})),t.formatArgs.call(n,e);(n.log||t.log).apply(n,e)}return o.namespace=e,o.useColors=t.useColors(),o.color=t.selectColor(e),o.extend=n,o.destroy=t.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==a?a:(s!==t.namespaces&&(s=t.namespaces,i=t.enabled(e)),i),set:e=>{a=e}}),"function"==typeof t.init&&t.init(o),o}function n(e,n){const r=t(this.namespace+(void 0===n?":":n)+e);return r.log=this.log,r}function r(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(r),...t.skips.map(r).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let n;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(n=0;n<s;n++)r[n]&&("-"===(e=r[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=wt(),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((n=>{t[n]=e[n]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.enable(t.load()),t};!function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let r=0,s=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(r++,"%c"===e&&(s=r))})),t.splice(s,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=St(t);const{formatters:n}=e.exports;n.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(bt,bt.exports);var Ct,Tt=bt.exports;const Et="object"==typeof globalThis?globalThis:"object"==typeof global?global:window,{process:It={}}=Et,kt="production"===(null===(Ct=It.env)||void 0===Ct?void 0:Ct.NODE_ENV),At={EU:"eu",SG:"sg",US:"us"},_t={http:"https://apix.{region}.amity.co",upload:"https://upload.{region}.amity.co",mqtt:"wss://sse.{region}.amity.co:443/mqtt"};function Rt(e,t){return _t[e].replace("{region}",t)}function Ot(e,t){return function(){return e.apply(t,arguments)}}const{toString:Lt}=Object.prototype,{getPrototypeOf:Dt}=Object,xt=(Pt=Object.create(null),e=>{const t=Lt.call(e);return Pt[t]||(Pt[t]=t.slice(8,-1).toLowerCase())});var Pt;const Mt=e=>(e=e.toLowerCase(),t=>xt(t)===e),Ft=e=>t=>typeof t===e,{isArray:Ut}=Array,Nt=Ft("undefined");const Bt=Mt("ArrayBuffer");const jt=Ft("string"),$t=Ft("function"),qt=Ft("number"),Kt=e=>null!==e&&"object"==typeof e,Gt=e=>{if("object"!==xt(e))return!1;const t=Dt(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)},Ht=Mt("Date"),Vt=Mt("File"),zt=Mt("Blob"),Wt=Mt("FileList"),Yt=Mt("URLSearchParams");function Qt(e,t,{allOwnKeys:n=!1}={}){if(null==e)return;let r,s;if("object"!=typeof e&&(e=[e]),Ut(e))for(r=0,s=e.length;r<s;r++)t.call(null,e[r],r,e);else{const s=n?Object.getOwnPropertyNames(e):Object.keys(e),i=s.length;let a;for(r=0;r<i;r++)a=s[r],t.call(null,e[a],a,e)}}function Xt(e,t){t=t.toLowerCase();const n=Object.keys(e);let r,s=n.length;for(;s-- >0;)if(r=n[s],t===r.toLowerCase())return r;return null}const Jt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:global,Zt=e=>!Nt(e)&&e!==Jt;const en=(tn="undefined"!=typeof Uint8Array&&Dt(Uint8Array),e=>tn&&e instanceof tn);var tn;const nn=Mt("HTMLFormElement"),rn=(({hasOwnProperty:e})=>(t,n)=>e.call(t,n))(Object.prototype),sn=Mt("RegExp"),an=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),r={};Qt(n,((n,s)=>{!1!==t(n,s,e)&&(r[s]=n)})),Object.defineProperties(e,r)};var on={isArray:Ut,isArrayBuffer:Bt,isBuffer:function(e){return null!==e&&!Nt(e)&&null!==e.constructor&&!Nt(e.constructor)&&$t(e.constructor.isBuffer)&&e.constructor.isBuffer(e)},isFormData:e=>{const t="[object FormData]";return e&&("function"==typeof FormData&&e instanceof FormData||Lt.call(e)===t||$t(e.toString)&&e.toString()===t)},isArrayBufferView:function(e){let t;return t="undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&Bt(e.buffer),t},isString:jt,isNumber:qt,isBoolean:e=>!0===e||!1===e,isObject:Kt,isPlainObject:Gt,isUndefined:Nt,isDate:Ht,isFile:Vt,isBlob:zt,isRegExp:sn,isFunction:$t,isStream:e=>Kt(e)&&$t(e.pipe),isURLSearchParams:Yt,isTypedArray:en,isFileList:Wt,forEach:Qt,merge:function e(){const{caseless:t}=Zt(this)&&this||{},n={},r=(r,s)=>{const i=t&&Xt(n,s)||s;Gt(n[i])&&Gt(r)?n[i]=e(n[i],r):Gt(r)?n[i]=e({},r):Ut(r)?n[i]=r.slice():n[i]=r};for(let e=0,t=arguments.length;e<t;e++)arguments[e]&&Qt(arguments[e],r);return n},extend:(e,t,n,{allOwnKeys:r}={})=>(Qt(t,((t,r)=>{n&&$t(t)?e[r]=Ot(t,n):e[r]=t}),{allOwnKeys:r}),e),trim:e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(65279===e.charCodeAt(0)&&(e=e.slice(1)),e),inherits:(e,t,n,r)=>{e.prototype=Object.create(t.prototype,r),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),n&&Object.assign(e.prototype,n)},toFlatObject:(e,t,n,r)=>{let s,i,a;const o={};if(t=t||{},null==e)return t;do{for(s=Object.getOwnPropertyNames(e),i=s.length;i-- >0;)a=s[i],r&&!r(a,e,t)||o[a]||(t[a]=e[a],o[a]=!0);e=!1!==n&&Dt(e)}while(e&&(!n||n(e,t))&&e!==Object.prototype);return t},kindOf:xt,kindOfTest:Mt,endsWith:(e,t,n)=>{e=String(e),(void 0===n||n>e.length)&&(n=e.length),n-=t.length;const r=e.indexOf(t,n);return-1!==r&&r===n},toArray:e=>{if(!e)return null;if(Ut(e))return e;let t=e.length;if(!qt(t))return null;const n=new Array(t);for(;t-- >0;)n[t]=e[t];return n},forEachEntry:(e,t)=>{const n=(e&&e[Symbol.iterator]).call(e);let r;for(;(r=n.next())&&!r.done;){const n=r.value;t.call(e,n[0],n[1])}},matchAll:(e,t)=>{let n;const r=[];for(;null!==(n=e.exec(t));)r.push(n);return r},isHTMLForm:nn,hasOwnProperty:rn,hasOwnProp:rn,reduceDescriptors:an,freezeMethods:e=>{an(e,((t,n)=>{if($t(e)&&-1!==["arguments","caller","callee"].indexOf(n))return!1;const r=e[n];$t(r)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))}))},toObjectSet:(e,t)=>{const n={},r=e=>{e.forEach((e=>{n[e]=!0}))};return Ut(e)?r(e):r(String(e).split(t)),n},toCamelCase:e=>e.toLowerCase().replace(/[_-\s]([a-z\d])(\w*)/g,(function(e,t,n){return t.toUpperCase()+n})),noop:()=>{},toFiniteNumber:(e,t)=>(e=+e,Number.isFinite(e)?e:t),findKey:Xt,global:Jt,isContextDefined:Zt,toJSONObject:e=>{const t=new Array(10),n=(e,r)=>{if(Kt(e)){if(t.indexOf(e)>=0)return;if(!("toJSON"in e)){t[r]=e;const s=Ut(e)?[]:{};return Qt(e,((e,t)=>{const i=n(e,r+1);!Nt(i)&&(s[t]=i)})),t[r]=void 0,s}}return e};return n(e,0)}};function ln(e,t,n,r,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=e,this.name="AxiosError",t&&(this.code=t),n&&(this.config=n),r&&(this.request=r),s&&(this.response=s)}on.inherits(ln,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:on.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const cn=ln.prototype,dn={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((e=>{dn[e]={value:e}})),Object.defineProperties(ln,dn),Object.defineProperty(cn,"isAxiosError",{value:!0}),ln.from=(e,t,n,r,s,i)=>{const a=Object.create(cn);return on.toFlatObject(e,a,(function(e){return e!==Error.prototype}),(e=>"isAxiosError"!==e)),ln.call(a,e.message,t,n,r,s),a.cause=e,a.name=e.name,i&&Object.assign(a,i),a};var un="object"==typeof self?self.FormData:window.FormData;function hn(e){return on.isPlainObject(e)||on.isArray(e)}function fn(e){return on.endsWith(e,"[]")?e.slice(0,-2):e}function pn(e,t,n){return e?e.concat(t).map((function(e,t){return e=fn(e),!n&&t?"["+e+"]":e})).join(n?".":""):t}const gn=on.toFlatObject(on,{},null,(function(e){return/^is[A-Z]/.test(e)}));function mn(e,t,n){if(!on.isObject(e))throw new TypeError("target must be an object");t=t||new(un||FormData);const r=(n=on.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(e,t){return!on.isUndefined(t[e])}))).metaTokens,s=n.visitor||d,i=n.dots,a=n.indexes,o=(n.Blob||"undefined"!=typeof Blob&&Blob)&&((l=t)&&on.isFunction(l.append)&&"FormData"===l[Symbol.toStringTag]&&l[Symbol.iterator]);var l;if(!on.isFunction(s))throw new TypeError("visitor must be a function");function c(e){if(null===e)return"";if(on.isDate(e))return e.toISOString();if(!o&&on.isBlob(e))throw new ln("Blob is not supported. Use a Buffer instead.");return on.isArrayBuffer(e)||on.isTypedArray(e)?o&&"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}function d(e,n,s){let o=e;if(e&&!s&&"object"==typeof e)if(on.endsWith(n,"{}"))n=r?n:n.slice(0,-2),e=JSON.stringify(e);else if(on.isArray(e)&&function(e){return on.isArray(e)&&!e.some(hn)}(e)||on.isFileList(e)||on.endsWith(n,"[]")&&(o=on.toArray(e)))return n=fn(n),o.forEach((function(e,r){!on.isUndefined(e)&&null!==e&&t.append(!0===a?pn([n],r,i):null===a?n:n+"[]",c(e))})),!1;return!!hn(e)||(t.append(pn(s,n,i),c(e)),!1)}const u=[],h=Object.assign(gn,{defaultVisitor:d,convertValue:c,isVisitable:hn});if(!on.isObject(e))throw new TypeError("data must be an object");return function e(n,r){if(!on.isUndefined(n)){if(-1!==u.indexOf(n))throw Error("Circular reference detected in "+r.join("."));u.push(n),on.forEach(n,(function(n,i){!0===(!(on.isUndefined(n)||null===n)&&s.call(t,n,on.isString(i)?i.trim():i,r,h))&&e(n,r?r.concat(i):[i])})),u.pop()}}(e),t}function yn(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,(function(e){return t[e]}))}function vn(e,t){this._pairs=[],e&&mn(e,this,t)}const bn=vn.prototype;function wn(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Sn(e,t,n){if(!t)return e;const r=n&&n.encode||wn,s=n&&n.serialize;let i;if(i=s?s(t,n):on.isURLSearchParams(t)?t.toString():new vn(t,n).toString(r),i){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+i}return e}bn.append=function(e,t){this._pairs.push([e,t])},bn.toString=function(e){const t=e?function(t){return e.call(this,t,yn)}:yn;return this._pairs.map((function(e){return t(e[0])+"="+t(e[1])}),"").join("&")};class Cn{constructor(){this.handlers=[]}use(e,t,n){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){on.forEach(this.handlers,(function(t){null!==t&&e(t)}))}}var Tn={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},En="undefined"!=typeof URLSearchParams?URLSearchParams:vn,In=FormData;const kn=(()=>{let e;return("undefined"==typeof navigator||"ReactNative"!==(e=navigator.product)&&"NativeScript"!==e&&"NS"!==e)&&("undefined"!=typeof window&&"undefined"!=typeof document)})(),An="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts;var _n={isBrowser:!0,classes:{URLSearchParams:En,FormData:In,Blob:Blob},isStandardBrowserEnv:kn,isStandardBrowserWebWorkerEnv:An,protocols:["http","https","file","blob","url","data"]};function Rn(e){function t(e,n,r,s){let i=e[s++];const a=Number.isFinite(+i),o=s>=e.length;if(i=!i&&on.isArray(r)?r.length:i,o)return on.hasOwnProp(r,i)?r[i]=[r[i],n]:r[i]=n,!a;r[i]&&on.isObject(r[i])||(r[i]=[]);return t(e,n,r[i],s)&&on.isArray(r[i])&&(r[i]=function(e){const t={},n=Object.keys(e);let r;const s=n.length;let i;for(r=0;r<s;r++)i=n[r],t[i]=e[i];return t}(r[i])),!a}if(on.isFormData(e)&&on.isFunction(e.entries)){const n={};return on.forEachEntry(e,((e,r)=>{t(function(e){return on.matchAll(/\w+|\[(\w*)]/g,e).map((e=>"[]"===e[0]?"":e[1]||e[0]))}(e),r,n,0)})),n}return null}const On={"Content-Type":void 0};const Ln={transitional:Tn,adapter:["xhr","http"],transformRequest:[function(e,t){const n=t.getContentType()||"",r=n.indexOf("application/json")>-1,s=on.isObject(e);s&&on.isHTMLForm(e)&&(e=new FormData(e));if(on.isFormData(e))return r&&r?JSON.stringify(Rn(e)):e;if(on.isArrayBuffer(e)||on.isBuffer(e)||on.isStream(e)||on.isFile(e)||on.isBlob(e))return e;if(on.isArrayBufferView(e))return e.buffer;if(on.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let i;if(s){if(n.indexOf("application/x-www-form-urlencoded")>-1)return function(e,t){return mn(e,new _n.classes.URLSearchParams,Object.assign({visitor:function(e,t,n,r){return _n.isNode&&on.isBuffer(e)?(this.append(t,e.toString("base64")),!1):r.defaultVisitor.apply(this,arguments)}},t))}(e,this.formSerializer).toString();if((i=on.isFileList(e))||n.indexOf("multipart/form-data")>-1){const t=this.env&&this.env.FormData;return mn(i?{"files[]":e}:e,t&&new t,this.formSerializer)}}return s||r?(t.setContentType("application/json",!1),function(e,t,n){if(on.isString(e))try{return(t||JSON.parse)(e),on.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(n||JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){const t=this.transitional||Ln.transitional,n=t&&t.forcedJSONParsing,r="json"===this.responseType;if(e&&on.isString(e)&&(n&&!this.responseType||r)){const n=!(t&&t.silentJSONParsing)&&r;try{return JSON.parse(e)}catch(e){if(n){if("SyntaxError"===e.name)throw ln.from(e,ln.ERR_BAD_RESPONSE,this,null,this.response);throw e}}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:_n.classes.FormData,Blob:_n.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};on.forEach(["delete","get","head"],(function(e){Ln.headers[e]={}})),on.forEach(["post","put","patch"],(function(e){Ln.headers[e]=on.merge(On)}));const Dn=on.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]);const xn=Symbol("internals");function Pn(e){return e&&String(e).trim().toLowerCase()}function Mn(e){return!1===e||null==e?e:on.isArray(e)?e.map(Mn):String(e)}function Fn(e,t,n,r){return on.isFunction(r)?r.call(this,t,n):on.isString(t)?on.isString(r)?-1!==t.indexOf(r):on.isRegExp(r)?r.test(t):void 0:void 0}class Un{constructor(e){e&&this.set(e)}set(e,t,n){const r=this;function s(e,t,n){const s=Pn(t);if(!s)throw new Error("header name must be a non-empty string");const i=on.findKey(r,s);(!i||void 0===r[i]||!0===n||void 0===n&&!1!==r[i])&&(r[i||t]=Mn(e))}const i=(e,t)=>on.forEach(e,((e,n)=>s(e,n,t)));return on.isPlainObject(e)||e instanceof this.constructor?i(e,t):on.isString(e)&&(e=e.trim())&&!/^[-_a-zA-Z]+$/.test(e.trim())?i((e=>{const t={};let n,r,s;return e&&e.split("\n").forEach((function(e){s=e.indexOf(":"),n=e.substring(0,s).trim().toLowerCase(),r=e.substring(s+1).trim(),!n||t[n]&&Dn[n]||("set-cookie"===n?t[n]?t[n].push(r):t[n]=[r]:t[n]=t[n]?t[n]+", "+r:r)})),t})(e),t):null!=e&&s(t,e,n),this}get(e,t){if(e=Pn(e)){const n=on.findKey(this,e);if(n){const e=this[n];if(!t)return e;if(!0===t)return function(e){const t=Object.create(null),n=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let r;for(;r=n.exec(e);)t[r[1]]=r[2];return t}(e);if(on.isFunction(t))return t.call(this,e,n);if(on.isRegExp(t))return t.exec(e);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=Pn(e)){const n=on.findKey(this,e);return!(!n||t&&!Fn(0,this[n],n,t))}return!1}delete(e,t){const n=this;let r=!1;function s(e){if(e=Pn(e)){const s=on.findKey(n,e);!s||t&&!Fn(0,n[s],s,t)||(delete n[s],r=!0)}}return on.isArray(e)?e.forEach(s):s(e),r}clear(){return Object.keys(this).forEach(this.delete.bind(this))}normalize(e){const t=this,n={};return on.forEach(this,((r,s)=>{const i=on.findKey(n,s);if(i)return t[i]=Mn(r),void delete t[s];const a=e?function(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,((e,t,n)=>t.toUpperCase()+n))}(s):String(s).trim();a!==s&&delete t[s],t[a]=Mn(r),n[a]=!0})),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return on.forEach(this,((n,r)=>{null!=n&&!1!==n&&(t[r]=e&&on.isArray(n)?n.join(", "):n)})),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((([e,t])=>e+": "+t)).join("\n")}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const n=new this(e);return t.forEach((e=>n.set(e))),n}static accessor(e){const t=(this[xn]=this[xn]={accessors:{}}).accessors,n=this.prototype;function r(e){const r=Pn(e);t[r]||(!function(e,t){const n=on.toCamelCase(" "+t);["get","set","has"].forEach((r=>{Object.defineProperty(e,r+n,{value:function(e,n,s){return this[r].call(this,t,e,n,s)},configurable:!0})}))}(n,e),t[r]=!0)}return on.isArray(e)?e.forEach(r):r(e),this}}function Nn(e,t){const n=this||Ln,r=t||n,s=Un.from(r.headers);let i=r.data;return on.forEach(e,(function(e){i=e.call(n,i,s.normalize(),t?t.status:void 0)})),s.normalize(),i}function Bn(e){return!(!e||!e.__CANCEL__)}function jn(e,t,n){ln.call(this,null==e?"canceled":e,ln.ERR_CANCELED,t,n),this.name="CanceledError"}Un.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent"]),on.freezeMethods(Un.prototype),on.freezeMethods(Un),on.inherits(jn,ln,{__CANCEL__:!0});var $n=_n.isStandardBrowserEnv?{write:function(e,t,n,r,s,i){const a=[];a.push(e+"="+encodeURIComponent(t)),on.isNumber(n)&&a.push("expires="+new Date(n).toGMTString()),on.isString(r)&&a.push("path="+r),on.isString(s)&&a.push("domain="+s),!0===i&&a.push("secure"),document.cookie=a.join("; ")},read:function(e){const t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}};function qn(e,t){return e&&!function(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}(t)?function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}(e,t):t}var Kn=_n.isStandardBrowserEnv?function(){const e=/(msie|trident)/i.test(navigator.userAgent),t=document.createElement("a");let n;function r(n){let r=n;return e&&(t.setAttribute("href",r),r=t.href),t.setAttribute("href",r),{href:t.href,protocol:t.protocol?t.protocol.replace(/:$/,""):"",host:t.host,search:t.search?t.search.replace(/^\?/,""):"",hash:t.hash?t.hash.replace(/^#/,""):"",hostname:t.hostname,port:t.port,pathname:"/"===t.pathname.charAt(0)?t.pathname:"/"+t.pathname}}return n=r(window.location.href),function(e){const t=on.isString(e)?r(e):e;return t.protocol===n.protocol&&t.host===n.host}}():function(){return!0};function Gn(e,t){let n=0;const r=function(e,t){e=e||10;const n=new Array(e),r=new Array(e);let s,i=0,a=0;return t=void 0!==t?t:1e3,function(o){const l=Date.now(),c=r[a];s||(s=l),n[i]=o,r[i]=l;let d=a,u=0;for(;d!==i;)u+=n[d++],d%=e;if(i=(i+1)%e,i===a&&(a=(a+1)%e),l-s<t)return;const h=c&&l-c;return h?Math.round(1e3*u/h):void 0}}(50,250);return s=>{const i=s.loaded,a=s.lengthComputable?s.total:void 0,o=i-n,l=r(o);n=i;const c={loaded:i,total:a,progress:a?i/a:void 0,bytes:o,rate:l||void 0,estimated:l&&a&&i<=a?(a-i)/l:void 0,event:s};c[t?"download":"upload"]=!0,e(c)}}var Hn="undefined"!=typeof XMLHttpRequest&&function(e){return new Promise((function(t,n){let r=e.data;const s=Un.from(e.headers).normalize(),i=e.responseType;let a;function o(){e.cancelToken&&e.cancelToken.unsubscribe(a),e.signal&&e.signal.removeEventListener("abort",a)}on.isFormData(r)&&(_n.isStandardBrowserEnv||_n.isStandardBrowserWebWorkerEnv)&&s.setContentType(!1);let l=new XMLHttpRequest;if(e.auth){const t=e.auth.username||"",n=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";s.set("Authorization","Basic "+btoa(t+":"+n))}const c=qn(e.baseURL,e.url);function d(){if(!l)return;const r=Un.from("getAllResponseHeaders"in l&&l.getAllResponseHeaders());!function(e,t,n){const r=n.config.validateStatus;n.status&&r&&!r(n.status)?t(new ln("Request failed with status code "+n.status,[ln.ERR_BAD_REQUEST,ln.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):e(n)}((function(e){t(e),o()}),(function(e){n(e),o()}),{data:i&&"text"!==i&&"json"!==i?l.response:l.responseText,status:l.status,statusText:l.statusText,headers:r,config:e,request:l}),l=null}if(l.open(e.method.toUpperCase(),Sn(c,e.params,e.paramsSerializer),!0),l.timeout=e.timeout,"onloadend"in l?l.onloadend=d:l.onreadystatechange=function(){l&&4===l.readyState&&(0!==l.status||l.responseURL&&0===l.responseURL.indexOf("file:"))&&setTimeout(d)},l.onabort=function(){l&&(n(new ln("Request aborted",ln.ECONNABORTED,e,l)),l=null)},l.onerror=function(){n(new ln("Network Error",ln.ERR_NETWORK,e,l)),l=null},l.ontimeout=function(){let t=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded";const r=e.transitional||Tn;e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),n(new ln(t,r.clarifyTimeoutError?ln.ETIMEDOUT:ln.ECONNABORTED,e,l)),l=null},_n.isStandardBrowserEnv){const t=(e.withCredentials||Kn(c))&&e.xsrfCookieName&&$n.read(e.xsrfCookieName);t&&s.set(e.xsrfHeaderName,t)}void 0===r&&s.setContentType(null),"setRequestHeader"in l&&on.forEach(s.toJSON(),(function(e,t){l.setRequestHeader(t,e)})),on.isUndefined(e.withCredentials)||(l.withCredentials=!!e.withCredentials),i&&"json"!==i&&(l.responseType=e.responseType),"function"==typeof e.onDownloadProgress&&l.addEventListener("progress",Gn(e.onDownloadProgress,!0)),"function"==typeof e.onUploadProgress&&l.upload&&l.upload.addEventListener("progress",Gn(e.onUploadProgress)),(e.cancelToken||e.signal)&&(a=t=>{l&&(n(!t||t.type?new jn(null,e,l):t),l.abort(),l=null)},e.cancelToken&&e.cancelToken.subscribe(a),e.signal&&(e.signal.aborted?a():e.signal.addEventListener("abort",a)));const u=function(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}(c);u&&-1===_n.protocols.indexOf(u)?n(new ln("Unsupported protocol "+u+":",ln.ERR_BAD_REQUEST,e)):l.send(r||null)}))};const Vn={http:null,xhr:Hn};on.forEach(Vn,((e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch(e){}Object.defineProperty(e,"adapterName",{value:t})}}));var zn=e=>{e=on.isArray(e)?e:[e];const{length:t}=e;let n,r;for(let s=0;s<t&&(n=e[s],!(r=on.isString(n)?Vn[n.toLowerCase()]:n));s++);if(!r){if(!1===r)throw new ln(`Adapter ${n} is not supported by the environment`,"ERR_NOT_SUPPORT");throw new Error(on.hasOwnProp(Vn,n)?`Adapter '${n}' is not available in the build`:`Unknown adapter '${n}'`)}if(!on.isFunction(r))throw new TypeError("adapter is not a function");return r};function Wn(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new jn(null,e)}function Yn(e){Wn(e),e.headers=Un.from(e.headers),e.data=Nn.call(e,e.transformRequest),-1!==["post","put","patch"].indexOf(e.method)&&e.headers.setContentType("application/x-www-form-urlencoded",!1);return zn(e.adapter||Ln.adapter)(e).then((function(t){return Wn(e),t.data=Nn.call(e,e.transformResponse,t),t.headers=Un.from(t.headers),t}),(function(t){return Bn(t)||(Wn(e),t&&t.response&&(t.response.data=Nn.call(e,e.transformResponse,t.response),t.response.headers=Un.from(t.response.headers))),Promise.reject(t)}))}const Qn=e=>e instanceof Un?e.toJSON():e;function Xn(e,t){t=t||{};const n={};function r(e,t,n){return on.isPlainObject(e)&&on.isPlainObject(t)?on.merge.call({caseless:n},e,t):on.isPlainObject(t)?on.merge({},t):on.isArray(t)?t.slice():t}function s(e,t,n){return on.isUndefined(t)?on.isUndefined(e)?void 0:r(void 0,e,n):r(e,t,n)}function i(e,t){if(!on.isUndefined(t))return r(void 0,t)}function a(e,t){return on.isUndefined(t)?on.isUndefined(e)?void 0:r(void 0,e):r(void 0,t)}function o(n,s,i){return i in t?r(n,s):i in e?r(void 0,n):void 0}const l={url:i,method:i,data:i,baseURL:a,transformRequest:a,transformResponse:a,paramsSerializer:a,timeout:a,timeoutMessage:a,withCredentials:a,adapter:a,responseType:a,xsrfCookieName:a,xsrfHeaderName:a,onUploadProgress:a,onDownloadProgress:a,decompress:a,maxContentLength:a,maxBodyLength:a,beforeRedirect:a,transport:a,httpAgent:a,httpsAgent:a,cancelToken:a,socketPath:a,responseEncoding:a,validateStatus:o,headers:(e,t)=>s(Qn(e),Qn(t),!0)};return on.forEach(Object.keys(e).concat(Object.keys(t)),(function(r){const i=l[r]||s,a=i(e[r],t[r],r);on.isUndefined(a)&&i!==o||(n[r]=a)})),n}const Jn="1.2.3",Zn={};["object","boolean","number","function","string","symbol"].forEach(((e,t)=>{Zn[e]=function(n){return typeof n===e||"a"+(t<1?"n ":" ")+e}}));const er={};Zn.transitional=function(e,t,n){function r(e,t){return"[Axios v1.2.3] Transitional option '"+e+"'"+t+(n?". "+n:"")}return(n,s,i)=>{if(!1===e)throw new ln(r(s," has been removed"+(t?" in "+t:"")),ln.ERR_DEPRECATED);return t&&!er[s]&&(er[s]=!0,console.warn(r(s," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(n,s,i)}};var tr={assertOptions:function(e,t,n){if("object"!=typeof e)throw new ln("options must be an object",ln.ERR_BAD_OPTION_VALUE);const r=Object.keys(e);let s=r.length;for(;s-- >0;){const i=r[s],a=t[i];if(a){const t=e[i],n=void 0===t||a(t,i,e);if(!0!==n)throw new ln("option "+i+" must be "+n,ln.ERR_BAD_OPTION_VALUE)}else if(!0!==n)throw new ln("Unknown option "+i,ln.ERR_BAD_OPTION)}},validators:Zn};const nr=tr.validators;class rr{constructor(e){this.defaults=e,this.interceptors={request:new Cn,response:new Cn}}request(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},t=Xn(this.defaults,t);const{transitional:n,paramsSerializer:r,headers:s}=t;let i;void 0!==n&&tr.assertOptions(n,{silentJSONParsing:nr.transitional(nr.boolean),forcedJSONParsing:nr.transitional(nr.boolean),clarifyTimeoutError:nr.transitional(nr.boolean)},!1),void 0!==r&&tr.assertOptions(r,{encode:nr.function,serialize:nr.function},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase(),i=s&&on.merge(s.common,s[t.method]),i&&on.forEach(["delete","get","head","post","put","patch","common"],(e=>{delete s[e]})),t.headers=Un.concat(i,s);const a=[];let o=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(o=o&&e.synchronous,a.unshift(e.fulfilled,e.rejected))}));const l=[];let c;this.interceptors.response.forEach((function(e){l.push(e.fulfilled,e.rejected)}));let d,u=0;if(!o){const e=[Yn.bind(this),void 0];for(e.unshift.apply(e,a),e.push.apply(e,l),d=e.length,c=Promise.resolve(t);u<d;)c=c.then(e[u++],e[u++]);return c}d=a.length;let h=t;for(u=0;u<d;){const e=a[u++],t=a[u++];try{h=e(h)}catch(e){t.call(this,e);break}}try{c=Yn.call(this,h)}catch(e){return Promise.reject(e)}for(u=0,d=l.length;u<d;)c=c.then(l[u++],l[u++]);return c}getUri(e){return Sn(qn((e=Xn(this.defaults,e)).baseURL,e.url),e.params,e.paramsSerializer)}}on.forEach(["delete","get","head","options"],(function(e){rr.prototype[e]=function(t,n){return this.request(Xn(n||{},{method:e,url:t,data:(n||{}).data}))}})),on.forEach(["post","put","patch"],(function(e){function t(t){return function(n,r,s){return this.request(Xn(s||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:n,data:r}))}}rr.prototype[e]=t(),rr.prototype[e+"Form"]=t(!0)}));class sr{constructor(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");let t;this.promise=new Promise((function(e){t=e}));const n=this;this.promise.then((e=>{if(!n._listeners)return;let t=n._listeners.length;for(;t-- >0;)n._listeners[t](e);n._listeners=null})),this.promise.then=e=>{let t;const r=new Promise((e=>{n.subscribe(e),t=e})).then(e);return r.cancel=function(){n.unsubscribe(t)},r},e((function(e,r,s){n.reason||(n.reason=new jn(e,r,s),t(n.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}static source(){let e;return{token:new sr((function(t){e=t})),cancel:e}}}const ir={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(ir).forEach((([e,t])=>{ir[t]=e}));const ar=function e(t){const n=new rr(t),r=Ot(rr.prototype.request,n);return on.extend(r,rr.prototype,n,{allOwnKeys:!0}),on.extend(r,n,null,{allOwnKeys:!0}),r.create=function(n){return e(Xn(t,n))},r}(Ln);ar.Axios=rr,ar.CanceledError=jn,ar.CancelToken=sr,ar.isCancel=Bn,ar.VERSION=Jn,ar.toFormData=mn,ar.AxiosError=ln,ar.Cancel=ar.CanceledError,ar.all=function(e){return Promise.all(e)},ar.spread=function(e){return function(t){return e.apply(null,t)}},ar.isAxiosError=function(e){return on.isObject(e)&&!0===e.isAxiosError},ar.mergeConfig=Xn,ar.AxiosHeaders=Un,ar.formToJSON=e=>Rn(on.isHTMLForm(e)?new FormData(e):e),ar.HttpStatusCode=ir,ar.default=ar;var or={exports:{}};or.exports=cr;var lr=or.exports.HttpsAgent=cr;function cr(){}class dr{constructor(){this._listener=new Map}onNetworkActivities(e){return this._listener.set(e,e),()=>{this._listener.delete(e)}}setNetworkActivities(e,t){this._listener.forEach((n=>n(e,t)))}destroy(){this._listener.clear()}}let ur;var hr,fr=()=>(ur||(ur=new dr),ur);!function(e){e.UserDeleted="User Deleted",e.UserGlobalBanned="User Global Banned",e.TokenExpired="Token Expired"}(hr||(hr={}));const pr=new AbortController,gr=e=>{switch(e){case hr.UserGlobalBanned:throw new fe(e,400312,"fatal");case hr.UserDeleted:throw new fe(e,400100,"fatal");case hr.TokenExpired:throw Je("tokenExpired","tokenExpired"),new fe(e,800403,"fatal");default:throw new fe("Request Aborted",8e5,"error")}},mr=e=>{const t={maxSockets:100,maxFreeSockets:10,timeout:6e4,freeSocketTimeout:3e4},n=ar.create({baseURL:e,httpAgent:new or.exports(t),httpsAgent:new lr(t),signal:pr.signal});return n.defaults.withCredentials=!1,n.interceptors.request.use((e=>{if("/api/v5/sessions"===e.url)return e;if(e.metadata){const{tokenExpiry:t,isGlobalBanned:n,isUserDeleted:r}=e.metadata;n&&(pr.abort(),gr(hr.UserGlobalBanned)),r&&(pr.abort(),gr(hr.UserDeleted)),t&&Date.now()>=Date.parse(t)&&(pr.abort(hr.UserDeleted),gr(hr.TokenExpired))}return e})),n.interceptors.response.use((e=>{const t=new Headers;return Object.entries(e.headers).forEach((([e,n])=>{"string"==typeof n&&t.append(e,n)})),fr().setNetworkActivities(new Request(e.request.url,{method:e.request.method,headers:e.request.headers,body:e.request.data}),{data:e.data,status:e.status,statusText:e.statusText,headers:t}),e}),(e=>{var t,n;const{response:r}=e;if(400100===(null==r?void 0:r.data.code)&&Je("tokenTerminated","terminated"),(null===(t=null==r?void 0:r.data)||void 0===t?void 0:t.status)&&(e=>{if("success"===e.status)return e.data;if("fail"===e.status)throw new ge(e.code);if("error"===e.status)throw new pe(e.message,e.code,"error")})(null==r?void 0:r.data),pr.signal.aborted)throw e;throw new Error(null!==(n=null==r?void 0:r.data)&&void 0!==n?n:e)})),n.defaults.paramsSerializer={encode:e=>encodeURIComponent(e)},n};var yr={exports:{}},vr=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,br=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],wr=function(e){var t=e,n=e.indexOf("["),r=e.indexOf("]");-1!=n&&-1!=r&&(e=e.substring(0,n)+e.substring(n,r).replace(/:/g,";")+e.substring(r,e.length));for(var s=vr.exec(e||""),i={},a=14;a--;)i[br[a]]=s[a]||"";return-1!=n&&-1!=r&&(i.source=t,i.host=i.host.substring(1,i.host.length-1).replace(/;/g,":"),i.authority=i.authority.replace("[","").replace("]","").replace(/;/g,":"),i.ipv6uri=!0),i},Sr={exports:{}},Cr={exports:{}},Tr=1e3,Er=6e4,Ir=60*Er,kr=24*Ir,Ar=365.25*kr,_r=function(e,t){t=t||{};var n=typeof e;if("string"===n&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*Ar;case"days":case"day":case"d":return n*kr;case"hours":case"hour":case"hrs":case"hr":case"h":return n*Ir;case"minutes":case"minute":case"mins":case"min":case"m":return n*Er;case"seconds":case"second":case"secs":case"sec":case"s":return n*Tr;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}(e);if("number"===n&&!1===isNaN(e))return t.long?function(e){return Rr(e,kr,"day")||Rr(e,Ir,"hour")||Rr(e,Er,"minute")||Rr(e,Tr,"second")||e+" ms"}(e):function(e){if(e>=kr)return Math.round(e/kr)+"d";if(e>=Ir)return Math.round(e/Ir)+"h";if(e>=Er)return Math.round(e/Er)+"m";if(e>=Tr)return Math.round(e/Tr)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function Rr(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}!function(e,t){function n(e){var n;function s(){if(s.enabled){var e=s,r=+new Date,i=r-(n||r);e.diff=i,e.prev=n,e.curr=r,n=r;for(var a=new Array(arguments.length),o=0;o<a.length;o++)a[o]=arguments[o];a[0]=t.coerce(a[0]),"string"!=typeof a[0]&&a.unshift("%O");var l=0;a[0]=a[0].replace(/%([a-zA-Z%])/g,(function(n,r){if("%%"===n)return n;l++;var s=t.formatters[r];if("function"==typeof s){var i=a[l];n=s.call(e,i),a.splice(l,1),l--}return n})),t.formatArgs.call(e,a);var c=s.log||t.log||console.log.bind(console);c.apply(e,a)}}return s.namespace=e,s.enabled=t.enabled(e),s.useColors=t.useColors(),s.color=function(e){var n,r=0;for(n in e)r=(r<<5)-r+e.charCodeAt(n),r|=0;return t.colors[Math.abs(r)%t.colors.length]}(e),s.destroy=r,"function"==typeof t.init&&t.init(s),t.instances.push(s),s}function r(){var e=t.instances.indexOf(this);return-1!==e&&(t.instances.splice(e,1),!0)}(t=e.exports=n.debug=n.default=n).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){var n;t.save(e),t.names=[],t.skips=[];var r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(n=0;n<s;n++)r[n]&&("-"===(e=r[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")));for(n=0;n<t.instances.length;n++){var i=t.instances[n];i.enabled=t.enabled(i.namespace)}},t.enabled=function(e){if("*"===e[e.length-1])return!0;var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=_r,t.instances=[],t.names=[],t.skips=[],t.formatters={}}(Cr,Cr.exports),function(e,t){function n(){var e;try{e=t.storage.debug}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e}(t=e.exports=Cr.exports).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(e){var n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return;var r="color: "+this.color;e.splice(1,0,r,"color: inherit");var s=0,i=0;e[0].replace(/%[a-zA-Z%]/g,(function(e){"%%"!==e&&(s++,"%c"===e&&(i=s))})),e.splice(i,0,r)},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(n())}(Sr,Sr.exports);var Or=wr,Lr=Sr.exports("socket.io-client:url"),Dr=function(e,t){var n=e;t=t||"undefined"!=typeof location&&location,null==e&&(e=t.protocol+"//"+t.host);"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?t.protocol+e:t.host+e),/^(https?|wss?):\/\//.test(e)||(Lr("protocol-less url %s",e),e=void 0!==t?t.protocol+"//"+e:"https://"+e),Lr("parse %s",e),n=Or(e));n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443"));n.path=n.path||"/";var r=-1!==n.host.indexOf(":")?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+r+":"+n.port,n.href=n.protocol+"://"+r+(t&&t.port===n.port?"":":"+n.port),n};var xr={},Pr={exports:{}},Mr={exports:{}},Fr=1e3,Ur=6e4,Nr=60*Ur,Br=24*Nr,jr=365.25*Br,$r=function(e,t){t=t||{};var n=typeof e;if("string"===n&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*jr;case"days":case"day":case"d":return n*Br;case"hours":case"hour":case"hrs":case"hr":case"h":return n*Nr;case"minutes":case"minute":case"mins":case"min":case"m":return n*Ur;case"seconds":case"second":case"secs":case"sec":case"s":return n*Fr;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}(e);if("number"===n&&!1===isNaN(e))return t.long?function(e){return qr(e,Br,"day")||qr(e,Nr,"hour")||qr(e,Ur,"minute")||qr(e,Fr,"second")||e+" ms"}(e):function(e){if(e>=Br)return Math.round(e/Br)+"d";if(e>=Nr)return Math.round(e/Nr)+"h";if(e>=Ur)return Math.round(e/Ur)+"m";if(e>=Fr)return Math.round(e/Fr)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function qr(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}!function(e,t){function n(e){var n;function s(){if(s.enabled){var e=s,r=+new Date,i=r-(n||r);e.diff=i,e.prev=n,e.curr=r,n=r;for(var a=new Array(arguments.length),o=0;o<a.length;o++)a[o]=arguments[o];a[0]=t.coerce(a[0]),"string"!=typeof a[0]&&a.unshift("%O");var l=0;a[0]=a[0].replace(/%([a-zA-Z%])/g,(function(n,r){if("%%"===n)return n;l++;var s=t.formatters[r];if("function"==typeof s){var i=a[l];n=s.call(e,i),a.splice(l,1),l--}return n})),t.formatArgs.call(e,a);var c=s.log||t.log||console.log.bind(console);c.apply(e,a)}}return s.namespace=e,s.enabled=t.enabled(e),s.useColors=t.useColors(),s.color=function(e){var n,r=0;for(n in e)r=(r<<5)-r+e.charCodeAt(n),r|=0;return t.colors[Math.abs(r)%t.colors.length]}(e),s.destroy=r,"function"==typeof t.init&&t.init(s),t.instances.push(s),s}function r(){var e=t.instances.indexOf(this);return-1!==e&&(t.instances.splice(e,1),!0)}(t=e.exports=n.debug=n.default=n).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){var n;t.save(e),t.names=[],t.skips=[];var r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(n=0;n<s;n++)r[n]&&("-"===(e=r[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")));for(n=0;n<t.instances.length;n++){var i=t.instances[n];i.enabled=t.enabled(i.namespace)}},t.enabled=function(e){if("*"===e[e.length-1])return!0;var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=$r,t.instances=[],t.names=[],t.skips=[],t.formatters={}}(Mr,Mr.exports),function(e,t){function n(){var e;try{e=t.storage.debug}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e}(t=e.exports=Mr.exports).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(e){var n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return;var r="color: "+this.color;e.splice(1,0,r,"color: inherit");var s=0,i=0;e[0].replace(/%[a-zA-Z%]/g,(function(e){"%%"!==e&&(s++,"%c"===e&&(i=s))})),e.splice(i,0,r)},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(n())}(Pr,Pr.exports);var Kr={exports:{}};!function(e){function t(e){if(e)return function(e){for(var n in t.prototype)e[n]=t.prototype[n];return e}(e)}e.exports=t,t.prototype.on=t.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},t.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},t.prototype.off=t.prototype.removeListener=t.prototype.removeAllListeners=t.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks["$"+e];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var s=0;s<r.length;s++)if((n=r[s])===t||n.fn===t){r.splice(s,1);break}return 0===r.length&&delete this._callbacks["$"+e],this},t.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),n=this._callbacks["$"+e],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(n){r=0;for(var s=(n=n.slice(0)).length;r<s;++r)n[r].apply(this,t)}return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length}}(Kr);var Gr={},Hr={}.toString,Vr=Array.isArray||function(e){return"[object Array]"==Hr.call(e)},zr=function(e){return Wr&&Buffer.isBuffer(e)||Yr&&(e instanceof ArrayBuffer||function(e){return"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer}(e))},Wr="function"==typeof Buffer&&"function"==typeof Buffer.isBuffer,Yr="function"==typeof ArrayBuffer;var Qr=Vr,Xr=zr,Jr=Object.prototype.toString,Zr="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Jr.call(Blob),es="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===Jr.call(File);function ts(e,t){if(!e)return e;if(Xr(e)){var n={_placeholder:!0,num:t.length};return t.push(e),n}if(Qr(e)){for(var r=new Array(e.length),s=0;s<e.length;s++)r[s]=ts(e[s],t);return r}if("object"==typeof e&&!(e instanceof Date)){r={};for(var i in e)r[i]=ts(e[i],t);return r}return e}function ns(e,t){if(!e)return e;if(e&&e._placeholder)return t[e.num];if(Qr(e))for(var n=0;n<e.length;n++)e[n]=ns(e[n],t);else if("object"==typeof e)for(var r in e)e[r]=ns(e[r],t);return e}Gr.deconstructPacket=function(e){var t=[],n=e.data,r=e;return r.data=ts(n,t),r.attachments=t.length,{packet:r,buffers:t}},Gr.reconstructPacket=function(e,t){return e.data=ns(e.data,t),e.attachments=void 0,e},Gr.removeBlobs=function(e,t){var n=0,r=e;!function e(s,i,a){if(!s)return s;if(Zr&&s instanceof Blob||es&&s instanceof File){n++;var o=new FileReader;o.onload=function(){a?a[i]=this.result:r=this.result,--n||t(r)},o.readAsArrayBuffer(s)}else if(Qr(s))for(var l=0;l<s.length;l++)e(s[l],l,s);else if("object"==typeof s&&!Xr(s))for(var c in s)e(s[c],c,s)}(r),n||t(r)},function(e){var t=Pr.exports("socket.io-parser"),n=Kr.exports,r=Gr,s=Vr,i=zr;function a(){}e.protocol=4,e.types=["CONNECT","DISCONNECT","EVENT","ACK","ERROR","BINARY_EVENT","BINARY_ACK"],e.CONNECT=0,e.DISCONNECT=1,e.EVENT=2,e.ACK=3,e.ERROR=4,e.BINARY_EVENT=5,e.BINARY_ACK=6,e.Encoder=a,e.Decoder=c;var o=e.ERROR+'"encode error"';function l(n){var r=""+n.type;if(e.BINARY_EVENT!==n.type&&e.BINARY_ACK!==n.type||(r+=n.attachments+"-"),n.nsp&&"/"!==n.nsp&&(r+=n.nsp+","),null!=n.id&&(r+=n.id),null!=n.data){var s=function(e){try{return JSON.stringify(e)}catch(e){return!1}}(n.data);if(!1===s)return o;r+=s}return t("encoded %j as %s",n,r),r}function c(){this.reconstructor=null}function d(e){this.reconPack=e,this.buffers=[]}function u(t){return{type:e.ERROR,data:"parser error: "+t}}a.prototype.encode=function(n,s){(t("encoding packet %j",n),e.BINARY_EVENT===n.type||e.BINARY_ACK===n.type)?function(e,t){function n(e){var n=r.deconstructPacket(e),s=l(n.packet),i=n.buffers;i.unshift(s),t(i)}r.removeBlobs(e,n)}(n,s):s([l(n)])},n(c.prototype),c.prototype.add=function(n){var r;if("string"==typeof n)r=function(n){var r=0,i={type:Number(n.charAt(0))};if(null==e.types[i.type])return u("unknown packet type "+i.type);if(e.BINARY_EVENT===i.type||e.BINARY_ACK===i.type){for(var a=r+1;"-"!==n.charAt(++r)&&r!=n.length;);var o=n.substring(a,r);if(o!=Number(o)||"-"!==n.charAt(r))throw new Error("Illegal attachments");i.attachments=Number(o)}if("/"===n.charAt(r+1)){for(a=r+1;++r;){if(","===(c=n.charAt(r)))break;if(r===n.length)break}i.nsp=n.substring(a,r)}else i.nsp="/";var l=n.charAt(r+1);if(""!==l&&Number(l)==l){for(a=r+1;++r;){var c;if(null==(c=n.charAt(r))||Number(c)!=c){--r;break}if(r===n.length)break}i.id=Number(n.substring(a,r+1))}if(n.charAt(++r)){var d=function(e){try{return JSON.parse(e)}catch(e){return!1}}(n.substr(r));if(!(!1!==d&&(i.type===e.ERROR||s(d))))return u("invalid payload");i.data=d}return t("decoded %s as %j",n,i),i}(n),e.BINARY_EVENT===r.type||e.BINARY_ACK===r.type?(this.reconstructor=new d(r),0===this.reconstructor.reconPack.attachments&&this.emit("decoded",r)):this.emit("decoded",r);else{if(!i(n)&&!n.base64)throw new Error("Unknown type: "+n);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");(r=this.reconstructor.takeBinaryData(n))&&(this.reconstructor=null,this.emit("decoded",r))}},c.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},d.prototype.takeBinaryData=function(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){var t=r.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null},d.prototype.finishedReconstruction=function(){this.reconPack=null,this.buffers=[]}}(xr);var rs={exports:{}},ss={},is={exports:{}};try{is.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(e){is.exports=!1}var as,os,ls,cs,ds=is.exports,us=function(e){var t=e.xdomain,n=e.xscheme,r=e.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!t||ds))return new XMLHttpRequest}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!n&&r)return new XDomainRequest}catch(e){}if(!t)try{return new(self[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}},hs={exports:{}},fs={},ps=Object.keys||function(e){var t=[],n=Object.prototype.hasOwnProperty;for(var r in e)n.call(e,r)&&t.push(r);return t};function gs(){if(cs)return ls;cs=1;var e=function(){if(os)return as;os=1;var e={}.toString;return as=Array.isArray||function(t){return"[object Array]"==e.call(t)}}(),t=Object.prototype.toString,n="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===t.call(Blob),r="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===t.call(File);return ls=function t(s){if(!s||"object"!=typeof s)return!1;if(e(s)){for(var i=0,a=s.length;i<a;i++)if(t(s[i]))return!0;return!1}if("function"==typeof Buffer&&Buffer.isBuffer&&Buffer.isBuffer(s)||"function"==typeof ArrayBuffer&&s instanceof ArrayBuffer||n&&s instanceof Blob||r&&s instanceof File)return!0;if(s.toJSON&&"function"==typeof s.toJSON&&1===arguments.length)return t(s.toJSON(),!0);for(var o in s)if(Object.prototype.hasOwnProperty.call(s,o)&&t(s[o]))return!0;return!1},ls}var ms=function(e,t,n){var r=e.byteLength;if(t=t||0,n=n||r,e.slice)return e.slice(t,n);if(t<0&&(t+=r),n<0&&(n+=r),n>r&&(n=r),t>=r||t>=n||0===r)return new ArrayBuffer(0);for(var s=new Uint8Array(e),i=new Uint8Array(n-t),a=t,o=0;a<n;a++,o++)i[o]=s[a];return i.buffer},ys=function(e,t,n){var r=!1;return n=n||vs,s.count=e,0===e?t():s;function s(e,i){if(s.count<=0)throw new Error("after called too many times");--s.count,e?(r=!0,t(e),t=n):0!==s.count||r||t(null,i)}};function vs(){}
/*! https://mths.be/utf8js v2.1.2 by @mathias */var bs,ws,Ss,Cs=String.fromCharCode;function Ts(e){for(var t,n,r=[],s=0,i=e.length;s<i;)(t=e.charCodeAt(s++))>=55296&&t<=56319&&s<i?56320==(64512&(n=e.charCodeAt(s++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),s--):r.push(t);return r}function Es(e,t){if(e>=55296&&e<=57343){if(t)throw Error("Lone surrogate U+"+e.toString(16).toUpperCase()+" is not a scalar value");return!1}return!0}function Is(e,t){return Cs(e>>t&63|128)}function ks(e,t){if(0==(4294967168&e))return Cs(e);var n="";return 0==(4294965248&e)?n=Cs(e>>6&31|192):0==(4294901760&e)?(Es(e,t)||(e=65533),n=Cs(e>>12&15|224),n+=Is(e,6)):0==(4292870144&e)&&(n=Cs(e>>18&7|240),n+=Is(e,12),n+=Is(e,6)),n+=Cs(63&e|128)}function As(){if(Ss>=ws)throw Error("Invalid byte index");var e=255&bs[Ss];if(Ss++,128==(192&e))return 63&e;throw Error("Invalid continuation byte")}function _s(e){var t,n;if(Ss>ws)throw Error("Invalid byte index");if(Ss==ws)return!1;if(t=255&bs[Ss],Ss++,0==(128&t))return t;if(192==(224&t)){if((n=(31&t)<<6|As())>=128)return n;throw Error("Invalid continuation byte")}if(224==(240&t)){if((n=(15&t)<<12|As()<<6|As())>=2048)return Es(n,e)?n:65533;throw Error("Invalid continuation byte")}if(240==(248&t)&&(n=(7&t)<<18|As()<<12|As()<<6|As())>=65536&&n<=1114111)return n;throw Error("Invalid UTF-8 detected")}var Rs,Os,Ls,Ds={version:"2.1.2",encode:function(e,t){for(var n=!1!==(t=t||{}).strict,r=Ts(e),s=r.length,i=-1,a="";++i<s;)a+=ks(r[i],n);return a},decode:function(e,t){var n=!1!==(t=t||{}).strict;bs=Ts(e),ws=bs.length,Ss=0;for(var r,s=[];!1!==(r=_s(n));)s.push(r);return function(e){for(var t,n=e.length,r=-1,s="";++r<n;)(t=e[r])>65535&&(s+=Cs((t-=65536)>>>10&1023|55296),t=56320|1023&t),s+=Cs(t);return s}(s)}},xs={};function Ps(){if(Ls)return Os;Ls=1;var e=void 0!==e?e:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder&&MozBlobBuilder,t=function(){try{return 2===new Blob(["hi"]).size}catch(e){return!1}}(),n=t&&function(){try{return 2===new Blob([new Uint8Array([1,2])]).size}catch(e){return!1}}(),r=e&&e.prototype.append&&e.prototype.getBlob;function s(e){return e.map((function(e){if(e.buffer instanceof ArrayBuffer){var t=e.buffer;if(e.byteLength!==t.byteLength){var n=new Uint8Array(e.byteLength);n.set(new Uint8Array(t,e.byteOffset,e.byteLength)),t=n.buffer}return t}return e}))}function i(t,n){n=n||{};var r=new e;return s(t).forEach((function(e){r.append(e)})),n.type?r.getBlob(n.type):r.getBlob()}function a(e,t){return new Blob(s(e),t||{})}return"undefined"!=typeof Blob&&(i.prototype=Blob.prototype,a.prototype=Blob.prototype),Os=t?n?Blob:a:r?i:void 0}!function(e){var t,n=ps,r=gs(),s=ms,i=ys,a=Ds;"undefined"!=typeof ArrayBuffer&&(Rs||(Rs=1,function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=new Uint8Array(256),n=0;n<e.length;n++)t[e.charCodeAt(n)]=n;xs.encode=function(t){var n,r=new Uint8Array(t),s=r.length,i="";for(n=0;n<s;n+=3)i+=e[r[n]>>2],i+=e[(3&r[n])<<4|r[n+1]>>4],i+=e[(15&r[n+1])<<2|r[n+2]>>6],i+=e[63&r[n+2]];return s%3==2?i=i.substring(0,i.length-1)+"=":s%3==1&&(i=i.substring(0,i.length-2)+"=="),i},xs.decode=function(e){var n,r,s,i,a,o=.75*e.length,l=e.length,c=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var d=new ArrayBuffer(o),u=new Uint8Array(d);for(n=0;n<l;n+=4)r=t[e.charCodeAt(n)],s=t[e.charCodeAt(n+1)],i=t[e.charCodeAt(n+2)],a=t[e.charCodeAt(n+3)],u[c++]=r<<2|s>>4,u[c++]=(15&s)<<4|i>>2,u[c++]=(3&i)<<6|63&a;return d}}()),t=xs);var o="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),l="undefined"!=typeof navigator&&/PhantomJS/i.test(navigator.userAgent),c=o||l;e.protocol=3;var d=e.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},u=n(d),h={type:"error",data:"parser error"},f=Ps();function p(e,t,n){for(var r=new Array(e.length),s=i(e.length,n),a=function(e,n,s){t(n,(function(t,n){r[e]=n,s(t,r)}))},o=0;o<e.length;o++)a(o,e[o],s)}e.encodePacket=function(t,n,r,s){"function"==typeof n&&(s=n,n=!1),"function"==typeof r&&(s=r,r=null);var i=void 0===t.data?void 0:t.data.buffer||t.data;if("undefined"!=typeof ArrayBuffer&&i instanceof ArrayBuffer)return function(t,n,r){if(!n)return e.encodeBase64Packet(t,r);var s=t.data,i=new Uint8Array(s),a=new Uint8Array(1+s.byteLength);a[0]=d[t.type];for(var o=0;o<i.length;o++)a[o+1]=i[o];return r(a.buffer)}(t,n,s);if(void 0!==f&&i instanceof f)return function(t,n,r){if(!n)return e.encodeBase64Packet(t,r);if(c)return function(t,n,r){if(!n)return e.encodeBase64Packet(t,r);var s=new FileReader;return s.onload=function(){e.encodePacket({type:t.type,data:s.result},n,!0,r)},s.readAsArrayBuffer(t.data)}(t,n,r);var s=new Uint8Array(1);s[0]=d[t.type];var i=new f([s.buffer,t.data]);return r(i)}(t,n,s);if(i&&i.base64)return function(t,n){var r="b"+e.packets[t.type]+t.data.data;return n(r)}(t,s);var o=d[t.type];return void 0!==t.data&&(o+=r?a.encode(String(t.data),{strict:!1}):String(t.data)),s(""+o)},e.encodeBase64Packet=function(t,n){var r,s="b"+e.packets[t.type];if(void 0!==f&&t.data instanceof f){var i=new FileReader;return i.onload=function(){var e=i.result.split(",")[1];n(s+e)},i.readAsDataURL(t.data)}try{r=String.fromCharCode.apply(null,new Uint8Array(t.data))}catch(e){for(var a=new Uint8Array(t.data),o=new Array(a.length),l=0;l<a.length;l++)o[l]=a[l];r=String.fromCharCode.apply(null,o)}return s+=btoa(r),n(s)},e.decodePacket=function(t,n,r){if(void 0===t)return h;if("string"==typeof t){if("b"===t.charAt(0))return e.decodeBase64Packet(t.substr(1),n);if(r&&!1===(t=function(e){try{e=a.decode(e,{strict:!1})}catch(e){return!1}return e}(t)))return h;var i=t.charAt(0);return Number(i)==i&&u[i]?t.length>1?{type:u[i],data:t.substring(1)}:{type:u[i]}:h}i=new Uint8Array(t)[0];var o=s(t,1);return f&&"blob"===n&&(o=new f([o])),{type:u[i],data:o}},e.decodeBase64Packet=function(e,n){var r=u[e.charAt(0)];if(!t)return{type:r,data:{base64:!0,data:e.substr(1)}};var s=t.decode(e.substr(1));return"blob"===n&&f&&(s=new f([s])),{type:r,data:s}},e.encodePayload=function(t,n,s){"function"==typeof n&&(s=n,n=null);var i=r(t);if(n&&i)return f&&!c?e.encodePayloadAsBlob(t,s):e.encodePayloadAsArrayBuffer(t,s);if(!t.length)return s("0:");p(t,(function(t,r){e.encodePacket(t,!!i&&n,!1,(function(e){r(null,function(e){return e.length+":"+e}(e))}))}),(function(e,t){return s(t.join(""))}))},e.decodePayload=function(t,n,r){if("string"!=typeof t)return e.decodePayloadAsBinary(t,n,r);var s;if("function"==typeof n&&(r=n,n=null),""===t)return r(h,0,1);for(var i,a,o="",l=0,c=t.length;l<c;l++){var d=t.charAt(l);if(":"===d){if(""===o||o!=(i=Number(o)))return r(h,0,1);if(o!=(a=t.substr(l+1,i)).length)return r(h,0,1);if(a.length){if(s=e.decodePacket(a,n,!1),h.type===s.type&&h.data===s.data)return r(h,0,1);if(!1===r(s,l+i,c))return}l+=i,o=""}else o+=d}return""!==o?r(h,0,1):void 0},e.encodePayloadAsArrayBuffer=function(t,n){if(!t.length)return n(new ArrayBuffer(0));p(t,(function(t,n){e.encodePacket(t,!0,!0,(function(e){return n(null,e)}))}),(function(e,t){var r=t.reduce((function(e,t){var n;return e+(n="string"==typeof t?t.length:t.byteLength).toString().length+n+2}),0),s=new Uint8Array(r),i=0;return t.forEach((function(e){var t="string"==typeof e,n=e;if(t){for(var r=new Uint8Array(e.length),a=0;a<e.length;a++)r[a]=e.charCodeAt(a);n=r.buffer}s[i++]=t?0:1;var o=n.byteLength.toString();for(a=0;a<o.length;a++)s[i++]=parseInt(o[a]);s[i++]=255;for(r=new Uint8Array(n),a=0;a<r.length;a++)s[i++]=r[a]})),n(s.buffer)}))},e.encodePayloadAsBlob=function(t,n){p(t,(function(t,n){e.encodePacket(t,!0,!0,(function(e){var t=new Uint8Array(1);if(t[0]=1,"string"==typeof e){for(var r=new Uint8Array(e.length),s=0;s<e.length;s++)r[s]=e.charCodeAt(s);e=r.buffer,t[0]=0}var i=(e instanceof ArrayBuffer?e.byteLength:e.size).toString(),a=new Uint8Array(i.length+1);for(s=0;s<i.length;s++)a[s]=parseInt(i[s]);if(a[i.length]=255,f){var o=new f([t.buffer,a.buffer,e]);n(null,o)}}))}),(function(e,t){return n(new f(t))}))},e.decodePayloadAsBinary=function(t,n,r){"function"==typeof n&&(r=n,n=null);for(var i=t,a=[];i.byteLength>0;){for(var o=new Uint8Array(i),l=0===o[0],c="",d=1;255!==o[d];d++){if(c.length>310)return r(h,0,1);c+=o[d]}i=s(i,2+c.length),c=parseInt(c);var u=s(i,0,c);if(l)try{u=String.fromCharCode.apply(null,new Uint8Array(u))}catch(e){var f=new Uint8Array(u);u="";for(d=0;d<f.length;d++)u+=String.fromCharCode(f[d])}a.push(u),i=s(i,c)}var p=a.length;a.forEach((function(t,s){r(e.decodePacket(t,n,!0),s,p)}))}}(fs);var Ms,Fs,Us={exports:{}};function Ns(){if(Fs)return Ms;Fs=1;var e=fs;function t(e){this.path=e.path,this.hostname=e.hostname,this.port=e.port,this.secure=e.secure,this.query=e.query,this.timestampParam=e.timestampParam,this.timestampRequests=e.timestampRequests,this.readyState="",this.agent=e.agent||!1,this.socket=e.socket,this.enablesXDR=e.enablesXDR,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.forceNode=e.forceNode,this.isReactNative=e.isReactNative,this.extraHeaders=e.extraHeaders,this.localAddress=e.localAddress}return Ms=t,(0,Us.exports)(t.prototype),t.prototype.onError=function(e,t){var n=new Error(e);return n.type="TransportError",n.description=t,this.emit("error",n),this},t.prototype.open=function(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this},t.prototype.close=function(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this},t.prototype.send=function(e){if("open"!==this.readyState)throw new Error("Transport not open");this.write(e)},t.prototype.onOpen=function(){this.readyState="open",this.writable=!0,this.emit("open")},t.prototype.onData=function(t){var n=e.decodePacket(t,this.socket.binaryType);this.onPacket(n)},t.prototype.onPacket=function(e){this.emit("packet",e)},t.prototype.onClose=function(){this.readyState="closed",this.emit("close")},Ms}!function(e){function t(e){if(e)return function(e){for(var n in t.prototype)e[n]=t.prototype[n];return e}(e)}e.exports=t,t.prototype.on=t.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},t.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},t.prototype.off=t.prototype.removeListener=t.prototype.removeAllListeners=t.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks["$"+e];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var s=0;s<r.length;s++)if((n=r[s])===t||n.fn===t){r.splice(s,1);break}return this},t.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks["$"+e];if(n)for(var r=0,s=(n=n.slice(0)).length;r<s;++r)n[r].apply(this,t);return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length}}(Us);var Bs,js={};function $s(){return Bs||(Bs=1,js.encode=function(e){var t="";for(var n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t},js.decode=function(e){for(var t={},n=e.split("&"),r=0,s=n.length;r<s;r++){var i=n[r].split("=");t[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return t}),js}var qs,Ks=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e},Gs="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),Hs={},Vs=0,zs=0;function Ws(e){var t="";do{t=Gs[e%64]+t,e=Math.floor(e/64)}while(e>0);return t}function Ys(){var e=Ws(+new Date);return e!==qs?(Vs=0,qs=e):e+"."+Ws(Vs++)}for(;zs<64;zs++)Hs[Gs[zs]]=zs;Ys.encode=Ws,Ys.decode=function(e){var t=0;for(zs=0;zs<e.length;zs++)t=64*t+Hs[e.charAt(zs)];return t};var Qs=Ys,Xs={exports:{}},Js={exports:{}},Zs=1e3,ei=60*Zs,ti=60*ei,ni=24*ti,ri=365.25*ni,si=function(e,t){t=t||{};var n=typeof e;if("string"===n&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*ri;case"days":case"day":case"d":return n*ni;case"hours":case"hour":case"hrs":case"hr":case"h":return n*ti;case"minutes":case"minute":case"mins":case"min":case"m":return n*ei;case"seconds":case"second":case"secs":case"sec":case"s":return n*Zs;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}(e);if("number"===n&&!1===isNaN(e))return t.long?function(e){return ii(e,ni,"day")||ii(e,ti,"hour")||ii(e,ei,"minute")||ii(e,Zs,"second")||e+" ms"}(e):function(e){if(e>=ni)return Math.round(e/ni)+"d";if(e>=ti)return Math.round(e/ti)+"h";if(e>=ei)return Math.round(e/ei)+"m";if(e>=Zs)return Math.round(e/Zs)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function ii(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}!function(e,t){function n(e){var n;function s(){if(s.enabled){var e=s,r=+new Date,i=r-(n||r);e.diff=i,e.prev=n,e.curr=r,n=r;for(var a=new Array(arguments.length),o=0;o<a.length;o++)a[o]=arguments[o];a[0]=t.coerce(a[0]),"string"!=typeof a[0]&&a.unshift("%O");var l=0;a[0]=a[0].replace(/%([a-zA-Z%])/g,(function(n,r){if("%%"===n)return n;l++;var s=t.formatters[r];if("function"==typeof s){var i=a[l];n=s.call(e,i),a.splice(l,1),l--}return n})),t.formatArgs.call(e,a);var c=s.log||t.log||console.log.bind(console);c.apply(e,a)}}return s.namespace=e,s.enabled=t.enabled(e),s.useColors=t.useColors(),s.color=function(e){var n,r=0;for(n in e)r=(r<<5)-r+e.charCodeAt(n),r|=0;return t.colors[Math.abs(r)%t.colors.length]}(e),s.destroy=r,"function"==typeof t.init&&t.init(s),t.instances.push(s),s}function r(){var e=t.instances.indexOf(this);return-1!==e&&(t.instances.splice(e,1),!0)}(t=e.exports=n.debug=n.default=n).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){var n;t.save(e),t.names=[],t.skips=[];var r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(n=0;n<s;n++)r[n]&&("-"===(e=r[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")));for(n=0;n<t.instances.length;n++){var i=t.instances[n];i.enabled=t.enabled(i.namespace)}},t.enabled=function(e){if("*"===e[e.length-1])return!0;var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=si,t.instances=[],t.names=[],t.skips=[],t.formatters={}}(Js,Js.exports),function(e,t){function n(){var e;try{e=t.storage.debug}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e}(t=e.exports=Js.exports).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(e){var n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return;var r="color: "+this.color;e.splice(1,0,r,"color: inherit");var s=0,i=0;e[0].replace(/%[a-zA-Z%]/g,(function(e){"%%"!==e&&(s++,"%c"===e&&(i=s))})),e.splice(i,0,r)},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(n())}(Xs,Xs.exports);var ai=Ns(),oi=$s(),li=fs,ci=Ks,di=Qs,ui=Xs.exports("engine.io-client:polling"),hi=pi,fi=null!=new us({xdomain:!1}).responseType;function pi(e){var t=e&&e.forceBase64;fi&&!t||(this.supportsBinary=!1),ai.call(this,e)}ci(pi,ai),pi.prototype.name="polling",pi.prototype.doOpen=function(){this.poll()},pi.prototype.pause=function(e){var t=this;function n(){ui("paused"),t.readyState="paused",e()}if(this.readyState="pausing",this.polling||!this.writable){var r=0;this.polling&&(ui("we are currently polling - waiting to pause"),r++,this.once("pollComplete",(function(){ui("pre-pause polling complete"),--r||n()}))),this.writable||(ui("we are currently writing - waiting to pause"),r++,this.once("drain",(function(){ui("pre-pause writing complete"),--r||n()})))}else n()},pi.prototype.poll=function(){ui("polling"),this.polling=!0,this.doPoll(),this.emit("poll")},pi.prototype.onData=function(e){var t=this;ui("polling got data %s",e);li.decodePayload(e,this.socket.binaryType,(function(e,n,r){if("opening"===t.readyState&&t.onOpen(),"close"===e.type)return t.onClose(),!1;t.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():ui('ignoring poll - transport state "%s"',this.readyState))},pi.prototype.doClose=function(){var e=this;function t(){ui("writing close packet"),e.write([{type:"close"}])}"open"===this.readyState?(ui("transport open - closing"),t()):(ui("transport not open - deferring close"),this.once("open",t))},pi.prototype.write=function(e){var t=this;this.writable=!1;var n=function(){t.writable=!0,t.emit("drain")};li.encodePayload(e,this.supportsBinary,(function(e){t.doWrite(e,n)}))},pi.prototype.uri=function(){var e=this.query||{},t=this.secure?"https":"http",n="";return!1!==this.timestampRequests&&(e[this.timestampParam]=di()),this.supportsBinary||e.sid||(e.b64=1),e=oi.encode(e),this.port&&("https"===t&&443!==Number(this.port)||"http"===t&&80!==Number(this.port))&&(n=":"+this.port),e.length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e};var gi=us,mi=hi,yi=Us.exports,vi=Ks,bi=Xs.exports("engine.io-client:polling-xhr");function wi(){}function Si(e){if(mi.call(this,e),this.requestTimeout=e.requestTimeout,this.extraHeaders=e.extraHeaders,"undefined"!=typeof location){var t="https:"===location.protocol,n=location.port;n||(n=t?443:80),this.xd="undefined"!=typeof location&&e.hostname!==location.hostname||n!==e.port,this.xs=e.secure!==t}}function Ci(e){this.method=e.method||"GET",this.uri=e.uri,this.xd=!!e.xd,this.xs=!!e.xs,this.async=!1!==e.async,this.data=void 0!==e.data?e.data:null,this.agent=e.agent,this.isBinary=e.isBinary,this.supportsBinary=e.supportsBinary,this.enablesXDR=e.enablesXDR,this.requestTimeout=e.requestTimeout,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.extraHeaders=e.extraHeaders,this.create()}if(hs.exports=Si,hs.exports.Request=Ci,vi(Si,mi),Si.prototype.supportsBinary=!0,Si.prototype.request=function(e){return(e=e||{}).uri=this.uri(),e.xd=this.xd,e.xs=this.xs,e.agent=this.agent||!1,e.supportsBinary=this.supportsBinary,e.enablesXDR=this.enablesXDR,e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized,e.requestTimeout=this.requestTimeout,e.extraHeaders=this.extraHeaders,new Ci(e)},Si.prototype.doWrite=function(e,t){var n="string"!=typeof e&&void 0!==e,r=this.request({method:"POST",data:e,isBinary:n}),s=this;r.on("success",t),r.on("error",(function(e){s.onError("xhr post error",e)})),this.sendXhr=r},Si.prototype.doPoll=function(){bi("xhr poll");var e=this.request(),t=this;e.on("data",(function(e){t.onData(e)})),e.on("error",(function(e){t.onError("xhr poll error",e)})),this.pollXhr=e},yi(Ci.prototype),Ci.prototype.create=function(){var e={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized;var t=this.xhr=new gi(e),n=this;try{bi("xhr open %s: %s",this.method,this.uri),t.open(this.method,this.uri,this.async);try{if(this.extraHeaders)for(var r in t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0),this.extraHeaders)this.extraHeaders.hasOwnProperty(r)&&t.setRequestHeader(r,this.extraHeaders[r])}catch(e){}if("POST"===this.method)try{this.isBinary?t.setRequestHeader("Content-type","application/octet-stream"):t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=!0),this.requestTimeout&&(t.timeout=this.requestTimeout),this.hasXDR()?(t.onload=function(){n.onLoad()},t.onerror=function(){n.onError(t.responseText)}):t.onreadystatechange=function(){if(2===t.readyState)try{var e=t.getResponseHeader("Content-Type");n.supportsBinary&&"application/octet-stream"===e&&(t.responseType="arraybuffer")}catch(e){}4===t.readyState&&(200===t.status||1223===t.status?n.onLoad():setTimeout((function(){n.onError(t.status)}),0))},bi("xhr data %s",this.data),t.send(this.data)}catch(e){return void setTimeout((function(){n.onError(e)}),0)}"undefined"!=typeof document&&(this.index=Ci.requestsCount++,Ci.requests[this.index]=this)},Ci.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},Ci.prototype.onData=function(e){this.emit("data",e),this.onSuccess()},Ci.prototype.onError=function(e){this.emit("error",e),this.cleanup(!0)},Ci.prototype.cleanup=function(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=wi:this.xhr.onreadystatechange=wi,e)try{this.xhr.abort()}catch(e){}"undefined"!=typeof document&&delete Ci.requests[this.index],this.xhr=null}},Ci.prototype.onLoad=function(){var e;try{var t;try{t=this.xhr.getResponseHeader("Content-Type")}catch(e){}e="application/octet-stream"===t&&this.xhr.response||this.xhr.responseText}catch(e){this.onError(e)}null!=e&&this.onData(e)},Ci.prototype.hasXDR=function(){return"undefined"!=typeof XDomainRequest&&!this.xs&&this.enablesXDR},Ci.prototype.abort=function(){this.cleanup()},Ci.requestsCount=0,Ci.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",Ei);else if("function"==typeof addEventListener){var Ti="onpagehide"in self?"pagehide":"unload";addEventListener(Ti,Ei,!1)}function Ei(){for(var e in Ci.requests)Ci.requests.hasOwnProperty(e)&&Ci.requests[e].abort()}var Ii,ki=hi,Ai=Di,_i=/\n/g,Ri=/\\n/g;function Oi(){}function Li(){return"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==pt?pt:{}}function Di(e){if(ki.call(this,e),this.query=this.query||{},!Ii){var t=Li();Ii=t.___eio=t.___eio||[]}this.index=Ii.length;var n=this;Ii.push((function(e){n.onData(e)})),this.query.j=this.index,"function"==typeof addEventListener&&addEventListener("beforeunload",(function(){n.script&&(n.script.onerror=Oi)}),!1)}Ks(Di,ki),Di.prototype.supportsBinary=!1,Di.prototype.doClose=function(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),ki.prototype.doClose.call(this)},Di.prototype.doPoll=function(){var e=this,t=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),t.async=!0,t.src=this.uri(),t.onerror=function(t){e.onError("jsonp poll error",t)};var n=document.getElementsByTagName("script")[0];n?n.parentNode.insertBefore(t,n):(document.head||document.body).appendChild(t),this.script=t,"undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent)&&setTimeout((function(){var e=document.createElement("iframe");document.body.appendChild(e),document.body.removeChild(e)}),100)},Di.prototype.doWrite=function(e,t){var n=this;if(!this.form){var r,s=document.createElement("form"),i=document.createElement("textarea"),a=this.iframeId="eio_iframe_"+this.index;s.className="socketio",s.style.position="absolute",s.style.top="-1000px",s.style.left="-1000px",s.target=a,s.method="POST",s.setAttribute("accept-charset","utf-8"),i.name="d",s.appendChild(i),document.body.appendChild(s),this.form=s,this.area=i}function o(){l(),t()}function l(){if(n.iframe)try{n.form.removeChild(n.iframe)}catch(e){n.onError("jsonp polling iframe removal error",e)}try{var e='<iframe src="javascript:0" name="'+n.iframeId+'">';r=document.createElement(e)}catch(e){(r=document.createElement("iframe")).name=n.iframeId,r.src="javascript:0"}r.id=n.iframeId,n.form.appendChild(r),n.iframe=r}this.form.action=this.uri(),l(),e=e.replace(Ri,"\\\n"),this.area.value=e.replace(_i,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"===n.iframe.readyState&&o()}:this.iframe.onload=o};var xi,Pi,Mi=mt(Object.freeze({__proto__:null,default:{}})),Fi=Ns(),Ui=fs,Ni=$s(),Bi=Ks,ji=Qs,$i=Xs.exports("engine.io-client:websocket");if("undefined"!=typeof WebSocket)xi=WebSocket;else if("undefined"!=typeof self)xi=self.WebSocket||self.MozWebSocket;else try{Pi=Mi}catch(e){}var qi=xi||Pi,Ki=Gi;function Gi(e){e&&e.forceBase64&&(this.supportsBinary=!1),this.perMessageDeflate=e.perMessageDeflate,this.usingBrowserWebSocket=xi&&!e.forceNode,this.protocols=e.protocols,this.usingBrowserWebSocket||(qi=Pi),Fi.call(this,e)}Bi(Gi,Fi),Gi.prototype.name="websocket",Gi.prototype.supportsBinary=!0,Gi.prototype.doOpen=function(){if(this.check()){var e=this.uri(),t=this.protocols,n={agent:this.agent,perMessageDeflate:this.perMessageDeflate};n.pfx=this.pfx,n.key=this.key,n.passphrase=this.passphrase,n.cert=this.cert,n.ca=this.ca,n.ciphers=this.ciphers,n.rejectUnauthorized=this.rejectUnauthorized,this.extraHeaders&&(n.headers=this.extraHeaders),this.localAddress&&(n.localAddress=this.localAddress);try{this.ws=this.usingBrowserWebSocket&&!this.isReactNative?t?new qi(e,t):new qi(e):new qi(e,t,n)}catch(e){return this.emit("error",e)}void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.supports&&this.ws.supports.binary?(this.supportsBinary=!0,this.ws.binaryType="nodebuffer"):this.ws.binaryType="arraybuffer",this.addEventListeners()}},Gi.prototype.addEventListeners=function(){var e=this;this.ws.onopen=function(){e.onOpen()},this.ws.onclose=function(){e.onClose()},this.ws.onmessage=function(t){e.onData(t.data)},this.ws.onerror=function(t){e.onError("websocket error",t)}},Gi.prototype.write=function(e){var t=this;this.writable=!1;for(var n=e.length,r=0,s=n;r<s;r++)!function(e){Ui.encodePacket(e,t.supportsBinary,(function(r){if(!t.usingBrowserWebSocket){var s={};if(e.options&&(s.compress=e.options.compress),t.perMessageDeflate)("string"==typeof r?Buffer.byteLength(r):r.length)<t.perMessageDeflate.threshold&&(s.compress=!1)}try{t.usingBrowserWebSocket?t.ws.send(r):t.ws.send(r,s)}catch(e){$i("websocket closed before onclose event")}--n||i()}))}(e[r]);function i(){t.emit("flush"),setTimeout((function(){t.writable=!0,t.emit("drain")}),0)}},Gi.prototype.onClose=function(){Fi.prototype.onClose.call(this)},Gi.prototype.doClose=function(){void 0!==this.ws&&this.ws.close()},Gi.prototype.uri=function(){var e=this.query||{},t=this.secure?"wss":"ws",n="";return this.port&&("wss"===t&&443!==Number(this.port)||"ws"===t&&80!==Number(this.port))&&(n=":"+this.port),this.timestampRequests&&(e[this.timestampParam]=ji()),this.supportsBinary||(e.b64=1),(e=Ni.encode(e)).length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e},Gi.prototype.check=function(){return!(!qi||"__initialize"in qi&&this.name===Gi.prototype.name)};var Hi=us,Vi=hs.exports,zi=Ai,Wi=Ki;ss.polling=function(e){var t=!1,n=!1,r=!1!==e.jsonp;if("undefined"!=typeof location){var s="https:"===location.protocol,i=location.port;i||(i=s?443:80),t=e.hostname!==location.hostname||i!==e.port,n=e.secure!==s}if(e.xdomain=t,e.xscheme=n,"open"in new Hi(e)&&!e.forceJSONP)return new Vi(e);if(!r)throw new Error("JSONP disabled");return new zi(e)},ss.websocket=Wi;var Yi,Qi=[].indexOf,Xi=function(e,t){if(Qi)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1},Ji=ss,Zi=Us.exports,ea=Xs.exports("engine.io-client:socket"),ta=Xi,na=fs,ra=wr,sa=$s(),ia=aa;function aa(e,t){if(!(this instanceof aa))return new aa(e,t);t=t||{},e&&"object"==typeof e&&(t=e,e=null),e?(e=ra(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=ra(t.host).host),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.agent=t.agent||!1,this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?443:80),this.query=t.query||{},"string"==typeof this.query&&(this.query=sa.decode(this.query)),this.upgrade=!1!==t.upgrade,this.path=(t.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!t.forceJSONP,this.jsonp=!1!==t.jsonp,this.forceBase64=!!t.forceBase64,this.enablesXDR=!!t.enablesXDR,this.timestampParam=t.timestampParam||"t",this.timestampRequests=t.timestampRequests,this.transports=t.transports||["polling","websocket"],this.transportOptions=t.transportOptions||{},this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.policyPort=t.policyPort||843,this.rememberUpgrade=t.rememberUpgrade||!1,this.binaryType=null,this.onlyBinaryUpgrades=t.onlyBinaryUpgrades,this.perMessageDeflate=!1!==t.perMessageDeflate&&(t.perMessageDeflate||{}),!0===this.perMessageDeflate&&(this.perMessageDeflate={}),this.perMessageDeflate&&null==this.perMessageDeflate.threshold&&(this.perMessageDeflate.threshold=1024),this.pfx=t.pfx||null,this.key=t.key||null,this.passphrase=t.passphrase||null,this.cert=t.cert||null,this.ca=t.ca||null,this.ciphers=t.ciphers||null,this.rejectUnauthorized=void 0===t.rejectUnauthorized||t.rejectUnauthorized,this.forceNode=!!t.forceNode,this.isReactNative="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase(),("undefined"==typeof self||this.isReactNative)&&(t.extraHeaders&&Object.keys(t.extraHeaders).length>0&&(this.extraHeaders=t.extraHeaders),t.localAddress&&(this.localAddress=t.localAddress)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingIntervalTimer=null,this.pingTimeoutTimer=null,this.open()}aa.priorWebsocketSuccess=!1,Zi(aa.prototype),aa.protocol=na.protocol,aa.Socket=aa,aa.Transport=Ns(),aa.transports=ss,aa.parser=fs,aa.prototype.createTransport=function(e){ea('creating transport "%s"',e);var t=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}(this.query);t.EIO=na.protocol,t.transport=e;var n=this.transportOptions[e]||{};return this.id&&(t.sid=this.id),new Ji[e]({query:t,socket:this,agent:n.agent||this.agent,hostname:n.hostname||this.hostname,port:n.port||this.port,secure:n.secure||this.secure,path:n.path||this.path,forceJSONP:n.forceJSONP||this.forceJSONP,jsonp:n.jsonp||this.jsonp,forceBase64:n.forceBase64||this.forceBase64,enablesXDR:n.enablesXDR||this.enablesXDR,timestampRequests:n.timestampRequests||this.timestampRequests,timestampParam:n.timestampParam||this.timestampParam,policyPort:n.policyPort||this.policyPort,pfx:n.pfx||this.pfx,key:n.key||this.key,passphrase:n.passphrase||this.passphrase,cert:n.cert||this.cert,ca:n.ca||this.ca,ciphers:n.ciphers||this.ciphers,rejectUnauthorized:n.rejectUnauthorized||this.rejectUnauthorized,perMessageDeflate:n.perMessageDeflate||this.perMessageDeflate,extraHeaders:n.extraHeaders||this.extraHeaders,forceNode:n.forceNode||this.forceNode,localAddress:n.localAddress||this.localAddress,requestTimeout:n.requestTimeout||this.requestTimeout,protocols:n.protocols||void 0,isReactNative:this.isReactNative})},aa.prototype.open=function(){var e;if(this.rememberUpgrade&&aa.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length){var t=this;return void setTimeout((function(){t.emit("error","No transports available")}),0)}e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)},aa.prototype.setTransport=function(e){ea("setting transport %s",e.name);var t=this;this.transport&&(ea("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=e,e.on("drain",(function(){t.onDrain()})).on("packet",(function(e){t.onPacket(e)})).on("error",(function(e){t.onError(e)})).on("close",(function(){t.onClose("transport close")}))},aa.prototype.probe=function(e){ea('probing transport "%s"',e);var t=this.createTransport(e,{probe:1}),n=!1,r=this;function s(){if(r.onlyBinaryUpgrades){var s=!this.supportsBinary&&r.transport.supportsBinary;n=n||s}n||(ea('probe transport "%s" opened',e),t.send([{type:"ping",data:"probe"}]),t.once("packet",(function(s){if(!n)if("pong"===s.type&&"probe"===s.data){if(ea('probe transport "%s" pong',e),r.upgrading=!0,r.emit("upgrading",t),!t)return;aa.priorWebsocketSuccess="websocket"===t.name,ea('pausing current transport "%s"',r.transport.name),r.transport.pause((function(){n||"closed"!==r.readyState&&(ea("changing transport and sending upgrade packet"),d(),r.setTransport(t),t.send([{type:"upgrade"}]),r.emit("upgrade",t),t=null,r.upgrading=!1,r.flush())}))}else{ea('probe transport "%s" failed',e);var i=new Error("probe error");i.transport=t.name,r.emit("upgradeError",i)}})))}function i(){n||(n=!0,d(),t.close(),t=null)}function a(n){var s=new Error("probe error: "+n);s.transport=t.name,i(),ea('probe transport "%s" failed because of error: %s',e,n),r.emit("upgradeError",s)}function o(){a("transport closed")}function l(){a("socket closed")}function c(e){t&&e.name!==t.name&&(ea('"%s" works - aborting "%s"',e.name,t.name),i())}function d(){t.removeListener("open",s),t.removeListener("error",a),t.removeListener("close",o),r.removeListener("close",l),r.removeListener("upgrading",c)}aa.priorWebsocketSuccess=!1,t.once("open",s),t.once("error",a),t.once("close",o),this.once("close",l),this.once("upgrading",c),t.open()},aa.prototype.onOpen=function(){if(ea("socket open"),this.readyState="open",aa.priorWebsocketSuccess="websocket"===this.transport.name,this.emit("open"),this.flush(),"open"===this.readyState&&this.upgrade&&this.transport.pause){ea("starting upgrade probes");for(var e=0,t=this.upgrades.length;e<t;e++)this.probe(this.upgrades[e])}},aa.prototype.onPacket=function(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(ea('socket receive: type "%s", data "%s"',e.type,e.data),this.emit("packet",e),this.emit("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"pong":this.setPing(),this.emit("pong");break;case"error":var t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emit("data",e.data),this.emit("message",e.data)}else ea('packet received with socket readyState "%s"',this.readyState)},aa.prototype.onHandshake=function(e){this.emit("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.onOpen(),"closed"!==this.readyState&&(this.setPing(),this.removeListener("heartbeat",this.onHeartbeat),this.on("heartbeat",this.onHeartbeat))},aa.prototype.onHeartbeat=function(e){clearTimeout(this.pingTimeoutTimer);var t=this;t.pingTimeoutTimer=setTimeout((function(){"closed"!==t.readyState&&t.onClose("ping timeout")}),e||t.pingInterval+t.pingTimeout)},aa.prototype.setPing=function(){var e=this;clearTimeout(e.pingIntervalTimer),e.pingIntervalTimer=setTimeout((function(){ea("writing ping packet - expecting pong within %sms",e.pingTimeout),e.ping(),e.onHeartbeat(e.pingTimeout)}),e.pingInterval)},aa.prototype.ping=function(){var e=this;this.sendPacket("ping",(function(){e.emit("ping")}))},aa.prototype.onDrain=function(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emit("drain"):this.flush()},aa.prototype.flush=function(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(ea("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))},aa.prototype.write=aa.prototype.send=function(e,t,n){return this.sendPacket("message",e,t,n),this},aa.prototype.sendPacket=function(e,t,n,r){if("function"==typeof t&&(r=t,t=void 0),"function"==typeof n&&(r=n,n=null),"closing"!==this.readyState&&"closed"!==this.readyState){(n=n||{}).compress=!1!==n.compress;var s={type:e,data:t,options:n};this.emit("packetCreate",s),this.writeBuffer.push(s),r&&this.once("flush",r),this.flush()}},aa.prototype.close=function(){if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";var e=this;this.writeBuffer.length?this.once("drain",(function(){this.upgrading?r():t()})):this.upgrading?r():t()}function t(){e.onClose("forced close"),ea("socket closing - telling transport to close"),e.transport.close()}function n(){e.removeListener("upgrade",n),e.removeListener("upgradeError",n),t()}function r(){e.once("upgrade",n),e.once("upgradeError",n)}return this},aa.prototype.onError=function(e){ea("socket error %j",e),aa.priorWebsocketSuccess=!1,this.emit("error",e),this.onClose("transport error",e)},aa.prototype.onClose=function(e,t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){ea('socket close with reason: "%s"',e);clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",e,t),this.writeBuffer=[],this.prevBufferLen=0}},aa.prototype.filterUpgrades=function(e){for(var t=[],n=0,r=e.length;n<r;n++)~ta(this.transports,e[n])&&t.push(e[n]);return t},(Yi=rs).exports=ia,Yi.exports.parser=fs;var oa,la,ca={exports:{}},da={exports:{}};!function(e){function t(e){if(e)return function(e){for(var n in t.prototype)e[n]=t.prototype[n];return e}(e)}e.exports=t,t.prototype.on=t.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},t.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},t.prototype.off=t.prototype.removeListener=t.prototype.removeAllListeners=t.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks["$"+e];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var s=0;s<r.length;s++)if((n=r[s])===t||n.fn===t){r.splice(s,1);break}return this},t.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks["$"+e];if(n)for(var r=0,s=(n=n.slice(0)).length;r<s;++r)n[r].apply(this,t);return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length}}(da);var ua=function(e,t,n){return e.on(t,n),{destroy:function(){e.removeListener(t,n)}}};var ha,fa=[].slice,pa=function(e,t){if("string"==typeof t&&(t=e[t]),"function"!=typeof t)throw new Error("bind() requires a function");var n=fa.call(arguments,2);return function(){return t.apply(e,n.concat(fa.call(arguments)))}};function ga(){return ha||(ha=1,function(e,t){var n=xr,r=da.exports,s=(la||(la=1,oa=function(e,t){for(var n=[],r=(t=t||0)||0;r<e.length;r++)n[r-t]=e[r];return n}),oa),i=ua,a=pa,o=Sr.exports("socket.io-client:socket"),l=$s(),c=gs();e.exports=h;var d={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1,ping:1,pong:1},u=r.prototype.emit;function h(e,t,n){this.io=e,this.nsp=t,this.json=this,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,this.flags={},n&&n.query&&(this.query=n.query),this.io.autoConnect&&this.open()}r(h.prototype),h.prototype.subEvents=function(){if(!this.subs){var e=this.io;this.subs=[i(e,"open",a(this,"onopen")),i(e,"packet",a(this,"onpacket")),i(e,"close",a(this,"onclose"))]}},h.prototype.open=h.prototype.connect=function(){return this.connected||(this.subEvents(),this.io.open(),"open"===this.io.readyState&&this.onopen(),this.emit("connecting")),this},h.prototype.send=function(){var e=s(arguments);return e.unshift("message"),this.emit.apply(this,e),this},h.prototype.emit=function(e){if(d.hasOwnProperty(e))return u.apply(this,arguments),this;var t=s(arguments),r={type:(void 0!==this.flags.binary?this.flags.binary:c(t))?n.BINARY_EVENT:n.EVENT,data:t,options:{}};return r.options.compress=!this.flags||!1!==this.flags.compress,"function"==typeof t[t.length-1]&&(o("emitting packet with ack id %d",this.ids),this.acks[this.ids]=t.pop(),r.id=this.ids++),this.connected?this.packet(r):this.sendBuffer.push(r),this.flags={},this},h.prototype.packet=function(e){e.nsp=this.nsp,this.io.packet(e)},h.prototype.onopen=function(){if(o("transport is open - connecting"),"/"!==this.nsp)if(this.query){var e="object"==typeof this.query?l.encode(this.query):this.query;o("sending connect packet with query %s",e),this.packet({type:n.CONNECT,query:e})}else this.packet({type:n.CONNECT})},h.prototype.onclose=function(e){o("close (%s)",e),this.connected=!1,this.disconnected=!0,delete this.id,this.emit("disconnect",e)},h.prototype.onpacket=function(e){var t=e.nsp===this.nsp,r=e.type===n.ERROR&&"/"===e.nsp;if(t||r)switch(e.type){case n.CONNECT:this.onconnect();break;case n.EVENT:case n.BINARY_EVENT:this.onevent(e);break;case n.ACK:case n.BINARY_ACK:this.onack(e);break;case n.DISCONNECT:this.ondisconnect();break;case n.ERROR:this.emit("error",e.data)}},h.prototype.onevent=function(e){var t=e.data||[];o("emitting event %j",t),null!=e.id&&(o("attaching ack callback to event"),t.push(this.ack(e.id))),this.connected?u.apply(this,t):this.receiveBuffer.push(t)},h.prototype.ack=function(e){var t=this,r=!1;return function(){if(!r){r=!0;var i=s(arguments);o("sending ack %j",i),t.packet({type:c(i)?n.BINARY_ACK:n.ACK,id:e,data:i})}}},h.prototype.onack=function(e){var t=this.acks[e.id];"function"==typeof t?(o("calling ack %s with %j",e.id,e.data),t.apply(this,e.data),delete this.acks[e.id]):o("bad ack %s",e.id)},h.prototype.onconnect=function(){this.connected=!0,this.disconnected=!1,this.emit("connect"),this.emitBuffered()},h.prototype.emitBuffered=function(){var e;for(e=0;e<this.receiveBuffer.length;e++)u.apply(this,this.receiveBuffer[e]);for(this.receiveBuffer=[],e=0;e<this.sendBuffer.length;e++)this.packet(this.sendBuffer[e]);this.sendBuffer=[]},h.prototype.ondisconnect=function(){o("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")},h.prototype.destroy=function(){if(this.subs){for(var e=0;e<this.subs.length;e++)this.subs[e].destroy();this.subs=null}this.io.destroy(this)},h.prototype.close=h.prototype.disconnect=function(){return this.connected&&(o("performing disconnect (%s)",this.nsp),this.packet({type:n.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this},h.prototype.compress=function(e){return this.flags.compress=e,this},h.prototype.binary=function(e){return this.flags.binary=e,this}}(ca)),ca.exports}var ma=ya;function ya(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}ya.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-n:e+n}return 0|Math.min(e,this.max)},ya.prototype.reset=function(){this.attempts=0},ya.prototype.setMin=function(e){this.ms=e},ya.prototype.setMax=function(e){this.max=e},ya.prototype.setJitter=function(e){this.jitter=e};var va=rs.exports,ba=ga(),wa=da.exports,Sa=xr,Ca=ua,Ta=pa,Ea=Sr.exports("socket.io-client:manager"),Ia=Xi,ka=ma,Aa=Object.prototype.hasOwnProperty,_a=Ra;function Ra(e,t){if(!(this instanceof Ra))return new Ra(e,t);e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.nsps={},this.subs=[],this.opts=t,this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(t.randomizationFactor||.5),this.backoff=new ka({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this.readyState="closed",this.uri=e,this.connecting=[],this.lastPing=null,this.encoding=!1,this.packetBuffer=[];var n=t.parser||Sa;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this.autoConnect=!1!==t.autoConnect,this.autoConnect&&this.open()}Ra.prototype.emitAll=function(){for(var e in this.emit.apply(this,arguments),this.nsps)Aa.call(this.nsps,e)&&this.nsps[e].emit.apply(this.nsps[e],arguments)},Ra.prototype.updateSocketIds=function(){for(var e in this.nsps)Aa.call(this.nsps,e)&&(this.nsps[e].id=this.generateId(e))},Ra.prototype.generateId=function(e){return("/"===e?"":e+"#")+this.engine.id},wa(Ra.prototype),Ra.prototype.reconnection=function(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection},Ra.prototype.reconnectionAttempts=function(e){return arguments.length?(this._reconnectionAttempts=e,this):this._reconnectionAttempts},Ra.prototype.reconnectionDelay=function(e){return arguments.length?(this._reconnectionDelay=e,this.backoff&&this.backoff.setMin(e),this):this._reconnectionDelay},Ra.prototype.randomizationFactor=function(e){return arguments.length?(this._randomizationFactor=e,this.backoff&&this.backoff.setJitter(e),this):this._randomizationFactor},Ra.prototype.reconnectionDelayMax=function(e){return arguments.length?(this._reconnectionDelayMax=e,this.backoff&&this.backoff.setMax(e),this):this._reconnectionDelayMax},Ra.prototype.timeout=function(e){return arguments.length?(this._timeout=e,this):this._timeout},Ra.prototype.maybeReconnectOnOpen=function(){!this.reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()},Ra.prototype.open=Ra.prototype.connect=function(e,t){if(Ea("readyState %s",this.readyState),~this.readyState.indexOf("open"))return this;Ea("opening %s",this.uri),this.engine=va(this.uri,this.opts);var n=this.engine,r=this;this.readyState="opening",this.skipReconnect=!1;var s=Ca(n,"open",(function(){r.onopen(),e&&e()})),i=Ca(n,"error",(function(t){if(Ea("connect_error"),r.cleanup(),r.readyState="closed",r.emitAll("connect_error",t),e){var n=new Error("Connection error");n.data=t,e(n)}else r.maybeReconnectOnOpen()}));if(!1!==this._timeout){var a=this._timeout;Ea("connect attempt will timeout after %d",a);var o=setTimeout((function(){Ea("connect attempt timed out after %d",a),s.destroy(),n.close(),n.emit("error","timeout"),r.emitAll("connect_timeout",a)}),a);this.subs.push({destroy:function(){clearTimeout(o)}})}return this.subs.push(s),this.subs.push(i),this},Ra.prototype.onopen=function(){Ea("open"),this.cleanup(),this.readyState="open",this.emit("open");var e=this.engine;this.subs.push(Ca(e,"data",Ta(this,"ondata"))),this.subs.push(Ca(e,"ping",Ta(this,"onping"))),this.subs.push(Ca(e,"pong",Ta(this,"onpong"))),this.subs.push(Ca(e,"error",Ta(this,"onerror"))),this.subs.push(Ca(e,"close",Ta(this,"onclose"))),this.subs.push(Ca(this.decoder,"decoded",Ta(this,"ondecoded")))},Ra.prototype.onping=function(){this.lastPing=new Date,this.emitAll("ping")},Ra.prototype.onpong=function(){this.emitAll("pong",new Date-this.lastPing)},Ra.prototype.ondata=function(e){this.decoder.add(e)},Ra.prototype.ondecoded=function(e){this.emit("packet",e)},Ra.prototype.onerror=function(e){Ea("error",e),this.emitAll("error",e)},Ra.prototype.socket=function(e,t){var n=this.nsps[e];if(!n){n=new ba(this,e,t),this.nsps[e]=n;var r=this;n.on("connecting",s),n.on("connect",(function(){n.id=r.generateId(e)})),this.autoConnect&&s()}function s(){~Ia(r.connecting,n)||r.connecting.push(n)}return n},Ra.prototype.destroy=function(e){var t=Ia(this.connecting,e);~t&&this.connecting.splice(t,1),this.connecting.length||this.close()},Ra.prototype.packet=function(e){Ea("writing packet %j",e);var t=this;e.query&&0===e.type&&(e.nsp+="?"+e.query),t.encoding?t.packetBuffer.push(e):(t.encoding=!0,this.encoder.encode(e,(function(n){for(var r=0;r<n.length;r++)t.engine.write(n[r],e.options);t.encoding=!1,t.processPacketQueue()})))},Ra.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var e=this.packetBuffer.shift();this.packet(e)}},Ra.prototype.cleanup=function(){Ea("cleanup");for(var e=this.subs.length,t=0;t<e;t++){this.subs.shift().destroy()}this.packetBuffer=[],this.encoding=!1,this.lastPing=null,this.decoder.destroy()},Ra.prototype.close=Ra.prototype.disconnect=function(){Ea("disconnect"),this.skipReconnect=!0,this.reconnecting=!1,"opening"===this.readyState&&this.cleanup(),this.backoff.reset(),this.readyState="closed",this.engine&&this.engine.close()},Ra.prototype.onclose=function(e){Ea("onclose"),this.cleanup(),this.backoff.reset(),this.readyState="closed",this.emit("close",e),this._reconnection&&!this.skipReconnect&&this.reconnect()},Ra.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var e=this;if(this.backoff.attempts>=this._reconnectionAttempts)Ea("reconnect failed"),this.backoff.reset(),this.emitAll("reconnect_failed"),this.reconnecting=!1;else{var t=this.backoff.duration();Ea("will wait %dms before reconnect attempt",t),this.reconnecting=!0;var n=setTimeout((function(){e.skipReconnect||(Ea("attempting reconnect"),e.emitAll("reconnect_attempt",e.backoff.attempts),e.emitAll("reconnecting",e.backoff.attempts),e.skipReconnect||e.open((function(t){t?(Ea("reconnect attempt error"),e.reconnecting=!1,e.reconnect(),e.emitAll("reconnect_error",t.data)):(Ea("reconnect success"),e.onreconnect())})))}),t);this.subs.push({destroy:function(){clearTimeout(n)}})}},Ra.prototype.onreconnect=function(){var e=this.backoff.attempts;this.reconnecting=!1,this.backoff.reset(),this.updateSocketIds(),this.emitAll("reconnect",e)},function(e,t){var n=Dr,r=xr,s=_a,i=Sr.exports("socket.io-client");e.exports=t=o;var a=t.managers={};function o(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var r,o=n(e),l=o.source,c=o.id,d=o.path,u=a[c]&&d in a[c].nsps;return t.forceNew||t["force new connection"]||!1===t.multiplex||u?(i("ignoring socket cache for %s",l),r=s(l,t)):(a[c]||(i("new io instance for %s",l),a[c]=s(l,t)),r=a[c]),o.query&&!t.query&&(t.query=o.query),r.socket(o.path,t)}t.protocol=r.protocol,t.connect=o,t.Manager=_a,t.Socket=ga()}(yr,yr.exports);var Oa=yr.exports;function La(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Da={exports:{}};!function(e,t){e.exports=function(){function e(t,n,r){function s(a,o){if(!n[a]){if(!t[a]){if(!o&&La)return La(a);if(i)return i(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var c=n[a]={exports:{}};t[a][0].call(c.exports,(function(e){return s(t[a][1][e]||e)}),c,c.exports,e,t,n,r)}return n[a].exports}for(var i=La,a=0;a<r.length;a++)s(r[a]);return s}return e}()({1:[function(e,t,n){(function(n,r){(function(){const s=e("events").EventEmitter,i=e("./store"),a=e("./topic-alias-recv"),o=e("./topic-alias-send"),l=e("mqtt-packet"),c=e("./default-message-id-provider"),d=e("readable-stream").Writable,u=e("inherits"),h=e("reinterval"),f=e("rfdc/default"),p=e("./validations"),g=e("xtend"),m=e("debug")("mqttjs:client"),y=n?n.nextTick:function(e){setTimeout(e,0)},v=r.setImmediate||function(e){y(e)},b={keepalive:60,reschedulePings:!0,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:1e3,connectTimeout:3e4,clean:!0,resubscribe:!0},w=["ECONNREFUSED","EADDRINUSE","ECONNRESET","ENOTFOUND"],S={0:"",1:"Unacceptable protocol version",2:"Identifier rejected",3:"Server unavailable",4:"Bad username or password",5:"Not authorized",16:"No matching subscribers",17:"No subscription existed",128:"Unspecified error",129:"Malformed Packet",130:"Protocol Error",131:"Implementation specific error",132:"Unsupported Protocol Version",133:"Client Identifier not valid",134:"Bad User Name or Password",135:"Not authorized",136:"Server unavailable",137:"Server busy",138:"Banned",139:"Server shutting down",140:"Bad authentication method",141:"Keep Alive timeout",142:"Session taken over",143:"Topic Filter invalid",144:"Topic Name invalid",145:"Packet identifier in use",146:"Packet Identifier not found",147:"Receive Maximum exceeded",148:"Topic Alias invalid",149:"Packet too large",150:"Message rate too high",151:"Quota exceeded",152:"Administrative action",153:"Payload format invalid",154:"Retain not supported",155:"QoS not supported",156:"Use another server",157:"Server moved",158:"Shared Subscriptions not supported",159:"Connection rate exceeded",160:"Maximum connect time",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"};function C(){return"mqttjs_"+Math.random().toString(16).substr(2,8)}function T(e,t){if(5===e.options.protocolVersion&&"publish"===t.cmd){let n;t.properties&&(n=t.properties.topicAlias);const r=t.topic.toString();if(e.topicAliasSend)if(n){if(0!==r.length&&(m("applyTopicAlias :: register topic: %s - alias: %d",r,n),!e.topicAliasSend.put(r,n)))return m("applyTopicAlias :: error out of range. topic: %s - alias: %d",r,n),new Error("Sending Topic Alias out of range")}else 0!==r.length&&(e.options.autoAssignTopicAlias?(n=e.topicAliasSend.getAliasByTopic(r),n?(t.topic="",t.properties={...t.properties,topicAlias:n},m("applyTopicAlias :: auto assign(use) topic: %s - alias: %d",r,n)):(n=e.topicAliasSend.getLruAlias(),e.topicAliasSend.put(r,n),t.properties={...t.properties,topicAlias:n},m("applyTopicAlias :: auto assign topic: %s - alias: %d",r,n))):e.options.autoUseTopicAlias&&(n=e.topicAliasSend.getAliasByTopic(r),n&&(t.topic="",t.properties={...t.properties,topicAlias:n},m("applyTopicAlias :: auto use topic: %s - alias: %d",r,n))));else if(n)return m("applyTopicAlias :: error out of range. topic: %s - alias: %d",r,n),new Error("Sending Topic Alias out of range")}}function E(e,t){let n;t.properties&&(n=t.properties.topicAlias);let r=t.topic.toString();if(0===r.length){if(void 0===n)return new Error("Unregistered Topic Alias");if(r=e.topicAliasSend.getTopicByAlias(n),void 0===r)return new Error("Unregistered Topic Alias");t.topic=r}n&&delete t.properties.topicAlias}function I(e,t,n){m("sendPacket :: packet: %O",t),m("sendPacket :: emitting `packetsend`"),e.emit("packetsend",t),m("sendPacket :: writing to stream");const r=l.writeToStream(t,e.stream,e.options);m("sendPacket :: writeToStream result %s",r),!r&&n&&n!==R?(m("sendPacket :: handle events on `drain` once through callback."),e.stream.once("drain",n)):n&&(m("sendPacket :: invoking cb"),n())}function k(e){e&&(m("flush: queue exists? %b",!!e),Object.keys(e).forEach((function(t){"function"==typeof e[t].cb&&(e[t].cb(new Error("Connection closed")),delete e[t])})))}function A(e){e&&(m("flushVolatile :: deleting volatile messages from the queue and setting their callbacks as error function"),Object.keys(e).forEach((function(t){e[t].volatile&&"function"==typeof e[t].cb&&(e[t].cb(new Error("Connection closed")),delete e[t])})))}function _(e,t,n,r){m("storeAndSend :: store packet with cmd %s to outgoingStore",t.cmd);let s,i=t;if("publish"===i.cmd&&(i=f(t),s=E(e,i),s))return n&&n(s);e.outgoingStore.put(i,(function(s){if(s)return n&&n(s);r(),I(e,t,n)}))}function R(e){m("nop ::",e)}function O(e,t){let n;const r=this;if(!(this instanceof O))return new O(e,t);for(n in this.options=t||{},b)void 0===this.options[n]?this.options[n]=b[n]:this.options[n]=t[n];m("MqttClient :: options.protocol",t.protocol),m("MqttClient :: options.protocolVersion",t.protocolVersion),m("MqttClient :: options.username",t.username),m("MqttClient :: options.keepalive",t.keepalive),m("MqttClient :: options.reconnectPeriod",t.reconnectPeriod),m("MqttClient :: options.rejectUnauthorized",t.rejectUnauthorized),m("MqttClient :: options.topicAliasMaximum",t.topicAliasMaximum),this.options.clientId="string"==typeof t.clientId?t.clientId:C(),m("MqttClient :: clientId",this.options.clientId),this.options.customHandleAcks=5===t.protocolVersion&&t.customHandleAcks?t.customHandleAcks:function(){arguments[3](0)},this.streamBuilder=e,this.messageIdProvider=void 0===this.options.messageIdProvider?new c:this.options.messageIdProvider,this.outgoingStore=t.outgoingStore||new i,this.incomingStore=t.incomingStore||new i,this.queueQoSZero=void 0===t.queueQoSZero||t.queueQoSZero,this._resubscribeTopics={},this.messageIdToTopic={},this.pingTimer=null,this.connected=!1,this.disconnecting=!1,this.queue=[],this.connackTimer=null,this.reconnectTimer=null,this._storeProcessing=!1,this._packetIdsDuringStoreProcessing={},this._storeProcessingQueue=[],this.outgoing={},this._firstConnection=!0,t.topicAliasMaximum>0&&(t.topicAliasMaximum>65535?m("MqttClient :: options.topicAliasMaximum is out of range"):this.topicAliasRecv=new a(t.topicAliasMaximum)),this.on("connect",(function(){const e=this.queue;function t(){const n=e.shift();m("deliver :: entry %o",n);let s=null;if(!n)return void r._resubscribe();s=n.packet,m("deliver :: call _sendPacket for %o",s);let i=!0;s.messageId&&0!==s.messageId&&(r.messageIdProvider.register(s.messageId)||(i=!1)),i?r._sendPacket(s,(function(e){n.cb&&n.cb(e),t()})):(m("messageId: %d has already used. The message is skipped and removed.",s.messageId),t())}m("connect :: sending queued packets"),t()})),this.on("close",(function(){m("close :: connected set to `false`"),this.connected=!1,m("close :: clearing connackTimer"),clearTimeout(this.connackTimer),m("close :: clearing ping timer"),null!==r.pingTimer&&(r.pingTimer.clear(),r.pingTimer=null),this.topicAliasRecv&&this.topicAliasRecv.clear(),m("close :: calling _setupReconnect"),this._setupReconnect()})),s.call(this),m("MqttClient :: setting up stream"),this._setupStream()}u(O,s),O.prototype._setupStream=function(){const e=this,t=new d,n=l.parser(this.options);let r=null;const s=[];function i(){if(s.length)y(a);else{const e=r;r=null,e()}}function a(){m("work :: getting next packet in queue");const t=s.shift();if(t)m("work :: packet pulled from queue"),e._handlePacket(t,i);else{m("work :: no packets in queue");const e=r;r=null,m("work :: done flag is %s",!!e),e&&e()}}function o(t){m("streamErrorHandler :: error",t.message),w.includes(t.code)?(m("streamErrorHandler :: emitting error"),e.emit("error",t)):R(t)}m("_setupStream :: calling method to clear reconnect"),this._clearReconnect(),m("_setupStream :: using streamBuilder provided to client to create stream"),this.stream=this.streamBuilder(this),n.on("packet",(function(e){m("parser :: on packet push to packets array."),s.push(e)})),t._write=function(e,t,s){r=s,m("writable stream :: parsing buffer"),n.parse(e),a()},m("_setupStream :: pipe stream to writable stream"),this.stream.pipe(t),this.stream.on("error",o),this.stream.on("close",(function(){m("(%s)stream :: on close",e.options.clientId),A(e.outgoing),m("stream: emit close to MqttClient"),e.emit("close")})),m("_setupStream: sending packet `connect`");const c=Object.create(this.options);if(c.cmd="connect",this.topicAliasRecv&&(c.properties||(c.properties={}),this.topicAliasRecv&&(c.properties.topicAliasMaximum=this.topicAliasRecv.max)),I(this,c),n.on("error",this.emit.bind(this,"error")),this.options.properties){if(!this.options.properties.authenticationMethod&&this.options.properties.authenticationData)return e.end((()=>this.emit("error",new Error("Packet has no Authentication Method")))),this;this.options.properties.authenticationMethod&&this.options.authPacket&&"object"==typeof this.options.authPacket&&I(this,g({cmd:"auth",reasonCode:0},this.options.authPacket))}this.stream.setMaxListeners(1e3),clearTimeout(this.connackTimer),this.connackTimer=setTimeout((function(){m("!!connectTimeout hit!! Calling _cleanUp with force `true`"),e._cleanUp(!0)}),this.options.connectTimeout)},O.prototype._handlePacket=function(e,t){const n=this.options;if(5===n.protocolVersion&&n.properties&&n.properties.maximumPacketSize&&n.properties.maximumPacketSize<e.length)return this.emit("error",new Error("exceeding packets size "+e.cmd)),this.end({reasonCode:149,properties:{reasonString:"Maximum packet size was exceeded"}}),this;switch(m("_handlePacket :: emitting packetreceive"),this.emit("packetreceive",e),e.cmd){case"publish":this._handlePublish(e,t);break;case"puback":case"pubrec":case"pubcomp":case"suback":case"unsuback":this._handleAck(e),t();break;case"pubrel":this._handlePubrel(e,t);break;case"connack":this._handleConnack(e),t();break;case"auth":this._handleAuth(e),t();break;case"pingresp":this._handlePingresp(e),t();break;case"disconnect":this._handleDisconnect(e),t()}},O.prototype._checkDisconnecting=function(e){return this.disconnecting&&(e&&e!==R?e(new Error("client disconnecting")):this.emit("error",new Error("client disconnecting"))),this.disconnecting},O.prototype.publish=function(e,t,n,r){m("publish :: message `%s` to topic `%s`",t,e);const s=this.options;if("function"==typeof n&&(r=n,n=null),n=g({qos:0,retain:!1,dup:!1},n),this._checkDisconnecting(r))return this;const i=this,a=function(){let a=0;if((1===n.qos||2===n.qos)&&(a=i._nextId(),null===a))return m("No messageId left"),!1;const o={cmd:"publish",topic:e,payload:t,qos:n.qos,retain:n.retain,messageId:a,dup:n.dup};switch(5===s.protocolVersion&&(o.properties=n.properties),m("publish :: qos",n.qos),n.qos){case 1:case 2:i.outgoing[o.messageId]={volatile:!1,cb:r||R},m("MqttClient:publish: packet cmd: %s",o.cmd),i._sendPacket(o,void 0,n.cbStorePut);break;default:m("MqttClient:publish: packet cmd: %s",o.cmd),i._sendPacket(o,r,n.cbStorePut)}return!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!a())&&this._storeProcessingQueue.push({invoke:a,cbStorePut:n.cbStorePut,callback:r}),this},O.prototype.subscribe=function(){const e=this,t=new Array(arguments.length);for(let e=0;e<arguments.length;e++)t[e]=arguments[e];const n=[];let r=t.shift();const s=r.resubscribe;let i=t.pop()||R,a=t.pop();const o=this.options.protocolVersion;delete r.resubscribe,"string"==typeof r&&(r=[r]),"function"!=typeof i&&(a=i,i=R);const l=p.validateTopics(r);if(null!==l)return v(i,new Error("Invalid topic "+l)),this;if(this._checkDisconnecting(i))return m("subscribe: discconecting true"),this;const c={qos:0};if(5===o&&(c.nl=!1,c.rap=!1,c.rh=0),a=g(c,a),Array.isArray(r)?r.forEach((function(t){if(m("subscribe: array topic %s",t),!Object.prototype.hasOwnProperty.call(e._resubscribeTopics,t)||e._resubscribeTopics[t].qos<a.qos||s){const e={topic:t,qos:a.qos};5===o&&(e.nl=a.nl,e.rap=a.rap,e.rh=a.rh,e.properties=a.properties),m("subscribe: pushing topic `%s` and qos `%s` to subs list",e.topic,e.qos),n.push(e)}})):Object.keys(r).forEach((function(t){if(m("subscribe: object topic %s",t),!Object.prototype.hasOwnProperty.call(e._resubscribeTopics,t)||e._resubscribeTopics[t].qos<r[t].qos||s){const e={topic:t,qos:r[t].qos};5===o&&(e.nl=r[t].nl,e.rap=r[t].rap,e.rh=r[t].rh,e.properties=a.properties),m("subscribe: pushing `%s` to subs list",e),n.push(e)}})),!n.length)return i(null,[]),this;const d=function(){const t=e._nextId();if(null===t)return m("No messageId left"),!1;const r={cmd:"subscribe",subscriptions:n,qos:1,retain:!1,dup:!1,messageId:t};if(a.properties&&(r.properties=a.properties),e.options.resubscribe){m("subscribe :: resubscribe true");const t=[];n.forEach((function(n){if(e.options.reconnectPeriod>0){const r={qos:n.qos};5===o&&(r.nl=n.nl||!1,r.rap=n.rap||!1,r.rh=n.rh||0,r.properties=n.properties),e._resubscribeTopics[n.topic]=r,t.push(n.topic)}})),e.messageIdToTopic[r.messageId]=t}return e.outgoing[r.messageId]={volatile:!0,cb:function(e,t){if(!e){const e=t.granted;for(let t=0;t<e.length;t+=1)n[t].qos=e[t]}i(e,n)}},m("subscribe :: call _sendPacket"),e._sendPacket(r),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!d())&&this._storeProcessingQueue.push({invoke:d,callback:i}),this},O.prototype.unsubscribe=function(){const e=this,t=new Array(arguments.length);for(let e=0;e<arguments.length;e++)t[e]=arguments[e];let n=t.shift(),r=t.pop()||R,s=t.pop();"string"==typeof n&&(n=[n]),"function"!=typeof r&&(s=r,r=R);const i=p.validateTopics(n);if(null!==i)return v(r,new Error("Invalid topic "+i)),this;if(e._checkDisconnecting(r))return this;const a=function(){const t=e._nextId();if(null===t)return m("No messageId left"),!1;const i={cmd:"unsubscribe",qos:1,messageId:t};return"string"==typeof n?i.unsubscriptions=[n]:Array.isArray(n)&&(i.unsubscriptions=n),e.options.resubscribe&&i.unsubscriptions.forEach((function(t){delete e._resubscribeTopics[t]})),"object"==typeof s&&s.properties&&(i.properties=s.properties),e.outgoing[i.messageId]={volatile:!0,cb:r},m("unsubscribe: call _sendPacket"),e._sendPacket(i),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!a())&&this._storeProcessingQueue.push({invoke:a,callback:r}),this},O.prototype.end=function(e,t,n){const r=this;function s(){m("end :: closeStores: closing incoming and outgoing stores"),r.disconnected=!0,r.incomingStore.close((function(e){r.outgoingStore.close((function(t){if(m("end :: closeStores: emitting end"),r.emit("end"),n){const r=e||t;m("end :: closeStores: invoking callback with args"),n(r)}}))})),r._deferredReconnect&&r._deferredReconnect()}function i(){m("end :: (%s) :: finish :: calling _cleanUp with force %s",r.options.clientId,e),r._cleanUp(e,(()=>{m("end :: finish :: calling process.nextTick on closeStores"),y(s.bind(r))}),t)}return m("end :: (%s)",this.options.clientId),null!=e&&"boolean"==typeof e||(n=t||R,t=e,e=!1,"object"!=typeof t&&(n=t,t=null,"function"!=typeof n&&(n=R))),"object"!=typeof t&&(n=t,t=null),m("end :: cb? %s",!!n),n=n||R,this.disconnecting?(n(),this):(this._clearReconnect(),this.disconnecting=!0,!e&&Object.keys(this.outgoing).length>0?(m("end :: (%s) :: calling finish in 10ms once outgoing is empty",r.options.clientId),this.once("outgoingEmpty",setTimeout.bind(null,i,10))):(m("end :: (%s) :: immediately calling finish",r.options.clientId),i()),this)},O.prototype.removeOutgoingMessage=function(e){const t=this.outgoing[e]?this.outgoing[e].cb:null;return delete this.outgoing[e],this.outgoingStore.del({messageId:e},(function(){t(new Error("Message removed"))})),this},O.prototype.reconnect=function(e){m("client reconnect");const t=this,n=function(){e?(t.options.incomingStore=e.incomingStore,t.options.outgoingStore=e.outgoingStore):(t.options.incomingStore=null,t.options.outgoingStore=null),t.incomingStore=t.options.incomingStore||new i,t.outgoingStore=t.options.outgoingStore||new i,t.disconnecting=!1,t.disconnected=!1,t._deferredReconnect=null,t._reconnect()};return this.disconnecting&&!this.disconnected?this._deferredReconnect=n:n(),this},O.prototype._reconnect=function(){m("_reconnect: emitting reconnect to client"),this.emit("reconnect"),this.connected?(this.end((()=>{this._setupStream()})),m("client already connected. disconnecting first.")):(m("_reconnect: calling _setupStream"),this._setupStream())},O.prototype._setupReconnect=function(){const e=this;!e.disconnecting&&!e.reconnectTimer&&e.options.reconnectPeriod>0?(this.reconnecting||(m("_setupReconnect :: emit `offline` state"),this.emit("offline"),m("_setupReconnect :: set `reconnecting` to `true`"),this.reconnecting=!0),m("_setupReconnect :: setting reconnectTimer for %d ms",e.options.reconnectPeriod),e.reconnectTimer=setInterval((function(){m("reconnectTimer :: reconnect triggered!"),e._reconnect()}),e.options.reconnectPeriod)):m("_setupReconnect :: doing nothing...")},O.prototype._clearReconnect=function(){m("_clearReconnect : clearing reconnect timer"),this.reconnectTimer&&(clearInterval(this.reconnectTimer),this.reconnectTimer=null)},O.prototype._cleanUp=function(e,t){const n=arguments[2];if(t&&(m("_cleanUp :: done callback provided for on stream close"),this.stream.on("close",t)),m("_cleanUp :: forced? %s",e),e)0===this.options.reconnectPeriod&&this.options.clean&&k(this.outgoing),m("_cleanUp :: (%s) :: destroying stream",this.options.clientId),this.stream.destroy();else{const e=g({cmd:"disconnect"},n);m("_cleanUp :: (%s) :: call _sendPacket with disconnect packet",this.options.clientId),this._sendPacket(e,v.bind(null,this.stream.end.bind(this.stream)))}this.disconnecting||(m("_cleanUp :: client not disconnecting. Clearing and resetting reconnect."),this._clearReconnect(),this._setupReconnect()),null!==this.pingTimer&&(m("_cleanUp :: clearing pingTimer"),this.pingTimer.clear(),this.pingTimer=null),t&&!this.connected&&(m("_cleanUp :: (%s) :: removing stream `done` callback `close` listener",this.options.clientId),this.stream.removeListener("close",t),t())},O.prototype._sendPacket=function(e,t,n){m("_sendPacket :: (%s) ::  start",this.options.clientId),n=n||R,t=t||R;const r=T(this,e);if(r)t(r);else{if(!this.connected)return"auth"===e.cmd?(this._shiftPingInterval(),void I(this,e,t)):(m("_sendPacket :: client not connected. Storing packet offline."),void this._storePacket(e,t,n));switch(this._shiftPingInterval(),e.cmd){case"publish":break;case"pubrel":return void _(this,e,t,n);default:return void I(this,e,t)}switch(e.qos){case 2:case 1:_(this,e,t,n);break;default:I(this,e,t)}m("_sendPacket :: (%s) ::  end",this.options.clientId)}},O.prototype._storePacket=function(e,t,n){m("_storePacket :: packet: %o",e),m("_storePacket :: cb? %s",!!t),n=n||R;let r=e;if("publish"===r.cmd){r=f(e);const n=E(this,r);if(n)return t&&t(n)}0===(r.qos||0)&&this.queueQoSZero||"publish"!==r.cmd?this.queue.push({packet:r,cb:t}):r.qos>0?(t=this.outgoing[r.messageId]?this.outgoing[r.messageId].cb:null,this.outgoingStore.put(r,(function(e){if(e)return t&&t(e);n()}))):t&&t(new Error("No connection to broker"))},O.prototype._setupPingTimer=function(){m("_setupPingTimer :: keepalive %d (seconds)",this.options.keepalive);const e=this;!this.pingTimer&&this.options.keepalive&&(this.pingResp=!0,this.pingTimer=h((function(){e._checkPing()}),1e3*this.options.keepalive))},O.prototype._shiftPingInterval=function(){this.pingTimer&&this.options.keepalive&&this.options.reschedulePings&&this.pingTimer.reschedule(1e3*this.options.keepalive)},O.prototype._checkPing=function(){m("_checkPing :: checking ping..."),this.pingResp?(m("_checkPing :: ping response received. Clearing flag and sending `pingreq`"),this.pingResp=!1,this._sendPacket({cmd:"pingreq"})):(m("_checkPing :: calling _cleanUp with force true"),this._cleanUp(!0))},O.prototype._handlePingresp=function(){this.pingResp=!0},O.prototype._handleConnack=function(e){m("_handleConnack");const t=this.options,n=5===t.protocolVersion?e.reasonCode:e.returnCode;if(clearTimeout(this.connackTimer),delete this.topicAliasSend,e.properties){if(e.properties.topicAliasMaximum){if(e.properties.topicAliasMaximum>65535)return void this.emit("error",new Error("topicAliasMaximum from broker is out of range"));e.properties.topicAliasMaximum>0&&(this.topicAliasSend=new o(e.properties.topicAliasMaximum))}e.properties.serverKeepAlive&&t.keepalive&&(t.keepalive=e.properties.serverKeepAlive,this._shiftPingInterval()),e.properties.maximumPacketSize&&(t.properties||(t.properties={}),t.properties.maximumPacketSize=e.properties.maximumPacketSize)}if(0===n)this.reconnecting=!1,this._onConnect(e);else if(n>0){const e=new Error("Connection refused: "+S[n]);e.code=n,this.emit("error",e)}},O.prototype._handleAuth=function(e){const t=this.options.protocolVersion,n=5===t?e.reasonCode:e.returnCode;if(5!==t){const e=new Error("Protocol error: Auth packets are only supported in MQTT 5. Your version:"+t);return e.code=n,void this.emit("error",e)}const r=this;this.handleAuth(e,(function(e,t){if(e)r.emit("error",e);else if(24===n)r.reconnecting=!1,r._sendPacket(t);else{const t=new Error("Connection refused: "+S[n]);e.code=n,r.emit("error",t)}}))},O.prototype.handleAuth=function(e,t){t()},O.prototype._handlePublish=function(e,t){m("_handlePublish: packet %o",e),t=void 0!==t?t:R;let n=e.topic.toString();const r=e.payload,s=e.qos,i=e.messageId,a=this,o=this.options,l=[0,16,128,131,135,144,145,151,153];if(5===this.options.protocolVersion){let t;if(e.properties&&(t=e.properties.topicAlias),void 0!==t)if(0===n.length){if(!(t>0&&t<=65535))return m("_handlePublish :: topic alias out of range. alias: %d",t),void this.emit("error",new Error("Received Topic Alias is out of range"));{const e=this.topicAliasRecv.getTopicByAlias(t);if(!e)return m("_handlePublish :: unregistered topic alias. alias: %d",t),void this.emit("error",new Error("Received unregistered Topic Alias"));n=e,m("_handlePublish :: topic complemented by alias. topic: %s - alias: %d",n,t)}}else{if(!this.topicAliasRecv.put(n,t))return m("_handlePublish :: topic alias out of range. alias: %d",t),void this.emit("error",new Error("Received Topic Alias is out of range"));m("_handlePublish :: registered topic: %s - alias: %d",n,t)}}switch(m("_handlePublish: qos %d",s),s){case 2:o.customHandleAcks(n,r,e,(function(n,r){return n instanceof Error||(r=n,n=null),n?a.emit("error",n):-1===l.indexOf(r)?a.emit("error",new Error("Wrong reason code for pubrec")):void(r?a._sendPacket({cmd:"pubrec",messageId:i,reasonCode:r},t):a.incomingStore.put(e,(function(){a._sendPacket({cmd:"pubrec",messageId:i},t)})))}));break;case 1:o.customHandleAcks(n,r,e,(function(s,o){return s instanceof Error||(o=s,s=null),s?a.emit("error",s):-1===l.indexOf(o)?a.emit("error",new Error("Wrong reason code for puback")):(o||a.emit("message",n,r,e),void a.handleMessage(e,(function(e){if(e)return t&&t(e);a._sendPacket({cmd:"puback",messageId:i,reasonCode:o},t)})))}));break;case 0:this.emit("message",n,r,e),this.handleMessage(e,t);break;default:m("_handlePublish: unknown QoS. Doing nothing.")}},O.prototype.handleMessage=function(e,t){t()},O.prototype._handleAck=function(e){const t=e.messageId,n=e.cmd;let r=null;const s=this.outgoing[t]?this.outgoing[t].cb:null,i=this;let a;if(s){switch(m("_handleAck :: packet type",n),n){case"pubcomp":case"puback":{const n=e.reasonCode;n&&n>0&&16!==n&&(a=new Error("Publish error: "+S[n]),a.code=n,s(a,e)),delete this.outgoing[t],this.outgoingStore.del(e,s),this.messageIdProvider.deallocate(t),this._invokeStoreProcessingQueue();break}case"pubrec":{r={cmd:"pubrel",qos:2,messageId:t};const n=e.reasonCode;n&&n>0&&16!==n?(a=new Error("Publish error: "+S[n]),a.code=n,s(a,e)):this._sendPacket(r);break}case"suback":delete this.outgoing[t],this.messageIdProvider.deallocate(t);for(let n=0;n<e.granted.length;n++)if(0!=(128&e.granted[n])){const e=this.messageIdToTopic[t];e&&e.forEach((function(e){delete i._resubscribeTopics[e]}))}this._invokeStoreProcessingQueue(),s(null,e);break;case"unsuback":delete this.outgoing[t],this.messageIdProvider.deallocate(t),this._invokeStoreProcessingQueue(),s(null);break;default:i.emit("error",new Error("unrecognized packet type"))}this.disconnecting&&0===Object.keys(this.outgoing).length&&this.emit("outgoingEmpty")}else m("_handleAck :: Server sent an ack in error. Ignoring.")},O.prototype._handlePubrel=function(e,t){m("handling pubrel packet"),t=void 0!==t?t:R;const n=e.messageId,r=this,s={cmd:"pubcomp",messageId:n};r.incomingStore.get(e,(function(e,n){e?r._sendPacket(s,t):(r.emit("message",n.topic,n.payload,n),r.handleMessage(n,(function(e){if(e)return t(e);r.incomingStore.del(n,R),r._sendPacket(s,t)})))}))},O.prototype._handleDisconnect=function(e){this.emit("disconnect",e)},O.prototype._nextId=function(){return this.messageIdProvider.allocate()},O.prototype.getLastMessageId=function(){return this.messageIdProvider.getLastAllocated()},O.prototype._resubscribe=function(){m("_resubscribe");const e=Object.keys(this._resubscribeTopics);if(!this._firstConnection&&(this.options.clean||5===this.options.protocolVersion&&!this.connackPacket.sessionPresent)&&e.length>0)if(this.options.resubscribe)if(5===this.options.protocolVersion){m("_resubscribe: protocolVersion 5");for(let t=0;t<e.length;t++){const n={};n[e[t]]=this._resubscribeTopics[e[t]],n.resubscribe=!0,this.subscribe(n,{properties:n[e[t]].properties})}}else this._resubscribeTopics.resubscribe=!0,this.subscribe(this._resubscribeTopics);else this._resubscribeTopics={};this._firstConnection=!1},O.prototype._onConnect=function(e){if(this.disconnected)return void this.emit("connect",e);const t=this;function n(){let r=t.outgoingStore.createStream();function s(){t._storeProcessing=!1,t._packetIdsDuringStoreProcessing={}}function i(){r.destroy(),r=null,t._flushStoreProcessingQueue(),s()}function a(){if(!r)return;t._storeProcessing=!0;const e=r.read(1);let n;e?t._packetIdsDuringStoreProcessing[e.messageId]?a():t.disconnecting||t.reconnectTimer?r.destroy&&r.destroy():(n=t.outgoing[e.messageId]?t.outgoing[e.messageId].cb:null,t.outgoing[e.messageId]={volatile:!1,cb:function(e,t){n&&n(e,t),a()}},t._packetIdsDuringStoreProcessing[e.messageId]=!0,t.messageIdProvider.register(e.messageId)?t._sendPacket(e):m("messageId: %d has already used.",e.messageId)):r.once("readable",a)}t.once("close",i),r.on("error",(function(e){s(),t._flushStoreProcessingQueue(),t.removeListener("close",i),t.emit("error",e)})),r.on("end",(function(){let r=!0;for(const e in t._packetIdsDuringStoreProcessing)if(!t._packetIdsDuringStoreProcessing[e]){r=!1;break}r?(s(),t.removeListener("close",i),t._invokeAllStoreProcessingQueue(),t.emit("connect",e)):n()})),a()}this.connackPacket=e,this.messageIdProvider.clear(),this._setupPingTimer(),this.connected=!0,n()},O.prototype._invokeStoreProcessingQueue=function(){if(this._storeProcessingQueue.length>0){const e=this._storeProcessingQueue[0];if(e&&e.invoke())return this._storeProcessingQueue.shift(),!0}return!1},O.prototype._invokeAllStoreProcessingQueue=function(){for(;this._invokeStoreProcessingQueue(););},O.prototype._flushStoreProcessingQueue=function(){for(const e of this._storeProcessingQueue)e.cbStorePut&&e.cbStorePut(new Error("Connection closed")),e.callback&&e.callback(new Error("Connection closed"));this._storeProcessingQueue.splice(0)},t.exports=O}).call(this)}).call(this,e("_process"),void 0!==pt?pt:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./default-message-id-provider":7,"./store":8,"./topic-alias-recv":9,"./topic-alias-send":10,"./validations":11,_process:50,debug:18,events:22,inherits:24,"mqtt-packet":40,"readable-stream":69,reinterval:70,"rfdc/default":71,xtend:81}],2:[function(e,t,n){const{Buffer:r}=e("buffer"),s=e("readable-stream").Transform,i=e("duplexify");let a,o,l,c=!1;function d(){const e=new s;return e._write=function(e,t,n){a.sendSocketMessage({data:e.buffer,success:function(){n()},fail:function(){n(new Error)}})},e._flush=function(e){a.closeSocket({success:function(){e()}})},e}function u(e){e.hostname||(e.hostname="localhost"),e.path||(e.path="/"),e.wsOptions||(e.wsOptions={})}function h(e,t){const n="alis"===e.protocol?"wss":"ws";let r=n+"://"+e.hostname+e.path;return e.port&&80!==e.port&&443!==e.port&&(r=n+"://"+e.hostname+":"+e.port+e.path),"function"==typeof e.transformWsUrl&&(r=e.transformWsUrl(r,e,t)),r}function f(){c||(c=!0,a.onSocketOpen((function(){l.setReadable(o),l.setWritable(o),l.emit("connect")})),a.onSocketMessage((function(e){if("string"==typeof e.data){const t=r.from(e.data,"base64");o.push(t)}else{const t=new FileReader;t.addEventListener("load",(function(){let e=t.result;e=e instanceof ArrayBuffer?r.from(e):r.from(e,"utf8"),o.push(e)})),t.readAsArrayBuffer(e.data)}})),a.onSocketClose((function(){l.end(),l.destroy()})),a.onSocketError((function(e){l.destroy(e)})))}function p(e,t){if(t.hostname=t.hostname||t.host,!t.hostname)throw new Error("Could not determine host. Specify host manually.");const n="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt";u(t);const r=h(t,e);return a=t.my,a.connectSocket({url:r,protocols:n}),o=d(),l=i.obj(),f(),l}t.exports=p},{buffer:17,duplexify:20,"readable-stream":69}],3:[function(e,t,n){const r=e("net"),s=e("debug")("mqttjs:tcp");function i(e,t){t.port=t.port||1883,t.hostname=t.hostname||t.host||"localhost";const n=t.port,i=t.hostname;return s("port %d and host %s",n,i),r.createConnection(n,i)}t.exports=i},{debug:18,net:16}],4:[function(e,t,n){const r=e("tls"),s=e("net"),i=e("debug")("mqttjs:tls");function a(e,t){t.port=t.port||8883,t.host=t.hostname||t.host||"localhost",0===s.isIP(t.host)&&(t.servername=t.host),t.rejectUnauthorized=!1!==t.rejectUnauthorized,delete t.path,i("port %d host %s rejectUnauthorized %b",t.port,t.host,t.rejectUnauthorized);const n=r.connect(t);function a(r){t.rejectUnauthorized&&e.emit("error",r),n.end()}return n.on("secureConnect",(function(){t.rejectUnauthorized&&!n.authorized?n.emit("error",new Error("TLS not authorized")):n.removeListener("error",a)})),n.on("error",a),n}t.exports=a},{debug:18,net:16,tls:16}],5:[function(e,t,n){(function(n){(function(){const{Buffer:r}=e("buffer"),s=e("ws"),i=e("debug")("mqttjs:ws"),a=e("duplexify"),o=e("readable-stream").Transform,l=["rejectUnauthorized","ca","cert","key","pfx","passphrase"],c=void 0!==n&&"browser"===n.title||"function"==typeof __webpack_require__;function d(e,t){let n=e.protocol+"://"+e.hostname+":"+e.port+e.path;return"function"==typeof e.transformWsUrl&&(n=e.transformWsUrl(n,e,t)),n}function u(e){const t=e;return e.hostname||(t.hostname="localhost"),e.port||("wss"===e.protocol?t.port=443:t.port=80),e.path||(t.path="/"),e.wsOptions||(t.wsOptions={}),c||"wss"!==e.protocol||l.forEach((function(n){Object.prototype.hasOwnProperty.call(e,n)&&!Object.prototype.hasOwnProperty.call(e.wsOptions,n)&&(t.wsOptions[n]=e[n])})),t}function h(e){const t=u(e);if(t.hostname||(t.hostname=t.host),!t.hostname){if("undefined"==typeof document)throw new Error("Could not determine host. Specify host manually.");const e=new URL(document.URL);t.hostname=e.hostname,t.port||(t.port=e.port)}return void 0===t.objectMode&&(t.objectMode=!(!0===t.binary||void 0===t.binary)),t}function f(e,t,n){i("createWebSocket"),i("protocol: "+n.protocolId+" "+n.protocolVersion);const r="MQIsdp"===n.protocolId&&3===n.protocolVersion?"mqttv3.1":"mqtt";return i("creating new Websocket for url: "+t+" and protocol: "+r),new s(t,[r],n.wsOptions)}function p(e,t){const n="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt",r=d(t,e),s=new WebSocket(r,[n]);return s.binaryType="arraybuffer",s}function g(e,t){i("streamBuilder");const n=u(t),r=d(n,e),a=f(e,r,n),o=s.createWebSocketStream(a,n.wsOptions);return o.url=r,a.on("close",(()=>{o.destroy()})),o}function m(e,t){let n;i("browserStreamBuilder");const s=h(t).browserBufferSize||524288,l=t.browserBufferTimeout||1e3,c=!t.objectMode,d=p(e,t),u=g(t,S,C);t.objectMode||(u._writev=w),u.on("close",(()=>{d.close()}));const f=void 0!==d.addEventListener;function g(e,t,n){const r=new o({objectModeMode:e.objectMode});return r._write=t,r._flush=n,r}function m(){n.setReadable(u),n.setWritable(u),n.emit("connect")}function y(){n.end(),n.destroy()}function v(e){n.destroy(e)}function b(e){let t=e.data;t=t instanceof ArrayBuffer?r.from(t):r.from(t,"utf8"),u.push(t)}function w(e,t){const n=new Array(e.length);for(let t=0;t<e.length;t++)"string"==typeof e[t].chunk?n[t]=r.from(e[t],"utf8"):n[t]=e[t].chunk;this._write(r.concat(n),"binary",t)}function S(e,t,n){d.bufferedAmount>s&&setTimeout(S,l,e,t,n),c&&"string"==typeof e&&(e=r.from(e,"utf8"));try{d.send(e)}catch(e){return n(e)}n()}function C(e){d.close(),e()}return d.readyState===d.OPEN?n=u:(n=n=a(void 0,void 0,t),t.objectMode||(n._writev=w),f?d.addEventListener("open",m):d.onopen=m),n.socket=d,f?(d.addEventListener("close",y),d.addEventListener("error",v),d.addEventListener("message",b)):(d.onclose=y,d.onerror=v,d.onmessage=b),n}t.exports=c?m:g}).call(this)}).call(this,e("_process"))},{_process:50,buffer:17,debug:18,duplexify:20,"readable-stream":69,ws:80}],6:[function(e,t,n){const{Buffer:r}=e("buffer"),s=e("readable-stream").Transform,i=e("duplexify");let a,o,l;function c(){const e=new s;return e._write=function(e,t,n){a.send({data:e.buffer,success:function(){n()},fail:function(e){n(new Error(e))}})},e._flush=function(e){a.close({success:function(){e()}})},e}function d(e){e.hostname||(e.hostname="localhost"),e.path||(e.path="/"),e.wsOptions||(e.wsOptions={})}function u(e,t){const n="wxs"===e.protocol?"wss":"ws";let r=n+"://"+e.hostname+e.path;return e.port&&80!==e.port&&443!==e.port&&(r=n+"://"+e.hostname+":"+e.port+e.path),"function"==typeof e.transformWsUrl&&(r=e.transformWsUrl(r,e,t)),r}function h(){a.onOpen((function(){l.setReadable(o),l.setWritable(o),l.emit("connect")})),a.onMessage((function(e){let t=e.data;t=t instanceof ArrayBuffer?r.from(t):r.from(t,"utf8"),o.push(t)})),a.onClose((function(){l.end(),l.destroy()})),a.onError((function(e){l.destroy(new Error(e.errMsg))}))}function f(e,t){if(t.hostname=t.hostname||t.host,!t.hostname)throw new Error("Could not determine host. Specify host manually.");const n="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt";d(t);const r=u(t,e);a=wx.connectSocket({url:r,protocols:[n]}),o=c(),l=i.obj(),l._destroy=function(e,t){a.close({success:function(){t&&t(e)}})};const s=l.destroy;return l.destroy=function(){l.destroy=s;const e=this;setTimeout((function(){a.close({fail:function(){e._destroy(new Error)}})}),0)}.bind(l),h(),l}t.exports=f},{buffer:17,duplexify:20,"readable-stream":69}],7:[function(e,t,n){function r(){if(!(this instanceof r))return new r;this.nextId=Math.max(1,Math.floor(65535*Math.random()))}r.prototype.allocate=function(){const e=this.nextId++;return 65536===this.nextId&&(this.nextId=1),e},r.prototype.getLastAllocated=function(){return 1===this.nextId?65535:this.nextId-1},r.prototype.register=function(e){return!0},r.prototype.deallocate=function(e){},r.prototype.clear=function(){},t.exports=r},{}],8:[function(e,t,n){const r=e("xtend"),s=e("readable-stream").Readable,i={objectMode:!0},a={clean:!0};function o(e){if(!(this instanceof o))return new o(e);this.options=e||{},this.options=r(a,e),this._inflights=new Map}o.prototype.put=function(e,t){return this._inflights.set(e.messageId,e),t&&t(),this},o.prototype.createStream=function(){const e=new s(i),t=[];let n=!1,r=0;return this._inflights.forEach((function(e,n){t.push(e)})),e._read=function(){!n&&r<t.length?this.push(t[r++]):this.push(null)},e.destroy=function(){if(n)return;const e=this;n=!0,setTimeout((function(){e.emit("close")}),0)},e},o.prototype.del=function(e,t){return(e=this._inflights.get(e.messageId))?(this._inflights.delete(e.messageId),t(null,e)):t&&t(new Error("missing packet")),this},o.prototype.get=function(e,t){return(e=this._inflights.get(e.messageId))?t(null,e):t&&t(new Error("missing packet")),this},o.prototype.close=function(e){this.options.clean&&(this._inflights=null),e&&e()},t.exports=o},{"readable-stream":69,xtend:81}],9:[function(e,t,n){function r(e){if(!(this instanceof r))return new r(e);this.aliasToTopic={},this.max=e}r.prototype.put=function(e,t){return!(0===t||t>this.max||(this.aliasToTopic[t]=e,this.length=Object.keys(this.aliasToTopic).length,0))},r.prototype.getTopicByAlias=function(e){return this.aliasToTopic[e]},r.prototype.clear=function(){this.aliasToTopic={}},t.exports=r},{}],10:[function(e,t,n){const r=e("lru-cache"),s=e("number-allocator").NumberAllocator;function i(e){if(!(this instanceof i))return new i(e);e>0&&(this.aliasToTopic=new r({max:e}),this.topicToAlias={},this.numberAllocator=new s(1,e),this.max=e,this.length=0)}i.prototype.put=function(e,t){if(0===t||t>this.max)return!1;const n=this.aliasToTopic.get(t);return n&&delete this.topicToAlias[n],this.aliasToTopic.set(t,e),this.topicToAlias[e]=t,this.numberAllocator.use(t),this.length=this.aliasToTopic.length,!0},i.prototype.getTopicByAlias=function(e){return this.aliasToTopic.get(e)},i.prototype.getAliasByTopic=function(e){const t=this.topicToAlias[e];return void 0!==t&&this.aliasToTopic.get(t),t},i.prototype.clear=function(){this.aliasToTopic.reset(),this.topicToAlias={},this.numberAllocator.clear(),this.length=0},i.prototype.getLruAlias=function(){const e=this.numberAllocator.firstVacant();return e||this.aliasToTopic.keys()[this.aliasToTopic.length-1]},t.exports=i},{"lru-cache":37,"number-allocator":46}],11:[function(e,t,n){function r(e){const t=e.split("/");for(let e=0;e<t.length;e++)if("+"!==t[e]){if("#"===t[e])return e===t.length-1;if(-1!==t[e].indexOf("+")||-1!==t[e].indexOf("#"))return!1}return!0}function s(e){if(0===e.length)return"empty_topic_list";for(let t=0;t<e.length;t++)if(!r(e[t]))return e[t];return null}t.exports={validateTopics:s}},{}],12:[function(e,t,n){(function(n){(function(){const r=e("../client"),s=e("../store"),i=e("url"),a=e("xtend"),o=e("debug")("mqttjs"),l={};function c(e){let t;e.auth&&(t=e.auth.match(/^(.+):(.+)$/),t?(e.username=t[1],e.password=t[2]):e.username=e.auth)}function d(e,t){if(o("connecting to an MQTT broker..."),"object"!=typeof e||t||(t=e,e=null),t=t||{},e){const n=i.parse(e,!0);if(null!=n.port&&(n.port=Number(n.port)),null===(t=a(n,t)).protocol)throw new Error("Missing protocol");t.protocol=t.protocol.replace(/:$/,"")}if(c(t),t.query&&"string"==typeof t.query.clientId&&(t.clientId=t.query.clientId),t.cert&&t.key){if(!t.protocol)throw new Error("Missing secure protocol key");if(-1===["mqtts","wss","wxs","alis"].indexOf(t.protocol))switch(t.protocol){case"mqtt":t.protocol="mqtts";break;case"ws":t.protocol="wss";break;case"wx":t.protocol="wxs";break;case"ali":t.protocol="alis";break;default:throw new Error('Unknown protocol for secure connection: "'+t.protocol+'"!')}}if(!l[t.protocol]){const e=-1!==["mqtts","wss"].indexOf(t.protocol);t.protocol=["mqtt","mqtts","ws","wss","wx","wxs","ali","alis"].filter((function(t,n){return(!e||n%2!=0)&&"function"==typeof l[t]}))[0]}if(!1===t.clean&&!t.clientId)throw new Error("Missing clientId for unclean clients");function n(e){return t.servers&&(e._reconnectCount&&e._reconnectCount!==t.servers.length||(e._reconnectCount=0),t.host=t.servers[e._reconnectCount].host,t.port=t.servers[e._reconnectCount].port,t.protocol=t.servers[e._reconnectCount].protocol?t.servers[e._reconnectCount].protocol:t.defaultProtocol,t.hostname=t.host,e._reconnectCount++),o("calling streambuilder for",t.protocol),l[t.protocol](e,t)}t.protocol&&(t.defaultProtocol=t.protocol);const s=new r(n,t);return s.on("error",(function(){})),s}void 0!==n&&"browser"!==n.title||"function"!=typeof __webpack_require__?(l.mqtt=e("./tcp"),l.tcp=e("./tcp"),l.ssl=e("./tls"),l.tls=e("./tls"),l.mqtts=e("./tls")):(l.wx=e("./wx"),l.wxs=e("./wx"),l.ali=e("./ali"),l.alis=e("./ali")),l.ws=e("./ws"),l.wss=e("./ws"),t.exports=d,t.exports.connect=d,t.exports.MqttClient=r,t.exports.Store=s}).call(this)}).call(this,e("_process"))},{"../client":1,"../store":8,"./ali":2,"./tcp":3,"./tls":4,"./ws":5,"./wx":6,_process:50,debug:18,url:76,xtend:81}],13:[function(e,t,n){n.byteLength=d,n.toByteArray=h,n.fromByteArray=g;for(var r=[],s=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,l=a.length;o<l;++o)r[o]=a[o],s[a.charCodeAt(o)]=o;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function d(e){var t=c(e),n=t[0],r=t[1];return 3*(n+r)/4-r}function u(e,t,n){return 3*(t+n)/4-n}function h(e){var t,n,r=c(e),a=r[0],o=r[1],l=new i(u(e,a,o)),d=0,h=o>0?a-4:a;for(n=0;n<h;n+=4)t=s[e.charCodeAt(n)]<<18|s[e.charCodeAt(n+1)]<<12|s[e.charCodeAt(n+2)]<<6|s[e.charCodeAt(n+3)],l[d++]=t>>16&255,l[d++]=t>>8&255,l[d++]=255&t;return 2===o&&(t=s[e.charCodeAt(n)]<<2|s[e.charCodeAt(n+1)]>>4,l[d++]=255&t),1===o&&(t=s[e.charCodeAt(n)]<<10|s[e.charCodeAt(n+1)]<<4|s[e.charCodeAt(n+2)]>>2,l[d++]=t>>8&255,l[d++]=255&t),l}function f(e){return r[e>>18&63]+r[e>>12&63]+r[e>>6&63]+r[63&e]}function p(e,t,n){for(var r,s=[],i=t;i<n;i+=3)r=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]),s.push(f(r));return s.join("")}function g(e){for(var t,n=e.length,s=n%3,i=[],a=16383,o=0,l=n-s;o<l;o+=a)i.push(p(e,o,o+a>l?l:o+a));return 1===s?(t=e[n-1],i.push(r[t>>2]+r[t<<4&63]+"==")):2===s&&(t=(e[n-2]<<8)+e[n-1],i.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"=")),i.join("")}s["-".charCodeAt(0)]=62,s["_".charCodeAt(0)]=63},{}],14:[function(e,t,n){const{Buffer:r}=e("buffer"),s=Symbol.for("BufferList");function i(e){if(!(this instanceof i))return new i(e);i._init.call(this,e)}i._init=function(e){Object.defineProperty(this,s,{value:!0}),this._bufs=[],this.length=0,e&&this.append(e)},i.prototype._new=function(e){return new i(e)},i.prototype._offset=function(e){if(0===e)return[0,0];let t=0;for(let n=0;n<this._bufs.length;n++){const r=t+this._bufs[n].length;if(e<r||n===this._bufs.length-1)return[n,e-t];t=r}},i.prototype._reverseOffset=function(e){const t=e[0];let n=e[1];for(let e=0;e<t;e++)n+=this._bufs[e].length;return n},i.prototype.get=function(e){if(e>this.length||e<0)return;const t=this._offset(e);return this._bufs[t[0]][t[1]]},i.prototype.slice=function(e,t){return"number"==typeof e&&e<0&&(e+=this.length),"number"==typeof t&&t<0&&(t+=this.length),this.copy(null,0,e,t)},i.prototype.copy=function(e,t,n,s){if(("number"!=typeof n||n<0)&&(n=0),("number"!=typeof s||s>this.length)&&(s=this.length),n>=this.length)return e||r.alloc(0);if(s<=0)return e||r.alloc(0);const i=!!e,a=this._offset(n),o=s-n;let l=o,c=i&&t||0,d=a[1];if(0===n&&s===this.length){if(!i)return 1===this._bufs.length?this._bufs[0]:r.concat(this._bufs,this.length);for(let t=0;t<this._bufs.length;t++)this._bufs[t].copy(e,c),c+=this._bufs[t].length;return e}if(l<=this._bufs[a[0]].length-d)return i?this._bufs[a[0]].copy(e,t,d,d+l):this._bufs[a[0]].slice(d,d+l);i||(e=r.allocUnsafe(o));for(let t=a[0];t<this._bufs.length;t++){const n=this._bufs[t].length-d;if(!(l>n)){this._bufs[t].copy(e,c,d,d+l),c+=n;break}this._bufs[t].copy(e,c,d),c+=n,l-=n,d&&(d=0)}return e.length>c?e.slice(0,c):e},i.prototype.shallowSlice=function(e,t){if(e=e||0,t="number"!=typeof t?this.length:t,e<0&&(e+=this.length),t<0&&(t+=this.length),e===t)return this._new();const n=this._offset(e),r=this._offset(t),s=this._bufs.slice(n[0],r[0]+1);return 0===r[1]?s.pop():s[s.length-1]=s[s.length-1].slice(0,r[1]),0!==n[1]&&(s[0]=s[0].slice(n[1])),this._new(s)},i.prototype.toString=function(e,t,n){return this.slice(t,n).toString(e)},i.prototype.consume=function(e){if(e=Math.trunc(e),Number.isNaN(e)||e<=0)return this;for(;this._bufs.length;){if(!(e>=this._bufs[0].length)){this._bufs[0]=this._bufs[0].slice(e),this.length-=e;break}e-=this._bufs[0].length,this.length-=this._bufs[0].length,this._bufs.shift()}return this},i.prototype.duplicate=function(){const e=this._new();for(let t=0;t<this._bufs.length;t++)e.append(this._bufs[t]);return e},i.prototype.append=function(e){if(null==e)return this;if(e.buffer)this._appendBuffer(r.from(e.buffer,e.byteOffset,e.byteLength));else if(Array.isArray(e))for(let t=0;t<e.length;t++)this.append(e[t]);else if(this._isBufferList(e))for(let t=0;t<e._bufs.length;t++)this.append(e._bufs[t]);else"number"==typeof e&&(e=e.toString()),this._appendBuffer(r.from(e));return this},i.prototype._appendBuffer=function(e){this._bufs.push(e),this.length+=e.length},i.prototype.indexOf=function(e,t,n){if(void 0===n&&"string"==typeof t&&(n=t,t=void 0),"function"==typeof e||Array.isArray(e))throw new TypeError('The "value" argument must be one of type string, Buffer, BufferList, or Uint8Array.');if("number"==typeof e?e=r.from([e]):"string"==typeof e?e=r.from(e,n):this._isBufferList(e)?e=e.slice():Array.isArray(e.buffer)?e=r.from(e.buffer,e.byteOffset,e.byteLength):r.isBuffer(e)||(e=r.from(e)),t=Number(t||0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),0===e.length)return t>this.length?this.length:t;const s=this._offset(t);let i=s[0],a=s[1];for(;i<this._bufs.length;i++){const t=this._bufs[i];for(;a<t.length;)if(t.length-a>=e.length){const n=t.indexOf(e,a);if(-1!==n)return this._reverseOffset([i,n]);a=t.length-e.length+1}else{const t=this._reverseOffset([i,a]);if(this._match(t,e))return t;a++}a=0}return-1},i.prototype._match=function(e,t){if(this.length-e<t.length)return!1;for(let n=0;n<t.length;n++)if(this.get(e+n)!==t[n])return!1;return!0},function(){const e={readDoubleBE:8,readDoubleLE:8,readFloatBE:4,readFloatLE:4,readInt32BE:4,readInt32LE:4,readUInt32BE:4,readUInt32LE:4,readInt16BE:2,readInt16LE:2,readUInt16BE:2,readUInt16LE:2,readInt8:1,readUInt8:1,readIntBE:null,readIntLE:null,readUIntBE:null,readUIntLE:null};for(const t in e)!function(t){null===e[t]?i.prototype[t]=function(e,n){return this.slice(e,e+n)[t](0,n)}:i.prototype[t]=function(n=0){return this.slice(n,n+e[t])[t](0)}}(t)}(),i.prototype._isBufferList=function(e){return e instanceof i||i.isBufferList(e)},i.isBufferList=function(e){return null!=e&&e[s]},t.exports=i},{buffer:17}],15:[function(e,t,n){const r=e("readable-stream").Duplex,s=e("inherits"),i=e("./BufferList");function a(e){if(!(this instanceof a))return new a(e);if("function"==typeof e){this._callback=e;const t=function(e){this._callback&&(this._callback(e),this._callback=null)}.bind(this);this.on("pipe",(function(e){e.on("error",t)})),this.on("unpipe",(function(e){e.removeListener("error",t)})),e=null}i._init.call(this,e),r.call(this)}s(a,r),Object.assign(a.prototype,i.prototype),a.prototype._new=function(e){return new a(e)},a.prototype._write=function(e,t,n){this._appendBuffer(e),"function"==typeof n&&n()},a.prototype._read=function(e){if(!this.length)return this.push(null);e=Math.min(e,this.length),this.push(this.slice(0,e)),this.consume(e)},a.prototype.end=function(e){r.prototype.end.call(this,e),this._callback&&(this._callback(null,this.slice()),this._callback=null)},a.prototype._destroy=function(e,t){this._bufs.length=0,this.length=0,t(e)},a.prototype._isBufferList=function(e){return e instanceof a||e instanceof i||a.isBufferList(e)},a.isBufferList=i.isBufferList,t.exports=a,t.exports.BufferListStream=a,t.exports.BufferList=i},{"./BufferList":14,inherits:24,"readable-stream":69}],16:[function(e,t,n){},{}],17:[function(e,t,n){(function(t){(function(){var t=e("base64-js"),r=e("ieee754");n.Buffer=o,n.SlowBuffer=y,n.INSPECT_MAX_BYTES=50;var s=2147483647;function i(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()}catch(e){return!1}}function a(e){if(e>s)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=o.prototype,t}function o(e,t,n){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return u(e)}return l(e,t,n)}function l(e,t,n){if("string"==typeof e)return h(e,t);if(ArrayBuffer.isView(e))return f(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(Q(e,ArrayBuffer)||e&&Q(e.buffer,ArrayBuffer))return p(e,t,n);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return o.from(r,t,n);var s=g(e);if(s)return s;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return o.from(e[Symbol.toPrimitive]("string"),t,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function c(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function d(e,t,n){return c(e),e<=0?a(e):void 0!==t?"string"==typeof n?a(e).fill(t,n):a(e).fill(t):a(e)}function u(e){return c(e),a(e<0?0:0|m(e))}function h(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!o.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var n=0|v(e,t),r=a(n),s=r.write(e,t);return s!==n&&(r=r.slice(0,s)),r}function f(e){for(var t=e.length<0?0:0|m(e.length),n=a(t),r=0;r<t;r+=1)n[r]=255&e[r];return n}function p(e,t,n){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(n||0))throw new RangeError('"length" is outside of buffer bounds');var r;return(r=void 0===t&&void 0===n?new Uint8Array(e):void 0===n?new Uint8Array(e,t):new Uint8Array(e,t,n)).__proto__=o.prototype,r}function g(e){if(o.isBuffer(e)){var t=0|m(e.length),n=a(t);return 0===n.length||e.copy(n,0,0,t),n}return void 0!==e.length?"number"!=typeof e.length||X(e.length)?a(0):f(e):"Buffer"===e.type&&Array.isArray(e.data)?f(e.data):void 0}function m(e){if(e>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return 0|e}function y(e){return+e!=e&&(e=0),o.alloc(+e)}function v(e,t){if(o.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||Q(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var n=e.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===n)return 0;for(var s=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return H(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return W(e).length;default:if(s)return r?-1:H(e).length;t=(""+t).toLowerCase(),s=!0}}function b(e,t,n){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return M(this,t,n);case"utf8":case"utf-8":return O(this,t,n);case"ascii":return x(this,t,n);case"latin1":case"binary":return P(this,t,n);case"base64":return R(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return F(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function w(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function S(e,t,n,r,s){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),X(n=+n)&&(n=s?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(s)return-1;n=e.length-1}else if(n<0){if(!s)return-1;n=0}if("string"==typeof t&&(t=o.from(t,r)),o.isBuffer(t))return 0===t.length?-1:C(e,t,n,r,s);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):C(e,[t],n,r,s);throw new TypeError("val must be string, number or Buffer")}function C(e,t,n,r,s){var i,a=1,o=e.length,l=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;a=2,o/=2,l/=2,n/=2}function c(e,t){return 1===a?e[t]:e.readUInt16BE(t*a)}if(s){var d=-1;for(i=n;i<o;i++)if(c(e,i)===c(t,-1===d?0:i-d)){if(-1===d&&(d=i),i-d+1===l)return d*a}else-1!==d&&(i-=i-d),d=-1}else for(n+l>o&&(n=o-l),i=n;i>=0;i--){for(var u=!0,h=0;h<l;h++)if(c(e,i+h)!==c(t,h)){u=!1;break}if(u)return i}return-1}function T(e,t,n,r){n=Number(n)||0;var s=e.length-n;r?(r=Number(r))>s&&(r=s):r=s;var i=t.length;r>i/2&&(r=i/2);for(var a=0;a<r;++a){var o=parseInt(t.substr(2*a,2),16);if(X(o))return a;e[n+a]=o}return a}function E(e,t,n,r){return Y(H(t,e.length-n),e,n,r)}function I(e,t,n,r){return Y(V(t),e,n,r)}function k(e,t,n,r){return I(e,t,n,r)}function A(e,t,n,r){return Y(W(t),e,n,r)}function _(e,t,n,r){return Y(z(t,e.length-n),e,n,r)}function R(e,n,r){return 0===n&&r===e.length?t.fromByteArray(e):t.fromByteArray(e.slice(n,r))}function O(e,t,n){n=Math.min(e.length,n);for(var r=[],s=t;s<n;){var i,a,o,l,c=e[s],d=null,u=c>239?4:c>223?3:c>191?2:1;if(s+u<=n)switch(u){case 1:c<128&&(d=c);break;case 2:128==(192&(i=e[s+1]))&&(l=(31&c)<<6|63&i)>127&&(d=l);break;case 3:i=e[s+1],a=e[s+2],128==(192&i)&&128==(192&a)&&(l=(15&c)<<12|(63&i)<<6|63&a)>2047&&(l<55296||l>57343)&&(d=l);break;case 4:i=e[s+1],a=e[s+2],o=e[s+3],128==(192&i)&&128==(192&a)&&128==(192&o)&&(l=(15&c)<<18|(63&i)<<12|(63&a)<<6|63&o)>65535&&l<1114112&&(d=l)}null===d?(d=65533,u=1):d>65535&&(d-=65536,r.push(d>>>10&1023|55296),d=56320|1023&d),r.push(d),s+=u}return D(r)}n.kMaxLength=s,o.TYPED_ARRAY_SUPPORT=i(),o.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(o.prototype,"parent",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.buffer}}),Object.defineProperty(o.prototype,"offset",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&o[Symbol.species]===o&&Object.defineProperty(o,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),o.poolSize=8192,o.from=function(e,t,n){return l(e,t,n)},o.prototype.__proto__=Uint8Array.prototype,o.__proto__=Uint8Array,o.alloc=function(e,t,n){return d(e,t,n)},o.allocUnsafe=function(e){return u(e)},o.allocUnsafeSlow=function(e){return u(e)},o.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==o.prototype},o.compare=function(e,t){if(Q(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),Q(t,Uint8Array)&&(t=o.from(t,t.offset,t.byteLength)),!o.isBuffer(e)||!o.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;for(var n=e.length,r=t.length,s=0,i=Math.min(n,r);s<i;++s)if(e[s]!==t[s]){n=e[s],r=t[s];break}return n<r?-1:r<n?1:0},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=o.allocUnsafe(t),s=0;for(n=0;n<e.length;++n){var i=e[n];if(Q(i,Uint8Array)&&(i=o.from(i)),!o.isBuffer(i))throw new TypeError('"list" argument must be an Array of Buffers');i.copy(r,s),s+=i.length}return r},o.byteLength=v,o.prototype._isBuffer=!0,o.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)w(this,t,t+1);return this},o.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)w(this,t,t+3),w(this,t+1,t+2);return this},o.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)w(this,t,t+7),w(this,t+1,t+6),w(this,t+2,t+5),w(this,t+3,t+4);return this},o.prototype.toString=function(){var e=this.length;return 0===e?"":0===arguments.length?O(this,0,e):b.apply(this,arguments)},o.prototype.toLocaleString=o.prototype.toString,o.prototype.equals=function(e){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===o.compare(this,e)},o.prototype.inspect=function(){var e="",t=n.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"},o.prototype.compare=function(e,t,n,r,s){if(Q(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),!o.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===s&&(s=this.length),t<0||n>e.length||r<0||s>this.length)throw new RangeError("out of range index");if(r>=s&&t>=n)return 0;if(r>=s)return-1;if(t>=n)return 1;if(this===e)return 0;for(var i=(s>>>=0)-(r>>>=0),a=(n>>>=0)-(t>>>=0),l=Math.min(i,a),c=this.slice(r,s),d=e.slice(t,n),u=0;u<l;++u)if(c[u]!==d[u]){i=c[u],a=d[u];break}return i<a?-1:a<i?1:0},o.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},o.prototype.indexOf=function(e,t,n){return S(this,e,t,n,!0)},o.prototype.lastIndexOf=function(e,t,n){return S(this,e,t,n,!1)},o.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(n)?(n>>>=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var s=this.length-t;if((void 0===n||n>s)&&(n=s),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var i=!1;;)switch(r){case"hex":return T(this,e,t,n);case"utf8":case"utf-8":return E(this,e,t,n);case"ascii":return I(this,e,t,n);case"latin1":case"binary":return k(this,e,t,n);case"base64":return A(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return _(this,e,t,n);default:if(i)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),i=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var L=4096;function D(e){var t=e.length;if(t<=L)return String.fromCharCode.apply(String,e);for(var n="",r=0;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=L));return n}function x(e,t,n){var r="";n=Math.min(e.length,n);for(var s=t;s<n;++s)r+=String.fromCharCode(127&e[s]);return r}function P(e,t,n){var r="";n=Math.min(e.length,n);for(var s=t;s<n;++s)r+=String.fromCharCode(e[s]);return r}function M(e,t,n){var r=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>r)&&(n=r);for(var s="",i=t;i<n;++i)s+=G(e[i]);return s}function F(e,t,n){for(var r=e.slice(t,n),s="",i=0;i<r.length;i+=2)s+=String.fromCharCode(r[i]+256*r[i+1]);return s}function U(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function N(e,t,n,r,s,i){if(!o.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<i)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function B(e,t,n,r,s,i){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function j(e,t,n,s,i){return t=+t,n>>>=0,i||B(e,t,n,4),r.write(e,t,n,s,23,4),n+4}function $(e,t,n,s,i){return t=+t,n>>>=0,i||B(e,t,n,8),r.write(e,t,n,s,52,8),n+8}o.prototype.slice=function(e,t){var n=this.length;(e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),t<e&&(t=e);var r=this.subarray(e,t);return r.__proto__=o.prototype,r},o.prototype.readUIntLE=function(e,t,n){e>>>=0,t>>>=0,n||U(e,t,this.length);for(var r=this[e],s=1,i=0;++i<t&&(s*=256);)r+=this[e+i]*s;return r},o.prototype.readUIntBE=function(e,t,n){e>>>=0,t>>>=0,n||U(e,t,this.length);for(var r=this[e+--t],s=1;t>0&&(s*=256);)r+=this[e+--t]*s;return r},o.prototype.readUInt8=function(e,t){return e>>>=0,t||U(e,1,this.length),this[e]},o.prototype.readUInt16LE=function(e,t){return e>>>=0,t||U(e,2,this.length),this[e]|this[e+1]<<8},o.prototype.readUInt16BE=function(e,t){return e>>>=0,t||U(e,2,this.length),this[e]<<8|this[e+1]},o.prototype.readUInt32LE=function(e,t){return e>>>=0,t||U(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},o.prototype.readUInt32BE=function(e,t){return e>>>=0,t||U(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},o.prototype.readIntLE=function(e,t,n){e>>>=0,t>>>=0,n||U(e,t,this.length);for(var r=this[e],s=1,i=0;++i<t&&(s*=256);)r+=this[e+i]*s;return r>=(s*=128)&&(r-=Math.pow(2,8*t)),r},o.prototype.readIntBE=function(e,t,n){e>>>=0,t>>>=0,n||U(e,t,this.length);for(var r=t,s=1,i=this[e+--r];r>0&&(s*=256);)i+=this[e+--r]*s;return i>=(s*=128)&&(i-=Math.pow(2,8*t)),i},o.prototype.readInt8=function(e,t){return e>>>=0,t||U(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},o.prototype.readInt16LE=function(e,t){e>>>=0,t||U(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},o.prototype.readInt16BE=function(e,t){e>>>=0,t||U(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},o.prototype.readInt32LE=function(e,t){return e>>>=0,t||U(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},o.prototype.readInt32BE=function(e,t){return e>>>=0,t||U(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},o.prototype.readFloatLE=function(e,t){return e>>>=0,t||U(e,4,this.length),r.read(this,e,!0,23,4)},o.prototype.readFloatBE=function(e,t){return e>>>=0,t||U(e,4,this.length),r.read(this,e,!1,23,4)},o.prototype.readDoubleLE=function(e,t){return e>>>=0,t||U(e,8,this.length),r.read(this,e,!0,52,8)},o.prototype.readDoubleBE=function(e,t){return e>>>=0,t||U(e,8,this.length),r.read(this,e,!1,52,8)},o.prototype.writeUIntLE=function(e,t,n,r){e=+e,t>>>=0,n>>>=0,r||N(this,e,t,n,Math.pow(2,8*n)-1,0);var s=1,i=0;for(this[t]=255&e;++i<n&&(s*=256);)this[t+i]=e/s&255;return t+n},o.prototype.writeUIntBE=function(e,t,n,r){e=+e,t>>>=0,n>>>=0,r||N(this,e,t,n,Math.pow(2,8*n)-1,0);var s=n-1,i=1;for(this[t+s]=255&e;--s>=0&&(i*=256);)this[t+s]=e/i&255;return t+n},o.prototype.writeUInt8=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,1,255,0),this[t]=255&e,t+1},o.prototype.writeUInt16LE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},o.prototype.writeUInt16BE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},o.prototype.writeUInt32LE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},o.prototype.writeUInt32BE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},o.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t>>>=0,!r){var s=Math.pow(2,8*n-1);N(this,e,t,n,s-1,-s)}var i=0,a=1,o=0;for(this[t]=255&e;++i<n&&(a*=256);)e<0&&0===o&&0!==this[t+i-1]&&(o=1),this[t+i]=(e/a>>0)-o&255;return t+n},o.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t>>>=0,!r){var s=Math.pow(2,8*n-1);N(this,e,t,n,s-1,-s)}var i=n-1,a=1,o=0;for(this[t+i]=255&e;--i>=0&&(a*=256);)e<0&&0===o&&0!==this[t+i+1]&&(o=1),this[t+i]=(e/a>>0)-o&255;return t+n},o.prototype.writeInt8=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},o.prototype.writeInt16LE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},o.prototype.writeInt16BE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},o.prototype.writeInt32LE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},o.prototype.writeInt32BE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},o.prototype.writeFloatLE=function(e,t,n){return j(this,e,t,!0,n)},o.prototype.writeFloatBE=function(e,t,n){return j(this,e,t,!1,n)},o.prototype.writeDoubleLE=function(e,t,n){return $(this,e,t,!0,n)},o.prototype.writeDoubleBE=function(e,t,n){return $(this,e,t,!1,n)},o.prototype.copy=function(e,t,n,r){if(!o.isBuffer(e))throw new TypeError("argument should be a Buffer");if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var s=r-n;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,n,r);else if(this===e&&n<t&&t<r)for(var i=s-1;i>=0;--i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,r),t);return s},o.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!o.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===e.length){var s=e.charCodeAt(0);("utf8"===r&&s<128||"latin1"===r)&&(e=s)}}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var i;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(i=t;i<n;++i)this[i]=e;else{var a=o.isBuffer(e)?e:o.from(e,r),l=a.length;if(0===l)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<n-t;++i)this[i+t]=a[i%l]}return this};var q=/[^+/0-9A-Za-z-_]/g;function K(e){if((e=(e=e.split("=")[0]).trim().replace(q,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}function G(e){return e<16?"0"+e.toString(16):e.toString(16)}function H(e,t){var n;t=t||1/0;for(var r=e.length,s=null,i=[],a=0;a<r;++a){if((n=e.charCodeAt(a))>55295&&n<57344){if(!s){if(n>56319){(t-=3)>-1&&i.push(239,191,189);continue}if(a+1===r){(t-=3)>-1&&i.push(239,191,189);continue}s=n;continue}if(n<56320){(t-=3)>-1&&i.push(239,191,189),s=n;continue}n=65536+(s-55296<<10|n-56320)}else s&&(t-=3)>-1&&i.push(239,191,189);if(s=null,n<128){if((t-=1)<0)break;i.push(n)}else if(n<2048){if((t-=2)<0)break;i.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;i.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;i.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return i}function V(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}function z(e,t){for(var n,r,s,i=[],a=0;a<e.length&&!((t-=2)<0);++a)r=(n=e.charCodeAt(a))>>8,s=n%256,i.push(s),i.push(r);return i}function W(e){return t.toByteArray(K(e))}function Y(e,t,n,r){for(var s=0;s<r&&!(s+n>=t.length||s>=e.length);++s)t[s+n]=e[s];return s}function Q(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function X(e){return e!=e}}).call(this)}).call(this,e("buffer").Buffer)},{"base64-js":13,buffer:17,ieee754:23}],18:[function(e,t,n){(function(r){(function(){function s(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))}function i(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;e.splice(1,0,n,"color: inherit");let r=0,s=0;e[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(r++,"%c"===e&&(s=r))})),e.splice(s,0,n)}function a(e){try{e?n.storage.setItem("debug",e):n.storage.removeItem("debug")}catch(e){}}function o(){let e;try{e=n.storage.getItem("debug")}catch(e){}return!e&&void 0!==r&&"env"in r&&(e=r.env.DEBUG),e}function l(){try{return localStorage}catch(e){}}n.formatArgs=i,n.save=a,n.load=o,n.useColors=s,n.storage=l(),n.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),n.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],n.log=console.debug||console.log||(()=>{}),t.exports=e("./common")(n);const{formatters:c}=t.exports;c.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this)}).call(this,e("_process"))},{"./common":19,_process:50}],19:[function(e,t,n){function r(t){function n(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return r.colors[Math.abs(t)%r.colors.length]}function r(e){let t,n,i,a=null;function o(...e){if(!o.enabled)return;const n=o,s=Number(new Date),i=s-(t||s);n.diff=i,n.prev=t,n.curr=s,t=s,e[0]=r.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((t,s)=>{if("%%"===t)return"%";a++;const i=r.formatters[s];if("function"==typeof i){const r=e[a];t=i.call(n,r),e.splice(a,1),a--}return t})),r.formatArgs.call(n,e),(n.log||r.log).apply(n,e)}return o.namespace=e,o.useColors=r.useColors(),o.color=r.selectColor(e),o.extend=s,o.destroy=r.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==a?a:(n!==r.namespaces&&(n=r.namespaces,i=r.enabled(e)),i),set:e=>{a=e}}),"function"==typeof r.init&&r.init(o),o}function s(e,t){const n=r(this.namespace+(void 0===t?":":t)+e);return n.log=this.log,n}function i(e){let t;r.save(e),r.namespaces=e,r.names=[],r.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),s=n.length;for(t=0;t<s;t++)n[t]&&("-"===(e=n[t].replace(/\*/g,".*?"))[0]?r.skips.push(new RegExp("^"+e.substr(1)+"$")):r.names.push(new RegExp("^"+e+"$")))}function a(){const e=[...r.names.map(l),...r.skips.map(l).map((e=>"-"+e))].join(",");return r.enable(""),e}function o(e){if("*"===e[e.length-1])return!0;let t,n;for(t=0,n=r.skips.length;t<n;t++)if(r.skips[t].test(e))return!1;for(t=0,n=r.names.length;t<n;t++)if(r.names[t].test(e))return!0;return!1}function l(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}function c(e){return e instanceof Error?e.stack||e.message:e}function d(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return r.debug=r,r.default=r,r.coerce=c,r.disable=a,r.enable=i,r.enabled=o,r.humanize=e("ms"),r.destroy=d,Object.keys(t).forEach((e=>{r[e]=t[e]})),r.names=[],r.skips=[],r.formatters={},r.selectColor=n,r.enable(r.load()),r}t.exports=r},{ms:45}],20:[function(e,t,n){(function(n,r){(function(){var s=e("readable-stream"),i=e("end-of-stream"),a=e("inherits"),o=e("stream-shift"),l=r.from&&r.from!==Uint8Array.from?r.from([0]):new r([0]),c=function(e,t){e._corked?e.once("uncork",t):t()},d=function(e,t){e._autoDestroy&&e.destroy(t)},u=function(e,t){return function(n){n?d(e,"premature close"===n.message?null:n):t&&!e._ended&&e.end()}},h=function(e,t){return e?e._writableState&&e._writableState.finished?t():e._writableState?e.end(t):(e.end(),void t()):t()},f=function(){},p=function(e){return new s.Readable({objectMode:!0,highWaterMark:16}).wrap(e)},g=function(e,t,n){if(!(this instanceof g))return new g(e,t,n);s.Duplex.call(this,n),this._writable=null,this._readable=null,this._readable2=null,this._autoDestroy=!n||!1!==n.autoDestroy,this._forwardDestroy=!n||!1!==n.destroy,this._forwardEnd=!n||!1!==n.end,this._corked=1,this._ondrain=null,this._drained=!1,this._forwarding=!1,this._unwrite=null,this._unread=null,this._ended=!1,this.destroyed=!1,e&&this.setWritable(e),t&&this.setReadable(t)};a(g,s.Duplex),g.obj=function(e,t,n){return n||(n={}),n.objectMode=!0,n.highWaterMark=16,new g(e,t,n)},g.prototype.cork=function(){1==++this._corked&&this.emit("cork")},g.prototype.uncork=function(){this._corked&&0==--this._corked&&this.emit("uncork")},g.prototype.setWritable=function(e){if(this._unwrite&&this._unwrite(),this.destroyed)e&&e.destroy&&e.destroy();else if(null!==e&&!1!==e){var t=this,r=i(e,{writable:!0,readable:!1},u(this,this._forwardEnd)),s=function(){var e=t._ondrain;t._ondrain=null,e&&e()},a=function(){t._writable.removeListener("drain",s),r()};this._unwrite&&n.nextTick(s),this._writable=e,this._writable.on("drain",s),this._unwrite=a,this.uncork()}else this.end()},g.prototype.setReadable=function(e){if(this._unread&&this._unread(),this.destroyed)e&&e.destroy&&e.destroy();else{if(null===e||!1===e)return this.push(null),void this.resume();var t=this,n=i(e,{writable:!1,readable:!0},u(this)),r=function(){t._forward()},s=function(){t.push(null)},a=function(){t._readable2.removeListener("readable",r),t._readable2.removeListener("end",s),n()};this._drained=!0,this._readable=e,this._readable2=e._readableState?e:p(e),this._readable2.on("readable",r),this._readable2.on("end",s),this._unread=a,this._forward()}},g.prototype._read=function(){this._drained=!0,this._forward()},g.prototype._forward=function(){if(!this._forwarding&&this._readable2&&this._drained){var e;for(this._forwarding=!0;this._drained&&null!==(e=o(this._readable2));)this.destroyed||(this._drained=this.push(e));this._forwarding=!1}},g.prototype.destroy=function(e,t){if(t||(t=f),this.destroyed)return t(null);this.destroyed=!0;var r=this;n.nextTick((function(){r._destroy(e),t(null)}))},g.prototype._destroy=function(e){if(e){var t=this._ondrain;this._ondrain=null,t?t(e):this.emit("error",e)}this._forwardDestroy&&(this._readable&&this._readable.destroy&&this._readable.destroy(),this._writable&&this._writable.destroy&&this._writable.destroy()),this.emit("close")},g.prototype._write=function(e,t,n){if(!this.destroyed)return this._corked?c(this,this._write.bind(this,e,t,n)):e===l?this._finish(n):this._writable?void(!1===this._writable.write(e)?this._ondrain=n:this.destroyed||n()):n()},g.prototype._finish=function(e){var t=this;this.emit("preend"),c(this,(function(){h(t._forwardEnd&&t._writable,(function(){!1===t._writableState.prefinished&&(t._writableState.prefinished=!0),t.emit("prefinish"),c(t,e)}))}))},g.prototype.end=function(e,t,n){return"function"==typeof e?this.end(null,null,e):"function"==typeof t?this.end(e,null,t):(this._ended=!0,e&&this.write(e),this._writableState.ending||this._writableState.destroyed||this.write(l),s.Writable.prototype.end.call(this,n))},t.exports=g}).call(this)}).call(this,e("_process"),e("buffer").Buffer)},{_process:50,buffer:17,"end-of-stream":21,inherits:24,"readable-stream":69,"stream-shift":74}],21:[function(e,t,n){(function(n){(function(){var r=e("once"),s=function(){},i=function(e){return e.setHeader&&"function"==typeof e.abort},a=function(e){return e.stdio&&Array.isArray(e.stdio)&&3===e.stdio.length},o=function(e,t,l){if("function"==typeof t)return o(e,null,t);t||(t={}),l=r(l||s);var c=e._writableState,d=e._readableState,u=t.readable||!1!==t.readable&&e.readable,h=t.writable||!1!==t.writable&&e.writable,f=!1,p=function(){e.writable||g()},g=function(){h=!1,u||l.call(e)},m=function(){u=!1,h||l.call(e)},y=function(t){l.call(e,t?new Error("exited with error code: "+t):null)},v=function(t){l.call(e,t)},b=function(){n.nextTick(w)},w=function(){if(!f)return(!u||d&&d.ended&&!d.destroyed)&&(!h||c&&c.ended&&!c.destroyed)?void 0:l.call(e,new Error("premature close"))},S=function(){e.req.on("finish",g)};return i(e)?(e.on("complete",g),e.on("abort",b),e.req?S():e.on("request",S)):h&&!c&&(e.on("end",p),e.on("close",p)),a(e)&&e.on("exit",y),e.on("end",m),e.on("finish",g),!1!==t.error&&e.on("error",v),e.on("close",b),function(){f=!0,e.removeListener("complete",g),e.removeListener("abort",b),e.removeListener("request",S),e.req&&e.req.removeListener("finish",g),e.removeListener("end",p),e.removeListener("close",p),e.removeListener("finish",g),e.removeListener("exit",y),e.removeListener("end",m),e.removeListener("error",v),e.removeListener("close",b)}};t.exports=o}).call(this)}).call(this,e("_process"))},{_process:50,once:48}],22:[function(e,t,n){var r=Object.create||E,s=Object.keys||I,i=Function.prototype.bind||k;function a(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=r(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}t.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._maxListeners=void 0;var o,l=10;try{var c={};Object.defineProperty&&Object.defineProperty(c,"x",{value:0}),o=0===c.x}catch(e){o=!1}function d(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function u(e,t,n){if(t)e.call(n);else for(var r=e.length,s=C(e,r),i=0;i<r;++i)s[i].call(n)}function h(e,t,n,r){if(t)e.call(n,r);else for(var s=e.length,i=C(e,s),a=0;a<s;++a)i[a].call(n,r)}function f(e,t,n,r,s){if(t)e.call(n,r,s);else for(var i=e.length,a=C(e,i),o=0;o<i;++o)a[o].call(n,r,s)}function p(e,t,n,r,s,i){if(t)e.call(n,r,s,i);else for(var a=e.length,o=C(e,a),l=0;l<a;++l)o[l].call(n,r,s,i)}function g(e,t,n,r){if(t)e.apply(n,r);else for(var s=e.length,i=C(e,s),a=0;a<s;++a)i[a].apply(n,r)}function m(e,t,n,s){var i,a,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),o=a[t]):(a=e._events=r(null),e._eventsCount=0),o){if("function"==typeof o?o=a[t]=s?[n,o]:[o,n]:s?o.unshift(n):o.push(n),!o.warned&&(i=d(e))&&i>0&&o.length>i){o.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+o.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=o.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",l.name,l.message)}}else o=a[t]=n,++e._eventsCount;return e}function y(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function v(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},s=i.call(y,r);return s.listener=n,r.wrapFn=s,s}function b(e,t,n){var r=e._events;if(!r)return[];var s=r[t];return s?"function"==typeof s?n?[s.listener||s]:[s]:n?T(s):C(s,s.length):[]}function w(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function S(e,t){for(var n=t,r=n+1,s=e.length;r<s;n+=1,r+=1)e[n]=e[r];e.pop()}function C(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function T(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function E(e){var t=function(){};return t.prototype=e,new t}function I(e){for(var t in e)Object.prototype.hasOwnProperty.call(e,t);return t}function k(e){var t=this;return function(){return t.apply(e,arguments)}}o?Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');l=e}}):a.defaultMaxListeners=l,a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return d(this)},a.prototype.emit=function(e){var t,n,r,s,i,a,o="error"===e;if(a=this._events)o=o&&null==a.error;else if(!o)return!1;if(o){if(arguments.length>1&&(t=arguments[1]),t instanceof Error)throw t;var l=new Error('Unhandled "error" event. ('+t+")");throw l.context=t,l}if(!(n=a[e]))return!1;var c="function"==typeof n;switch(r=arguments.length){case 1:u(n,c,this);break;case 2:h(n,c,this,arguments[1]);break;case 3:f(n,c,this,arguments[1],arguments[2]);break;case 4:p(n,c,this,arguments[1],arguments[2],arguments[3]);break;default:for(s=new Array(r-1),i=1;i<r;i++)s[i-1]=arguments[i];g(n,c,this,s)}return!0},a.prototype.addListener=function(e,t){return m(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return m(this,e,t,!0)},a.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,v(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,v(this,e,t)),this},a.prototype.removeListener=function(e,t){var n,s,i,a,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(s=this._events))return this;if(!(n=s[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=r(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length-1;a>=0;a--)if(n[a]===t||n[a].listener===t){o=n[a].listener,i=a;break}if(i<0)return this;0===i?n.shift():S(n,i),1===n.length&&(s[e]=n[0]),s.removeListener&&this.emit("removeListener",e,o||t)}return this},a.prototype.removeAllListeners=function(e){var t,n,i;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=r(null),this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=r(null):delete n[e]),this;if(0===arguments.length){var a,o=s(n);for(i=0;i<o.length;++i)"removeListener"!==(a=o[i])&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=r(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},a.prototype.listeners=function(e){return b(this,e,!0)},a.prototype.rawListeners=function(e){return b(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):w.call(e,t)},a.prototype.listenerCount=w,a.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],23:[function(e,t,n){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
n.read=function(e,t,n,r,s){var i,a,o=8*s-r-1,l=(1<<o)-1,c=l>>1,d=-7,u=n?s-1:0,h=n?-1:1,f=e[t+u];for(u+=h,i=f&(1<<-d)-1,f>>=-d,d+=o;d>0;i=256*i+e[t+u],u+=h,d-=8);for(a=i&(1<<-d)-1,i>>=-d,d+=r;d>0;a=256*a+e[t+u],u+=h,d-=8);if(0===i)i=1-c;else{if(i===l)return a?NaN:1/0*(f?-1:1);a+=Math.pow(2,r),i-=c}return(f?-1:1)*a*Math.pow(2,i-r)},n.write=function(e,t,n,r,s,i){var a,o,l,c=8*i-s-1,d=(1<<c)-1,u=d>>1,h=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:i-1,p=r?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,a=d):(a=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-a))<1&&(a--,l*=2),(t+=a+u>=1?h/l:h*Math.pow(2,1-u))*l>=2&&(a++,l/=2),a+u>=d?(o=0,a=d):a+u>=1?(o=(t*l-1)*Math.pow(2,s),a+=u):(o=t*Math.pow(2,u-1)*Math.pow(2,s),a=0));s>=8;e[n+f]=255&o,f+=p,o/=256,s-=8);for(a=a<<s|o,c+=s;c>0;e[n+f]=255&a,f+=p,a/=256,c-=8);e[n+f-p]|=128*g}},{}],24:[function(e,t,n){"function"==typeof Object.create?t.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}}},{}],25:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,t){this.color=!0,this.key=void 0,this.value=void 0,this.parent=void 0,this.brother=void 0,this.leftChild=void 0,this.rightChild=void 0,this.key=e,this.value=t}return e.prototype.rotateLeft=function(){var e=this.parent,t=this.brother,n=this.leftChild,r=this.rightChild;if(!r)throw new Error("unknown error");var s=r.leftChild,i=r.rightChild;return e&&(e.leftChild===this?e.leftChild=r:e.rightChild===this&&(e.rightChild=r)),r.parent=e,r.brother=t,r.leftChild=this,r.rightChild=i,t&&(t.brother=r),this.parent=r,this.brother=i,this.leftChild=n,this.rightChild=s,i&&(i.parent=r,i.brother=this),n&&(n.parent=this,n.brother=s),s&&(s.parent=this,s.brother=n),r},e.prototype.rotateRight=function(){var e=this.parent,t=this.brother,n=this.leftChild;if(!n)throw new Error("unknown error");var r=this.rightChild,s=n.leftChild,i=n.rightChild;return e&&(e.leftChild===this?e.leftChild=n:e.rightChild===this&&(e.rightChild=n)),n.parent=e,n.brother=t,n.leftChild=s,n.rightChild=this,t&&(t.brother=n),s&&(s.parent=n,s.brother=this),this.parent=n,this.brother=s,this.leftChild=i,this.rightChild=r,i&&(i.parent=this,i.brother=r),r&&(r.parent=this,r.brother=i),n},e.prototype.remove=function(){if(this.leftChild||this.rightChild)throw new Error("can only remove leaf node");this.parent&&(this===this.parent.leftChild?this.parent.leftChild=void 0:this===this.parent.rightChild&&(this.parent.rightChild=void 0)),this.brother&&(this.brother.brother=void 0),this.key=void 0,this.value=void 0,this.parent=void 0,this.brother=void 0},e.TreeNodeColorType={red:!0,black:!1},e}();Object.freeze(r),n.default=r},{}],26:[function(e,t,n){var r=this&&this.__generator||function(e,t){var n,r,s,i,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(e){return function(t){return l([e,t])}}function l(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((s=(s=a.trys).length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){a.label=i[1];break}if(6===i[0]&&a.label<s[1]){a.label=s[1],s=i;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(i);break}s[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}};function s(e){var t=this;void 0===e&&(e=[]);var n=[],i=0,a=0,o=0,l=0,c=0,d=0;this.size=function(){return d},this.empty=function(){return 0===d},this.clear=function(){i=o=a=l=c=d=0,h.call(this,s.bucketSize),d=0},this.front=function(){return n[i][a]},this.back=function(){return n[o][l]},this.forEach=function(e){if(!this.empty()){var t=0;if(i!==o){for(c=a;c<s.bucketSize;++c)e(n[i][c],t++);for(c=i+1;c<o;++c)for(var r=0;r<s.bucketSize;++r)e(n[c][r],t++);for(c=0;c<=l;++c)e(n[o][c],t++)}else for(var c=a;c<=l;++c)e(n[i][c],t++)}};var u=function(e){var t=i*s.bucketSize+a,n=t+e,r=o*s.bucketSize+l;if(n<t||n>r)throw new Error("pos should more than 0 and less than queue's size");return{curNodeBucketIndex:Math.floor(n/s.bucketSize),curNodePointerIndex:n%s.bucketSize}};this.getElementByPos=function(e){var t=u(e),r=t.curNodeBucketIndex,s=t.curNodePointerIndex;return n[r][s]},this.eraseElementByPos=function(e){var t=this;if(e<0||e>d)throw new Error("pos should more than 0 and less than queue's size");if(0===e)this.popFront();else if(e===this.size())this.popBack();else{for(var n=[],r=e+1;r<d;++r)n.push(this.getElementByPos(r));this.cut(e),this.popBack(),n.forEach((function(e){return t.pushBack(e)}))}},this.eraseElementByValue=function(e){if(!this.empty()){var t=[];this.forEach((function(n){n!==e&&t.push(n)}));for(var n=t.length,r=0;r<n;++r)this.setElementByPos(r,t[r]);this.cut(n-1)}};var h=function(e){for(var t=[],r=e*s.sigma,u=Math.max(Math.ceil(r/s.bucketSize),2),h=0;h<u;++h)t.push(new Array(s.bucketSize));var f=Math.ceil(e/s.bucketSize),p=Math.floor(u/2)-Math.floor(f/2),g=p,m=0;if(this.size())for(h=0;h<f;++h){for(var y=0;y<s.bucketSize;++y)if(t[p+h][y]=this.front(),this.popFront(),this.empty()){g=p+h,m=y;break}if(this.empty())break}n=t,i=p,a=0,o=g,l=m,c=u,d=e};this.pushBack=function(e){this.empty()||(o===c-1&&l===s.bucketSize-1&&h.call(this,this.size()),l<s.bucketSize-1?++l:o<c-1&&(++o,l=0)),++d,n[o][l]=e},this.popBack=function(){this.empty()||(1!==this.size()&&(l>0?--l:i<o&&(--o,l=s.bucketSize-1)),d>0&&--d)},this.setElementByPos=function(e,t){var r=u(e),s=r.curNodeBucketIndex,i=r.curNodePointerIndex;n[s][i]=t},this.insert=function(e,t,n){var r=this;if(void 0===n&&(n=1),0===e)for(;n--;)this.pushFront(t);else if(e===this.size())for(;n--;)this.pushBack(t);else{for(var s=[],i=e;i<d;++i)s.push(this.getElementByPos(i));for(this.cut(e-1),i=0;i<n;++i)this.pushBack(t);s.forEach((function(e){return r.pushBack(e)}))}},this.find=function(e){if(i===o){for(var t=a;t<=l;++t)if(n[i][t]===e)return!0;return!1}for(t=a;t<s.bucketSize;++t)if(n[i][t]===e)return!0;for(t=i+1;t<o;++t)for(var r=0;r<s.bucketSize;++r)if(n[t][r]===e)return!0;for(t=0;t<=l;++t)if(n[o][t]===e)return!0;return!1},this.reverse=function(){for(var e=0,t=d-1;e<t;){var n=this.getElementByPos(e);this.setElementByPos(e,this.getElementByPos(t)),this.setElementByPos(t,n),++e,--t}},this.unique=function(){if(!this.empty()){var e=[],t=this.front();this.forEach((function(n,r){0!==r&&n===t||(e.push(n),t=n)}));for(var n=0;n<d;++n)this.setElementByPos(n,e[n]);this.cut(e.length-1)}},this.sort=function(e){var t=[];this.forEach((function(e){t.push(e)})),t.sort(e);for(var n=0;n<d;++n)this.setElementByPos(n,t[n])},this.pushFront=function(e){this.empty()||(0===i&&0===a&&h.call(this,this.size()),a>0?--a:i>0&&(--i,a=s.bucketSize-1)),++d,n[i][a]=e},this.popFront=function(){this.empty()||(1!==this.size()&&(a<s.bucketSize-1?++a:i<o&&(++i,a=0)),d>0&&--d)},this.shrinkToFit=function(){var e=this,t=[];this.forEach((function(e){t.push(e)}));var r=t.length;n=[];for(var i=Math.ceil(r/s.bucketSize),a=0;a<i;++a)n.push(new Array(s.bucketSize));this.clear(),t.forEach((function(t){return e.pushBack(t)}))},this.cut=function(e){if(e<0)this.clear();else{var t=u(e),n=t.curNodeBucketIndex,r=t.curNodePointerIndex;o=n,l=r,d=e+1}},this[Symbol.iterator]=function(){return function(){var e,t;return r(this,(function(r){switch(r.label){case 0:if(0===d)return[2];if(i!==o)return[3,5];t=a,r.label=1;case 1:return t<=l?[4,n[i][t]]:[3,4];case 2:r.sent(),r.label=3;case 3:return++t,[3,1];case 4:return[2];case 5:t=a,r.label=6;case 6:return t<s.bucketSize?[4,n[i][t]]:[3,9];case 7:r.sent(),r.label=8;case 8:return++t,[3,6];case 9:t=i+1,r.label=10;case 10:if(!(t<o))return[3,15];e=0,r.label=11;case 11:return e<s.bucketSize?[4,n[t][e]]:[3,14];case 12:r.sent(),r.label=13;case 13:return++e,[3,11];case 14:return++t,[3,10];case 15:t=0,r.label=16;case 16:return t<=l?[4,n[o][t]]:[3,19];case 17:r.sent(),r.label=18;case 18:return++t,[3,16];case 19:return[2]}}))}()},function(){var r=s.bucketSize;e.size?r=e.size():e.length&&(r=e.length);var a=r*s.sigma;c=Math.ceil(a/s.bucketSize),c=Math.max(c,3);for(var l=0;l<c;++l)n.push(new Array(s.bucketSize));var d=Math.ceil(r/s.bucketSize);i=Math.floor(c/2)-Math.floor(d/2),o=i,e.forEach((function(e){return t.pushBack(e)}))}(),Object.freeze(this)}Object.defineProperty(n,"__esModule",{value:!0}),s.sigma=3,s.bucketSize=5e3,Object.freeze(s),n.default=s},{}],27:[function(e,t,n){var r=this&&this.__generator||function(e,t){var n,r,s,i,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(e){return function(t){return l([e,t])}}function l(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((s=(s=a.trys).length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){a.label=i[1];break}if(6===i[0]&&a.label<s[1]){a.label=s[1],s=i;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(i);break}s[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}},s=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(n,"__esModule",{value:!0});var i=e("../LinkList/LinkList"),a=e("../Map/Map");function o(e,t,n){var l=this;if(void 0===e&&(e=[]),void 0===t&&(t=o.initSize),n=n||function(e){var t,n,r=0,i="";if("number"==typeof e)r=((r=Math.floor(e))<<5)-r,r&=r;else{i="string"!=typeof e?JSON.stringify(e):e;try{for(var a=s(i),o=a.next();!o.done;o=a.next())r=(r<<5)-r+o.value.charCodeAt(0),r&=r}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}}return r^=r>>>16},0!=(t&t-1))throw new Error("initBucketNum must be 2 to the power of n");var c=0,d=[],u=Math.max(o.initSize,Math.min(o.maxSize,t));this.size=function(){return c},this.empty=function(){return 0===c},this.clear=function(){c=0,u=t,d=[]},this.forEach=function(e){var t=0;d.forEach((function(n){n.forEach((function(n){e(n,t++)}))}))};var h=function(e){if(!(e>=o.maxSize)){u=2*e;var t=[];d.forEach((function(r,s){if(!r.empty()){if(r instanceof i.default&&1===r.size()){var l=r.front(),c=l.key,h=l.value;t[n(c)&u-1]=new i.default([{key:c,value:h}])}else if(r instanceof a.default){var f=new i.default,p=new i.default;r.forEach((function(t){0==(n(t.key)&e)?f.pushBack(t):p.pushBack(t)})),f.size()>o.untreeifyThreshold?t[s]=new a.default(f):f.size()&&(t[s]=f),p.size()>o.untreeifyThreshold?t[s+e]=new a.default(p):p.size()&&(t[s+e]=p)}else{var g=new i.default,m=new i.default;r.forEach((function(t){0==(n(t.key)&e)?g.pushBack(t):m.pushBack(t)})),g.size()&&(t[s]=g),m.size()&&(t[s+e]=m)}d[s].clear()}})),d=t}};this.setElement=function(e,t){var r,l;if(null==e)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(null!=t){var f=n(e)&u-1;if(d[f]){var p=d[f].size();if(d[f]instanceof i.default){try{for(var g=s(d[f]),m=g.next();!m.done;m=g.next()){var y=m.value;if(y.key===e)return void(y.value=t)}}catch(e){r={error:e}}finally{try{m&&!m.done&&(l=g.return)&&l.call(g)}finally{if(r)throw r.error}}d[f].pushBack({key:e,value:t}),d[f].size()>=o.treeifyThreshold&&(d[f]=new a.default(d[f]))}else d[f].setElement(e,t);var v=d[f].size();c+=v-p}else++c,d[f]=new i.default([{key:e,value:t}]);c>u*o.sigma&&h.call(this,u)}else this.eraseElementByKey(e)},this.getElementByKey=function(e){var t,r,i=n(e)&u-1;if(d[i]){if(d[i]instanceof a.default)return d[i].getElementByKey(e);try{for(var o=s(d[i]),l=o.next();!l.done;l=o.next()){var c=l.value;if(c.key===e)return c.value}}catch(e){t={error:e}}finally{try{l&&!l.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}}},this.eraseElementByKey=function(e){var t,r,l=n(e)&u-1;if(d[l]){var h=d[l].size();if(d[l]instanceof a.default)d[l].eraseElementByKey(e),d[l].size()<=o.untreeifyThreshold&&(d[l]=new i.default(d[l]));else{var f=-1;try{for(var p=s(d[l]),g=p.next();!g.done;g=p.next()){var m=g.value;if(++f,m.key===e){d[l].eraseElementByPos(f);break}}}catch(e){t={error:e}}finally{try{g&&!g.done&&(r=p.return)&&r.call(p)}finally{if(t)throw t.error}}}var y=d[l].size();c+=y-h}},this.find=function(e){var t,r,i=n(e)&u-1;if(!d[i])return!1;if(d[i]instanceof a.default)return d[i].find(e);try{for(var o=s(d[i]),l=o.next();!l.done;l=o.next())if(l.value.key===e)return!0}catch(e){t={error:e}}finally{try{l&&!l.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return!1},this[Symbol.iterator]=function(){return function(){var e,t,n,i,a,o;return r(this,(function(r){switch(r.label){case 0:e=0,r.label=1;case 1:if(!(e<u))return[3,10];for(;e<u&&!d[e];)++e;if(e>=u)return[3,10];r.label=2;case 2:r.trys.push([2,7,8,9]),a=void 0,t=s(d[e]),n=t.next(),r.label=3;case 3:return n.done?[3,6]:[4,n.value];case 4:r.sent(),r.label=5;case 5:return n=t.next(),[3,3];case 6:return[3,9];case 7:return i=r.sent(),a={error:i},[3,9];case 8:try{n&&!n.done&&(o=t.return)&&o.call(t)}finally{if(a)throw a.error}return[7];case 9:return++e,[3,1];case 10:return[2]}}))}()},e.forEach((function(e){var t=e.key,n=e.value;return l.setElement(t,n)})),Object.freeze(this)}o.initSize=16,o.maxSize=1<<30,o.sigma=.75,o.treeifyThreshold=8,o.untreeifyThreshold=6,o.minTreeifySize=64,Object.freeze(o),n.default=o},{"../LinkList/LinkList":29,"../Map/Map":30}],28:[function(e,t,n){var r=this&&this.__generator||function(e,t){var n,r,s,i,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(e){return function(t){return l([e,t])}}function l(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((s=(s=a.trys).length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){a.label=i[1];break}if(6===i[0]&&a.label<s[1]){a.label=s[1],s=i;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(i);break}s[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}},s=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(n,"__esModule",{value:!0});var i=e("../Set/Set"),a=e("../LinkList/LinkList");function o(e,t,n){var l=this;if(void 0===e&&(e=[]),void 0===t&&(t=o.initSize),n=n||function(e){var t=0,n="";if("number"==typeof e)t=((t=Math.floor(e))<<5)-t,t&=t;else{n="string"!=typeof e?JSON.stringify(e):e;for(var r=0;r<n.length;r++)t=(t<<5)-t+n.charCodeAt(r),t&=t}return t^=t>>>16},0!=(t&t-1))throw new Error("initBucketNum must be 2 to the power of n");var c=0,d=[],u=Math.max(o.initSize,Math.min(o.maxSize,t));this.size=function(){return c},this.empty=function(){return 0===c},this.clear=function(){c=0,u=t,d=[]},this.forEach=function(e){var t=0;d.forEach((function(n){n.forEach((function(n){e(n,t++)}))}))};var h=function(e){if(!(e>=o.maxSize)){u=2*e;var t=[];d.forEach((function(r,s){if(!r.empty()){if(r instanceof a.default&&1===r.size()){var l=r.front();if(void 0===l)throw new Error("unknown error");t[n(l)&u-1]=new a.default([l])}else if(r instanceof i.default){var c=new a.default,h=new a.default;r.forEach((function(t){0==(n(t)&e)?c.pushBack(t):h.pushBack(t)})),c.size()>o.untreeifyThreshold?t[s]=new i.default(c):c.size()&&(t[s]=c),h.size()>o.untreeifyThreshold?t[s+e]=new i.default(h):h.size()&&(t[s+e]=h)}else{var f=new a.default,p=new a.default;r.forEach((function(t){0==(n(t)&e)?f.pushBack(t):p.pushBack(t)})),f.size()&&(t[s]=f),p.size()&&(t[s+e]=p)}d[s].clear()}})),d=t}};this.insert=function(e){if(null==e)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");var t=n(e)&u-1;if(d[t]){var r=d[t].size();if(d[t]instanceof a.default){if(d[t].find(e))return;d[t].pushBack(e),d[t].size()>=o.treeifyThreshold&&(d[t]=new i.default(d[t]))}else d[t].insert(e);var s=d[t].size();c+=s-r}else d[t]=new a.default([e]),++c;c>u*o.sigma&&h.call(this,u)},this.eraseElementByValue=function(e){var t=n(e)&u-1;if(d[t]){var r=d[t].size();d[t].eraseElementByValue(e),d[t]instanceof i.default&&d[t].size()<=o.untreeifyThreshold&&(d[t]=new a.default(d[t]));var s=d[t].size();c+=s-r}},this.find=function(e){var t=n(e)&u-1;return!!d[t]&&d[t].find(e)},this[Symbol.iterator]=function(){return function(){var e,t,n,i,a,o;return r(this,(function(r){switch(r.label){case 0:e=0,r.label=1;case 1:if(!(e<u))return[3,10];for(;e<u&&!d[e];)++e;if(e>=u)return[3,10];r.label=2;case 2:r.trys.push([2,7,8,9]),a=void 0,t=s(d[e]),n=t.next(),r.label=3;case 3:return n.done?[3,6]:[4,n.value];case 4:r.sent(),r.label=5;case 5:return n=t.next(),[3,3];case 6:return[3,9];case 7:return i=r.sent(),a={error:i},[3,9];case 8:try{n&&!n.done&&(o=t.return)&&o.call(t)}finally{if(a)throw a.error}return[7];case 9:return++e,[3,1];case 10:return[2]}}))}()},e.forEach((function(e){return l.insert(e)})),Object.freeze(this)}o.initSize=16,o.maxSize=1<<30,o.sigma=.75,o.treeifyThreshold=8,o.untreeifyThreshold=6,o.minTreeifySize=64,Object.freeze(o),n.default=o},{"../LinkList/LinkList":29,"../Set/Set":33}],29:[function(e,t,n){var r=this&&this.__generator||function(e,t){var n,r,s,i,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(e){return function(t){return l([e,t])}}function l(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((s=(s=a.trys).length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){a.label=i[1];break}if(6===i[0]&&a.label<s[1]){a.label=s[1],s=i;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(i);break}s[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}};Object.defineProperty(n,"__esModule",{value:!0});var s=function(){function e(e){this.value=void 0,this.pre=void 0,this.next=void 0,this.value=e}return e}();function i(e){var t=this;void 0===e&&(e=[]);var n=0,i=void 0,a=void 0;this.size=function(){return n},this.empty=function(){return 0===n},this.clear=function(){i=a=void 0,n=0},this.front=function(){return null==i?void 0:i.value},this.back=function(){return null==a?void 0:a.value},this.forEach=function(e){for(var t=i,n=0;t;){if(void 0===t.value)throw new Error("unknown error");e(t.value,n++),t=t.next}},this.getElementByPos=function(e){if(e<0||e>=n)throw new Error("pos must more then 0 and less then the list length");for(var t=i;e--&&t;)t=t.next;if(!t||void 0===t.value)throw new Error("unknown error");return t.value},this.eraseElementByPos=function(e){if(e<0||e>=n)throw new Error("erase pos must more then 0 and less then the list length");if(0===e)this.popFront();else if(e===n-1)this.popBack();else{for(var t=i;e--;){if(!(null==t?void 0:t.next))throw new Error("unknown error");t=t.next}if(!t||!t.pre||!t.next)throw new Error("unknown error");var r=t.pre,s=t.next;s.pre=r,r.next=s,n>0&&--n}},this.eraseElementByValue=function(e){for(;i&&i.value===e;)this.popFront();for(;a&&a.value===e;)this.popBack();if(i)for(var t=i;t;){if(t.value===e){var r=t.pre,s=t.next;s&&(s.pre=r),r&&(r.next=s),n>0&&--n}t=t.next}},this.pushBack=function(e){if(null==e)throw new Error("you can't push null or undefined here");++n;var t=new s(e);a?(a.next=t,t.pre=a,a=t):i=a=t},this.popBack=function(){a&&(n>0&&--n,a&&(i===a?i=a=void 0:(a=a.pre)&&(a.next=void 0)))},this.setElementByPos=function(e,t){if(null==t)throw new Error("you can't set null or undefined here");if(e<0||e>=n)throw new Error("pos must more then 0 and less then the list length");for(var r=i;e--;){if(!r)throw new Error("unknown error");r=r.next}r&&(r.value=t)},this.insert=function(e,t,r){if(void 0===r&&(r=1),null==t)throw new Error("you can't insert null or undefined here");if(e<0||e>n)throw new Error("insert pos must more then 0 and less then or equal to the list length");if(r<0)throw new Error("insert size must more than 0");if(0===e)for(;r--;)this.pushFront(t);else if(e===n)for(;r--;)this.pushBack(t);else{for(var a=i,o=1;o<e;++o){if(!(null==a?void 0:a.next))throw new Error("unknown error");a=null==a?void 0:a.next}if(!a)throw new Error("unknown error");var l=a.next;for(n+=r;r--;)a.next=new s(t),a.next.pre=a,a=a.next;a.next=l,l&&(l.pre=a)}},this.find=function(e){for(var t=i;t;){if(t.value===e)return!0;t=t.next}return!1},this.reverse=function(){for(var e=i,t=a,r=0;e&&t&&2*r<n;){var s=e.value;e.value=t.value,t.value=s,e=e.next,t=t.pre,++r}},this.unique=function(){for(var e=i;e;){for(var t=e;t&&t.next&&t.value===t.next.value;)t=t.next,n>0&&--n;e.next=t.next,e.next&&(e.next.pre=e),e=e.next}},this.sort=function(e){var t=[];this.forEach((function(e){t.push(e)})),t.sort(e);var n=i;t.forEach((function(e){n&&(n.value=e,n=n.next)}))},this.pushFront=function(e){if(null==e)throw new Error("you can't push null or undefined here");++n;var t=new s(e);i?(t.next=i,i.pre=t,i=t):i=a=t},this.popFront=function(){i&&(n>0&&--n,i&&(i===a?i=a=void 0:(i=i.next)&&(i.pre=void 0)))},this.merge=function(e){var t=this,r=i;e.forEach((function(e){for(;r&&void 0!==r.value&&r.value<=e;)r=r.next;if(void 0===r)t.pushBack(e),r=a;else if(r===i)t.pushFront(e),r=i;else{++n;var o=r.pre;o&&(o.next=new s(e),o.next.pre=o,o.next.next=r,r&&(r.pre=o.next))}}))},this[Symbol.iterator]=function(){return function(){var e;return r(this,(function(t){switch(t.label){case 0:e=i,t.label=1;case 1:if(void 0===e)return[3,3];if(!e.value)throw new Error("unknown error");return[4,e.value];case 2:return t.sent(),e=e.next,[3,1];case 3:return[2]}}))}()},e.forEach((function(e){return t.pushBack(e)})),Object.freeze(this)}Object.freeze(i),n.default=i},{}],30:[function(e,t,n){var r=this&&this.__generator||function(e,t){var n,r,s,i,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(e){return function(t){return l([e,t])}}function l(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((s=(s=a.trys).length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){a.label=i[1];break}if(6===i[0]&&a.label<s[1]){a.label=s[1],s=i;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(i);break}s[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}},s=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(n,"__esModule",{value:!0});var i=e("../Base/TreeNode");function a(e,t){var n=this;void 0===e&&(e=[]),t=t||function(e,t){return e<t?-1:e>t?1:0};var a=0,o=new i.default;o.color=i.default.TreeNodeColorType.black,this.size=function(){return a},this.empty=function(){return 0===a},this.clear=function(){a=0,o.key=o.value=void 0,o.leftChild=o.rightChild=o.brother=void 0};var l=function(e){if(!e||void 0===e.key)throw new Error("unknown error");return e.leftChild?l(e.leftChild):e},c=function(e){if(!e||void 0===e.key)throw new Error("unknown error");return e.rightChild?c(e.rightChild):e};this.front=function(){if(!this.empty()){var e=l(o);if(void 0===e.key||void 0===e.value)throw new Error("unknown error");return{key:e.key,value:e.value}}},this.back=function(){if(!this.empty()){var e=c(o);if(void 0===e.key||void 0===e.value)throw new Error("unknown error");return{key:e.key,value:e.value}}},this.forEach=function(e){var t,n,r=0;try{for(var i=s(this),a=i.next();!a.done;a=i.next())e(a.value,r++)}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}},this.getElementByPos=function(e){var t,n;if(e<0||e>=this.size())throw new Error("pos must more than 0 and less than set's size");var r=0;try{for(var i=s(this),a=i.next();!a.done;a=i.next()){var o=a.value;if(r===e)return o;++r}}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}throw new Error("unknown Error")};var d=function(e,n){if(e&&void 0!==e.key&&void 0!==e.value){var r=t(e.key,n);return 0===r?{key:e.key,value:e.value}:r<0?d(e.rightChild,n):d(e.leftChild,n)||{key:e.key,value:e.value}}};this.lowerBound=function(e){return d(o,e)};var u=function(e,n){if(e&&void 0!==e.key&&void 0!==e.value)return t(e.key,n)<=0?u(e.rightChild,n):u(e.leftChild,n)||{key:e.key,value:e.value}};this.upperBound=function(e){return u(o,e)};var h=function(e,n){if(e&&void 0!==e.key&&void 0!==e.value){var r=t(e.key,n);return 0===r?{key:e.key,value:e.value}:r>0?h(e.leftChild,n):h(e.rightChild,n)||{key:e.key,value:e.value}}};this.reverseLowerBound=function(e){return h(o,e)};var f=function(e,n){if(e&&void 0!==e.key&&void 0!==e.value)return t(e.key,n)>=0?f(e.leftChild,n):f(e.rightChild,n)||{key:e.key,value:e.value}};this.reverseUpperBound=function(e){return f(o,e)};var p=function(e){var t=e.parent;if(!t){if(e===o)return;throw new Error("unknown error")}if(e.color!==i.default.TreeNodeColorType.red){var n=e.brother;if(!n)throw new Error("unknown error");if(e===t.leftChild)if(n.color===i.default.TreeNodeColorType.red){n.color=i.default.TreeNodeColorType.black,t.color=i.default.TreeNodeColorType.red;var r=t.rotateLeft();o===t&&(o=r),p(e)}else n.color===i.default.TreeNodeColorType.black&&(n.rightChild&&n.rightChild.color===i.default.TreeNodeColorType.red?(n.color=t.color,t.color=i.default.TreeNodeColorType.black,n.rightChild&&(n.rightChild.color=i.default.TreeNodeColorType.black),r=t.rotateLeft(),o===t&&(o=r),e.color=i.default.TreeNodeColorType.black):n.rightChild&&n.rightChild.color!==i.default.TreeNodeColorType.black||!n.leftChild||n.leftChild.color!==i.default.TreeNodeColorType.red?n.leftChild&&n.leftChild.color!==i.default.TreeNodeColorType.black||n.rightChild&&n.rightChild.color!==i.default.TreeNodeColorType.black||(n.color=i.default.TreeNodeColorType.red,p(t)):(n.color=i.default.TreeNodeColorType.red,n.leftChild&&(n.leftChild.color=i.default.TreeNodeColorType.black),r=n.rotateRight(),o===n&&(o=r),p(e)));else e===t.rightChild&&(n.color===i.default.TreeNodeColorType.red?(n.color=i.default.TreeNodeColorType.black,t.color=i.default.TreeNodeColorType.red,r=t.rotateRight(),o===t&&(o=r),p(e)):n.color===i.default.TreeNodeColorType.black&&(n.leftChild&&n.leftChild.color===i.default.TreeNodeColorType.red?(n.color=t.color,t.color=i.default.TreeNodeColorType.black,n.leftChild&&(n.leftChild.color=i.default.TreeNodeColorType.black),r=t.rotateRight(),o===t&&(o=r),e.color=i.default.TreeNodeColorType.black):n.leftChild&&n.leftChild.color!==i.default.TreeNodeColorType.black||!n.rightChild||n.rightChild.color!==i.default.TreeNodeColorType.red?n.leftChild&&n.leftChild.color!==i.default.TreeNodeColorType.black||n.rightChild&&n.rightChild.color!==i.default.TreeNodeColorType.black||(n.color=i.default.TreeNodeColorType.red,p(t)):(n.color=i.default.TreeNodeColorType.red,n.rightChild&&(n.rightChild.color=i.default.TreeNodeColorType.black),r=n.rotateLeft(),o===n&&(o=r),p(e))))}else e.color=i.default.TreeNodeColorType.black},g=function(e){for(var t=e;t.leftChild||t.rightChild;){if(t.rightChild){t=l(t.rightChild);var n=e.key;e.key=t.key,t.key=n;var r=e.value;e.value=t.value,t.value=r,e=t}t.leftChild&&(t=c(t.leftChild),n=e.key,e.key=t.key,t.key=n,r=e.value,e.value=t.value,t.value=r,e=t)}p(t),t&&t.remove(),--a,o.color=i.default.TreeNodeColorType.black},m=function(e,t){return!(!e||void 0===e.key)&&(!!m(e.leftChild,t)||!!t(e)||m(e.rightChild,t))};this.eraseElementByPos=function(e){if(e<0||e>=a)throw new Error("pos must more than 0 and less than set's size");var t=0;m(o,(function(n){return e===t?(g(n),!0):(++t,!1)}))},this.eraseElementByKey=function(e){if(!this.empty()){var n=b(o,e);void 0!==n&&void 0!==n.key&&0===t(n.key,e)&&g(n)}};var y=function(e,n){if(!e||void 0===e.key)throw new Error("unknown error");var r=t(n,e.key);return r<0?e.leftChild?y(e.leftChild,n):(e.leftChild=new i.default,e.leftChild.parent=e,e.leftChild.brother=e.rightChild,e.rightChild&&(e.rightChild.brother=e.leftChild),e.leftChild):r>0?e.rightChild?y(e.rightChild,n):(e.rightChild=new i.default,e.rightChild.parent=e,e.rightChild.brother=e.leftChild,e.leftChild&&(e.leftChild.brother=e.rightChild),e.rightChild):e},v=function(e){var t=e.parent;if(!t){if(e===o)return;throw new Error("unknown error")}if(t.color!==i.default.TreeNodeColorType.black&&t.color===i.default.TreeNodeColorType.red){var n=t.brother,r=t.parent;if(!r)throw new Error("unknown error");if(n&&n.color===i.default.TreeNodeColorType.red)n.color=t.color=i.default.TreeNodeColorType.black,r.color=i.default.TreeNodeColorType.red,v(r);else if(!n||n.color===i.default.TreeNodeColorType.black)if(t===r.leftChild)if(e===t.leftChild){t.color=i.default.TreeNodeColorType.black,r.color=i.default.TreeNodeColorType.red;var s=r.rotateRight();r===o&&(o=s)}else e===t.rightChild&&(s=t.rotateLeft(),r===o&&(o=s),v(t));else t===r.rightChild&&(e===t.leftChild?(s=t.rotateRight(),r===o&&(o=s),v(t)):e===t.rightChild&&(t.color=i.default.TreeNodeColorType.black,r.color=i.default.TreeNodeColorType.red,s=r.rotateLeft(),r===o&&(o=s)))}};this.setElement=function(e,n){if(null==e)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(null!=n){if(this.empty())return++a,o.key=e,o.value=n,void(o.color=i.default.TreeNodeColorType.black);var r=y(o,e);void 0===r.key||0!==t(r.key,e)?(++a,r.key=e,r.value=n,v(r),o.color=i.default.TreeNodeColorType.black):r.value=n}else this.eraseElementByKey(e)};var b=function(e,n){if(e&&void 0!==e.key){var r=t(n,e.key);return r<0?b(e.leftChild,n):r>0?b(e.rightChild,n):e}};this.find=function(e){return!!b(o,e)},this.getElementByKey=function(e){var t=b(o,e);if(void 0===(null==t?void 0:t.key)||void 0===(null==t?void 0:t.value))throw new Error("unknown error");return t.value},this.union=function(e){var t=this;e.forEach((function(e){var n=e.key,r=e.value;return t.setElement(n,r)}))},this.getHeight=function(){if(this.empty())return 0;var e=function(t){return t?Math.max(e(t.leftChild),e(t.rightChild))+1:1};return e(o)};var w=function(e){return r(this,(function(t){switch(t.label){case 0:return e&&void 0!==e.key&&void 0!==e.value?[5,s(w(e.leftChild))]:[2];case 1:return t.sent(),[4,{key:e.key,value:e.value}];case 2:return t.sent(),[5,s(w(e.rightChild))];case 3:return t.sent(),[2]}}))};this[Symbol.iterator]=function(){return w(o)},e.forEach((function(e){var t=e.key,r=e.value;return n.setElement(t,r)})),Object.freeze(this)}Object.freeze(a),n.default=a},{"../Base/TreeNode":25}],31:[function(e,t,n){function r(e,t){void 0===e&&(e=[]),t=t||function(e,t){return e>t?-1:e<t?1:0};var n=[];e.forEach((function(e){return n.push(e)}));var r=n.length,s=function(e,t){if(e<0||e>=r)throw new Error("unknown error");if(t<0||t>=r)throw new Error("unknown error");var s=n[e];n[e]=n[t],n[t]=s},i=function(e){if(e<0||e>=r)throw new Error("unknown error");var i=2*e+1,a=2*e+2;i<r&&t(n[e],n[i])>0&&s(e,i),a<r&&t(n[e],n[a])>0&&s(e,a)};!function(){for(var e=Math.floor((r-1)/2);e>=0;--e)for(var i=e,a=2*i+1;a<r;){var o=a+1,l=a;if(o<r&&t(n[a],n[o])>0&&(l=o),t(n[i],n[l])<=0)break;s(i,l),a=2*(i=l)+1}}(),this.size=function(){return r},this.empty=function(){return 0===r},this.clear=function(){r=0,n.length=0},this.push=function(e){if(n.push(e),1!=++r)for(var s=r-1;s>0;){var a=Math.floor((s-1)/2);if(t(n[a],e)<=0)break;i(a),s=a}},this.pop=function(){if(!this.empty())if(1!==this.size()){var e=n[r-1];--r;for(var s=0;s<this.size();){var i=2*s+1,a=2*s+2;if(i>=this.size())break;var o=i;if(a<this.size()&&t(n[i],n[a])>0&&(o=a),t(n[o],e)>=0)break;n[s]=n[o],s=o}n[s]=e}else--r},this.top=function(){return n[0]},Object.freeze(this)}Object.defineProperty(n,"__esModule",{value:!0}),Object.freeze(r),n.default=r},{}],32:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var r=e("../LinkList/LinkList");function s(e){void 0===e&&(e=[]);var t=new r.default(e);this.size=function(){return t.size()},this.empty=function(){return t.empty()},this.clear=function(){t.clear()},this.push=function(e){t.pushBack(e)},this.pop=function(){t.popFront()},this.front=function(){return t.front()},Object.freeze(this)}Object.freeze(s),n.default=s},{"../LinkList/LinkList":29}],33:[function(e,t,n){var r=this&&this.__generator||function(e,t){var n,r,s,i,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(e){return function(t){return l([e,t])}}function l(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((s=(s=a.trys).length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){a.label=i[1];break}if(6===i[0]&&a.label<s[1]){a.label=s[1],s=i;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(i);break}s[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}},s=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(n,"__esModule",{value:!0});var i=e("../Base/TreeNode");function a(e,t){var n=this;void 0===e&&(e=[]),t=t||function(e,t){return e<t?-1:e>t?1:0};var a=0,o=new i.default;o.color=i.default.TreeNodeColorType.black,this.size=function(){return a},this.empty=function(){return 0===a},this.clear=function(){a=0,o.key=void 0,o.leftChild=o.rightChild=o.brother=o.parent=void 0,o.color=i.default.TreeNodeColorType.black};var l=function(e){if(!e||void 0===e.key)throw new Error("unknown error");return e.leftChild?l(e.leftChild):e},c=function(e){if(!e||void 0===e.key)throw new Error("unknown error");return e.rightChild?c(e.rightChild):e};this.front=function(){if(!this.empty())return l(o).key},this.back=function(){if(!this.empty())return c(o).key},this.forEach=function(e){var t,n,r=0;try{for(var i=s(this),a=i.next();!a.done;a=i.next())e(a.value,r++)}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}},this.getElementByPos=function(e){var t,n;if(e<0||e>=this.size())throw new Error("pos must more than 0 and less than set's size");var r=0;try{for(var i=s(this),a=i.next();!a.done;a=i.next()){var o=a.value;if(r===e)return o;++r}}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}throw new Error("unknown error")};var d=function(e){var t=e.parent;if(!t){if(e===o)return;throw new Error("unknown error")}if(e.color!==i.default.TreeNodeColorType.red){var n=e.brother;if(!n)throw new Error("unknown error");if(e===t.leftChild)if(n.color===i.default.TreeNodeColorType.red){n.color=i.default.TreeNodeColorType.black,t.color=i.default.TreeNodeColorType.red;var r=t.rotateLeft();o===t&&(o=r),d(e)}else n.color===i.default.TreeNodeColorType.black&&(n.rightChild&&n.rightChild.color===i.default.TreeNodeColorType.red?(n.color=t.color,t.color=i.default.TreeNodeColorType.black,n.rightChild&&(n.rightChild.color=i.default.TreeNodeColorType.black),r=t.rotateLeft(),o===t&&(o=r),e.color=i.default.TreeNodeColorType.black):n.rightChild&&n.rightChild.color!==i.default.TreeNodeColorType.black||!n.leftChild||n.leftChild.color!==i.default.TreeNodeColorType.red?n.leftChild&&n.leftChild.color!==i.default.TreeNodeColorType.black||n.rightChild&&n.rightChild.color!==i.default.TreeNodeColorType.black||(n.color=i.default.TreeNodeColorType.red,d(t)):(n.color=i.default.TreeNodeColorType.red,n.leftChild&&(n.leftChild.color=i.default.TreeNodeColorType.black),r=n.rotateRight(),o===n&&(o=r),d(e)));else e===t.rightChild&&(n.color===i.default.TreeNodeColorType.red?(n.color=i.default.TreeNodeColorType.black,t.color=i.default.TreeNodeColorType.red,r=t.rotateRight(),o===t&&(o=r),d(e)):n.color===i.default.TreeNodeColorType.black&&(n.leftChild&&n.leftChild.color===i.default.TreeNodeColorType.red?(n.color=t.color,t.color=i.default.TreeNodeColorType.black,n.leftChild&&(n.leftChild.color=i.default.TreeNodeColorType.black),r=t.rotateRight(),o===t&&(o=r),e.color=i.default.TreeNodeColorType.black):n.leftChild&&n.leftChild.color!==i.default.TreeNodeColorType.black||!n.rightChild||n.rightChild.color!==i.default.TreeNodeColorType.red?n.leftChild&&n.leftChild.color!==i.default.TreeNodeColorType.black||n.rightChild&&n.rightChild.color!==i.default.TreeNodeColorType.black||(n.color=i.default.TreeNodeColorType.red,d(t)):(n.color=i.default.TreeNodeColorType.red,n.rightChild&&(n.rightChild.color=i.default.TreeNodeColorType.black),r=n.rotateLeft(),o===n&&(o=r),d(e))))}else e.color=i.default.TreeNodeColorType.black},u=function(e){for(var t=e;t.leftChild||t.rightChild;){if(t.rightChild){t=l(t.rightChild);var n=e.key;e.key=t.key,t.key=n,e=t}t.leftChild&&(t=c(t.leftChild),n=e.key,e.key=t.key,t.key=n,e=t)}d(t),t&&t.remove(),--a,o.color=i.default.TreeNodeColorType.black},h=function(e,t){return!(!e||void 0===e.key)&&(!!h(e.leftChild,t)||!!t(e)||h(e.rightChild,t))};this.eraseElementByPos=function(e){if(e<0||e>=a)throw new Error("pos must more than 0 and less than set's size");var t=0;h(o,(function(n){return e===t?(u(n),!0):(++t,!1)}))},this.eraseElementByValue=function(e){if(!this.empty()){var n=g(o,e);void 0!==n&&void 0!==n.key&&0===t(n.key,e)&&u(n)}};var f=function(e,n){if(!e||void 0===e.key)throw new Error("unknown error");var r=t(n,e.key);return r<0?e.leftChild?f(e.leftChild,n):(e.leftChild=new i.default,e.leftChild.parent=e,e.leftChild.brother=e.rightChild,e.rightChild&&(e.rightChild.brother=e.leftChild),e.leftChild):r>0?e.rightChild?f(e.rightChild,n):(e.rightChild=new i.default,e.rightChild.parent=e,e.rightChild.brother=e.leftChild,e.leftChild&&(e.leftChild.brother=e.rightChild),e.rightChild):e},p=function(e){var t=e.parent;if(!t){if(e===o)return;throw new Error("unknown error")}if(t.color!==i.default.TreeNodeColorType.black&&t.color===i.default.TreeNodeColorType.red){var n=t.brother,r=t.parent;if(!r)throw new Error("unknown error");if(n&&n.color===i.default.TreeNodeColorType.red)n.color=t.color=i.default.TreeNodeColorType.black,r.color=i.default.TreeNodeColorType.red,p(r);else if(!n||n.color===i.default.TreeNodeColorType.black)if(t===r.leftChild)if(e===t.leftChild){t.color=i.default.TreeNodeColorType.black,r.color=i.default.TreeNodeColorType.red;var s=r.rotateRight();r===o&&(o=s)}else e===t.rightChild&&(s=t.rotateLeft(),r===o&&(o=s),p(t));else t===r.rightChild&&(e===t.leftChild?(s=t.rotateRight(),r===o&&(o=s),p(t)):e===t.rightChild&&(t.color=i.default.TreeNodeColorType.black,r.color=i.default.TreeNodeColorType.red,s=r.rotateLeft(),r===o&&(o=s)))}};this.insert=function(e){if(null==e)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(this.empty())return++a,o.key=e,void(o.color=i.default.TreeNodeColorType.black);var n=f(o,e);void 0!==n.key&&0===t(n.key,e)||(++a,n.key=e,p(n),o.color=i.default.TreeNodeColorType.black)};var g=function(e,n){if(e&&void 0!==e.key){var r=t(n,e.key);return r<0?g(e.leftChild,n):r>0?g(e.rightChild,n):e}};this.find=function(e){var n=g(o,e);return void 0!==n&&void 0!==n.key&&0===t(n.key,e)};var m=function(e,n){if(e&&void 0!==e.key){var r=t(e.key,n);if(0===r)return e.key;if(r<0)return m(e.rightChild,n);var s=m(e.leftChild,n);return void 0!==s?s:e.key}};this.lowerBound=function(e){return m(o,e)};var y=function(e,n){if(e&&void 0!==e.key){if(t(e.key,n)<=0)return y(e.rightChild,n);var r=y(e.leftChild,n);return void 0!==r?r:e.key}};this.upperBound=function(e){return y(o,e)};var v=function(e,n){if(e&&void 0!==e.key){var r=t(e.key,n);if(0===r)return e.key;if(r>0)return v(e.leftChild,n);var s=v(e.rightChild,n);return void 0!==s?s:e.key}};this.reverseLowerBound=function(e){return v(o,e)};var b=function(e,n){if(e&&void 0!==e.key){if(t(e.key,n)>=0)return b(e.leftChild,n);var r=b(e.rightChild,n);return void 0!==r?r:e.key}};this.reverseUpperBound=function(e){return b(o,e)},this.union=function(e){var t=this;e.forEach((function(e){return t.insert(e)}))},this.getHeight=function(){if(this.empty())return 0;var e=function(t){return t?Math.max(e(t.leftChild),e(t.rightChild))+1:1};return e(o)};var w=function(e){return r(this,(function(t){switch(t.label){case 0:return e&&void 0!==e.key?[5,s(w(e.leftChild))]:[2];case 1:return t.sent(),[4,e.key];case 2:return t.sent(),[5,s(w(e.rightChild))];case 3:return t.sent(),[2]}}))};this[Symbol.iterator]=function(){return w(o)},e.forEach((function(e){return n.insert(e)})),Object.freeze(this)}Object.freeze(a),n.default=a},{"../Base/TreeNode":25}],34:[function(e,t,n){function r(e){var t=this;void 0===e&&(e=[]);var n=0,r=[];this.size=function(){return n},this.empty=function(){return 0===n},this.clear=function(){n=0,r.length=0},this.push=function(e){r.push(e),++n},this.pop=function(){r.pop(),n>0&&--n},this.top=function(){return r[n-1]},e.forEach((function(e){return t.push(e)})),Object.freeze(this)}Object.defineProperty(n,"__esModule",{value:!0}),Object.freeze(r),n.default=r},{}],35:[function(e,t,n){var r=this&&this.__generator||function(e,t){var n,r,s,i,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(e){return function(t){return l([e,t])}}function l(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((s=(s=a.trys).length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){a.label=i[1];break}if(6===i[0]&&a.label<s[1]){a.label=s[1],s=i;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(i);break}s[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}},s=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,s,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){s={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(s)throw s.error}}return a},i=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,s=0,i=t.length;s<i;s++)!r&&s in t||(r||(r=Array.prototype.slice.call(t,0,s)),r[s]=t[s]);return e.concat(r||Array.prototype.slice.call(t))},a=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};function o(e){var t=this;void 0===e&&(e=[]);var n=0,o=[];this.size=function(){return n},this.empty=function(){return 0===n},this.clear=function(){n=0,o.length=0},this.front=function(){if(!this.empty())return o[0]},this.back=function(){if(!this.empty())return o[n-1]},this.forEach=function(e){o.forEach(e)},this.getElementByPos=function(e){if(e<0||e>=n)throw new Error("pos must more than 0 and less than vector's size");return o[e]},this.eraseElementByPos=function(e){if(e<0||e>=n)throw new Error("pos must more than 0 and less than vector's size");for(var t=e;t<n-1;++t)o[t]=o[t+1];this.popBack()},this.eraseElementByValue=function(e){var t=[];this.forEach((function(n){n!==e&&t.push(n)})),t.forEach((function(e,t){o[t]=e}));for(var r=t.length;n>r;)this.popBack()},this.pushBack=function(e){o.push(e),++n},this.popBack=function(){o.pop(),n>0&&--n},this.setElementByPos=function(e,t){if(e<0||e>=n)throw new Error("pos must more than 0 and less than vector's size");o[e]=t},this.insert=function(e,t,r){if(void 0===r&&(r=1),e<0||e>n)throw new Error("pos must more than 0 and less than or equal to vector's size");o.splice.apply(o,i([e,0],s(new Array(r).fill(t)),!1)),n+=r},this.find=function(e){return o.includes(e)},this.reverse=function(){o.reverse()},this.unique=function(){var e,t=[];this.forEach((function(n,r){0!==r&&n===e||(t.push(n),e=n)})),t.forEach((function(e,t){o[t]=e}));for(var r=t.length;n>r;)this.popBack()},this.sort=function(e){o.sort(e)},this[Symbol.iterator]=function(){return function(){return r(this,(function(e){switch(e.label){case 0:return[5,a(o)];case 1:return[2,e.sent()]}}))}()},e.forEach((function(e){return t.pushBack(e)})),Object.freeze(this)}Object.defineProperty(n,"__esModule",{value:!0}),Object.freeze(o),n.default=o},{}],36:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.HashMap=n.HashSet=n.Map=n.Set=n.PriorityQueue=n.Deque=n.LinkList=n.Queue=n.Stack=n.Vector=void 0;var r=e("./Vector/Vector");n.Vector=r.default;var s=e("./Stack/Stack");n.Stack=s.default;var i=e("./Queue/Queue");n.Queue=i.default;var a=e("./LinkList/LinkList");n.LinkList=a.default;var o=e("./Deque/Deque");n.Deque=o.default;var l=e("./PriorityQueue/PriorityQueue");n.PriorityQueue=l.default;var c=e("./Set/Set");n.Set=c.default;var d=e("./Map/Map");n.Map=d.default;var u=e("./HashSet/HashSet");n.HashSet=u.default;var h=e("./HashMap/HashMap");n.HashMap=h.default},{"./Deque/Deque":26,"./HashMap/HashMap":27,"./HashSet/HashSet":28,"./LinkList/LinkList":29,"./Map/Map":30,"./PriorityQueue/PriorityQueue":31,"./Queue/Queue":32,"./Set/Set":33,"./Stack/Stack":34,"./Vector/Vector":35}],37:[function(e,t,n){const r=e("yallist"),s=Symbol("max"),i=Symbol("length"),a=Symbol("lengthCalculator"),o=Symbol("allowStale"),l=Symbol("maxAge"),c=Symbol("dispose"),d=Symbol("noDisposeOnSet"),u=Symbol("lruList"),h=Symbol("cache"),f=Symbol("updateAgeOnGet"),p=()=>1;class g{constructor(e){if("number"==typeof e&&(e={max:e}),e||(e={}),e.max&&("number"!=typeof e.max||e.max<0))throw new TypeError("max must be a non-negative number");this[s]=e.max||1/0;const t=e.length||p;if(this[a]="function"!=typeof t?p:t,this[o]=e.stale||!1,e.maxAge&&"number"!=typeof e.maxAge)throw new TypeError("maxAge must be a number");this[l]=e.maxAge||0,this[c]=e.dispose,this[d]=e.noDisposeOnSet||!1,this[f]=e.updateAgeOnGet||!1,this.reset()}set max(e){if("number"!=typeof e||e<0)throw new TypeError("max must be a non-negative number");this[s]=e||1/0,v(this)}get max(){return this[s]}set allowStale(e){this[o]=!!e}get allowStale(){return this[o]}set maxAge(e){if("number"!=typeof e)throw new TypeError("maxAge must be a non-negative number");this[l]=e,v(this)}get maxAge(){return this[l]}set lengthCalculator(e){"function"!=typeof e&&(e=p),e!==this[a]&&(this[a]=e,this[i]=0,this[u].forEach((e=>{e.length=this[a](e.value,e.key),this[i]+=e.length}))),v(this)}get lengthCalculator(){return this[a]}get length(){return this[i]}get itemCount(){return this[u].length}rforEach(e,t){t=t||this;for(let n=this[u].tail;null!==n;){const r=n.prev;S(this,e,n,t),n=r}}forEach(e,t){t=t||this;for(let n=this[u].head;null!==n;){const r=n.next;S(this,e,n,t),n=r}}keys(){return this[u].toArray().map((e=>e.key))}values(){return this[u].toArray().map((e=>e.value))}reset(){this[c]&&this[u]&&this[u].length&&this[u].forEach((e=>this[c](e.key,e.value))),this[h]=new Map,this[u]=new r,this[i]=0}dump(){return this[u].map((e=>!y(this,e)&&{k:e.key,v:e.value,e:e.now+(e.maxAge||0)})).toArray().filter((e=>e))}dumpLru(){return this[u]}set(e,t,n){if((n=n||this[l])&&"number"!=typeof n)throw new TypeError("maxAge must be a number");const r=n?Date.now():0,o=this[a](t,e);if(this[h].has(e)){if(o>this[s])return b(this,this[h].get(e)),!1;const a=this[h].get(e).value;return this[c]&&(this[d]||this[c](e,a.value)),a.now=r,a.maxAge=n,a.value=t,this[i]+=o-a.length,a.length=o,this.get(e),v(this),!0}const f=new w(e,t,o,r,n);return f.length>this[s]?(this[c]&&this[c](e,t),!1):(this[i]+=f.length,this[u].unshift(f),this[h].set(e,this[u].head),v(this),!0)}has(e){if(!this[h].has(e))return!1;const t=this[h].get(e).value;return!y(this,t)}get(e){return m(this,e,!0)}peek(e){return m(this,e,!1)}pop(){const e=this[u].tail;return e?(b(this,e),e.value):null}del(e){b(this,this[h].get(e))}load(e){this.reset();const t=Date.now();for(let n=e.length-1;n>=0;n--){const r=e[n],s=r.e||0;if(0===s)this.set(r.k,r.v);else{const e=s-t;e>0&&this.set(r.k,r.v,e)}}}prune(){this[h].forEach(((e,t)=>m(this,t,!1)))}}const m=(e,t,n)=>{const r=e[h].get(t);if(r){const t=r.value;if(y(e,t)){if(b(e,r),!e[o])return}else n&&(e[f]&&(r.value.now=Date.now()),e[u].unshiftNode(r));return t.value}},y=(e,t)=>{if(!t||!t.maxAge&&!e[l])return!1;const n=Date.now()-t.now;return t.maxAge?n>t.maxAge:e[l]&&n>e[l]},v=e=>{if(e[i]>e[s])for(let t=e[u].tail;e[i]>e[s]&&null!==t;){const n=t.prev;b(e,t),t=n}},b=(e,t)=>{if(t){const n=t.value;e[c]&&e[c](n.key,n.value),e[i]-=n.length,e[h].delete(n.key),e[u].removeNode(t)}};class w{constructor(e,t,n,r,s){this.key=e,this.value=t,this.length=n,this.now=r,this.maxAge=s||0}}const S=(e,t,n,r)=>{let s=n.value;y(e,s)&&(b(e,n),e[o]||(s=void 0)),s&&t.call(r,s.value,s.key,e)};t.exports=g},{yallist:83}],38:[function(e,t,n){(function(e){(function(){const n=t.exports;n.types={0:"reserved",1:"connect",2:"connack",3:"publish",4:"puback",5:"pubrec",6:"pubrel",7:"pubcomp",8:"subscribe",9:"suback",10:"unsubscribe",11:"unsuback",12:"pingreq",13:"pingresp",14:"disconnect",15:"auth"},n.codes={};for(const e in n.types){const t=n.types[e];n.codes[t]=e}n.CMD_SHIFT=4,n.CMD_MASK=240,n.DUP_MASK=8,n.QOS_MASK=3,n.QOS_SHIFT=1,n.RETAIN_MASK=1,n.VARBYTEINT_MASK=127,n.VARBYTEINT_FIN_MASK=128,n.VARBYTEINT_MAX=268435455,n.SESSIONPRESENT_MASK=1,n.SESSIONPRESENT_HEADER=e.from([n.SESSIONPRESENT_MASK]),n.CONNACK_HEADER=e.from([n.codes.connack<<n.CMD_SHIFT]),n.USERNAME_MASK=128,n.PASSWORD_MASK=64,n.WILL_RETAIN_MASK=32,n.WILL_QOS_MASK=24,n.WILL_QOS_SHIFT=3,n.WILL_FLAG_MASK=4,n.CLEAN_SESSION_MASK=2,n.CONNECT_HEADER=e.from([n.codes.connect<<n.CMD_SHIFT]),n.properties={sessionExpiryInterval:17,willDelayInterval:24,receiveMaximum:33,maximumPacketSize:39,topicAliasMaximum:34,requestResponseInformation:25,requestProblemInformation:23,userProperties:38,authenticationMethod:21,authenticationData:22,payloadFormatIndicator:1,messageExpiryInterval:2,contentType:3,responseTopic:8,correlationData:9,maximumQoS:36,retainAvailable:37,assignedClientIdentifier:18,reasonString:31,wildcardSubscriptionAvailable:40,subscriptionIdentifiersAvailable:41,sharedSubscriptionAvailable:42,serverKeepAlive:19,responseInformation:26,serverReference:28,topicAlias:35,subscriptionIdentifier:11},n.propertiesCodes={};for(const e in n.properties){const t=n.properties[e];n.propertiesCodes[t]=e}function r(t){return[0,1,2].map((r=>[0,1].map((s=>[0,1].map((i=>{const a=e.alloc(1);return a.writeUInt8(n.codes[t]<<n.CMD_SHIFT|(s?n.DUP_MASK:0)|r<<n.QOS_SHIFT|i,0,!0),a}))))))}n.propertiesTypes={sessionExpiryInterval:"int32",willDelayInterval:"int32",receiveMaximum:"int16",maximumPacketSize:"int32",topicAliasMaximum:"int16",requestResponseInformation:"byte",requestProblemInformation:"byte",userProperties:"pair",authenticationMethod:"string",authenticationData:"binary",payloadFormatIndicator:"byte",messageExpiryInterval:"int32",contentType:"string",responseTopic:"string",correlationData:"binary",maximumQoS:"int8",retainAvailable:"byte",assignedClientIdentifier:"string",reasonString:"string",wildcardSubscriptionAvailable:"byte",subscriptionIdentifiersAvailable:"byte",sharedSubscriptionAvailable:"byte",serverKeepAlive:"int16",responseInformation:"string",serverReference:"string",topicAlias:"int16",subscriptionIdentifier:"var"},n.PUBLISH_HEADER=r("publish"),n.SUBSCRIBE_HEADER=r("subscribe"),n.SUBSCRIBE_OPTIONS_QOS_MASK=3,n.SUBSCRIBE_OPTIONS_NL_MASK=1,n.SUBSCRIBE_OPTIONS_NL_SHIFT=2,n.SUBSCRIBE_OPTIONS_RAP_MASK=1,n.SUBSCRIBE_OPTIONS_RAP_SHIFT=3,n.SUBSCRIBE_OPTIONS_RH_MASK=3,n.SUBSCRIBE_OPTIONS_RH_SHIFT=4,n.SUBSCRIBE_OPTIONS_RH=[0,16,32],n.SUBSCRIBE_OPTIONS_NL=4,n.SUBSCRIBE_OPTIONS_RAP=8,n.SUBSCRIBE_OPTIONS_QOS=[0,1,2],n.UNSUBSCRIBE_HEADER=r("unsubscribe"),n.ACKS={unsuback:r("unsuback"),puback:r("puback"),pubcomp:r("pubcomp"),pubrel:r("pubrel"),pubrec:r("pubrec")},n.SUBACK_HEADER=e.from([n.codes.suback<<n.CMD_SHIFT]),n.VERSION3=e.from([3]),n.VERSION4=e.from([4]),n.VERSION5=e.from([5]),n.VERSION131=e.from([131]),n.VERSION132=e.from([132]),n.QOS=[0,1,2].map((t=>e.from([t]))),n.EMPTY={pingreq:e.from([n.codes.pingreq<<4,0]),pingresp:e.from([n.codes.pingresp<<4,0]),disconnect:e.from([n.codes.disconnect<<4,0])}}).call(this)}).call(this,e("buffer").Buffer)},{buffer:17}],39:[function(e,t,n){(function(n){(function(){const r=e("./writeToStream"),s=e("events");function i(e,t){const n=new a;return r(e,n,t),n.concat()}class a extends s{constructor(){super(),this._array=new Array(20),this._i=0}write(e){return this._array[this._i++]=e,!0}concat(){let e=0;const t=new Array(this._array.length),r=this._array;let s,i=0;for(s=0;s<r.length&&void 0!==r[s];s++)"string"!=typeof r[s]?t[s]=r[s].length:t[s]=n.byteLength(r[s]),e+=t[s];const a=n.allocUnsafe(e);for(s=0;s<r.length&&void 0!==r[s];s++)"string"!=typeof r[s]?(r[s].copy(a,i),i+=t[s]):(a.write(r[s],i),i+=t[s]);return a}}t.exports=i}).call(this)}).call(this,e("buffer").Buffer)},{"./writeToStream":44,buffer:17,events:22}],40:[function(e,t,n){n.parser=e("./parser").parser,n.generate=e("./generate"),n.writeToStream=e("./writeToStream")},{"./generate":39,"./parser":43,"./writeToStream":44}],41:[function(e,t,n){(function(e){(function(){const n=65536,r={},s=e.isBuffer(e.from([1,2]).subarray(0,1));function i(t){const n=e.allocUnsafe(2);return n.writeUInt8(t>>8,0),n.writeUInt8(255&t,1),n}function a(){for(let e=0;e<n;e++)r[e]=i(e)}function o(t){const n=4;let r=0,i=0;const a=e.allocUnsafe(n);do{r=t%128|0,(t=t/128|0)>0&&(r|=128),a.writeUInt8(r,i++)}while(t>0&&i<n);return t>0&&(i=0),s?a.subarray(0,i):a.slice(0,i)}function l(t){const n=e.allocUnsafe(4);return n.writeUInt32BE(t,0),n}t.exports={cache:r,generateCache:a,generateNumber:i,genBufVariableByteInt:o,generate4ByteBuffer:l}}).call(this)}).call(this,e("buffer").Buffer)},{buffer:17}],42:[function(e,t,n){class r{constructor(){this.cmd=null,this.retain=!1,this.qos=0,this.dup=!1,this.length=-1,this.topic=null,this.payload=null}}t.exports=r},{}],43:[function(e,t,n){const r=e("bl"),s=e("events"),i=e("./packet"),a=e("./constants"),o=e("debug")("mqtt-packet:parser");class l extends s{constructor(){super(),this.parser=this.constructor.parser}static parser(e){return this instanceof l?(this.settings=e||{},this._states=["_parseHeader","_parseLength","_parsePayload","_newPacket"],this._resetState(),this):(new l).parser(e)}_resetState(){o("_resetState: resetting packet, error, _list, and _stateCounter"),this.packet=new i,this.error=null,this._list=r(),this._stateCounter=0}parse(e){for(this.error&&this._resetState(),this._list.append(e),o("parse: current state: %s",this._states[this._stateCounter]);(-1!==this.packet.length||this._list.length>0)&&this[this._states[this._stateCounter]]()&&!this.error;)this._stateCounter++,o("parse: state complete. _stateCounter is now: %d",this._stateCounter),o("parse: packet.length: %d, buffer list length: %d",this.packet.length,this._list.length),this._stateCounter>=this._states.length&&(this._stateCounter=0);return o("parse: exited while loop. packet: %d, buffer list length: %d",this.packet.length,this._list.length),this._list.length}_parseHeader(){const e=this._list.readUInt8(0);return this.packet.cmd=a.types[e>>a.CMD_SHIFT],this.packet.retain=0!=(e&a.RETAIN_MASK),this.packet.qos=e>>a.QOS_SHIFT&a.QOS_MASK,this.packet.dup=0!=(e&a.DUP_MASK),o("_parseHeader: packet: %o",this.packet),this._list.consume(1),!0}_parseLength(){const e=this._parseVarByteNum(!0);return e&&(this.packet.length=e.value,this._list.consume(e.bytes)),o("_parseLength %d",e.value),!!e}_parsePayload(){o("_parsePayload: payload %O",this._list);let e=!1;if(0===this.packet.length||this._list.length>=this.packet.length){switch(this._pos=0,this.packet.cmd){case"connect":this._parseConnect();break;case"connack":this._parseConnack();break;case"publish":this._parsePublish();break;case"puback":case"pubrec":case"pubrel":case"pubcomp":this._parseConfirmation();break;case"subscribe":this._parseSubscribe();break;case"suback":this._parseSuback();break;case"unsubscribe":this._parseUnsubscribe();break;case"unsuback":this._parseUnsuback();break;case"pingreq":case"pingresp":break;case"disconnect":this._parseDisconnect();break;case"auth":this._parseAuth();break;default:this._emitError(new Error("Not supported"))}e=!0}return o("_parsePayload complete result: %s",e),e}_parseConnect(){let e,t,n,r;o("_parseConnect");const s={},i=this.packet,l=this._parseString();if(null===l)return this._emitError(new Error("Cannot parse protocolId"));if("MQTT"!==l&&"MQIsdp"!==l)return this._emitError(new Error("Invalid protocolId"));if(i.protocolId=l,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(i.protocolVersion=this._list.readUInt8(this._pos),i.protocolVersion>=128&&(i.bridgeMode=!0,i.protocolVersion=i.protocolVersion-128),3!==i.protocolVersion&&4!==i.protocolVersion&&5!==i.protocolVersion)return this._emitError(new Error("Invalid protocol version"));if(this._pos++,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(s.username=this._list.readUInt8(this._pos)&a.USERNAME_MASK,s.password=this._list.readUInt8(this._pos)&a.PASSWORD_MASK,s.will=this._list.readUInt8(this._pos)&a.WILL_FLAG_MASK,s.will&&(i.will={},i.will.retain=0!=(this._list.readUInt8(this._pos)&a.WILL_RETAIN_MASK),i.will.qos=(this._list.readUInt8(this._pos)&a.WILL_QOS_MASK)>>a.WILL_QOS_SHIFT),i.clean=0!=(this._list.readUInt8(this._pos)&a.CLEAN_SESSION_MASK),this._pos++,i.keepalive=this._parseNum(),-1===i.keepalive)return this._emitError(new Error("Packet too short"));if(5===i.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(i.properties=e)}const c=this._parseString();if(null===c)return this._emitError(new Error("Packet too short"));if(i.clientId=c,o("_parseConnect: packet.clientId: %s",i.clientId),s.will){if(5===i.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(i.will.properties=e)}if(e=this._parseString(),null===e)return this._emitError(new Error("Cannot parse will topic"));if(i.will.topic=e,o("_parseConnect: packet.will.topic: %s",i.will.topic),t=this._parseBuffer(),null===t)return this._emitError(new Error("Cannot parse will payload"));i.will.payload=t,o("_parseConnect: packet.will.paylaod: %s",i.will.payload)}if(s.username){if(r=this._parseString(),null===r)return this._emitError(new Error("Cannot parse username"));i.username=r,o("_parseConnect: packet.username: %s",i.username)}if(s.password){if(n=this._parseBuffer(),null===n)return this._emitError(new Error("Cannot parse password"));i.password=n}return this.settings=i,o("_parseConnect: complete"),i}_parseConnack(){o("_parseConnack");const e=this.packet;if(this._list.length<1)return null;if(e.sessionPresent=!!(this._list.readUInt8(this._pos++)&a.SESSIONPRESENT_MASK),5===this.settings.protocolVersion)this._list.length>=2?e.reasonCode=this._list.readUInt8(this._pos++):e.reasonCode=0;else{if(this._list.length<2)return null;e.returnCode=this._list.readUInt8(this._pos++)}if(-1===e.returnCode||-1===e.reasonCode)return this._emitError(new Error("Cannot parse return code"));if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}o("_parseConnack: complete")}_parsePublish(){o("_parsePublish");const e=this.packet;if(e.topic=this._parseString(),null===e.topic)return this._emitError(new Error("Cannot parse topic"));if(!(e.qos>0)||this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}e.payload=this._list.slice(this._pos,e.length),o("_parsePublish: payload from buffer list: %o",e.payload)}}_parseSubscribe(){o("_parseSubscribe");const e=this.packet;let t,n,r,s,i,l,c;if(1!==e.qos)return this._emitError(new Error("Wrong subscribe header"));if(e.subscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}for(;this._pos<e.length;){if(t=this._parseString(),null===t)return this._emitError(new Error("Cannot parse topic"));if(this._pos>=e.length)return this._emitError(new Error("Malformed Subscribe Payload"));n=this._parseByte(),r=n&a.SUBSCRIBE_OPTIONS_QOS_MASK,l=0!=(n>>a.SUBSCRIBE_OPTIONS_NL_SHIFT&a.SUBSCRIBE_OPTIONS_NL_MASK),i=0!=(n>>a.SUBSCRIBE_OPTIONS_RAP_SHIFT&a.SUBSCRIBE_OPTIONS_RAP_MASK),s=n>>a.SUBSCRIBE_OPTIONS_RH_SHIFT&a.SUBSCRIBE_OPTIONS_RH_MASK,c={topic:t,qos:r},5===this.settings.protocolVersion?(c.nl=l,c.rap=i,c.rh=s):this.settings.bridgeMode&&(c.rh=0,c.rap=!0,c.nl=!0),o("_parseSubscribe: push subscription `%s` to subscription",c),e.subscriptions.push(c)}}}_parseSuback(){o("_parseSuback");const e=this.packet;if(this.packet.granted=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}for(;this._pos<this.packet.length;)this.packet.granted.push(this._list.readUInt8(this._pos++))}}_parseUnsubscribe(){o("_parseUnsubscribe");const e=this.packet;if(e.unsubscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}for(;this._pos<e.length;){const t=this._parseString();if(null===t)return this._emitError(new Error("Cannot parse topic"));o("_parseUnsubscribe: push topic `%s` to unsubscriptions",t),e.unsubscriptions.push(t)}}}_parseUnsuback(){o("_parseUnsuback");const e=this.packet;if(!this._parseMessageId())return this._emitError(new Error("Cannot parse messageId"));if(5===this.settings.protocolVersion){const t=this._parseProperties();for(Object.getOwnPropertyNames(t).length&&(e.properties=t),e.granted=[];this._pos<this.packet.length;)this.packet.granted.push(this._list.readUInt8(this._pos++))}}_parseConfirmation(){o("_parseConfirmation: packet.cmd: `%s`",this.packet.cmd);const e=this.packet;if(this._parseMessageId(),5===this.settings.protocolVersion&&(e.length>2?(e.reasonCode=this._parseByte(),o("_parseConfirmation: packet.reasonCode `%d`",e.reasonCode)):e.reasonCode=0,e.length>3)){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}return!0}_parseDisconnect(){const e=this.packet;if(o("_parseDisconnect"),5===this.settings.protocolVersion){this._list.length>0?e.reasonCode=this._parseByte():e.reasonCode=0;const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}return o("_parseDisconnect result: true"),!0}_parseAuth(){o("_parseAuth");const e=this.packet;if(5!==this.settings.protocolVersion)return this._emitError(new Error("Not supported auth packet for this version MQTT"));e.reasonCode=this._parseByte();const t=this._parseProperties();return Object.getOwnPropertyNames(t).length&&(e.properties=t),o("_parseAuth: result: true"),!0}_parseMessageId(){const e=this.packet;return e.messageId=this._parseNum(),null===e.messageId?(this._emitError(new Error("Cannot parse messageId")),!1):(o("_parseMessageId: packet.messageId %d",e.messageId),!0)}_parseString(e){const t=this._parseNum(),n=t+this._pos;if(-1===t||n>this._list.length||n>this.packet.length)return null;const r=this._list.toString("utf8",this._pos,n);return this._pos+=t,o("_parseString: result: %s",r),r}_parseStringPair(){return o("_parseStringPair"),{name:this._parseString(),value:this._parseString()}}_parseBuffer(){const e=this._parseNum(),t=e+this._pos;if(-1===e||t>this._list.length||t>this.packet.length)return null;const n=this._list.slice(this._pos,t);return this._pos+=e,o("_parseBuffer: result: %o",n),n}_parseNum(){if(this._list.length-this._pos<2)return-1;const e=this._list.readUInt16BE(this._pos);return this._pos+=2,o("_parseNum: result: %s",e),e}_parse4ByteNum(){if(this._list.length-this._pos<4)return-1;const e=this._list.readUInt32BE(this._pos);return this._pos+=4,o("_parse4ByteNum: result: %s",e),e}_parseVarByteNum(e){o("_parseVarByteNum");const t=4;let n,r=0,s=1,i=0,l=!1;const c=this._pos?this._pos:0;for(;r<t&&c+r<this._list.length;){if(n=this._list.readUInt8(c+r++),i+=s*(n&a.VARBYTEINT_MASK),s*=128,0==(n&a.VARBYTEINT_FIN_MASK)){l=!0;break}if(this._list.length<=r)break}return!l&&r===t&&this._list.length>=r&&this._emitError(new Error("Invalid variable byte integer")),c&&(this._pos+=r),l=!!l&&(e?{bytes:r,value:i}:i),o("_parseVarByteNum: result: %o",l),l}_parseByte(){let e;return this._pos<this._list.length&&(e=this._list.readUInt8(this._pos),this._pos++),o("_parseByte: result: %o",e),e}_parseByType(e){switch(o("_parseByType: type: %s",e),e){case"byte":return 0!==this._parseByte();case"int8":return this._parseByte();case"int16":return this._parseNum();case"int32":return this._parse4ByteNum();case"var":return this._parseVarByteNum();case"string":return this._parseString();case"pair":return this._parseStringPair();case"binary":return this._parseBuffer()}}_parseProperties(){o("_parseProperties");const e=this._parseVarByteNum(),t=this._pos+e,n={};for(;this._pos<t;){const e=this._parseByte();if(!e)return this._emitError(new Error("Cannot parse property code type")),!1;const t=a.propertiesCodes[e];if(!t)return this._emitError(new Error("Unknown property")),!1;if("userProperties"!==t)n[t]?(Array.isArray(n[t])||(n[t]=[n[t]]),n[t].push(this._parseByType(a.propertiesTypes[t]))):n[t]=this._parseByType(a.propertiesTypes[t]);else{n[t]||(n[t]=Object.create(null));const e=this._parseByType(a.propertiesTypes[t]);if(n[t][e.name])if(Array.isArray(n[t][e.name]))n[t][e.name].push(e.value);else{const r=n[t][e.name];n[t][e.name]=[r],n[t][e.name].push(e.value)}else n[t][e.name]=e.value}}return n}_newPacket(){return o("_newPacket"),this.packet&&(this._list.consume(this.packet.length),o("_newPacket: parser emit packet: packet.cmd: %s, packet.payload: %s, packet.length: %d",this.packet.cmd,this.packet.payload,this.packet.length),this.emit("packet",this.packet)),o("_newPacket: new packet"),this.packet=new i,this._pos=0,!0}_emitError(e){o("_emitError"),this.error=e,this.emit("error",e)}}t.exports=l},{"./constants":38,"./packet":42,bl:15,debug:18,events:22}],44:[function(e,t,n){(function(n){(function(){const r=e("./constants"),s=n.allocUnsafe(0),i=n.from([0]),a=e("./numbers"),o=e("process-nextick-args").nextTick,l=e("debug")("mqtt-packet:writeToStream"),c=a.cache,d=a.generateNumber,u=a.generateCache,h=a.genBufVariableByteInt,f=a.generate4ByteBuffer;let p=x,g=!0;function m(e,t,n){switch(l("generate called"),t.cork&&(t.cork(),o(y,t)),g&&(g=!1,u()),l("generate: packet.cmd: %s",e.cmd),e.cmd){case"connect":return v(e,t);case"connack":return b(e,t,n);case"publish":return w(e,t,n);case"puback":case"pubrec":case"pubrel":case"pubcomp":return S(e,t,n);case"subscribe":return C(e,t,n);case"suback":return T(e,t,n);case"unsubscribe":return E(e,t,n);case"unsuback":return I(e,t,n);case"pingreq":case"pingresp":return k(e,t);case"disconnect":return A(e,t,n);case"auth":return _(e,t,n);default:return t.emit("error",new Error("Unknown command")),!1}}function y(e){e.uncork()}function v(e,t,s){const i=e||{},a=i.protocolId||"MQTT";let o=i.protocolVersion||4;const l=i.will;let c=i.clean;const d=i.keepalive||0,u=i.clientId||"",h=i.username,f=i.password,g=i.properties;void 0===c&&(c=!0);let m=0;if(!a||"string"!=typeof a&&!n.isBuffer(a))return t.emit("error",new Error("Invalid protocolId")),!1;if(m+=a.length+2,3!==o&&4!==o&&5!==o)return t.emit("error",new Error("Invalid protocol version")),!1;if(m+=1,("string"==typeof u||n.isBuffer(u))&&(u||o>=4)&&(u||c))m+=n.byteLength(u)+2;else{if(o<4)return t.emit("error",new Error("clientId must be supplied before 3.1.1")),!1;if(1*c==0)return t.emit("error",new Error("clientId must be given if cleanSession set to 0")),!1}if("number"!=typeof d||d<0||d>65535||d%1!=0)return t.emit("error",new Error("Invalid keepalive")),!1;if(m+=2,m+=1,5===o){var y=U(t,g);if(!y)return!1;m+=y.length}if(l){if("object"!=typeof l)return t.emit("error",new Error("Invalid will")),!1;if(!l.topic||"string"!=typeof l.topic)return t.emit("error",new Error("Invalid will topic")),!1;if(m+=n.byteLength(l.topic)+2,m+=2,l.payload){if(!(l.payload.length>=0))return t.emit("error",new Error("Invalid will payload")),!1;"string"==typeof l.payload?m+=n.byteLength(l.payload):m+=l.payload.length}var v={};if(5===o){if(!(v=U(t,l.properties)))return!1;m+=v.length}}let b=!1;if(null!=h){if(!q(h))return t.emit("error",new Error("Invalid username")),!1;b=!0,m+=n.byteLength(h)+2}if(null!=f){if(!b)return t.emit("error",new Error("Username is required to use password")),!1;if(!q(f))return t.emit("error",new Error("Invalid password")),!1;m+=$(f)+2}t.write(r.CONNECT_HEADER),O(t,m),F(t,a),i.bridgeMode&&(o+=128),t.write(131===o?r.VERSION131:132===o?r.VERSION132:4===o?r.VERSION4:5===o?r.VERSION5:r.VERSION3);let w=0;return w|=null!=h?r.USERNAME_MASK:0,w|=null!=f?r.PASSWORD_MASK:0,w|=l&&l.retain?r.WILL_RETAIN_MASK:0,w|=l&&l.qos?l.qos<<r.WILL_QOS_SHIFT:0,w|=l?r.WILL_FLAG_MASK:0,w|=c?r.CLEAN_SESSION_MASK:0,t.write(n.from([w])),p(t,d),5===o&&y.write(),F(t,u),l&&(5===o&&v.write(),L(t,l.topic),F(t,l.payload)),null!=h&&F(t,h),null!=f&&F(t,f),!0}function b(e,t,s){const a=s?s.protocolVersion:4,o=e||{},l=5===a?o.reasonCode:o.returnCode,c=o.properties;let d=2;if("number"!=typeof l)return t.emit("error",new Error("Invalid return code")),!1;let u=null;if(5===a){if(u=U(t,c),!u)return!1;d+=u.length}return t.write(r.CONNACK_HEADER),O(t,d),t.write(o.sessionPresent?r.SESSIONPRESENT_HEADER:i),t.write(n.from([l])),null!=u&&u.write(),!0}function w(e,t,i){l("publish: packet: %o",e);const a=i?i.protocolVersion:4,o=e||{},c=o.qos||0,d=o.retain?r.RETAIN_MASK:0,u=o.topic,h=o.payload||s,f=o.messageId,g=o.properties;let m=0;if("string"==typeof u)m+=n.byteLength(u)+2;else{if(!n.isBuffer(u))return t.emit("error",new Error("Invalid topic")),!1;m+=u.length+2}if(n.isBuffer(h)?m+=h.length:m+=n.byteLength(h),c&&"number"!=typeof f)return t.emit("error",new Error("Invalid messageId")),!1;c&&(m+=2);let y=null;if(5===a){if(y=U(t,g),!y)return!1;m+=y.length}return t.write(r.PUBLISH_HEADER[c][o.dup?1:0][d?1:0]),O(t,m),p(t,$(u)),t.write(u),c>0&&p(t,f),null!=y&&y.write(),l("publish: payload: %o",h),t.write(h)}function S(e,t,s){const i=s?s.protocolVersion:4,a=e||{},o=a.cmd||"puback",l=a.messageId,c=a.dup&&"pubrel"===o?r.DUP_MASK:0;let d=0;const u=a.reasonCode,h=a.properties;let f=5===i?3:2;if("pubrel"===o&&(d=1),"number"!=typeof l)return t.emit("error",new Error("Invalid messageId")),!1;let g=null;if(5===i&&"object"==typeof h){if(g=N(t,h,s,f),!g)return!1;f+=g.length}return t.write(r.ACKS[o][d][c][0]),O(t,f),p(t,l),5===i&&t.write(n.from([u])),null!==g&&g.write(),!0}function C(e,t,s){l("subscribe: packet: ");const i=s?s.protocolVersion:4,a=e||{},o=a.dup?r.DUP_MASK:0,c=a.messageId,d=a.subscriptions,u=a.properties;let h=0;if("number"!=typeof c)return t.emit("error",new Error("Invalid messageId")),!1;h+=2;let f=null;if(5===i){if(f=U(t,u),!f)return!1;h+=f.length}if("object"!=typeof d||!d.length)return t.emit("error",new Error("Invalid subscriptions")),!1;for(let e=0;e<d.length;e+=1){const r=d[e].topic,s=d[e].qos;if("string"!=typeof r)return t.emit("error",new Error("Invalid subscriptions - invalid topic")),!1;if("number"!=typeof s)return t.emit("error",new Error("Invalid subscriptions - invalid qos")),!1;if(5===i){if("boolean"!=typeof(d[e].nl||!1))return t.emit("error",new Error("Invalid subscriptions - invalid No Local")),!1;if("boolean"!=typeof(d[e].rap||!1))return t.emit("error",new Error("Invalid subscriptions - invalid Retain as Published")),!1;const n=d[e].rh||0;if("number"!=typeof n||n>2)return t.emit("error",new Error("Invalid subscriptions - invalid Retain Handling")),!1}h+=n.byteLength(r)+2+1}l("subscribe: writing to stream: %o",r.SUBSCRIBE_HEADER),t.write(r.SUBSCRIBE_HEADER[1][o?1:0][0]),O(t,h),p(t,c),null!==f&&f.write();let g=!0;for(const e of d){const s=e.topic,a=e.qos,o=+e.nl,l=+e.rap,c=e.rh;let d;L(t,s),d=r.SUBSCRIBE_OPTIONS_QOS[a],5===i&&(d|=o?r.SUBSCRIBE_OPTIONS_NL:0,d|=l?r.SUBSCRIBE_OPTIONS_RAP:0,d|=c?r.SUBSCRIBE_OPTIONS_RH[c]:0),g=t.write(n.from([d]))}return g}function T(e,t,s){const i=s?s.protocolVersion:4,a=e||{},o=a.messageId,l=a.granted,c=a.properties;let d=0;if("number"!=typeof o)return t.emit("error",new Error("Invalid messageId")),!1;if(d+=2,"object"!=typeof l||!l.length)return t.emit("error",new Error("Invalid qos vector")),!1;for(let e=0;e<l.length;e+=1){if("number"!=typeof l[e])return t.emit("error",new Error("Invalid qos vector")),!1;d+=1}let u=null;if(5===i){if(u=N(t,c,s,d),!u)return!1;d+=u.length}return t.write(r.SUBACK_HEADER),O(t,d),p(t,o),null!==u&&u.write(),t.write(n.from(l))}function E(e,t,s){const i=s?s.protocolVersion:4,a=e||{},o=a.messageId,l=a.dup?r.DUP_MASK:0,c=a.unsubscriptions,d=a.properties;let u=0;if("number"!=typeof o)return t.emit("error",new Error("Invalid messageId")),!1;if(u+=2,"object"!=typeof c||!c.length)return t.emit("error",new Error("Invalid unsubscriptions")),!1;for(let e=0;e<c.length;e+=1){if("string"!=typeof c[e])return t.emit("error",new Error("Invalid unsubscriptions")),!1;u+=n.byteLength(c[e])+2}let h=null;if(5===i){if(h=U(t,d),!h)return!1;u+=h.length}t.write(r.UNSUBSCRIBE_HEADER[1][l?1:0][0]),O(t,u),p(t,o),null!==h&&h.write();let f=!0;for(let e=0;e<c.length;e++)f=L(t,c[e]);return f}function I(e,t,s){const i=s?s.protocolVersion:4,a=e||{},o=a.messageId,l=a.dup?r.DUP_MASK:0,c=a.granted,d=a.properties,u=a.cmd,h=0;let f=2;if("number"!=typeof o)return t.emit("error",new Error("Invalid messageId")),!1;if(5===i){if("object"!=typeof c||!c.length)return t.emit("error",new Error("Invalid qos vector")),!1;for(let e=0;e<c.length;e+=1){if("number"!=typeof c[e])return t.emit("error",new Error("Invalid qos vector")),!1;f+=1}}let g=null;if(5===i){if(g=N(t,d,s,f),!g)return!1;f+=g.length}return t.write(r.ACKS[u][h][l][0]),O(t,f),p(t,o),null!==g&&g.write(),5===i&&t.write(n.from(c)),!0}function k(e,t,n){return t.write(r.EMPTY[e.cmd])}function A(e,t,s){const i=s?s.protocolVersion:4,a=e||{},o=a.reasonCode,l=a.properties;let c=5===i?1:0,d=null;if(5===i){if(d=N(t,l,s,c),!d)return!1;c+=d.length}return t.write(n.from([r.codes.disconnect<<4])),O(t,c),5===i&&t.write(n.from([o])),null!==d&&d.write(),!0}function _(e,t,s){const i=s?s.protocolVersion:4,a=e||{},o=a.reasonCode,l=a.properties;let c=5===i?1:0;5!==i&&t.emit("error",new Error("Invalid mqtt version for auth packet"));const d=N(t,l,s,c);return!!d&&(c+=d.length,t.write(n.from([r.codes.auth<<4])),O(t,c),t.write(n.from([o])),null!==d&&d.write(),!0)}Object.defineProperty(m,"cacheNumbers",{get:()=>p===x,set(e){e?(c&&0!==Object.keys(c).length||(g=!0),p=x):(g=!1,p=P)}});const R={};function O(e,t){if(t>r.VARBYTEINT_MAX)return e.emit("error",new Error(`Invalid variable byte integer: ${t}`)),!1;let n=R[t];return n||(n=h(t),t<16384&&(R[t]=n)),l("writeVarByteInt: writing to stream: %o",n),e.write(n)}function L(e,t){const r=n.byteLength(t);return p(e,r),l("writeString: %s",t),e.write(t,"utf8")}function D(e,t,n){L(e,t),L(e,n)}function x(e,t){return l("writeNumberCached: number: %d",t),l("writeNumberCached: %o",c[t]),e.write(c[t])}function P(e,t){const n=d(t);return l("writeNumberGenerated: %o",n),e.write(n)}function M(e,t){const n=f(t);return l("write4ByteNumber: %o",n),e.write(n)}function F(e,t){"string"==typeof t?L(e,t):t?(p(e,t.length),e.write(t)):p(e,0)}function U(e,t){if("object"!=typeof t||null!=t.length)return{length:1,write(){j(e,{},0)}};let s=0;function i(t,s){let i=0;switch(r.propertiesTypes[t]){case"byte":if("boolean"!=typeof s)return e.emit("error",new Error(`Invalid ${t}: ${s}`)),!1;i+=2;break;case"int8":if("number"!=typeof s||s<0||s>255)return e.emit("error",new Error(`Invalid ${t}: ${s}`)),!1;i+=2;break;case"binary":if(s&&null===s)return e.emit("error",new Error(`Invalid ${t}: ${s}`)),!1;i+=1+n.byteLength(s)+2;break;case"int16":if("number"!=typeof s||s<0||s>65535)return e.emit("error",new Error(`Invalid ${t}: ${s}`)),!1;i+=3;break;case"int32":if("number"!=typeof s||s<0||s>4294967295)return e.emit("error",new Error(`Invalid ${t}: ${s}`)),!1;i+=5;break;case"var":if("number"!=typeof s||s<0||s>268435455)return e.emit("error",new Error(`Invalid ${t}: ${s}`)),!1;i+=1+n.byteLength(h(s));break;case"string":if("string"!=typeof s)return e.emit("error",new Error(`Invalid ${t}: ${s}`)),!1;i+=3+n.byteLength(s.toString());break;case"pair":if("object"!=typeof s)return e.emit("error",new Error(`Invalid ${t}: ${s}`)),!1;i+=Object.getOwnPropertyNames(s).reduce(((e,t)=>{const r=s[t];return Array.isArray(r)?e+=r.reduce(((e,r)=>e+=3+n.byteLength(t.toString())+2+n.byteLength(r.toString())),0):e+=3+n.byteLength(t.toString())+2+n.byteLength(s[t].toString()),e}),0);break;default:return e.emit("error",new Error(`Invalid property ${t}: ${s}`)),!1}return i}if(t)for(const e in t){let n=0,r=0;const a=t[e];if(Array.isArray(a))for(let t=0;t<a.length;t++){if(r=i(e,a[t]),!r)return!1;n+=r}else{if(r=i(e,a),!r)return!1;n=r}if(!n)return!1;s+=n}return{length:n.byteLength(h(s))+s,write(){j(e,t,s)}}}function N(e,t,n,r){const s=["reasonString","userProperties"],i=n&&n.properties&&n.properties.maximumPacketSize?n.properties.maximumPacketSize:0;let a=U(e,t);if(i)for(;r+a.length>i;){const n=s.shift();if(!n||!t[n])return!1;delete t[n],a=U(e,t)}return a}function B(e,t,s){switch(r.propertiesTypes[t]){case"byte":e.write(n.from([r.properties[t]])),e.write(n.from([+s]));break;case"int8":e.write(n.from([r.properties[t]])),e.write(n.from([s]));break;case"binary":e.write(n.from([r.properties[t]])),F(e,s);break;case"int16":e.write(n.from([r.properties[t]])),p(e,s);break;case"int32":e.write(n.from([r.properties[t]])),M(e,s);break;case"var":e.write(n.from([r.properties[t]])),O(e,s);break;case"string":e.write(n.from([r.properties[t]])),L(e,s);break;case"pair":Object.getOwnPropertyNames(s).forEach((i=>{const a=s[i];Array.isArray(a)?a.forEach((s=>{e.write(n.from([r.properties[t]])),D(e,i.toString(),s.toString())})):(e.write(n.from([r.properties[t]])),D(e,i.toString(),a.toString()))}));break;default:return e.emit("error",new Error(`Invalid property ${t} value: ${s}`)),!1}}function j(e,t,n){O(e,n);for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&null!==t[n]){const r=t[n];if(Array.isArray(r))for(let t=0;t<r.length;t++)B(e,n,r[t]);else B(e,n,r)}}function $(e){return e?e instanceof n?e.length:n.byteLength(e):0}function q(e){return"string"==typeof e||e instanceof n}t.exports=m}).call(this)}).call(this,e("buffer").Buffer)},{"./constants":38,"./numbers":41,buffer:17,debug:18,"process-nextick-args":49}],45:[function(e,t,n){var r=1e3,s=60*r,i=60*s,a=24*i,o=7*a,l=365.25*a;function c(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*l;case"weeks":case"week":case"w":return n*o;case"days":case"day":case"d":return n*a;case"hours":case"hour":case"hrs":case"hr":case"h":return n*i;case"minutes":case"minute":case"mins":case"min":case"m":return n*s;case"seconds":case"second":case"secs":case"sec":case"s":return n*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}}}function d(e){var t=Math.abs(e);return t>=a?Math.round(e/a)+"d":t>=i?Math.round(e/i)+"h":t>=s?Math.round(e/s)+"m":t>=r?Math.round(e/r)+"s":e+"ms"}function u(e){var t=Math.abs(e);return t>=a?h(e,t,a,"day"):t>=i?h(e,t,i,"hour"):t>=s?h(e,t,s,"minute"):t>=r?h(e,t,r,"second"):e+" ms"}function h(e,t,n,r){var s=t>=1.5*n;return Math.round(e/n)+" "+r+(s?"s":"")}t.exports=function(e,t){t=t||{};var n=typeof e;if("string"===n&&e.length>0)return c(e);if("number"===n&&isFinite(e))return t.long?u(e):d(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},{}],46:[function(e,t,n){const r=e("./lib/number-allocator.js");t.exports.NumberAllocator=r},{"./lib/number-allocator.js":47}],47:[function(e,t,n){const r=e("js-sdsl").Set,s=e("debug")("number-allocator:trace"),i=e("debug")("number-allocator:error");function a(e,t){this.low=e,this.high=t}function o(e,t){if(!(this instanceof o))return new o(e,t);this.min=e,this.max=t,this.ss=new r([],((e,t)=>e.compare(t))),s("Create"),this.clear()}a.prototype.equals=function(e){return this.low===e.low&&this.high===e.high},a.prototype.compare=function(e){return this.low<e.low&&this.high<e.low?-1:e.low<this.low&&e.high<this.low?1:0},o.prototype.firstVacant=function(){return 0===this.ss.size()?null:this.ss.front().low},o.prototype.alloc=function(){if(0===this.ss.size())return s("alloc():empty"),null;const e=this.ss.front(),t=e.low;return t+1<=e.high?++e.low:this.ss.eraseElementByPos(0),s("alloc():"+t),t},o.prototype.use=function(e){const t=new a(e,e),n=this.ss.lowerBound(t);if(n){if(n.equals(t))return this.ss.eraseElementByValue(n),s("use():"+e),!0;if(n.low>e)return!1;if(n.low===e)return++n.low,s("use():"+e),!0;if(n.high===e)return--n.high,s("use():"+e),!0;const r=n.low;return n.low=e+1,this.ss.insert(new a(r,e-1)),s("use():"+e),!0}return s("use():failed"),!1},o.prototype.free=function(e){if(e<this.min||e>this.max)return void i("free():"+e+" is out of range");const t=new a(e,e),n=this.ss.lowerBound(t);if(n){if(n.low<=e&&e<=n.high)return void i("free():"+e+" has already been vacant");if(n===this.ss.front())e+1===n.low?--n.low:this.ss.insert(t);else{const r=this.ss.reverseLowerBound(t);r.high+1===e?e+1===n.low?(this.ss.eraseElementByValue(r),n.low=r.low):r.high=e:e+1===n.low?n.low=e:this.ss.insert(t)}}else{if(n===this.ss.front())return void this.ss.insert(t);const r=this.ss.reverseLowerBound(t);r.high+1===e?r.high=e:this.ss.insert(t)}s("free():"+e)},o.prototype.clear=function(){s("clear()"),this.ss.clear(),this.ss.insert(new a(this.min,this.max))},o.prototype.intervalCount=function(){return this.ss.size()},o.prototype.dump=function(){console.log("length:"+this.ss.size());for(const e of this.ss)console.log(e)},t.exports=o},{debug:18,"js-sdsl":36}],48:[function(e,t,n){var r=e("wrappy");function s(e){var t=function(){return t.called?t.value:(t.called=!0,t.value=e.apply(this,arguments))};return t.called=!1,t}function i(e){var t=function(){if(t.called)throw new Error(t.onceError);return t.called=!0,t.value=e.apply(this,arguments)},n=e.name||"Function wrapped with `once`";return t.onceError=n+" shouldn't be called more than once",t.called=!1,t}t.exports=r(s),t.exports.strict=r(i),s.proto=s((function(){Object.defineProperty(Function.prototype,"once",{value:function(){return s(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return i(this)},configurable:!0})}))},{wrappy:79}],49:[function(e,t,n){(function(e){(function(){function n(t,n,r,s){if("function"!=typeof t)throw new TypeError('"callback" argument must be a function');var i,a,o=arguments.length;switch(o){case 0:case 1:return e.nextTick(t);case 2:return e.nextTick((function(){t.call(null,n)}));case 3:return e.nextTick((function(){t.call(null,n,r)}));case 4:return e.nextTick((function(){t.call(null,n,r,s)}));default:for(i=new Array(o-1),a=0;a<i.length;)i[a++]=arguments[a];return e.nextTick((function(){t.apply(null,i)}))}}void 0===e||!e.version||0===e.version.indexOf("v0.")||0===e.version.indexOf("v1.")&&0!==e.version.indexOf("v1.8.")?t.exports={nextTick:n}:t.exports=e}).call(this)}).call(this,e("_process"))},{_process:50}],50:[function(e,t,n){var r,s,i=t.exports={};function a(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function l(e){if(r===setTimeout)return setTimeout(e,0);if((r===a||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}function c(e){if(s===clearTimeout)return clearTimeout(e);if((s===o||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(e);try{return s(e)}catch(t){try{return s.call(null,e)}catch(t){return s.call(this,e)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:a}catch(e){r=a}try{s="function"==typeof clearTimeout?clearTimeout:o}catch(e){s=o}}();var d,u=[],h=!1,f=-1;function p(){h&&d&&(h=!1,d.length?u=d.concat(u):f=-1,u.length&&g())}function g(){if(!h){var e=l(p);h=!0;for(var t=u.length;t;){for(d=u,u=[];++f<t;)d&&d[f].run();f=-1,t=u.length}d=null,h=!1,c(e)}}function m(e,t){this.fun=e,this.array=t}function y(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new m(e,t)),1!==u.length||h||l(g)},m.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=y,i.addListener=y,i.once=y,i.off=y,i.removeListener=y,i.removeAllListeners=y,i.emit=y,i.prependListener=y,i.prependOnceListener=y,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},{}],51:[function(e,t,n){(function(e){(function(){!function(r){var s="object"==typeof n&&n&&!n.nodeType&&n,i="object"==typeof t&&t&&!t.nodeType&&t,a="object"==typeof e&&e;a.global!==a&&a.window!==a&&a.self!==a||(r=a);var o,l,c=2147483647,d=36,u=1,h=26,f=38,p=700,g=72,m=128,y="-",v=/^xn--/,b=/[^\x20-\x7E]/,w=/[\x2E\u3002\uFF0E\uFF61]/g,S={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},C=d-u,T=Math.floor,E=String.fromCharCode;function I(e){throw new RangeError(S[e])}function k(e,t){for(var n=e.length,r=[];n--;)r[n]=t(e[n]);return r}function A(e,t){var n=e.split("@"),r="";return n.length>1&&(r=n[0]+"@",e=n[1]),r+k((e=e.replace(w,".")).split("."),t).join(".")}function _(e){for(var t,n,r=[],s=0,i=e.length;s<i;)(t=e.charCodeAt(s++))>=55296&&t<=56319&&s<i?56320==(64512&(n=e.charCodeAt(s++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),s--):r.push(t);return r}function R(e){return k(e,(function(e){var t="";return e>65535&&(t+=E((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=E(e)})).join("")}function O(e){return e-48<10?e-22:e-65<26?e-65:e-97<26?e-97:d}function L(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function D(e,t,n){var r=0;for(e=n?T(e/p):e>>1,e+=T(e/t);e>C*h>>1;r+=d)e=T(e/C);return T(r+(C+1)*e/(e+f))}function x(e){var t,n,r,s,i,a,o,l,f,p,v=[],b=e.length,w=0,S=m,C=g;for((n=e.lastIndexOf(y))<0&&(n=0),r=0;r<n;++r)e.charCodeAt(r)>=128&&I("not-basic"),v.push(e.charCodeAt(r));for(s=n>0?n+1:0;s<b;){for(i=w,a=1,o=d;s>=b&&I("invalid-input"),((l=O(e.charCodeAt(s++)))>=d||l>T((c-w)/a))&&I("overflow"),w+=l*a,!(l<(f=o<=C?u:o>=C+h?h:o-C));o+=d)a>T(c/(p=d-f))&&I("overflow"),a*=p;C=D(w-i,t=v.length+1,0==i),T(w/t)>c-S&&I("overflow"),S+=T(w/t),w%=t,v.splice(w++,0,S)}return R(v)}function P(e){var t,n,r,s,i,a,o,l,f,p,v,b,w,S,C,k=[];for(b=(e=_(e)).length,t=m,n=0,i=g,a=0;a<b;++a)(v=e[a])<128&&k.push(E(v));for(r=s=k.length,s&&k.push(y);r<b;){for(o=c,a=0;a<b;++a)(v=e[a])>=t&&v<o&&(o=v);for(o-t>T((c-n)/(w=r+1))&&I("overflow"),n+=(o-t)*w,t=o,a=0;a<b;++a)if((v=e[a])<t&&++n>c&&I("overflow"),v==t){for(l=n,f=d;!(l<(p=f<=i?u:f>=i+h?h:f-i));f+=d)C=l-p,S=d-p,k.push(E(L(p+C%S,0))),l=T(C/S);k.push(E(L(l,0))),i=D(n,w,r==s),n=0,++r}++n,++t}return k.join("")}function M(e){return A(e,(function(e){return v.test(e)?x(e.slice(4).toLowerCase()):e}))}function F(e){return A(e,(function(e){return b.test(e)?"xn--"+P(e):e}))}if(o={version:"1.4.1",ucs2:{decode:_,encode:R},decode:x,encode:P,toASCII:F,toUnicode:M},s&&i)if(t.exports==s)i.exports=o;else for(l in o)o.hasOwnProperty(l)&&(s[l]=o[l]);else r.punycode=o}(this)}).call(this)}).call(this,void 0!==pt?pt:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],52:[function(e,t,n){function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.exports=function(e,t,n,i){t=t||"&",n=n||"=";var a={};if("string"!=typeof e||0===e.length)return a;var o=/\+/g;e=e.split(t);var l=1e3;i&&"number"==typeof i.maxKeys&&(l=i.maxKeys);var c=e.length;l>0&&c>l&&(c=l);for(var d=0;d<c;++d){var u,h,f,p,g=e[d].replace(o,"%20"),m=g.indexOf(n);m>=0?(u=g.substr(0,m),h=g.substr(m+1)):(u=g,h=""),f=decodeURIComponent(u),p=decodeURIComponent(h),r(a,f)?s(a[f])?a[f].push(p):a[f]=[a[f],p]:a[f]=p}return a};var s=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},{}],53:[function(e,t,n){var r=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};t.exports=function(e,t,n,o){return t=t||"&",n=n||"=",null===e&&(e=void 0),"object"==typeof e?i(a(e),(function(a){var o=encodeURIComponent(r(a))+n;return s(e[a])?i(e[a],(function(e){return o+encodeURIComponent(r(e))})).join(t):o+encodeURIComponent(r(e[a]))})).join(t):o?encodeURIComponent(r(o))+n+encodeURIComponent(r(e)):""};var s=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function i(e,t){if(e.map)return e.map(t);for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],r));return n}var a=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}},{}],54:[function(e,t,n){n.decode=n.parse=e("./decode"),n.encode=n.stringify=e("./encode")},{"./decode":52,"./encode":53}],55:[function(e,t,n){function r(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var s={};function i(e,t,n){function i(e,n,r){return"string"==typeof t?t:t(e,n,r)}n||(n=Error);var a=function(e){function t(t,n,r){return e.call(this,i(t,n,r))||this}return r(t,e),t}(n);a.prototype.name=n.name,a.prototype.code=e,s[e]=a}function a(e,t){if(Array.isArray(e)){var n=e.length;return e=e.map((function(e){return String(e)})),n>2?"one of ".concat(t," ").concat(e.slice(0,n-1).join(", "),", or ")+e[n-1]:2===n?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}return"of ".concat(t," ").concat(String(e))}function o(e,t,n){return e.substr(!n||n<0?0:+n,t.length)===t}function l(e,t,n){return(void 0===n||n>e.length)&&(n=e.length),e.substring(n-t.length,n)===t}function c(e,t,n){return"number"!=typeof n&&(n=0),!(n+t.length>e.length)&&-1!==e.indexOf(t,n)}i("ERR_INVALID_OPT_VALUE",(function(e,t){return'The value "'+t+'" is invalid for option "'+e+'"'}),TypeError),i("ERR_INVALID_ARG_TYPE",(function(e,t,n){var r,s;if("string"==typeof t&&o(t,"not ")?(r="must not be",t=t.replace(/^not /,"")):r="must be",l(e," argument"))s="The ".concat(e," ").concat(r," ").concat(a(t,"type"));else{var i=c(e,".")?"property":"argument";s='The "'.concat(e,'" ').concat(i," ").concat(r," ").concat(a(t,"type"))}return s+=". Received type ".concat(typeof n)}),TypeError),i("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),i("ERR_METHOD_NOT_IMPLEMENTED",(function(e){return"The "+e+" method is not implemented"})),i("ERR_STREAM_PREMATURE_CLOSE","Premature close"),i("ERR_STREAM_DESTROYED",(function(e){return"Cannot call "+e+" after a stream was destroyed"})),i("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),i("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),i("ERR_STREAM_WRITE_AFTER_END","write after end"),i("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),i("ERR_UNKNOWN_ENCODING",(function(e){return"Unknown encoding: "+e}),TypeError),i("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),t.exports.codes=s},{}],56:[function(e,t,n){(function(n){(function(){var r=Object.keys||function(e){var t=[];for(var n in e)t.push(n);return t};t.exports=c;var s=e("./_stream_readable"),i=e("./_stream_writable");e("inherits")(c,s);for(var a=r(i.prototype),o=0;o<a.length;o++){var l=a[o];c.prototype[l]||(c.prototype[l]=i.prototype[l])}function c(e){if(!(this instanceof c))return new c(e);s.call(this,e),i.call(this,e),this.allowHalfOpen=!0,e&&(!1===e.readable&&(this.readable=!1),!1===e.writable&&(this.writable=!1),!1===e.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",d)))}function d(){this._writableState.ended||n.nextTick(u,this)}function u(e){e.end()}Object.defineProperty(c.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(c.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(c.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(c.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&this._readableState.destroyed&&this._writableState.destroyed},set:function(e){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}})}).call(this)}).call(this,e("_process"))},{"./_stream_readable":58,"./_stream_writable":60,_process:50,inherits:24}],57:[function(e,t,n){t.exports=s;var r=e("./_stream_transform");function s(e){if(!(this instanceof s))return new s(e);r.call(this,e)}e("inherits")(s,r),s.prototype._transform=function(e,t,n){n(null,e)}},{"./_stream_transform":59,inherits:24}],58:[function(e,t,n){(function(n,r){(function(){var s;t.exports=_,_.ReadableState=A,e("events").EventEmitter;var i=function(e,t){return e.listeners(t).length},a=e("./internal/streams/stream"),o=e("buffer").Buffer,l=r.Uint8Array||function(){};function c(e){return o.from(e)}function d(e){return o.isBuffer(e)||e instanceof l}var u,h=e("util");u=h&&h.debuglog?h.debuglog("stream"):function(){};var f,p,g,m=e("./internal/streams/buffer_list"),y=e("./internal/streams/destroy"),v=e("./internal/streams/state").getHighWaterMark,b=e("../errors").codes,w=b.ERR_INVALID_ARG_TYPE,S=b.ERR_STREAM_PUSH_AFTER_EOF,C=b.ERR_METHOD_NOT_IMPLEMENTED,T=b.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;e("inherits")(_,a);var E=y.errorOrDestroy,I=["error","close","destroy","pause","resume"];function k(e,t,n){if("function"==typeof e.prependListener)return e.prependListener(t,n);e._events&&e._events[t]?Array.isArray(e._events[t])?e._events[t].unshift(n):e._events[t]=[n,e._events[t]]:e.on(t,n)}function A(t,n,r){s=s||e("./_stream_duplex"),t=t||{},"boolean"!=typeof r&&(r=n instanceof s),this.objectMode=!!t.objectMode,r&&(this.objectMode=this.objectMode||!!t.readableObjectMode),this.highWaterMark=v(this,t,"readableHighWaterMark",r),this.buffer=new m,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.destroyed=!1,this.defaultEncoding=t.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,t.encoding&&(f||(f=e("string_decoder/").StringDecoder),this.decoder=new f(t.encoding),this.encoding=t.encoding)}function _(t){if(s=s||e("./_stream_duplex"),!(this instanceof _))return new _(t);var n=this instanceof s;this._readableState=new A(t,this,n),this.readable=!0,t&&("function"==typeof t.read&&(this._read=t.read),"function"==typeof t.destroy&&(this._destroy=t.destroy)),a.call(this)}function R(e,t,n,r,s){u("readableAddChunk",t);var i,a=e._readableState;if(null===t)a.reading=!1,M(e,a);else if(s||(i=L(a,t)),i)E(e,i);else if(a.objectMode||t&&t.length>0)if("string"==typeof t||a.objectMode||Object.getPrototypeOf(t)===o.prototype||(t=c(t)),r)a.endEmitted?E(e,new T):O(e,a,t,!0);else if(a.ended)E(e,new S);else{if(a.destroyed)return!1;a.reading=!1,a.decoder&&!n?(t=a.decoder.write(t),a.objectMode||0!==t.length?O(e,a,t,!1):N(e,a)):O(e,a,t,!1)}else r||(a.reading=!1,N(e,a));return!a.ended&&(a.length<a.highWaterMark||0===a.length)}function O(e,t,n,r){t.flowing&&0===t.length&&!t.sync?(t.awaitDrain=0,e.emit("data",n)):(t.length+=t.objectMode?1:n.length,r?t.buffer.unshift(n):t.buffer.push(n),t.needReadable&&F(e)),N(e,t)}function L(e,t){var n;return d(t)||"string"==typeof t||void 0===t||e.objectMode||(n=new w("chunk",["string","Buffer","Uint8Array"],t)),n}Object.defineProperty(_.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(e){this._readableState&&(this._readableState.destroyed=e)}}),_.prototype.destroy=y.destroy,_.prototype._undestroy=y.undestroy,_.prototype._destroy=function(e,t){t(e)},_.prototype.push=function(e,t){var n,r=this._readableState;return r.objectMode?n=!0:"string"==typeof e&&((t=t||r.defaultEncoding)!==r.encoding&&(e=o.from(e,t),t=""),n=!0),R(this,e,t,!1,n)},_.prototype.unshift=function(e){return R(this,e,null,!0,!1)},_.prototype.isPaused=function(){return!1===this._readableState.flowing},_.prototype.setEncoding=function(t){f||(f=e("string_decoder/").StringDecoder);var n=new f(t);this._readableState.decoder=n,this._readableState.encoding=this._readableState.decoder.encoding;for(var r=this._readableState.buffer.head,s="";null!==r;)s+=n.write(r.data),r=r.next;return this._readableState.buffer.clear(),""!==s&&this._readableState.buffer.push(s),this._readableState.length=s.length,this};var D=1073741824;function x(e){return e>=D?e=D:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}function P(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=x(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}function M(e,t){if(u("onEofChunk"),!t.ended){if(t.decoder){var n=t.decoder.end();n&&n.length&&(t.buffer.push(n),t.length+=t.objectMode?1:n.length)}t.ended=!0,t.sync?F(e):(t.needReadable=!1,t.emittedReadable||(t.emittedReadable=!0,U(e)))}}function F(e){var t=e._readableState;u("emitReadable",t.needReadable,t.emittedReadable),t.needReadable=!1,t.emittedReadable||(u("emitReadable",t.flowing),t.emittedReadable=!0,n.nextTick(U,e))}function U(e){var t=e._readableState;u("emitReadable_",t.destroyed,t.length,t.ended),t.destroyed||!t.length&&!t.ended||(e.emit("readable"),t.emittedReadable=!1),t.needReadable=!t.flowing&&!t.ended&&t.length<=t.highWaterMark,H(e)}function N(e,t){t.readingMore||(t.readingMore=!0,n.nextTick(B,e,t))}function B(e,t){for(;!t.reading&&!t.ended&&(t.length<t.highWaterMark||t.flowing&&0===t.length);){var n=t.length;if(u("maybeReadMore read 0"),e.read(0),n===t.length)break}t.readingMore=!1}function j(e){return function(){var t=e._readableState;u("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&i(e,"data")&&(t.flowing=!0,H(e))}}function $(e){var t=e._readableState;t.readableListening=e.listenerCount("readable")>0,t.resumeScheduled&&!t.paused?t.flowing=!0:e.listenerCount("data")>0&&e.resume()}function q(e){u("readable nexttick read 0"),e.read(0)}function K(e,t){t.resumeScheduled||(t.resumeScheduled=!0,n.nextTick(G,e,t))}function G(e,t){u("resume",t.reading),t.reading||e.read(0),t.resumeScheduled=!1,e.emit("resume"),H(e),t.flowing&&!t.reading&&e.read(0)}function H(e){var t=e._readableState;for(u("flow",t.flowing);t.flowing&&null!==e.read(););}function V(e,t){return 0===t.length?null:(t.objectMode?n=t.buffer.shift():!e||e>=t.length?(n=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.first():t.buffer.concat(t.length),t.buffer.clear()):n=t.buffer.consume(e,t.decoder),n);var n}function z(e){var t=e._readableState;u("endReadable",t.endEmitted),t.endEmitted||(t.ended=!0,n.nextTick(W,t,e))}function W(e,t){if(u("endReadableNT",e.endEmitted,e.length),!e.endEmitted&&0===e.length&&(e.endEmitted=!0,t.readable=!1,t.emit("end"),e.autoDestroy)){var n=t._writableState;(!n||n.autoDestroy&&n.finished)&&t.destroy()}}function Y(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}_.prototype.read=function(e){u("read",e),e=parseInt(e,10);var t=this._readableState,n=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&((0!==t.highWaterMark?t.length>=t.highWaterMark:t.length>0)||t.ended))return u("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?z(this):F(this),null;if(0===(e=P(e,t))&&t.ended)return 0===t.length&&z(this),null;var r,s=t.needReadable;return u("need readable",s),(0===t.length||t.length-e<t.highWaterMark)&&u("length less than watermark",s=!0),t.ended||t.reading?u("reading or ended",s=!1):s&&(u("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=P(n,t))),null===(r=e>0?V(e,t):null)?(t.needReadable=t.length<=t.highWaterMark,e=0):(t.length-=e,t.awaitDrain=0),0===t.length&&(t.ended||(t.needReadable=!0),n!==e&&t.ended&&z(this)),null!==r&&this.emit("data",r),r},_.prototype._read=function(e){E(this,new C("_read()"))},_.prototype.pipe=function(e,t){var r=this,s=this._readableState;switch(s.pipesCount){case 0:s.pipes=e;break;case 1:s.pipes=[s.pipes,e];break;default:s.pipes.push(e)}s.pipesCount+=1,u("pipe count=%d opts=%j",s.pipesCount,t);var a=t&&!1===t.end||e===n.stdout||e===n.stderr?y:l;function o(e,t){u("onunpipe"),e===r&&t&&!1===t.hasUnpiped&&(t.hasUnpiped=!0,h())}function l(){u("onend"),e.end()}s.endEmitted?n.nextTick(a):r.once("end",a),e.on("unpipe",o);var c=j(r);e.on("drain",c);var d=!1;function h(){u("cleanup"),e.removeListener("close",g),e.removeListener("finish",m),e.removeListener("drain",c),e.removeListener("error",p),e.removeListener("unpipe",o),r.removeListener("end",l),r.removeListener("end",y),r.removeListener("data",f),d=!0,!s.awaitDrain||e._writableState&&!e._writableState.needDrain||c()}function f(t){u("ondata");var n=e.write(t);u("dest.write",n),!1===n&&((1===s.pipesCount&&s.pipes===e||s.pipesCount>1&&-1!==Y(s.pipes,e))&&!d&&(u("false write response, pause",s.awaitDrain),s.awaitDrain++),r.pause())}function p(t){u("onerror",t),y(),e.removeListener("error",p),0===i(e,"error")&&E(e,t)}function g(){e.removeListener("finish",m),y()}function m(){u("onfinish"),e.removeListener("close",g),y()}function y(){u("unpipe"),r.unpipe(e)}return r.on("data",f),k(e,"error",p),e.once("close",g),e.once("finish",m),e.emit("pipe",r),s.flowing||(u("pipe resume"),r.resume()),e},_.prototype.unpipe=function(e){var t=this._readableState,n={hasUnpiped:!1};if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this,n)),this;if(!e){var r=t.pipes,s=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var i=0;i<s;i++)r[i].emit("unpipe",this,{hasUnpiped:!1});return this}var a=Y(t.pipes,e);return-1===a||(t.pipes.splice(a,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this,n)),this},_.prototype.on=function(e,t){var r=a.prototype.on.call(this,e,t),s=this._readableState;return"data"===e?(s.readableListening=this.listenerCount("readable")>0,!1!==s.flowing&&this.resume()):"readable"===e&&(s.endEmitted||s.readableListening||(s.readableListening=s.needReadable=!0,s.flowing=!1,s.emittedReadable=!1,u("on readable",s.length,s.reading),s.length?F(this):s.reading||n.nextTick(q,this))),r},_.prototype.addListener=_.prototype.on,_.prototype.removeListener=function(e,t){var r=a.prototype.removeListener.call(this,e,t);return"readable"===e&&n.nextTick($,this),r},_.prototype.removeAllListeners=function(e){var t=a.prototype.removeAllListeners.apply(this,arguments);return"readable"!==e&&void 0!==e||n.nextTick($,this),t},_.prototype.resume=function(){var e=this._readableState;return e.flowing||(u("resume"),e.flowing=!e.readableListening,K(this,e)),e.paused=!1,this},_.prototype.pause=function(){return u("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(u("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},_.prototype.wrap=function(e){var t=this,n=this._readableState,r=!1;for(var s in e.on("end",(function(){if(u("wrapped end"),n.decoder&&!n.ended){var e=n.decoder.end();e&&e.length&&t.push(e)}t.push(null)})),e.on("data",(function(s){u("wrapped data"),n.decoder&&(s=n.decoder.write(s)),n.objectMode&&null==s||(n.objectMode||s&&s.length)&&(t.push(s)||(r=!0,e.pause()))})),e)void 0===this[s]&&"function"==typeof e[s]&&(this[s]=function(t){return function(){return e[t].apply(e,arguments)}}(s));for(var i=0;i<I.length;i++)e.on(I[i],this.emit.bind(this,I[i]));return this._read=function(t){u("wrapped _read",t),r&&(r=!1,e.resume())},this},"function"==typeof Symbol&&(_.prototype[Symbol.asyncIterator]=function(){return void 0===p&&(p=e("./internal/streams/async_iterator")),p(this)}),Object.defineProperty(_.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(_.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(_.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(e){this._readableState&&(this._readableState.flowing=e)}}),_._fromList=V,Object.defineProperty(_.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(_.from=function(t,n){return void 0===g&&(g=e("./internal/streams/from")),g(_,t,n)})}).call(this)}).call(this,e("_process"),void 0!==pt?pt:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":55,"./_stream_duplex":56,"./internal/streams/async_iterator":61,"./internal/streams/buffer_list":62,"./internal/streams/destroy":63,"./internal/streams/from":65,"./internal/streams/state":67,"./internal/streams/stream":68,_process:50,buffer:17,events:22,inherits:24,"string_decoder/":75,util:16}],59:[function(e,t,n){t.exports=d;var r=e("../errors").codes,s=r.ERR_METHOD_NOT_IMPLEMENTED,i=r.ERR_MULTIPLE_CALLBACK,a=r.ERR_TRANSFORM_ALREADY_TRANSFORMING,o=r.ERR_TRANSFORM_WITH_LENGTH_0,l=e("./_stream_duplex");function c(e,t){var n=this._transformState;n.transforming=!1;var r=n.writecb;if(null===r)return this.emit("error",new i);n.writechunk=null,n.writecb=null,null!=t&&this.push(t),r(e);var s=this._readableState;s.reading=!1,(s.needReadable||s.length<s.highWaterMark)&&this._read(s.highWaterMark)}function d(e){if(!(this instanceof d))return new d(e);l.call(this,e),this._transformState={afterTransform:c.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",u)}function u(){var e=this;"function"!=typeof this._flush||this._readableState.destroyed?h(this,null,null):this._flush((function(t,n){h(e,t,n)}))}function h(e,t,n){if(t)return e.emit("error",t);if(null!=n&&e.push(n),e._writableState.length)throw new o;if(e._transformState.transforming)throw new a;return e.push(null)}e("inherits")(d,l),d.prototype.push=function(e,t){return this._transformState.needTransform=!1,l.prototype.push.call(this,e,t)},d.prototype._transform=function(e,t,n){n(new s("_transform()"))},d.prototype._write=function(e,t,n){var r=this._transformState;if(r.writecb=n,r.writechunk=e,r.writeencoding=t,!r.transforming){var s=this._readableState;(r.needTransform||s.needReadable||s.length<s.highWaterMark)&&this._read(s.highWaterMark)}},d.prototype._read=function(e){var t=this._transformState;null===t.writechunk||t.transforming?t.needTransform=!0:(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform))},d.prototype._destroy=function(e,t){l.prototype._destroy.call(this,e,(function(e){t(e)}))}},{"../errors":55,"./_stream_duplex":56,inherits:24}],60:[function(e,t,n){(function(n,r){(function(){function s(e){var t=this;this.next=null,this.entry=null,this.finish=function(){G(t,e)}}var i;t.exports=A,A.WritableState=k;var a={deprecate:e("util-deprecate")},o=e("./internal/streams/stream"),l=e("buffer").Buffer,c=r.Uint8Array||function(){};function d(e){return l.from(e)}function u(e){return l.isBuffer(e)||e instanceof c}var h,f=e("./internal/streams/destroy"),p=e("./internal/streams/state").getHighWaterMark,g=e("../errors").codes,m=g.ERR_INVALID_ARG_TYPE,y=g.ERR_METHOD_NOT_IMPLEMENTED,v=g.ERR_MULTIPLE_CALLBACK,b=g.ERR_STREAM_CANNOT_PIPE,w=g.ERR_STREAM_DESTROYED,S=g.ERR_STREAM_NULL_VALUES,C=g.ERR_STREAM_WRITE_AFTER_END,T=g.ERR_UNKNOWN_ENCODING,E=f.errorOrDestroy;function I(){}function k(t,n,r){i=i||e("./_stream_duplex"),t=t||{},"boolean"!=typeof r&&(r=n instanceof i),this.objectMode=!!t.objectMode,r&&(this.objectMode=this.objectMode||!!t.writableObjectMode),this.highWaterMark=p(this,t,"writableHighWaterMark",r),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var a=!1===t.decodeStrings;this.decodeStrings=!a,this.defaultEncoding=t.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){M(n,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new s(this)}function A(t){var n=this instanceof(i=i||e("./_stream_duplex"));if(!n&&!h.call(A,this))return new A(t);this._writableState=new k(t,this,n),this.writable=!0,t&&("function"==typeof t.write&&(this._write=t.write),"function"==typeof t.writev&&(this._writev=t.writev),"function"==typeof t.destroy&&(this._destroy=t.destroy),"function"==typeof t.final&&(this._final=t.final)),o.call(this)}function _(e,t){var r=new C;E(e,r),n.nextTick(t,r)}function R(e,t,r,s){var i;return null===r?i=new S:"string"==typeof r||t.objectMode||(i=new m("chunk",["string","Buffer"],r)),!i||(E(e,i),n.nextTick(s,i),!1)}function O(e,t,n){return e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=l.from(t,n)),t}function L(e,t,n,r,s,i){if(!n){var a=O(t,r,s);r!==a&&(n=!0,s="buffer",r=a)}var o=t.objectMode?1:r.length;t.length+=o;var l=t.length<t.highWaterMark;if(l||(t.needDrain=!0),t.writing||t.corked){var c=t.lastBufferedRequest;t.lastBufferedRequest={chunk:r,encoding:s,isBuf:n,callback:i,next:null},c?c.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else D(e,t,!1,o,r,s,i);return l}function D(e,t,n,r,s,i,a){t.writelen=r,t.writecb=a,t.writing=!0,t.sync=!0,t.destroyed?t.onwrite(new w("write")):n?e._writev(s,t.onwrite):e._write(s,i,t.onwrite),t.sync=!1}function x(e,t,r,s,i){--t.pendingcb,r?(n.nextTick(i,s),n.nextTick(q,e,t),e._writableState.errorEmitted=!0,E(e,s)):(i(s),e._writableState.errorEmitted=!0,E(e,s),q(e,t))}function P(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}function M(e,t){var r=e._writableState,s=r.sync,i=r.writecb;if("function"!=typeof i)throw new v;if(P(r),t)x(e,r,s,t,i);else{var a=B(r)||e.destroyed;a||r.corked||r.bufferProcessing||!r.bufferedRequest||N(e,r),s?n.nextTick(F,e,r,a,i):F(e,r,a,i)}}function F(e,t,n,r){n||U(e,t),t.pendingcb--,r(),q(e,t)}function U(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}function N(e,t){t.bufferProcessing=!0;var n=t.bufferedRequest;if(e._writev&&n&&n.next){var r=t.bufferedRequestCount,i=new Array(r),a=t.corkedRequestsFree;a.entry=n;for(var o=0,l=!0;n;)i[o]=n,n.isBuf||(l=!1),n=n.next,o+=1;i.allBuffers=l,D(e,t,!0,t.length,i,"",a.finish),t.pendingcb++,t.lastBufferedRequest=null,a.next?(t.corkedRequestsFree=a.next,a.next=null):t.corkedRequestsFree=new s(t),t.bufferedRequestCount=0}else{for(;n;){var c=n.chunk,d=n.encoding,u=n.callback;if(D(e,t,!1,t.objectMode?1:c.length,c,d,u),n=n.next,t.bufferedRequestCount--,t.writing)break}null===n&&(t.lastBufferedRequest=null)}t.bufferedRequest=n,t.bufferProcessing=!1}function B(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function j(e,t){e._final((function(n){t.pendingcb--,n&&E(e,n),t.prefinished=!0,e.emit("prefinish"),q(e,t)}))}function $(e,t){t.prefinished||t.finalCalled||("function"!=typeof e._final||t.destroyed?(t.prefinished=!0,e.emit("prefinish")):(t.pendingcb++,t.finalCalled=!0,n.nextTick(j,e,t)))}function q(e,t){var n=B(t);if(n&&($(e,t),0===t.pendingcb&&(t.finished=!0,e.emit("finish"),t.autoDestroy))){var r=e._readableState;(!r||r.autoDestroy&&r.endEmitted)&&e.destroy()}return n}function K(e,t,r){t.ending=!0,q(e,t),r&&(t.finished?n.nextTick(r):e.once("finish",r)),t.ended=!0,e.writable=!1}function G(e,t,n){var r=e.entry;for(e.entry=null;r;){var s=r.callback;t.pendingcb--,s(n),r=r.next}t.corkedRequestsFree.next=e}e("inherits")(A,o),k.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},function(){try{Object.defineProperty(k.prototype,"buffer",{get:a.deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(h=Function.prototype[Symbol.hasInstance],Object.defineProperty(A,Symbol.hasInstance,{value:function(e){return!!h.call(this,e)||this===A&&e&&e._writableState instanceof k}})):h=function(e){return e instanceof this},A.prototype.pipe=function(){E(this,new b)},A.prototype.write=function(e,t,n){var r=this._writableState,s=!1,i=!r.objectMode&&u(e);return i&&!l.isBuffer(e)&&(e=d(e)),"function"==typeof t&&(n=t,t=null),i?t="buffer":t||(t=r.defaultEncoding),"function"!=typeof n&&(n=I),r.ending?_(this,n):(i||R(this,r,e,n))&&(r.pendingcb++,s=L(this,r,i,e,t,n)),s},A.prototype.cork=function(){this._writableState.corked++},A.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.bufferProcessing||!e.bufferedRequest||N(this,e))},A.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new T(e);return this._writableState.defaultEncoding=e,this},Object.defineProperty(A.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(A.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),A.prototype._write=function(e,t,n){n(new y("_write()"))},A.prototype._writev=null,A.prototype.end=function(e,t,n){var r=this._writableState;return"function"==typeof e?(n=e,e=null,t=null):"function"==typeof t&&(n=t,t=null),null!=e&&this.write(e,t),r.corked&&(r.corked=1,this.uncork()),r.ending||K(this,r,n),this},Object.defineProperty(A.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(A.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(e){this._writableState&&(this._writableState.destroyed=e)}}),A.prototype.destroy=f.destroy,A.prototype._undestroy=f.undestroy,A.prototype._destroy=function(e,t){t(e)}}).call(this)}).call(this,e("_process"),void 0!==pt?pt:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":55,"./_stream_duplex":56,"./internal/streams/destroy":63,"./internal/streams/state":67,"./internal/streams/stream":68,_process:50,buffer:17,inherits:24,"util-deprecate":78}],61:[function(e,t,n){(function(n){(function(){var r;function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=e("./end-of-stream"),a=Symbol("lastResolve"),o=Symbol("lastReject"),l=Symbol("error"),c=Symbol("ended"),d=Symbol("lastPromise"),u=Symbol("handlePromise"),h=Symbol("stream");function f(e,t){return{value:e,done:t}}function p(e){var t=e[a];if(null!==t){var n=e[h].read();null!==n&&(e[d]=null,e[a]=null,e[o]=null,t(f(n,!1)))}}function g(e){n.nextTick(p,e)}function m(e,t){return function(n,r){e.then((function(){t[c]?n(f(void 0,!0)):t[u](n,r)}),r)}}var y=Object.getPrototypeOf((function(){})),v=Object.setPrototypeOf((s(r={get stream(){return this[h]},next:function(){var e=this,t=this[l];if(null!==t)return Promise.reject(t);if(this[c])return Promise.resolve(f(void 0,!0));if(this[h].destroyed)return new Promise((function(t,r){n.nextTick((function(){e[l]?r(e[l]):t(f(void 0,!0))}))}));var r,s=this[d];if(s)r=new Promise(m(s,this));else{var i=this[h].read();if(null!==i)return Promise.resolve(f(i,!1));r=new Promise(this[u])}return this[d]=r,r}},Symbol.asyncIterator,(function(){return this})),s(r,"return",(function(){var e=this;return new Promise((function(t,n){e[h].destroy(null,(function(e){e?n(e):t(f(void 0,!0))}))}))})),r),y),b=function(e){var t,n=Object.create(v,(s(t={},h,{value:e,writable:!0}),s(t,a,{value:null,writable:!0}),s(t,o,{value:null,writable:!0}),s(t,l,{value:null,writable:!0}),s(t,c,{value:e._readableState.endEmitted,writable:!0}),s(t,u,{value:function(e,t){var r=n[h].read();r?(n[d]=null,n[a]=null,n[o]=null,e(f(r,!1))):(n[a]=e,n[o]=t)},writable:!0}),t));return n[d]=null,i(e,(function(e){if(e&&"ERR_STREAM_PREMATURE_CLOSE"!==e.code){var t=n[o];return null!==t&&(n[d]=null,n[a]=null,n[o]=null,t(e)),void(n[l]=e)}var r=n[a];null!==r&&(n[d]=null,n[a]=null,n[o]=null,r(f(void 0,!0))),n[c]=!0})),e.on("readable",g.bind(null,n)),n};t.exports=b}).call(this)}).call(this,e("_process"))},{"./end-of-stream":64,_process:50}],62:[function(e,t,n){function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}var c=e("buffer").Buffer,d=e("util").inspect,u=d&&d.custom||"inspect";function h(e,t,n){c.prototype.copy.call(e,t,n)}t.exports=function(){function e(){a(this,e),this.head=null,this.tail=null,this.length=0}return l(e,[{key:"push",value:function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length}},{key:"unshift",value:function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length}},{key:"shift",value:function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(e){if(0===this.length)return"";for(var t=this.head,n=""+t.data;t=t.next;)n+=e+t.data;return n}},{key:"concat",value:function(e){if(0===this.length)return c.alloc(0);for(var t=c.allocUnsafe(e>>>0),n=this.head,r=0;n;)h(n.data,t,r),r+=n.data.length,n=n.next;return t}},{key:"consume",value:function(e,t){var n;return e<this.head.data.length?(n=this.head.data.slice(0,e),this.head.data=this.head.data.slice(e)):n=e===this.head.data.length?this.shift():t?this._getString(e):this._getBuffer(e),n}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(e){var t=this.head,n=1,r=t.data;for(e-=r.length;t=t.next;){var s=t.data,i=e>s.length?s.length:e;if(i===s.length?r+=s:r+=s.slice(0,e),0==(e-=i)){i===s.length?(++n,t.next?this.head=t.next:this.head=this.tail=null):(this.head=t,t.data=s.slice(i));break}++n}return this.length-=n,r}},{key:"_getBuffer",value:function(e){var t=c.allocUnsafe(e),n=this.head,r=1;for(n.data.copy(t),e-=n.data.length;n=n.next;){var s=n.data,i=e>s.length?s.length:e;if(s.copy(t,t.length-e,0,i),0==(e-=i)){i===s.length?(++r,n.next?this.head=n.next:this.head=this.tail=null):(this.head=n,n.data=s.slice(i));break}++r}return this.length-=r,t}},{key:u,value:function(e,t){return d(this,s({},t,{depth:0,customInspect:!1}))}}]),e}()},{buffer:17,util:16}],63:[function(e,t,n){(function(e){(function(){function n(t,n){var i=this,o=this._readableState&&this._readableState.destroyed,l=this._writableState&&this._writableState.destroyed;return o||l?(n?n(t):t&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,e.nextTick(a,this,t)):e.nextTick(a,this,t)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(t||null,(function(t){!n&&t?i._writableState?i._writableState.errorEmitted?e.nextTick(s,i):(i._writableState.errorEmitted=!0,e.nextTick(r,i,t)):e.nextTick(r,i,t):n?(e.nextTick(s,i),n(t)):e.nextTick(s,i)})),this)}function r(e,t){a(e,t),s(e)}function s(e){e._writableState&&!e._writableState.emitClose||e._readableState&&!e._readableState.emitClose||e.emit("close")}function i(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function a(e,t){e.emit("error",t)}function o(e,t){var n=e._readableState,r=e._writableState;n&&n.autoDestroy||r&&r.autoDestroy?e.destroy(t):e.emit("error",t)}t.exports={destroy:n,undestroy:i,errorOrDestroy:o}}).call(this)}).call(this,e("_process"))},{_process:50}],64:[function(e,t,n){var r=e("../../../errors").codes.ERR_STREAM_PREMATURE_CLOSE;function s(e){var t=!1;return function(){if(!t){t=!0;for(var n=arguments.length,r=new Array(n),s=0;s<n;s++)r[s]=arguments[s];e.apply(this,r)}}}function i(){}function a(e){return e.setHeader&&"function"==typeof e.abort}function o(e,t,n){if("function"==typeof t)return o(e,null,t);t||(t={}),n=s(n||i);var l=t.readable||!1!==t.readable&&e.readable,c=t.writable||!1!==t.writable&&e.writable,d=function(){e.writable||h()},u=e._writableState&&e._writableState.finished,h=function(){c=!1,u=!0,l||n.call(e)},f=e._readableState&&e._readableState.endEmitted,p=function(){l=!1,f=!0,c||n.call(e)},g=function(t){n.call(e,t)},m=function(){var t;return l&&!f?(e._readableState&&e._readableState.ended||(t=new r),n.call(e,t)):c&&!u?(e._writableState&&e._writableState.ended||(t=new r),n.call(e,t)):void 0},y=function(){e.req.on("finish",h)};return a(e)?(e.on("complete",h),e.on("abort",m),e.req?y():e.on("request",y)):c&&!e._writableState&&(e.on("end",d),e.on("close",d)),e.on("end",p),e.on("finish",h),!1!==t.error&&e.on("error",g),e.on("close",m),function(){e.removeListener("complete",h),e.removeListener("abort",m),e.removeListener("request",y),e.req&&e.req.removeListener("finish",h),e.removeListener("end",d),e.removeListener("close",d),e.removeListener("finish",h),e.removeListener("end",p),e.removeListener("error",g),e.removeListener("close",m)}}t.exports=o},{"../../../errors":55}],65:[function(e,t,n){t.exports=function(){throw new Error("Readable.from is not available in the browser")}},{}],66:[function(e,t,n){var r;function s(e){var t=!1;return function(){t||(t=!0,e.apply(void 0,arguments))}}var i=e("../../../errors").codes,a=i.ERR_MISSING_ARGS,o=i.ERR_STREAM_DESTROYED;function l(e){if(e)throw e}function c(e){return e.setHeader&&"function"==typeof e.abort}function d(t,n,i,a){a=s(a);var l=!1;t.on("close",(function(){l=!0})),void 0===r&&(r=e("./end-of-stream")),r(t,{readable:n,writable:i},(function(e){if(e)return a(e);l=!0,a()}));var d=!1;return function(e){if(!l&&!d)return d=!0,c(t)?t.abort():"function"==typeof t.destroy?t.destroy():void a(e||new o("pipe"))}}function u(e){e()}function h(e,t){return e.pipe(t)}function f(e){return e.length?"function"!=typeof e[e.length-1]?l:e.pop():l}function p(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r,s=f(t);if(Array.isArray(t[0])&&(t=t[0]),t.length<2)throw new a("streams");var i=t.map((function(e,n){var a=n<t.length-1;return d(e,a,n>0,(function(e){r||(r=e),e&&i.forEach(u),a||(i.forEach(u),s(r))}))}));return t.reduce(h)}t.exports=p},{"../../../errors":55,"./end-of-stream":64}],67:[function(e,t,n){var r=e("../../../errors").codes.ERR_INVALID_OPT_VALUE;function s(e,t,n){return null!=e.highWaterMark?e.highWaterMark:t?e[n]:null}function i(e,t,n,i){var a=s(t,i,n);if(null!=a){if(!isFinite(a)||Math.floor(a)!==a||a<0)throw new r(i?n:"highWaterMark",a);return Math.floor(a)}return e.objectMode?16:16384}t.exports={getHighWaterMark:i}},{"../../../errors":55}],68:[function(e,t,n){t.exports=e("events").EventEmitter},{events:22}],69:[function(e,t,n){(n=t.exports=e("./lib/_stream_readable.js")).Stream=n,n.Readable=n,n.Writable=e("./lib/_stream_writable.js"),n.Duplex=e("./lib/_stream_duplex.js"),n.Transform=e("./lib/_stream_transform.js"),n.PassThrough=e("./lib/_stream_passthrough.js"),n.finished=e("./lib/internal/streams/end-of-stream.js"),n.pipeline=e("./lib/internal/streams/pipeline.js")},{"./lib/_stream_duplex.js":56,"./lib/_stream_passthrough.js":57,"./lib/_stream_readable.js":58,"./lib/_stream_transform.js":59,"./lib/_stream_writable.js":60,"./lib/internal/streams/end-of-stream.js":64,"./lib/internal/streams/pipeline.js":66}],70:[function(e,t,n){function r(e,t,n){var r=this;this._callback=e,this._args=n,this._interval=setInterval(e,t,this._args),this.reschedule=function(e){e||(e=r._interval),r._interval&&clearInterval(r._interval),r._interval=setInterval(r._callback,e,r._args)},this.clear=function(){r._interval&&(clearInterval(r._interval),r._interval=void 0)},this.destroy=function(){r._interval&&clearInterval(r._interval),r._callback=void 0,r._interval=void 0,r._args=void 0}}function s(){if("function"!=typeof arguments[0])throw new Error("callback needed");if("number"!=typeof arguments[1])throw new Error("interval needed");var e;if(arguments.length>0){e=new Array(arguments.length-2);for(var t=0;t<e.length;t++)e[t]=arguments[t+2]}return new r(arguments[0],arguments[1],e)}t.exports=s},{}],71:[function(e,t,n){t.exports=e("./index.js")()},{"./index.js":72}],72:[function(e,t,n){(function(e){(function(){function n(t){return t instanceof e?e.from(t):new t.constructor(t.buffer.slice(),t.byteOffset,t.length)}function r(e){return(e=e||{}).circles?s(e):e.proto?i:r;function t(e,t){for(var r=Object.keys(e),s=new Array(r.length),i=0;i<r.length;i++){var a=r[i],o=e[a];"object"!=typeof o||null===o?s[a]=o:o instanceof Date?s[a]=new Date(o):ArrayBuffer.isView(o)?s[a]=n(o):s[a]=t(o)}return s}function r(e){if("object"!=typeof e||null===e)return e;if(e instanceof Date)return new Date(e);if(Array.isArray(e))return t(e,r);if(e instanceof Map)return new Map(t(Array.from(e),r));if(e instanceof Set)return new Set(t(Array.from(e),r));var s={};for(var i in e)if(!1!==Object.hasOwnProperty.call(e,i)){var a=e[i];"object"!=typeof a||null===a?s[i]=a:a instanceof Date?s[i]=new Date(a):a instanceof Map?s[i]=new Map(t(Array.from(a),r)):a instanceof Set?s[i]=new Set(t(Array.from(a),r)):ArrayBuffer.isView(a)?s[i]=n(a):s[i]=r(a)}return s}function i(e){if("object"!=typeof e||null===e)return e;if(e instanceof Date)return new Date(e);if(Array.isArray(e))return t(e,i);if(e instanceof Map)return new Map(t(Array.from(e),i));if(e instanceof Set)return new Set(t(Array.from(e),i));var r={};for(var s in e){var a=e[s];"object"!=typeof a||null===a?r[s]=a:a instanceof Date?r[s]=new Date(a):a instanceof Map?r[s]=new Map(t(Array.from(a),i)):a instanceof Set?r[s]=new Set(t(Array.from(a),i)):ArrayBuffer.isView(a)?r[s]=n(a):r[s]=i(a)}return r}}function s(e){var t=[],r=[];return e.proto?a:i;function s(e,s){for(var i=Object.keys(e),a=new Array(i.length),o=0;o<i.length;o++){var l=i[o],c=e[l];if("object"!=typeof c||null===c)a[l]=c;else if(c instanceof Date)a[l]=new Date(c);else if(ArrayBuffer.isView(c))a[l]=n(c);else{var d=t.indexOf(c);a[l]=-1!==d?r[d]:s(c)}}return a}function i(e){if("object"!=typeof e||null===e)return e;if(e instanceof Date)return new Date(e);if(Array.isArray(e))return s(e,i);if(e instanceof Map)return new Map(s(Array.from(e),i));if(e instanceof Set)return new Set(s(Array.from(e),i));var a={};for(var o in t.push(e),r.push(a),e)if(!1!==Object.hasOwnProperty.call(e,o)){var l=e[o];if("object"!=typeof l||null===l)a[o]=l;else if(l instanceof Date)a[o]=new Date(l);else if(l instanceof Map)a[o]=new Map(s(Array.from(l),i));else if(l instanceof Set)a[o]=new Set(s(Array.from(l),i));else if(ArrayBuffer.isView(l))a[o]=n(l);else{var c=t.indexOf(l);a[o]=-1!==c?r[c]:i(l)}}return t.pop(),r.pop(),a}function a(e){if("object"!=typeof e||null===e)return e;if(e instanceof Date)return new Date(e);if(Array.isArray(e))return s(e,a);if(e instanceof Map)return new Map(s(Array.from(e),a));if(e instanceof Set)return new Set(s(Array.from(e),a));var i={};for(var o in t.push(e),r.push(i),e){var l=e[o];if("object"!=typeof l||null===l)i[o]=l;else if(l instanceof Date)i[o]=new Date(l);else if(l instanceof Map)i[o]=new Map(s(Array.from(l),a));else if(l instanceof Set)i[o]=new Set(s(Array.from(l),a));else if(ArrayBuffer.isView(l))i[o]=n(l);else{var c=t.indexOf(l);i[o]=-1!==c?r[c]:a(l)}}return t.pop(),r.pop(),i}}t.exports=r}).call(this)}).call(this,e("buffer").Buffer)},{buffer:17}],73:[function(e,t,n){
/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
var r=e("buffer"),s=r.Buffer;function i(e,t){for(var n in e)t[n]=e[n]}function a(e,t,n){return s(e,t,n)}s.from&&s.alloc&&s.allocUnsafe&&s.allocUnsafeSlow?t.exports=r:(i(r,n),n.Buffer=a),a.prototype=Object.create(s.prototype),i(s,a),a.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return s(e,t,n)},a.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var r=s(e);return void 0!==t?"string"==typeof n?r.fill(t,n):r.fill(t):r.fill(0),r},a.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return s(e)},a.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r.SlowBuffer(e)}},{buffer:17}],74:[function(e,t,n){function r(e){var t=e._readableState;return t?t.objectMode||"number"==typeof e._duplexState?e.read():e.read(s(t)):null}function s(e){return e.buffer.length?e.buffer.head?e.buffer.head.data.length:e.buffer[0].length:e.length}t.exports=r},{}],75:[function(e,t,n){var r=e("safe-buffer").Buffer,s=r.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function i(e){if(!e)return"utf8";for(var t;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}function a(e){var t=i(e);if("string"!=typeof t&&(r.isEncoding===s||!s(e)))throw new Error("Unknown encoding: "+e);return t||e}function o(e){var t;switch(this.encoding=a(e),this.encoding){case"utf16le":this.text=p,this.end=g,t=4;break;case"utf8":this.fillLast=u,t=4;break;case"base64":this.text=m,this.end=y,t=3;break;default:return this.write=v,void(this.end=b)}this.lastNeed=0,this.lastTotal=0,this.lastChar=r.allocUnsafe(t)}function l(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:e>>6==2?-1:-2}function c(e,t,n){var r=t.length-1;if(r<n)return 0;var s=l(t[r]);return s>=0?(s>0&&(e.lastNeed=s-1),s):--r<n||-2===s?0:(s=l(t[r]))>=0?(s>0&&(e.lastNeed=s-2),s):--r<n||-2===s?0:(s=l(t[r]))>=0?(s>0&&(2===s?s=0:e.lastNeed=s-3),s):0}function d(e,t,n){if(128!=(192&t[0]))return e.lastNeed=0,"�";if(e.lastNeed>1&&t.length>1){if(128!=(192&t[1]))return e.lastNeed=1,"�";if(e.lastNeed>2&&t.length>2&&128!=(192&t[2]))return e.lastNeed=2,"�"}}function u(e){var t=this.lastTotal-this.lastNeed,n=d(this,e);return void 0!==n?n:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(e.copy(this.lastChar,t,0,e.length),void(this.lastNeed-=e.length))}function h(e,t){var n=c(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=n;var r=e.length-(n-this.lastNeed);return e.copy(this.lastChar,0,r),e.toString("utf8",t,r)}function f(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"�":t}function p(e,t){if((e.length-t)%2==0){var n=e.toString("utf16le",t);if(n){var r=n.charCodeAt(n.length-1);if(r>=55296&&r<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],n.slice(0,-1)}return n}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function g(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var n=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,n)}return t}function m(e,t){var n=(e.length-t)%3;return 0===n?e.toString("base64",t):(this.lastNeed=3-n,this.lastTotal=3,1===n?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-n))}function y(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function v(e){return e.toString(this.encoding)}function b(e){return e&&e.length?this.write(e):""}n.StringDecoder=o,o.prototype.write=function(e){if(0===e.length)return"";var t,n;if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";n=this.lastNeed,this.lastNeed=0}else n=0;return n<e.length?t?t+this.text(e,n):this.text(e,n):t||""},o.prototype.end=f,o.prototype.text=h,o.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}},{"safe-buffer":73}],76:[function(e,t,n){var r=e("punycode"),s=e("./util");function i(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}n.parse=w,n.resolve=C,n.resolveObject=T,n.format=S,n.Url=i;var a=/^([a-z0-9.+-]+:)/i,o=/:[0-9]*$/,l=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,c=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),d=["'"].concat(c),u=["%","/","?",";","#"].concat(d),h=["/","?","#"],f=255,p=/^[+a-z0-9A-Z_-]{0,63}$/,g=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,m={javascript:!0,"javascript:":!0},y={javascript:!0,"javascript:":!0},v={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},b=e("querystring");function w(e,t,n){if(e&&s.isObject(e)&&e instanceof i)return e;var r=new i;return r.parse(e,t,n),r}function S(e){return s.isString(e)&&(e=w(e)),e instanceof i?e.format():i.prototype.format.call(e)}function C(e,t){return w(e,!1,!0).resolve(t)}function T(e,t){return e?w(e,!1,!0).resolveObject(t):t}i.prototype.parse=function(e,t,n){if(!s.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var i=e.indexOf("?"),o=-1!==i&&i<e.indexOf("#")?"?":"#",c=e.split(o),w=/\\/g;c[0]=c[0].replace(w,"/");var S=e=c.join(o);if(S=S.trim(),!n&&1===e.split("#").length){var C=l.exec(S);if(C)return this.path=S,this.href=S,this.pathname=C[1],C[2]?(this.search=C[2],this.query=t?b.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var T=a.exec(S);if(T){var E=(T=T[0]).toLowerCase();this.protocol=E,S=S.substr(T.length)}if(n||T||S.match(/^\/\/[^@\/]+@[^@\/]+/)){var I="//"===S.substr(0,2);!I||T&&y[T]||(S=S.substr(2),this.slashes=!0)}if(!y[T]&&(I||T&&!v[T])){for(var k,A,_=-1,R=0;R<h.length;R++)-1!==(O=S.indexOf(h[R]))&&(-1===_||O<_)&&(_=O);for(-1!==(A=-1===_?S.lastIndexOf("@"):S.lastIndexOf("@",_))&&(k=S.slice(0,A),S=S.slice(A+1),this.auth=decodeURIComponent(k)),_=-1,R=0;R<u.length;R++){var O;-1!==(O=S.indexOf(u[R]))&&(-1===_||O<_)&&(_=O)}-1===_&&(_=S.length),this.host=S.slice(0,_),S=S.slice(_),this.parseHost(),this.hostname=this.hostname||"";var L="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!L)for(var D=this.hostname.split(/\./),x=(R=0,D.length);R<x;R++){var P=D[R];if(P&&!P.match(p)){for(var M="",F=0,U=P.length;F<U;F++)P.charCodeAt(F)>127?M+="x":M+=P[F];if(!M.match(p)){var N=D.slice(0,R),B=D.slice(R+1),j=P.match(g);j&&(N.push(j[1]),B.unshift(j[2])),B.length&&(S="/"+B.join(".")+S),this.hostname=N.join(".");break}}}this.hostname.length>f?this.hostname="":this.hostname=this.hostname.toLowerCase(),L||(this.hostname=r.toASCII(this.hostname));var $=this.port?":"+this.port:"",q=this.hostname||"";this.host=q+$,this.href+=this.host,L&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==S[0]&&(S="/"+S))}if(!m[E])for(R=0,x=d.length;R<x;R++){var K=d[R];if(-1!==S.indexOf(K)){var G=encodeURIComponent(K);G===K&&(G=escape(K)),S=S.split(K).join(G)}}var H=S.indexOf("#");-1!==H&&(this.hash=S.substr(H),S=S.slice(0,H));var V=S.indexOf("?");if(-1!==V?(this.search=S.substr(V),this.query=S.substr(V+1),t&&(this.query=b.parse(this.query)),S=S.slice(0,V)):t&&(this.search="",this.query={}),S&&(this.pathname=S),v[E]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){$=this.pathname||"";var z=this.search||"";this.path=$+z}return this.href=this.format(),this},i.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",n=this.pathname||"",r=this.hash||"",i=!1,a="";this.host?i=e+this.host:this.hostname&&(i=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(i+=":"+this.port)),this.query&&s.isObject(this.query)&&Object.keys(this.query).length&&(a=b.stringify(this.query));var o=this.search||a&&"?"+a||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||v[t])&&!1!==i?(i="//"+(i||""),n&&"/"!==n.charAt(0)&&(n="/"+n)):i||(i=""),r&&"#"!==r.charAt(0)&&(r="#"+r),o&&"?"!==o.charAt(0)&&(o="?"+o),t+i+(n=n.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(o=o.replace("#","%23"))+r},i.prototype.resolve=function(e){return this.resolveObject(w(e,!1,!0)).format()},i.prototype.resolveObject=function(e){if(s.isString(e)){var t=new i;t.parse(e,!1,!0),e=t}for(var n=new i,r=Object.keys(this),a=0;a<r.length;a++){var o=r[a];n[o]=this[o]}if(n.hash=e.hash,""===e.href)return n.href=n.format(),n;if(e.slashes&&!e.protocol){for(var l=Object.keys(e),c=0;c<l.length;c++){var d=l[c];"protocol"!==d&&(n[d]=e[d])}return v[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname="/"),n.href=n.format(),n}if(e.protocol&&e.protocol!==n.protocol){if(!v[e.protocol]){for(var u=Object.keys(e),h=0;h<u.length;h++){var f=u[h];n[f]=e[f]}return n.href=n.format(),n}if(n.protocol=e.protocol,e.host||y[e.protocol])n.pathname=e.pathname;else{for(var p=(e.pathname||"").split("/");p.length&&!(e.host=p.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==p[0]&&p.unshift(""),p.length<2&&p.unshift(""),n.pathname=p.join("/")}if(n.search=e.search,n.query=e.query,n.host=e.host||"",n.auth=e.auth,n.hostname=e.hostname||e.host,n.port=e.port,n.pathname||n.search){var g=n.pathname||"",m=n.search||"";n.path=g+m}return n.slashes=n.slashes||e.slashes,n.href=n.format(),n}var b=n.pathname&&"/"===n.pathname.charAt(0),w=e.host||e.pathname&&"/"===e.pathname.charAt(0),S=w||b||n.host&&e.pathname,C=S,T=n.pathname&&n.pathname.split("/")||[],E=(p=e.pathname&&e.pathname.split("/")||[],n.protocol&&!v[n.protocol]);if(E&&(n.hostname="",n.port=null,n.host&&(""===T[0]?T[0]=n.host:T.unshift(n.host)),n.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===p[0]?p[0]=e.host:p.unshift(e.host)),e.host=null),S=S&&(""===p[0]||""===T[0])),w)n.host=e.host||""===e.host?e.host:n.host,n.hostname=e.hostname||""===e.hostname?e.hostname:n.hostname,n.search=e.search,n.query=e.query,T=p;else if(p.length)T||(T=[]),T.pop(),T=T.concat(p),n.search=e.search,n.query=e.query;else if(!s.isNullOrUndefined(e.search))return E&&(n.hostname=n.host=T.shift(),(R=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=R.shift(),n.host=n.hostname=R.shift())),n.search=e.search,n.query=e.query,s.isNull(n.pathname)&&s.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n;if(!T.length)return n.pathname=null,n.search?n.path="/"+n.search:n.path=null,n.href=n.format(),n;for(var I=T.slice(-1)[0],k=(n.host||e.host||T.length>1)&&("."===I||".."===I)||""===I,A=0,_=T.length;_>=0;_--)"."===(I=T[_])?T.splice(_,1):".."===I?(T.splice(_,1),A++):A&&(T.splice(_,1),A--);if(!S&&!C)for(;A--;A)T.unshift("..");!S||""===T[0]||T[0]&&"/"===T[0].charAt(0)||T.unshift(""),k&&"/"!==T.join("/").substr(-1)&&T.push("");var R,O=""===T[0]||T[0]&&"/"===T[0].charAt(0);return E&&(n.hostname=n.host=O?"":T.length?T.shift():"",(R=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=R.shift(),n.host=n.hostname=R.shift())),(S=S||n.host&&T.length)&&!O&&T.unshift(""),T.length?n.pathname=T.join("/"):(n.pathname=null,n.path=null),s.isNull(n.pathname)&&s.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=e.auth||n.auth,n.slashes=n.slashes||e.slashes,n.href=n.format(),n},i.prototype.parseHost=function(){var e=this.host,t=o.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},{"./util":77,punycode:51,querystring:54}],77:[function(e,t,n){t.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},{}],78:[function(e,t,n){(function(e){(function(){function n(e,t){if(r("noDeprecation"))return e;var n=!1;function s(){if(!n){if(r("throwDeprecation"))throw new Error(t);r("traceDeprecation")?console.trace(t):console.warn(t),n=!0}return e.apply(this,arguments)}return s}function r(t){try{if(!e.localStorage)return!1}catch(e){return!1}var n=e.localStorage[t];return null!=n&&"true"===String(n).toLowerCase()}t.exports=n}).call(this)}).call(this,void 0!==pt?pt:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],79:[function(e,t,n){function r(e,t){if(e&&t)return r(e)(t);if("function"!=typeof e)throw new TypeError("need wrapper function");return Object.keys(e).forEach((function(t){n[t]=e[t]})),n;function n(){for(var t=new Array(arguments.length),n=0;n<t.length;n++)t[n]=arguments[n];var r=e.apply(this,t),s=t[t.length-1];return"function"==typeof r&&r!==s&&Object.keys(s).forEach((function(e){r[e]=s[e]})),r}}t.exports=r},{}],80:[function(e,t,n){t.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}},{}],81:[function(e,t,n){t.exports=s;var r=Object.prototype.hasOwnProperty;function s(){for(var e={},t=0;t<arguments.length;t++){var n=arguments[t];for(var s in n)r.call(n,s)&&(e[s]=n[s])}return e}},{}],82:[function(e,t,n){t.exports=function(e){e.prototype[Symbol.iterator]=function*(){for(let e=this.head;e;e=e.next)yield e.value}}},{}],83:[function(e,t,n){function r(e){var t=this;if(t instanceof r||(t=new r),t.tail=null,t.head=null,t.length=0,e&&"function"==typeof e.forEach)e.forEach((function(e){t.push(e)}));else if(arguments.length>0)for(var n=0,s=arguments.length;n<s;n++)t.push(arguments[n]);return t}function s(e,t,n){var r=t===e.head?new o(n,null,t,e):new o(n,t,t.next,e);return null===r.next&&(e.tail=r),null===r.prev&&(e.head=r),e.length++,r}function i(e,t){e.tail=new o(t,e.tail,null,e),e.head||(e.head=e.tail),e.length++}function a(e,t){e.head=new o(t,null,e.head,e),e.tail||(e.tail=e.head),e.length++}function o(e,t,n,r){if(!(this instanceof o))return new o(e,t,n,r);this.list=r,this.value=e,t?(t.next=this,this.prev=t):this.prev=null,n?(n.prev=this,this.next=n):this.next=null}t.exports=r,r.Node=o,r.create=r,r.prototype.removeNode=function(e){if(e.list!==this)throw new Error("removing node which does not belong to this list");var t=e.next,n=e.prev;return t&&(t.prev=n),n&&(n.next=t),e===this.head&&(this.head=t),e===this.tail&&(this.tail=n),e.list.length--,e.next=null,e.prev=null,e.list=null,t},r.prototype.unshiftNode=function(e){if(e!==this.head){e.list&&e.list.removeNode(e);var t=this.head;e.list=this,e.next=t,t&&(t.prev=e),this.head=e,this.tail||(this.tail=e),this.length++}},r.prototype.pushNode=function(e){if(e!==this.tail){e.list&&e.list.removeNode(e);var t=this.tail;e.list=this,e.prev=t,t&&(t.next=e),this.tail=e,this.head||(this.head=e),this.length++}},r.prototype.push=function(){for(var e=0,t=arguments.length;e<t;e++)i(this,arguments[e]);return this.length},r.prototype.unshift=function(){for(var e=0,t=arguments.length;e<t;e++)a(this,arguments[e]);return this.length},r.prototype.pop=function(){if(this.tail){var e=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}},r.prototype.shift=function(){if(this.head){var e=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}},r.prototype.forEach=function(e,t){t=t||this;for(var n=this.head,r=0;null!==n;r++)e.call(t,n.value,r,this),n=n.next},r.prototype.forEachReverse=function(e,t){t=t||this;for(var n=this.tail,r=this.length-1;null!==n;r--)e.call(t,n.value,r,this),n=n.prev},r.prototype.get=function(e){for(var t=0,n=this.head;null!==n&&t<e;t++)n=n.next;if(t===e&&null!==n)return n.value},r.prototype.getReverse=function(e){for(var t=0,n=this.tail;null!==n&&t<e;t++)n=n.prev;if(t===e&&null!==n)return n.value},r.prototype.map=function(e,t){t=t||this;for(var n=new r,s=this.head;null!==s;)n.push(e.call(t,s.value,this)),s=s.next;return n},r.prototype.mapReverse=function(e,t){t=t||this;for(var n=new r,s=this.tail;null!==s;)n.push(e.call(t,s.value,this)),s=s.prev;return n},r.prototype.reduce=function(e,t){var n,r=this.head;if(arguments.length>1)n=t;else{if(!this.head)throw new TypeError("Reduce of empty list with no initial value");r=this.head.next,n=this.head.value}for(var s=0;null!==r;s++)n=e(n,r.value,s),r=r.next;return n},r.prototype.reduceReverse=function(e,t){var n,r=this.tail;if(arguments.length>1)n=t;else{if(!this.tail)throw new TypeError("Reduce of empty list with no initial value");r=this.tail.prev,n=this.tail.value}for(var s=this.length-1;null!==r;s--)n=e(n,r.value,s),r=r.prev;return n},r.prototype.toArray=function(){for(var e=new Array(this.length),t=0,n=this.head;null!==n;t++)e[t]=n.value,n=n.next;return e},r.prototype.toArrayReverse=function(){for(var e=new Array(this.length),t=0,n=this.tail;null!==n;t++)e[t]=n.value,n=n.prev;return e},r.prototype.slice=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var n=new r;if(t<e||t<0)return n;e<0&&(e=0),t>this.length&&(t=this.length);for(var s=0,i=this.head;null!==i&&s<e;s++)i=i.next;for(;null!==i&&s<t;s++,i=i.next)n.push(i.value);return n},r.prototype.sliceReverse=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var n=new r;if(t<e||t<0)return n;e<0&&(e=0),t>this.length&&(t=this.length);for(var s=this.length,i=this.tail;null!==i&&s>t;s--)i=i.prev;for(;null!==i&&s>e;s--,i=i.prev)n.push(i.value);return n},r.prototype.splice=function(e,t,...n){e>this.length&&(e=this.length-1),e<0&&(e=this.length+e);for(var r=0,i=this.head;null!==i&&r<e;r++)i=i.next;var a=[];for(r=0;i&&r<t;r++)a.push(i.value),i=this.removeNode(i);for(null===i&&(i=this.tail),i!==this.head&&i!==this.tail&&(i=i.prev),r=0;r<n.length;r++)i=s(this,i,n[r]);return a},r.prototype.reverse=function(){for(var e=this.head,t=this.tail,n=e;null!==n;n=n.prev){var r=n.prev;n.prev=n.next,n.next=r}return this.head=t,this.tail=e,this};try{e("./iterator.js")(r)}catch(e){}},{"./iterator.js":82}]},{},[12])(12)}(Da);var xa=gt(Da.exports);class Pa{constructor(){this.store={},this.store={}}clear(){this.store={}}getItem(e){return this.store[e]||null}setItem(e,t){this.store[e]=String(t)}removeItem(e){delete this.store[e]}get length(){return Object.keys(this.store).length}key(e){return Object.keys(this.store)[e]||null}}const Ma=()=>"undefined"!=typeof window&&window.localStorage?window:{localStorage:new Pa};var Fa={},Ua={},Na={};Object.defineProperty(Na,"__esModule",{value:!0}),Na.bytesToString=Na.stringToBytes=Na.NIL=Na.X500=Na.OID=Na.URL=Na.DNS=Na.hexToByte=Na.byteToHex=void 0;let Ba=[],ja={};for(var $a=0;$a<256;$a++)Ba[$a]=($a+256).toString(16).substr(1),ja[Ba[$a]]=$a;Na.byteToHex=Ba,Na.hexToByte=ja,Na.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",Na.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",Na.OID="6ba7b812-9dad-11d1-80b4-00c04fd430c8",Na.X500="6ba7b814-9dad-11d1-80b4-00c04fd430c8",Na.NIL="00000000-0000-0000-0000-000000000000";Na.stringToBytes=e=>{e=unescape(encodeURIComponent(e));const t=new Uint8Array(e.length);for(let n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t};Na.bytesToString=e=>{const t=new Uint8Array(e,0,e.byteLength);return String.fromCharCode.apply(null,Array.from(t))},Object.defineProperty(Ua,"__esModule",{value:!0}),Ua.parse=void 0;const qa=Na;Ua.parse=(e,t,n)=>{let r=t&&n||0,s=0;for(t=t||[],e.toLowerCase().replace(/[0-9a-f]{2}/g,(e=>(s<16&&t&&(t[r+s++]=qa.hexToByte[e]),"")));s<16;)t[r+s++]=0;return t};var Ka={};Object.defineProperty(Ka,"__esModule",{value:!0}),Ka.unparse=void 0;const Ga=Na;Ka.unparse=(e,t)=>{let n=t||0,r=Ga.byteToHex;return r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]};var Ha={},Va={};Object.defineProperty(Va,"__esModule",{value:!0});Va.default=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;var za=pt&&pt.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Ha,"__esModule",{value:!0}),Ha.validate=void 0;const Wa=za(Va);Ha.validate=e=>"string"==typeof e&&Wa.default.test(e);var Ya={};Object.defineProperty(Ya,"__esModule",{value:!0}),Ya.version=void 0;const Qa=Ha;Ya.version=e=>{if(!Qa.validate(e))throw TypeError("Invalid UUID");return parseInt(e.substr(14,1),16)};var Xa={},Ja={};Object.defineProperty(Ja,"__esModule",{value:!0}),Ja.stringify=void 0;const Za=Ha,eo=[];for(let e=0;e<256;++e)eo.push((e+256).toString(16).substr(1));Ja.stringify=(e,t=0)=>{const n=(eo[e[t+0]]+eo[e[t+1]]+eo[e[t+2]]+eo[e[t+3]]+"-"+eo[e[t+4]]+eo[e[t+5]]+"-"+eo[e[t+6]]+eo[e[t+7]]+"-"+eo[e[t+8]]+eo[e[t+9]]+"-"+eo[e[t+10]]+eo[e[t+11]]+eo[e[t+12]]+eo[e[t+13]]+eo[e[t+14]]+eo[e[t+15]]).toLowerCase();if(!Za.validate(n))throw TypeError("Stringified UUID is invalid");return n};var to={};Object.defineProperty(to,"__esModule",{value:!0}),to.rng=void 0;to.rng=()=>{let e=new Array(16);for(let t=0;t<16;t++)e[t]=255&256*Math.random()+0;return e},Object.defineProperty(Xa,"__esModule",{value:!0}),Xa.v1=void 0;const no=Ja,ro=to;let so,io,ao=0,oo=0;Xa.v1=(e,t,n=0)=>{let r=t&&n||0;const s=t||new Uint8Array(16);let i=e&&e.node?e.node:so,a=e&&e.clockseq?e.clockseq:io;if(null==i||null==a){const t=e&&e.random?e.random:e&&e.rng?e.rng():ro.rng();null==i&&(i=so=[1|t[0],t[1],t[2],t[3],t[4],t[5]]),null==a&&(a=io=16383&(t[6]<<8|t[7]))}let o=e&&e.msecs?e.msecs:Date.now(),l=e&&e.nsecs?e.nsecs:oo+1;const c=o-ao+(l-oo)/1e4;if(c<0&&e&&!e.clockseq&&(a=a+1&16383),(c<0||o>ao)&&e&&!e.nsecs&&(l=0),l>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");ao=o,oo=l,io=a,o+=122192928e5;const d=(1e4*(268435455&o)+l)%4294967296;s[r++]=d>>>24&255,s[r++]=d>>>16&255,s[r++]=d>>>8&255,s[r++]=255&d;const u=o/4294967296*1e4&268435455;s[r++]=u>>>8&255,s[r++]=255&u,s[r++]=u>>>24&15|16,s[r++]=u>>>16&255,s[r++]=a>>>8|128,s[r++]=255&a;for(let e=0;e<6;++e)s[r+e]=i[e];return t||no.stringify(s)};var lo={};Object.defineProperty(lo,"__esModule",{value:!0}),lo.v4=void 0;const co=Ka,uo=to;lo.v4=(e,t,n)=>{let r=t&&n||0,s=uo.rng();if(!e||e instanceof String||(e.random&&(s=e.random),e.rng&&(s=e.rng())),s[6]=15&s[6]|64,s[8]=63&s[8]|128,t)for(var i=0;i<16;i++)t[r+i]=s[i];return t||co.unparse(s)};var ho={},fo={};Object.defineProperty(fo,"__esModule",{value:!0}),fo.v35=void 0;const po=Ja,go=Ua,mo=Na;fo.v35=(e,t,n)=>(e,r,s,i=0)=>{if("string"==typeof e&&(e=mo.stringToBytes(e)),"string"==typeof r&&(r=go.parse(r)),r&&16!==r.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let a=new Uint8Array(16+e.length);if(a.set(r),a.set(e,r.length),a=mo.stringToBytes(n(mo.bytesToString(a))),a[6]=15&a[6]|t,a[8]=63&a[8]|128,s)for(let e=0;e<16;++e)s[i+e]=a[e];return s||po.stringify(a)};var yo={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.any_hmac_sha1=e.b64_hmac_sha1=e.hex_hmac_sha1=e.any_sha1=e.b64_sha1=e.hex_sha1=void 0;let t=0,n="";e.hex_sha1=e=>i(r(l(e))),e.default=e.hex_sha1;e.b64_sha1=e=>a(r(l(e)));e.any_sha1=(e,t)=>o(r(l(e)),t);e.hex_hmac_sha1=(e,t)=>i(s(l(e),l(t)));e.b64_hmac_sha1=(e,t)=>a(s(l(e),l(t)));e.any_hmac_sha1=(e,t,n)=>o(s(l(e),l(t)),n);const r=e=>d(u(c(e),8*e.length)),s=(e,t)=>{let n=c(e);n.length>16&&(n=u(n,8*e.length));let r=Array(16),s=Array(16);for(var i=0;i<16;i++)r[i]=909522486^n[i],s[i]=1549556828^n[i];var a=u(r.concat(c(t)),512+8*t.length);return d(u(s.concat(a),672))},i=e=>{for(var n,r=t?"0123456789ABCDEF":"0123456789abcdef",s="",i=0;i<e.length;i++)n=e.charCodeAt(i),s+=r.charAt(n>>>4&15)+r.charAt(15&n);return s},a=e=>{for(var t="",r=e.length,s=0;s<r;s+=3)for(var i=e.charCodeAt(s)<<16|(s+1<r?e.charCodeAt(s+1)<<8:0)|(s+2<r?e.charCodeAt(s+2):0),a=0;a<4;a++)8*s+6*a>8*e.length?t+=n:t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(i>>>6*(3-a)&63);return t},o=(e,t)=>{var n,r,s,i,a=t.length,o=[],l=Array(Math.ceil(e.length/2));for(n=0;n<l.length;n++)l[n]=e.charCodeAt(2*n)<<8|e.charCodeAt(2*n+1);for(;l.length>0;){for(i=[],s=0,n=0;n<l.length;n++)s=(s<<16)+l[n],s-=(r=Math.floor(s/a))*a,(i.length>0||r>0)&&(i[i.length]=r);o[o.length]=s,l=i}var c="";for(n=o.length-1;n>=0;n--)c+=t.charAt(o[n]);var d=Math.ceil(8*e.length/(Math.log(t.length)/Math.log(2)));for(n=c.length;n<d;n++)c=t[0]+c;return c},l=e=>{for(var t,n,r="",s=-1;++s<e.length;)t=e.charCodeAt(s),n=s+1<e.length?e.charCodeAt(s+1):0,t>=55296&&t<=56319&&n>=56320&&n<=57343&&(t=65536+((1023&t)<<10)+(1023&n),s++),t<=127?r+=String.fromCharCode(t):t<=2047?r+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?r+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(r+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return r},c=e=>{for(var t=Array(e.length>>2),n=0;n<t.length;n++)t[n]=0;for(n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<24-n%32;return t},d=e=>{for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>24-n%32&255);return t},u=(e,t)=>{e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var n=Array(80),r=1732584193,s=-271733879,i=-1732584194,a=271733878,o=-1009589776,l=0;l<e.length;l+=16){for(var c=r,d=s,u=i,m=a,y=o,v=0;v<80;v++){n[v]=v<16?e[l+v]:g(n[v-3]^n[v-8]^n[v-14]^n[v-16],1);let t=p(p(g(r,5),h(v,s,i,a)),p(p(o,n[v]),f(v)));o=a,a=i,i=g(s,30),s=r,r=t}r=p(r,c),s=p(s,d),i=p(i,u),a=p(a,m),o=p(o,y)}return[r,s,i,a,o]},h=(e,t,n,r)=>e<20?t&n|~t&r:e<40?t^n^r:e<60?t&n|t&r|n&r:t^n^r,f=e=>e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514,p=(e,t)=>{var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n},g=(e,t)=>e<<t|e>>>32-t}(yo);var vo=pt&&pt.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ho,"__esModule",{value:!0}),ho.v5=void 0;const bo=fo,wo=vo(yo);ho.v5=bo.v35("v5",80,wo.default),Object.defineProperty(Fa,"__esModule",{value:!0});const So=Ua,Co=Ka,To=Ha,Eo=Ya,Io=Xa,ko=lo,Ao=ho,_o=Na;var Ro=Fa.default={parse:So.parse,unparse:Co.unparse,validate:To.validate,version:Eo.version,v1:Io.v1,v4:ko.v4,v5:Ao.v5,NIL:_o.NIL,DNS:_o.DNS,URL:_o.URL,OID:_o.OID,X500:_o.X500};const Oo=()=>Ro.v4().toString();let Lo=0;if("undefined"!=typeof BroadcastChannel&&"undefined"!=typeof window){const e=Oo(),t={},n=new BroadcastChannel("amity_ts_sdk");let r;n.postMessage({type:"startup",tabId:e}),n.onmessage=({data:s})=>{s.tabId!==e&&("startup"===s.type&&n.postMessage({type:"identify",tabId:e,tabIndex:Lo}),"identify"===s.type&&void 0!==s.tabIndex&&s.tabId&&(t[s.tabId]=s.tabIndex,r||(r=setTimeout((()=>{const e=Object.values(t).sort();e&&0!==e.length&&(Lo=e.reduce(((e,t)=>e<t?e:t+1),0))}),15))))}}const Do=async()=>{var e;const t=`${null!==(e=ve().prefixDeviceIdKey)&&void 0!==e?e:""}#deviceId`,n=await(async e=>new Promise((t=>{t(Ma().localStorage.getItem(e))})))(t);if(n)return n;const r=`ascWebSdk#${Oo()}`;return await(async(e,t)=>new Promise((n=>{Ma().localStorage.setItem(e,t),n(!0)})))(t,r),r},xo=()=>{const e=(()=>{var e,t;return(null===(e=It.versions)||void 0===e?void 0:e.node)?It.versions.node:navigator?`${navigator.product.toLowerCase()}#${null!==(t=navigator.userAgent)&&void 0!==t?t:"unknown_agent"}`:"unknown_model"})();return{kind:"web",model:e,sdkVersion:h}},Po=1e3;var Mo;!function(e){e[e.IDENTIFIER_REJECTED=2]="IDENTIFIER_REJECTED",e[e.BAD_USERNAME_OR_PASSWORD=134]="BAD_USERNAME_OR_PASSWORD",e[e.NOT_AUTHORIZED=135]="NOT_AUTHORIZED"}(Mo||(Mo={}));const Fo=e=>{let t;return{connect:async function(n){const r=await(async e=>`mqttjs_${await Do()}_${e}_${Lo}`)(n.userId);return t&&(t.removeAllListeners(),t.end(!0)),t=xa.connect(e,function(e){return Object.assign({clean:!1,clientId:`mqttjs_ + ${Math.random().toString(16).substring(2,10)}`,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:Po,will:{topic:"WillMsg",payload:"Connection Closed abnormally..!",qos:0,retain:!1},resubscribe:!0},e)}({username:n.userId,password:n.accessToken,clientId:r})),t.on("connect",(()=>{t.options.reconnectPeriod=Po,(()=>{const e=[ht(lt()),ht(ct()),ht(dt()),ht(ut()),ht(it(Ke())),ht(ot()),ht(ft())]})()})),t.on("error",(e=>{switch(e.code){case 2:case 134:case 135:t.end()}})),t.on("reconnect",(()=>{t.options.reconnectPeriod=Math.min(2*(t.options.reconnectPeriod||Po),8e3)})),new Promise((e=>t.once("connect",(()=>e()))))},async disconnect(){if(this.connected)return new Promise((e=>null==t?void 0:t.end(!0,void 0,(()=>e()))))},get connected(){return!!(null==t?void 0:t.connected)},on(e,n){null==t||t.on(e,n)},once(e,n){null==t||t.once(e,n)},off(e,n){void 0!==n?null==t||t.off(e,n):null==t||t.removeAllListeners(e)},removeAllListeners(){null==t||t.removeAllListeners()},subscribe(e,n){const r=(t,r)=>{var s;if(t||128===(null===(s=r[0])||void 0===s?void 0:s.qos)){const r=t?new fe(t.message,8e5,"error"):new ge(8e5,"error");console.warn(`Failed to subscribe to topic ${e}`,r),null==n||n(r)}else console.log(`Subscribed to topic ${e}`),null==n||n()};return t?t.subscribe(e,{qos:0},r):r(new Error("No connection to broker"),[]),()=>null==t?void 0:t.unsubscribe(e)},unsubscribe(e){null==t||t.unsubscribe(e)}}},Uo=(e={},t,n=!0)=>{Object.entries(e).forEach((([e,r])=>{const s=ue[e];if(!s)return;const i=de(s);i&&r.forEach((e=>{(n?Ce:Ee)([s,"get",i(e)],e,t)}))}))},No=(e,t)=>{const{log:n,cache:r}=ve(),s=[e,w,t],i={cachedAt:Date.now()};r&&(n("cache/api/pushToTombstone",{cacheKey:s,data:i}),Ie([e,"get",t],!0),Ce(s,i))};function Bo(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(n[r[s]]=e[r[s]])}return n}const jo=(e,t="userId",n="user")=>{var r;return null!==(r=null==e?void 0:e.map((e=>((e,t="userId",n="user")=>e[n]?e:Object.assign({get[n](){var n;if(!ve().cache)return;return(null===(n=Se(["user","get",e[t]]))||void 0===n?void 0:n.data)||void 0}},e))(e,t,n))))&&void 0!==r?r:e},$o=(e,t,n="userId",r="user")=>{const s=e,i=t,a=s[i],o=Bo(s,["symbol"==typeof i?i:i+""]),l=jo(a,n,r);return Object.assign(Object.assign({},o),{[t]:l})};function qo(e){return e.map((e=>{var{isMentioned:t}=e,n=Bo(e,["isMentioned"]);return Object.assign({hasMentioned:t},n)}))}function Ko(e){return qo(e)}function Go(e){return qo(e)}const Ho=e=>{var t,n;return null!==(n=null===(t=Se(["messagePreviewChannel","get",e]))||void 0===t?void 0:t.data)&&void 0!==n?n:null},Vo=["analytic","normal-priority"],zo=["analytic","high-priority"],Wo=async e=>{const t=ve(),n={activities:e};await t.http.post("/api/v1/analytics/activities",n)};class Yo{constructor(){this._timer=void 0,this._high_priority_timer=void 0}start(){this.syncCapturedEvent(),this._timer=setInterval((()=>{this.syncCapturedEvent()}),6e4),this._high_priority_timer=setInterval((()=>{this.syncHighPriorityCapturedEvent()}),1e4)}stop(){this._timer&&(clearInterval(this._timer),this._timer=void 0),this._high_priority_timer&&(clearInterval(this._high_priority_timer),this._high_priority_timer=void 0)}async syncCapturedEvent(){try{const e=Se(Vo);if(!(null==e?void 0:e.data))return;if(0===e.data.event.length)return;const t=e.data.event;await Wo(t),Ie(Vo)}catch(e){this.stop(),Ie(Vo)}}async syncHighPriorityCapturedEvent(){try{const e=Se(zo);if(!(null==e?void 0:e.data))return;if(0===e.data.event.length)return;const t=e.data.event;await Wo(t),Ie(zo)}catch(e){this.stop(),Ie(zo)}}}class Qo{constructor(){this._expireTime=3e5,this._poolLimit=1e3,this._recentViewed={},this._recentHighPriorityViewed={},this._throttleStoryTimer=void 0,this._bufferNewSeenStoryReferenceIds=[]}isAbleToEnqueue({uniqueId:e,expireTime:t,isHighPriority:n=!1}){const r=new Date,s=n?this._recentHighPriorityViewed[e]:this._recentViewed[e];if(!s)return!0;return!(r.getTime()-s.getTime()<t)}markAs({uniqueId:e,contentId:t,contentType:n,activityType:r,metadata:s}){if(!this.isAbleToEnqueue({uniqueId:e,expireTime:this._expireTime}))return;const i=new Date,a={event:[]},o=Se(Vo);(null==o?void 0:o.data)&&(a.event=o.data.event),a.event.length>=this._poolLimit&&a.event.shift();const l={contentId:t,contentType:n,activityType:r,timestamp:i.toISOString()};s&&(l.metadata=s),a.event.push(l),Ee(Vo,a),this._recentViewed[e]=i}markPostAsViewed(e){this.markAs({uniqueId:e,contentId:e,contentType:"post",activityType:"view"})}markStory(e,t){if(!e.expiresAt)return;const n=new Date,r=new Date(e.expiresAt);if(!this.isAbleToEnqueue({uniqueId:e.storyId,expireTime:r.getTime(),isHighPriority:!0}))return;const s={event:[]},i=Se(zo);if((null==i?void 0:i.data)&&(s.event=i.data.event),s.event.length>=this._poolLimit&&s.event.shift(),s.event.push({contentId:e.storyId,contentType:"story",activityType:t,timestamp:n.toISOString()}),Ee(zo,s),this._recentHighPriorityViewed[e.storyId]=n,"linkClicked"===t)return;Ce(["story-seen","get",e.storyId],(new Date).toISOString());const a=Se(["story-last-seen",e.targetId]);(null==a?void 0:a.data)?new Date(a.data).getTime()<new Date(e.expiresAt).getTime()&&Ce(["story-last-seen",e.targetId],e.expiresAt):Ce(["story-last-seen",e.targetId],e.expiresAt),this._bufferNewSeenStoryReferenceIds.push(e.referenceId),this._throttleStoryTimer||(this._throttleStoryTimer=setTimeout((()=>{clearTimeout(this._throttleStoryTimer),Je("local.story.reload",{referenceIds:this._bufferNewSeenStoryReferenceIds}),this._bufferNewSeenStoryReferenceIds=[]}),300))}resetAllBuckets(){this._recentViewed={},this._recentHighPriorityViewed={},Ie(Vo),Ie(zo)}markStoryAsViewed(e){this.markStory(e,"view")}markStoryAsClicked(e){this.markStory(e,"linkClicked")}markAdAsViewed(e,t){const n={placement:t},r="view";this.markAs({uniqueId:`${e.adId}.view.${t}`,contentId:e.adId,contentType:"ad",activityType:r,metadata:n})}markAdAsClicked(e,t){const n={placement:t},r="linkClicked";this.markAs({uniqueId:`${e.adId}.linkClicked.${t}`,contentId:e.adId,contentType:"ad",activityType:r,metadata:n})}}class Xo{constructor(){this._client=ve(),this._eventCapturer=new Qo,this._eventSyncer=new Yo}markPostAsViewed(e){"established"!==this._client.sessionState&&"tokenExpired"!==this._client.sessionState||this._eventCapturer.markPostAsViewed(e)}markStoryAsViewed(e){"established"!==this._client.sessionState&&"tokenExpired"!==this._client.sessionState||this._eventCapturer.markStoryAsViewed(e)}markAdAsViewed(e,t){"established"!==this._client.sessionState&&"tokenExpired"!==this._client.sessionState||this._eventCapturer.markAdAsViewed(e,t)}markAdAsClicked(e,t){"established"!==this._client.sessionState&&"tokenExpired"!==this._client.sessionState||this._eventCapturer.markAdAsClicked(e,t)}markStoryAsClicked(e){"established"!==this._client.sessionState&&"tokenExpired"!==this._client.sessionState||this._eventCapturer.markStoryAsClicked(e)}established(){this._eventSyncer.start()}handleTokenExpired(){this._stopAndDestroy()}destroy(){this._stopAndDestroy()}_stopAndDestroy(){this._eventSyncer.stop(),this._eventCapturer.resetAllBuckets()}}let Jo;var Zo=()=>(Jo||(Jo=new Xo),Jo);const el=e=>Object.assign(Object.assign({},e),{get avatar(){var t;if(!e.avatarFileId)return;return null===(t=Se(["file","get",`${e.avatarFileId}`]))||void 0===t?void 0:t.data}});class tl{constructor(e,t,n){this._syncingStoriesCount=0,this._errorStoriesCount=0,this._targetId=e,this._lastStoryExpiresAt=t,this._lastStorySeenExpiresAt=n,this.cacheStoryExpireTime=Se(["story-expire",this._targetId]),this.cacheStoreSeenTime=Se(["story-last-seen",this._targetId]),this.getTotalStoryByStatus()}get lastStoryExpiresAt(){return this._lastStoryExpiresAt?new Date(this._lastStoryExpiresAt).getTime():0}get lastStorySeenExpiresAt(){return this._lastStorySeenExpiresAt?new Date(this._lastStorySeenExpiresAt).getTime():0}get localLastStoryExpires(){var e,t;return(null===(e=this.cacheStoryExpireTime)||void 0===e?void 0:e.data)?new Date(null===(t=this.cacheStoryExpireTime)||void 0===t?void 0:t.data).getTime():0}get localLastStorySeenExpiresAt(){var e,t;return(null===(e=this.cacheStoreSeenTime)||void 0===e?void 0:e.data)?new Date(null===(t=this.cacheStoreSeenTime)||void 0===t?void 0:t.data).getTime():0}get isContainUnSyncedStory(){const e=Se(["story-sync-state",this._targetId]);return!!(null==e?void 0:e.data)&&["syncing","error"].includes(e.data)}getLocalLastSortingDate(){return this.isContainUnSyncedStory?this.localLastStoryExpires:this.lastStoryExpiresAt}getHasUnseenFlag(){const e=(new Date).getTime(),t=Math.max(this.lastStorySeenExpiresAt,this.localLastStorySeenExpiresAt);return Se(["story-sync-state",this._targetId]),this.isContainUnSyncedStory?this.localLastStoryExpires>e&&this.localLastStoryExpires>t:this.lastStoryExpiresAt>e&&this.lastStoryExpiresAt>t}getTotalStoryByStatus(){const e=we(["story","get"]);if(!e)return this._errorStoriesCount=0,void(this._syncingStoriesCount=0);const t=e.reduce(((e,t)=>{const{data:{targetId:n,syncState:r,isDeleted:s}}=t;return n!==this._targetId||s||(e[r]+=1),e}),{syncing:0,error:0,synced:0});this._errorStoriesCount=t.error,this._syncingStoriesCount=t.syncing}get syncingStoriesCount(){return this._syncingStoriesCount}get failedStoriesCount(){return this._errorStoriesCount}}const nl=e=>{const{targetType:t,targetId:n,lastStoryExpiresAt:r,lastStorySeenExpiresAt:s,targetUpdatedAt:i,localFilter:a}=e,o=new tl(n,r,s);return{targetType:t,targetId:n,lastStoryExpiresAt:r,updatedAt:i,hasUnseen:o.getHasUnseenFlag(),syncingStoriesCount:o.syncingStoriesCount,failedStoriesCount:o.failedStoriesCount,localFilter:a,localLastExpires:o.localLastStoryExpires,localLastSeen:o.localLastStorySeenExpiresAt,localSortingDate:o.getLocalLastSortingDate()}};function rl(e,t){if(null==e||null==t)return e===t;if(e.constructor!==t.constructor)return!1;if(e instanceof Function)return e===t;if(e instanceof RegExp)return e===t;if(e===t||e.valueOf()===t.valueOf())return!0;if(Array.isArray(e)&&e.length!==t.length)return!1;if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n+=1)if(!rl(e[n],t[n]))return!1;return!0}if(e instanceof Date)return!1;if(!(e instanceof Object))return!1;if(!(t instanceof Object))return!1;const n=Object.keys(e);return Object.keys(t).every((e=>-1!==n.indexOf(e)))&&n.every((n=>rl(e[n],t[n])))}function sl(e){return null!=e}const il=e=>Object.assign(Object.assign({},e),{get target(){const t={type:e.targetType};if("user"===e.targetType)return Object.assign(Object.assign({},t),{userId:e.targetId});if("content"===t.type)return Object.assign(Object.assign({},t),{contentId:e.targetId});if("community"===t.type){const n=Se(["communityUsers","get",`${e.targetId}#${e.userId}`]);return Object.assign(Object.assign({},t),{communityId:e.targetId,creatorMember:null==n?void 0:n.data})}return{type:"unknown"}},get creator(){const t=Se(["user","get",e.userId]);if(null==t?void 0:t.data)return el(t.data)},get childrenComment(){return e.children.map((e=>{const t=Se(["comment","get",e]);if(null==t?void 0:t.data)return null==t?void 0:t.data})).filter(sl).map((e=>il(e)))}}),al=e=>Object.assign(Object.assign({},e),{analytics:{markAsViewed:()=>{Zo().markPostAsViewed(e.postId)}},get latestComments(){return e.comments&&e.comments.map((e=>{var t;const n=null===(t=Se(["comment","get",e]))||void 0===t?void 0:t.data;return n?il(n):null})).filter(Boolean)||[]},get creator(){const t=Se(["user","get",e.postedUserId]);if(null==t?void 0:t.data)return el(t.data)}}),ol=(e,t)=>{var n;return null!==(n=null!=t?t:(e=>{var t,n;const r={creatorId:"creatorPrivateId"in e?e.creatorPrivateId:e.creatorId,feedId:null!==(t=e.messageFeedId)&&void 0!==t?t:e.subChannelId,contentId:e.messageId};return null===(n=Se(["messageMarker","get",de("messageMarker")(r)]))||void 0===n?void 0:n.data})(e))&&void 0!==n?n:{readCount:0,deliveredCount:0}};class ll{constructor(){this.isActive=!0,this.MAX_RETRY=3,this.JOB_QUEUE_SIZE=120,this.jobQueue=[],this.RECEIPT_SYNC_INTERVAL=1,this.client=ve(),this.getUnsyncJobs()}startSyncReadReceipt(){this.timer=setInterval((()=>{this.syncReadReceipts()}),1e3*this.RECEIPT_SYNC_INTERVAL)}syncReadReceipts(){if(0===this.jobQueue.length||!1===this.isActive)return;const e=this.getReadReceipts();e&&this.markReadApi(e)}getUnsyncJobs(){var e;const t=null===(e=we(["readReceipt"]))||void 0===e?void 0:e.filter((({data:e})=>e.latestSyncSegment<e.latestSegment));null==t||t.forEach((({data:e})=>{this.enqueueReadReceipt(e.channelId,e.latestSegment)}))}getReadReceipts(){const e=this.jobQueue.splice(0,this.jobQueue.length);if(0!==e.length)return e.filter((e=>{var t;const n=null===(t=Se(["readReceipt",e.channelId]))||void 0===t?void 0:t.data;return!!n&&n.latestSegment>n.latestSyncSegment}))}async markReadApi(e){var t;const n=e.map((e=>({channelId:e.channelId,readToSegment:e.segment})));if(await(async e=>{const t=ve();try{return await t.http.post("api/v3/channels/seen",{channels:e}),!0}catch(e){return!1}})(n))for(let n=0;n<e.length;n+=1){const r=["readReceipt",e[n].channelId],s=null===(t=Se(r))||void 0===t?void 0:t.data;Ce(r,Object.assign(Object.assign({},s),{latestSyncSegment:e[n].segment}))}else for(let t=0;t<e.length;t+=1){if(e[t].retryCount>=this.MAX_RETRY)return;const n=Object.assign(Object.assign({},e[t]),{syncState:"create",retryCount:e[t].retryCount+1});this.enqueueJob(n)}}startObservingReadReceiptQueue(){this.client.useLegacyUnreadCount&&(this.isActive=!0,this.startSyncReadReceipt())}stopObservingReadReceiptQueue(){this.isActive=!1,this.jobQueue.map((e=>"syncing"===e.syncState?Object.assign(Object.assign({},e),{syncState:"create"}):e)),this.timer&&clearInterval(this.timer)}onSessionEstablished(){this.startObservingReadReceiptQueue()}onSessionDestroyed(){this.stopObservingReadReceiptQueue(),this.jobQueue=[]}onTokenExpired(){this.stopObservingReadReceiptQueue()}onNetworkOffline(){this.stopObservingReadReceiptQueue()}onNetworkOnline(){this.startObservingReadReceiptQueue()}markRead(e,t){var n;const r=["channelUnread","get",e],s=null===(n=Se(r))||void 0===n?void 0:n.data;"number"==typeof(null==s?void 0:s.readToSegment)&&s&&t>s.readToSegment&&(s.readToSegment=t,s.unreadCount=Math.max(s.lastSegment-t,0),Ce(r,s),Je("local.channelUnread.updated",s)),this.enqueueReadReceipt(e,t)}enqueueReadReceipt(e,t){var n;const r=null===(n=Se(["readReceipt",e]))||void 0===n?void 0:n.data;if(r){if(r.latestSegment<t)Ce(["readReceipt",e],Object.assign(Object.assign({},r),{latestSegment:t}));else if(r.latestSyncSegment>=t)return}else{Ce(["readReceipt",e],{channelId:e,latestSegment:t,latestSyncSegment:0})}let s=this.getSyncJob(e);null===s||"syncing"===s.syncState?(s={channelId:e,segment:t,syncState:"create",retryCount:0},this.enqueueJob(s)):s.segment<t&&(s.segment=t)}getSyncJob(e){const{jobQueue:t}=this;return t.find((t=>t.channelId===e))||null}enqueueJob(e){this.jobQueue.length<this.JOB_QUEUE_SIZE||this.jobQueue.shift(),this.jobQueue.push(e)}}let cl=null;var dl=()=>(cl||(cl=new ll),cl);const ul=e=>{var t;const n=["channelUnreadInfo","get",e],r=null===(t=Se(n))||void 0===t?void 0:t.data,s=we(["subChannelUnreadInfo","get"]);let i=0,a=!1;if(s&&(null==s?void 0:s.length)>0){const t=null==s?void 0:s.filter((({data:t})=>t.channelId===e&&!t.isDeleted));i=t.map((({data:e})=>e.unreadCount)).reduce(((e,t)=>e+t),0),a=t.some((({data:e})=>e.isMentioned))}const o=Object.assign(Object.assign({},null!=r?r:{channelId:e,createdAt:(new Date).toISOString()}),{updatedAt:(new Date).toISOString(),unreadCount:i,isMentioned:a});return Ce(n,o),o};class hl{constructor(){this.isActive=!0,this.MAX_RETRY=3,this.JOB_QUEUE_SIZE=120,this.jobQueue=[],this.RECEIPT_SYNC_INTERVAL=1,this.client=ve(),this.getUnsyncJobs()}startSyncReadReceipt(){this.timer=setInterval((()=>{this.syncReadReceipts()}),1e3*this.RECEIPT_SYNC_INTERVAL)}syncReadReceipts(){if(0===this.jobQueue.length||!1===this.isActive)return;const e=this.getReadReceipt();e&&this.markReadApi(e)}getUnsyncJobs(){var e;const t=null===(e=we(["legacyReadReceipt"]))||void 0===e?void 0:e.filter((({data:e})=>e.latestSyncSegment<e.latestSegment));null==t||t.forEach((({data:e})=>{this.enqueueReadReceipt(e.subChannelId,e.latestSegment)}))}getReadReceipt(){var e;const t=this.jobQueue[0];if(!t)return;if("syncing"===t.syncState)return;const n=null===(e=Se(["legacyReadReceipt",t.subChannelId]))||void 0===e?void 0:e.data;return n?(null==n?void 0:n.latestSegment)>(null==n?void 0:n.latestSyncSegment)?(t.segment=n.latestSegment,t):(this.removeSynedReceipt(n.subChannelId,n.latestSegment),this.getReadReceipt()):void 0}async markReadApi(e){var t;const n=e;n.syncState="syncing";const{subChannelId:r,segment:s}=n,i=await(async({subChannelId:e,readToSegment:t})=>{const n=ve();n.log("subChannel/markAsReadBySegment",e);try{return await n.http.put(`/api/v1/markers/message-feeds/${e}/mark-read`,{readToSegment:t}),!0}catch(e){return!1}})({subChannelId:r,readToSegment:s});if(i){this.removeSynedReceipt(e.subChannelId,e.segment);const n=null===(t=Se(["legacyReadReceipt",r]))||void 0===t?void 0:t.data;Ce(["legacyReadReceipt",r],Object.assign(Object.assign({},n),{latestSyncSegment:s}))}else i||(n.retryCount>this.MAX_RETRY?this.removeJobFromQueue(n):(n.retryCount+=1,n.syncState="create"))}removeSynedReceipt(e,t){this.jobQueue.forEach((n=>{n.subChannelId===e&&n.segment<=t&&this.removeJobFromQueue(n)}))}startObservingReadReceiptQueue(){this.client.isUnreadCountEnabled&&(this.isActive=!0,this.startSyncReadReceipt())}stopObservingReadReceiptQueue(){this.isActive=!1;this.jobQueue.map((e=>"syncing"===e.syncState?Object.assign(Object.assign({},e),{syncState:"create"}):e)),this.timer&&clearInterval(this.timer)}onSessionEstablished(){this.startObservingReadReceiptQueue()}onSessionDestroyed(){this.stopObservingReadReceiptQueue(),this.jobQueue=[]}onTokenExpired(){this.stopObservingReadReceiptQueue()}onNetworkOffline(){this.stopObservingReadReceiptQueue()}onNetworkOnline(){this.startObservingReadReceiptQueue()}markRead(e,t){var n;const r=["subChannelUnreadInfo","get",e],s=null===(n=Se(r))||void 0===n?void 0:n.data;if(s&&t>s.readToSegment){s.readToSegment=t,s.unreadCount=Math.max(s.lastSegment-t,0);const e=ul(s.channelId);Je("local.channelUnreadInfo.updated",e),Ce(r,s),Je("local.subChannelUnread.updated",s)}this.enqueueReadReceipt(e,t)}enqueueReadReceipt(e,t){var n;const r=null===(n=Se(["legacyReadReceipt",e]))||void 0===n?void 0:n.data;if(r){if(r.latestSegment<t)Ce(["legacyReadReceipt",e],Object.assign(Object.assign({},r),{latestSegment:t}));else if(r.latestSyncSegment>=t)return}else{Ce(["legacyReadReceipt",e],{subChannelId:e,latestSegment:t,latestSyncSegment:0})}let s=this.getSyncJob(e);null===s||"syncing"===s.syncState?(s={subChannelId:e,segment:t,syncState:"create",retryCount:0},this.enqueueJob(s)):s.segment<t&&(s.segment=t)}getSyncJob(e){return this.jobQueue.find((t=>t.subChannelId===e))||null}enqueueJob(e){this.jobQueue.length<this.JOB_QUEUE_SIZE||this.jobQueue.shift(),this.jobQueue.push(e)}removeJobFromQueue(e){const t=this.jobQueue.indexOf(e);t>-1&&this.jobQueue.splice(t,1)}}let fl=null;var pl=()=>(fl||(fl=new hl),fl);const gl=e=>{if(ve().useLegacyUnreadCount){dl().markRead(e.channelId,e.channelSegment)}else{pl().markRead(e.subChannelId,e.channelSegment)}};function ml(e,t){return Object.create(Object.getPrototypeOf(e),Object.assign(Object.assign({},Object.getOwnPropertyDescriptors(e)),Object.getOwnPropertyDescriptors(t)))}const yl={ad:e=>{const t=Zo(),{image9_16:n,image1_1:r}=e,s=Bo(e,["image9_16","image1_1"]);return Object.assign(Object.assign({},s),{analytics:{markAsSeen:n=>{t.markAdAsViewed(e,n)},markLinkAsClicked:n=>{t.markAdAsClicked(e,n)}},get advertiser(){var t,n;const r=null===(t=Se(["advertiser","get",e.advertiserId]))||void 0===t?void 0:t.data;if(!r)return;const s=null===(n=Se(["file","get",r.avatarFileId]))||void 0===n?void 0:n.data;return Object.assign(Object.assign({},r),{avatar:s})},get image1_1(){const e=Se(["file","get",r]);if(e)return e.data||void 0},get image9_16(){const e=Se(["file","get",n]);if(e)return e.data||void 0}})},comment:il,post:al,user:el,category:e=>Object.assign(Object.assign({},e),{get avatar(){var t;if(!e.avatarFileId)return;return null===(t=Se(["file","get",`${e.avatarFileId}`]))||void 0===t?void 0:t.data}}),stream:e=>Object.assign(Object.assign({},e),{get moderation(){var t;return null===(t=Se(["streamModeration","get",e.streamId]))||void 0===t?void 0:t.data},get post(){var t;if("post"===e.referenceType)return null===(t=Se(["post","get",e.referenceId]))||void 0===t?void 0:t.data},get community(){var t;if("community"===e.targetType)return null===(t=Se(["community","get",e.targetId]))||void 0===t?void 0:t.data},get user(){var t;return null===(t=Se(["user","get",e.userId]))||void 0===t?void 0:t.data}}),story:e=>{const t=Zo(),n=Se(["storyTarget","get",e.targetId]),r=Se(["community","get",e.targetId]);return Object.assign(Object.assign({},e),{analytics:{markAsSeen:()=>{e.expiresAt&&"synced"===e.syncState&&t.markStoryAsViewed(e)},markLinkAsClicked:()=>{e.expiresAt&&"synced"===e.syncState&&t.markStoryAsClicked(e)}},get videoData(){var t,n;const r=Se(["file","get",null===(n=null===(t=e.data)||void 0===t?void 0:t.videoFileId)||void 0===n?void 0:n.original]);if(!r)return;const{data:s}=r;return s||void 0},get imageData(){var t,n;if(!(null===(t=e.data)||void 0===t?void 0:t.fileId))return;const r=Se(["file","get",null===(n=e.data)||void 0===n?void 0:n.fileId]);if(!r)return;const{data:s}=r;return s?Object.assign(Object.assign({},s),{fileUrl:`${s.fileUrl}?size=full`}):void 0},get community(){if("community"===e.targetType&&r)return(null==r?void 0:r.data)||void 0},get communityCategories(){if("community"!==e.targetType)return;if(!r)return;const{data:{categoryIds:t}}=r;return 0!==t.length?t.map((e=>{const t=Se(["category","get",e]);return(null==t?void 0:t.data)||void 0})).filter((e=>void 0!==e)):void 0},get creator(){const t=Se(["user","get",e.creatorPublicId]);if(null==t?void 0:t.data)return el(t.data)},get storyTarget(){if(null==n?void 0:n.data)return nl(n.data)},get isSeen(){const t=Se(["story-last-seen",e.targetId]);if(!(null==n?void 0:n.data))return!1;const r=(null==t?void 0:t.data)?new Date(t.data).getTime():0,s=new Date(null==n?void 0:n.data.lastStorySeenExpiresAt).getTime()||0,i=new Date(e.expiresAt).getTime();return Math.max(r,s)>=i}})},storyTarget:nl,message:e=>{const t=Bo(e,["creatorPrivateId"]);return Object.assign(Object.assign({},t),{get readCount(){return ol(e).readCount},get deliveredCount(){return ol(e).deliveredCount},get creator(){var t;return null===(t=Se(["user","get",e.creatorId]))||void 0===t?void 0:t.data},markRead:()=>gl(e)})},reactor:e=>Object.assign(Object.assign({},e),{get user(){var t;const n=null===(t=Se(["user","get",e.userId]))||void 0===t?void 0:t.data;if(n)return el(n)}}),channel:e=>ml(e,{markAsRead:()=>(async e=>{const t=ve();t.log("channel/markAsRead",e);const{data:n}=await t.http.put(`/api/v1/markers/channels/${e}/mark-read`),{userMarkers:r,userEntityMarkers:s,userFeedMarkers:i}=n,a=Bo(n,["userMarkers","userEntityMarkers","userFeedMarkers"]),o=t.cache&&Date.now(),l=Ko(s),c=Go(i);return t.cache&&Uo(Object.assign({userMarkers:r,userEntityMarkers:l,userFeedMarkers:c},a),{cachedAt:o}),Je("local.channelMarker.updated",{userEntityMarkers:l}),Je("local.subChannelMarker.updated",{userFeedMarkers:c}),!0})(e.channelInternalId)}),pinnedPost:e=>{var t;const n=Se(["post","get",e.referenceId]),r=null===(t=we(["user","get"]).find((t=>{var n;return(null===(n=t.data)||void 0===n?void 0:n.userInternalId)===e.pinnedBy})))||void 0===t?void 0:t.data;return Object.assign(Object.assign({},e),{pinnedBy:r,get post(){if(null==n?void 0:n.data)return al(n.data)},get target(){const e=Se(["pinTarget","get",null==n?void 0:n.data.targetId]);if(null==e?void 0:e.data)return null==e?void 0:e.data}})},notificationTray:e=>Object.assign(Object.assign({},e),{isSeen:e.lastSeenAt>e.lastOccurredAt,isRecent:new Date(e.lastOccurredAt).getTime()>=Date.now()-6048e5,users:e.actors.map((({publicId:e})=>Se(["user","get",e]))).filter(sl).map((({data:e})=>e)).map((e=>el(e)))})},vl=e=>{var t,n;const r={messagePreviewChannel:null!==(n=null===(t=e.messagePreviews)||void 0===t?void 0:t.map((t=>(t=>{var n;const r=null===(n=e.messageFeedsInfo)||void 0===n?void 0:n.find((e=>e.messageFeedId===t.messageFeedId)),{channelPublicId:s,messageFeedId:i,data:a,dataType:o,isDeleted:l,segment:c,creatorPublicId:d,createdAt:u,updatedAt:h}=t;return{channelId:s,subChannelId:i,data:a,dataType:o,isDeleted:l,segment:c,creatorId:d,createdAt:u,updatedAt:h,subChannelName:null==r?void 0:r.name,messagePreviewId:null==r?void 0:r.messagePreviewId,subChannelUpdatedAt:null==r?void 0:r.updatedAt}})(t))))&&void 0!==n?n:[]};Uo(r)},bl=e=>{var t,n;return null!==(n=null===(t=Se(["messagePreviewSubChannel","get",e]))||void 0===t?void 0:t.data)&&void 0!==n?n:null},wl=e=>{var t;const n=e.messagePreviewId?bl(e.subChannelId):null,r=n?Object.assign(Object.assign({},n),{user:null===(t=Se(["user","get",null==n?void 0:n.creatorId]))||void 0===t?void 0:t.data}):null;return Object.assign(Object.assign({},e),{messagePreview:r})},Sl=e=>{var t,n;const r={messagePreviewSubChannel:null!==(n=null===(t=e.messages)||void 0===t?void 0:t.map((t=>(t=>{var n;const r=null===(n=e.messageFeeds)||void 0===n?void 0:n.find((e=>e.messageFeedId===t.messageFeedId)),{channelPublicId:s,messageFeedId:i,messageId:a,creatorPublicId:o,data:l,dataType:c,isDeleted:d,segment:u,createdAt:h,updatedAt:f}=t;return{messagePreviewId:a,channelId:s,subChannelId:i,data:l,dataType:c,isDeleted:d,segment:u,creatorId:o,createdAt:h,updatedAt:f,subChannelName:null==r?void 0:r.name,subChannelUpdatedAt:null==r?void 0:r.updatedAt}})(t))))&&void 0!==n?n:[]};Uo(r)};function Cl(e,t,n){Ce(["subChannel","get",e],ml(t,n))}const Tl=(e,t)=>{const{log:n,cache:r}=ve(),s=[e,w,t];if(!r)return;n("cache/api/isInTombstone",s);const i=Se(s),{lifeSpan:a}=ae("cache_then_server",18e4);if(i&&se(i.data,a))throw new pe("Item not found!",400400,"error")},El=e=>{const{feedMarkers:t,userFeedMarkers:n}=e;if(t.length>0&&n.length>0){const e=[],r=new Map(t.map((e=>[e.feedId,e])));n.forEach((t=>{const n=r.get(t.feedId);if(n&&n.feedId===t.feedId){const r=n.lastSegment-t.readToSegment,s={subChannelId:n.feedId,channelId:n.entityId,readToSegment:t.readToSegment,lastSegment:n.lastSegment,lastMentionSegment:t.lastMentionSegment,unreadCount:Math.max(0,r),isMentioned:t.isMentioned,isDeleted:n.isDeleted,createdAt:t.createdAt,updatedAt:t.updatedAt};Uo({subChannelUnreadInfo:[s]}),e.includes(n.entityId)||e.push(n.entityId)}})),e.forEach((e=>{ul(e)}))}},Il=async()=>{const e=ve();e.log("channel/getUserMarker");const{data:t}=await e.http.get("/api/v1/markers/userMarker"),{userMarkers:n}=t,r=e.cache&&Date.now();e.cache&&Uo({userMarkers:n},{cachedAt:r}),Je("local.userMarker.fetched",{userMarkers:n});return{data:n.reduce(((e,t)=>null==e||new Date(e.lastSyncAt).getTime()<new Date(t.lastSyncAt).getTime()?t:e),void 0),cachedAt:r}},kl=e=>!0===e&&void 0;function Al(e,t,n){var r,s;if(n)return n.hasMentioned;const i=ve();if(i.isUnreadCountEnabled&&i.getMarkerSyncConsistentMode()){const e=null===(r=Se(["subChannelUnreadInfo","get",t]))||void 0===r?void 0:r.data;return!!e&&e.isMentioned}const a={entityId:e,feedId:t,userId:Ke()._id},o=null===(s=Se(["subChannelMarker","get",de("subChannelMarker")(a)]))||void 0===s?void 0:s.data;return!!o&&o.hasMentioned}const _l=["broadcast","conversation","community"],Rl=({channelType:e})=>_l.includes(e);function Ol(e){var{channelId:t,channelPublicId:n,channelType:r,childCount:s,creatorId:i,creatorPublicId:a,lastMessageId:o,lastMessageTimestamp:l,messageFeedId:c,name:d}=e,u=Bo(e,["channelId","channelPublicId","channelType","childCount","creatorId","creatorPublicId","lastMessageId","lastMessageTimestamp","messageFeedId","name"]);return Object.assign(Object.assign({get unreadCount(){return function(e,t,n){var r,s;if(n)return n.unreadCount;const i=ve();if(i.isUnreadCountEnabled&&i.getMarkerSyncConsistentMode()){const e=null===(r=Se(["subChannelUnreadInfo","get",t]))||void 0===r?void 0:r.data;return e?e.isDeleted?0:e.unreadCount:0}const a={entityId:e,feedId:t,userId:Ke()._id},o=null===(s=Se(["subChannelMarker","get",de("subChannelMarker")(a)]))||void 0===s?void 0:s.data;return o?o.unreadCount:0}(t,c)},get hasMentioned(){return Al(t,c)},get isMentioned(){return Al(t,c)}},u),{channelId:n,creatorId:a,displayName:d,lastActivity:l,latestMessageId:o,messageCount:s,subChannelId:c,isUnreadCountSupport:Rl({channelType:r})})}function Ll(e,t,n){var r;const s=(e=>{var t,n,r;const s=null===(n=null===(t=we(["message","get"]))||void 0===t?void 0:t.find((({data:t})=>t.messageId===e.messageId)))||void 0===n?void 0:n.data;return s?Object.assign(Object.assign(Object.assign({},s),e),{referenceId:null!==(r=s.referenceId)&&void 0!==r?r:e.referenceId}):e})(e),{channelPublicId:i,childCount:a,creatorPublicId:o,mentionedUsers:l,messageFeedId:c,myReactions:d,reactionCount:u,reactions:h,referenceId:f,segment:p,messageId:g,creatorId:m}=s,y=Bo(s,["channelPublicId","childCount","creatorPublicId","mentionedUsers","messageFeedId","myReactions","reactionCount","reactions","referenceId","segment","messageId","creatorId"]);let v;f&&(v=Se(["message","get",f])),v||(v=Se(["message","get",g]));const b=Object.assign(Object.assign({},y),{messageId:g,channelId:i,channelSegment:p,childrenNumber:a,creatorId:o,creatorPrivateId:e.creatorId,reactions:null!=h?h:{},myReactions:d||(null!==(r=null==v?void 0:v.data.myReactions)&&void 0!==r?r:[]),reactionsCount:u,subChannelId:c,uniqueId:v?v.data.uniqueId:g,referenceId:f,syncState:"synced"});return l&&(b.mentionees=l.map((e=>"channel"===e.type?e:{type:"user",userIds:e.userPublicIds}))),t&&t.length&&n&&((e,t,n)=>{const r=ve(),s=Se(["message","get",e.messageId]),i=(null==s?void 0:s.data.myReactions)||[];Object.assign(e,{myReactions:i});const a=t[0];a&&a.userId===r.userId&&("message.reactionAdded"!==n||i.includes(a.reactionName)||Object.assign(e,{myReactions:[...i,a.reactionName]}),"message.reactionRemoved"===n&&i.includes(a.reactionName)&&Object.assign(e,{myReactions:i.filter((e=>e!==a.reactionName))}))})(b,t,n),b}const Dl={},xl=async(e,t)=>{const n=e.messages.map((({messageId:e})=>e));if(n.length>0){Uo({messages:(r=e).messages.map((e=>Ll(e,r.reactions)))});const t=n.join("");Dl[t]&&clearTimeout(Dl[t]),Dl[t]=setTimeout((()=>{try{(async e=>{const t=ve();t.log("channel/getMessageMarkers",e);const{data:n}=await t.http.get("/api/v1/markers/messages",{params:{messageIds:e}}),{contentMarkers:r,feedMarkers:s,userMarkers:i}=n,a=t.cache&&Date.now();t.cache&&Uo({contentMarkers:r,feedMarkers:s,userMarkers:i},{cachedAt:a}),Je("local.feedMarker.fetched",{feedMarkers:s}),Je("local.messageMarker.fetched",{contentMarkers:r}),Je("local.userMarker.fetched",{userMarkers:i})})(n)}catch(e){}}),2e3)}var r;const{messageFeeds:s}=e,i=Bo(e,["messageFeeds"]);return s&&s.length>0&&(null==s||s.forEach((e=>{var t,n;const r=null!==(n=null===(t=Se(["subChannel","get",e.messageFeedId]))||void 0===t?void 0:t.data)&&void 0!==n?n:{},s=Bo(Ol(e),["unreadCount","isMentioned"]);Cl(e.messageFeedId,r,s)}))),Object.assign(Object.assign({},i),{messages:e.messages.map((n=>Ll(n,e.reactions,t)))})};function Pl(e){var{subChannelId:t,mentionees:n,dataType:r,data:s}=e,i=Bo(e,["subChannelId","mentionees","dataType","data"]);return r===d.IMAGE||r===d.FILE?Object.assign({messageFeedId:t,mentionedUsers:n,dataType:r,data:Object.assign({caption:""},s)},i):Object.assign({messageFeedId:t,mentionedUsers:n,dataType:r,data:s},i)}function Ml(e){var{sortBy:t,subChannelId:n,includingTags:r,excludingTags:s,includeDeleted:i,aroundMessageId:a,limit:o,type:l}=e,c=Bo(e,["sortBy","subChannelId","includingTags","excludingTags","includeDeleted","aroundMessageId","limit","type"]);const d=Object.assign(Object.assign({},c),{messageFeedId:n,isDeleted:kl(i),options:{sortBy:t,limit:o||f,around:a}});return r&&(d.includeTags=r),l&&(d.dataType=l),s&&(d.excludeTags=s),d}const Fl=["broadcast","conversation","community"],Ul=({channelType:e})=>Fl.includes(e),Nl=async e=>{const t=e.messageFeeds.filter(Ul).map((({messageFeedId:e})=>e));if(t.length>0){(e=>{Uo({messageFeeds:e.messageFeeds.map((e=>Ol(e)))})})(e);try{await(async(e,t={limit:100})=>{const n=ve();n.log("channel/getSubChannelMarkers",e,t);const{data:r}=await n.http.get("/api/v1/markers/message-feeds",{params:{messageFeedIds:e,options:{token:J(t,"skiplimit")}}}),{paging:s}=r,i=Bo(r,["paging"]),{userEntityMarkers:a,userFeedMarkers:o,userMarkers:l,feedMarkers:c}=i;n.isUnreadCountEnabled&&n.getMarkerSyncConsistentMode()&&El({feedMarkers:c,userFeedMarkers:o});const d=Ko(a),u=Go(o),h=n.cache&&Date.now();n.cache&&Uo({userEntityMarkers:d,userFeedMarkers:u,userMarkers:l},{cachedAt:h}),Je("local.channelMarker.fetched",{userEntityMarkers:d}),Je("local.subChannelMarker.fetched",{userFeedMarkers:u}),Je("local.userMarker.fetched",{userMarkers:l});const f=Z(s.next);return{data:u,cachedAt:h,prevPage:Z(s.previous),nextPage:f}})(t)}catch(e){}}Sl(e);const n=e.messageFeeds.map(Ol),r=e.messages.map((e=>Ll(e)));return Object.assign(Object.assign({},e),{messageFeeds:n,messages:r})};const Bl=async e=>{const t=ve();t.log("channel/getSubChannel",e),Tl("subChannel",e);try{const n=await t.http.get(`/api/v5/message-feeds/${encodeURIComponent(e)}`),r=await Nl(n.data),s=t.cache&&Date.now();return t.cache&&Uo(r,{cachedAt:s}),Je("local.message-feed.fetched",r),{data:r.messageFeeds[0],cachedAt:s}}catch(t){throw I(null==t?void 0:t.code)&&No("subChannel",e),t}};Bl.locally=e=>{const t=ve();if(t.log("channel/getSubChannel.locally",e),!t.cache)return;const n=Se(["subChannel","get",e]);return n?{data:n.data,cachedAt:n.cachedAt}:void 0};const jl=e=>new Date(e).getTime(),$l=async e=>{var t;let n=null===(t=Se(["subChannel","get",e]))||void 0===t?void 0:t.data;return n||(n=(await Bl(e)).data),n},ql=async e=>{const t=await(async()=>ve().getMessagePreviewSetting(!1))(),{channelId:n,messageId:r,creatorId:s,createdAt:i,updatedAt:a,data:o,dataType:l,subChannelId:c,channelSegment:d,isDeleted:u}=e,h=await $l(c);"no-message-preview"!==t?(e=>{var t;const n=null===(t=Se(["messagePreviewSubChannel","get",e.subChannelId]))||void 0===t?void 0:t.data;return!n||n.segment<=e.channelSegment||jl(n.createdAt)<=jl(e.createdAt)})(e)&&(Ce(["messagePreviewSubChannel","get",e.subChannelId],{channelId:n,creatorId:s,messagePreviewId:r,createdAt:i,updatedAt:a,subChannelId:c,data:o,dataType:l,segment:d,isDeleted:u,subChannelUpdatedAt:null==h?void 0:h.updatedAt,subChannelName:null==h?void 0:h.displayName}),Cl(e.subChannelId,h,{lastActivity:i,messagePreviewId:r})):jl(h.lastActivity)<jl(i)&&Cl(e.subChannelId,h,{lastActivity:i})},Kl=async e=>{var t;const{channelId:n,messageId:r,creatorId:s,createdAt:i,updatedAt:a,data:o,dataType:l,subChannelId:c,channelSegment:d,isDeleted:u}=e,h=null===(t=Se(["messagePreviewSubChannel","get",e.subChannelId]))||void 0===t?void 0:t.data;if(h&&h.messagePreviewId===e.messageId){const t=await $l(c);Ce(["messagePreviewSubChannel","get",e.subChannelId],{channelId:n,creatorId:s,messagePreviewId:r,createdAt:i,updatedAt:a,subChannelId:c,data:o,dataType:l,segment:d,isDeleted:u,subChannelUpdatedAt:t.updatedAt,subChannelName:h.subChannelName})}},Gl=async e=>{const{channelId:t,messageId:n,creatorId:r,createdAt:s,updatedAt:i,data:a,dataType:o,subChannelId:l,channelSegment:c,isDeleted:d}=e;if((e=>{var t;const n=null===(t=Se(["messagePreviewChannel","get",e.channelId]))||void 0===t?void 0:t.data;return!n||jl(n.createdAt)<=jl(e.createdAt)})(e)){const u=await $l(l);Ce(["messagePreviewChannel","get",e.channelId],{channelId:t,creatorId:r,messagePreviewId:n,createdAt:s,updatedAt:i,subChannelId:l,data:a,dataType:o,segment:c,isDeleted:d,subChannelUpdatedAt:null==u?void 0:u.updatedAt,subChannelName:null==u?void 0:u.displayName})}},Hl=async e=>{var t;const{channelId:n,messageId:r,creatorId:s,createdAt:i,updatedAt:a,data:o,dataType:l,subChannelId:c,channelSegment:d,isDeleted:u}=e,h=null===(t=Se(["messagePreviewChannel","get",e.channelId]))||void 0===t?void 0:t.data;if(h&&h.messagePreviewId===e.messageId){const t=await $l(c);Ce(["messagePreviewChannel","get",e.channelId],{channelId:n,creatorId:s,messagePreviewId:r,createdAt:i,updatedAt:a,subChannelId:c,data:o,dataType:l,segment:d,isDeleted:u,subChannelUpdatedAt:t.updatedAt,subChannelName:h.subChannelName})}},Vl=async e=>{var t,n,r,s;const{channelId:i,subChannelId:a}=e,o=null===(t=Se(["messagePreviewChannel","get",i]))||void 0===t?void 0:t.data;if((null==o?void 0:o.subChannelId)===a){const e=null===(n=Se(["subChannel","get",a]))||void 0===n?void 0:n.data;Ce(["messagePreviewChannel","get",i],Object.assign(Object.assign({},o),{subChannelName:null==e?void 0:e.displayName,subChannelUpdatedAt:null==e?void 0:e.updatedAt}))}const l=null===(r=Se(["messagePreviewSubChannel","get",a]))||void 0===r?void 0:r.data;if(l&&new Date(l.updatedAt).valueOf()>new Date(e.updatedAt).valueOf()){const e=null===(s=Se(["subChannel","get",a]))||void 0===s?void 0:s.data;Ce(["messagePreviewSubChannel","get",a],Object.assign(Object.assign({},l),{subChannelName:null==e?void 0:e.displayName,subChannelUpdatedAt:null==e?void 0:e.updatedAt}))}};function zl(e){return Object.assign(Object.assign({},e),{isGlobalBanned:(null==e?void 0:e.isGlobalBan)||!1})}const Wl=["broadcast","conversation","community"],Yl=({type:e})=>Wl.includes(e);function Ql(e,t={isMessagePreviewUpdated:!0}){var n;let{messagePreviewId:r}=e;const s=null===(n=Se(["messagePreviewChannel","get",e.channelId]))||void 0===n?void 0:n.data;return(null==s?void 0:s.messagePreviewId)&&!t.isMessagePreviewUpdated&&(r=s.messagePreviewId),Object.assign(Object.assign({},e),{defaultSubChannelId:e.channelInternalId,isUnreadCountSupport:Yl(e),messagePreviewId:r})}const Xl=(e,t={isMessagePreviewUpdated:!0})=>{Uo({channels:e.channels.map((e=>Ql(e,{isMessagePreviewUpdated:t.isMessagePreviewUpdated})))})},Jl=async(e,t={isMessagePreviewUpdated:!0})=>{const n=ve(),r=await n.getMessagePreviewSetting(!1);if(t.isMessagePreviewUpdated&&"no-message-preview"!==r&&e.messagePreviews&&e.messagePreviews.length>0&&vl(e),n.useLegacyUnreadCount)(({currentUserId:e,channels:t,channelUsers:n})=>{for(let r=0;r<t.length;r+=1){const s=["channelUnread","get",t[r].channelId],i=n.find((n=>n.channelId===t[r].channelId&&n.userId===e));let a=0,o=null,l=null,c=!1;i&&(o=i.readToSegment,l=i.lastMentionedSegment,a=Math.max(t[r].messageCount-o,0),c=l>o);const d={channelId:t[r].channelId,lastSegment:t[r].messageCount,readToSegment:o,lastMentionedSegment:l,unreadCount:a,isMentioned:c,isDeleted:t[r].isDeleted||!1};Ce(s,d)}})({channels:e.channels,channelUsers:e.channelUsers,currentUserId:n.userId});else{const n=e.channels.filter(Yl).map((({channelInternalId:e})=>e));if(n.length>0){Xl(e,{isMessagePreviewUpdated:t.isMessagePreviewUpdated});try{await(async e=>{const t=ve();t.log("channel/getChannelMarkers",e);const{data:n}=await t.http.get("/api/v1/markers/channels",{params:{channelIds:e}}),{userEntityMarkers:r,userMarkers:s}=n,i=Ko(r),a=t.cache&&Date.now();return t.cache&&Uo({userEntityMarkers:i,userMarkers:s},{cachedAt:a}),Je("local.channelMarker.fetched",{userEntityMarkers:i}),Je("local.userMarker.fetched",{userMarkers:s}),{data:i,cachedAt:a}})(n)}catch(e){}}}const s=e.channels.map((e=>Ql(e,{isMessagePreviewUpdated:t.isMessagePreviewUpdated}))),i=e.channelUsers.map((e=>{return t=e,Object.assign(Object.assign({},t),{get user(){var e;if(ve().cache)return(null===(e=Se(["user","get",t.userId]))||void 0===e?void 0:e.data)||void 0}});var t})),a=e.users.map(zl),o=Bo(e,["messageFeedsInfo","messagePreviews"]);return Object.assign(Object.assign({},o),{users:a,channels:s,channelUsers:i})},Zl=async e=>{const t=ve();t.log("channel/getUserMessageFeedMakers",e);const{data:n}=await t.http.get("/api/v1/markers/user-message-feed",{params:{channelIds:e}});return Je("local.userMessageFeedMarker.fetched",{userMessageFeedMarker:n}),n},ec=async e=>{const t=ve(),n=await Zl(e.channels.map((({channelInternalId:e})=>e))),{feedMarkers:r,userFeedMarkers:s}=n;El({feedMarkers:r,userFeedMarkers:s}),t.log("channel/prepareUnreadCountInfo",e.channels)},tc=(e,t)=>{var n,r,s,i;const a=ve();return a.isUnreadCountEnabled&&a.getMarkerSyncConsistentMode()?null!==(r=null===(n=(e=>{var t;return null===(t=Se(["channelUnreadInfo","get",e]))||void 0===t?void 0:t.data})(e.channelPublicId))||void 0===n?void 0:n.isMentioned)&&void 0!==r&&r:void 0!==(null==t?void 0:t.hasMentioned)?null==t?void 0:t.hasMentioned:null!==(i=null===(s=(e=>{var t;const n={entityId:e,userId:Ke()._id};return null===(t=Se(["channelMarker","get",de("channelMarker")(n)]))||void 0===t?void 0:t.data})(e.channelPublicId))||void 0===s?void 0:s.hasMentioned)&&void 0!==i&&i},nc=(e,t)=>{var n,r,s,i,a;const o=ve();return o.isUnreadCountEnabled&&o.getMarkerSyncConsistentMode()?null!==(r=null===(n=(e=>{var t;return null===(t=Se(["channelUnreadInfo","get",e]))||void 0===t?void 0:t.data})(e.channelInternalId))||void 0===n?void 0:n.unreadCount)&&void 0!==r?r:0:(null==t?void 0:t.isDeleted)?0:null!==(a=null!==(s=null==t?void 0:t.unreadCount)&&void 0!==s?s:null===(i=(e=>{var t;const n={entityId:e,userId:Ke()._id};return null===(t=Se(["channelMarker","get",de("channelMarker")(n)]))||void 0===t?void 0:t.data})(e.channelInternalId))||void 0===i?void 0:i.unreadCount)&&void 0!==a?a:0},rc=e=>{var t;return null===(t=Se(["channelUnread","get",e]))||void 0===t?void 0:t.data},sc=e=>{const t=ve(),n=Bo(e,["messageCount"]);return ml(n,{get unreadCount(){var e,t;return null!==(t=null===(e=rc(n.channelId))||void 0===e?void 0:e.unreadCount)&&void 0!==t?t:0},get subChannelsUnreadCount(){return nc(n)},get isMentioned(){var e,r;return t.useLegacyUnreadCount?null!==(r=null===(e=rc(n.channelId))||void 0===e?void 0:e.isMentioned)&&void 0!==r&&r:tc(n)}})},ic=e=>yl.channel(sc((e=>{var t;const n=e.messagePreviewId?Ho(e.channelId):null,r=null===(t=Se(["user","get",null==n?void 0:n.creatorId]))||void 0===t?void 0:t.data,s=n?Object.assign(Object.assign({},n),{user:r?yl.user(r):void 0}):null;return Object.assign(Object.assign({},e),{messagePreview:s})})(e))),ac=async e=>{const t=ve();t.log("channel/getChannelByIds",e);const n=e.map((e=>encodeURIComponent(e)));let r;try{r=(await t.http.get("/api/v3/channels/list",{params:{channelIds:n}})).data}catch(t){throw e.forEach((e=>{I(null==t?void 0:t.code)&&No("channel",e)})),t}const s=await Jl(r);t.isUnreadCountEnabled&&t.getMarkerSyncConsistentMode()&&await ec(r);const i=t.cache&&Date.now();return t.cache&&Uo(s,{cachedAt:i}),Je("local.channel.fetched",s.channels),{data:s.channels.map((e=>ic(e))),cachedAt:i}};ac.locally=e=>{var t,n;const r=ve();if(r.log("channel/getChannelByIds.locally",e),!r.cache)return;const s=null===(t=we(["channel","get"]))||void 0===t?void 0:t.filter((({data:t})=>e.includes(t.channelPublicId)));if(!s||(null==s?void 0:s.length)<e.length)return;const i=s.map((({data:e})=>e)),a=null===(n=s.sort(((e,t)=>e.cachedAt<t.cachedAt?-1:1)))||void 0===n?void 0:n[0];return{data:i.map((e=>ic(e))),cachedAt:a.cachedAt}};class oc{constructor(){this._sessionState="notLoggedIn",this._listener=new Map}onSessionStateChange(e){return this._listener.set(e,e),()=>{this._listener.delete(e)}}setSessionState(e){this._sessionState!==e&&(this._sessionState=e,this._listener.forEach((t=>t(e))))}destroy(){this._listener.clear()}}let lc;var cc=()=>(lc||(lc=new oc),lc);const dc=e=>cc().onSessionStateChange(e),uc=(e,t)=>{const n=setInterval(e,t);return()=>clearInterval(n)};let hc=!1;const fc={},pc=async()=>{const e=Object.entries(fc).filter((([,e])=>e)).map((([e])=>e));return 0!==e.length&&(async e=>{const t=ve();t.log("subChannel/readingAPI",e);const{data:n}=await t.http.post("/api/v1/markers/message-feeds/reading",{messageFeedIds:e}),{userEntityMarkers:r,userFeedMarkers:s,feedMarkers:i,userMarkers:a}=n,o=Ko(r),l=Go(s),c=t.cache&&Date.now();return t.cache&&Uo({userEntityMarkers:o,userFeedMarkers:l,feedMarkers:i,userMarkers:a},{cachedAt:c}),Je("local.feedMarker.fetched",{feedMarkers:i}),Je("local.channelMarker.fetched",{userEntityMarkers:o}),Je("local.subChannelMarker.fetched",{userFeedMarkers:l}),Je("local.userMarker.fetched",{userMarkers:a}),!0})(e)},gc=()=>{hc=!1},mc=()=>(hc=!0,dc((e=>{"notLoggedIn"===e&&gc()})),()=>{gc()});uc((async()=>{hc&&await pc()}),3e4);const yc=async e=>{const t=ve();t.log("channel/getSubChannels",e);const n=await t.http.get("/api/v5/message-feeds/list",{params:{messageFeedIds:e.map(encodeURIComponent)}}),r=await Nl(n.data),s=t.cache&&Date.now();return t.cache&&Uo(r,{cachedAt:s}),Je("local.message-feed.fetched",r),{data:r.messageFeeds,cachedAt:s}};yc.locally=e=>{var t;const n=ve();if(n.log("channel/getSubChannels.locally",e),!n.cache)return;const r=e.map((e=>Se(["subChannel","get",e]))).filter(Boolean);if((null==r?void 0:r.length)<e.length)return;return{data:r.map((({data:e})=>e)),cachedAt:(null===(t=r.sort(((e,t)=>e.cachedAt<t.cachedAt?-1:1)))||void 0===t?void 0:t[0]).cachedAt}};const vc=async(e=!0)=>{var t;const n=null===(t=Se(["MessagePreviewSetting"]))||void 0===t?void 0:t.data;if(!e&&n)return n;const r=await(async()=>{const e=ve(),{data:t}=await e.http.get("/api/v3/network-settings/chat");return t})();var s;return(s=r).messagePreview.enabled?s.messagePreview.isIncludeDeleted?"message-preview-include-deleted":"message-preview-not-include-deleted":"no-message-preview"},bc=async()=>{const e=ve(),{data:t}=await e.http.get("/api/v3/network-settings/social");return t.socialNetworkSetting},wc=(e,t)=>{var n;const r=null===(n=Se(["user","get",e]))||void 0===n?void 0:n.data;return!!r&&r.permissions.some((e=>e===t))},Sc=e=>{const{userId:t}=ve();return{currentUser:()=>wc(t,e),community:n=>((e,t,n)=>{var r;if(!e)return!1;const s=null===(r=Se(["communityUsers","get",`${n}#${e}`]))||void 0===r?void 0:r.data;return!!s&&(!!s.permissions.some((e=>e===t))||wc(e,t))})(t,e,n),channel:n=>((e,t,n)=>{var r;if(!e)return!1;const s=null===(r=Se(["channelUsers","get",`${n}#${e}`]))||void 0===r?void 0:r.data;return!!s&&(!!s.permissions.some((e=>e===t))||wc(e,t))})(t,e,n)}},Cc=async e=>{const t=ve();if(t.log("channel/markerSync"),0===e.length)return!1;const{data:n}=await t.http.post("/api/v3/allowlists/verify",{data:e});return n.success},Tc=async e=>{const t=ve();if(t.log("channel/markerSync"),0===e.length)return!1;const{data:n}=await t.http.post("/api/v3/blocklists/verify",{data:e});return n.success},Ec=async()=>{const e=ve(),{data:t}=await e.http.get("/api/v3/network-settings/feed-setting");return Object.fromEntries(t.feedSettings.map((({feedType:e,contentSettings:t})=>[e,t])))},Ic={notLoggedIn:["establishing"],terminated:["establishing"],establishing:["notLoggedIn","established"],established:["notLoggedIn","terminated","tokenExpired","establishing"],tokenExpired:["establishing"]},kc=e=>{const t=ve();t.log("client/api/setSessionState",e);const{sessionState:n}=t;if(n===e)return!1;if(!((e,t)=>Ic[e].includes(t))(n,e))throw new fe(`Session state cannot change from ${n} to ${e}`,8e5,"error");return t.sessionState=e,cc().setSessionState(e),!0},Ac=async e=>{const t=ve();kc("establishing");const{accessToken:n,users:r,expiresAt:s,issuedAt:i}=await(async({params:e,options:t})=>{const n=ve();n.log("client/api/getToken",e);const r=xo(),{data:s}=await n.http.post("/api/v5/sessions",Object.assign(Object.assign({},e),{deviceInfo:r}),{headers:{"X-API-Key":n.apiKey,"set-access-token-cookie":(null==t?void 0:t.setAccessTokenCookie)||!1}});return s})(e);return t.http.defaults.headers.common.Authorization=`Bearer ${n}`,t.http.defaults.metadata={tokenExpiry:s,isGlobalBanned:!1,isUserDeleted:!1},t.upload.defaults.headers.common.Authorization=`Bearer ${n}`,t.upload.defaults.metadata={tokenExpiry:s,isGlobalBanned:!1,isUserDeleted:!1},t.ws&&(t.ws.io.opts.query={token:n}),t.token={accessToken:n,issuedAt:i,expiresAt:s},kc("established"),{accessToken:n,users:r}},_c=e=>{const t=we(["subChannelUnreadInfo","get"]);if(t){(null==t?void 0:t.filter((({data:t})=>t.channelId===e))).forEach((({key:e,data:t})=>{Ce(e,Object.assign(Object.assign({},t),{isDeleted:!0}))}))}},Rc=e=>{var t;const n=["channelUnreadInfo","get",e];(null===(t=Se(n))||void 0===t?void 0:t.data)&&Ie(n)},Oc=[];let Lc=null;const Dc=e=>{if(0===Oc.length){const e=ve(),t=async t=>{const n=await Jl(t),r=e.getMarkerSyncConsistentMode()&&e.isUnreadCountEnabled,s=e.useLegacyUnreadCount;n.channels.forEach((e=>{if(r)_c(e.channelId),Rc(e.channelId);else if(s){const t=["channelUnread","get",e.channelId],n=Se(t);n&&Ce(t,Object.assign(Object.assign({},n),{isDeleted:!0}))}})),Uo(n),Oc.forEach((e=>e(n.channels[0])))};Lc=Xe(e,"onChannelDeleted","channel.deleted",t)}return Oc.push(e),()=>(e=>{const t=Oc.indexOf(e);t>-1&&Oc.splice(t,1),0===Oc.length&&(null==Lc||Lc())})(e)},xc=[];let Pc=null;const Mc=e=>{const t=ve();return Pc=Xe(t,"onChannelMemberBanned","channel.banned",(async e=>{const n=await Jl(e),{channels:r,channelUsers:s}=n,i=s.some((e=>"banned"===e.membership&&e.userId===t.userId));t.isUnreadCountEnabled&&t.getMarkerSyncConsistentMode()&&i&&n.channels.forEach((e=>{_c(e.channelId),Rc(e.channelId)})),Uo(n),xc.forEach((e=>e(r[0],s.find((e=>"banned"===e.membership)))))})),xc.push(e),()=>(e=>{const t=xc.indexOf(e);t>-1&&xc.splice(t,1),0===xc.length&&(null==Pc||Pc())})(e)};function Fc(e){return{users:e.users.map(zl),files:e.files}}const Uc=(e,t)=>{const n=ve();return Xe(n,e,e,(e=>{const r=Fc(e);n.cache&&Uo(r),t(r.users[0])}))},Nc=e=>Uc("user.deleted",e);const Bc=e=>"undefined"!=typeof window&&window.addEventListener?(window.addEventListener("online",e),()=>window.removeEventListener("online",e)):"undefined"!=typeof document&&document.addEventListener?(document.addEventListener("online",e),()=>document.removeEventListener("online",e)):(console.error("Unsupported environment"),()=>console.error("Unsupported environment")),jc=async e=>{const t=ve();t.log("channel/getChannelByIds",e);const n=e.map((e=>encodeURIComponent(e)));let r;try{r=(await t.http.get("/api/v3/channels/list",{params:{channelIds:n}})).data}catch(t){throw e.forEach((e=>{I(null==t?void 0:t.code)&&No("channel",e)})),t}const s=await Jl(r);t.isUnreadCountEnabled&&t.getMarkerSyncConsistentMode()&&await ec(r);const i=t.cache&&Date.now();return t.cache&&Uo(s,{cachedAt:i}),Je("local.channel.fetched",s.channels),{data:s.channels,cachedAt:i}};jc.locally=e=>{var t,n;const r=ve();if(r.log("channel/getChannelByIds.locally",e),!r.cache)return;const s=null===(t=we(["channel","get"]))||void 0===t?void 0:t.filter((({data:t})=>e.includes(t.channelPublicId)));if(!s||(null==s?void 0:s.length)<e.length)return;return{data:s.map((({data:e})=>e)),cachedAt:(null===(n=s.sort(((e,t)=>e.cachedAt<t.cachedAt?-1:1)))||void 0===n?void 0:n[0]).cachedAt}};class $c{constructor(){this.TIMER_INTERVAL_MS=v,this.BUFFER_ID_LIMIT=100,this.buffer={channel:[],userMessageFeedMarker:[]},this.isResolvingTask=!1,this.connectionListener=[],this.isConnected=!0,this.addConnectionListener()}startResolver(){this.timer||(this.timer=setInterval((()=>{this.isConnected&&this.resolveObjects()}),this.TIMER_INTERVAL_MS))}stopResolver(){this.timer&&(clearInterval(this.timer),this.timer=void 0)}resolve(e,t){const n=this.getBuffer(t);n.includes(e)||(n.length>=this.BUFFER_ID_LIMIT&&n.shift(),n.push(e))}addConnectionListener(){var e;this.connectionListener.length>0||(this.connectionListener.push(Bc((()=>{this.isConnected=!0}))),this.connectionListener.push((e=()=>{this.isConnected=!1},"undefined"!=typeof window&&window.addEventListener?(window.addEventListener("offline",e),()=>window.removeEventListener("offline",e)):"undefined"!=typeof document&&document.addEventListener?(document.addEventListener("offline",e),()=>document.removeEventListener("offline",e)):(console.error("Unsupported environment"),()=>console.error("Unsupported environment")))))}removeConnectionListener(){this.connectionListener.length>0&&this.connectionListener.forEach((e=>e()))}resolveObjects(){if(this.isResolvingTask)return;this.isResolvingTask=!0;const e=this.getBuffer("channel"),t=this.getBuffer("userMessageFeedMarker");this.clearBuffer(),e.length>0&&(async e=>{var t,n,r;await jc(e);const s=null!==(r=null===(n=null===(t=we(["channel","get"]))||void 0===t?void 0:t.filter((({data:t})=>t.channelPublicId&&e.includes(t.channelPublicId))))||void 0===n?void 0:n.map((({data:e})=>e)))&&void 0!==r?r:[];Je("local.channel.resolved",s)})(e),t.length>0&&(async e=>{const t=await Zl(e),{feedMarkers:n,userFeedMarkers:r}=t;El({feedMarkers:n,userFeedMarkers:r}),Je("local.userMessageFeedMarkers.resolved",{feedMarkers:n,userFeedMarkers:r})})(t),this.isResolvingTask=!1}clearBuffer(){this.buffer={channel:[],userMessageFeedMarker:[]}}getBuffer(e){return this.buffer[e]}onSessionEstablished(){this.startResolver(),this.addConnectionListener()}onSessionDestroyed(){this.stopResolver(),this.clearBuffer(),this.isResolvingTask=!1,this.removeConnectionListener()}onTokenExpired(){this.stopResolver()}}let qc=null;var Kc=()=>(qc||(qc=new $c),qc);const Gc=async()=>{var e,t;const n=ve();return n.log("client/api/disconnectClient"),n.mqtt&&n.mqtt.connected&&n.mqtt.disconnect(),n.ws&&n.ws.connected&&n.ws.disconnect(),"established"===n.sessionState&&kc("notLoggedIn"),n.emitter.all.clear(),null===(e=n.ws)||void 0===e||e.removeAllListeners(),null===(t=n.mqtt)||void 0===t||t.removeAllListeners(),n.userId=void 0,n.token=void 0,n.http.defaults.headers.common.Authorization="",n.http.defaults.metadata={tokenExpiry:"",isGlobalBanned:!1,isUserDeleted:!1},n.ws&&(n.ws.io.opts.query={token:""}),"undefined"!=typeof document&&(document.cookie="_ascSession=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"),"tokenExpired"!==n.sessionState&&n.cache&&(n.cache={data:{}}),!0},Hc=e=>{const t=ve();kc("terminated"),t.http.defaults.metadata&&("globalBan"===e&&(t.http.defaults.metadata.isGlobalBanned=!0),"userDeleted"===e&&(t.http.defaults.metadata.isUserDeleted=!0)),t.sessionHandler=void 0,Gc()},Vc=["disconnected","error","connect_error","reconnect_error","reconnect_failed"],zc=e=>{const t=ve(),n=Vc.map((n=>Xe(t,`client/onConnectionError(${n})`,n,(t=>{const r=(null==t?void 0:t.code)?new fe(t.message,t.code,"fatal"):new me(n);e(r)}))));return()=>{n.forEach((e=>e()))}},Wc=e=>{const t=ve();return Xe(t,"client/onConnectionError(user.didGlobalBan)","user.didGlobalBan",e)},Yc=e=>{const t=de("channelMarker")({userId:Ke()._id,entityId:e.channelId});Ie(["channelMarker","get",t],!0)},Qc=[];let Xc=null;const Jc=e=>{if(0===Qc.length){const e=ve();Xc=Xe(e,"onChannelCreated","channel.created",(async e=>{const t=await Jl(e);Uo(t),Qc.forEach((e=>e(t.channels[0])))}))}return Qc.push(e),()=>(e=>{const t=Qc.indexOf(e);t>-1&&Qc.splice(t,1),0===Qc.length&&(null==Xc||Xc())})(e)},Zc=[],ed=[],td=e=>{const t=ve();if(0===Zc.length){const e=async e=>{const t=await Jl(e);Uo(t),Zc.forEach((e=>e(t.channels[0])))};ed.push(Xe(t,"onChannelUpdated","channel.updated",e)),ed.push(Xe(t,"onChannelUpdated","local.channel.updated",(e=>Zc.forEach((t=>t(e.channels[0]))))))}return Zc.push(e),()=>(e=>{const t=Zc.indexOf(e);t>-1&&Zc.splice(t,1),0===Zc.length&&ed.forEach((e=>e()))})(e)},nd=[];let rd=null;const sd=e=>{if(0===nd.length){const e=ve();rd=Xe(e,"onChannelJoined","channel.joined",(async e=>{const t=await Jl(e),{channels:n,channelUsers:r}=t;Uo(t),nd.forEach((e=>e(n[0],r[0])))}))}return nd.push(e),()=>(e=>{const t=nd.indexOf(e);t>-1&&nd.splice(t,1),0===nd.length&&(null==rd||rd())})(e)},id=[];let ad=null;const od=e=>{if(0===id.length){const e=ve(),t=async t=>{const{userId:n}=ve(),{channelUsers:r}=t,s=r.some((e=>e.userId===n)),i=await Jl(t,{isMessagePreviewUpdated:s}),a=e.getMarkerSyncConsistentMode()&&e.isUnreadCountEnabled,o=e.useLegacyUnreadCount;s&&i.channels.forEach((e=>{a?(_c(e.channelId),Rc(e.channelId)):o&&Ie(["channelUnread","get",e.channelId])}));const{channels:l,channelUsers:c}=i;Uo(i),id.forEach((e=>e(l[0],c[0])))};ad=Xe(e,"onChannelLeft","channel.left",t)}return id.push(e),()=>(e=>{const t=id.indexOf(e);t>-1&&id.splice(t,1),0===id.length&&(null==ad||ad())})(e)},ld=[];let cd=null;const dd=e=>{if(0===ld.length){const e=ve();cd=Xe(e,"onChannelMuted","channel.setMuted",(async e=>{const t=await Jl(e);Uo(t),ld.forEach((e=>e(t.channels[0])))}))}return ld.push(e),()=>(e=>{const t=ld.indexOf(e);t>-1&&ld.splice(t,1),0===ld.length&&(null==cd||cd())})(e)},ud=[];let hd=null;const fd=e=>{if(0===ud.length){const e=ve();hd=Xe(e,"onChannelMemberAdded","channel.membersAdded",(async e=>{const t=await Jl(e),{channels:n,channelUsers:r}=t;Uo(t),ud.forEach((e=>e(n[0],r.find((e=>"member"===e.membership)))))}))}return ud.push(e),()=>(e=>{const t=ud.indexOf(e);t>-1&&ud.splice(t,1),0===ud.length&&(null==hd||hd())})(e)},pd=[];let gd=null;const md=e=>{if(0===pd.length){const e=ve();gd=Xe(e,"onChannelMemberRemoved","channel.membersRemoved",(async e=>{const t=await Jl(e),{channels:n,channelUsers:r}=t;Uo(t),pd.forEach((e=>e(n[0],r[0])))}))}return pd.push(e),()=>(e=>{const t=pd.indexOf(e);t>-1&&pd.splice(t,1),0===pd.length&&(null==gd||gd())})(e)},yd=[];let vd=null;const bd=e=>{if(0===yd.length){const e=ve();vd=Xe(e,"onChannelMemberUnbanned","channel.unbanned",(async e=>{const t=await Jl(e),{channels:n,channelUsers:r}=t;Uo(t),yd.forEach((e=>e(n[0],r.find((e=>"none"===e.membership)))))}))}return yd.push(e),()=>(e=>{const t=yd.indexOf(e);t>-1&&yd.splice(t,1),0===yd.length&&(null==vd||vd())})(e)},wd=[];let Sd=null;const Cd=e=>{if(0===wd.length){const e=ve();Sd=Xe(e,"onChannelMemberRoleAdded","local.channel-moderator.role-added",(async e=>{const{channels:t,channelUsers:n}=e;wd.forEach((e=>e(t[0],n.find((e=>"member"===e.membership)))))}))}return wd.push(e),()=>(e=>{const t=wd.indexOf(e);t>-1&&wd.splice(t,1),0===wd.length&&(null==Sd||Sd())})(e)},Td=[];let Ed=null;const Id=e=>{if(0===Td.length){const t=ve();Ed=Xe(t,"onChannelMemberRoleRemoved","local.channel-moderator.role-removed",(async t=>{const{channels:n,channelUsers:r}=t;e(n[0],r.find((e=>"member"===e.membership)))}))}return Td.push(e),()=>(e=>{const t=Td.indexOf(e);t>-1&&Td.splice(t,1),0===Td.length&&(null==Ed||Ed())})(e)},kd=e=>{const t=ve();return Xe(t,"feedMarker/onFeedMarkerUpdated","marker.feed-updated",(t=>{Uo(t),e(t.feedMarkers[0])}))},Ad=e=>{const t=ve(),n=Ke(),r=[Xe(t,"message/onMessageCreated","message.created",(async r=>{const s=await xl(r);t.isUnreadCountEnabled&&t.getMarkerSyncConsistentMode()&&r.messages.forEach((e=>{(e=>{var t;const n=ve(),r=["subChannelUnreadInfo","get",e.messageFeedId],s=null===(t=Se(r))||void 0===t?void 0:t.data;if(!s)return;const i=s.lastSegment<e.segment?e.segment:s.lastSegment,a=i-s.readToSegment;let{lastMentionSegment:o}=s;e.mentionedUsers&&e.mentionedUsers.length>0&&e.mentionedUsers.forEach((t=>{("channel"===t.type||"user"===t.type&&n.userId&&t.userPublicIds.includes(n.userId))&&(o=e.segment)}));const l=Object.assign(Object.assign({},s),{lastMentionSegment:o,lastSegment:i,isMentioned:!(s.readToSegment>=o),unreadCount:Math.max(a,0)});Ce(r,l)})(e),ul(e.channelId)})),t.useLegacyUnreadCount&&r.messages.forEach((e=>{var n,r;const s=null===(n=Se(["channelUnread","get",e.channelId]))||void 0===n?void 0:n.data;if(!s||s.lastSegment>=e.segment||"number"!=typeof s.readToSegment||"number"!=typeof s.lastMentionedSegment)return;const i=e.segment,a=(null===(r=e.mentionedUsers)||void 0===r?void 0:r.some((e=>"channel"===e.type||"user"===e.type&&t.userId&&e.userPublicIds.includes(t.userId))))?e.segment:s.lastMentionedSegment,o=Object.assign(Object.assign({},s),{lastSegment:i,unreadCount:Math.max(i-s.readToSegment,0),lastMentionedSegment:a,isMentioned:!(s.readToSegment>=a)});Ce(["channelUnread","get",e.channelId],o),Je("local.channelUnread.updated",o)})),Uo(s),s.messages.forEach((t=>{t.creatorPrivateId===n._id&&gl(t),e(t)}))}))];return()=>{r.forEach((e=>e()))}},_d=e=>{const t=ve(),n=[Xe(t,"message/onMessageCreated","local.message.created",(async t=>(Uo(t),t.messages.forEach((t=>{e(t)})))))];return()=>{n.forEach((e=>e()))}},Rd=e=>{const t=ve();return Xe(t,"onSubChannelCreated","message-feed.created",(async n=>{const r=await Nl(n);t.isUnreadCountEnabled&&t.getMarkerSyncConsistentMode()&&n.messageFeeds.forEach((e=>{(e=>{const{channelId:t,subChannelId:n,createdAt:r,updatedAt:s}=e,i={channelId:t,subChannelId:n,unreadCount:0,readToSegment:0,lastMentionSegment:0,lastSegment:0,isMentioned:!1,isDeleted:!1,createdAt:r,updatedAt:s};Ce(["subChannelUnreadInfo","get",i.subChannelId],i)})({channelId:e.channelId,subChannelId:e.messageFeedId,createdAt:e.createdAt,updatedAt:e.updatedAt})})),Uo(r),e(r.messageFeeds[0])}))},Od=e=>{const t=ve(),n=[Xe(t,"onSubChannelDeleted","message-feed.deleted",(async n=>{const r=await Nl(n);t.isUnreadCountEnabled&&t.getMarkerSyncConsistentMode()&&r.messageFeeds.forEach((e=>{(e=>{var t;const n=["subChannelUnreadInfo","get",e],r=null===(t=Se(n))||void 0===t?void 0:t.data;r&&Ce(n,Object.assign(Object.assign({},r),{isDeleted:!0}))})(e.subChannelId),ul(e.channelId)})),Uo(r),e(r.messageFeeds[0])})),Xe(t,"local.message-feed.deleted","local.message-feed.deleted",(t=>e(t.messageFeeds[0])))];return()=>{n.forEach((e=>e()))}},Ld=async e=>{const t=ve();t.log("channel/markerSync");const{data:n}=await t.http.post("/api/v1/markers/sync",{deviceLastSyncAt:e}),{userEntityMarkers:r,userFeedMarkers:s,feedMarkers:i,userMarkers:a}=n,o=Ko(r),l=Go(s),c=t.cache&&Date.now();return t.cache&&Uo({userEntityMarkers:o,userFeedMarkers:l,feedMarkers:i,userMarkers:a},{cachedAt:c}),Je("local.feedMarker.fetched",{feedMarkers:i}),Je("local.channelMarker.fetched",{userEntityMarkers:o}),Je("local.subChannelMarker.fetched",{userFeedMarkers:l}),Je("local.userMarker.fetched",{userMarkers:a}),{data:n,hasMore:n.feedMarkers.length>0}},Dd=()=>{const e=ve();if(e.log("client/api/isUnreadCountEnabled",e.isUnreadCountEnabled),!e)throw new fe("There is no active client",8e5,"fatal");return!e.isUnreadCountEnabled&&(e.isUnreadCountEnabled=!0,e.useLegacyUnreadCount=!1,e.emitter.emit("unreadCountEnabled",!0),!0)};let xd=!1,Pd=[],Md=!1,Fd=!0,Ud=null;const Nd=e=>{null!=e&&(!Ud||e.getTime()>Ud.getTime())&&(Ud=e)},Bd=async()=>{const{data:e}=await Il();null!=e&&Nd(new Date(e.lastSyncAt))};let jd=[];const $d=e=>{jd=e},qd=e=>jd.push(e),Kd=async()=>{if(!Md&&0!==jd.length)try{Md=!0,jd=[];const e=await Ld((null==Ud?new Date:Ud).toISOString()),t=e.data.userMarkers.reduce(((e,t)=>null==e||e.getTime()<new Date(t.lastSyncAt).getTime()?new Date(t.lastSyncAt):e),null);Nd(t),e.hasMore&&jd.push("has_more")}catch(e){}finally{Md&&(Md=!1)}},Gd=()=>{Pd.length>0||Pd.push(Bc((()=>{jd.push("resume")})),Ad((e=>{const t=ve();Ul(e)&&e.creatorId!==t.userId&&jd.push("new message")})),Jc((()=>jd.push("subchannel is created"))),Dc((()=>jd.push("subchannel is deleted"))),sd((()=>jd.push("subchannel is joined"))),od((()=>jd.push("subchannel is left"))),Rd((()=>jd.push("subchannel is created"))),Od((()=>setTimeout((()=>jd.push("subchannel is deleted")),2e3))),kd((()=>jd.push("feed marker updated"))),(e=>{const t=ve();return Xe(t,"UserMarker/onUserMarkerSync","marker.user-sync",(t=>{const{userMarkers:n,userEntityMarkers:r,userFeedMarkers:s}=t,i=Bo(t,["userMarkers","userEntityMarkers","userFeedMarkers"]),a=Ko(r),o=Go(s);Uo(Object.assign({userMarkers:n,userEntityMarkers:a,userFeedMarker:o},i)),e(n[0])}))})((()=>jd.push("feed marker updated"))),(e=>{const t=ve();return Xe(t,"feedMarker/onUserFeedMarkerUpdated","marker.userFeed-updated",(t=>{El(t),t.feedMarkers.forEach((t=>{e(t)}))}))})((()=>jd.push("feed marker updated"))))},Hd=()=>{Pd.forEach((e=>e())),Pd=[]},Vd=async()=>(await Bd(),qd("start syncing"),Fd=!0,xd=!0,Gd(),Hd);uc((async()=>{xd&&await Kd()}),2e3);const zd=()=>Fd;let Wd=[];const Yd=async(e,t,n)=>{var r;const s=ve();let i;s.log("client/api/connectClient",Object.assign({apiKey:s.apiKey,sessionState:s.sessionState},e)),s.userId&&s.userId!==e.userId&&(await Gc(),Wd.forEach((e=>e())),Wd=[]);const a=await Do();try{const{users:n}=await Ac({params:Object.assign(Object.assign({},e),{displayName:null==e?void 0:e.displayName,deviceId:(null==e?void 0:e.deviceId)||a}),options:{setAccessTokenCookie:!0}}),c=n.find((t=>t.userId===e.userId));if(null==c)throw new fe(`${e.userId} has not been founded`,8e5,"error");if(c.isDeleted)return Hc("userDeleted"),!1;if(c.isGlobalBanned)return Hc("globalBan"),!1;o=s.ws,l=s.emitter,We.forEach((e=>{null==o||o.on(e,(t=>{l.emit(e,t)}))})),null===(r=s.ws)||void 0===r||r.open(),s.userId=c.userId,s.sessionHandler=t,i=s.accessTokenExpiryWatcher(t),Ge(c)}catch(e){throw cc().setSessionState("notLoggedIn"),e}var o,l;if(!0!==(null==n?void 0:n.disableRTE)&&async function(){await tt()}(),await(async()=>{var e;const t=await vc();if(t===(null===(e=Se(["MessagePreviewSetting"]))||void 0===e?void 0:e.data))return;Ce(["MessagePreviewSetting"],t);const n=[],r=[];if("no-message-preview"===t){const e=we(["MessagePreview"]);e&&(null==e?void 0:e.length)>0&&e.forEach((({key:e,data:t})=>{Ie(e),e.includes("MessagePreviewChannel")&&n.push(t.channelId),e.includes("MessagePreviewSubChannel")&&r.push(t.subChannelId)}))}else if("message-preview-not-include-deleted"===t){const e=we(["MessagePreview"]);e&&(null==e?void 0:e.length)>0&&e.forEach((({key:e,data:t})=>{(null==t?void 0:t.isDeleted)&&(Ie(e),e.includes("MessagePreviewChannel")&&n.push(t.channelId),e.includes("MessagePreviewSubChannel")&&r.push(t.subChannelId))})),0!==n.length&&await ac(n),0!==r.length&&await yc(r)}})(),0===Wd.length){Wd.push(Wc((e=>{Hc("globalBan"),Wd.forEach((e=>e())),i()})),(e=>{const t=ve();return Xe(t,"client/onTokenTerminated","tokenTerminated",e)})((e=>{Hc(),Wd.forEach((e=>e())),i()})),Nc((e=>{e.userId===s.userId&&(Hc("userDeleted"),Wd.forEach((e=>e())),i())})),(e=>{const t=ve();return Xe(t,"client/onTokenExpired","tokenExpired",e)})((e=>{cc().setSessionState(e),Gc(),Wd.forEach((e=>e()))})),Dc(Yc),Mc(Yc),mc(),(()=>{const e=Zo();return e.established(),dc((t=>{"established"===t?e.established():e.handleTokenExpired()})),()=>{e.destroy()}})(),(()=>{const e=Kc();return e.startResolver(),dc((t=>{"established"===t?e.onSessionEstablished():"tokenExpired"===t?e.onTokenExpired():e.onSessionDestroyed()})),()=>{e.onSessionDestroyed()}})()),s.useLegacyUnreadCount?Wd.push((()=>{const e=dl();return e.startSyncReadReceipt(),dc((t=>{"established"===t?e.onSessionEstablished():"tokenExpired"===t?e.onTokenExpired():e.onSessionDestroyed()})),()=>{e.onSessionDestroyed()}})()):Wd.push((()=>{const e=pl();return e.startSyncReadReceipt(),dc((t=>{"established"===t?e.onSessionEstablished():"tokenExpired"===t?e.onTokenExpired():e.onSessionDestroyed()})),()=>{e.onSessionDestroyed()}})());const e=await Vd();Wd.push(e)}return!0},Qd=()=>{let e,t=!1;const n=ve();n.log("initiating access token renewal");const r=async r=>{const{userId:s,displayName:i}=Ke(),a={userId:s,displayName:i,authToken:r,deviceId:await Do()};"tokenExpired"===n.sessionState&&n.sessionHandler?await Yd(a,n.sessionHandler):await Ac({params:a,options:{setAccessTokenCookie:!0}}),t=!0,e&&clearTimeout(e)};return{renew:()=>{t?console.log("'renew' method can be called only once per renewal instance"):r()},renewWithAuthToken:e=>{t?console.log("'renewWithAuthToken' method can be called only once per renewal instance"):r(e)},unableToRetrieveAuthToken:()=>{e=setTimeout((()=>{var e;null===(e=n.sessionHandler)||void 0===e||e.sessionWillRenewAccessToken(Qd())}),b)}}},Xd=3e5,Jd=e=>{const t=setInterval((()=>{const t=ve();if(!t.token)return;const{issuedAt:n,expiresAt:r}=t.token;if((e=>Date.now()>Date.parse(e)-Xd)(r))return Je("tokenExpired","tokenExpired"),void ze((()=>e.sessionWillRenewAccessToken(Qd())));(e=>{const{expiresAt:t,issuedAt:n}=e,r=Date.parse(t),s=Date.parse(n),i=Date.now();return i>s+.8*(r-s-Xd)&&i<r})({expiresAt:r,issuedAt:n})&&e.sessionWillRenewAccessToken(Qd())}),b);return()=>clearInterval(t)};var Zd;class eu{constructor(){Zd.set(this,e.FileAccessTypeEnum.PUBLIC)}setFileAccessType(e){!function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===r?s.call(e,n):s?s.value=n:t.set(e,n)}(this,Zd,e,"f")}getFileAccessType(){return function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}(this,Zd,"f")}}let tu;Zd=new WeakMap;var nu=()=>(tu||(tu=new eu),tu);const ru=e=>{const t=ve();return Xe(t,"channelMarker/onChannelMarkerFetched","local.channelMarker.fetched",(t=>{t.userEntityMarkers.forEach((t=>{e(t)}))}))},su=e=>{const t=ve();return Xe(t,"subChannelMarker/onSubChannelMarkerFetched","local.subChannelMarker.fetched",(t=>{t.userFeedMarkers.forEach(e)}))},iu=e=>{const t=ve();return Xe(t,"subChannelMarker/onSubChannelMarkerUpdated","local.subChannelMarker.updated",(t=>{e(t.userFeedMarkers)}))},au=e=>{const t=ve();return Xe(t,"userMarker/onUserMarkerFetched","local.userMarker.fetched",(t=>{e(t.userMarkers)}))},ou=e=>{const t=ve();return Xe(t,"messageMarker/onMessageMarkerFetched","local.messageMarker.fetched",(t=>{e(t.contentMarkers[0])}))},lu=e=>{const t=ve();return Xe(t,"messageMarker/onMessageMarked","marker.marked-message",(t=>{var n,r,s;Uo(t);const i=we(["message","collection"]),{contentMarkers:a,feedMarkers:o}=t;if(i&&(null==i?void 0:i.length)>0&&(null==o?void 0:o.length)>0){const e=i.filter((e=>{var t,n;return(null===(n=null===(t=e.data)||void 0===t?void 0:t.query)||void 0===n?void 0:n.subChannelId)===o[0].feedId}));if(e.length>0&&(null==a?void 0:a.length)>0){(null!==(s=null===(r=null===(n=e[0].data)||void 0===n?void 0:n.data)||void 0===r?void 0:r.map((e=>Se(["message","get",e]))).map((({data:e})=>e)).filter(Boolean))&&void 0!==s?s:[]).forEach((e=>{var t,n;const r=["messageMarker","get",de("messageMarker")({creatorId:e.creatorPrivateId,feedId:e.subChannelId,contentId:e.messageId})],s=null===(t=Se(r))||void 0===t?void 0:t.data;if(!s)return;const i=a[0].feedId===s.feedId,o=a[0].readCount>s.readCount,l=(null===(n=a[0])||void 0===n?void 0:n.deliveredCount)>s.deliveredCount;if(i){const e=Object.assign(Object.assign({},s),{readCount:o?a[0].readCount:s.readCount,deliveredCount:l?a[0].deliveredCount:s.deliveredCount});Ce(r,e)}}))}}e(t.contentMarkers[0])}))};function cu(e){return"object"==typeof e&&null!==e}const du=e=>{if(!cu(e))return e;const t=Object.entries(e).map((([t,n])=>{const r=Object.getOwnPropertyDescriptor(e,t);return"function"==typeof(null==r?void 0:r.get)?[t,r.get.call(e)]:[t,n]}));return Object.fromEntries(t)},uu=e=>{if(!cu(e))return e;const t=Object.entries(e).map((([e,t])=>"function"==typeof t?[e,void 0]:[e,t]));return Object.fromEntries(t)};var hu=Object.freeze({__proto__:null,getActiveClient:ve,getActiveUser:Ke,setActiveUser:Ge,createClient:(e,t=At.SG,{debugSession:n="amity",apiEndpoint:r,prefixDeviceIdKey:s,rteEnabled:i=!0}={})=>{var a,o,l;const c=(e=>{const t=`${null==e?void 0:e.trim()}`.length>0&&!kt,n=Tt(e),r=(e,...r)=>{t&&n(e,r)};return r.__instance__=n,r})(n);c("client/api/createClient",{apiKey:e.replace(/.{5}$/g,"xxxxx"),apiRegion:t});const d=null!==(a=null==r?void 0:r.http)&&void 0!==a?a:Rt("http",t),u=null!==(o=null==r?void 0:r.upload)&&void 0!==o?o:Rt("upload",t),f=null!==(l=null==r?void 0:r.mqtt)&&void 0!==l?l:Rt("mqtt",t),p=mr(d),g=mr(u);let m,y;i&&(m=(e=>{const t=Oa(e,{autoConnect:!1,reconnectionDelay:2e3,transports:["websocket"]});return t.on("disconnect",(e=>{"io server disconnect"===e&&t.connect()})),t})(d),y=Fo(f));const v=Qe(),b={version:`${h}`,apiKey:e,log:c,cache:{data:{}},http:p,ws:m,mqtt:y,upload:g,emitter:v,sessionState:"notLoggedIn",accessTokenExpiryWatcher:Jd,sessionHandler:undefined,hasPermission:Sc,validateUrls:Cc,validateTexts:Tc,getFeedSettings:Ec,getSocialSettings:bc,getMessagePreviewSetting:vc,use:()=>be(b),isUnreadCountEnabled:!1,useLegacyUnreadCount:!0,getMarkerSyncConsistentMode:zd,prefixDeviceIdKey:s};try{const t=ve();if(t.apiKey===e)return t;be(b)}catch(e){be(b)}return b},login:Yd,logout:Gc,secureLogout:async()=>{const e=ve(),{data:{success:t}}=await e.http.delete("/api/v4/sessions");if(!t)throw new Error("Failed to logout");return await Gc()},isConnected:()=>{var e,t;const n=ve();n.log("client/api/isConnected",n);const r=n.ws&&n.ws.connected||!!n.ws;return!!(n.userId&&(null===(t=String(null===(e=n.http.defaults.headers.common)||void 0===e?void 0:e.Authorization))||void 0===t?void 0:t.length)&&r)},getFeedSettings:Ec,renewal:Qd,markerSync:Ld,enableUnreadCount:Dd,setUploadedFileAccessType:function(e){nu().setFileAccessType(e)},fetchLinkPreview:async e=>{const t=ve();let n=e;/^https?:\/\//i.test(e)||(n=`https://${e}`);const{data:r}=await t.http.get(`/api/v1/link-preview?url=${encodeURIComponent(n)}`);return r},onConnectionError:zc,onClientDisconnected:e=>zc((({code:t})=>{800211===t&&e()})),onClientBanned:Wc,onSessionStateChange:dc,onNetworkActivities:e=>fr().onNetworkActivities(e),getUserUnread:e=>{const{_id:t}=Ke();if(!t)throw new fe("The _id has not been defined in ActiveUser",8e5,"error");const{log:n,cache:r}=ve();r||console.log("For using Live Object feature you need to enable Cache!");n(`liveUserUnread(tmpid: ${Date.now()}) > listen`);const s=[];let i,a=!1;const o=t=>{const{data:n}=t,r=n?{unreadCount:n.unreadCount,isMentioned:n.isMentioned}:void 0;i=r?du(r):r,e({data:r?Object.assign(Object.assign({},r),{isMentioned:r.isMentioned}):r,loading:t.loading,error:t.error})};return s.push(au((e=>(e=>{var n;const r=e.filter((e=>t===e.userId)),s=r.reduce(((e,t)=>null==e||new Date(t.lastSyncAt).getTime()>new Date(e.lastSyncAt).getTime()?t:e),null),a={unreadCount:null!==(n=null==s?void 0:s.unreadCount)&&void 0!==n?n:0,isMentioned:r.some((e=>!!e.isMentioned))};rl(i,a)||o({loading:!1,data:a})})(e)))),(()=>{const e=ie(Il);oe(e,(({error:e,data:t,loading:n,origin:r,cachedAt:i})=>{!function(e){return null!=e&&null!=e}(t)?o({loading:n,data:void 0,origin:r,error:e}):(i===y?(o({data:t,origin:r,loading:!1,error:new pe(m,800800,"error")}),a=!0,s.forEach((e=>e()))):a||o({loading:n,data:t,origin:r,error:e}),e&&s.forEach((e=>e())))}))})(),()=>{s.forEach((e=>e()))}},getMarkerSyncEvents:()=>jd,setMarkerSyncEvents:$d,pushMarkerSyncEvent:qd,markerSyncTrigger:Kd,startMarkerSync:Vd,startUnreadSync:async()=>{await Bd(),qd("start syncing"),Dd(),Fd=!1,xd=!0,Gd()},stopUnreadSync:()=>{xd=!1,$d([]),Hd()},getMarkerSyncConsistentMode:zd});function fu(e){const{users:t,follows:n}=e,r=Bo(e,["users","follows"]);return Object.assign(Object.assign({},r),{follows:n,users:t.map(zl)})}function pu(e){const{users:t,follows:n}=e,r=Bo(e,["users","follows"]);return Object.assign(Object.assign({},r),{follows:n,users:t.map(zl)})}function gu(e){const{follows:t}=e,n=Bo(e,["follows"]);return Object.assign(Object.assign({},n),{follows:t})}const mu=(e,t)=>{const n=ve();return Xe(n,e,e,(e=>{const r=fu(e);n.cache?(Uo(r),t(r.follows[0])):t(r.follows[0])}))},yu=(e,t)=>{const n=ve();return Xe(n,e,e,(e=>{const r=gu(e);n.cache?(Uo(r),t(r.follows[0])):t(r.follows[0])}))},vu=e=>mu("follow.created",e),bu=e=>mu("follow.unfollowed",e),wu=e=>mu("follow.followerDeleted",e),Su=e=>mu("follow.requested",e),Cu=e=>mu("follow.requestCanceled",e),Tu=e=>mu("follow.accepted",e),Eu=e=>mu("follow.requestDeclined",e),Iu=async e=>{var t,n;const r=ve();r.log("follow/getFollowInfo",e);const{data:s}=await r.http.get(r.userId===e?"/api/v4/me/followInfo":`/api/v5/users/${e}/followInfo`),i=r.cache&&Date.now(),a="follows"in s?Object.assign(Object.assign({},s.followCounts[0]),{status:null===(n=null===(t=s.follows)||void 0===t?void 0:t[0])||void 0===n?void 0:n.status}):s.followCounts[0];return r.cache&&Ce(["followInfo","get",e],a,{cachedAt:i}),{data:a,cachedAt:i}};Iu.locally=e=>{const t=ve();if(t.log("follow/getFollowInfo.locally",e),!t.cache)return;const n=Se(["followInfo","get",e]);return n?{data:n.data,cachedAt:n.cachedAt}:void 0};const ku=e=>{const t=async t=>{const[{data:n},{data:r}]=await Promise.all([Iu(t.from),Iu(t.to)]);e(n),e(r)},n=[mu("follow.created",t),mu("follow.requested",t),mu("follow.accepted",t),mu("follow.unfollowed",t),mu("follow.requestCanceled",t),mu("follow.requestDeclined",t),mu("follow.followerDeleted",t),yu("local.follow.created",t),yu("local.follow.requested",t),yu("local.follow.accepted",t),yu("local.follow.unfollowed",t),yu("local.follow.requestDeclined",t)];return()=>{n.forEach((e=>e()))}},Au=e=>yu("local.follow.created",e),_u=e=>yu("local.follow.unfollowed",e),Ru=e=>yu("local.follow.requested",e),Ou=e=>yu("local.follow.accepted",e),Lu=e=>yu("local.follow.requestDeclined",e);var Du={exports:{}};!function(e,t){e.exports=function e(t,n,r){function s(a,o){if(!n[a]){if(!t[a]){if(!o&&La)return La(a);if(i)return i(a,!0);throw new Error("Cannot find module '"+a+"'")}o=n[a]={exports:{}},t[a][0].call(o.exports,(function(e){return s(t[a][1][e]||e)}),o,o.exports,e,t,n,r)}return n[a].exports}for(var i=La,a=0;a<r.length;a++)s(r[a]);return s}({1:[function(e,t,n){(function(r,s,i,a,o,l,c,d,u){var h=e("crypto");function f(e,t){var n;return void 0===(n="passthrough"!==(t=m(e,t)).algorithm?h.createHash(t.algorithm):new b).write&&(n.write=n.update,n.end=n.update),v(t,n).dispatch(e),n.update||n.end(""),n.digest?n.digest("buffer"===t.encoding?void 0:t.encoding):(e=n.read(),"buffer"!==t.encoding?e.toString(t.encoding):e)}(n=t.exports=f).sha1=function(e){return f(e)},n.keys=function(e){return f(e,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},n.MD5=function(e){return f(e,{algorithm:"md5",encoding:"hex"})},n.keysMD5=function(e){return f(e,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var p=h.getHashes?h.getHashes().slice():["sha1","md5"],g=(p.push("passthrough"),["buffer","hex","binary","base64"]);function m(e,t){var n={};if(n.algorithm=(t=t||{}).algorithm||"sha1",n.encoding=t.encoding||"hex",n.excludeValues=!!t.excludeValues,n.algorithm=n.algorithm.toLowerCase(),n.encoding=n.encoding.toLowerCase(),n.ignoreUnknown=!0===t.ignoreUnknown,n.respectType=!1!==t.respectType,n.respectFunctionNames=!1!==t.respectFunctionNames,n.respectFunctionProperties=!1!==t.respectFunctionProperties,n.unorderedArrays=!0===t.unorderedArrays,n.unorderedSets=!1!==t.unorderedSets,n.unorderedObjects=!1!==t.unorderedObjects,n.replacer=t.replacer||void 0,n.excludeKeys=t.excludeKeys||void 0,void 0===e)throw new Error("Object argument required.");for(var r=0;r<p.length;++r)p[r].toLowerCase()===n.algorithm.toLowerCase()&&(n.algorithm=p[r]);if(-1===p.indexOf(n.algorithm))throw new Error('Algorithm "'+n.algorithm+'"  not supported. supported values: '+p.join(", "));if(-1===g.indexOf(n.encoding)&&"passthrough"!==n.algorithm)throw new Error('Encoding "'+n.encoding+'"  not supported. supported values: '+g.join(", "));return n}function y(e){if("function"==typeof e)return null!=/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(e))}function v(e,t,n){function r(e){return t.update?t.update(e,"utf8"):t.write(e,"utf8")}return n=n||[],{dispatch:function(t){return this["_"+(null===(t=e.replacer?e.replacer(t):t)?"null":typeof t)](t)},_object:function(t){var s,a=Object.prototype.toString.call(t),o=/\[object (.*)\]/i.exec(a);if(o=(o=o?o[1]:"unknown:["+a+"]").toLowerCase(),0<=(a=n.indexOf(t)))return this.dispatch("[CIRCULAR:"+a+"]");if(n.push(t),void 0!==i&&i.isBuffer&&i.isBuffer(t))return r("buffer:"),r(t);if("object"===o||"function"===o||"asyncfunction"===o)return a=Object.keys(t),e.unorderedObjects&&(a=a.sort()),!1===e.respectType||y(t)||a.splice(0,0,"prototype","__proto__","constructor"),e.excludeKeys&&(a=a.filter((function(t){return!e.excludeKeys(t)}))),r("object:"+a.length+":"),s=this,a.forEach((function(n){s.dispatch(n),r(":"),e.excludeValues||s.dispatch(t[n]),r(",")}));if(!this["_"+o]){if(e.ignoreUnknown)return r("["+o+"]");throw new Error('Unknown object type "'+o+'"')}this["_"+o](t)},_array:function(t,s){s=void 0!==s?s:!1!==e.unorderedArrays;var i=this;if(r("array:"+t.length+":"),!s||t.length<=1)return t.forEach((function(e){return i.dispatch(e)}));var a=[];return s=t.map((function(t){var r=new b,s=n.slice();return v(e,r,s).dispatch(t),a=a.concat(s.slice(n.length)),r.read().toString()})),n=n.concat(a),s.sort(),this._array(s,!1)},_date:function(e){return r("date:"+e.toJSON())},_symbol:function(e){return r("symbol:"+e.toString())},_error:function(e){return r("error:"+e.toString())},_boolean:function(e){return r("bool:"+e.toString())},_string:function(e){r("string:"+e.length+":"),r(e.toString())},_function:function(t){r("fn:"),y(t)?this.dispatch("[native]"):this.dispatch(t.toString()),!1!==e.respectFunctionNames&&this.dispatch("function-name:"+String(t.name)),e.respectFunctionProperties&&this._object(t)},_number:function(e){return r("number:"+e.toString())},_xml:function(e){return r("xml:"+e.toString())},_null:function(){return r("Null")},_undefined:function(){return r("Undefined")},_regexp:function(e){return r("regex:"+e.toString())},_uint8array:function(e){return r("uint8array:"),this.dispatch(Array.prototype.slice.call(e))},_uint8clampedarray:function(e){return r("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(e))},_int8array:function(e){return r("int8array:"),this.dispatch(Array.prototype.slice.call(e))},_uint16array:function(e){return r("uint16array:"),this.dispatch(Array.prototype.slice.call(e))},_int16array:function(e){return r("int16array:"),this.dispatch(Array.prototype.slice.call(e))},_uint32array:function(e){return r("uint32array:"),this.dispatch(Array.prototype.slice.call(e))},_int32array:function(e){return r("int32array:"),this.dispatch(Array.prototype.slice.call(e))},_float32array:function(e){return r("float32array:"),this.dispatch(Array.prototype.slice.call(e))},_float64array:function(e){return r("float64array:"),this.dispatch(Array.prototype.slice.call(e))},_arraybuffer:function(e){return r("arraybuffer:"),this.dispatch(new Uint8Array(e))},_url:function(e){return r("url:"+e.toString())},_map:function(t){return r("map:"),t=Array.from(t),this._array(t,!1!==e.unorderedSets)},_set:function(t){return r("set:"),t=Array.from(t),this._array(t,!1!==e.unorderedSets)},_file:function(e){return r("file:"),this.dispatch([e.name,e.size,e.type,e.lastModfied])},_blob:function(){if(e.ignoreUnknown)return r("[blob]");throw Error('Hashing Blob objects is currently not supported\n(see https://github.com/puleos/object-hash/issues/26)\nUse "options.replacer" or "options.ignoreUnknown"\n')},_domwindow:function(){return r("domwindow")},_bigint:function(e){return r("bigint:"+e.toString())},_process:function(){return r("process")},_timer:function(){return r("timer")},_pipe:function(){return r("pipe")},_tcp:function(){return r("tcp")},_udp:function(){return r("udp")},_tty:function(){return r("tty")},_statwatcher:function(){return r("statwatcher")},_securecontext:function(){return r("securecontext")},_connection:function(){return r("connection")},_zlib:function(){return r("zlib")},_context:function(){return r("context")},_nodescript:function(){return r("nodescript")},_httpparser:function(){return r("httpparser")},_dataview:function(){return r("dataview")},_signal:function(){return r("signal")},_fsevent:function(){return r("fsevent")},_tlswrap:function(){return r("tlswrap")}}}function b(){return{buf:"",write:function(e){this.buf+=e},end:function(e){this.buf+=e},read:function(){return this.buf}}}n.writeToStream=function(e,t,n){return void 0===n&&(n=t,t={}),v(t=m(e,t),n).dispatch(e)}}).call(this,e("lYpoI2"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_9a5aa49d.js","/")},{buffer:3,crypto:5,lYpoI2:11}],2:[function(e,t,n){(function(e,t,r,s,i,a,o,l,c){!function(e){var t="undefined"!=typeof Uint8Array?Uint8Array:Array,n="+".charCodeAt(0),r="/".charCodeAt(0),s="0".charCodeAt(0),i="a".charCodeAt(0),a="A".charCodeAt(0),o="-".charCodeAt(0),l="_".charCodeAt(0);function c(e){return(e=e.charCodeAt(0))===n||e===o?62:e===r||e===l?63:e<s?-1:e<s+10?e-s+26+26:e<a+26?e-a:e<i+26?e-i+26:void 0}e.toByteArray=function(e){var n,r;if(0<e.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var s=e.length,i=(s="="===e.charAt(s-2)?2:"="===e.charAt(s-1)?1:0,new t(3*e.length/4-s)),a=0<s?e.length-4:e.length,o=0;function l(e){i[o++]=e}for(n=0;n<a;n+=4,0)l((16711680&(r=c(e.charAt(n))<<18|c(e.charAt(n+1))<<12|c(e.charAt(n+2))<<6|c(e.charAt(n+3))))>>16),l((65280&r)>>8),l(255&r);return 2==s?l(255&(r=c(e.charAt(n))<<2|c(e.charAt(n+1))>>4)):1==s&&(l((r=c(e.charAt(n))<<10|c(e.charAt(n+1))<<4|c(e.charAt(n+2))>>2)>>8&255),l(255&r)),i},e.fromByteArray=function(e){var t,n,r,s,i=e.length%3,a="";function o(e){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e)}for(t=0,r=e.length-i;t<r;t+=3)a+=o((s=n=(e[t]<<16)+(e[t+1]<<8)+e[t+2])>>18&63)+o(s>>12&63)+o(s>>6&63)+o(63&s);switch(i){case 1:a=(a+=o((n=e[e.length-1])>>2))+o(n<<4&63)+"==";break;case 2:a=(a=(a+=o((n=(e[e.length-2]<<8)+e[e.length-1])>>10))+o(n>>4&63))+o(n<<2&63)+"="}return a}}(void 0===n?this.base64js={}:n)}).call(this,e("lYpoI2"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:11}],3:[function(e,t,n){(function(t,r,s,i,a,o,l,c,d){var u=e("base64-js"),h=e("ieee754");function s(e,t,n){if(!(this instanceof s))return new s(e,t,n);var r,i,a,o,l=typeof e;if("base64"===t&&"string"==l)for(e=(o=e).trim?o.trim():o.replace(/^\s+|\s+$/g,"");e.length%4!=0;)e+="=";if("number"==l)r=O(e);else if("string"==l)r=s.byteLength(e,t);else{if("object"!=l)throw new Error("First argument needs to be a number, array or string.");r=O(e.length)}if(s._useTypedArrays?i=s._augment(new Uint8Array(r)):((i=this).length=r,i._isBuffer=!0),s._useTypedArrays&&"number"==typeof e.byteLength)i._set(e);else if(L(o=e)||s.isBuffer(o)||o&&"object"==typeof o&&"number"==typeof o.length)for(a=0;a<r;a++)s.isBuffer(e)?i[a]=e.readUInt8(a):i[a]=e[a];else if("string"==l)i.write(e,0,t);else if("number"==l&&!s._useTypedArrays&&!n)for(a=0;a<r;a++)i[a]=0;return i}function f(e,t,n,r){return s._charsWritten=M(function(e){for(var t=[],n=0;n<e.length;n++)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function p(e,t,n,r){return s._charsWritten=M(function(e){for(var t,n,r=[],s=0;s<e.length;s++)t=(n=e.charCodeAt(s))>>8,n%=256,r.push(n),r.push(t);return r}(t),e,n,r)}function g(e,t,n){var r="";n=Math.min(e.length,n);for(var s=t;s<n;s++)r+=String.fromCharCode(e[s]);return r}function m(e,t,n,r){var s;if(r||(j("boolean"==typeof n,"missing or invalid endian"),j(null!=t,"missing offset"),j(t+1<e.length,"Trying to read beyond buffer length")),!((r=e.length)<=t))return n?(s=e[t],t+1<r&&(s|=e[t+1]<<8)):(s=e[t]<<8,t+1<r&&(s|=e[t+1])),s}function y(e,t,n,r){var s;if(r||(j("boolean"==typeof n,"missing or invalid endian"),j(null!=t,"missing offset"),j(t+3<e.length,"Trying to read beyond buffer length")),!((r=e.length)<=t))return n?(t+2<r&&(s=e[t+2]<<16),t+1<r&&(s|=e[t+1]<<8),s|=e[t],t+3<r&&(s+=e[t+3]<<24>>>0)):(t+1<r&&(s=e[t+1]<<16),t+2<r&&(s|=e[t+2]<<8),t+3<r&&(s|=e[t+3]),s+=e[t]<<24>>>0),s}function v(e,t,n,r){if(r||(j("boolean"==typeof n,"missing or invalid endian"),j(null!=t,"missing offset"),j(t+1<e.length,"Trying to read beyond buffer length")),!(e.length<=t))return 32768&(r=m(e,t,n,!0))?-1*(65535-r+1):r}function b(e,t,n,r){if(r||(j("boolean"==typeof n,"missing or invalid endian"),j(null!=t,"missing offset"),j(t+3<e.length,"Trying to read beyond buffer length")),!(e.length<=t))return 2147483648&(r=y(e,t,n,!0))?-1*(4294967295-r+1):r}function w(e,t,n,r){return r||(j("boolean"==typeof n,"missing or invalid endian"),j(t+3<e.length,"Trying to read beyond buffer length")),h.read(e,t,n,23,4)}function S(e,t,n,r){return r||(j("boolean"==typeof n,"missing or invalid endian"),j(t+7<e.length,"Trying to read beyond buffer length")),h.read(e,t,n,52,8)}function C(e,t,n,r,s){if(s||(j(null!=t,"missing value"),j("boolean"==typeof r,"missing or invalid endian"),j(null!=n,"missing offset"),j(n+1<e.length,"trying to write beyond buffer length"),U(t,65535)),!((s=e.length)<=n))for(var i=0,a=Math.min(s-n,2);i<a;i++)e[n+i]=(t&255<<8*(r?i:1-i))>>>8*(r?i:1-i)}function T(e,t,n,r,s){if(s||(j(null!=t,"missing value"),j("boolean"==typeof r,"missing or invalid endian"),j(null!=n,"missing offset"),j(n+3<e.length,"trying to write beyond buffer length"),U(t,4294967295)),!((s=e.length)<=n))for(var i=0,a=Math.min(s-n,4);i<a;i++)e[n+i]=t>>>8*(r?i:3-i)&255}function E(e,t,n,r,s){s||(j(null!=t,"missing value"),j("boolean"==typeof r,"missing or invalid endian"),j(null!=n,"missing offset"),j(n+1<e.length,"Trying to write beyond buffer length"),N(t,32767,-32768)),e.length<=n||C(e,0<=t?t:65535+t+1,n,r,s)}function I(e,t,n,r,s){s||(j(null!=t,"missing value"),j("boolean"==typeof r,"missing or invalid endian"),j(null!=n,"missing offset"),j(n+3<e.length,"Trying to write beyond buffer length"),N(t,2147483647,-2147483648)),e.length<=n||T(e,0<=t?t:4294967295+t+1,n,r,s)}function k(e,t,n,r,s){s||(j(null!=t,"missing value"),j("boolean"==typeof r,"missing or invalid endian"),j(null!=n,"missing offset"),j(n+3<e.length,"Trying to write beyond buffer length"),B(t,34028234663852886e22,-34028234663852886e22)),e.length<=n||h.write(e,t,n,r,23,4)}function A(e,t,n,r,s){s||(j(null!=t,"missing value"),j("boolean"==typeof r,"missing or invalid endian"),j(null!=n,"missing offset"),j(n+7<e.length,"Trying to write beyond buffer length"),B(t,17976931348623157e292,-17976931348623157e292)),e.length<=n||h.write(e,t,n,r,52,8)}n.Buffer=s,n.SlowBuffer=s,n.INSPECT_MAX_BYTES=50,s.poolSize=8192,s._useTypedArrays=function(){try{var e=new ArrayBuffer(0),t=new Uint8Array(e);return t.foo=function(){return 42},42===t.foo()&&"function"==typeof t.subarray}catch(e){return!1}}(),s.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},s.isBuffer=function(e){return!(null==e||!e._isBuffer)},s.byteLength=function(e,t){var n;switch(e+="",t||"utf8"){case"hex":n=e.length/2;break;case"utf8":case"utf-8":n=x(e).length;break;case"ascii":case"binary":case"raw":n=e.length;break;case"base64":n=P(e).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":n=2*e.length;break;default:throw new Error("Unknown encoding")}return n},s.concat=function(e,t){if(j(L(e),"Usage: Buffer.concat(list, [totalLength])\nlist should be an Array."),0===e.length)return new s(0);if(1===e.length)return e[0];if("number"!=typeof t)for(i=t=0;i<e.length;i++)t+=e[i].length;for(var n=new s(t),r=0,i=0;i<e.length;i++){var a=e[i];a.copy(n,r),r+=a.length}return n},s.prototype.write=function(e,t,n,r){isFinite(t)?isFinite(n)||(r=n,n=void 0):(c=r,r=t,t=n,n=c),t=Number(t)||0;var i,a,o,l,c=this.length-t;switch((!n||c<(n=Number(n)))&&(n=c),r=String(r||"utf8").toLowerCase()){case"hex":i=function(e,t,n,r){n=Number(n)||0;var i=e.length-n;(!r||i<(r=Number(r)))&&(r=i),j((i=t.length)%2==0,"Invalid hex string"),i/2<r&&(r=i/2);for(var a=0;a<r;a++){var o=parseInt(t.substr(2*a,2),16);j(!isNaN(o),"Invalid hex string"),e[n+a]=o}return s._charsWritten=2*a,a}(this,e,t,n);break;case"utf8":case"utf-8":a=this,o=t,l=n,i=s._charsWritten=M(x(e),a,o,l);break;case"ascii":case"binary":i=f(this,e,t,n);break;case"base64":a=this,o=t,l=n,i=s._charsWritten=M(P(e),a,o,l);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":i=p(this,e,t,n);break;default:throw new Error("Unknown encoding")}return i},s.prototype.toString=function(e,t,n){var r,s,i,a,o=this;if(e=String(e||"utf8").toLowerCase(),t=Number(t)||0,(n=void 0!==n?Number(n):o.length)===t)return"";switch(e){case"hex":r=function(e,t,n){var r=e.length;(!t||t<0)&&(t=0),(!n||n<0||r<n)&&(n=r);for(var s="",i=t;i<n;i++)s+=D(e[i]);return s}(o,t,n);break;case"utf8":case"utf-8":r=function(e,t,n){var r="",s="";n=Math.min(e.length,n);for(var i=t;i<n;i++)e[i]<=127?(r+=F(s)+String.fromCharCode(e[i]),s=""):s+="%"+e[i].toString(16);return r+F(s)}(o,t,n);break;case"ascii":case"binary":r=g(o,t,n);break;case"base64":s=o,a=n,r=0===(i=t)&&a===s.length?u.fromByteArray(s):u.fromByteArray(s.slice(i,a));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":r=function(e,t,n){for(var r=e.slice(t,n),s="",i=0;i<r.length;i+=2)s+=String.fromCharCode(r[i]+256*r[i+1]);return s}(o,t,n);break;default:throw new Error("Unknown encoding")}return r},s.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},s.prototype.copy=function(e,t,n,r){if(t=t||0,(r=r||0===r?r:this.length)!==(n=n||0)&&0!==e.length&&0!==this.length){j(n<=r,"sourceEnd < sourceStart"),j(0<=t&&t<e.length,"targetStart out of bounds"),j(0<=n&&n<this.length,"sourceStart out of bounds"),j(0<=r&&r<=this.length,"sourceEnd out of bounds"),r>this.length&&(r=this.length);var i=(r=e.length-t<r-n?e.length-t+n:r)-n;if(i<100||!s._useTypedArrays)for(var a=0;a<i;a++)e[a+t]=this[a+n];else e._set(this.subarray(n,n+i),t)}},s.prototype.slice=function(e,t){var n=this.length;if(e=R(e,n,0),t=R(t,n,n),s._useTypedArrays)return s._augment(this.subarray(e,t));for(var r=t-e,i=new s(r,void 0,!0),a=0;a<r;a++)i[a]=this[a+e];return i},s.prototype.get=function(e){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(e)},s.prototype.set=function(e,t){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(e,t)},s.prototype.readUInt8=function(e,t){if(t||(j(null!=e,"missing offset"),j(e<this.length,"Trying to read beyond buffer length")),!(e>=this.length))return this[e]},s.prototype.readUInt16LE=function(e,t){return m(this,e,!0,t)},s.prototype.readUInt16BE=function(e,t){return m(this,e,!1,t)},s.prototype.readUInt32LE=function(e,t){return y(this,e,!0,t)},s.prototype.readUInt32BE=function(e,t){return y(this,e,!1,t)},s.prototype.readInt8=function(e,t){if(t||(j(null!=e,"missing offset"),j(e<this.length,"Trying to read beyond buffer length")),!(e>=this.length))return 128&this[e]?-1*(255-this[e]+1):this[e]},s.prototype.readInt16LE=function(e,t){return v(this,e,!0,t)},s.prototype.readInt16BE=function(e,t){return v(this,e,!1,t)},s.prototype.readInt32LE=function(e,t){return b(this,e,!0,t)},s.prototype.readInt32BE=function(e,t){return b(this,e,!1,t)},s.prototype.readFloatLE=function(e,t){return w(this,e,!0,t)},s.prototype.readFloatBE=function(e,t){return w(this,e,!1,t)},s.prototype.readDoubleLE=function(e,t){return S(this,e,!0,t)},s.prototype.readDoubleBE=function(e,t){return S(this,e,!1,t)},s.prototype.writeUInt8=function(e,t,n){n||(j(null!=e,"missing value"),j(null!=t,"missing offset"),j(t<this.length,"trying to write beyond buffer length"),U(e,255)),t>=this.length||(this[t]=e)},s.prototype.writeUInt16LE=function(e,t,n){C(this,e,t,!0,n)},s.prototype.writeUInt16BE=function(e,t,n){C(this,e,t,!1,n)},s.prototype.writeUInt32LE=function(e,t,n){T(this,e,t,!0,n)},s.prototype.writeUInt32BE=function(e,t,n){T(this,e,t,!1,n)},s.prototype.writeInt8=function(e,t,n){n||(j(null!=e,"missing value"),j(null!=t,"missing offset"),j(t<this.length,"Trying to write beyond buffer length"),N(e,127,-128)),t>=this.length||(0<=e?this.writeUInt8(e,t,n):this.writeUInt8(255+e+1,t,n))},s.prototype.writeInt16LE=function(e,t,n){E(this,e,t,!0,n)},s.prototype.writeInt16BE=function(e,t,n){E(this,e,t,!1,n)},s.prototype.writeInt32LE=function(e,t,n){I(this,e,t,!0,n)},s.prototype.writeInt32BE=function(e,t,n){I(this,e,t,!1,n)},s.prototype.writeFloatLE=function(e,t,n){k(this,e,t,!0,n)},s.prototype.writeFloatBE=function(e,t,n){k(this,e,t,!1,n)},s.prototype.writeDoubleLE=function(e,t,n){A(this,e,t,!0,n)},s.prototype.writeDoubleBE=function(e,t,n){A(this,e,t,!1,n)},s.prototype.fill=function(e,t,n){if(t=t||0,n=n||this.length,j("number"==typeof(e="string"==typeof(e=e||0)?e.charCodeAt(0):e)&&!isNaN(e),"value is not a number"),j(t<=n,"end < start"),n!==t&&0!==this.length){j(0<=t&&t<this.length,"start out of bounds"),j(0<=n&&n<=this.length,"end out of bounds");for(var r=t;r<n;r++)this[r]=e}},s.prototype.inspect=function(){for(var e=[],t=this.length,r=0;r<t;r++)if(e[r]=D(this[r]),r===n.INSPECT_MAX_BYTES){e[r+1]="...";break}return"<Buffer "+e.join(" ")+">"},s.prototype.toArrayBuffer=function(){if("undefined"==typeof Uint8Array)throw new Error("Buffer.toArrayBuffer not supported in this browser");if(s._useTypedArrays)return new s(this).buffer;for(var e=new Uint8Array(this.length),t=0,n=e.length;t<n;t+=1)e[t]=this[t];return e.buffer};var _=s.prototype;function R(e,t,n){return"number"!=typeof e?n:t<=(e=~~e)?t:0<=e||0<=(e+=t)?e:0}function O(e){return(e=~~Math.ceil(+e))<0?0:e}function L(e){return(Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)})(e)}function D(e){return e<16?"0"+e.toString(16):e.toString(16)}function x(e){for(var t=[],n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<=127)t.push(e.charCodeAt(n));else for(var s=n,i=(55296<=r&&r<=57343&&n++,encodeURIComponent(e.slice(s,n+1)).substr(1).split("%")),a=0;a<i.length;a++)t.push(parseInt(i[a],16))}return t}function P(e){return u.toByteArray(e)}function M(e,t,n,r){for(var s=0;s<r&&!(s+n>=t.length||s>=e.length);s++)t[s+n]=e[s];return s}function F(e){try{return decodeURIComponent(e)}catch(e){return String.fromCharCode(65533)}}function U(e,t){j("number"==typeof e,"cannot write a non-number as a number"),j(0<=e,"specified a negative value for writing an unsigned value"),j(e<=t,"value is larger than maximum value for type"),j(Math.floor(e)===e,"value has a fractional component")}function N(e,t,n){j("number"==typeof e,"cannot write a non-number as a number"),j(e<=t,"value larger than maximum allowed value"),j(n<=e,"value smaller than minimum allowed value"),j(Math.floor(e)===e,"value has a fractional component")}function B(e,t,n){j("number"==typeof e,"cannot write a non-number as a number"),j(e<=t,"value larger than maximum allowed value"),j(n<=e,"value smaller than minimum allowed value")}function j(e,t){if(!e)throw new Error(t||"Failed assertion")}s._augment=function(e){return e._isBuffer=!0,e._get=e.get,e._set=e.set,e.get=_.get,e.set=_.set,e.write=_.write,e.toString=_.toString,e.toLocaleString=_.toString,e.toJSON=_.toJSON,e.copy=_.copy,e.slice=_.slice,e.readUInt8=_.readUInt8,e.readUInt16LE=_.readUInt16LE,e.readUInt16BE=_.readUInt16BE,e.readUInt32LE=_.readUInt32LE,e.readUInt32BE=_.readUInt32BE,e.readInt8=_.readInt8,e.readInt16LE=_.readInt16LE,e.readInt16BE=_.readInt16BE,e.readInt32LE=_.readInt32LE,e.readInt32BE=_.readInt32BE,e.readFloatLE=_.readFloatLE,e.readFloatBE=_.readFloatBE,e.readDoubleLE=_.readDoubleLE,e.readDoubleBE=_.readDoubleBE,e.writeUInt8=_.writeUInt8,e.writeUInt16LE=_.writeUInt16LE,e.writeUInt16BE=_.writeUInt16BE,e.writeUInt32LE=_.writeUInt32LE,e.writeUInt32BE=_.writeUInt32BE,e.writeInt8=_.writeInt8,e.writeInt16LE=_.writeInt16LE,e.writeInt16BE=_.writeInt16BE,e.writeInt32LE=_.writeInt32LE,e.writeInt32BE=_.writeInt32BE,e.writeFloatLE=_.writeFloatLE,e.writeFloatBE=_.writeFloatBE,e.writeDoubleLE=_.writeDoubleLE,e.writeDoubleBE=_.writeDoubleBE,e.fill=_.fill,e.inspect=_.inspect,e.toArrayBuffer=_.toArrayBuffer,e}}).call(this,e("lYpoI2"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:10,lYpoI2:11}],4:[function(e,t,n){(function(n,r,s,i,a,o,l,c,d){s=e("buffer").Buffer;var u=4,h=new s(u);h.fill(0),t.exports={hash:function(e,t,n,r){for(var i=t(function(e,t){e.length%u!=0&&(n=e.length+(u-e.length%u),e=s.concat([e,h],n));for(var n,r=[],i=t?e.readInt32BE:e.readInt32LE,a=0;a<e.length;a+=u)r.push(i.call(e,a));return r}(e=s.isBuffer(e)?e:new s(e),r),8*e.length),a=(t=r,new s(n)),o=t?a.writeInt32BE:a.writeInt32LE,l=0;l<i.length;l++)o.call(a,i[l],4*l,!0);return a}}}).call(this,e("lYpoI2"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],5:[function(e,t,n){(function(t,r,s,i,a,o,l,c,d){s=e("buffer").Buffer;var u=e("./sha"),h=e("./sha256"),f=e("./rng"),p={sha1:u,sha256:h,md5:e("./md5")},g=64,m=new s(g);function y(e,t){var n=p[e=e||"sha1"],r=[];return n||v("algorithm:",e,"is not yet supported"),{update:function(e){return s.isBuffer(e)||(e=new s(e)),r.push(e),e.length,this},digest:function(e){var i=s.concat(r);return i=t?function(e,t,n){s.isBuffer(t)||(t=new s(t)),s.isBuffer(n)||(n=new s(n)),t.length>g?t=e(t):t.length<g&&(t=s.concat([t,m],g));for(var r=new s(g),i=new s(g),a=0;a<g;a++)r[a]=54^t[a],i[a]=92^t[a];return n=e(s.concat([r,n])),e(s.concat([i,n]))}(n,t,i):n(i),r=null,e?i.toString(e):i}}}function v(){var e=[].slice.call(arguments).join(" ");throw new Error([e,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join("\n"))}m.fill(0),n.createHash=function(e){return y(e)},n.createHmac=y,n.randomBytes=function(e,t){if(!t||!t.call)return new s(f(e));try{t.call(this,void 0,new s(f(e)))}catch(e){t(e)}};var b,w=["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],S=function(e){n[e]=function(){v("sorry,",e,"is not implemented yet")}};for(b in w)S(w[b])}).call(this,e("lYpoI2"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:11}],6:[function(e,t,n){(function(n,r,s,i,a,o,l,c,d){var u=e("./helpers");function h(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,r=-271733879,s=-1732584194,i=271733878,a=0;a<e.length;a+=16){var o=n,l=r,c=s,d=i;n=p(n,r,s,i,e[a+0],7,-680876936),i=p(i,n,r,s,e[a+1],12,-389564586),s=p(s,i,n,r,e[a+2],17,606105819),r=p(r,s,i,n,e[a+3],22,-1044525330),n=p(n,r,s,i,e[a+4],7,-176418897),i=p(i,n,r,s,e[a+5],12,1200080426),s=p(s,i,n,r,e[a+6],17,-1473231341),r=p(r,s,i,n,e[a+7],22,-45705983),n=p(n,r,s,i,e[a+8],7,1770035416),i=p(i,n,r,s,e[a+9],12,-1958414417),s=p(s,i,n,r,e[a+10],17,-42063),r=p(r,s,i,n,e[a+11],22,-1990404162),n=p(n,r,s,i,e[a+12],7,1804603682),i=p(i,n,r,s,e[a+13],12,-40341101),s=p(s,i,n,r,e[a+14],17,-1502002290),n=g(n,r=p(r,s,i,n,e[a+15],22,1236535329),s,i,e[a+1],5,-165796510),i=g(i,n,r,s,e[a+6],9,-1069501632),s=g(s,i,n,r,e[a+11],14,643717713),r=g(r,s,i,n,e[a+0],20,-373897302),n=g(n,r,s,i,e[a+5],5,-701558691),i=g(i,n,r,s,e[a+10],9,38016083),s=g(s,i,n,r,e[a+15],14,-660478335),r=g(r,s,i,n,e[a+4],20,-405537848),n=g(n,r,s,i,e[a+9],5,568446438),i=g(i,n,r,s,e[a+14],9,-1019803690),s=g(s,i,n,r,e[a+3],14,-187363961),r=g(r,s,i,n,e[a+8],20,1163531501),n=g(n,r,s,i,e[a+13],5,-1444681467),i=g(i,n,r,s,e[a+2],9,-51403784),s=g(s,i,n,r,e[a+7],14,1735328473),n=m(n,r=g(r,s,i,n,e[a+12],20,-1926607734),s,i,e[a+5],4,-378558),i=m(i,n,r,s,e[a+8],11,-2022574463),s=m(s,i,n,r,e[a+11],16,1839030562),r=m(r,s,i,n,e[a+14],23,-35309556),n=m(n,r,s,i,e[a+1],4,-1530992060),i=m(i,n,r,s,e[a+4],11,1272893353),s=m(s,i,n,r,e[a+7],16,-155497632),r=m(r,s,i,n,e[a+10],23,-1094730640),n=m(n,r,s,i,e[a+13],4,681279174),i=m(i,n,r,s,e[a+0],11,-358537222),s=m(s,i,n,r,e[a+3],16,-722521979),r=m(r,s,i,n,e[a+6],23,76029189),n=m(n,r,s,i,e[a+9],4,-640364487),i=m(i,n,r,s,e[a+12],11,-421815835),s=m(s,i,n,r,e[a+15],16,530742520),n=y(n,r=m(r,s,i,n,e[a+2],23,-995338651),s,i,e[a+0],6,-198630844),i=y(i,n,r,s,e[a+7],10,1126891415),s=y(s,i,n,r,e[a+14],15,-1416354905),r=y(r,s,i,n,e[a+5],21,-57434055),n=y(n,r,s,i,e[a+12],6,1700485571),i=y(i,n,r,s,e[a+3],10,-1894986606),s=y(s,i,n,r,e[a+10],15,-1051523),r=y(r,s,i,n,e[a+1],21,-2054922799),n=y(n,r,s,i,e[a+8],6,1873313359),i=y(i,n,r,s,e[a+15],10,-30611744),s=y(s,i,n,r,e[a+6],15,-1560198380),r=y(r,s,i,n,e[a+13],21,1309151649),n=y(n,r,s,i,e[a+4],6,-145523070),i=y(i,n,r,s,e[a+11],10,-1120210379),s=y(s,i,n,r,e[a+2],15,718787259),r=y(r,s,i,n,e[a+9],21,-343485551),n=v(n,o),r=v(r,l),s=v(s,c),i=v(i,d)}return Array(n,r,s,i)}function f(e,t,n,r,s,i){return v((t=v(v(t,e),v(r,i)))<<s|t>>>32-s,n)}function p(e,t,n,r,s,i,a){return f(t&n|~t&r,e,t,s,i,a)}function g(e,t,n,r,s,i,a){return f(t&r|n&~r,e,t,s,i,a)}function m(e,t,n,r,s,i,a){return f(t^n^r,e,t,s,i,a)}function y(e,t,n,r,s,i,a){return f(n^(t|~r),e,t,s,i,a)}function v(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}t.exports=function(e){return u.hash(e,h,16)}}).call(this,e("lYpoI2"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],7:[function(e,t,n){(function(e,n,r,s,i,a,o,l,c){t.exports=function(e){for(var t,n=new Array(e),r=0;r<e;r++)0==(3&r)&&(t=4294967296*Math.random()),n[r]=t>>>((3&r)<<3)&255;return n}}).call(this,e("lYpoI2"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],8:[function(e,t,n){(function(n,r,s,i,a,o,l,c,d){var u=e("./helpers");function h(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var n,r,s,i=Array(80),a=1732584193,o=-271733879,l=-1732584194,c=271733878,d=-1009589776,u=0;u<e.length;u+=16){for(var h=a,g=o,m=l,y=c,v=d,b=0;b<80;b++){i[b]=b<16?e[u+b]:p(i[b-3]^i[b-8]^i[b-14]^i[b-16],1);var w=f(f(p(a,5),(w=o,r=l,s=c,(n=b)<20?w&r|~w&s:!(n<40)&&n<60?w&r|w&s|r&s:w^r^s)),f(f(d,i[b]),(n=b)<20?1518500249:n<40?1859775393:n<60?-1894007588:-899497514));d=c,c=l,l=p(o,30),o=a,a=w}a=f(a,h),o=f(o,g),l=f(l,m),c=f(c,y),d=f(d,v)}return Array(a,o,l,c,d)}function f(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function p(e,t){return e<<t|e>>>32-t}t.exports=function(e){return u.hash(e,h,20,!0)}}).call(this,e("lYpoI2"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],9:[function(e,t,n){(function(n,r,s,i,a,o,l,c,d){function u(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function h(e,t){var n,r=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),s=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),i=new Array(64);e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var a,o,l=0;l<e.length;l+=16){for(var c=s[0],d=s[1],h=s[2],f=s[3],m=s[4],y=s[5],v=s[6],b=s[7],w=0;w<64;w++)i[w]=w<16?e[w+l]:u(u(u((o=i[w-2],p(o,17)^p(o,19)^g(o,10)),i[w-7]),(o=i[w-15],p(o,7)^p(o,18)^g(o,3))),i[w-16]),n=u(u(u(u(b,p(o=m,6)^p(o,11)^p(o,25)),m&y^~m&v),r[w]),i[w]),a=u(p(a=c,2)^p(a,13)^p(a,22),c&d^c&h^d&h),b=v,v=y,y=m,m=u(f,n),f=h,h=d,d=c,c=u(n,a);s[0]=u(c,s[0]),s[1]=u(d,s[1]),s[2]=u(h,s[2]),s[3]=u(f,s[3]),s[4]=u(m,s[4]),s[5]=u(y,s[5]),s[6]=u(v,s[6]),s[7]=u(b,s[7])}return s}var f=e("./helpers"),p=function(e,t){return e>>>t|e<<32-t},g=function(e,t){return e>>>t};t.exports=function(e){return f.hash(e,h,32,!0)}}).call(this,e("lYpoI2"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],10:[function(e,t,n){(function(e,t,r,s,i,a,o,l,c){n.read=function(e,t,n,r,s){var i,a,o=8*s-r-1,l=(1<<o)-1,c=l>>1,d=-7,u=n?s-1:0,h=n?-1:1;for(s=e[t+u],u+=h,i=s&(1<<-d)-1,s>>=-d,d+=o;0<d;i=256*i+e[t+u],u+=h,d-=8);for(a=i&(1<<-d)-1,i>>=-d,d+=r;0<d;a=256*a+e[t+u],u+=h,d-=8);if(0===i)i=1-c;else{if(i===l)return a?NaN:1/0*(s?-1:1);a+=Math.pow(2,r),i-=c}return(s?-1:1)*a*Math.pow(2,i-r)},n.write=function(e,t,n,r,s,i){var a,o,l=8*i-s-1,c=(1<<l)-1,d=c>>1,u=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,h=r?0:i-1,f=r?1:-1;for(i=t<0||0===t&&1/t<0?1:0,t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,a=c):(a=Math.floor(Math.log(t)/Math.LN2),t*(r=Math.pow(2,-a))<1&&(a--,r*=2),2<=(t+=1<=a+d?u/r:u*Math.pow(2,1-d))*r&&(a++,r/=2),c<=a+d?(o=0,a=c):1<=a+d?(o=(t*r-1)*Math.pow(2,s),a+=d):(o=t*Math.pow(2,d-1)*Math.pow(2,s),a=0));8<=s;e[n+h]=255&o,h+=f,o/=256,s-=8);for(a=a<<s|o,l+=s;0<l;e[n+h]=255&a,h+=f,a/=256,l-=8);e[n+h-f]|=128*i}}).call(this,e("lYpoI2"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/ieee754/index.js","/node_modules/gulp-browserify/node_modules/ieee754")},{buffer:3,lYpoI2:11}],11:[function(e,t,n){(function(e,n,r,s,i,a,o,l,c){var d,u,h;function f(){}(e=t.exports={}).nextTick=(u="undefined"!=typeof window&&window.setImmediate,h="undefined"!=typeof window&&window.postMessage&&window.addEventListener,u?function(e){return window.setImmediate(e)}:h?(d=[],window.addEventListener("message",(function(e){var t=e.source;t!==window&&null!==t||"process-tick"!==e.data||(e.stopPropagation(),0<d.length&&d.shift()())}),!0),function(e){d.push(e),window.postMessage("process-tick","*")}):function(e){setTimeout(e,0)}),e.title="browser",e.browser=!0,e.env={},e.argv=[],e.on=f,e.addListener=f,e.once=f,e.off=f,e.removeListener=f,e.removeAllListeners=f,e.emit=f,e.binding=function(e){throw new Error("process.binding is not supported")},e.cwd=function(){return"/"},e.chdir=function(e){throw new Error("process.chdir is not supported")}}).call(this,e("lYpoI2"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:11}]},{},[1])(1)}(Du);var xu,Pu=Du.exports;class Mu{constructor(e){const{http:t}=ve();this.queryParams=e,this.http=t}loadFirstPage(){return this.onFetch("first")}loadNextPage(){return this.onFetch("next")}loadPreviousPage(){return this.onFetch("prev")}async onFetch(e="first"){var t,n,r,s;if("prev"===e&&!this.previousToken)return;if("next"===e&&!this.nextToken)return;let i;"prev"===e&&(i=this.previousToken),"next"===e&&(i=this.nextToken);const a=await this.getRequest(this.queryParams,i);return"first"===e&&(this.nextToken=null===(t=a.paging)||void 0===t?void 0:t.next,this.previousToken=null===(n=a.paging)||void 0===n?void 0:n.previous),"prev"===e&&(this.previousToken=null===(r=a.paging)||void 0===r?void 0:r.previous),"next"===e&&(this.nextToken=null===(s=a.paging)||void 0===s?void 0:s.next),a}getNextToken(){return this.nextToken}getPrevToken(){return this.previousToken}}class Fu extends Mu{async getRequest(e,t){const{limit:n=f,userId:r}=e,s=Bo(e,["limit","userId"]),i=t?{token:t}:{limit:n},a=ve().userId===r?"/api/v4/me/followers":`/api/v4/users/${r}/followers`,{data:o}=await this.http.get(a,{params:Object.assign(Object.assign({},s),{options:i,isDeleted:!1})});return o}}class Uu{constructor(e,t){this.query=e,this.cacheKey=t}}!function(e){e.OnRequested="onRequested",e.OnAccepted="onAccepted",e.OnDeclined="onDeclined",e.OnCanceled="onCanceled",e.OnFollowed="onFollowed",e.OnUnfollowed="onUnfollowed",e.OnDeleted="onDeleted",e.OnUserDeleted="onUserDeleted"}(xu||(xu={}));class Nu extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.follows.map(de("follow"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.follows.map(de("follow"))])]}))}}reactor(e){return t=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;if(this.query.userId===t.to&&r){switch(e){case xu.OnDeclined:case xu.OnCanceled:case xu.OnUnfollowed:case xu.OnDeleted:r.data=r.data.filter((e=>e!==de("follow")(t)));break;case xu.OnRequested:case xu.OnAccepted:case xu.OnFollowed:r.data=[...new Set([de("follow")(t),...r.data])]}Ce(this.cacheKey,r),this.notifyChange({origin:"event",loading:!1})}}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}class Bu{constructor(e){const{http:t}=ve();this.queryParams=e,this.http=t}async onFetch(){return await this.getRequest(this.queryParams)}}class ju{constructor(e,t,n,r){this.paginationController=e,this.queryStreamId=t,this.cacheKey=n,this.callback=r}async refresh(){try{let e;if(e=this.paginationController instanceof Bu?await this.paginationController.onFetch():await this.paginationController.loadFirstPage(),!e)return;await this.persistModel(e),this.persistQueryStream({response:e,direction:"next",refresh:!0}),this.notifyChange({origin:"server",loading:!1})}catch(e){this.notifyChange({origin:"server",loading:!1,error:e})}}loadPage({initial:e=!1,direction:t="next"}){this.setup(),this.notifyChange({origin:"local",loading:!0}),e?this.refresh():"prev"===t?this.loadPrevPage():"next"===t&&this.loadNextPage()}async loadNextPage(){try{if(this.paginationController instanceof Bu)return;const e=await this.paginationController.loadNextPage();if(!e)return;await this.persistModel(e),this.persistQueryStream({response:e,direction:"next"}),this.notifyChange({origin:"server",loading:!1})}catch(e){this.notifyChange({origin:"server",loading:!1,error:e})}}async loadPrevPage(){try{if(this.paginationController instanceof Bu)return;const e=await this.paginationController.loadPreviousPage();if(!e)return;await this.persistModel(e),this.persistQueryStream({response:e,direction:"prev"}),this.notifyChange({origin:"server",loading:!1})}catch(e){this.notifyChange({origin:"server",loading:!1,error:e})}}shouldNotify(e){const t=e.map(du).map(uu);return!rl(this.snapshot,t)&&(this.snapshot=t,!0)}getCacheKey(){return this.cacheKey}}const $u=({userId:e})=>t=>{const n=ve();return Xe(n,"user.deleted","user.deleted",(n=>{const r=Fc(n);Uo(r);const s=Se(["follow","get",de("follow")({from:r.users[0].userId,to:e})]);s&&t(null==s?void 0:s.data)}))};class qu extends ju{constructor(e,t){const n=Pu(Object.assign(Object.assign({},e),{type:"follower"})),r=["follow","collection",n];super(new Fu(e),n,r,t),this.query=e,this.queryStreamController=new Nu(this.query,this.cacheKey,this.notifyChange.bind(this),fu),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:vu,action:xu.OnFollowed},{fn:bu,action:xu.OnUnfollowed},{fn:Tu,action:xu.OnAccepted},{fn:Eu,action:xu.OnDeclined},{fn:Cu,action:xu.OnCanceled},{fn:wu,action:xu.OnDeleted},{fn:Ou,action:xu.OnAccepted},{fn:Lu,action:xu.OnDeclined},{fn:Au,action:xu.OnFollowed},{fn:_u,action:xu.OnUnfollowed},{fn:$u({userId:this.query.userId}),action:xu.OnUserDeleted}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["follow","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){let t=e;return this.query.status&&"all"!==this.query.status&&(t=t.filter((e=>e.status===this.query.status))),t=t.filter((e=>{var t;const n=null===(t=Se(["user","get",e.from]))||void 0===t?void 0:t.data;return null==(null==n?void 0:n.isDeleted)||!1===(null==n?void 0:n.isDeleted)})),t}}class Ku extends Mu{async getRequest(e,t){const{limit:n=f,userId:r}=e,s=Bo(e,["limit","userId"]),i=t?{token:t}:{limit:n},a=ve().userId===r?"/api/v4/me/following":`/api/v4/users/${r}/following`,{data:o}=await this.http.get(a,{params:Object.assign(Object.assign({},s),{options:i,isDeleted:!1})});return o}}class Gu extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.follows.map(de("follow"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.follows.map(de("follow"))])]}))}}reactor(e){return t=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;if(this.query.userId===t.from&&r){switch(e){case xu.OnDeclined:case xu.OnCanceled:case xu.OnUnfollowed:case xu.OnDeleted:r.data=r.data.filter((e=>e!==de("follow")(t)));break;case xu.OnRequested:case xu.OnAccepted:case xu.OnFollowed:r.data=[...new Set([de("follow")(t),...r.data])]}Ce(this.cacheKey,r),this.notifyChange({origin:"event",loading:!1})}}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}const Hu=({userId:e})=>t=>{const n=ve();return Xe(n,"user.deleted","user.deleted",(n=>{const r=Fc(n);Uo(r);const s=Se(["follow","get",de("follow")({from:e,to:r.users[0].userId})]);s&&t(null==s?void 0:s.data)}))};class Vu extends ju{constructor(e,t){const n=Pu(Object.assign(Object.assign({},e),{type:"following"})),r=["follow","collection",n];super(new Ku(e),n,r,t),this.query=e,this.queryStreamController=new Gu(this.query,this.cacheKey,this.notifyChange.bind(this),pu),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:Su,action:xu.OnRequested},{fn:Tu,action:xu.OnAccepted},{fn:Eu,action:xu.OnDeclined},{fn:Cu,action:xu.OnCanceled},{fn:vu,action:xu.OnFollowed},{fn:bu,action:xu.OnUnfollowed},{fn:wu,action:xu.OnDeleted},{fn:Ru,action:xu.OnRequested},{fn:Ou,action:xu.OnAccepted},{fn:Lu,action:xu.OnDeclined},{fn:Au,action:xu.OnFollowed},{fn:_u,action:xu.OnUnfollowed},{fn:Hu({userId:this.query.userId}),action:xu.OnUserDeleted}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["follow","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){let t=e;return this.query.status&&"all"!==this.query.status&&(t=t.filter((e=>e.status===this.query.status))),t=t.filter((e=>{var t;const n=null===(t=Se(["user","get",e.to]))||void 0===t?void 0:t.data;return null==(null==n?void 0:n.isDeleted)||!1===(null==n?void 0:n.isDeleted)})),t}}const zu=(e,t,n,r,s,i)=>{const{forceDispatch:a,callbackDataSelector:o,callbackFilter:l}=Object.assign({forceDispatch:!1,callbackDataSelector:e=>e},i),{cache:c}=ve();let d;c||console.log("For using Live Object feature you need to enable Cache!");let u=!1;const h=[],f=e=>{const{data:n}=e,r=Bo(e,["data"]);l&&!l(n,d)||t(Object.assign({data:o(n)},r)),d=du(n)};return h.push(...s.map((t=>t((t=>((t,r=!1)=>{e===t[n]&&(d&&!r&&rl(d,t)||f({loading:!1,data:t,origin:"event"}))})(t,a)))))),(()=>{const t=ie(r,e,!0);oe(t,(({error:e,data:t,loading:n,origin:r,cachedAt:s})=>{s===y?(f({data:t,origin:r,loading:!1,error:new pe(m,800800,"error")}),u=!0,h.forEach((e=>e()))):u||f({loading:n,data:t,origin:r,error:e}),e&&h.forEach((e=>e()))}))})(),()=>{h.forEach((e=>e()))}};var Wu=Object.freeze({__proto__:null,blockUser:async e=>{const t=ve();t.log("user/blockUser",e);const{data:n}=await t.http.post(`/api/v4/me/user-blocks/${e}`),r=t.cache&&Date.now(),{follows:s,followCounts:i}=n,a={follows:s};t.cache&&(Uo(a,{cachedAt:r}),Ee(["followInfo","get",e],i[0],{cachedAt:r}));const o=gu(a);return Je("local.follow.unfollowed",o),n},unBlockUser:async e=>{const t=ve();t.log("user/unBlockUser",e);const{data:n}=await t.http.delete(`/api/v4/me/user-blocks/${e}`),r=t.cache&&Date.now(),{follows:s,followCounts:i}=n,a={follows:s};t.cache&&(Uo(a,{cachedAt:r}),Ee(["followInfo","get",e],i[0],{cachedAt:r}));const o=gu(a);return Je("local.follow.created",o),n},follow:async e=>{const t=ve();t.log("follow/follow",e);const{data:n}=await t.http.post(`/api/v4/me/following/${e}`),r=t.cache&&Date.now();t.cache&&Uo(n,{cachedAt:r});const s=gu(n);return"accepted"===n.follows[0].status?Je("local.follow.created",s):Je("local.follow.requested",s),{data:n.follows[0],cachedAt:r}},unfollow:async e=>{const t=ve();t.log("follow/unfollow",e);const{data:n}=await t.http.delete(`/api/v4/me/following/${e}`);t.cache&&Uo(n);const r=gu(n);return Je("local.follow.unfollowed",r),!0},acceptMyFollower:async e=>{const t=ve();t.log("follow/acceptMyFollower",e);const{data:n}=await t.http.post(`/api/v4/me/followers/${e}`);t.cache&&Uo(n);const r=gu(n);return Je("local.follow.accepted",r),!0},declineMyFollower:async e=>{const t=ve();t.log("follow/declineMyFollower",e);const{data:n}=await t.http.delete(`/api/v4/me/followers/${e}`);t.cache&&Uo(n);const r=gu(n);return Je("local.follow.requestDeclined",r),!0},onUserFollowed:vu,onUserUnfollowed:bu,onFollowerDeleted:wu,onFollowerRequested:Su,onFollowRequestCanceled:Cu,onFollowRequestAccepted:Tu,onFollowRequestDeclined:Eu,onFollowInfoUpdated:ku,onLocalUserFollowed:Au,onLocalUserUnfollowed:_u,onLocalFollowerRequested:Ru,onLocalFollowRequestAccepted:Ou,onLocalFollowRequestDeclined:Lu,getFollowers:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getFollowers(tmpid: ${i}) > listen`);const a=new qu(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`getFollowers(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},getFollowings:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log("For using Live Collection feature you need to enable Cache!");const i=Date.now();r(`getFollowings(tmpid: ${i}) > listen`);const a=new Vu(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`getFollowings(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},getFollowInfo:(e,t)=>zu(e,t,"userId",Iu,[ku],{forceDispatch:!0}),getMyFollowInfo:e=>{const{userId:t}=Ke();return zu(t,e,"userId",Iu,[ku],{forceDispatch:!0})}});const Yu=async e=>{const t=ve();t.log("user/getUsers",e);const n=e.map((e=>encodeURIComponent(e))),{data:r}=await t.http.get("/api/v3/users/list",{params:{userIds:n}}),s=Fc(r),i=t.cache&&Date.now();return t.cache&&Uo(s,{cachedAt:i}),Je("user.fetched",r),{data:s.users.map((e=>yl.user(e))),cachedAt:i}};Yu.locally=e=>{var t;const n=ve();if(n.log("user/getUsers.locally",e),!n.cache)return;const r=e.map((e=>Se(["user","get",e]))).filter(Boolean),s=r.map((({data:e})=>yl.user(e))),i=null===(t=r.sort(((e,t)=>e.cachedAt<t.cachedAt?-1:1)))||void 0===t?void 0:t[0];return(null==r?void 0:r.length)<e.length?void 0:{data:s,cachedAt:i.cachedAt}};const Qu=e=>Uc("user.updated",e),Xu=e=>Uc("user.flagged",e),Ju=e=>Uc("user.unflagged",e),Zu=e=>Uc("user.flagCleared",e),eh=e=>Uc("user.fetched",e),th=async e=>{const t=ve();t.log("user/getUser",e),Tl("user",e);try{const{data:n}=await t.http.get(`/api/v3/users/${encodeURIComponent(e)}`),r=t.cache&&Date.now(),s=Fc(n);return t.cache&&Uo(s,{cachedAt:r}),Je("user.fetched",n),{data:s.users.find((t=>t.userId===e)),cachedAt:r}}catch(t){throw I(null==t?void 0:t.code)&&No("user",e),t}};th.locally=e=>{const t=ve();if(t.log("user/getUser.locally",e),!t.cache)return;const n=Se(["user","get",e]);return n?{data:n.data,cachedAt:n.cachedAt}:void 0};class nh extends Mu{async getRequest(e,t){const{limit:n=f}=e,r=Bo(e,["limit"]),s=t?{token:t}:{limit:n},{data:i}=await this.http.get("/api/v3/users",{params:Object.assign(Object.assign({},r),{options:s,isDeleted:!1})});return i}}class rh extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.users.map(de("user"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.users.map(de("user"))])]}))}}reactor(e){return e=>{var t;const n=null===(t=Se(this.cacheKey))||void 0===t?void 0:t.data;n&&(n.data=[...new Set([e.userId,...n.data])],Ce(this.cacheKey,n),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}var sh;!function(e){e.OnUserDeleted="onUserDeleted",e.OnUserUpdated="onUserUpdated",e.OnUserFlagged="onUserFlagged",e.OnUserUnflagged="onUserUnflagged",e.OnUserFlagCleared="onUserFlagCleared"}(sh||(sh={}));class ih extends ju{constructor(e,t){const n=Pu(e),r=["user","collection",n];super(new nh(e),n,r,t),this.query=e,this.queryStreamController=new rh(this.query,this.cacheKey,this.notifyChange.bind(this),Fc),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:Nc,action:sh.OnUserDeleted},{fn:Qu,action:sh.OnUserUpdated},{fn:Xu,action:sh.OnUserFlagged},{fn:Ju,action:sh.OnUserUnflagged},{fn:Zu,action:sh.OnUserFlagCleared}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["user","get",e]))).filter(sl).map((({data:e})=>e)).map(yl.user))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){let t=e;const n=(()=>"firstCreated"===this.query.sortBy?Fe:Ne)();return t=t.sort(n),"flagged"===this.query.filter&&(t=t.filter((e=>!!e.hashFlag))),t=t.filter((e=>null==e.isDeleted||!1===e.isDeleted)),t}}class ah extends Mu{async getRequest(e,t){const{limit:n=f}=e,r=Bo(e,["limit"]),s=t?{token:t}:{limit:n},{data:i}=await this.http.get("/api/v4/me/user-blocks",{params:Object.assign(Object.assign({},r),{options:s,isDeleted:!1})});return i}}class oh extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.users.map(de("user"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.users.map(de("user"))])]}))}}reactor(e){return t=>{var n;if(e===xu.OnFollowed){const e=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data,r=null==e?void 0:e.data.filter((e=>e!==t.userId));Ce(this.cacheKey,Object.assign(Object.assign({},e),{data:r}))}this.notifyChange({origin:"event",loading:!1})}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}function lh(e){const{users:t,follows:n}=e,r=Bo(e,["users","follows"]);return Object.assign(Object.assign({},r),{follows:n.map((e=>{const n=t.find((t=>t.userId===e.from));return Object.assign(Object.assign({},e),{user:zl(n)})})),users:t.map(zl)})}const ch=(e,t,n)=>r=>e((e=>{var s;if(!e)return e;const i=[n,"get",`${e[t]}`],a=null===(s=Se(i))||void 0===s?void 0:s.data;return a?r(a):void 0}));class dh extends ju{constructor(e,t){const n=Pu(e),r=["blockedUsers","collection",n];super(new ah(e),n,r,t),this.query=e,this.queryStreamController=new oh(this.query,this.cacheKey,this.notifyChange.bind(this),lh),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:Nc,action:sh.OnUserDeleted},{fn:ch(Au,"to","user"),action:xu.OnFollowed},{fn:ch(vu,"to","user"),action:xu.OnFollowed}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["user","get",e]))).filter(sl).map((({data:e})=>e)).map(yl.user))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){let t=e;return t=t.filter((e=>null==e.isDeleted||!1===e.isDeleted)),t}}class uh extends Mu{async getRequest(e,t){const{limit:n=f,displayName:r}=e,s=Bo(e,["limit","displayName"]),i=t?{token:t}:{limit:n},{data:a}=await this.http.get("/api/v3/users",{params:Object.assign(Object.assign({},s),{keyword:r,options:i,isDeleted:!1})});return a}}class hh extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.users.map(de("user"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.users.map(de("user"))])]}))}}reactor(e){return e=>{var t;const n=null===(t=Se(this.cacheKey))||void 0===t?void 0:t.data;n&&(n.data=[...new Set([e.userId,...n.data])],Ce(this.cacheKey,n),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}class fh extends ju{constructor(e,t){var n;const r=Pu(e),s=["user","collection",r];super(new uh(e),r,s,t),this.query=Object.assign(Object.assign({},e),{filter:null!==(n=e.filter)&&void 0!==n?n:"all"}),this.queryStreamController=new hh(this.query,this.cacheKey,this.notifyChange.bind(this),Fc),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:Nc,action:sh.OnUserDeleted},{fn:Qu,action:sh.OnUserUpdated},{fn:Xu,action:sh.OnUserFlagged},{fn:Ju,action:sh.OnUserUnflagged},{fn:Zu,action:sh.OnUserFlagCleared}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["user","get",e]))).filter(sl).map((({data:e})=>e)).map(yl.user))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){let t=e;return"flagged"===this.query.filter&&(t=t.filter((e=>!!e.hashFlag))),t=t.filter((e=>null==e.isDeleted||!1===e.isDeleted)),t}}const ph=async({viewId:e,viewedType:t,limit:n,token:r})=>{const s=ve(),i={};r?i.token=r:i.limit=n;const a=`/api/v1/analytics/views/${"post"===t?"posts":"stories"}/${e}/users`,o=await s.http.get(a,{params:i});return Uo(o.data),o.data};var gh;!function(e){e.DEFAULT="default",e.PARTIAL="partial"}(gh||(gh={}));var mh=Object.freeze({__proto__:null,Relationship:Wu,getUserByIds:Yu,updateUser:async(e,t)=>{const n=ve();n.log("user/updateUser",e,t);const{data:r}=await n.http.put("/api/v3/users/",Object.assign(Object.assign({userId:e},t),{createNewUserWhenNotFound:!1})),s=Fc(r),i=n.cache&&Date.now();return n.cache&&Uo(s,{cachedAt:i}),Je("user.updated",r),{data:s.users.find((t=>t.userId===e)),cachedAt:i}},flagUser:async e=>{const t=ve();t.log("user/flagUser",e);const{data:n}=await t.http.post(`api/v4/me/flags/${encodeURIComponent(e)}`),r=Fc(n);return t.cache&&Uo(r),Je("user.flagged",n),!!r},unflagUser:async e=>{const t=ve();t.log("user/unflag",e);const{data:n}=await t.http.delete(`/api/v4/me/flags/${encodeURIComponent(e)}`),r=Fc(n);return t.cache&&Uo(r),Je("user.unflagged",n),!!r},isUserFlaggedByMe:async e=>{const t=ve();t.log("user/isUserFlaggedByMe",e);const{data:{isFlagByMe:n}}=await t.http.get(`/api/v3/users/${e}/isFlagByMe`);return n},onUserUpdated:Qu,onUserDeleted:Nc,onUserFlagged:Xu,onUserUnflagged:Ju,onUserFlagCleared:Zu,getUser:(e,t)=>zu(e,(e=>t(Object.assign(Object.assign({},e),{data:e.data?yl.user(e.data):e.data}))),"userId",th,[eh,Qu,Nc,Xu,Ju,Zu]),getUsers:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`liveUsers(tmpid: ${i}) > listen`);const a=new ih(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`liveUsers(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},getBlockedUsers:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getBlockedUsers(tmpid: ${i}) > listen`);const a=new dh(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`getBlockedUsers(tmpid: ${i}) > dispose`),o.forEach((e=>e())),Ie(l)}},searchUserByDisplayName:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`liveSearchUsers(tmpid: ${i}) > listen`);const a=new fh(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`liveSearchUsers(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},getReachedUsers:(e,t)=>{let n=(e=!1)=>{};const{log:r,cache:s}=ve(),i=["viewedUsers","collection",{viewId:e.viewId,viewedType:e.viewedType}];s||console.log(g);const a=Date.now();r(`getReachUsers(tmpid: ${a}) > listen`);const{limit:o,viewId:l,viewedType:c}=e;return n=(e=!1)=>{var r,s,a;const d=null===(r=Se(i))||void 0===r?void 0:r.data,u=null!==(s=null==d?void 0:d.data)&&void 0!==s?s:[];if(!e&&u.length>0&&!(null==d?void 0:d.params.page))return;const h=ie(ph,{viewId:l,viewedType:c,limit:o||10,token:e||null===(a=null==d?void 0:d.params.page)||void 0===a?void 0:a.next});oe(h,(e=>{var r,s,a,o,l;let c=null!==(a=null===(s=null===(r=Se(i))||void 0===r?void 0:r.data)||void 0===s?void 0:s.data)&&void 0!==a?a:[];(null===(o=e.data)||void 0===o?void 0:o.users)&&(c=[...new Set([...c,...e.data.users.map((({userId:e})=>e))])]);const d={loading:e.loading,params:{page:null===(l=e.data)||void 0===l?void 0:l.paging},data:c||[]};Ce(i,d),(e=>{var r,s;let i=[];(null==e?void 0:e.data)&&(i=e.data.map((e=>Se(["user","get",e]))).filter(Boolean).map((e=>null==e?void 0:e.data))||[]),t({onNextPage:n,data:i,hasNextPage:!!(null===(s=null===(r=e.params)||void 0===r?void 0:r.page)||void 0===s?void 0:s.next),loading:e.loading||!1})})(d)}),ae(p,2e3))},n(!0),()=>{r(`getReachUsers(tmpid: ${a}) > dispose`),Ie(i)}},get AmityUserSearchMatchType(){return gh}});const yh=async e=>{const t=ve();t.log("file/getFile",e);const{data:n}=await t.http.get(`/api/v3/files/${e}`),r=t.cache&&Date.now();return t.cache&&Uo({files:[n]},{cachedAt:r}),{data:n,cachedAt:r}};yh.locally=e=>{const t=ve();if(t.log("file/getFile.locally",e),!t.cache)return;const n=Se(["file","get",e]);return n?{data:n.data,cachedAt:n.cachedAt}:void 0};const vh=async(e,t,n)=>{const r=ve();r.log("file/uploadVideo",e);const s=e.getAll("files");if(!s.length)throw new Error("The formData object must have a `files` key.");const i=nu().getFileAccessType();e.append("accessType",i),e.append("preferredFilename",s[0].name),t&&e.append("feedType",t);const a="getHeaders"in e?e.getHeaders():{"content-type":"multipart/form-data"},{data:o}=await r.upload.post("/api/v4/videos",e,{headers:a,onUploadProgress({loaded:e,total:t=100}){n&&n(Math.round(100*e/t))}}),l=r.cache&&Date.now();return r.cache&&Uo({files:o},{cachedAt:l}),{data:o,cachedAt:l}},bh=async(e,t)=>{const n=ve();n.log("file/uploadImage",e);const r=e.getAll("files");if(!r.length)throw new Error("The formData object must have a `files` key.");const s=nu().getFileAccessType();e.append("accessType",s),e.append("preferredFilename",r[0].name);const i="getHeaders"in e?e.getHeaders():{"content-type":"multipart/form-data"},{data:a}=await n.upload.post("/api/v4/images",e,{headers:i,onUploadProgress({loaded:e,total:n=100}){t&&t(Math.round(100*e/n))}}),o=n.cache&&Date.now();return n.cache&&Uo({files:a},{cachedAt:o}),{data:a,cachedAt:o}};var wh=Object.freeze({__proto__:null,getFile:yh,uploadFile:async(e,t)=>{const n=ve();n.log("file/uploadFile",e);const r=e.getAll("files");if(!r.length)throw new Error("The formData object must have a `files` key.");const s=nu().getFileAccessType();e.append("accessType",s),e.append("preferredFilename",r[0].name);const i="getHeaders"in e?e.getHeaders():{"content-type":"multipart/form-data"},{data:a}=await n.upload.post("/api/v4/files",e,{headers:i,onUploadProgress({loaded:e,total:n=100}){t&&t(Math.round(100*e/n))}}),o=n.cache&&Date.now();return n.cache&&Uo({files:a},{cachedAt:o}),{data:a,cachedAt:o}},deleteFile:async e=>{const t=ve();return t.log("file/deleteFile",e),await t.http.delete(`/api/v3/files/${e}`),Ie(["file","get",e],!0),{success:!0}},fileUrlWithSize:(e,t)=>`${e}?size=${t}`,uploadVideo:vh,uploadImage:bh});const Sh=async e=>{const t=ve();t.log("role/queryRoles",e);const n=null!=e?e:{},{limit:r=10,queryToken:s,displayName:i,sortBy:a}=n,o=Bo(n,["limit","queryToken","displayName","sortBy"]),l=s?{token:s}:r?{limit:r}:void 0,{data:c}=await t.http.get("/api/v3/roles",{params:Object.assign(Object.assign({},o),{keyword:i,sortBy:a,options:l})}),{paging:d}=c,u=Bo(c,["paging"]),{roles:h}=u,f=t.cache&&Date.now();t.cache&&Uo(u,{cachedAt:f});const p=Z(d.next);return{data:h,cachedAt:f,prevPage:Z(d.previous),nextPage:p,paging:d}};Sh.locally=e=>{ve().log("role/queryRoles.locally",e)};const Ch=async e=>{const t=ve();t.log("role/getRole",e);const{data:n}=await t.http.get(`/api/v3/roles/${e}`),r=t.cache&&Date.now();return t.cache&&Uo({roles:n},{cachedAt:r}),{data:n.find((t=>t.roleId===e)),cachedAt:r}};Ch.locally=e=>{const t=ve();if(t.log("role/getRole.locally",e),!t.cache)return;const n=Se(["role","get",e]);return n?{data:n.data,cachedAt:n.cachedAt}:void 0};const Th=(e,t)=>{"message"===e?Je("local.message.updated",{messages:[t]}):"post"===e?Je("post.updated",{posts:[t]}):"comment"===e?Je("comment.updated",{comments:[t]}):"story"===e&&Je("story.updated",{categories:[],comments:[],communities:[],communityUsers:[],files:[],users:[],stories:[t]})},Eh=async(e,t=!1)=>{const n=ve();let r;n.log("message/getMessage",e),Tl("message",e);try{const{data:t}=await n.http.get(`/api/v5/messages/${encodeURIComponent(e)}`);r=await xl(t)}catch(t){throw I(null==t?void 0:t.code)&&No("message",e),t}const s=n.cache&&Date.now();n.cache&&Uo(r,{cachedAt:s});const{messages:i}=r;return Je("local.message.fetched",{messages:i}),{data:i.find((t=>t.messageId===e)),cachedAt:s}};Eh.locally=e=>{const t=ve();if(t.log("message/getMessage.locally",e),!t.cache)return;const n=Se(["message","get",e]);return n?{data:n.data,cachedAt:n.cachedAt}:void 0};const Ih=async e=>{const t=ve();let n;t.log("post/getPost",e),Tl("post",e);try{n=(await t.http.get(`/api/v3/posts/${encodeURIComponent(e)}`)).data}catch(t){throw I(null==t?void 0:t.code)&&No("post",e),t}const r=$o(n,"communityUsers"),s=t.cache&&Date.now();t.cache&&Uo(r,{cachedAt:s});const{posts:i}=r,a=i.find((t=>t.postId===e));return{data:yl.post(a),cachedAt:s}};Ih.locally=e=>{const t=ve();if(t.log("post/getPost.locally",e),!t.cache)return;const n=Se(["post","get",e]);return n?{data:yl.post(n.data),cachedAt:n.cachedAt}:void 0};const kh=async e=>{const t=ve();let n;t.log("comment/getComment",e),Tl("comment",e);try{n=(await t.http.get(`/api/v3/comments/${encodeURIComponent(e)}`)).data}catch(t){throw I(null==t?void 0:t.code)&&No("comment",e),t}const r=t.cache&&Date.now();t.cache&&Uo(n,{cachedAt:r});const{comments:s}=n;return{data:yl.comment(s.find((t=>t.commentId===e))),cachedAt:r}};function Ah(e,t){return e.map((e=>{const n=Se(["community","get",e.communityId]);if((null==n?void 0:n.data)&&(null==n?void 0:n.data.hasOwnProperty("isJoined")))return Object.assign(Object.assign({},n.data),e);const r=t.some((t=>function(e,t){const{userId:n}=Ke();return e.communityId===t.communityId&&t.userId===n}(e,t)&&"none"!==t.communityMembership));return Object.assign(Object.assign({},e),{isJoined:r})}))}kh.locally=e=>{const t=ve();if(t.log("comment/getComment.locally",e),!t.cache)return;const n=Se(["comment","get",e]);return n?{data:yl.comment(n.data),cachedAt:n.cachedAt}:void 0};const _h=(e,t)=>{var n,r;let s,i;if("post"===t)i="post",s=e.posts[0].postId;else if("comment"===t)i="comment",s=e.comments[0].commentId;else{if("story"!==t)throw new Error("Unknown event type");i="story",s=e.stories[0].referenceId}return(null===(r=null===(n=Se([i,"get",s]))||void 0===n?void 0:n.data)||void 0===r?void 0:r.myReactions)||[]},Rh=(e,t,n)=>{const[r]=e[t];return Object.assign(Object.assign({},e),{[t]:[Object.assign(Object.assign({},r),{myReactions:n})]})},Oh=(e,t,n,r=[])=>{const s=e.split(".")[1];let i=r;if(ve().userId===t)if(["addReaction","reactionAdded"].includes(s))i.includes(n)||i.push(n);else{if(!["removeReaction","reactionRemoved"].includes(s))throw new Error(`Unknown event type: ${s}`);i=i.filter((e=>e!==n))}return i},Lh=(e,t)=>{const n=e.split(".")[0],r=_h(t,n),s=Oh(e,t.reactor.userId,t.reactor.reactionName,r);return Rh(t,`${n}s`,s)},Dh=(e,t)=>{var n,r;const s=e.split(".")[0];let i=_h(t,s);(null==t?void 0:t.reactions)&&t.reactions.length>0&&(i=Oh(e,null===(n=t.reactions[0])||void 0===n?void 0:n.userId,null===(r=t.reactions[0])||void 0===r?void 0:r.reactionName,i));const a=Rh(t,"stories",i);if(!(null==t?void 0:t.communities)||!(null==t?void 0:t.communityUsers))return a;const o=Ah(t.communities,t.communityUsers);return Object.assign(Object.assign({},a),{communities:o})},xh=async(e,t,n)=>{var r,s;const i=ve();if(i.log("reaction/createReaction",{referenceId:t,referenceType:e,reactionName:n}),!["post","comment","story","message"].includes(e))throw new pe("The reference type is not valid. It should be one of post, comment, story, or message",4e5,"error");const{data:a}=await i.http.post("/api/v2/reactions",{referenceId:t,referenceType:e,reactionName:n,referenceVersion:"message"===e?5:void 0});if(i.cache){const o=Se([e,"get",t]);if(!o)return!0;const l=Object.assign(Object.assign({},o.data),{reactionsCount:o.data.reactionsCount+1,myReactions:[...null!==(r=o.data.myReactions)&&void 0!==r?r:[],n],reactions:Object.assign(Object.assign({},o.data.reactions),{[n]:(null!==(s=o.data.reactions[n])&&void 0!==s?s:0)+1})});if("comment"===e)return Je("local.comment.addReaction",{comment:l,reactor:{userId:i.userId,reactionName:n,reactionId:a.addedId}}),!0;if("post"===e)return Je("local.post.addReaction",{post:l,reactor:{userId:i.userId,reactionName:n,reactionId:a.addedId}}),!0;if("story"===e)return Je("local.story.reactionAdded",{story:l,reactor:{userId:i.userId,reactionName:n,reactionId:a.addedId}}),!0}return!0};xh.optimistically=(e,t,n)=>{var r,s,i,a,o;const l=ve();if(l.log("reaction/createReaction.optimistically",{referenceId:t,referenceType:e,reactionName:n}),!l.cache)return;const c=Se([e,"get",t]);if(!(null==c?void 0:c.data)||(null===(r=c.data.myReactions)||void 0===r?void 0:r.includes(n)))return;const d=Object.assign(Object.assign({},c.data),{reactionsCount:c.data.reactionsCount+1,myReactions:[...null!==(s=c.data.myReactions)&&void 0!==s?s:[],n],reactions:Object.assign(Object.assign({},c.data.reactions),{[n]:(null!==(i=c.data.reactions[n])&&void 0!==i?i:0)+1})});return Ee([e,"get",t],d,{cachedAt:y}),Th(e,d),null!==(o=null===(a=null==d?void 0:d.myReactions)||void 0===a?void 0:a.includes(n))&&void 0!==o&&o};const Ph=async(e,t,n)=>{var r,s;const i=ve();if(i.log("reaction/removeReaction",{referenceId:t,referenceType:e,reactionName:n}),!["post","comment","story","message"].includes(e))throw new pe("The reference type is not valid. It should be one of post, comment, story, or message",4e5,"error");const{data:a}=await i.http.delete("/api/v2/reactions",{data:{referenceId:t,referenceType:e,reactionName:n,referenceVersion:"message"===e?5:void 0}});if(i.cache){const o=Se([e,"get",t]);if(!o)return!0;const l=Object.assign(Object.assign({},o.data),{reactionsCount:Math.max(0,o.data.reactionsCount-1),myReactions:(null!==(r=o.data.myReactions)&&void 0!==r?r:[]).filter((e=>e!==n)),reactions:Object.assign(Object.assign({},o.data.reactions),{[n]:Math.max(0,(null!==(s=o.data.reactions[n])&&void 0!==s?s:0)-1)})});if("comment"===e)return Je("local.comment.removeReaction",{comment:l,reactor:{reactionId:a.removedId,reactionName:n,userId:i.userId}}),!0;if("post"===e)return Je("local.post.removeReaction",{post:l,reactor:{reactionId:a.removedId,reactionName:n,userId:i.userId}}),!0;if("story"===e)return Je("local.story.reactionAdded",{story:l,reactor:{userId:i.userId,reactionName:n,reactionId:a.removedId}}),!0}return!0};Ph.optimistically=(e,t,n)=>{var r,s,i,a;const o=ve();if(o.log("reaction/removeReaction.optimistically",{referenceId:t,referenceType:e,reactionName:n}),!o.cache)return;const l=Se([e,"get",t]);if(!(null==l?void 0:l.data)||!(null===(r=l.data.myReactions)||void 0===r?void 0:r.includes(n)))return;const c=Object.assign(Object.assign({},l.data),{reactionsCount:Math.max(0,l.data.reactionsCount-1),myReactions:(null!==(s=l.data.myReactions)&&void 0!==s?s:[]).filter((e=>e!==n)),reactions:Object.assign(Object.assign({},l.data.reactions),{[n]:Math.max(0,(null!==(i=l.data.reactions[n])&&void 0!==i?i:0)-1)})});return Ee([e,"get",t],c,{cachedAt:y}),Th(e,c),!(null===(a=null==c?void 0:c.myReactions)||void 0===a?void 0:a.includes(n))};const Mh=e=>{var t;return null!==(t=Object.keys(o).find((t=>e.needApprovalOnPostCreation===o[t].needApprovalOnPostCreation&&e.onlyAdminCanPost===o[t].onlyAdminCanPost)))&&void 0!==t?t:l};function Fh({communities:e}){return e.map((e=>{var{needApprovalOnPostCreation:t,onlyAdminCanPost:n}=e,r=Bo(e,["needApprovalOnPostCreation","onlyAdminCanPost"]);return Object.assign({postSetting:Mh({needApprovalOnPostCreation:t,onlyAdminCanPost:n})},r)}))}const Uh=e=>{const t=Fh({communities:e.communities}),n=e.communityUsers.map((t=>{const n=e.users.find((e=>e.userId===t.userId));return Object.assign(Object.assign({},t),{user:n})})),r=Ah(t,n);return Object.assign(Object.assign({},e),{communities:r,communityUsers:n})},Nh=e=>{const t=Fh({communities:e.communities}),n=e.communityUsers.map((t=>{const n=e.users.find((e=>e.userId===t.userId));return Object.assign(Object.assign({},t),{user:n})})),r=Ah(t,n);return Object.assign(Object.assign({},e),{communities:r,communityUsers:n})},Bh=e=>{const{postSetting:t,storySetting:n}=e,r=Bo(e,["postSetting","storySetting"]);return Object.assign(Object.assign(Object.assign({},r),t?o[t]:void 0),{allowCommentInStory:"boolean"!=typeof(null==n?void 0:n.enableComment)||n.enableComment})},jh=e=>{var t=Bo(e,["searchResult"]);const n=Uh(t);return Object.assign({},n)},$h=e=>{const{posts:t}=e,n=Bo(e,["posts"]),r=Fh({communities:n.communities}),s=n.communityUsers.map((e=>{const t=n.users.find((t=>t.userId===e.userId));return Object.assign(Object.assign({},e),{user:t})})),i=Ah(r,s),a=t.map((e=>{var t;const r=null===(t=n.feeds.find((t=>t.feedId===e.feedId)))||void 0===t?void 0:t.feedType;return Object.assign(Object.assign({},e),{feedType:r})}));return Object.assign(Object.assign({},n),{posts:a,communities:i,communityUsers:s})},qh=e=>{var{searchResult:t,polls:n}=e,r=Bo(e,["searchResult","polls"]);const s=$h(r);return Object.assign(Object.assign({},s),{polls:n})},Kh=(e,t)=>{const n=ve();return Xe(n,e,e,(r=>{var s;if(n.cache){const i=$h(r),{communities:a}=i;if(Uo(i,void 0,!1),(null==a?void 0:a[0])&&!["post.updated"].includes(e)&&Je("community.updated",{communities:a,categories:[],communityUsers:i.communityUsers,feeds:[],files:[],users:[]}),"post.deleted"===e){const{postId:e,postedUserId:s}=r.posts[0];try{Tl("post",e)}catch(e){return}return s!==n.userId&&Ie(["post","get",e]),t(r.posts[0])}const o=Se(["post","get",r.posts[0].postId]);if(["post.created","post.approved","post.declined"].includes(e)){let t=null===(s=we(["post","query"]))||void 0===s?void 0:s.filter((({key:e})=>{var t;return(null===(t=e[2])||void 0===t?void 0:t.targetId)===o.data.targetId}));"post.declined"===e&&(t=null==t?void 0:t.filter((({key:e})=>{var t;return"reviewing"===(null===(t=e[2])||void 0===t?void 0:t.feedType)}))),null==t||t.map((({key:e,data:t})=>Ee(e,t,{cachedAt:-1})))}t(o.data)}else t(r.posts[0])}))},Gh=(e,t)=>{const n=ve();return Xe(n,e,e,(r=>{if(n.cache){const n=$h(r),{communities:s}=n;Uo(n),(null==s?void 0:s[0])&&!["local.post.updated"].includes(e)&&Je("community.updated",{communities:s,categories:[],communityUsers:n.communityUsers,feeds:[],files:[],users:[]});const i=Se(["post","get",r.posts[0].postId]);t(i.data)}else t(r.posts[0])}))},Hh=e=>Kh("post.created",e),Vh=e=>Kh("post.updated",e),zh=e=>Kh("post.deleted",e),Wh=e=>Kh("post.approved",e),Yh=e=>Kh("post.declined",e),Qh=e=>Kh("post.flagged",e),Xh=e=>Kh("post.unflagged",e),Jh=e=>{const t=ve();return Xe(t,"post.addReaction","post.addReaction",(n=>{if(t.cache){const t=Bo(Lh("post.addReaction",n),["reactor"]);Uo(t);const r=Se(["post","get",n.posts[0].postId]);e(r.data)}else e(n.posts[0])}))},Zh=e=>{const t=ve();return Xe(t,"post.removeReaction","post.removeReaction",(n=>{if(t.cache){const t=Bo(Lh("post.removeReaction",n),["reactor"]);Uo(t);const r=Se(["post","get",n.posts[0].postId]);e(r.data)}else e(n.posts[0])}))},ef=(e,t)=>{const n=ve();return Xe(n,e,e,(r=>{var s;if(n.cache){const i=["comment.flagged","comment.unflagged"].includes(e)?(e=>{const t=_h(e,"comment");return Rh(e,"comments",t)})(r):r;Uo(i,void 0,!1);const{comments:a}=i;if(a.length>0){const r=Se(["comment","get",a[0].commentId]);if(["comment.created"].includes(e)){if("comment.created"===e&&r.data.userId===n.userId)return;if(a[0].parentId){const e=Se(["comment","get",a[0].parentId]);(null==e?void 0:e.data)&&(e.data.children.includes(a[0].commentId)||Ce(["comment","get",a[0].parentId],Object.assign(Object.assign({},e.data),{childrenNumber:e.data.childrenNumber+1,children:[...new Set([...e.data.children,a[0].commentId])]})))}}if(["comment.deleted"].includes(e)){if("comment.deleted"===e&&r.data.userId===n.userId)return;if(a[0].parentId){const e=Se(["comment","get",a[0].parentId]);if((null==e?void 0:e.data)&&e.data.children.includes(a[0].commentId)){const t=Object.assign(Object.assign({},e.data),{childrenNumber:e.data.childrenNumber-1,children:[...new Set([...e.data.children.filter((e=>e!==a[0].commentId))])]});Ce(["comment","get",a[0].parentId],t)}}const t=null===(s=we(["comment","query"]))||void 0===s?void 0:s.filter((({key:e})=>{var t;return(null===(t=e[2])||void 0===t?void 0:t.referenceId)===r.data.referenceId}));null==t||t.map((({key:e,data:t})=>Ee(e,t,{cachedAt:-1})))}t(yl.comment(r.data))}}else t(yl.comment(r.comments[0]))}))},tf=(e,t)=>{const n=ve();return Xe(n,e,e,(r=>{var s,i;if(n.cache){const n=r;Uo(n);const{comments:a}=n;if(a.length>0){const n=Se(["comment","get",a[0].commentId]);if(["local.comment.created"].includes(e)){if(a[0].parentId){const e=Se(["comment","get",a[0].parentId]);if((null==e?void 0:e.data)&&!e.data.children.includes(a[0].commentId)){const t=Object.assign(Object.assign({},e.data),{childrenNumber:e.data.childrenNumber+1,children:[...new Set([...e.data.children,a[0].commentId])]});Ce(["comment","get",a[0].parentId],t),setTimeout((()=>{Je("comment.updated",{comments:[t],commentChildren:[],files:[],users:[],communityUsers:[]})}),200)}}const e=null===(s=we(["comment","query"]))||void 0===s?void 0:s.filter((({key:e})=>{var t;return(null===(t=e[2])||void 0===t?void 0:t.referenceId)===n.data.referenceId}));null==e||e.map((({key:e,data:t})=>Ee(e,t,{cachedAt:-1})))}if(["local.comment.deleted"].includes(e)){if(a[0].parentId){const e=Se(["comment","get",a[0].parentId]);if((null==e?void 0:e.data)&&e.data.children.includes(a[0].commentId)){const t=Object.assign(Object.assign({},e.data),{childrenNumber:e.data.childrenNumber-1,children:[...new Set([...e.data.children.filter((e=>e!==a[0].commentId))])]});Ce(["comment","get",a[0].parentId],t),setTimeout((()=>{Je("comment.updated",{comments:[t],commentChildren:[],files:[],users:[],communityUsers:[]})}),200)}}const e=null===(i=we(["comment","query"]))||void 0===i?void 0:i.filter((({key:e})=>{var t;return(null===(t=e[2])||void 0===t?void 0:t.referenceId)===n.data.referenceId}));null==e||e.map((({key:e,data:t})=>Ee(e,t,{cachedAt:-1})))}t(yl.comment(n.data))}}else t(yl.comment(r.comments[0]))}))},nf=e=>ef("comment.created",e),rf=e=>ef("comment.updated",e),sf=e=>ef("comment.deleted",e),af=e=>ef("comment.flagged",e),of=e=>ef("comment.unflagged",e),lf=e=>{const t=ve();return Xe(t,"comment.addReaction","comment.addReaction",(n=>{if(t.cache){const t=Bo(Lh("comment.addReaction",n),["reactor"]);Uo(t);const r=Se(["comment","get",n.comments[0].commentId]);e(yl.comment(r.data))}else e(yl.comment(n.comments[0]))}))},cf=e=>{const t=ve();return Xe(t,"comment.removeReaction","comment.removeReaction",(n=>{if(t.cache){const t=Bo(Lh("comment.removeReaction",n),["reactor"]);Uo(t);const r=Se(["comment","get",n.comments[0].commentId]);e(yl.comment(r.data))}else e(yl.comment(n.comments[0]))}))},df=(e,t,n)=>{const r=ve(),s=(r,s,i)=>{r===e&&s===t&&n(i)};if("message"===e){return Xe(r,"reaction/onReactorAdded","message.reactionAdded",(async e=>{const t=await xl(e);t.reactions[0]&&(Uo(t),Uo({reactors:t.reactions}),s("message",t.messages[0].messageId,t.reactions[0]))}))}if("post"===e){return Xe(r,"post.addReaction","post.addReaction",(e=>{const{reactor:t}=e,n=Bo(e,["reactor"]);Uo(n),Uo({reactions:[t]}),s("post",e.posts[0].postId,t)}))}if("story"===e){return Xe(r,"story.reactionAdded","story.reactionAdded",(e=>{const{reactions:t}=e,n=Bo(e,["reactions"]);Uo(n),Uo({reactors:t}),0!==e.stories.length&&0!==e.reactions.length&&s("story",e.stories[0].storyId,e.reactions[0])}))}return Xe(r,"comment.addReaction","comment.addReaction",(e=>{const{reactor:t}=e,n=Bo(e,["reactor"]);Uo(n),Uo({reactions:[t]}),s("comment",e.comments[0].commentId,t)}))},uf=(e,t,n)=>{const r=ve(),s=(r,s,i)=>{r===e&&s===t&&n(i)};if("message"===e){return Xe(r,"reaction/onReactorRemoved","message.reactionRemoved",(async e=>{const t=await xl(e);t.reactions[0]&&(Uo(t),s("message",t.messages[0].messageId,t.reactions[0]))}))}if("post"===e){return Xe(r,"post.removeReaction","post.removeReaction",(e=>{const{reactor:t}=e,n=Bo(e,["reactor"]);Uo(n),Uo({reactions:[t]}),s("post",e.posts[0].postId,t)}))}if("story"===e){return Xe(r,"story.reactionRemoved","story.reactionRemoved",(e=>{const{reactions:t}=e,n=Bo(e,["reactions"]);Uo(n),Uo({reactors:t}),0!==e.stories.length&&0!==e.reactions.length&&s("story",e.stories[0].storyId,e.reactions[0])}))}return Xe(r,"comment.removeReaction","comment.removeReaction",(e=>{const{reactor:t}=e,n=Bo(e,["reactor"]);Uo(n),Uo({reactions:[t]}),s("comment",e.comments[0].commentId,t)}))};class hf extends Mu{async getRequest(e,t){const{limit:n=f}=e,r=Bo(e,["limit"]),s=t?{token:t}:{limit:n};ve().log("reaction/queryReactions",e);if(!["post","comment","story","message"].includes(r.referenceType))throw new pe("The reference type is not valid. It should be one of post, comment, story, or message",4e5,"error");const{data:i}=await this.http.get("/api/v3/reactions",{params:Object.assign(Object.assign({},r),{referenceVersion:5,options:s})});return i}}class ff extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){var t;const n=await this.preparePayload(e),r=ve(),s=r.cache&&Date.now();if(r.cache){const{reactions:e}=n,r=Bo(n,["reactions"]);Uo(Object.assign(Object.assign({},r),{reactions:e,reactors:null===(t=e[0])||void 0===t?void 0:t.reactors}),{cachedAt:s})}}appendToQueryStream(e,t,n=!1){var r,s,i,a;const o=null!==(s=null===(r=e.reactions[0])||void 0===r?void 0:r.reactors)&&void 0!==s?s:[];if(n)Ce(this.cacheKey,{data:o.map(de("reactor"))});else{const e=null===(i=Se(this.cacheKey))||void 0===i?void 0:i.data,t=null!==(a=null==e?void 0:e.data)&&void 0!==a?a:[];Ce(this.cacheKey,Object.assign(Object.assign({},e),{data:[...new Set([...t,...o.map(de("reactor"))])]}))}}reactor(e){return t=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;r&&("onAdded"===e?r.data=[...new Set([t.reactionId,...r.data])]:"onRemoved"===e&&(r.data=r.data.filter((e=>e!==t.reactionId))),Ce(this.cacheKey,r),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}class pf extends ju{constructor(e,t){const n=Pu(e),r=["reaction","collection",n];super(new hf(e),n,r,t),this.query=e,this.queryStreamController=new ff(this.query,this.cacheKey,this.notifyChange.bind(this),(e=>e)),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:e=>df(this.query.referenceType,this.query.referenceId,e),action:"onAdded"},{fn:e=>uf(this.query.referenceType,this.query.referenceId,e),action:"onRemoved"},{fn:e=>((e,t,n)=>{const r=ve(),s=(r,s,i)=>{r===e&&s===t&&n(i)};if("message"===e)return Xe(r,"reaction/onReactorRemoved","message.reactionRemoved",(async e=>{const t=await xl(e);t.reactions[0]&&(Uo(t),s("message",t.messages[0].messageId,t.reactions[0]))}));if("post"===e)return Xe(r,"local.post.removeReaction","local.post.removeReaction",(e=>{s("post",e.post.postId,e.reactor)}));if("story"===e)return Xe(r,"story.reactionRemoved","story.reactionRemoved",(e=>{const{reactions:t}=e,n=Bo(e,["reactions"]);Uo(n),Uo({reactors:t}),0!==e.stories.length&&0!==e.reactions.length&&s("story",e.stories[0].storyId,e.reactions[0])}));return Xe(r,"local.comment.removeReaction","local.comment.removeReaction",(e=>{s("comment",e.comment.commentId,e.reactor)}))})(this.query.referenceType,this.query.referenceId,e),action:"onRemoved"},{fn:e=>((e,t,n)=>{const r=ve(),s=(r,s,i)=>{r===e&&s===t&&n(i)};if("message"===e)return Xe(r,"reaction/onReactorAdded","message.reactionAdded",(async e=>{const t=await xl(e);t.reactions[0]&&(Uo(t),Uo({reactors:t.reactions}),s("message",t.messages[0].messageId,t.reactions[0]))}));if("post"===e)return Xe(r,"local.post.addReaction","local.post.addReaction",(e=>{s("post",e.post.postId,e.reactor)}));if("story"===e)return Xe(r,"story.reactionAdded","story.reactionAdded",(e=>{const{reactions:t}=e,n=Bo(e,["reactions"]);Uo(n),Uo({reactors:t}),0!==e.stories.length&&0!==e.reactions.length&&s("story",e.stories[0].storyId,e.reactions[0])}));return Xe(r,"local.comment.addReaction","local.comment.addReaction",(e=>{s("comment",e.comment.commentId,e.reactor)}))})(this.query.referenceType,this.query.referenceId,e),action:"onRemoved"}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=null!==(s=i.data.map((e=>Se(["reactor","get",e]))).filter(Boolean).map((({data:e})=>yl.reactor(e))))&&void 0!==s?s:[];(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}}var gf=Object.freeze({__proto__:null,addReaction:xh,removeReaction:Ph,onReactionAdded:(e,t,n)=>{const r=r=>{de(e)(r)===t&&n(r)};if("message"===e){const e=ve(),t=async e=>{var t;const n=await xl(e),s=Se(["message","get",n.messages[0].messageId]),i=(null===(t=null==s?void 0:s.data)||void 0===t?void 0:t.reactionsCount)!==n.messages[0].reactionsCount;Uo(n),i&&r(n.messages[0])};return Xe(e,"reaction/onReactionAdded","message.updated",t)}return"post"===e?Jh(r):lf(r)},onReactionRemoved:(e,t,n)=>{const r=r=>{de(e)(r)===t&&n(r)};if("message"===e){const e=ve(),t=async e=>{var t;const n=await xl(e),s=Se(["message","get",n.messages[0].messageId]),i=(null===(t=null==s?void 0:s.data)||void 0===t?void 0:t.reactionsCount)!==n.messages[0].reactionsCount;Uo(n),i&&r(n.messages[0])};return Xe(e,"reaction/onReactionRemoved","message.updated",t)}return"post"===e?Zh(r):cf(r)},onReactorAdded:df,onReactorRemoved:uf,getReactions:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log("For using Live Collection feature you need to enable Cache!");const i=Date.now();r(`getReactions(tmpid: ${i}) > listen`);const a=new pf(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>{Ie(l)})),()=>{r(`getReactions(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}}});function mf(e){const{comments:t}=e;return Object.assign(Object.assign({},e),{comments:t.map((e=>e.hasOwnProperty("myReactions")?e:Object.assign({myReactions:[]},e)))})}const yf=async e=>{const t=ve();let n;t.log("channel/getChannel",e),Tl("channel",e);try{const{data:r}=await t.http.get(`/api/v3/channels/${encodeURIComponent(e)}`);n=await Jl(r),t.isUnreadCountEnabled&&t.getMarkerSyncConsistentMode()&&ec(r)}catch(t){throw I(null==t?void 0:t.code)&&No("channel",e),t}const r=t.cache&&Date.now();t.cache&&Uo(n,{cachedAt:r});const{channels:s}=n;return{data:s.find((t=>t.channelId===e)),cachedAt:r}};yf.locally=e=>{var t;const n=ve();if(n.log("channel/getChannel.locally",e),!n.cache)return;const r=null===(t=we(["channel","get"]))||void 0===t?void 0:t.filter((({data:t})=>t.channelPublicId===e));return r&&0!==(null==r?void 0:r.length)?{data:r[0].data,cachedAt:r[0].cachedAt}:void 0};const vf=e=>{const t=ve(),n=[Xe(t,"onMessageUpdated","message.updated",(async t=>{const n=await xl(t);Uo(n),e(n.messages[0])})),Xe(t,"onMessageUpdated","local.message.updated",(t=>e(t.messages[0])))];return()=>{n.forEach((e=>e()))}},bf=e=>{const t=ve(),n=[Xe(t,"message/onMessageDeleted","message.deleted",(async t=>{const n=await xl(t);Uo(n),e(n.messages[0])})),Xe(t,"message/onMessageDeleted","local.message.deleted",(t=>e(t.messages[0])))];return()=>{n.forEach((e=>e()))}},wf=e=>{const t=ve(),n=[Xe(t,"onSubChannelUpdated","message-feed.updated",(async t=>{const n=await Nl(t);Uo(n),e(n.messageFeeds[0])})),Xe(t,"onSubChannelUpdated","local.message-feed.updated",(t=>e(t.messageFeeds[0])))];return()=>{n.forEach((e=>e()))}};function Sf(e,t){Ce(["channel","get",e.channelId],ml(e,t))}const Cf=e=>{const t=ve();return Xe(t,"channelMarker/onChannelMarkerUpdated","local.channelMarker.updated",(t=>{e(t.userEntityMarkers[0])}))},Tf=async(e,t=!1)=>{const n=ve(),r=await Bl(e);await n.http.delete(`/api/v5/message-feeds/${encodeURIComponent(e)}`,{params:{permanent:t}});const s=Object.assign(Object.assign({},r.data),{isDeleted:!0,updatedAt:he(r.data.updatedAt)});return t?setTimeout((()=>{No("subChannel",e)}),0):Ee(["subChannel","get",e],s),Je("local.message-feed.deleted",{messageFeeds:[s]}),s},Ef=e=>Xe(ve(),"onSubChannelFetched","local.message-feed.fetched",(t=>e(t.messageFeeds[0]))),If=()=>`LOCAL_${Oo()}`;let kf;const Af=async(e,t)=>{const n=ve();n.log("message/updateMessage",t),console.warn("MessageRepository.updateMessage will be replaced with MessageRepository.editMessage");const{data:r}=await n.http.put(`/api/v5/messages/${encodeURIComponent(e)}`,Pl(t)),s=await xl(r),i=n.cache&&Date.now();n.cache&&Uo(s,{cachedAt:i});const{messages:a}=s;return Je("local.message.updated",{messages:a}),{data:yl.message(a.find((t=>t.messageId===e))),cachedAt:i}};Af.optimistically=(e,t)=>{const n=ve();if(n.log("message/updateMessage.optimistically",t),!n.cache)return;const r=Se(["message","get",e]);if(!r)return;const s=Object.assign(Object.assign(Object.assign({},r.data),t),{updatedAt:(new Date).toISOString()});return Ee(["message","get",e],s,{cachedAt:-1}),Je("local.message.updated",{messages:[s]}),{data:yl.message(s),cachedAt:-1}};const _f=async(e,t)=>{const n=ve();n.log("message/editMessage",t);const{data:r}=await n.http.put(`/api/v5/messages/${encodeURIComponent(e)}`,Pl(t)),s=await xl(r),i=n.cache&&Date.now();n.cache&&Uo(s,{cachedAt:i});const{messages:a}=s;return Je("local.message.updated",{messages:a}),{data:yl.message(a.find((t=>t.messageId===e))),cachedAt:i}};_f.optimistically=(e,t)=>{const n=ve();if(n.log("message/editMessage.optimistically",t),!n.cache)return;const r=Se(["message","get",e]);if(!r)return;const s=Object.assign(Object.assign(Object.assign({},r.data),t),{updatedAt:(new Date).toISOString()});return Ee(["message","get",e],s,{cachedAt:-1}),Je("local.message.updated",{messages:[s]}),{data:yl.message(s),cachedAt:-1}};const Rf=async e=>{const t=ve();t.log("message/deleteMessage",e);const{data:n}=await t.http.delete(`/api/v5/messages/${encodeURIComponent(e)}`),r=await xl(n);return Je("local.message.deleted",{messages:[r.messages[0]]}),yl.message(r.messages[0])};Rf.optimistically=e=>{ve().log("message/deleteMessage.optimistically",e);const t=Se(["message","get",e]);if(!t)return;const n=Object.assign(Object.assign({},t.data),{isDeleted:!0,updatedAt:(new Date).toISOString()});return Ee(["message","get",e],n,{cachedAt:-1}),Je("local.message.deleted",{messages:[n]}),{data:yl.message(n),cachedAt:-1}};const Of=async e=>{const t=ve();t.log("message/softDeleteMessage",e),await t.http.delete(`/api/v5/messages/${encodeURIComponent(e)}`);const n=await Eh(e);return Je("local.message.deleted",{messages:[n.data]}),yl.message(n.data)};Of.optimistically=e=>{ve().log("message/softDeleteMessage.optimistically",e);const t=Se(["message","get",e]);if(!t)return;const n=Object.assign(Object.assign({},t.data),{isDeleted:!0,updatedAt:(new Date).toISOString()});return Ee(["message","get",e],n,{cachedAt:-1}),Je("local.message.deleted",{messages:[n]}),{data:yl.message(n),cachedAt:-1}};const Lf=async e=>{const t=ve();t.log("user/getReadUsers",e);const{page:n,messageId:r}=e,s=Bo(e,["page","messageId"]),{data:i}=await t.http.get(`/api/v1/markers/messages/${r}/read-users`,{params:Object.assign(Object.assign({},s),{options:{token:J(n,"afterbeforeraw")}})}),{paging:a,publicUserIds:o,userFeedMarkers:l}=i,c=Bo(i,["paging","publicUserIds","userFeedMarkers"]),d=t.cache&&Date.now();if(t.cache){Uo(Object.assign(Object.assign({},c),{userFeedMarkers:Go(l)}),{cachedAt:d});const e=["read-user","query",Object.assign(Object.assign({messageId:r},s),{options:Object.assign({},n)})];Ce(e,{users:o,paging:a})}let u=[];o.length>0&&({data:u}=await Yu(o));return{data:u,cachedAt:d,prevPage:Z(a.previous),nextPage:Z(a.next)}};Lf.locally=e=>{var t;const n=ve();if(n.log("user/getReadUsers.locally",e),!n.cache)return;const{page:r}=e,s=Bo(e,["page"]),i=["read-user","query",Object.assign(Object.assign({},s),{options:Object.assign({},r)})],{data:a,cachedAt:o}=null!==(t=Se(i))&&void 0!==t?t:{},l=null==a?void 0:a.users.map((e=>{var t;return null===(t=Se(["user","get",e]))||void 0===t?void 0:t.data}));if(!l||l.some((e=>!e)))return;return{data:l,cachedAt:o,prevPage:Z(null==a?void 0:a.paging.previous),nextPage:Z(null==a?void 0:a.paging.next)}};const Df=async e=>{const t=ve();t.log("user/getDeliveredUsers",e);const{page:n,messageId:r}=e,s=Bo(e,["page","messageId"]),{data:i}=await t.http.get(`/api/v1/markers/messages/${r}/delivered-users`,{params:Object.assign(Object.assign({},s),{options:{token:J(n,"afterbeforeraw")}})}),{paging:a,publicUserIds:o,userFeedMarkers:l}=i,c=Bo(i,["paging","publicUserIds","userFeedMarkers"]),d=t.cache&&Date.now();if(t.cache){Uo(Object.assign(Object.assign({},c),{userFeedMarkers:Go(l)}),{cachedAt:d});const e=["delivered-user","query",Object.assign(Object.assign({messageId:r},s),{options:Object.assign({},n)})];Ce(e,{users:o,paging:a})}let u=[];o.length>0&&({data:u}=await Yu(o));return{data:u,cachedAt:d,prevPage:Z(a.previous),nextPage:Z(a.next)}};Df.locally=e=>{var t;const n=ve();if(n.log("user/getDeliveredUsers.locally",e),!n.cache)return;const{page:r}=e,s=Bo(e,["page"]),i=["delivered-user","query",Object.assign(Object.assign({},s),{options:Object.assign({},r)})],{data:a,cachedAt:o}=null!==(t=Se(i))&&void 0!==t?t:{},l=null==a?void 0:a.users.map((e=>{var t;return null===(t=Se(["user","get",e]))||void 0===t?void 0:t.data}));if(!l||l.some((e=>!e)))return;return{data:l,cachedAt:o,prevPage:Z(null==a?void 0:a.paging.previous),nextPage:Z(null==a?void 0:a.paging.next)}};const xf=e=>{const t=ve();return Xe(t,"onMessageFlagged","message.flagged",(async t=>{const n=await xl(t);Uo(n),e(n.messages[0])}))},Pf=e=>{const t=ve();return Xe(t,"onMessageUnflagged","message.unflagged",(async t=>{const n=await xl(t);Uo(n),e(n.messages[0])}))},Mf=e=>{const t=ve();return Xe(t,"onMessageFlagCleared","message.flagCleared",(async t=>{const n=await xl(t);Uo(n),e(n.messages[0])}))},Ff=e=>{const t=ve();return Xe(t,"onMessageReactionAdded","message.reactionAdded",(async t=>{const n=await xl(t,"message.reactionAdded");Uo(n),e(n.messages[0])}))},Uf=e=>{const t=ve();return Xe(t,"onMessageReactionRemoved","message.reactionRemoved",(async t=>{const n=await xl(t,"message.reactionRemoved");Uo(n),e(n.messages[0])}))},Nf=e=>{const t=ve();return Xe(t,"message/onMessageFetched","local.message.fetched",(t=>{Uo(t),e(t.messages[0])}))};class Bf extends Uu{constructor(e,t,n,r,s){super(e,t),this.notifyChange=n,this.preparePayload=r,this.paginationController=s}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.messages.map(de("message")),query:this.query});else{const n=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,i=null!==(s=null==n?void 0:n.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},n),{data:"next"===t?[...new Set([...i,...e.messages.map(de("message"))])]:[...new Set([...e.messages.map(de("message")),...i])]}))}}reactor(e){return t=>{var n,r,s;if("onCreate"===e){const e=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data,{referenceId:i}=t;if(!e)return;if(this.query.subChannelId!==(null==t?void 0:t.subChannelId)||!e)return;if(this.query.type&&this.query.type!==t.dataType)return;if(this.query.excludingTags&&(null===(r=this.query.excludingTags)||void 0===r?void 0:r.some((e=>{var n;return null===(n=t.tags)||void 0===n?void 0:n.includes(e)}))))return;if(!!this.query.hasFlags!=!!t.flagCount)return;if(this.query.parentId&&this.query.parentId!==t.parentId)return;if(this.query.hasOwnProperty("includeDeleted")&&!this.query.includeDeleted&&t.isDeleted)return;if(this.query.includingTags&&!(null===(s=this.query.includingTags)||void 0===s?void 0:s.some((e=>{var n;return null===(n=t.tags)||void 0===n?void 0:n.includes(e)}))))return;this.query.sortBy&&"segmentDesc"!==this.query.sortBy||this.paginationController.getPrevToken()||(e.data=[...new Set([null!=i?i:t.messageId,...e.data])]),"segmentAsc"!==this.query.sortBy||this.paginationController.getNextToken()||(e.data=[...new Set([...e.data,null!=i?i:t.messageId])]),Ce(this.cacheKey,e)}this.notifyChange({origin:"event",loading:!1})}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}class jf extends Mu{async getRequest(e,t){const n=Ml(e),{data:r}=await this.http.get("/api/v5/messages",{params:Object.assign(Object.assign({},n),{options:t?{token:t}:Object.assign({},n.options)})});return r}}class $f extends ju{constructor(e,t){const n=Pu(e),r=["message","collection",n];super(new jf(e),n,r,t),this.query=e,this.queryStreamController=new Bf(this.query,this.cacheKey,this.notifyChange.bind(this),xl,this.paginationController),this.callback=t.bind(this),this.loadPage({initial:!0})}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:Ad,action:"onCreate"},{fn:_d,action:"onCreate"},{fn:bf,action:"onDelete"},{fn:vf,action:"onUpdate"},{fn:xf,action:"onFlagged"},{fn:Pf,action:"onUnflagged"},{fn:Mf,action:"onFlagCleared"},{fn:Ff,action:"onReactionAdded"},{fn:Uf,action:"onReactionRemoved"},{fn:ch(ou,"contentId","message"),action:"onUpdate"},{fn:ch(lu,"contentId","message"),action:"onUpdate"}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>(e=>{var t,n;const r=null===(t=Se(["message","get",e]))||void 0===t?void 0:t.data;if(r)return r;const s=we(["message","get"]);return null===(n=null==s?void 0:s.find((({data:t})=>t.messageId===e)))||void 0===n?void 0:n.data})(e))).filter(Boolean).map((e=>yl.message(e))))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),onPrevPage:()=>this.loadPage({direction:"prev"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),hasPrevPage:!!this.paginationController.getPrevToken(),loading:t,error:n})}applyFilter(e){let t=e;return this.query.includeDeleted||(t=ke(t,"isDeleted",!1)),t=t.sort(((e,t)=>"segmentAsc"===this.query.sortBy?e.channelSegment-t.channelSegment:"segmentDesc"===this.query.sortBy?t.channelSegment-e.channelSegment:0)),t}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],query:this.query})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}}var qf=Object.freeze({__proto__:null,createMessage:async e=>{const t=ve();t.log("message/createMessage",e);const n=(e=>{var t,n;const r=ve();if(!r.cache)return;kf=e.referenceId||If();const s=Object.assign({messageId:kf,uniqueId:kf},e);r.log("message/createMessage.optimistically",s);const i=Se(["subChannel","get",e.subChannelId]);if(i&&(Ee(["subChannel","get",e.subChannelId],Object.assign(Object.assign({},i.data),{messageCount:i.data.messageCount+1})),i.data.channelId===i.data.subChannelId)){const e=Se(["channel","get",i.data.channelId]);(null==e?void 0:e.data)&&Ee(["channel","get",i.data.channelId],Object.assign(Object.assign({},e.data),{messageCount:(null!==(t=e.data.messageCount)&&void 0!==t?t:0)+1}))}const a=(new Date).toISOString(),o=Object.assign({creatorId:r.userId,creatorPrivateId:Ke()._id,channelSegment:(null!==(n=null==i?void 0:i.data.messageCount)&&void 0!==n?n:0)+1,childrenNumber:0,createdAt:a,updatedAt:a,syncState:"syncing",isDeleted:!1},s);return Ce(["message","get",o.messageId],o,{cachedAt:-5}),Je("local.message.created",{messages:[o]}),o})(e),r=e.referenceId||kf||If();kf=void 0;try{const{data:n}=await t.http.post("/api/v5/messages",Object.assign(Object.assign({},Pl(e)),{referenceId:r})),s=await xl(n),{messages:i}=s,a=t.cache&&Date.now();return t.cache&&Uo(s,{cachedAt:a}),Je("local.message.created",{messages:[Object.assign(Object.assign({},i[0]),{syncState:"synced"})]}),{data:yl.message(i[0]),cachedAt:a}}catch(e){throw Je("local.message.created",{messages:[Object.assign(Object.assign({},n),{syncState:"error"})]}),e}},updateMessage:Af,editMessage:_f,deleteMessage:Rf,softDeleteMessage:Of,markAsDelivered:async(e,t)=>{const n=ve();n.log("message/markAsDelivered",e,t);const{data:r}=await n.http.put(`/api/v1/markers/message-feeds/${e}/mark-delivering`,{messageId:t}),{userMarkers:s,userEntityMarkers:i,userFeedMarkers:a}=r,o=Bo(r,["userMarkers","userEntityMarkers","userFeedMarkers"]),l=n.cache&&Date.now();return n.cache&&Uo(Object.assign({userMarkers:s,userEntityMarkers:Ko(i),userFeedMarkers:Go(a)},o),{cachedAt:l}),!0},getReadUsers:Lf,getDeliveredUsers:Df,flagMessage:async e=>{const t=ve();t.log("message/flag",e);const{data:n}=await t.http.post(`/api/v5/messages/${encodeURIComponent(e)}/flags`);if(t.cache){const e=await xl(n);Uo(e)}return Je("message.flagged",n),!!n},unflagMessage:async e=>{const t=ve();t.log("message/unflag",e);const{data:n}=await t.http.delete(`/api/v5/messages/${encodeURIComponent(e)}/flags`);if(t.cache){const e=await xl(n);Uo(e)}return Je("message.unflagged",n),!!n},isMessageFlaggedByMe:async e=>{const t=ve();t.log("message/isMessageFlaggedByMe",e);const{data:n}=await t.http.get(`/api/v5/messages/${encodeURIComponent(e)}/flags`);return n.result},onMessageCreatedMqtt:Ad,onMessageCreatedLocal:_d,onMessageUpdated:vf,onMessageDeleted:bf,onMessageFlagged:xf,onMessageUnflagged:Pf,onMessageFlagCleared:Mf,onMessageReactionAdded:Ff,onMessageReactionRemoved:Uf,onMessageFetched:Nf,getMessage:(e,t)=>zu(e,(e=>{const{data:n}=e;t(Object.assign(Object.assign({},e),{data:n?yl.message(e.data):n}))}),"messageId",Eh,[Nf,vf,bf,xf,Pf,Mf,Ff,Uf,ch(ou,"contentId","message"),ch(lu,"contentId","message")]),getMessages:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getMessages(tmpid: ${i}) > listen`);const a=new $f(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>{Ie(l)})),()=>{r(`getMessages(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},convertFromRaw:Ll,prepareMessagePayload:xl,convertParams:Pl,convertQueryParams:Ml});const Kf=e=>{const t=ve();return Xe(t,"subChannelMarker/onSubChannelUnreadUpdatedLocal","local.subChannelUnread.updated",(t=>{e(t)}))};class Gf extends Mu{async getRequest(e,t){var n;const{limit:r=f}=e,s=null!==(n=function(e){var{excludeDefaultSubChannel:t}=e,n=Bo(e,["excludeDefaultSubChannel"]);const r=Object.assign({},n);return void 0!==t&&(r.excludeDefaultMessageFeed=t),r}(Bo(e,["limit"])))&&void 0!==n?n:{},{channelId:i,includeDeleted:a}=s,o=Bo(s,["channelId","includeDeleted"]),l=t?{token:t}:{limit:r},{data:c}=await this.http.get(`/api/v5/message-feeds/channel/${i}`,{params:Object.assign(Object.assign({},o),{isDeleted:kl(a),options:l})});return c}}class Hf extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.messageFeeds.map((({messageFeedId:e})=>e))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.messageFeeds.map((({messageFeedId:e})=>e))])]}))}}reactor(e){return t=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;if(r){if(!Array.isArray(t)){if(this.query.channelId!==t.channelId)return;"onCreate"===e&&(r.data=[...new Set([t.subChannelId,...r.data])]),Ce(this.cacheKey,r)}this.notifyChange({origin:"event",loading:!1})}}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}class Vf extends ju{constructor(e,t){const n=Pu(e),r=["subChannel","collection",n];super(new Gf(e),n,r,t),this.query=e,this.queryStreamController=new Hf(this.query,this.cacheKey,this.notifyChange.bind(this),Nl),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[]})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:Ef,action:"onCreate"},{fn:Rd,action:"onCreate"},{fn:Od,action:"onDelete"},{fn:e=>wf((async t=>{if(!this.isRelatedCollection(t.subChannelId))return;const n=ve();if("no-message-preview"!==await n.getMessagePreviewSetting(!1)){const e=bl(t.subChannelId);(null==e?void 0:e.subChannelId)===t.subChannelId&&jl(t.updatedAt)>jl(e.subChannelUpdatedAt)&&Ce(["messagePreviewSubChannel","get",t.subChannelId],Object.assign(Object.assign({},e),{subChannelName:t.displayName,subChannelUpdatedAt:t.updatedAt}))}e(t)})),action:"onUpdate"},{fn:ch((e=>Ad((async t=>{this.isRelatedCollection(t.subChannelId)&&(await ql(t),e(t))}))),"subChannelId","subChannel"),action:"onUpdate"},{fn:ch((e=>_d((async t=>{this.isRelatedCollection(t.subChannelId)&&(await ql(t),e(t))}))),"subChannelId","subChannel"),action:"onUpdate"},{fn:e=>iu((t=>{var n;const r=null!==(n=t.map((({feedId:e})=>Se(["subChannel","get",e]))).filter(Boolean).map((({data:e})=>e)))&&void 0!==n?n:[];0!==r.length&&e(r)})),action:"onUpdate"},{fn:ch(su,"feedId","subChannel"),action:"onUpdate"},{fn:ch((e=>vf((async t=>{var n;const r=ve();if("no-message-preview"===await r.getMessagePreviewSetting(!1))return;const s=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;s&&s.data.includes(t.subChannelId)&&(Kl(t),e(t))}))),"subChannelId","subChannel"),action:"onUpdate"},{fn:ch((e=>bf((async t=>{const n=ve(),r=await n.getMessagePreviewSetting(!1);"no-message-preview"!==r&&this.isRelatedCollection(t.subChannelId)&&("message-preview-not-include-deleted"===r?await Bl(t.subChannelId):await Kl(t),e(t))}))),"subChannelId","subChannel"),action:"onUpdate"},{fn:ch(Kf,"subChannelId","subChannel"),action:"onUpdate"}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["subChannel","get",e]))).filter(Boolean).map((({data:e})=>e)).map(wl))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){let t=e;return this.query.includeDeleted||(t=ke(e,"isDeleted",!1)),t.sort($e),t}isRelatedCollection(e){var t;const n=null===(t=Se(this.cacheKey))||void 0===t?void 0:t.data;return n&&n.data.includes(e)}}const zf={},Wf=async e=>{const t=await(async e=>{const t=Bl.locally(e);if(t)return t.data.channelId;const{data:n}=await Bl(e);return n.channelId})(e),n=at({channelId:t,subChannelId:e});zf[e]=ht(n)};var Yf=Object.freeze({__proto__:null,getSubChannelByIds:yc,createSubChannel:async e=>{const t=ve();t.log("user/createSubChannel",e);const n=await t.http.post("/api/v5/message-feeds",{channelId:e.channelId,name:e.displayName}),r=await Nl(n.data),s=t.cache&&Date.now();return t.cache&&Uo(r,{cachedAt:s}),Je("message-feed.created",n.data),{data:r.messageFeeds[0],cachedAt:s}},updateSubChannel:async(e,t)=>{const n=ve();n.log("channel/updateSubChannel",e,t);const r=await n.http.put(`/api/v5/message-feeds/${encodeURIComponent(e)}`,{name:t.displayName}),s=await Nl(r.data),i=n.cache&&Date.now();return n.cache&&Uo(s,{cachedAt:i}),Je("message-feed.updated",r.data),{data:s.messageFeeds[0],cachedAt:i}},deleteSubChannel:Tf,hardDeleteSubChannel:async e=>{ve().log("channel/hardDeleteSubChannel",e);return await Tf(e,!0)},softDeleteSubChannel:async e=>{ve().log("channel/softDeleteSubChannel",e);return await Tf(e,!1)},onSubChannelCreated:Rd,onSubChannelUpdated:wf,onSubChannelDeleted:Od,getSubChannel:(e,t)=>{const n=ve();let r;return zu(e,(e=>{if(!e.data)return t(e);const n=Object.assign(Object.assign({},e),{data:wl(e.data)}),s=Bo(n,["origin"]);return rl(r,s)?void 0:(r=s,t(n))}),"subChannelId",Bl,[Ef,t=>wf((async r=>{"no-message-preview"!==await n.getMessagePreviewSetting(!1)&&(Vl(r),r.subChannelId===e&&t(r))})),Od,ch(su,"feedId","subChannel"),t=>iu((n=>{var r;if(!n.find((({feedId:t})=>t===e)))return;const s=null===(r=Se(["subChannel","get",e]))||void 0===r?void 0:r.data;s&&t(s)})),ch((t=>Ad((async n=>{n.subChannelId===e&&(await ql(n),t(n))}))),"subChannelId","subChannel"),ch((t=>_d((async n=>{n.subChannelId===e&&(await ql(n),t(n))}))),"subChannelId","subChannel"),ch((t=>vf((async r=>{"no-message-preview"!==await n.getMessagePreviewSetting(!1)&&r.subChannelId===e&&(Kl(r),t(r))}))),"subChannelId","subChannel"),ch((t=>bf((async r=>{const s=await n.getMessagePreviewSetting(!1);"no-message-preview"!==s&&r.subChannelId===e&&("message-preview-include-deleted"===s&&await Kl(r),"message-preview-not-include-deleted"===s&&await Bl(r.subChannelId),t(r))}))),"subChannelId","subChannel"),ch(Kf,"subChannelId","subChannel")],{forceDispatch:!0})},getSubChannels:(e,t,n)=>{const{log:r,cache:s}=ve(),i=Date.now();r(`getSubChannels(tmpid: ${i}) > listen`),s||console.log(g);const a=new Vf(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>{Ie(l)})),()=>{r(`getSubChannels(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},markReadEngineOnLoginHandler:mc,startMessageReceiptSync:async e=>(await Wf(e),!0),stopMessageReceiptSync:e=>(zf[e]&&zf[e](),!0)});const Qf=e=>{const t=ve();return Xe(t,"channelMarker/onChannelUnreadInfoUpdatedLocal","local.channelUnreadInfo.updated",(t=>{e(t)}))},Xf=e=>{const t=ve();return Xe(t,"channel/onChannelUnreadUpdatedLocal","local.channelUnread.updated",(t=>{e(t)}))};class Jf extends Mu{async getRequest(e,t){const{limit:n=f,displayName:r,membership:s}=e,i=Bo(e,["limit","displayName","membership"]),a=t?{token:t}:{limit:n},{data:o}=await this.http.get("/api/v3/channels",{params:Object.assign(Object.assign({},i),{keyword:r,filter:s,options:a})});return o}}class Zf extends Bu{async getRequest(e){const{data:t}=await this.http.get("/api/v3/channels/list",{params:Object.assign({},e)});return t}}class ep extends Uu{constructor(e,t,n,r,s){super(e,t),this.notifyChange=n,this.preparePayload=r,this.paginationController=s}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.channels.map(de("channel"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.channels.map(de("channel"))])]}))}}reactor(e){return t=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;if(r){if(this.paginationController instanceof Zf)return this.notifyChange({origin:"event",loading:!1});["onCreate","onJoin","onResolveChannel"].includes(e)&&(Array.isArray(t)?r.data=[...new Set([...t.map(de("channel")),...r.data])]:r.data=[...new Set([t.channelInternalId,...r.data])]),Ce(this.cacheKey,r),this.notifyChange({origin:"event",loading:!1})}}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}const tp=e=>{const t=ve();if(t.isUnreadCountEnabled&&t.getMarkerSyncConsistentMode()){Kc().resolve(e.channelId,"userMessageFeedMarker")}},np=e=>{const t=ve();return Xe(t,"onChannelResolved","local.channel.resolved",(async t=>{e(t)}))};class rp extends ju{constructor(e,t){const n=Pu(e),r=["channel","collection",n],s=rp.getPaginationController(e);super(s,n,r,t),this.query=e,this.queryStreamController=new ep(this.query,this.cacheKey,this.notifyChange.bind(this),(async e=>{try{const t=ve();t.isUnreadCountEnabled&&t.getMarkerSyncConsistentMode()&&await ec(e)}catch(e){console.error("Error while preparing unread count info",e)}return Jl(e)}),s),this.paginationController=s,this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE(this.getSubscriptions())}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;let a=null!==(s=i.data.map((e=>Se(["channel","get",e]))).filter(Boolean).map((({data:e})=>e)).map(ic))&&void 0!==s?s:[];this.paginationController instanceof Jf&&(a=this.applyFilter(a)),(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:this.paginationController instanceof Jf?()=>this.loadPage({direction:"next"}):void 0,data:a,hasNextPage:this.paginationController instanceof Jf&&!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){const{userId:t}=ve();let n=e;switch(n=ke(n,"isDeleted",this.query.isDeleted),n=Ae(n,"displayName",this.query.displayName),this.query.types&&(n=n.filter((e=>{var t;return null===(t=this.query.types)||void 0===t?void 0:t.includes(e.type)}))),this.query.tags&&(n=n.filter((e=>{var t;return null===(t=e.tags)||void 0===t?void 0:t.some((e=>{var t;return null===(t=this.query.tags)||void 0===t?void 0:t.includes(e)}))}))),this.query.excludeTags&&(n=n.filter((e=>{var t;return!(null===(t=e.tags)||void 0===t?void 0:t.some((e=>{var t;return null===(t=this.query.excludeTags)||void 0===t?void 0:t.includes(e)})))}))),this.query.membership&&t&&(n=Re(n,this.query.membership,t)),this.query.sortBy){case"firstCreated":n=n.sort(Fe);break;case"lastCreated":n=n.sort(Ne);break;case"displayName":n=n.map((e=>e.displayName?e:Object.assign(Object.assign({},e),{displayName:""}))).sort(Pe);break;default:n=n.sort($e)}return n}shouldAbort(e){var t,n;const r=null===(t=Se(this.cacheKey))||void 0===t?void 0:t.data;if(!r)return!0;return!(null===(n=null==r?void 0:r.data)||void 0===n?void 0:n.find((t=>t===e)))}static getMessagePreviewSetting(){return ve().getMessagePreviewSetting(!1)}static getPaginationController(e){return e.channelIds&&e.channelIds.length>0?new Zf(e):new Jf(e)}getSubscriptions(){const e=[{fn:ch((e=>Ad((t=>{var n,r;const s=Kc();(null===(n=Se(["subChannelUnreadInfo","get",t.subChannelId]))||void 0===n?void 0:n.data)||s.resolve(t.subChannelId,"userMessageFeedMarker");const i=null===(r=Se(["channel","get",t.channelId]))||void 0===r?void 0:r.data;i?(Sf(i,{lastActivity:t.createdAt}),e(t)):s.resolve(t.channelId,"channel")}))),"channelId","channel"),action:"onUpdate"},{fn:ch((e=>_d((t=>{var n;const r=null===(n=Se(["channel","get",t.channelId]))||void 0===n?void 0:n.data;r&&(Sf(r,{lastActivity:t.createdAt}),e(t))}))),"channelId","channel"),action:"onUpdate"},{fn:Dc,action:"onDelete"},{fn:td,action:"onUpdate"},{fn:dd,action:"onMute"},{fn:e=>sd((t=>{tp(t),e(t)})),action:"onJoin"},{fn:e=>od(((t,n)=>{var r,s;const{userId:i}=ve();if("member"===this.query.membership&&i===n.userId){const e=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;Ce(this.cacheKey,Object.assign(Object.assign({},e),{data:null!==(s=null==e?void 0:e.data.filter((e=>e!==t.channelId)))&&void 0!==s?s:[]}))}return e(t)})),action:"onLeft"},{fn:fd,action:"onMemberAdded"},{fn:md,action:"onMemberRemoved"},{fn:ch(ru,"entityId","channel"),action:"onUpdate"},{fn:ch(Cf,"entityId","channel"),action:"onUpdate"},{fn:ch((e=>Ad((async t=>{var n;if("no-message-preview"===await rp.getMessagePreviewSetting())return;if(Gl(t),this.shouldAbort(t.channelId))return;const r=null===(n=Se(["channel","get",t.channelId]))||void 0===n?void 0:n.data;r&&(Sf(r,{messagePreviewId:t.messageId}),e(t))}))),"channelId","channel"),action:"onUpdate"},{fn:ch((e=>_d((async t=>{var n;if("no-message-preview"===await rp.getMessagePreviewSetting())return;if(Gl(t),this.shouldAbort(t.channelId))return;const r=null===(n=Se(["channel","get",t.channelId]))||void 0===n?void 0:n.data;r&&(Sf(r,{messagePreviewId:t.messageId}),e(t))}))),"channelId","channel"),action:"onUpdate"},{fn:ch((e=>vf((async t=>{"no-message-preview"!==await rp.getMessagePreviewSetting()&&(Hl(t),this.shouldAbort(t.channelId)||e(t))}))),"channelId","channel"),action:"onUpdate"},{fn:ch((e=>bf((async t=>{const n=await rp.getMessagePreviewSetting();"no-message-preview"!==n&&("message-preview-include-deleted"===n&&await Hl(t),this.shouldAbort(t.channelId)||("message-preview-not-include-deleted"===n&&await yf(t.channelId),e(t)))}))),"channelId","channel"),action:"onUpdate"},{fn:ch((e=>Od((async t=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;if(!r)return;r.data.find((e=>{const n=Ho(e);return(null==n?void 0:n.subChannelId)===t.subChannelId}))&&(await yf(t.channelId),e(t))}))),"channelId","channel"),action:"onUpdate"},{fn:ch((e=>wf((async t=>{var n;if("no-message-preview"===await rp.getMessagePreviewSetting())return;(null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data)&&(await Vl(t),this.shouldAbort(t.channelId)||e(t))}))),"channelId","channel"),action:"onUpdate"},{fn:ch(Rd,"channelId","channel"),action:"onUpdate"},{fn:np,action:"onResolveChannel"},{fn:e=>(e=>{const t=ve();return Xe(t,"userMessageFeedMarker/onUserMessageFeedMarkerResolved","local.userMessageFeedMarkers.resolved",(t=>{e(t)}))})((async t=>{if(t.feedMarkers){const n=t.feedMarkers.map((e=>{var t;return null===(t=Se(["channel","get",e.entityId]))||void 0===t?void 0:t.data})).filter(Boolean);e(n)}})),action:"OnResolveUnread"},{fn:ch(Qf,"channelId","channel"),action:"onUpdate"},{fn:ch(Xf,"channelId","channel"),action:"onUpdate"}];return this.paginationController instanceof Mu?[...e,{fn:e=>Jc((t=>{tp(t),e(t)})),action:"onCreate"}]:e}}class sp extends Mu{async getRequest(e,t){const{limit:n=f,includeDeleted:r}=e,s=Bo(e,["limit","includeDeleted"]),i=t?{token:t}:{limit:n},a=!1!==r&&void 0,{data:o}=await this.http.get(`/api/v4/channels/${encodeURIComponent(s.channelId)}/users`,{params:Object.assign(Object.assign({},s),{options:i,isDeleted:a})});return o}}class ip extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.channelUsers.map((({channelId:e,userId:t})=>de("channelUsers")({channelId:e,userId:t})))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.channelUsers.map((({channelId:e,userId:t})=>de("channelUsers")({channelId:e,userId:t})))])]}))}}reactor(e){return(e,t)=>{var n;if(this.query.channelId!==t.channelId)return;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;if(!r)return;const s=de("channelUsers")({channelId:this.query.channelId,userId:t.userId});"none"===t.membership?r.data=r.data.filter((e=>e!==s)):r.data.includes(s)||(r.data=[s,...r.data]),Ce(this.cacheKey,r),this.notifyChange({origin:"event",loading:!1})}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}class ap extends ju{constructor(e,t){const n=Pu(e),r=["channelUsers","collection",n];super(new sp(e),n,r,t),this.query=e,this.queryStreamController=new ip(this.query,this.cacheKey,this.notifyChange.bind(this),Jl),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:sd,action:"onJoin"},{fn:od,action:"onLeft"},{fn:fd,action:"onMemberAdded"},{fn:md,action:"onMemberRemoved"},{fn:Mc,action:"onChannelMemberBanned"},{fn:bd,action:"onChannelMemberUnbanned"},{fn:Cd,action:"onChannelMemberRoleAdded"},{fn:Id,action:"onChannelMemberRoleRemoved"},{fn:(e=this.query.channelId,t=>{const n=ve();return Xe(n,"user.deleted","user.deleted",(n=>{var r,s;const i=Fc(n);if(0===i.users.length)return;const a=i.users[0];Uo(i);const o=de("channelUsers")({channelId:e,userId:a.userId}),l=null===(r=Se(["channelUsers","get",o]))||void 0===r?void 0:r.data;Ee(["channelUsers","get",o],Object.assign(Object.assign({},l),{user:a}));const c=null===(s=Se(["channel","get",e]))||void 0===s?void 0:s.data;c&&t(c,l)}))}),action:"onChannelMemberChanged"}]);var e}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["channelUsers","get",e]))).filter(Boolean).map((({data:e})=>e)))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){let t=_e(e,"roles",this.query.roles);this.query.memberships&&(t=t.filter((e=>{var t,n;return!(!(null===(t=this.query.memberships)||void 0===t?void 0:t.includes("muted"))||!e.isMuted)||"none"!==e.membership&&(null===(n=this.query.memberships)||void 0===n?void 0:n.includes(e.membership))}))),!1===this.query.includeDeleted&&(t=t.filter((e=>{var t;return!0!==(null===(t=e.user)||void 0===t?void 0:t.isDeleted)})));const n=this.query.sortBy?this.query.sortBy:"lastCreated";return t=t.sort("lastCreated"===n?Ne:Fe),t}}const op=(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getMembers(tmpid: ${i}) > listen`);const a=new ap(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>{Ie(l)})),()=>{r(`getMembers(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}};var lp=Object.freeze({__proto__:null,addMembers:async(e,t)=>{const n=ve();n.log("channel/addMembers",e,t);const{data:r}=await n.http.post(`/api/v3/channels/${encodeURIComponent(e)}/users`,{channelId:e,userIds:t});t.forEach((e=>Je("channel.membersAdded",Object.assign(Object.assign({},r),{channelUsers:r.channelUsers.filter((t=>t.userId===e))}))));const s=await Jl(r);n.cache&&Uo(s);const{channelUsers:i}=s;return!!i.find((t=>t.channelId===e&&"member"===t.membership))},removeMembers:async(e,t)=>{const n=ve();n.log("channel/removeMembers",e,t);const{data:r}=await n.http.delete(`/api/v3/channels/${encodeURIComponent(e)}/users`,{data:{channelId:e,userIds:t}});t.forEach((e=>Je("channel.membersRemoved",Object.assign(Object.assign({},r),{channelUsers:r.channelUsers.filter((t=>t.userId===e))}))));const s=await Jl(r);n.cache&&Uo(s);const{channelUsers:i}=s;return!!i.find((t=>t.channelId===e&&"member"!==t.membership))},applyFilter:(e,t)=>{let n=_e(e,"roles",t.roles);t.memberships&&(n=n.filter((e=>!(!t.memberships.includes("muted")||!e.isMuted)||t.memberships.includes(e.membership))));const r=t.sortBy?t.sortBy:"lastCreated";return n=n.sort("lastCreated"===r?Ne:Fe),n},getMembers:op,searchMembers:(e,t,n)=>op(e,t)});var cp=Object.freeze({__proto__:null,addRole:async(e,t,n)=>{const r=ve();r.log("channel/addRole",e,t,n);const{data:s}=await r.http.post(`/api/v3/channels/${encodeURIComponent(e)}/users/roles`,{channelId:e,role:t,userIds:n}),i=await Jl(s);r.cache&&Uo(i),Je("local.channel-moderator.role-added",i);const{channelUsers:a}=i;return!!a.find((n=>n.channelId===e&&n.roles.includes(t)))},removeRole:async(e,t,n)=>{const r=ve();r.log("channel/removeRole",e,t,n);const{data:s}=await r.http.delete(`/api/v3/channels/${encodeURIComponent(e)}/users/roles`,{data:{channelId:e,role:t,userIds:n}}),i=await Jl(s);r.cache&&Uo(i),Je("local.channel-moderator.role-removed",i);const{channelUsers:a}=i;return!!a.find((n=>n.channelId===e&&!n.roles.includes(t)))},banMembers:async(e,t)=>{const n=ve();n.log("channel/banMembers",{userIds:t,channelId:e});const{data:r}=await n.http.put(`/api/v3/channels/${e}/users/ban`,{userIds:t}),s=await Jl(r),{channelUsers:i}=s,a=n.cache&&Date.now();return n.cache&&Uo(s,{cachedAt:a}),{data:null==i?void 0:i.filter((e=>"banned"===e.membership)),cachedAt:a}},unbanMembers:async(e,t)=>{const n=ve();n.log("channel/unbanMembers",{userIds:t,channelId:e});const{data:r}=await n.http.put(`/api/v3/channels/${encodeURIComponent(e)}/users/unban`,{userIds:t}),s=await Jl(r),i=n.cache&&Date.now();n.cache&&Uo(s,{cachedAt:i});const{channelUsers:a}=s;return{data:null==a?void 0:a.filter((e=>"member"===e.membership)),cachedAt:i}},muteMembers:async(e,t,n=-1)=>{const r=ve();r.log("channel/muteMembers",{userIds:t,channelId:e,mutePeriod:n});const{data:s}=await r.http.put(`/api/v2/channel/${e}/users/mute`,{userIds:t,mutePeriod:-1===n?n:1e3*n}),{success:i}=s;return i},unmuteMembers:async(e,t)=>{const n=ve();n.log("channel/unmuteMembers",{userIds:t,channelId:e});const{data:r}=await n.http.put(`/api/v2/channel/${encodeURIComponent(e)}/users/mute`,{userIds:t,mutePeriod:0}),{success:s}=r;return s}}),dp=Object.freeze({__proto__:null,Membership:lp,Moderation:cp,getChannelByIds:ac,createChannel:async e=>{const t=ve();let n;if(t.log("user/createChannel",e),"conversation"===(null==e?void 0:e.type))n=await t.http.post("/api/v3/channels/conversation",Object.assign(Object.assign({},e),{isDistinct:!0}));else{const{isPublic:r}=e,s=Bo(e,["isPublic"]);n=await t.http.post("/api/v3/channels",Object.assign(Object.assign({},s),{isPublic:"community"===(null==e?void 0:e.type)?r:void 0}))}const r=await Jl(n.data),s=t.cache&&Date.now();t.cache&&Uo(r,{cachedAt:s});const{channels:i}=r;return{data:sc(i[0]),cachedAt:s}},updateChannel:async(e,t)=>{const n=ve();n.log("channel/updateChannel",e,t);const{data:r}=await n.http.put(`/api/v3/channels/${encodeURIComponent(e)}`,t),s=await Jl(r),i=n.cache&&Date.now();n.cache&&Uo(s,{cachedAt:i});const{channels:a}=s;return{data:sc(a.find((t=>t.channelId===e))),cachedAt:i}},deleteChannel:async e=>{const t=ve();t.log("channel/deleteChannel",e),await t.http.delete(`/api/v3/channels/${encodeURIComponent(e)}`);const n=await yf(e);return sc(n.data)},joinChannel:async e=>{const t=ve();t.log("channel/joinChannel",e);const{data:n}=await t.http.post(`/api/v3/channels/${encodeURIComponent(e)}/join`),r=await Jl(n);t.cache&&Uo(r);const{channelUsers:s}=r;return!!s.find((t=>t.channelId===e&&"member"===t.membership))},leaveChannel:async e=>{const t=ve();t.log("channel/leaveChannel",e);const{data:n}=await t.http.delete(`/api/v3/channels/${encodeURIComponent(e)}/leave`),r=await Jl(n);t.cache&&Uo(r);const{channelUsers:s}=r;return!!s.find((t=>t.channelId===e&&"member"!==t.membership))},muteChannel:async(e,t=-1)=>{const n=ve();if(n.log("channel/muteChannel",e),-1!==t&&t<0)throw new fe("Mute Period can only be positive numbers or -1(mute forever)",800110,"error");const{data:r}=await n.http.put(`/api/v2/channel/${encodeURIComponent(e)}/mute`,{mutePeriod:t}),{success:s}=r;return s},unmuteChannel:async e=>{const t=ve();t.log("channel/unmuteChannel",e);const{data:n}=await t.http.put(`/api/v2/channel/${encodeURIComponent(e)}/mute`,{mutePeriod:0}),{success:r}=n;return r},onChannelCreated:Jc,onChannelUpdated:td,onChannelDeleted:Dc,onChannelJoined:sd,onChannelLeft:od,onChannelMuted:dd,onChannelMemberAdded:fd,onChannelMemberRemoved:md,onChannelMemberBanned:Mc,onChannelMemberUnbanned:bd,onChannelMemberRoleAdded:Cd,onChannelMemberRoleRemoved:Id,getChannel:(e,t)=>{const n=ve();let r;return zu(e,(async e=>{if(!e.data)return t(e);const n=Object.assign(Object.assign({},e),{data:ic(e.data)}),s=Bo(n,["origin"]);return rl(r,s)?void 0:(r=s,t(n))}),"channelId",yf,[td,Dc,sd,od,fd,md,Mc,bd,dd,ch(ru,"entityId","channel"),ch(Cf,"entityId","channel"),ch((t=>Ad((async r=>{await(async r=>{var s;if("no-message-preview"===await n.getMessagePreviewSetting(!1))return;if(await Gl(r),r.channelId!==e)return;const i=null===(s=Se(["channel","get",e]))||void 0===s?void 0:s.data;i&&(Sf(i,{messagePreviewId:r.messageId}),t(r))})(r),t(r)}))),"channelId","channel"),ch((t=>_d((async r=>{var s;if("no-message-preview"===await n.getMessagePreviewSetting(!1))return;if(await Gl(r),r.channelId!==e)return;const i=null===(s=Se(["channel","get",e]))||void 0===s?void 0:s.data;i&&(Sf(i,{messagePreviewId:r.messageId}),t(r))}))),"channelId","channel"),ch((t=>vf((async r=>{var s;const i=null===(s=Se(["channel","get",e]))||void 0===s?void 0:s.data;if(!i||i.messagePreviewId!==r.messageId)return;"no-message-preview"!==await n.getMessagePreviewSetting(!1)&&(await Hl(r),t(r))}))),"channelId","channel"),ch((t=>bf((async r=>{var s;const i=null===(s=Se(["channel","get",e]))||void 0===s?void 0:s.data;if(!i||i.messagePreviewId!==r.messageId)return;const a=await n.getMessagePreviewSetting(!1);"no-message-preview"!==a&&("message-preview-not-include-deleted"===a?(Ie(["messagePreviewChannel","get",e]),await yf(r.channelId)):await Hl(r),t(r))}))),"channelId","channel"),ch((e=>Od((async t=>{var r,s;const{channelId:i,subChannelId:a}=t,o=null===(r=Se(["messagePreviewChannel","get",i]))||void 0===r?void 0:r.data;if(!o||o.subChannelId!==a)return;if("no-message-preview"===await n.getMessagePreviewSetting(!1))return;await yf(i);(null===(s=Se(["channel","get",i]))||void 0===s?void 0:s.data)&&e(t)}))),"channelId","channel"),ch((t=>wf((async r=>{var s,i;if("no-message-preview"===await n.getMessagePreviewSetting(!1))return;Vl(r);const a=null===(s=Se(["messagePreviewChannel","get",e]))||void 0===s?void 0:s.data;if(!a||a.subChannelId!==r.subChannelId)return;(null===(i=Se(["channel","get",e]))||void 0===i?void 0:i.data)&&t(r)}))),"channelId","channel"),ch(Rd,"channelId","channel"),ch(Qf,"channelId","channel"),ch(Xf,"channelId","channel")],{forceDispatch:!0})},getChannels:(e,t,n)=>{const{log:r,cache:s,userId:i}=ve();s||console.log(g);const a=Date.now();r(`getChannels(tmpid: ${a}) > listen`);const o=new rp(e,t),l=o.startSubscription(),c=o.getCacheKey();return l.push((()=>{Ie(c)})),()=>{r(`getChannels(tmpid: ${a}) > dispose`),l.forEach((e=>e()))}},getTotalChannelsUnread:e=>{const{_id:t}=Ke();if(!t)throw new fe("The _id has not been defined in ActiveUser",8e5,"error");const{log:n,cache:r}=ve();r||console.log("For using Live Object feature you need to enable Cache!");n(`liveTotalChannelsUnread(tmpid: ${Date.now()}) > listen`);const s=[];let i,a=!1;const o=t=>{const{data:n}=t,r=n?{unreadCount:n.unreadCount,isMentioned:n.isMentioned}:void 0;i=r?du(r):r,e({data:r?Object.assign(Object.assign({},r),{isMentioned:r.isMentioned}):r,loading:t.loading,error:t.error})};return s.push(Xf((e=>{rl(i,e)||o({loading:!1,data:e})}))),(()=>{const e=ie((async()=>(()=>{var e;const t=ve();t.log("channel/getTotalChannelsUnread.locally");const n=(null===(e=we(["channelUnread","get"]))||void 0===e?void 0:e.filter((({data:e})=>!e.isDeleted)))||[];return{data:(null==n?void 0:n.reduce(((e,{data:t})=>(e.unreadCount+=t.unreadCount,e.isMentioned=e.isMentioned||t.isMentioned,e)),{unreadCount:0,isMentioned:!1}))||{unreadCount:0,isMentioned:!1},cachedAt:t.cache&&Date.now()}})()));oe(e,(({error:e,data:t,loading:n,origin:r,cachedAt:i})=>{i===y?(o({data:t,origin:r,loading:!1,error:new pe(m,800800,"error")}),a=!0,s.forEach((e=>e()))):a||o({loading:n,data:t,origin:r,error:e}),e&&s.forEach((e=>e()))}))})(),()=>{s.forEach((e=>e()))}},MARKER_INCLUDED_CHANNEL_TYPE:Wl,isUnreadCountSupport:Yl,convertFromRaw:Ql,preUpdateChannelCache:Xl,prepareChannelPayload:Jl});const up=(e,t)=>{0!==e.length&&0!==t.length&&e.forEach((({communityId:e})=>{const n=t.filter((({communityId:t})=>e===t));Ce(["communityUsers","collection",e],n)}))},hp=async e=>{const t=ve();t.log("community/getCommunities",e);const{data:n}=await t.http.get("/api/v3/communities/list",{params:{communityIds:e}}),r=Uh(n),s=t.cache&&Date.now();return t.cache&&(Uo(r,{cachedAt:s}),up(r.communities,r.communityUsers)),{data:r.communities,cachedAt:s}};hp.locally=e=>{var t;const n=ve();if(n.log("community/getCommunities.locally",e),!n.cache)return;const r=e.map((e=>Se(["community","get",e]))).filter(Boolean),s=r.map((({data:e})=>e)),i=null===(t=r.sort(((e,t)=>e.cachedAt<t.cachedAt?-1:1)))||void 0===t?void 0:t[0];return(null==r?void 0:r.length)<e.length?void 0:{data:s,cachedAt:i.cachedAt}};const fp=async e=>{const t=ve();t.log("community/getCommunity",e);const{data:n}=await t.http.get(`/api/v3/communities/${e}`),r=Uh(n),s=t.cache&&Date.now();t.cache&&(Uo(r,{cachedAt:s}),up(r.communities,r.communityUsers));const{communities:i}=r;return{data:i.find((t=>t.communityId===e)),cachedAt:s}};fp.locally=e=>{const t=ve();if(t.log("community/getCommunity.locally",e),!t.cache)return;const n=Se(["community","get",e]);return n?{data:n.data,cachedAt:n.cachedAt}:void 0};const pp=(e,t)=>{const n=ve();return Xe(n,e,e,(e=>{const r=Uh(e);if(n.cache){Uo(r);const e=Se(["community","get",r.communities[0].communityId]);t(e.data)}else t(r.communities[0])}))},gp=e=>pp("community.created",e),mp=e=>pp("community.updated",e),yp=e=>pp("community.deleted",e);class vp extends Mu{async getRequest(e,t){const{limit:n=f}=e,r=Bo(e,["limit"]),s=t?{token:t}:{limit:n},{data:i}=await this.http.get("/api/v3/communities",{params:Object.assign(Object.assign({},r),{isDeleted:kl(r.includeDeleted),keyword:r.displayName,filter:r.membership,options:s})});return i}}class bp extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.communities.map(de("community"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.communities.map(de("community"))])]}))}}reactor(e){return e=>{var t;const n=null===(t=Se(this.cacheKey))||void 0===t?void 0:t.data;n&&(Ce(this.cacheKey,n),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}var wp,Sp;!function(e){e.OnCommunityCreated="onCommunityCreated",e.OnCommunityDeleted="onCommunityDeleted",e.OnCommunityUpdated="onCommunityUpdated"}(wp||(wp={})),function(e){e.OnCommunityJoined="onCommunityJoined",e.OnCommunityLeft="onCommunityLeft",e.OnCommunityUserBanned="onCommunityUserBanned",e.OnCommunityUserChanged="onCommunityUserChanged",e.OnCommunityUserRoleAdded="onCommunityUserRoleAdded",e.OnCommunityUserRoleRemoved="onCommunityUserRoleRemoved",e.OnCommunityUserUnbanned="onCommunityUserUnbanned",e.OnMemberCountChanged="OnMemberCountChanged",e.OnCommunityUserAdded="OnCommunityUserAdded",e.onCommunityUserRemoved="onCommunityUserRemoved",e.OnUserDeleted="OnUserDeleted"}(Sp||(Sp={}));class Cp extends Mu{async getRequest(e,t){const{limit:n=f,includeDeleted:r}=e,s=Bo(e,["limit","includeDeleted"]),i=t?{token:t}:{limit:n},a=!1!==r&&void 0,{data:o}=await this.http.get(`/api/v3/communities/${s.communityId}/users`,{params:Object.assign(Object.assign({},s),{options:i,isDeleted:a})});return o}}class Tp extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.communityUsers.map((({communityId:e,userId:t})=>de("communityUsers")({communityId:e,userId:t})))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.communityUsers.map((({communityId:e,userId:t})=>de("communityUsers")({communityId:e,userId:t})))])]}))}}reactor(e){return(e,t)=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;r&&(t.forEach((e=>{const t=de("communityUsers")({communityId:this.query.communityId,userId:e.userId});"none"===e.communityMembership?r.data=r.data.filter((e=>e!==t)):r.data.includes(t)||(r.data=[t,...r.data])})),Ce(this.cacheKey,r),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}function Ep(e,t,n){return!!e.permissions.some((e=>e===n))||t.communityUsers.find((t=>t.userId===e.userId)).permissions.some((e=>e===n))}function Ip(e,t){return"community.joined"===e||"community.left"===e?t.communityUsers:"community.userRemoved"===e||"local.community.userRemoved"===e?t.communityUsers.filter((e=>"none"===e.communityMembership)):"community.userBanned"===e?t.communityUsers.filter((e=>"banned"===e.communityMembership)):"community.userUnbanned"===e?t.communityUsers.filter((e=>!Ep(e,t,"BAN_COMMUNITY_USER"))):t.communityUsers.filter((e=>!Ep(e,t,"ADD_COMMUNITY_USER")))}const kp=(e,t)=>{const n=ve();return Xe(n,e,e,(r=>{const s=Uh(r),{communities:i,communityUsers:a}=s,o=Ah(i,a);if(s.communities=o,n.cache){Uo(s,void 0,!1);const n=Se(["community","get",s.communities[0].communityId]),r=Ip(e,s).map((e=>{const t=Se(["communityUsers","get",de("communityUsers")(e)]);return null==t?void 0:t.data})).filter(sl);t(n.data,r)}else t(s.communities[0],Ip(e,s))}))},Ap=(e,t)=>{const n=ve();return Xe(n,e,e,(r=>{const s=Uh(r),{communities:i,communityUsers:a}=s,o=Ah(i,a);if(s.communities=o,n.cache){Uo(s,void 0,!1);const n=Se(["community","get",s.communities[0].communityId]),r=Ip(e,s).map((e=>{const t=Se(["communityUsers","get",de("communityUsers")(e)]);return null==t?void 0:t.data})).filter(sl);t(n.data,r)}else t(s.communities[0],Ip(e,s))}))},_p=e=>kp("community.userBanned",e),Rp=e=>kp("community.userChanged",e),Op=e=>kp("community.userUnbanned",e),Lp=e=>kp("community.roleAdded",e),Dp=e=>kp("community.roleRemoved",e),xp=e=>Ap("local.community.userAdded",e),Pp=e=>Ap("local.community.userRemoved",e),Mp=e=>kp("community.joined",e),Fp=e=>kp("community.left",e),Up=e=>Ap("local.community.joined",e),Np=e=>Ap("local.community.left",e),Bp=e=>{const t=ve();return Xe(t,"onLocalCommunityRoleRemoved","local.community.roleRemoved",(async t=>{const{communities:n,communityUsers:r}=t;e(n[0],r.filter((e=>"member"===e.communityMembership)))}))},jp=e=>{const t=ve();return Xe(t,"onLocalCommunityRoleAdded","local.community.roleAdded",(async t=>{const{communities:n,communityUsers:r}=t;e(n[0],r.filter((e=>"member"===e.communityMembership)))}))},$p=e=>t=>{const n=ve();return Xe(n,"user.deleted","user.deleted",(n=>{var r,s;const i=Fc(n);if(0===i.users.length)return;const a=i.users[0];Uo(i);const o=de("communityUsers")({communityId:e,userId:a.userId}),l=null===(r=Se(["communityUsers","get",o]))||void 0===r?void 0:r.data;Ce(["communityUsers","get",o],Object.assign(Object.assign({},l),{user:a}));const c=null===(s=Se(["community","get",e]))||void 0===s?void 0:s.data;t(c,[Object.assign(Object.assign({},l),{user:a})])}))};class qp extends ju{constructor(e,t){const n=Pu(e),r=["communityUsers","collection",n];super(new Cp(e),n,r,t),this.query=e,this.queryStreamController=new Tp(this.query,this.cacheKey,this.notifyChange.bind(this),Uh),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:Mp,action:Sp.OnCommunityJoined},{fn:Up,action:Sp.OnCommunityJoined},{fn:Fp,action:Sp.OnCommunityLeft},{fn:Np,action:Sp.OnCommunityLeft},{fn:_p,action:Sp.OnCommunityUserBanned},{fn:Rp,action:Sp.OnCommunityUserChanged},{fn:Lp,action:Sp.OnCommunityUserRoleAdded},{fn:Dp,action:Sp.OnCommunityUserRoleRemoved},{fn:jp,action:Sp.OnCommunityUserRoleAdded},{fn:Bp,action:Sp.OnCommunityUserRoleRemoved},{fn:Op,action:Sp.OnCommunityUserUnbanned},{fn:xp,action:Sp.OnCommunityUserAdded},{fn:Pp,action:Sp.onCommunityUserRemoved},{fn:$p(this.query.communityId),action:Sp.OnCommunityUserChanged}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["communityUsers","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){let t=_e(e,"roles",this.query.roles);if(this.query.memberships&&(t=t.filter((({communityMembership:e})=>(this.query.memberships||[]).includes(e)))),!1===this.query.includeDeleted&&(t=t.filter((({user:e})=>!0!==(null==e?void 0:e.isDeleted)))),"firstCreated"===this.query.sortBy)t=t.sort(Fe);else t=t.sort(Ne);return t}}class Kp extends Mu{async getRequest(e,t){const{limit:n=f,includeDeleted:r}=e,s=Bo(e,["limit","includeDeleted"]),i=t?{token:t}:{limit:n},a=!1!==r&&void 0,{data:o}=await this.http.get(`/api/v3/communities/${s.communityId}/users`,{params:Object.assign(Object.assign({},s),{options:i,isDeleted:a})});return o}}class Gp extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.communityUsers.map((({communityId:e,userId:t})=>de("communityUsers")({communityId:e,userId:t})))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.communityUsers.map((({communityId:e,userId:t})=>de("communityUsers")({communityId:e,userId:t})))])]}))}}reactor(e){return(e,t)=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;r&&(t.forEach((e=>{const t=de("communityUsers")({communityId:this.query.communityId,userId:e.userId});"none"===e.communityMembership&&(r.data=r.data.filter((e=>e!==t)))})),Ce(this.cacheKey,r),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}var Hp;!function(e){e.OnCommunityJoined="onCommunityJoined",e.OnCommunityLeft="onCommunityLeft",e.OnCommunityUserBanned="onCommunityUserBanned",e.OnCommunityUserChanged="onCommunityUserChanged",e.OnCommunityUserRoleAdded="onCommunityUserRoleAdded",e.OnCommunityUserRoleRemoved="onCommunityUserRoleRemoved",e.OnCommunityUserUnbanned="onCommunityUserUnbanned"}(Hp||(Hp={}));class Vp extends ju{constructor(e,t){const n=Pu(e),r=["communityUsers","collection",n];super(new Kp(e),n,r,t),this.query=e,this.queryStreamController=new Gp(this.query,this.cacheKey,this.notifyChange.bind(this),Uh),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:Mp,action:Hp.OnCommunityJoined},{fn:Up,action:Hp.OnCommunityJoined},{fn:Fp,action:Hp.OnCommunityLeft},{fn:Np,action:Hp.OnCommunityLeft},{fn:_p,action:Hp.OnCommunityUserBanned},{fn:Rp,action:Hp.OnCommunityUserChanged},{fn:Bp,action:Hp.OnCommunityUserRoleRemoved},{fn:Dp,action:Hp.OnCommunityUserRoleRemoved},{fn:Op,action:Hp.OnCommunityUserUnbanned},{fn:$p(this.query.communityId),action:Hp.OnCommunityUserChanged}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["communityUsers","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){let t=_e(e,"roles",this.query.roles);return this.query.memberships&&(t=t.filter((({communityMembership:e})=>(this.query.memberships||[]).includes(e)))),this.query.search&&(t=xe(t,this.query.search)),!1===this.query.includeDeleted&&(t=t.filter((({user:e})=>!0!==(null==e?void 0:e.isDeleted)))),t}}var zp=Object.freeze({__proto__:null,addMembers:async(e,t)=>{const n=ve();n.log("community/moderation/addMembers",e,t);const{data:r}=await n.http.post(`/api/v3/communities/${e}/users`,{communityId:e,userIds:t});Je("local.community.userAdded",r);const s=$o(r,"communityUsers");n.cache&&Uo(s);const{communityUsers:i}=s;return!!i.find((t=>t.communityId===e&&"member"===t.communityMembership))},removeMembers:async(e,t)=>{const n=ve();n.log("community/moderation/removeMembers",e,t);const{data:r}=await n.http.delete(`/api/v3/communities/${e}/users`,{data:{communityId:e,userIds:t}});Je("local.community.userRemoved",r);const s=$o(r,"communityUsers");n.cache&&Uo(s);const{communityUsers:i}=s;return!!i.find((t=>t.communityId===e&&"member"!==t.communityMembership))},applyFilter:(e,t)=>{let n=_e(e,"roles",t.roles);t.memberships&&(n=n.filter((({communityMembership:e})=>t.memberships.includes(e))));const r=t.sortBy?t.sortBy:"lastCreated";return n=n.sort("lastCreated"===r?Ne:Fe),n},getMembers:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getMembers(tmpid: ${i}) > listen`);const a=new qp(e,(e=>{t(e)})),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>{Ie(l)})),()=>{r(`getMembers(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},searchMembers:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getMembers(tmpid: ${i}) > listen`);const a=new Vp(e,(e=>{t(e)})),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>{Ie(l)})),()=>{r(`getMembers(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},onCommunityUserAdded:e=>kp("community.userAdded",e),onCommunityUserRemoved:e=>kp("community.userRemoved",e),onCommunityUserBanned:_p,onCommunityUserChanged:Rp,onCommunityUserUnbanned:Op,onCommunityUserRoleAdded:Lp,onCommunityUserRoleRemoved:Dp,onLocalCommunityUserAdded:xp,onLocalCommunityUserRemoved:Pp,onCommunityJoined:Mp,onCommunityLeft:Fp,onLocalCommunityJoined:Up,onLocalCommunityLeft:Np});class Wp extends ju{constructor(e,t){const n=Pu(e),r=["community","collection",n];super(new vp(e),n,r,t),this.query=e,this.queryStreamController=new bp(this.query,this.cacheKey,this.notifyChange.bind(this),Uh),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:yp,action:wp.OnCommunityDeleted},{fn:mp,action:wp.OnCommunityUpdated},{fn:Mp,action:Sp.OnCommunityJoined},{fn:Fp,action:Sp.OnCommunityLeft},{fn:Rp,action:Sp.OnMemberCountChanged},{fn:Up,action:Sp.OnCommunityJoined},{fn:Np,action:Sp.OnCommunityLeft}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["community","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){const{userId:t}=ve();let n=e;return this.query.includeDeleted||(n=ke(n,"isDeleted",!1)),this.query.categoryId&&(n=n.filter((e=>{var t;return null===(t=e.categoryIds)||void 0===t?void 0:t.includes(this.query.categoryId)}))),this.query.tags&&(n=n.filter((e=>{var t;return null===(t=e.tags)||void 0===t?void 0:t.some((e=>{var t;return null===(t=this.query.tags)||void 0===t?void 0:t.includes(e)}))}))),this.query.membership&&t&&(n=Le(n,this.query.membership,t)),n}}class Yp extends Mu{async getRequest(e,t){const{limit:n=f}=e,r=Bo(e,["limit"]),s=t?{token:t}:{limit:n},{data:i}=await this.http.get("/api/v3/communities",{params:Object.assign(Object.assign({},r),{isDeleted:kl(r.includeDeleted),filter:r.membership,options:s})});return i}}class Qp extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&(Uo(t,{cachedAt:r}),up(e.communities,e.communityUsers))}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.communities.map(de("community"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.communities.map(de("community"))])]}))}}reactor(e){return e=>{var t;const n=null===(t=Se(this.cacheKey))||void 0===t?void 0:t.data;n&&(n.data=[...new Set([e.communityId,...n.data])],Ce(this.cacheKey,n),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}var Xp;!function(e){e.OnCommunityCreated="onCommunityCreated",e.OnCommunityDeleted="onCommunityDeleted",e.OnCommunityUpdated="onCommunityUpdated"}(Xp||(Xp={}));class Jp extends ju{constructor(e,t){const n=Pu(e),r=["community","collection",n];super(new Yp(e),n,r,t),this.query=e,this.queryStreamController=new Qp(this.query,this.cacheKey,this.notifyChange.bind(this),Uh),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:gp,action:Xp.OnCommunityCreated},{fn:yp,action:Xp.OnCommunityDeleted},{fn:mp,action:Xp.OnCommunityUpdated},{fn:Mp,action:Sp.OnCommunityJoined},{fn:Fp,action:Sp.OnCommunityLeft},{fn:Rp,action:Sp.OnMemberCountChanged},{fn:Up,action:Sp.OnCommunityJoined},{fn:Np,action:Sp.OnCommunityLeft}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["community","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){const{userId:t}=ve();let n=e;this.query.includeDeleted||(n=ke(n,"isDeleted",!1)),this.query.categoryId&&(n=n.filter((e=>{var t;return null===(t=e.categoryIds)||void 0===t?void 0:t.includes(this.query.categoryId)}))),this.query.tags&&(n=n.filter((e=>{var t;return null===(t=e.tags)||void 0===t?void 0:t.some((e=>{var t;return null===(t=this.query.tags)||void 0===t?void 0:t.includes(e)}))}))),this.query.membership&&t&&(n=Le(n,this.query.membership,t));const r=(()=>"firstCreated"===this.query.sortBy?Fe:Ne)();return n=n.sort(r),n}}class Zp extends Mu{async getRequest(e,t){const{limit:n=f}=e,r=Bo(e,["limit"]),s=t?{token:t}:{limit:n},{data:i}=await this.http.get("/api/v3/communities/top-trending",{params:Object.assign(Object.assign({},r),{options:s})});return i}}class eg extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&(Uo(t,{cachedAt:r}),up(e.communities,e.communityUsers))}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.communities.map(de("community"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.communities.map(de("community"))])]}))}}reactor(e){return e=>{var t;const n=null===(t=Se(this.cacheKey))||void 0===t?void 0:t.data;n&&(Ce(this.cacheKey,n),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}var tg;!function(e){e.OnCommunityDeleted="onCommunityDeleted",e.OnCommunityUpdated="onCommunityUpdated"}(tg||(tg={}));class ng extends ju{constructor(e,t){const n=Pu(e),r=["trendingCommunity","collection",n];super(new Zp(e),n,r,t),this.query=e,this.queryStreamController=new eg(this.query,this.cacheKey,this.notifyChange.bind(this),Uh),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:yp,action:tg.OnCommunityDeleted},{fn:mp,action:tg.OnCommunityUpdated},{fn:Mp,action:Sp.OnCommunityJoined},{fn:Fp,action:Sp.OnCommunityLeft},{fn:Rp,action:Sp.OnMemberCountChanged},{fn:Up,action:Sp.OnCommunityJoined},{fn:Np,action:Sp.OnCommunityLeft}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=null!==(s=i.data.map((e=>Se(["community","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[];(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}}class rg extends Mu{async getRequest(e,t){const{limit:n=f}=e,r=Bo(e,["limit"]),s=t?{token:t}:{limit:n},{data:i}=await this.http.get("/api/v3/communities/recommended",{params:Object.assign(Object.assign({},r),{options:s})});return i}}class sg extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&(Uo(t,{cachedAt:r}),up(e.communities,e.communityUsers))}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.communities.map(de("community"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.communities.map(de("community"))])]}))}}reactor(e){return e=>{var t;const n=null===(t=Se(this.cacheKey))||void 0===t?void 0:t.data;n&&(Ce(this.cacheKey,n),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}var ig;!function(e){e.OnCommunityDeleted="onCommunityDeleted",e.OnCommunityUpdated="onCommunityUpdated"}(ig||(ig={}));class ag extends ju{constructor(e,t){const n=Pu(e),r=["community","collection",n];super(new rg(e),n,r,t),this.query=e,this.queryStreamController=new sg(this.query,this.cacheKey,this.notifyChange.bind(this),Uh),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:yp,action:ig.OnCommunityDeleted},{fn:mp,action:ig.OnCommunityUpdated},{fn:Mp,action:Sp.OnCommunityJoined},{fn:Fp,action:Sp.OnCommunityLeft},{fn:Rp,action:Sp.OnMemberCountChanged},{fn:Up,action:Sp.OnCommunityJoined},{fn:Np,action:Sp.OnCommunityLeft}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=null!==(s=i.data.map((e=>Se(["community","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[];(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}}class og extends Mu{async getRequest(e,t){const{limit:n=f,communityMembershipStatus:r}=e,s=Bo(e,["limit","communityMembershipStatus"]),i={type:e.limit?"pagination":void 0},a=t?Object.assign(Object.assign({},i),{token:t}):Object.assign(Object.assign({},i),{limit:n}),{data:o}=await this.http.get("/api/v1/semantic-search/communities",{params:Object.assign(Object.assign({},s),{filter:null!=r?r:"all",options:a})});return o}}function lg(e){return e.communities.map((t=>{const n=e.searchResult.find((e=>e.communityId===t.communityId));return`${t.communityId}:${n}`}))}class cg extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:lg(e)});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...lg(e)])]}))}}reactor(e){return e=>{var t;const n=null===(t=Se(this.cacheKey))||void 0===t?void 0:t.data;n&&(n.data=[...new Set([e.communityId,...n.data])],Ce(this.cacheKey,n),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}var dg;!function(e){e.OnCommunityCreated="onCommunityCreated",e.OnCommunityDeleted="onCommunityDeleted",e.OnCommunityUpdated="onCommunityUpdated"}(dg||(dg={}));class ug extends ju{constructor(e,t){const n=Pu(e),r=["community","collection",n];super(new og(e),n,r,t),this.query=e,this.queryStreamController=new cg(this.query,this.cacheKey,this.notifyChange.bind(this),jh),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:gp,action:dg.OnCommunityCreated},{fn:yp,action:dg.OnCommunityDeleted},{fn:mp,action:dg.OnCommunityUpdated},{fn:Mp,action:Sp.OnCommunityJoined},{fn:Fp,action:Sp.OnCommunityLeft},{fn:Rp,action:Sp.OnMemberCountChanged},{fn:Up,action:Sp.OnCommunityJoined},{fn:Np,action:Sp.OnCommunityLeft}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>{const[t,n]=e.split(":");return{communityId:t,score:parseFloat(n)}})).sort(((e,t)=>t.score-e.score)).map((({communityId:e})=>Se(["community","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){const{userId:t}=ve();let n=e;return this.query.categoryIds&&(n=n.filter((e=>{var t;return null===(t=e.categoryIds)||void 0===t?void 0:t.some((e=>!this.query.categoryIds||(0===this.query.categoryIds.length||this.query.categoryIds.includes(e))))}))),this.query.tags&&(n=n.filter((e=>{var t;return null===(t=e.tags)||void 0===t?void 0:t.some((e=>{var t;return null===(t=this.query.tags)||void 0===t?void 0:t.includes(e)}))}))),this.query.communityMembershipStatus&&t&&(n=Le(n,this.query.communityMembershipStatus,t)),n}}var hg;!function(e){e.ALL="all",e.MEMBER="member",e.NOT_MEMBER="notMember"}(hg||(hg={}));var fg=Object.freeze({__proto__:null,addRoles:async(e,t,n)=>{const r=ve();r.log("community/moderation/addRoles",e,t,n);const{data:s}=await r.http.post(`/api/v4/communities/${e}/users/roles`,{communityId:e,roles:t,userIds:n}),i=Nh(s);r.cache&&Uo(i),Je("local.community.roleAdded",i);const{communityUsers:a}=i;return!!a.find((n=>n.communityId===e&&t.some((e=>n.roles.includes(e)))))},removeRoles:async(e,t,n)=>{const r=ve();r.log("community/moderation/removeRoles",e,t,n);const{data:s}=await r.http.delete(`/api/v4/communities/${e}/users/roles`,{data:{communityId:e,roles:t,userIds:n}}),i=Nh(s);r.cache&&Uo(i),Je("local.community.roleRemoved",i);const{communityUsers:a}=i;return!!a.find((n=>n.communityId===e&&!t.some((e=>n.roles.includes(e)))))},banMembers:async(e,t)=>{const n=ve();n.log("community/banMembers",{userIds:t,communityId:e});const{data:r}=await n.http.put(`/api/v3/communities/${e}/users/ban`,{userIds:t}),s=$o(r,"communityUsers"),i=n.cache&&Date.now();n.cache&&Uo(s,{cachedAt:i});const{communityUsers:a}=s;return{data:a.filter((e=>t.includes(e.userId))),cachedAt:i}},unbanMembers:async(e,t)=>{const n=ve();n.log("community/unbanMembers",{userIds:t,communityId:e});const{data:r}=await n.http.put(`/api/v3/communities/${e}/users/unban`,{userIds:t}),s=$o(r,"communityUsers"),i=n.cache&&Date.now();n.cache&&Uo(s,{cachedAt:i});const{communityUsers:a}=s;return{data:a.filter((e=>t.includes(e.userId))),cachedAt:i}}}),pg=Object.freeze({__proto__:null,Moderation:fg,Membership:zp,getCommunityByIds:hp,createCommunity:async e=>{const t=ve();t.log("user/createCommunity",e);const{data:n}=await t.http.post("/api/v3/communities/",Bh(e));Je("community.created",n);const r=Uh(n),s=t.cache&&Date.now();t.cache&&(Uo(r,{cachedAt:s}),up(r.communities,r.communityUsers));const{communities:i}=r;return{data:i[0],cachedAt:s}},updateCommunity:async(e,t)=>{const n=ve();n.log("community/updateCommunity",e,t);const{data:r}=await n.http.put(`/api/v3/communities/${e}`,Bh(t));Je("community.updated",r);const s=Uh(r),i=n.cache&&Date.now();n.cache&&(Uo(s,{cachedAt:i}),up(s.communities,s.communityUsers));const{communities:a}=s;return{data:a.find((t=>t.communityId===e)),cachedAt:i}},deleteCommunity:async e=>{const t=ve();t.log("community/deleteCommunity",e),await t.http.delete(`/api/v3/communities/${e}`);const n=await fp(e);return Je("community.deleted",{communities:[n.data],categories:[],communityUsers:[],feeds:[],files:[],users:[]}),n.data},joinCommunity:async e=>{const t=ve();t.log("community/joinCommunity",e);const{data:n}=await t.http.post(`/api/v3/communities/${e}/join`);Je("local.community.joined",n);const r=Uh(n),s=t.cache&&Date.now();t.cache&&Uo(r,{cachedAt:s});const{communityUsers:i}=r;return!!i.find((t=>t.communityId===e&&"member"===t.communityMembership))},leaveCommunity:async e=>{const t=ve();t.log("community/leaveCommunity",e);const{data:n}=await t.http.delete(`/api/v3/communities/${e}/leave`);Je("local.community.left",n);const r=Uh(n),s=t.cache&&Date.now();t.cache&&Uo(r,{cachedAt:s});const{communityUsers:i}=r;return!!i.find((t=>t.communityId===e&&"member"!==t.communityMembership))},onCommunityCreated:gp,onCommunityUpdated:mp,onCommunityDeleted:yp,searchCommunities:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`searchCommunities(tmpid: ${i}) > listen`);const a=new Wp(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`searchCommunities(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},getCommunities:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getCommunities(tmpid: ${i}) > listen`);const a=new Jp(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`getCommunities(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},getCommunity:(e,t)=>zu(e,t,"communityId",fp,[mp,yp,Mp,Fp,Up,Np,_p,Op,Rp]),getTrendingCommunities:(e,t,n)=>{const{log:r,cache:s,userId:i}=ve();s||console.log(g);const a=Date.now();r(`getTrendingCommunities(tmpid: ${a}) > listen`);const o=new ng(e,t),l=o.startSubscription(),c=o.getCacheKey();return l.push((()=>Ie(c))),()=>{r(`getTrendingCommunities(tmpid: ${a}) > dispose`),l.forEach((e=>e()))}},getRecommendedCommunities:(e,t,n)=>{const{log:r,cache:s,userId:i}=ve();s||console.log(g);const a=Date.now();r(`getRecommendedCommunities(tmpid: ${a}) > listen`);const o=new ag(e,t),l=o.startSubscription(),c=o.getCacheKey();return l.push((()=>Ie(c))),()=>{r(`getRecommendedCommunities(tmpid: ${a}) > dispose`),l.forEach((e=>e()))}},semanticSearchCommunities:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`semanticSearchCommunities(tmpid: ${i}) > listen`);const a=new ug(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`semanticSearchCommunities(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},get AmityCommunityMemberStatusFilter(){return hg}});const gg=async e=>{const t=ve();t.log("category/getCategory",e);const{data:n}=await t.http.get(`/api/v3/community-categories/${encodeURIComponent(e)}`),r=t.cache&&Date.now();t.cache&&Uo(n,{cachedAt:r});const{categories:s}=n;return{data:yl.category(s.find((t=>t.categoryId===e))),cachedAt:r}};gg.locally=e=>{const t=ve();if(t.log("category/getCategory.locally",e),!t.cache)return;const n=Se(["category","get",e]);return n?{data:yl.category(n.data),cachedAt:n.cachedAt}:void 0};const mg=async e=>{const t=ve();t.log("category/queryCategories",e);const n=null!=e?e:{},{page:r,limit:s,includeDeleted:i}=n,a=Bo(n,["page","limit","includeDeleted"]),o=r?{token:r}:s?{limit:s}:void 0,{data:l}=await t.http.get("/api/v3/community-categories",{params:Object.assign(Object.assign({},a),{isDeleted:kl(i),options:o})}),{paging:c}=l,d=Bo(l,["paging"]),{categories:u}=d,h=t.cache&&Date.now();if(t.cache){Uo(d,{cachedAt:h});const e=["category","query",Object.assign(Object.assign({},a),{includeDeleted:i,options:o})];Ce(e,{categories:u.map(de("category")),paging:c})}return{data:u,cachedAt:h,paging:c}};mg.locally=e=>{var t,n;const r=ve();if(r.log("category/queryCategories.locally",e),!r.cache)return;const s=null!=e?e:{},{page:i,limit:a=10}=s,o=Bo(s,["page","limit"]),l=i?{token:i}:a?{limit:a}:void 0,c=["category","query",Object.assign(Object.assign({},o),{options:l})],{data:d,cachedAt:u}=null!==(t=Se(c))&&void 0!==t?t:{};if(!(null==d?void 0:d.categories.length))return;const h=d.categories.map((e=>Se(["category","get",e]))).filter(Boolean).map((({data:e})=>e)),{paging:f}=d;return h.length===(null===(n=null==d?void 0:d.categories)||void 0===n?void 0:n.length)?{data:h,cachedAt:u,paging:f}:void 0};var yg=Object.freeze({__proto__:null,getCategory:gg,getCategories:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getCategories(tmpid: ${i}) > listen`);const{limit:a}=e,o=Bo(e,["limit"]),l=null!=a?a:f,{policy:c=p}=null!=n?n:{},d=[],u=["category","collection",{}],h=(n=!1)=>{var r,s;const i=null===(r=Se(u))||void 0===r?void 0:r.data,a=null!==(s=null==i?void 0:i.data)&&void 0!==s?s:[];if(!n&&a.length>0&&!(null==i?void 0:i.params.page))return;const d=ie(mg,Object.assign(Object.assign({},o),{limit:n?l:void 0,page:n||null==i?void 0:i.params.page}));oe(d,(({data:n,error:r,loading:s,paging:i})=>{const o={loading:s,error:r,params:{page:null==i?void 0:i.next},data:a};n&&(o.data=[...new Set([...a,...n.map(de("category"))])]),Ce(u,o),(n=>{var r,s;let i=null!==(r=n.data.map((e=>Se(["category","get",e]))).filter(Boolean).map((({data:e})=>yl.category(e))))&&void 0!==r?r:[];switch(e.includeDeleted||(i=ke(i,"isDeleted",!1)),e.sortBy){case"firstCreated":i=i.sort(Fe);break;case"lastCreated":i=i.sort(Ne);break;default:i=i.sort(Me)}t({onNextPage:h,data:i,hasNextPage:!!(null===(s=n.params)||void 0===s?void 0:s.page),loading:n.loading,error:n.error})})(o)}),ae(c))};return d.push((()=>{})),h(!0),()=>{r(`getCategories(tmpid: ${i}) > dispose`),d.forEach((e=>e()))}}});const vg=async e=>{const t=ve();t.log("feed/queryGlobalFeed",e);const n=null!=e?e:{},{queryToken:r}=n,s=Bo(n,["queryToken"]),i=(()=>{if(r)return{token:r}})(),{data:a}=await t.http.get("/api/v4/me/global-feeds",{params:Object.assign(Object.assign({},s),{options:i})}),{paging:o}=a,l=Bo(a,["paging"]),c=$o(l,"communityUsers"),{posts:d}=c,{communities:u}=Uh(c),h=t.cache&&Date.now();if(t.cache){Uo(Object.assign(Object.assign({},c),{communitis:u}));const e=["globalFeed","query",Object.assign(Object.assign({},s),{options:i})];Ce(e,{posts:d.map(de("post")),paging:o})}return{data:d.map(yl.post),cachedAt:h,paging:o}};vg.locally=e=>{var t,n;const r=ve();if(r.log("post/queryGlobalFeed.locally",e),!r.cache)return;const s=Bo(null!=e?e:{},[]),i=["globalFeed","query",Object.assign({},s)],{data:a,cachedAt:o}=null!==(t=Se(i))&&void 0!==t?t:{};if(!(null==a?void 0:a.posts.length))return;const l=a.posts.map((e=>Se(["post","get",e]))).filter(Boolean).map((({data:e})=>e)).map(yl.post),{paging:c}=a;return l.length===(null===(n=null==a?void 0:a.posts)||void 0===n?void 0:n.length)?{data:l,cachedAt:o,paging:c}:void 0};const bg=async e=>{const t=ve();t.log("feed/getCustomRankingGlobalFeed",e);const n=null!=e?e:{},{queryToken:r,limit:s}=n,i=Bo(n,["queryToken","limit"]),a=(()=>{if(r)return{token:r}})(),{data:o}=await t.http.get("/api/v5/me/global-feeds",{params:Object.assign(Object.assign({},i),{limit:r?void 0:s,options:a})}),{paging:l}=o,c=Bo(o,["paging"]),d=$o(c,"communityUsers"),{posts:u}=d,h=t.cache&&Date.now();if(t.cache){Uo(d);const e=["customGlobalFeed","query",Object.assign(Object.assign({},i),{options:a})];Ce(e,{posts:u.map(de("post")),paging:l})}return{data:u.map(yl.post),cachedAt:h,paging:l}};bg.locally=e=>{var t,n;const r=ve();if(r.log("post/getCustomRankingGlobalFeed.locally",e),!r.cache)return;const s=Bo(null!=e?e:{},[]),i=["customGlobalFeed","query",Object.assign({},s)],{data:a,cachedAt:o}=null!==(t=Se(i))&&void 0!==t?t:{};if(!(null==a?void 0:a.posts.length))return;const l=a.posts.map((e=>Se(["post","get",e]))).filter(Boolean).map((({data:e})=>e)),{paging:c}=a;return l.length===(null===(n=null==a?void 0:a.posts)||void 0===n?void 0:n.length)?{data:l.map(yl.post),cachedAt:o,paging:c}:void 0};var wg=Object.freeze({__proto__:null,queryGlobalFeed:vg,getCustomRankingGlobalFeed:bg});const Sg=async e=>{const t=ve();t.log("post/getPostByIds",e);const n=e.map((e=>encodeURIComponent(e)));let r;try{r=(await t.http.get("/api/v3/posts/list",{params:{postIds:n}})).data}catch(t){throw e.forEach((e=>{I(null==t?void 0:t.code)&&No("post",e)})),t}const s=$o(r,"communityUsers"),i=t.cache&&Date.now();return t.cache&&Uo(s,{cachedAt:i}),{data:s.posts.map(yl.post),cachedAt:i}};Sg.locally=e=>{var t;const n=ve();if(n.log("post/getPostByIds.locally",e),!n.cache)return;const r=e.map((e=>Se(["post","get",e]))).filter(Boolean),s=r.map((({data:e})=>e)),i=null===(t=r.sort(((e,t)=>e.cachedAt<t.cachedAt?-1:1)))||void 0===t?void 0:t[0];return(null==r?void 0:r.length)<e.length?void 0:{data:s.map(yl.post),cachedAt:i.cachedAt}};const Cg=async(e,t=!1)=>{var n;const r=ve(),s=await Ih(e);if(await r.http.delete(`/api/v4/posts/${encodeURIComponent(e)}`,{params:{postId:e,permanent:t}}),"community"===s.data.targetType){const e=await fp(s.data.targetId),t=(null!==(n=we(["communityUsers","get"]))&&void 0!==n?n:[]).filter((({key:t})=>"communityUsers"===t[0]&&("get"===t[1]&&("string"==typeof t[2]&&t[2].includes(e.data.communityId))))).map((({data:e})=>e));Je("community.updated",{communities:[e.data],categories:[],communityUsers:t,feeds:[],files:[],users:[]})}const i=Object.assign(Object.assign({},s.data),{isDeleted:!0});return t?setTimeout((()=>{No("post",e)}),0):Ee(["post","get",e],{isDeleted:!0}),Je("local.post.deleted",{posts:[i],categories:[],comments:[],communities:[],communityUsers:[],feeds:[],files:[],postChildren:[],users:[],videoStreamings:[]}),yl.post(i)},Tg=async e=>{const t=ve();t.log("comment/getCommentByIds",e);const n=e.map((e=>encodeURIComponent(e)));let r;try{r=(await t.http.get("/api/v3/comments/list",{params:{commentIds:n}})).data}catch(t){throw e.forEach((e=>{I(null==t?void 0:t.code)&&No("comment",e)})),t}const s=t.cache&&Date.now();return t.cache&&Uo(r,{cachedAt:s}),{data:r.comments.map((e=>yl.comment(e))),cachedAt:s}};Tg.locally=e=>{var t;const n=ve();if(n.log("comment/getCommentByIds.locally",e),!n.cache)return;const r=e.map((e=>Se(["comment","get",e]))).filter(Boolean),s=r.map((({data:e})=>e)),i=null===(t=r.sort(((e,t)=>e.cachedAt<t.cachedAt?-1:1)))||void 0===t?void 0:t[0];return(null==r?void 0:r.length)<e.length?void 0:{data:s.map((e=>yl.comment(e))),cachedAt:i.cachedAt}};const Eg=(e,t=!1)=>{const{stories:n}=e,r=n.map((e=>((e,t=!1)=>{const{storyId:n,referenceId:r}=e;return!t&&r?Object.assign(Object.assign({},e),{syncState:"synced"}):Object.assign(Object.assign({},e),{syncState:"synced",referenceId:n})})(e,t)));return Object.assign(Object.assign({},e),{stories:r})},Ig=async e=>{const t=ve();t.log("story/getStoryByStoryId",e);const n=Se(["story-reference",e]);if(null==n?void 0:n.data){const{data:e}=n;Tl("story",e)}let r;try{const n=await t.http.get(`/api/v4/stories/${e}`);r=Eg(n.data)}catch(t){throw I(null==t?void 0:t.code)&&No("story",e),t}const s=t.cache&&Date.now();return t.cache&&Uo(r,{cachedAt:s}),{data:r.stories[0],cachedAt:s}};Ig.locally=e=>{const t=ve();t.log("story/getStorybyStoryId",e);const n=Se(["story-reference",e]);if(null==n?void 0:n.data){const{data:e}=n;Tl("story",e)}const r=t.cache&&Date.now(),s=Se(["story","get",e]);if(s)return{data:s.data,cachedAt:r}};const kg=async(e,t=!1)=>{var n;const r=ve(),s=await kh(e);await r.http.delete(`/api/v4/comments/${encodeURIComponent(e)}`,{params:{commentId:e,permanent:t}});const i=Object.assign(Object.assign({},s.data),{isDeleted:!0});if("story"===s.data.referenceType){const e=await Ig(s.data.referenceId);Je("local.story.updated",{stories:[e.data],categories:[],comments:[],communities:[],communityUsers:[],files:[],users:[]})}else{const e=null===(n=Se(["post","get",s.data.referenceId]))||void 0===n?void 0:n.data;if(e){let t;t=i.parentId?1:i.childrenNumber+1,e.commentsCount-=t,Je("local.post.updated",{posts:[e],categories:[],comments:[],communities:[],communityUsers:[],feeds:[],files:[],postChildren:[],users:[],videoStreamings:[]})}}return Je("local.comment.deleted",{comments:[i],commentChildren:[],files:[],users:[],communityUsers:[]}),t?ze((()=>No("comment",e))):Ee(["comment","get",e],{isDeleted:!0}),i},Ag=async e=>{const t=ve();let n;t.log("comment/getComment",e),Tl("comment",e);try{n=(await t.http.get(`/api/v3/comments/${encodeURIComponent(e)}`)).data}catch(t){throw I(null==t?void 0:t.code)&&No("comment",e),t}const r=t.cache&&Date.now();t.cache&&Uo(n,{cachedAt:r});const{comments:s}=n;return{data:s.find((t=>t.commentId===e)),cachedAt:r}};Ag.locally=e=>{const t=ve();if(t.log("comment/getComment.locally",e),!t.cache)return;const n=Se(["comment","get",e]);return n?{data:n.data,cachedAt:n.cachedAt}:void 0};const _g=e=>tf("local.comment.deleted",e),Rg=e=>{const t=ve();return Xe(t,"local.comment.addReaction","local.comment.addReaction",(({comment:n})=>{t.cache?(Ee(["comment","get",n.commentId],n),e(il(n))):e(n)}))},Og=e=>{const t=ve();return Xe(t,"local.comment.removeReaction","local.comment.removeReaction",(({comment:n})=>{t.cache?(Ee(["comment","get",n.commentId],n),e(il(n))):e(n)}))};class Lg extends Mu{async getRequest(e,t){const{limit:n=f,includeDeleted:r}=e,s=Bo(e,["limit","includeDeleted"]),i={type:s.sortBy||e.limit?"pagination":void 0},a=t?Object.assign(Object.assign({},i),{token:t}):Object.assign(Object.assign({},i),{limit:n}),{data:o}=await this.http.get("/api/v3/comments",{params:Object.assign(Object.assign({},s),{isDeleted:kl(r),options:a})});return o}}var Dg;!function(e){e.OnCommentCreated="onCommentCreated",e.OnCommentUpdated="onCommentUpdated",e.OnCommentDeleted="onCommentDeleted",e.OnCommentFlagged="onCommentFlagged",e.OnCommentUnflagged="onCommentUnflagged",e.OnCommentReactionAdded="onCommentReactionAdded",e.OnCommentReactionRemoved="onCommentReactionRemoved"}(Dg||(Dg={}));class xg extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.comments.map(de("comment"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.comments.map(de("comment"))])]}))}}reactor(e){return t=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;this.query.referenceId===t.referenceId&&this.query.referenceType===t.referenceType&&r&&(this.query.parentId&&this.query.parentId!==t.parentId||!this.query.parentId&&t.parentId||(e===Dg.OnCommentCreated&&(r.data=[...new Set([t.commentId,...r.data])]),Ce(this.cacheKey,r),this.notifyChange({origin:"event",loading:!1})))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}const Pg=e=>tf("local.comment.created",e);class Mg extends ju{constructor(e,t){const n=Pu(e),r=["comments","collection",n];super(new Lg(e),n,r,t),this.query=e,this.queryStreamController=new xg(this.query,this.cacheKey,this.notifyChange.bind(this),mf),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:Pg,action:Dg.OnCommentCreated},{fn:_g,action:Dg.OnCommentDeleted},{fn:nf,action:Dg.OnCommentCreated},{fn:rf,action:Dg.OnCommentUpdated},{fn:sf,action:Dg.OnCommentDeleted},{fn:af,action:Dg.OnCommentFlagged},{fn:of,action:Dg.OnCommentUnflagged},{fn:lf,action:Dg.OnCommentReactionAdded},{fn:cf,action:Dg.OnCommentReactionRemoved},{fn:Rg,action:Dg.OnCommentReactionAdded},{fn:Og,action:Dg.OnCommentReactionRemoved}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["comment","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]).map(yl.comment);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){let t=e;if(this.query.includeDeleted||(t=ke(t,"isDeleted",!1)),this.query.parentId&&(t=t.filter((e=>e.parentId===this.query.parentId))),"boolean"==typeof this.query.hasFlag&&(t=this.query.hasFlag?t.filter((e=>null!=e.hashFlag)):t.filter((e=>null==e.hashFlag))),this.query.dataTypes&&("exact"===this.query.dataTypes.matchType&&(t=t.filter((e=>{var t,n;const r=(null===(t=this.query.dataTypes)||void 0===t?void 0:t.values.sort())||[],s=(null===(n=e.dataTypes)||void 0===n?void 0:n.sort())||[];return s.length===r.length&&r.every(((e,t)=>e===s[t]))}))),"any"===this.query.dataTypes.matchType&&(t=t.filter((e=>{var t;return null===(t=this.query.dataTypes)||void 0===t?void 0:t.values.some((t=>{var n;return null===(n=e.dataTypes)||void 0===n?void 0:n.includes(t)}))})))),"firstCreated"===this.query.sortBy)t=t.sort(Fe);else t=t.sort(Ne);return t}}var Fg=Object.freeze({__proto__:null,getCommentByIds:Tg,createComment:async e=>{var t;const n=ve();n.log("comment/createComment",e);const{data:r}=await n.http.post("/api/v3/comments",e),{comments:s}=r;if(0===s.length)throw new Error("Comment not created");const i=n.cache&&Date.now();if(n.cache&&Uo(r,{cachedAt:i}),["post","content"].includes(e.referenceType)){const n=null===(t=Se(["post","get",e.referenceId]))||void 0===t?void 0:t.data;n&&(n.commentsCount+=1,Je("local.post.updated",{posts:[n],categories:[],comments:[],communities:[],communityUsers:r.communityUsers,feeds:[],files:r.files,postChildren:[],users:r.users,videoStreamings:[]}))}else if("story"===e.referenceType){const t=Se(["story-reference",e.referenceId]);if(null==t?void 0:t.data){const e=Se(["story","get",t.data]);(null==e?void 0:e.data)&&Je("story.updated",{stories:[Object.assign(Object.assign({},e.data),{commentsCount:e.data.commentsCount+1,comments:[...new Set([...e.data.comments,s[0].commentId])]})],categories:[],comments:s,communities:[],communityUsers:r.communityUsers,files:r.files,users:r.users})}}return Je("local.comment.created",r),{data:yl.comment(s[0]),cachedAt:i}},updateComment:async(e,t)=>{const n=ve();n.log("user/updateComment",t);const{data:r}=await n.http.put(`/api/v3/comments/${encodeURIComponent(e)}`,t),s=n.cache&&Date.now();n.cache&&Uo(r,{cachedAt:s}),Je("comment.updated",r);const{comments:i}=r;return{data:yl.comment(i.find((t=>t.commentId===e))),cachedAt:s}},deleteComment:kg,softDeleteComment:async e=>{ve().log("comment/softDeleteComment",e);return kg(e)},hardDeleteComment:async e=>{ve().log("comment/hardDeleteComment",e);return kg(e,!0)},flagComment:async e=>{const t=ve();t.log("comment/flagComment",e);const{data:n}=await t.http.post(`/api/v3/comments/${encodeURIComponent(e)}/flag`);return t.cache&&Uo(n),Je("comment.flagged",n),!!n},unflagComment:async e=>{const t=ve();t.log("comment/unflagComment",e);const{data:n}=await t.http.delete(`/api/v3/comments/${encodeURIComponent(e)}/unflag`);return t.cache&&Uo(n),Je("comment.unflagged",n),!!n},isCommentFlaggedByMe:async e=>{const t=ve();t.log("comment/isCommentFlaggedByMe",e);const{data:{result:n}}=await t.http.get(`/api/v3/comments/${e}/isflagbyme`);return n},onCommentCreated:nf,onCommentUpdated:rf,onCommentDeleted:sf,onCommentFlagged:af,onCommentUnflagged:of,onCommentReactionAdded:lf,onCommentReactionRemoved:cf,getComment:(e,t)=>zu(e,t,"commentId",Ag,[_g,sf,af,lf,cf,of,rf,Rg,Og]),getComments:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log("For using Live Collection feature you need to enable Cache!");const i=Date.now();r(`getComments(tmpid: ${i}) > listen`);const a=new Mg(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`getComments(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}}});const Ug=e=>Gh("local.post.updated",e),Ng=e=>{const t=ve();return Xe(t,"local.post.addReaction","local.post.addReaction",(({post:n})=>{t.cache?(Ee(["post","get",n.postId],n),e(n)):e(n)}))},Bg=e=>{const t=ve();return Xe(t,"local.post.removeReaction","local.post.removeReaction",(({post:n})=>{t.cache?(Ee(["post","get",n.postId],n),e(n)):e(n)}))},jg=e=>Gh("local.post.deleted",e);class $g extends Mu{async getRequest(e,t){const{limit:n=f,includeDeleted:r,matchingOnlyParentPost:s}=e,i=Bo(e,["limit","includeDeleted","matchingOnlyParentPost"]),{dataTypes:a}=i,o={type:i.sortBy||e.limit?"pagination":void 0},l=t?Object.assign(Object.assign({},o),{token:t}):Object.assign(Object.assign({},o),{limit:n}),{data:c}=await this.http.get("/api/v4/posts",{params:Object.assign(Object.assign({},i),{isDeleted:kl(r),matchingOnlyParentPost:null!=s?s:!(null==a?void 0:a.length),options:l})});return c}}var qg;!function(e){e.OnPostCreated="onPostCreated",e.OnPostUpdated="onPostUpdated",e.OnPostDeleted="onPostDeleted",e.OnPostFlagged="onPostFlagged",e.OnPostUnflagged="onPostUnflagged",e.OnPostReactionAdded="onPostReactionAdded",e.OnPostReactionRemoved="onPostReactionRemoved",e.OnPostApproved="onPostApproved",e.OnPostDeclined="onPostDeclined"}(qg||(qg={}));class Kg extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.posts.map(de("post"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.posts.map(de("post"))])]}))}}reactor(e){return t=>{var n,r;const s=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;if(s){if(t.parentPostId&&t.isDeleted){const e=null===(r=Se(["post","get",t.parentPostId]))||void 0===r?void 0:r.data;if(!e||(null==e?void 0:e.targetId)!==this.query.targetId)return;e.children=e.children.filter((e=>e!==t.postId)),Ce(["post","get",e.postId],e)}else{if(this.query.targetId!==t.targetId)return;if(this.query.targetType!==t.targetType)return}e===qg.OnPostDeclined&&(s.data=s.data.filter((e=>e!==t.postId))),e!==qg.OnPostCreated&&e!==qg.OnPostApproved||(s.data=[...new Set([t.postId,...s.data])]),Ce(this.cacheKey,s),this.notifyChange({origin:"event",loading:!1})}}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}const Gg=async e=>{const t=ve();let n;t.log("post/getPost",e),Tl("post",e);try{n=(await t.http.get(`/api/v3/posts/${encodeURIComponent(e)}`)).data}catch(t){throw I(null==t?void 0:t.code)&&No("post",e),t}const r=$o(n,"communityUsers"),s=t.cache&&Date.now();t.cache&&Uo(r,{cachedAt:s});const{posts:i}=r;return{data:i.find((t=>t.postId===e)),cachedAt:s}};Gg.locally=e=>{const t=ve();if(t.log("post/getPost.locally",e),!t.cache)return;const n=Se(["post","get",e]);return n?{data:n.data,cachedAt:n.cachedAt}:void 0};class Hg extends ju{constructor(e,t){const n=Pu(e),r=["posts","collection",n];super(new $g(e),n,r,t),this.query=e,this.queryStreamController=new Kg(this.query,this.cacheKey,this.notifyChange.bind(this),$h),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:Hh,action:qg.OnPostCreated},{fn:Vh,action:qg.OnPostUpdated},{fn:Ug,action:qg.OnPostUpdated},{fn:zh,action:qg.OnPostDeleted},{fn:Qh,action:qg.OnPostFlagged},{fn:Xh,action:qg.OnPostUnflagged},{fn:Wh,action:qg.OnPostApproved},{fn:Yh,action:qg.OnPostDeclined},{fn:Jh,action:qg.OnPostReactionAdded},{fn:Zh,action:qg.OnPostReactionRemoved},{fn:Ng,action:qg.OnPostReactionAdded},{fn:Bg,action:qg.OnPostReactionRemoved},{fn:jg,action:qg.OnPostDeleted},{fn:ch((e=>nf((async t=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;r&&!r.data.includes(t.referenceId)&&(await Gg(t.referenceId),e(t))}))),"referenceId","post"),action:qg.OnPostUpdated},{fn:ch((e=>sf((async t=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;r&&!r.data.includes(t.referenceId)&&(await Gg(t.referenceId),e(t))}))),"referenceId","post"),action:qg.OnPostUpdated}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>Se(["post","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]).map(yl.post);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){var t;let n=e;if(this.query.includeDeleted||(n=ke(n,"isDeleted",!1)),this.query.tags&&(n=n.filter((e=>{var t;return null===(t=e.tags)||void 0===t?void 0:t.some((e=>{var t;return null===(t=this.query.tags)||void 0===t?void 0:t.includes(e)}))}))),"community"===this.query.targetType&&this.query.feedType&&(n=Oe(n,this.query.feedType)),(null===(t=this.query.dataTypes)||void 0===t?void 0:t.length)&&(n=De(n,this.query.dataTypes)),"firstCreated"===this.query.sortBy)n=n.sort(Fe);else n=n.sort(Ne);return n}}class Vg extends Mu{async getRequest(e,t){const n=Bo(e,["limit"]),{communityId:r,placement:s}=n,i=s?`/api/v1/pinned-posts/communities/${r}/${s}`:`/api/v1/pinned-posts/communities/${r}`,{data:a}=await this.http.get(i);return a}}class zg extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=ve(),n=t.cache&&Date.now();t.cache&&Uo(e,{cachedAt:n})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.pins.map(de("pin"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.pins.map(de("pin"))])]})),this.notifyChange({origin:"server",loading:!1})}}}class Wg extends ju{constructor(e,t){const n=Pu(e),r=["pinnedPosts","collection",n];super(new Vg(e),n,r,t),this.query=e,this.queryStreamController=new zg(this.query,this.cacheKey,this.notifyChange.bind(this),(e=>e)),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return[]}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;let a=(null!==(s=i.data.map((e=>Se(["pin","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]).map(yl.pinnedPost);a=this.applyFilter(a),(this.shouldNotify(a)||"event"!==e)&&this.callback({data:a,loading:t,error:n})}applyFilter(e){let t=e;if("lastCreated"===this.query.sortBy)t=t.sort((({post:e},{post:t})=>Ne({createdAt:null==e?void 0:e.createdAt},{createdAt:null==t?void 0:t.createdAt})));return t}}class Yg extends Mu{async getRequest(e,t){Bo(e,["limit"]);const{data:n}=await this.http.get("/api/v1/pinned-posts/global");return n}}class Qg extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=ve(),n=t.cache&&Date.now();t.cache&&Uo(e,{cachedAt:n})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.pins.map(de("pin"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.pins.map(de("pin"))])]})),this.notifyChange({origin:"server",loading:!1})}}reactor(e){return t=>{var n;const r=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;r&&(e===qg.OnPostDeleted&&(r.data=r.data.filter((e=>e!==`global#${t.postId}`))),Ce(this.cacheKey,r),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}class Xg extends ju{constructor(e,t){const n=Pu(e),r=["pinnedPosts","collection",n];super(new Yg(e),n,r,t),this.query=e,this.queryStreamController=new Qg(this.query,this.cacheKey,this.notifyChange.bind(this),(e=>e)),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:jg,action:qg.OnPostDeleted},{fn:zh,action:qg.OnPostDeleted}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=(null!==(s=i.data.map((e=>Se(["pin","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]).map(yl.pinnedPost);(this.shouldNotify(a)||"event"!==e)&&this.callback({data:a,loading:t,error:n})}}class Jg extends Mu{async getRequest(e,t){const{limit:n=f}=e,r=Bo(e,["limit"]),s={type:e.limit?"pagination":void 0},i=t?Object.assign(Object.assign({},s),{token:t}):Object.assign(Object.assign({},s),{limit:n}),{data:a}=await this.http.get("/api/v1/semantic-search/posts",{params:Object.assign(Object.assign({},r),{options:i})});return a}}function Zg(e){return e.posts.map((t=>{const n=e.searchResult.find((e=>e.postId===t.postId));return`${t.postId}:${n.score}`}))}function em(e){return(null!=e?e:[]).map((e=>e.split(":")[0]))}class tm extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:Zg(e)});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...Zg(e)])]}))}}reactor(e){return t=>{var n,r;const s=null===(n=Se(this.cacheKey))||void 0===n?void 0:n.data;if(s){if(t.parentPostId&&t.isDeleted){const e=null===(r=Se(["post","get",t.parentPostId]))||void 0===r?void 0:r.data;if(!e||(null==e?void 0:e.targetId)!==this.query.targetId)return;e.children=e.children.filter((e=>e!==t.postId)),Ce(["post","get",e.postId],e)}else{if(this.query.targetId!==t.targetId)return;if(this.query.targetType!==t.targetType)return}e===qg.OnPostDeclined&&(s.data=s.data.filter((e=>e!==t.postId))),e!==qg.OnPostCreated&&e!==qg.OnPostApproved||(s.data=[...new Set([t.postId,...s.data])]),Ce(this.cacheKey,s),this.notifyChange({origin:"event",loading:!1})}}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}class nm extends ju{constructor(e,t){const n=Object.assign(Object.assign({},e),{matchingOnlyParentPost:null==e.matchingOnlyParentPost||e.matchingOnlyParentPost,dataTypes:null==e.dataTypes?["text","image"]:e.dataTypes}),r=Pu(n),s=["posts","collection",r];super(new Jg(n),r,s,t),this.query=n,this.queryStreamController=new tm(this.query,this.cacheKey,this.notifyChange.bind(this),qh),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:Vh,action:qg.OnPostUpdated},{fn:zh,action:qg.OnPostDeleted},{fn:Qh,action:qg.OnPostFlagged},{fn:Xh,action:qg.OnPostUnflagged},{fn:Wh,action:qg.OnPostApproved},{fn:Yh,action:qg.OnPostDeclined},{fn:Jh,action:qg.OnPostReactionAdded},{fn:Zh,action:qg.OnPostReactionRemoved},{fn:ch((e=>nf((async t=>{const n=Se(this.cacheKey);em(null==n?void 0:n.data).includes(t.referenceId)||(await Ih(t.referenceId),e(t))}))),"referenceId","post"),action:qg.OnPostUpdated},{fn:ch((e=>sf((async t=>{const n=Se(this.cacheKey);em(null==n?void 0:n.data).includes(t.referenceId)||(await Ih(t.referenceId),e(t))}))),"referenceId","post"),action:qg.OnPostUpdated}])}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=this.applyFilter(null!==(s=i.data.map((e=>{const[t,n]=e.split(":");return{postId:t,score:parseFloat(n)}})).sort(((e,t)=>t.score-e.score)).map((({postId:e})=>Se(["post","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]).map(yl.post);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}applyFilter(e){let t=e;return this.query.targetType&&(t=t.filter((e=>e.targetType===this.query.targetType))),this.query.targetId&&(t=t.filter((e=>e.targetId===this.query.targetId))),this.query.dataTypes&&this.query.dataTypes.length>0&&(t=De(t,this.query.dataTypes)),t}}var rm=Object.freeze({__proto__:null,getPostByIds:Sg,createPost:async e=>{const t=ve();t.log("post/createPost",e),e.dataType&&!["text","image","file","video"].includes(e.dataType)||delete e.dataType;const{data:n}=await t.http.post("/api/v4/posts",e);Je("post.created",n);const r=$o(n,"communityUsers"),s=t.cache&&Date.now();t.cache&&Uo(r,{cachedAt:s});const{posts:i}=r;return{data:yl.post(i[0]),cachedAt:s}},editPost:async(e,t)=>{const n=ve();n.log("user/editPost",t);const{data:r}=await n.http.put(`/api/v4/posts/${encodeURIComponent(e)}`,t),s=$o(r,"communityUsers"),i=n.cache&&Date.now();n.cache&&Uo(s,{cachedAt:i}),Je("local.post.updated",s);const{posts:a}=s;return{data:yl.post(a.find((t=>t.postId===e))),cachedAt:i}},deletePost:Cg,softDeletePost:async e=>{ve().log("post/softDeletePost",e);const t=await Cg(e,!1);return yl.post(t)},hardDeletePost:async e=>{ve().log("post/hardDeletePost",e);const t=await Cg(e,!0);return yl.post(t)},approvePost:async e=>{const t=ve();t.log("post/approvePost",e);const{data:n}=await t.http.post(`/api/v3/posts/${encodeURIComponent(e)}/approve`);Je("post.approved",n),"community"===n.posts[0].targetType&&Je("community.updated",n);const r=$o(n,"communityUsers"),s=t.cache&&Date.now();return t.cache&&Uo(r,{cachedAt:s}),{data:yl.post(r.posts.find((t=>t.postId===e))),cachedAt:s}},declinePost:async e=>{const t=ve();t.log("post/declinePost",e);const{data:n}=await t.http.post(`/api/v3/posts/${encodeURIComponent(e)}/decline`);"community"===n.posts[0].targetType&&Je("community.updated",n),Je("post.declined",n);const r=$o(n,"communityUsers"),s=t.cache&&Date.now();return t.cache&&Uo(r,{cachedAt:s}),{data:yl.post(n.posts.find((t=>t.postId===e))),cachedAt:s}},flagPost:async e=>{const t=ve();t.log("post/flagPost",e);const{data:n}=await t.http.post(`/api/v3/posts/${encodeURIComponent(e)}/flag`);return t.cache&&Uo($o(n,"communityUsers")),Je("post.flagged",n),!!n},unflagPost:async e=>{const t=ve();t.log("post/unflagPost",e);const{data:n}=await t.http.delete(`/api/v3/posts/${encodeURIComponent(e)}/unflag`);return t.cache&&Uo($o(n,"communityUsers")),Je("post.unflagged",n),!!n},isPostFlaggedByMe:async e=>{const t=ve();t.log("post/isPostFlaggedByMe",e);const{data:{result:n}}=await t.http.get(`/api/v3/posts/${e}/isflagbyme`);return n},onPostCreated:Hh,onPostUpdated:Vh,onPostDeleted:zh,onPostApproved:Wh,onPostDeclined:Yh,onPostFlagged:Qh,onPostUnflagged:Xh,onPostReactionAdded:Jh,onPostReactionRemoved:Zh,getPost:(e,t)=>zu(e,(e=>{const{data:n}=e;t(Object.assign(Object.assign({},e),{data:n?yl.post(e.data):n}))}),"postId",Ih,[Wh,Yh,Ng,Bg,t=>zh((n=>{var r;let s=n;if(n.parentPostId===e&&n.isDeleted){const e=null===(r=Se(["post","get",n.parentPostId]))||void 0===r?void 0:r.data;e&&(e.children=e.children.filter((e=>e!==n.postId)),Ce(["post","get",e.postId],e),s=e)}t(s)})),Qh,e=>Jh((t=>{e(yl.post(t))})),e=>Zh((t=>{e(yl.post(t))})),Xh,Vh,Ug,jg,ch((t=>nf((async n=>{n.referenceId===e&&(await Ih(e),t(n))}))),"referenceId","post"),ch((t=>sf((async n=>{n.referenceId===e&&(await Ih(e),t(n))}))),"referenceId","post")]),getPosts:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getPosts(tmpid: ${i}) > listen`);const a=new Hg(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`getPosts(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},getPinnedPosts:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getPinnedPosts(tmpid: ${i}) > listen`);const a=new Wg(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`getPinnedPosts(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},getGlobalPinnedPosts:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getGlobalPinnedPosts(tmpid: ${i}) > listen`);const a=new Xg(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`getGlobalPinnedPosts(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},semanticSearchPosts:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`semanticSearchPosts(tmpid: ${i}) > listen`);const a=new nm(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`semanticSearchPosts(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}}});const sm=async e=>{const t=ve();t.log("stream/getStream",e);const{data:n}=await t.http.get(`/api/v3/video-streaming/${e}`),r=t.cache&&Date.now();t.cache&&Uo(n,{cachedAt:r});const{videoStreamings:s}=n;return{data:s.find((t=>t.streamId===e)),cachedAt:r}};sm.locally=e=>{const t=ve();if(t.log("stream/getStream",e),!t.cache)return;const n=Se(["stream","get",e]);return n?{data:n.data,cachedAt:n.cachedAt}:void 0};const im=e=>{const t=ve();return Xe(t,"stream/onStreamStarted","video-streaming.didStart",(t=>{Uo(t),e(t.videoStreamings[0])}))},am=e=>{const t=ve();return Xe(t,"stream/onStreamStropped","video-streaming.didStop",(t=>{Uo(t),e(t.videoStreamings[0])}))},om=e=>{const t=ve();return Xe(t,"stream/onStreamRecorded","video-streaming.didRecord",(t=>{Uo(t),e(t.videoStreamings[0])}))},lm=e=>{const t=ve();return Xe(t,"stream/onStreamFlagged","video-streaming.didFlag",(t=>{Uo(t),e(t.videoStreamings[0])}))},cm=e=>{const t=ve();return Xe(t,"stream/onStreamTerminated","video-streaming.didTerminate",(t=>{Uo(t),e(t.videoStreamings[0])}))},dm=(e,t)=>zu(e,(e=>{const{data:n}=e;t(Object.assign(Object.assign({},e),{data:n?yl.stream(e.data):n}))}),"streamId",sm,[om,im,am,lm,cm]);dm.locally=e=>{const t=ve();if(t.log("stream/getStreamById",e),!t.cache)return;const n=Se(["stream","get",e]);return n?{data:yl.stream(n.data),cachedAt:n.cachedAt}:void 0};class um extends Mu{async getRequest(e,t){const{limit:n=f}=e,r=Bo(e,["limit"]),s=t?{token:t}:{limit:n},{data:i}=await this.http.get("/api/v3/video-streaming",{params:Object.assign(Object.assign({},r),{options:s})});return Object.assign(Object.assign({},i.results),{paging:i.paging})}}class hm extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.paginationController=r}saveToMainDB(e){const t=ve(),n=t.cache&&Date.now();t.cache&&Uo(e,{cachedAt:n})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.videoStreamings.map(de("stream")),query:this.query});else{const n=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,i=null!==(s=null==n?void 0:n.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},n),{data:"next"===t?[...new Set([...i,...e.videoStreamings.map(de("stream"))])]:[...new Set([...e.videoStreamings.map(de("stream")),...i])]}))}}reactor(e){return e=>{var t;const n=null===(t=Se(this.cacheKey))||void 0===t?void 0:t.data;n&&(n.data=[...new Set([e.streamId,...n.data])],Ce(this.cacheKey,n),this.notifyChange({origin:"event",loading:!1}))}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}class fm extends ju{constructor(e,t){const n=Pu(e),r=["streams","collection",n],s=new um(e);super(s,n,r,t),this.applyFilter=e=>{let t=ke(e,"isDeleted",this.query.isDeleted);return t=t.sort("lastCreated"===this.query.sortBy?Ne:Fe),t},this.query=e,this.queryStreamController=new hm(this.query,this.cacheKey,this.notifyChange.bind(this),s),this.paginationController=s,this.callback=t.bind(this),this.loadPage({initial:!0})}notifyChange({origin:e,loading:t,error:n}){var r;const s=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!s)return;let i=s.data.map((e=>Se(["stream","get",e]))).filter(Boolean).map((e=>yl.stream(e.data)));(this.shouldNotify(i)||"event"!==e)&&(i=this.applyFilter(i),this.callback({onNextPage:()=>this.loadPage({initial:!1,direction:"next"}),data:i,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n}))}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:om,action:"onStreamRecorded"},{fn:im,action:"onStreamStarted"},{fn:am,action:"onStreamStopped"},{fn:lm,action:"onStreamFlagged"},{fn:cm,action:"onStreamTerminated"}])}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}persistModel(e){this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}}var pm=Object.freeze({__proto__:null,createStream:async e=>{const t=ve();t.log("stream/createStream",e);const{data:n}=await t.http.post("/api/v3/video-streaming",e),r=t.cache&&Date.now();t.cache&&Uo(n,{cachedAt:r});const{videoStreamings:s}=n;return{data:yl.stream(s[0]),cachedAt:r}},updateStream:async(e,t)=>{const n=ve();n.log("stream/updateStream",e,t);const{data:r}=await n.http.put(`/api/v3/video-streaming/${e}`,t),s=n.cache&&Date.now();n.cache&&Uo(r,{cachedAt:s});const{videoStreamings:i}=r;return{data:yl.stream(i.find((t=>t.streamId===e))),cachedAt:s}},deleteStream:async e=>{const t=ve();t.log("stream/deleteStream",e);const n=await sm(e),{data:r}=await t.http.delete(`/api/v3/video-streaming/${e}`),{success:s}=r,i=Object.assign(Object.assign({},n.data),{isDeleted:!0});return Ee(["stream","get",e],i),s},disposeStream:async e=>{const t=ve();t.log("stream/disposeStream",e);const{data:n}=await t.http.delete(`/api/v3/video-streaming/${e}/streaming-url`),r=t.cache&&Date.now();t.cache&&Uo(n,{cachedAt:r});const{videoStreamings:s}=n;return{data:s.find((t=>t.streamId===e)),cachedAt:r}},onStreamStarted:im,onStreamStopped:am,onStreamRecorded:om,onStreamFlagged:lm,onStreamTerminated:cm,getStreamById:dm,getStreams:(e,t,n)=>{const{log:r,cache:s,userId:i}=ve();s||console.log(g);const a=Date.now();r(`getStreams(tmpid: ${a}) > listen`);const o=new fm(e,t),l=o.startSubscription(),c=o.getCacheKey();return l.push((()=>{Ie(c)})),()=>{r(`getStreams(tmpid: ${a}) > dispose`),l.forEach((e=>e()))}}});const gm=async e=>{const t=ve();t.log("poll/getPoll",e);const{data:n}=await t.http.get(`/api/v3/polls/${e}`),r=t.cache&&Date.now();t.cache&&Uo(n,{cachedAt:r});const{polls:s}=n;return{data:s.find((t=>t.pollId===e)),cachedAt:r}};gm.locally=e=>{const t=ve();if(t.log("poll/getPoll",e),!t.cache)return;const n=Se(["poll","get",e]);return n?{data:n.data,cachedAt:n.cachedAt}:void 0};const mm=e=>{const t=ve();return Xe(t,"poll/onPollUpdated","poll.updated",(n=>{t.cache&&Uo(n),e(n.polls[0])}))},ym=e=>{const t=ve();return Xe(t,"poll/onPollDeleted","poll.deleted",(n=>{t.cache&&Uo(n),e(n.polls[0])}))};var vm=Object.freeze({__proto__:null,createPoll:async e=>{const t=ve();t.log("post/createPoll",e);const{data:n}=await t.http.post("/api/v3/polls",e),r=t.cache&&Date.now();t.cache&&Uo(n,{cachedAt:r});const{polls:s}=n;return{data:s[0],cachedAt:r}},closePoll:async e=>{const t=ve();t.log("user/closePoll",e);const{data:n}=await t.http.put(`/api/v3/polls/${encodeURIComponent(e)}`,{status:"closed"}),r=t.cache&&Date.now();t.cache&&Uo(n,{cachedAt:r}),Je("poll.updated",n);const{polls:s}=n;return{data:s.find((t=>t.pollId===e)),cachedAt:r}},deletePoll:async e=>{const t=ve();t.log("poll/deletePoll",e);const n=await gm(e),{data:r}=await t.http.delete(`/api/v3/polls/${e}`),{success:s}=r,i=Object.assign(Object.assign({},n.data),{isDeleted:!0});return Ee(["poll","get",e],i),Je("poll.deleted",{polls:[i],users:[]}),s},votePoll:async(e,t)=>{const n=ve();n.log("user/votePoll",e);const{data:r}=await n.http.post(`/api/v3/polls/${encodeURIComponent(e)}/votes`,{pollId:e,answerIds:t}),s=n.cache&&Date.now();n.cache&&Uo(r,{cachedAt:s});const{polls:i}=r;return Je("poll.updated",r),{data:i.find((t=>t.pollId===e)),cachedAt:s}},onPollUpdated:mm,onPollDeleted:ym,getPoll:(e,t)=>zu(e,t,"pollId",gm,[mm,ym])});function bm(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var wm={exports:{}};!function(e,t){var n,r,s,i,a;n=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,r=/^(?=([^\/?#]*))\1([^]*)$/,s=/(?:\/|^)\.(?=\/)/g,i=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(e,t,n){if(n=n||{},e=e.trim(),!(t=t.trim())){if(!n.alwaysNormalize)return e;var s=a.parseURL(e);if(!s)throw new Error("Error trying to parse base URL.");return s.path=a.normalizePath(s.path),a.buildURLFromParts(s)}var i=a.parseURL(t);if(!i)throw new Error("Error trying to parse relative URL.");if(i.scheme)return n.alwaysNormalize?(i.path=a.normalizePath(i.path),a.buildURLFromParts(i)):t;var o=a.parseURL(e);if(!o)throw new Error("Error trying to parse base URL.");if(!o.netLoc&&o.path&&"/"!==o.path[0]){var l=r.exec(o.path);o.netLoc=l[1],o.path=l[2]}o.netLoc&&!o.path&&(o.path="/");var c={scheme:o.scheme,netLoc:i.netLoc,path:null,params:i.params,query:i.query,fragment:i.fragment};if(!i.netLoc&&(c.netLoc=o.netLoc,"/"!==i.path[0]))if(i.path){var d=o.path,u=d.substring(0,d.lastIndexOf("/")+1)+i.path;c.path=a.normalizePath(u)}else c.path=o.path,i.params||(c.params=o.params,i.query||(c.query=o.query));return null===c.path&&(c.path=n.alwaysNormalize?a.normalizePath(i.path):i.path),a.buildURLFromParts(c)},parseURL:function(e){var t=n.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(s,"");e.length!==(e=e.replace(i,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}},e.exports=a}(wm);var Sm=wm.exports;function Cm(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Tm(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Cm(Object(n),!0).forEach((function(t){Em(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Cm(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Em(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Im(){return Im=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},Im.apply(this,arguments)}const km=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)};let Am=function(e){return e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.BUFFER_RESET="hlsBufferReset",e.BUFFER_CODECS="hlsBufferCodecs",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_EOS="hlsBufferEos",e.BUFFER_FLUSHING="hlsBufferFlushing",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_UPDATED="hlsLevelsUpdated",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.CUES_PARSED="hlsCuesParsed",e.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_LOADING="hlsKeyLoading",e.KEY_LOADED="hlsKeyLoaded",e.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",e.BACK_BUFFER_REACHED="hlsBackBufferReached",e}({}),_m=function(e){return e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e}({}),Rm=function(e){return e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",e.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",e.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",e.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_PARSING_ERROR="levelParsingError",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.FRAG_GAP="fragGap",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.INTERNAL_EXCEPTION="internalException",e.INTERNAL_ABORTED="aborted",e.UNKNOWN="unknown",e}({});const Om=function(){},Lm={trace:Om,debug:Om,log:Om,warn:Om,info:Om,error:Om};let Dm=Lm;function xm(e,...t){t.forEach((function(t){Dm[t]=e[t]?e[t].bind(e):function(e){const t=self.console[e];return t?t.bind(self.console,`[${e}] >`):Om}(t)}))}const Pm=Dm,Mm=/^(\d+)x(\d+)$/,Fm=/(.+?)=(".*?"|.*?)(?:,|$)/g;class Um{constructor(e){"string"==typeof e&&(e=Um.parseAttrList(e));for(const t in e)e.hasOwnProperty(t)&&("X-"===t.substring(0,2)&&(this.clientAttrs=this.clientAttrs||[],this.clientAttrs.push(t)),this[t]=e[t])}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const n=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)n[e]=parseInt(t.slice(2*e,2*e+2),16);return n}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const n=this[e];return n?parseFloat(n):t}enumeratedString(e){return this[e]}bool(e){return"YES"===this[e]}decimalResolution(e){const t=Mm.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t;const n={};for(Fm.lastIndex=0;null!==(t=Fm.exec(e));){let e=t[2];0===e.indexOf('"')&&e.lastIndexOf('"')===e.length-1&&(e=e.slice(1,-1));n[t[1].trim()]=e}return n}}function Nm(e){return"SCTE35-OUT"===e||"SCTE35-IN"===e}class Bm{constructor(e,t){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,t){const n=t.attr;for(const t in n)if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]!==n[t]){Pm.warn(`DATERANGE tag attribute: "${t}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=t;break}e=Im(new Um({}),n,e)}if(this.attr=e,this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const e=new Date(this.attr["END-DATE"]);km(e.getTime())&&(this._endDate=e)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const e=this.duration;return null!==e?new Date(this._startDate.getTime()+1e3*e):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(km(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&km(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class jm{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var $m="audio",qm="video",Km="audiovideo";class Gm{constructor(e){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[$m]:null,[qm]:null,[Km]:null},this.baseurl=e}setByteRange(e,t){const n=e.split("@",2),r=[];1===n.length?r[0]=t?t.byteRangeEndOffset:0:r[0]=parseInt(n[1]),r[1]=parseInt(n[0])+r[0],this._byteRange=r}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Sm.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}}class Hm extends Gm{constructor(e,t){super(t),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new jm,this.urlId=0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.type=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{const e=Object.keys(this.levelkeys);if(1===e.length)return this._decryptdata=this.levelkeys[e[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;if(!km(this.programDateTime))return null;const e=km(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){var e;if(null!=(e=this._decryptdata)&&e.encrypted)return!0;if(this.levelkeys){const e=Object.keys(this.levelkeys),t=e.length;if(t>1||1===t&&this.levelkeys[e[0]].encrypted)return!0}return!1}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;null==(e=this.loader)||e.abort(),null==(t=this.keyLoader)||t.abort()}setElementaryStreamInfo(e,t,n,r,s,i=!1){const{elementaryStreams:a}=this,o=a[e];o?(o.startPTS=Math.min(o.startPTS,t),o.endPTS=Math.max(o.endPTS,n),o.startDTS=Math.min(o.startDTS,r),o.endDTS=Math.max(o.endDTS,s)):a[e]={startPTS:t,endPTS:n,startDTS:r,endDTS:s,partial:i}}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[$m]=null,e[qm]=null,e[Km]=null}}class Vm extends Gm{constructor(e,t,n,r,s){super(n),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new jm,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=r;const i=e.enumeratedString("BYTERANGE");i&&this.setByteRange(i,s),s&&(this.fragOffset=s.fragOffset+s.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}class zm{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e)return this.advanced=!0,void(this.updated=!0);const t=this.lastPartSn-e.lastPartSn,n=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!n||!!t,this.advanced=this.endSN>e.endSN||t>0||0===t&&n>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&km(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){const e=this.driftEndTime-this.driftStartTime;if(e>0){return 1e3*(this.driftEnd-this.driftStart)/e}return 1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function Wm(e){return Uint8Array.from(atob(e),(e=>e.charCodeAt(0)))}function Ym(e){const t=e.split(":");let n=null;if("data"===t[0]&&2===t.length){const e=t[1].split(";"),r=e[e.length-1].split(",");if(2===r.length){const t="base64"===r[0],s=r[1];t?(e.splice(-1,1),n=Wm(s)):n=function(e){const t=Qm(e).subarray(0,16),n=new Uint8Array(16);return n.set(t,16-t.length),n}(s)}}return n}function Qm(e){return Uint8Array.from(unescape(encodeURIComponent(e)),(e=>e.charCodeAt(0)))}var Xm={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Jm="org.w3.clearkey",Zm="com.apple.streamingkeydelivery",ey="com.microsoft.playready",ty="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";function ny(e){switch(e){case Zm:return Xm.FAIRPLAY;case ey:return Xm.PLAYREADY;case ty:return Xm.WIDEVINE;case Jm:return Xm.CLEARKEY}}var ry="edef8ba979d64acea3c827dcd51d21ed";function sy(e){switch(e){case Xm.FAIRPLAY:return Zm;case Xm.PLAYREADY:return ey;case Xm.WIDEVINE:return ty;case Xm.CLEARKEY:return Jm}}function iy(e){const{drmSystems:t,widevineLicenseUrl:n}=e,r=t?[Xm.FAIRPLAY,Xm.WIDEVINE,Xm.PLAYREADY,Xm.CLEARKEY].filter((e=>!!t[e])):[];return!r[Xm.WIDEVINE]&&n&&r.push(Xm.WIDEVINE),r}const ay="undefined"!=typeof self&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;function oy(e,t,n){return Uint8Array.prototype.slice?e.slice(t,n):new Uint8Array(Array.prototype.slice.call(e,t,n))}const ly=(e,t)=>t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,cy=(e,t)=>t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,dy=(e,t)=>{const n=t;let r=0;for(;ly(e,t);){r+=10;r+=uy(e,t+6),cy(e,t+10)&&(r+=10),t+=r}if(r>0)return e.subarray(n,n+r)},uy=(e,t)=>{let n=0;return n=(127&e[t])<<21,n|=(127&e[t+1])<<14,n|=(127&e[t+2])<<7,n|=127&e[t+3],n},hy=(e,t)=>ly(e,t)&&uy(e,t+6)+10<=e.length-t,fy=e=>e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info,py=e=>{const t=String.fromCharCode(e[0],e[1],e[2],e[3]),n=uy(e,4);return{type:t,size:n,data:e.subarray(10,10+n)}},gy=e=>{let t=0;const n=[];for(;ly(e,t);){const r=uy(e,t+6);t+=10;const s=t+r;for(;t+8<s;){const r=py(e.subarray(t)),s=my(r);s&&n.push(s),t+=r.size+10}cy(e,t)&&(t+=10)}return n},my=e=>"PRIV"===e.type?yy(e):"W"===e.type[0]?by(e):vy(e),yy=e=>{if(e.size<2)return;const t=Sy(e.data,!0),n=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:n.buffer}},vy=e=>{if(e.size<2)return;if("TXXX"===e.type){let t=1;const n=Sy(e.data.subarray(t),!0);t+=n.length+1;const r=Sy(e.data.subarray(t));return{key:e.type,info:n,data:r}}const t=Sy(e.data.subarray(1));return{key:e.type,data:t}},by=e=>{if("WXXX"===e.type){if(e.size<2)return;let t=1;const n=Sy(e.data.subarray(t),!0);t+=n.length+1;const r=Sy(e.data.subarray(t));return{key:e.type,info:n,data:r}}const t=Sy(e.data);return{key:e.type,data:t}},wy=e=>{if(8===e.data.byteLength){const t=new Uint8Array(e.data),n=1&t[3];let r=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return r/=45,n&&(r+=47721858.84),Math.round(r)}},Sy=(e,t=!1)=>{const n=Ty();if(n){const r=n.decode(e);if(t){const e=r.indexOf("\0");return-1!==e?r.substring(0,e):r}return r.replace(/\0/g,"")}const r=e.length;let s,i,a,o="",l=0;for(;l<r;){if(s=e[l++],0===s&&t)return o;if(0!==s&&3!==s)switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(s);break;case 12:case 13:i=e[l++],o+=String.fromCharCode((31&s)<<6|63&i);break;case 14:i=e[l++],a=e[l++],o+=String.fromCharCode((15&s)<<12|(63&i)<<6|(63&a)<<0)}}return o};let Cy;function Ty(){return Cy||void 0===self.TextDecoder||(Cy=new self.TextDecoder("utf-8")),Cy}const Ey=function(e){let t="";for(let n=0;n<e.length;n++){let r=e[n].toString(16);r.length<2&&(r="0"+r),t+=r}return t},Iy=Math.pow(2,32)-1,ky=[].push,Ay={video:1,audio:2,id3:3,text:4};function _y(e){return String.fromCharCode.apply(null,e)}function Ry(e,t){const n=e[t]<<8|e[t+1];return n<0?65536+n:n}function Oy(e,t){const n=Ly(e,t);return n<0?4294967296+n:n}function Ly(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function Dy(e,t,n){e[t]=n>>24,e[t+1]=n>>16&255,e[t+2]=n>>8&255,e[t+3]=255&n}function xy(e,t){const n=[];if(!t.length)return n;const r=e.byteLength;for(let s=0;s<r;){const i=Oy(e,s),a=i>1?s+i:r;if(_y(e.subarray(s+4,s+8))===t[0])if(1===t.length)n.push(e.subarray(s+8,a));else{const r=xy(e.subarray(s+8,a),t.slice(1));r.length&&ky.apply(n,r)}s=a}return n}function Py(e){const t=[],n=e[0];let r=8;const s=Oy(e,r);r+=4;r+=0===n?8:16,r+=2;let i=e.length+0;const a=Ry(e,r);r+=2;for(let n=0;n<a;n++){let n=r;const a=Oy(e,n);n+=4;const o=2147483647&a;if(1===(2147483648&a)>>>31)return Pm.warn("SIDX has hierarchical references (not supported)"),null;const l=Oy(e,n);n+=4,t.push({referenceSize:o,subsegmentDuration:l,info:{duration:l/s,start:i,end:i+o-1}}),i+=o,n+=4,r=n}return{earliestPresentationTime:0,timescale:s,version:n,referencesCount:a,references:t}}function My(e){const t=[],n=xy(e,["moov","trak"]);for(let e=0;e<n.length;e++){const r=n[e],s=xy(r,["tkhd"])[0];if(s){let e=s[0],n=0===e?12:20;const i=Oy(s,n),a=xy(r,["mdia","mdhd"])[0];if(a){e=a[0],n=0===e?12:20;const s=Oy(a,n),o=xy(r,["mdia","hdlr"])[0];if(o){const e=_y(o.subarray(8,12)),n={soun:$m,vide:qm}[e];if(n){const e=xy(r,["mdia","minf","stbl","stsd"])[0];let a;e&&(a=_y(e.subarray(12,16))),t[i]={timescale:s,type:n},t[n]={timescale:s,id:i,codec:a}}}}}}return xy(e,["moov","mvex","trex"]).forEach((e=>{const n=Oy(e,4),r=t[n];r&&(r.default={duration:Oy(e,12),flags:Oy(e,20)})})),t}function Fy(e){const t=xy(e,["schm"])[0];if(t){const n=_y(t.subarray(4,8));if("cbcs"===n||"cenc"===n)return xy(e,["schi","tenc"])[0]}return Pm.error("[eme] missing 'schm' box"),null}function Uy(e){const t=Oy(e,0);let n=8;1&t&&(n+=4),4&t&&(n+=4);let r=0;const s=Oy(e,4);for(let i=0;i<s;i++){if(256&t){r+=Oy(e,n),n+=4}512&t&&(n+=4),1024&t&&(n+=4),2048&t&&(n+=4)}return r}function Ny(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}function By(e,t){const n=[],r=t.samples,s=t.timescale,i=t.id;let a=!1;return xy(r,["moof"]).map((o=>{const l=o.byteOffset-8;xy(o,["traf"]).map((o=>{const c=xy(o,["tfdt"]).map((e=>{const t=e[0];let n=Oy(e,4);return 1===t&&(n*=Math.pow(2,32),n+=Oy(e,8)),n/s}))[0];return void 0!==c&&(e=c),xy(o,["tfhd"]).map((c=>{const d=Oy(c,4),u=16777215&Oy(c,0);let h=0;const f=0!=(16&u);let p=0;const g=0!=(32&u);let m=8;d===i&&(0!=(1&u)&&(m+=8),0!=(2&u)&&(m+=4),0!=(8&u)&&(h=Oy(c,m),m+=4),f&&(p=Oy(c,m),m+=4),g&&(m+=4),"video"===t.type&&(a=function(e){if(!e)return!1;const t=e.indexOf("."),n=t<0?e:e.substring(0,t);return"hvc1"===n||"hev1"===n||"dvh1"===n||"dvhe"===n}(t.codec)),xy(o,["trun"]).map((i=>{const o=i[0],c=16777215&Oy(i,0),d=0!=(1&c);let u=0;const f=0!=(4&c),g=0!=(256&c);let m=0;const y=0!=(512&c);let v=0;const b=0!=(1024&c),w=0!=(2048&c);let S=0;const C=Oy(i,4);let T=8;d&&(u=Oy(i,T),T+=4),f&&(T+=4);let E=u+l;for(let l=0;l<C;l++){if(g?(m=Oy(i,T),T+=4):m=h,y?(v=Oy(i,T),T+=4):v=p,b&&(T+=4),w&&(S=0===o?Oy(i,T):Ly(i,T),T+=4),t.type===qm){let t=0;for(;t<v;){const i=Oy(r,E);if(E+=4,jy(a,r[E])){$y(r.subarray(E,E+i),a?2:1,e+S/s,n)}E+=i,t+=i+4}}e+=m/s}})))}))}))})),n}function jy(e,t){if(e){const e=t>>1&63;return 39===e||40===e}return 6===(31&t)}function $y(e,t,n,r){const s=qy(e);let i=0;i+=t;let a=0,o=0,l=!1,c=0;for(;i<s.length;){a=0;do{if(i>=s.length)break;c=s[i++],a+=c}while(255===c);o=0;do{if(i>=s.length)break;c=s[i++],o+=c}while(255===c);const e=s.length-i;if(!l&&4===a&&i<s.length){l=!0;if(181===s[i++]){const e=Ry(s,i);if(i+=2,49===e){const e=Oy(s,i);if(i+=4,1195456820===e){const e=s[i++];if(3===e){const t=s[i++],o=31&t,l=64&t,c=l?2+3*o:0,d=new Uint8Array(c);if(l){d[0]=t;for(let e=1;e<c;e++)d[e]=s[i++]}r.push({type:e,payloadType:a,pts:n,bytes:d})}}}}}else if(5===a&&o<e){if(l=!0,o>16){const e=[];for(let t=0;t<16;t++){const n=s[i++].toString(16);e.push(1==n.length?"0"+n:n),3!==t&&5!==t&&7!==t&&9!==t||e.push("-")}const t=o-16,l=new Uint8Array(t);for(let e=0;e<t;e++)l[e]=s[i++];r.push({payloadType:a,pts:n,uuid:e.join(""),userData:Sy(l),userDataBytes:l})}}else if(o<e)i+=o;else if(o>e)break}}function qy(e){const t=e.byteLength,n=[];let r=1;for(;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(n.push(r+2),r+=2):r++;if(0===n.length)return e;const s=t-n.length,i=new Uint8Array(s);let a=0;for(r=0;r<s;a++,r++)a===n[0]&&(a++,n.shift()),i[r]=e[a];return i}function Ky(e,t,n){if(16!==e.byteLength)throw new RangeError("Invalid system id");let r,s,i;if(t){r=1,s=new Uint8Array(16*t.length);for(let e=0;e<t.length;e++){const n=t[e];if(16!==n.byteLength)throw new RangeError("Invalid key");s.set(n,16*e)}}else r=0,s=new Uint8Array;r>0?(i=new Uint8Array(4),t.length>0&&new DataView(i.buffer).setUint32(0,t.length,!1)):i=new Uint8Array;const a=new Uint8Array(4);return n&&n.byteLength>0&&new DataView(a.buffer).setUint32(0,n.byteLength,!1),function(e,...t){const n=t.length;let r=8,s=n;for(;s--;)r+=t[s].byteLength;const i=new Uint8Array(r);for(i[0]=r>>24&255,i[1]=r>>16&255,i[2]=r>>8&255,i[3]=255&r,i.set(e,4),s=0,r=8;s<n;s++)i.set(t[s],r),r+=t[s].byteLength;return i}([112,115,115,104],new Uint8Array([r,0,0,0]),e,i,s,a,n||new Uint8Array)}let Gy={};class Hy{static clearKeyUriToKeyIdMap(){Gy={}}constructor(e,t,n,r=[1],s=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=n,this.keyFormatVersions=r,this.iv=s,this.encrypted=!!e&&"NONE"!==e,this.isCommonEncryption=this.encrypted&&"AES-128"!==e}isSupported(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case Zm:case ty:case ey:case Jm:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof e&&("AES-128"!==this.method||this.iv||Pm.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const t=function(e){const t=new Uint8Array(16);for(let n=12;n<16;n++)t[n]=e>>8*(15-n)&255;return t}(e);return new Hy(this.method,this.uri,"identity",this.keyFormatVersions,t)}const t=Ym(this.uri);if(t)switch(this.keyFormat){case ty:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case ey:{const e=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Ky(e,null,t);const n=new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2),r=String.fromCharCode.apply(null,Array.from(n)),s=r.substring(r.indexOf("<"),r.length),i=(new DOMParser).parseFromString(s,"text/xml").getElementsByTagName("KID")[0];if(i){const e=i.childNodes[0]?i.childNodes[0].nodeValue:i.getAttribute("VALUE");if(e){const t=Wm(e).subarray(0,16);!function(e){const t=function(e,t,n){const r=e[t];e[t]=e[n],e[n]=r};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}(t),this.keyId=t}}break}default:{let e=t.subarray(0,16);if(16!==e.length){const t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=Gy[this.uri];if(!e){const t=Object.keys(Gy).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16);new DataView(e.buffer,12,4).setUint32(0,t),Gy[this.uri]=e}this.keyId=e}return this}}const Vy=/\{\$([a-zA-Z0-9-_]+)\}/g;function zy(e){return Vy.test(e)}function Wy(e,t,n){if(null!==e.variableList||e.hasVariableRefs)for(let r=n.length;r--;){const s=n[r],i=t[s];i&&(t[s]=Yy(e,i))}}function Yy(e,t){if(null!==e.variableList||e.hasVariableRefs){const n=e.variableList;return t.replace(Vy,(t=>{const r=t.substring(2,t.length-1),s=null==n?void 0:n[r];return void 0===s?(e.playlistParsingError||(e.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${r}"`)),t):s}))}return t}function Qy(e,t,n){let r,s,i=e.variableList;if(i||(e.variableList=i={}),"QUERYPARAM"in t){r=t.QUERYPARAM;try{const e=new self.URL(n).searchParams;if(!e.has(r))throw new Error(`"${r}" does not match any query parameter in URI: "${n}"`);s=e.get(r)}catch(t){e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${t.message}`))}}else r=t.NAME,s=t.VALUE;r in i?e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${r}"`)):i[r]=s||""}function Xy(e,t,n){const r=t.IMPORT;if(n&&r in n){let t=e.variableList;t||(e.variableList=t={}),t[r]=n[r]}else e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${r}"`))}function Jy(){if("undefined"!=typeof self)return self.MediaSource||self.WebKitMediaSource}const Zy={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dva1:!0,dvav:!0,dvh1:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}},ev=Jy();function tv(e,t){var n;return null!=(n=null==ev?void 0:ev.isTypeSupported(`${t||"video"}/mp4;codecs="${e}"`))&&n}const nv=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,rv=/#EXT-X-MEDIA:(.*)/g,sv=/^#EXT(?:INF|-X-TARGETDURATION):/m,iv=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),av=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class ov{static findGroup(e,t){for(let n=0;n<e.length;n++){const r=e[n];if(r.id===t)return r}}static convertAVC1ToAVCOTI(e){const t=e.split(".");if(t.length>2){let e=t.shift()+".";return e+=parseInt(t.shift()).toString(16),e+=("000"+parseInt(t.shift()).toString(16)).slice(-4),e}return e}static resolve(e,t){return Sm.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return sv.test(e)}static parseMasterPlaylist(e,t){const n={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:zy(e)},r=[];let s;for(nv.lastIndex=0;null!=(s=nv.exec(e));)if(s[1]){var i;const e=new Um(s[1]);Wy(n,e,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const a=Yy(n,s[2]),o={attrs:e,bitrate:e.decimalInteger("AVERAGE-BANDWIDTH")||e.decimalInteger("BANDWIDTH"),name:e.NAME,url:ov.resolve(a,t)},l=e.decimalResolution("RESOLUTION");l&&(o.width=l.width,o.height=l.height),dv((e.CODECS||"").split(/[ ,]+/).filter((e=>e)),o),o.videoCodec&&-1!==o.videoCodec.indexOf("avc1")&&(o.videoCodec=ov.convertAVC1ToAVCOTI(o.videoCodec)),null!=(i=o.unknownCodecs)&&i.length||r.push(o),n.levels.push(o)}else if(s[3]){const e=s[3],r=s[4];switch(e){case"SESSION-DATA":{const e=new Um(r);Wy(n,e,["DATA-ID","LANGUAGE","VALUE","URI"]);const t=e["DATA-ID"];t&&(null===n.sessionData&&(n.sessionData={}),n.sessionData[t]=e);break}case"SESSION-KEY":{const e=lv(r,t,n);e.encrypted&&e.isSupported()?(null===n.sessionKeys&&(n.sessionKeys=[]),n.sessionKeys.push(e)):Pm.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${r}"`);break}case"DEFINE":{const e=new Um(r);Wy(n,e,["NAME","VALUE","QUERYPARAM"]),Qy(n,e,t)}break;case"CONTENT-STEERING":{const e=new Um(r);Wy(n,e,["SERVER-URI","PATHWAY-ID"]),n.contentSteering={uri:ov.resolve(e["SERVER-URI"],t),pathwayId:e["PATHWAY-ID"]||"."};break}case"START":n.startTimeOffset=cv(r)}}const a=r.length>0&&r.length<n.levels.length;return n.levels=a?r:n.levels,0===n.levels.length&&(n.playlistParsingError=new Error("no levels found in manifest")),n}static parseMasterPlaylistMedia(e,t,n){let r;const s={},i=n.levels,a={AUDIO:i.map((e=>({id:e.attrs.AUDIO,audioCodec:e.audioCodec}))),SUBTITLES:i.map((e=>({id:e.attrs.SUBTITLES,textCodec:e.textCodec}))),"CLOSED-CAPTIONS":[]};let o=0;for(rv.lastIndex=0;null!==(r=rv.exec(e));){const e=new Um(r[1]),i=e.TYPE;if(i){const r=a[i],l=s[i]||[];s[i]=l,Wy(n,e,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const c={attrs:e,bitrate:0,id:o++,groupId:e["GROUP-ID"]||"",instreamId:e["INSTREAM-ID"],name:e.NAME||e.LANGUAGE||"",type:i,default:e.bool("DEFAULT"),autoselect:e.bool("AUTOSELECT"),forced:e.bool("FORCED"),lang:e.LANGUAGE,url:e.URI?ov.resolve(e.URI,t):""};if(null!=r&&r.length){const e=ov.findGroup(r,c.groupId)||r[0];uv(c,e,"audioCodec"),uv(c,e,"textCodec")}l.push(c)}}return s}static parseLevelPlaylist(e,t,n,r,s,i){const a=new zm(t),o=a.fragments;let l,c,d,u=null,h=0,f=0,p=0,g=0,m=null,y=new Hm(r,t),v=-1,b=!1;for(iv.lastIndex=0,a.m3u8=e,a.hasVariableRefs=zy(e);null!==(l=iv.exec(e));){b&&(b=!1,y=new Hm(r,t),y.start=p,y.sn=h,y.cc=g,y.level=n,u&&(y.initSegment=u,y.rawProgramDateTime=u.rawProgramDateTime,u.rawProgramDateTime=null));const e=l[1];if(e){y.duration=parseFloat(e);const t=(" "+l[2]).slice(1);y.title=t||null,y.tagList.push(t?["INF",e,t]:["INF",e])}else if(l[3]){if(km(y.duration)){y.start=p,d&&pv(y,d,a),y.sn=h,y.level=n,y.cc=g,y.urlId=s,o.push(y);const e=(" "+l[3]).slice(1);y.relurl=Yy(a,e),hv(y,m),m=y,p+=y.duration,h++,f=0,b=!0}}else if(l[4]){const e=(" "+l[4]).slice(1);m?y.setByteRange(e,m):y.setByteRange(e)}else if(l[5])y.rawProgramDateTime=(" "+l[5]).slice(1),y.tagList.push(["PROGRAM-DATE-TIME",y.rawProgramDateTime]),-1===v&&(v=o.length);else{if(l=l[0].match(av),!l){Pm.warn("No matches on slow regex match for level playlist!");continue}for(c=1;c<l.length&&void 0===l[c];c++);const e=(" "+l[c]).slice(1),s=(" "+l[c+1]).slice(1),p=l[c+2]?(" "+l[c+2]).slice(1):"";switch(e){case"PLAYLIST-TYPE":a.type=s.toUpperCase();break;case"MEDIA-SEQUENCE":h=a.startSN=parseInt(s);break;case"SKIP":{const e=new Um(s);Wy(a,e,["RECENTLY-REMOVED-DATERANGES"]);const t=e.decimalInteger("SKIPPED-SEGMENTS");if(km(t)){a.skippedSegments=t;for(let e=t;e--;)o.unshift(null);h+=t}const n=e.enumeratedString("RECENTLY-REMOVED-DATERANGES");n&&(a.recentlyRemovedDateranges=n.split("\t"));break}case"TARGETDURATION":a.targetduration=Math.max(parseInt(s),1);break;case"VERSION":a.version=parseInt(s);break;case"EXTM3U":break;case"ENDLIST":a.live=!1;break;case"#":(s||p)&&y.tagList.push(p?[s,p]:[s]);break;case"DISCONTINUITY":g++,y.tagList.push(["DIS"]);break;case"GAP":y.gap=!0,y.tagList.push([e]);break;case"BITRATE":y.tagList.push([e,s]);break;case"DATERANGE":{const e=new Um(s);Wy(a,e,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),Wy(a,e,e.clientAttrs);const t=new Bm(e,a.dateRanges[e.ID]);t.isValid||a.skippedSegments?a.dateRanges[t.id]=t:Pm.warn(`Ignoring invalid DATERANGE tag: "${s}"`),y.tagList.push(["EXT-X-DATERANGE",s]);break}case"DEFINE":{const e=new Um(s);Wy(a,e,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in e?Xy(a,e,i):Qy(a,e,t)}break;case"DISCONTINUITY-SEQUENCE":g=parseInt(s);break;case"KEY":{const e=lv(s,t,a);if(e.isSupported()){if("NONE"===e.method){d=void 0;break}d||(d={}),d[e.keyFormat]&&(d=Im({},d)),d[e.keyFormat]=e}else Pm.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${s}"`);break}case"START":a.startTimeOffset=cv(s);break;case"MAP":{const e=new Um(s);if(Wy(a,e,["BYTERANGE","URI"]),y.duration){const s=new Hm(r,t);fv(s,e,n,d),u=s,y.initSegment=u,u.rawProgramDateTime&&!y.rawProgramDateTime&&(y.rawProgramDateTime=u.rawProgramDateTime)}else fv(y,e,n,d),u=y,b=!0;break}case"SERVER-CONTROL":{const e=new Um(s);a.canBlockReload=e.bool("CAN-BLOCK-RELOAD"),a.canSkipUntil=e.optionalFloat("CAN-SKIP-UNTIL",0),a.canSkipDateRanges=a.canSkipUntil>0&&e.bool("CAN-SKIP-DATERANGES"),a.partHoldBack=e.optionalFloat("PART-HOLD-BACK",0),a.holdBack=e.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const e=new Um(s);a.partTarget=e.decimalFloatingPoint("PART-TARGET");break}case"PART":{let e=a.partList;e||(e=a.partList=[]);const n=f>0?e[e.length-1]:void 0,r=f++,i=new Um(s);Wy(a,i,["BYTERANGE","URI"]);const o=new Vm(i,y,t,r,n);e.push(o),y.duration+=o.duration;break}case"PRELOAD-HINT":{const e=new Um(s);Wy(a,e,["URI"]),a.preloadHint=e;break}case"RENDITION-REPORT":{const e=new Um(s);Wy(a,e,["URI"]),a.renditionReports=a.renditionReports||[],a.renditionReports.push(e);break}default:Pm.warn(`line parsed but not handled: ${l}`)}}}m&&!m.relurl?(o.pop(),p-=m.duration,a.partList&&(a.fragmentHint=m)):a.partList&&(hv(y,m),y.cc=g,a.fragmentHint=y,d&&pv(y,d,a));const w=o.length,S=o[0],C=o[w-1];if(p+=a.skippedSegments*a.targetduration,p>0&&w&&C){a.averagetargetduration=p/w;const e=C.sn;a.endSN="initSegment"!==e?e:0,a.live||(C.endList=!0),S&&(a.startCC=S.cc)}else a.endSN=0,a.startCC=0;return a.fragmentHint&&(p+=a.fragmentHint.duration),a.totalduration=p,a.endCC=g,v>0&&function(e,t){let n=e[t];for(let r=t;r--;){const t=e[r];if(!t)return;t.programDateTime=n.programDateTime-1e3*t.duration,n=t}}(o,v),a}}function lv(e,t,n){var r,s;const i=new Um(e);Wy(n,i,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const a=null!=(r=i.METHOD)?r:"",o=i.URI,l=i.hexadecimalInteger("IV"),c=i.KEYFORMATVERSIONS,d=null!=(s=i.KEYFORMAT)?s:"identity";o&&i.IV&&!l&&Pm.error(`Invalid IV: ${i.IV}`);const u=o?ov.resolve(o,t):"",h=(c||"1").split("/").map(Number).filter(Number.isFinite);return new Hy(a,u,d,h,l)}function cv(e){const t=new Um(e).decimalFloatingPoint("TIME-OFFSET");return km(t)?t:null}function dv(e,t){["video","audio","text"].forEach((n=>{const r=e.filter((e=>function(e,t){const n=Zy[t];return!!n&&!0===n[e.slice(0,4)]}(e,n)));if(r.length){const s=r.filter((e=>0===e.lastIndexOf("avc1",0)||0===e.lastIndexOf("mp4a",0)));t[`${n}Codec`]=s.length>0?s[0]:r[0],e=e.filter((e=>-1===r.indexOf(e)))}})),t.unknownCodecs=e}function uv(e,t,n){const r=t[n];r&&(e[n]=r)}function hv(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):null!=t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime),km(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}function fv(e,t,n,r){e.relurl=t.URI,t.BYTERANGE&&e.setByteRange(t.BYTERANGE),e.level=n,e.sn="initSegment",r&&(e.levelkeys=r),e.initSegment=null}function pv(e,t,n){e.levelkeys=t;const{encryptedFragments:r}=n;r.length&&r[r.length-1].levelkeys===t||!Object.keys(t).some((e=>t[e].isCommonEncryption))||r.push(e)}var gv="manifest",mv="level",yv="audioTrack",vv="subtitleTrack",bv="main",wv="audio",Sv="subtitle";function Cv(e){const{type:t}=e;switch(t){case yv:return wv;case vv:return Sv;default:return bv}}function Tv(e,t){let n=e.url;return void 0!==n&&0!==n.indexOf("data:")||(n=t.url),n}class Ev{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.LEVEL_LOADING,this.onLevelLoading,this),e.on(Am.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(Am.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:e}=this;e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.LEVEL_LOADING,this.onLevelLoading,this),e.off(Am.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(Am.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(e){const t=this.hls.config,n=t.pLoader,r=t.loader,s=new(n||r)(t);return this.loaders[e.type]=s,s}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:n}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:gv,url:n,deliveryDirectives:null})}onLevelLoading(e,t){const{id:n,level:r,url:s,deliveryDirectives:i}=t;this.load({id:n,level:r,responseType:"text",type:mv,url:s,deliveryDirectives:i})}onAudioTrackLoading(e,t){const{id:n,groupId:r,url:s,deliveryDirectives:i}=t;this.load({id:n,groupId:r,level:null,responseType:"text",type:yv,url:s,deliveryDirectives:i})}onSubtitleTrackLoading(e,t){const{id:n,groupId:r,url:s,deliveryDirectives:i}=t;this.load({id:n,groupId:r,level:null,responseType:"text",type:vv,url:s,deliveryDirectives:i})}load(e){var t;const n=this.hls.config;let r,s=this.getInternalLoader(e);if(s){const t=s.context;if(t&&t.url===e.url)return void Pm.trace("[playlist-loader]: playlist request ongoing");Pm.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),s.abort()}if(r=e.type===gv?n.manifestLoadPolicy.default:Im({},n.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(e),null!=(t=e.deliveryDirectives)&&t.part){let t;if(e.type===mv&&null!==e.level?t=this.hls.levels[e.level].details:e.type===yv&&null!==e.id?t=this.hls.audioTracks[e.id].details:e.type===vv&&null!==e.id&&(t=this.hls.subtitleTracks[e.id].details),t){const e=t.partTarget,n=t.targetduration;if(e&&n){const t=1e3*Math.max(3*e,.8*n);r=Im({},r,{maxTimeToFirstByteMs:Math.min(t,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(t,r.maxTimeToFirstByteMs)})}}}const i=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:i.maxNumRetry||0,retryDelay:i.retryDelayMs||0,maxRetryDelay:i.maxRetryDelayMs||0},o={onSuccess:(e,t,n,r)=>{const s=this.getInternalLoader(n);this.resetInternalLoader(n.type);const i=e.data;0===i.indexOf("#EXTM3U")?(t.parsing.start=performance.now(),ov.isMediaPlaylist(i)?this.handleTrackOrLevelPlaylist(e,t,n,r||null,s):this.handleMasterPlaylist(e,t,n,r)):this.handleManifestParsingError(e,n,new Error("no EXTM3U delimiter"),r||null,t)},onError:(e,t,n,r)=>{this.handleNetworkError(t,n,!1,e,r)},onTimeout:(e,t,n)=>{this.handleNetworkError(t,n,!0,void 0,e)}};s.load(e,a,o)}handleMasterPlaylist(e,t,n,r){const s=this.hls,i=e.data,a=Tv(e,n),o=ov.parseMasterPlaylist(i,a);if(o.playlistParsingError)return void this.handleManifestParsingError(e,n,o.playlistParsingError,r,t);const{contentSteering:l,levels:c,sessionData:d,sessionKeys:u,startTimeOffset:h,variableList:f}=o;this.variableList=f;const{AUDIO:p=[],SUBTITLES:g,"CLOSED-CAPTIONS":m}=ov.parseMasterPlaylistMedia(i,a,o);if(p.length){p.some((e=>!e.url))||!c[0].audioCodec||c[0].attrs.AUDIO||(Pm.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),p.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new Um({}),bitrate:0,url:""}))}s.trigger(Am.MANIFEST_LOADED,{levels:c,audioTracks:p,subtitles:g,captions:m,contentSteering:l,url:a,stats:t,networkDetails:r,sessionData:d,sessionKeys:u,startTimeOffset:h,variableList:f})}handleTrackOrLevelPlaylist(e,t,n,r,s){const i=this.hls,{id:a,level:o,type:l}=n,c=Tv(e,n),d=km(a)?a:0,u=km(o)?o:d,h=Cv(n),f=ov.parseLevelPlaylist(e.data,c,u,h,d,this.variableList);if(l===gv){const e={attrs:new Um({}),bitrate:0,details:f,name:"",url:c};i.trigger(Am.MANIFEST_LOADED,{levels:[e],audioTracks:[],url:c,stats:t,networkDetails:r,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),n.levelDetails=f,this.handlePlaylistLoaded(f,e,t,n,r,s)}handleManifestParsingError(e,t,n,r,s){this.hls.trigger(Am.ERROR,{type:_m.NETWORK_ERROR,details:Rm.MANIFEST_PARSING_ERROR,fatal:t.type===gv,url:e.url,err:n,error:n,reason:n.message,response:e,context:t,networkDetails:r,stats:s})}handleNetworkError(e,t,n=!1,r,s){let i=`A network ${n?"timeout":"error"+(r?" (status "+r.code+")":"")} occurred while loading ${e.type}`;e.type===mv?i+=`: ${e.level} id: ${e.id}`:e.type!==yv&&e.type!==vv||(i+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(i);Pm.warn(`[playlist-loader]: ${i}`);let o=Rm.UNKNOWN,l=!1;const c=this.getInternalLoader(e);switch(e.type){case gv:o=n?Rm.MANIFEST_LOAD_TIMEOUT:Rm.MANIFEST_LOAD_ERROR,l=!0;break;case mv:o=n?Rm.LEVEL_LOAD_TIMEOUT:Rm.LEVEL_LOAD_ERROR,l=!1;break;case yv:o=n?Rm.AUDIO_TRACK_LOAD_TIMEOUT:Rm.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case vv:o=n?Rm.SUBTITLE_TRACK_LOAD_TIMEOUT:Rm.SUBTITLE_LOAD_ERROR,l=!1}c&&this.resetInternalLoader(e.type);const d={type:_m.NETWORK_ERROR,details:o,fatal:l,url:e.url,loader:c,context:e,error:a,networkDetails:t,stats:s};if(r){const n=(null==t?void 0:t.url)||e.url;d.response=Tm({url:n,data:void 0},r)}this.hls.trigger(Am.ERROR,d)}handlePlaylistLoaded(e,t,n,r,s,i){const a=this.hls,{type:o,level:l,id:c,groupId:d,deliveryDirectives:u}=r,h=Tv(t,r),f=Cv(r),p="number"==typeof r.level&&f===bv?l:void 0;if(!e.fragments.length){const e=new Error("No Segments found in Playlist");return void a.trigger(Am.ERROR,{type:_m.NETWORK_ERROR,details:Rm.LEVEL_EMPTY_ERROR,fatal:!1,url:h,error:e,reason:e.message,response:t,context:r,level:p,parent:f,networkDetails:s,stats:n})}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const g=e.playlistParsingError;if(g)a.trigger(Am.ERROR,{type:_m.NETWORK_ERROR,details:Rm.LEVEL_PARSING_ERROR,fatal:!1,url:h,error:g,reason:g.message,response:t,context:r,level:p,parent:f,networkDetails:s,stats:n});else switch(e.live&&i&&(i.getCacheAge&&(e.ageHeader=i.getCacheAge()||0),i.getCacheAge&&!isNaN(e.ageHeader)||(e.ageHeader=0)),o){case gv:case mv:a.trigger(Am.LEVEL_LOADED,{details:e,level:p||0,id:c||0,stats:n,networkDetails:s,deliveryDirectives:u});break;case yv:a.trigger(Am.AUDIO_TRACK_LOADED,{details:e,id:c||0,groupId:d||"",stats:n,networkDetails:s,deliveryDirectives:u});break;case vv:a.trigger(Am.SUBTITLE_TRACK_LOADED,{details:e,id:c||0,groupId:d||"",stats:n,networkDetails:s,deliveryDirectives:u})}}}function Iv(e,t){let n;try{n=new Event("addtrack")}catch(e){n=document.createEvent("Event"),n.initEvent("addtrack",!1,!1)}n.track=e,t.dispatchEvent(n)}function kv(e,t){const n=e.mode;if("disabled"===n&&(e.mode="hidden"),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw new Error(`addCue is failed for: ${t}`)}catch(n){Pm.debug(`[texttrack-utils]: ${n}`);try{const n=new self.TextTrackCue(t.startTime,t.endTime,t.text);n.id=t.id,e.addCue(n)}catch(e){Pm.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${e}`)}}"disabled"===n&&(e.mode=n)}function Av(e){const t=e.mode;if("disabled"===t&&(e.mode="hidden"),e.cues)for(let t=e.cues.length;t--;)e.removeCue(e.cues[t]);"disabled"===t&&(e.mode=t)}function _v(e,t,n,r){const s=e.mode;if("disabled"===s&&(e.mode="hidden"),e.cues&&e.cues.length>0){const s=function(e,t,n){const r=[],s=function(e,t){if(t<e[0].startTime)return 0;const n=e.length-1;if(t>e[n].endTime)return-1;let r=0,s=n;for(;r<=s;){const i=Math.floor((s+r)/2);if(t<e[i].startTime)s=i-1;else{if(!(t>e[i].startTime&&r<n))return i;r=i+1}}return e[r].startTime-t<t-e[s].startTime?r:s}(e,t);if(s>-1)for(let i=s,a=e.length;i<a;i++){const s=e[i];if(s.startTime>=t&&s.endTime<=n)r.push(s);else if(s.startTime>n)return r}return r}(e.cues,t,n);for(let t=0;t<s.length;t++)r&&!r(s[t])||e.removeCue(s[t])}"disabled"===s&&(e.mode=s)}var Rv="org.id3",Ov="com.apple.quicktime.HLS",Lv="https://aomedia.org/emsg/ID3";function Dv(){if("undefined"!=typeof self)return self.WebKitDataCue||self.VTTCue||self.TextTrackCue}const xv=(()=>{const e=Dv();try{new e(0,Number.POSITIVE_INFINITY,"")}catch(e){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function Pv(e,t){return e.getTime()/1e3-t}class Mv{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:e}=this;e.on(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(Am.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(Am.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(Am.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(Am.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(e,t){this.media=t.media}onMediaDetaching(){this.id3Track&&(Av(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const n=e[t];if("metadata"===n.kind&&"id3"===n.label)return Iv(n,this.media),n}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:n,enableID3MetadataCues:r}}}=this;if(!n&&!r)return;const{samples:s}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const i=Dv();for(let e=0;e<s.length;e++){const t=s[e].type;if(t===Lv&&!n||!r)continue;const a=gy(s[e].data);if(a){const n=s[e].pts;let r=n+s[e].duration;r>xv&&(r=xv);r-n<=0&&(r=n+.25);for(let e=0;e<a.length;e++){const s=a[e];if(!fy(s)){this.updateId3CueEnds(n,t);const e=new i(n,r,"");e.value=s,t&&(e.type=t),this.id3Track.addCue(e)}}}}}updateId3CueEnds(e,t){var n;const r=null==(n=this.id3Track)?void 0:n.cues;if(r)for(let n=r.length;n--;){const s=r[n];s.type===t&&s.startTime<e&&s.endTime===xv&&(s.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:n,type:r}){const{id3Track:s,hls:i}=this;if(!i)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:o}}=i;if(s&&(a||o)){let e;e="audio"===r?e=>e.type===Rv&&o:"video"===r?e=>e.type===Lv&&a:e=>e.type===Rv&&o||e.type===Lv&&a,_v(s,t,n,e)}}onLevelUpdated(e,{details:t}){if(!this.media||!t.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:n,id3Track:r}=this,{dateRanges:s}=t,i=Object.keys(s);if(r){const e=Object.keys(n).filter((e=>!i.includes(e)));for(let t=e.length;t--;){const s=e[t];Object.keys(n[s].cues).forEach((e=>{r.removeCue(n[s].cues[e])})),delete n[s]}}const a=t.fragments[t.fragments.length-1];if(0===i.length||!km(null==a?void 0:a.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=a.programDateTime/1e3-a.start,l=Dv();for(let e=0;e<i.length;e++){const t=i[e],r=s[t],a=n[t],u=(null==a?void 0:a.cues)||{};let h=(null==a?void 0:a.durationKnown)||!1;const f=Pv(r.startDate,o);let p=xv;const g=r.endDate;if(g)p=Pv(g,o),h=!0;else if(r.endOnNext&&!h){const e=i.reduce(((e,t)=>{const n=s[t];return n.class===r.class&&n.id!==t&&n.startDate>r.startDate&&e.push(n),e}),[]).sort(((e,t)=>e.startDate.getTime()-t.startDate.getTime()))[0];e&&(p=Pv(e.startDate,o),h=!0)}const m=Object.keys(r.attr);for(let e=0;e<m.length;e++){const n=m[e];if("ID"===(d=n)||"CLASS"===d||"START-DATE"===d||"DURATION"===d||"END-DATE"===d||"END-ON-NEXT"===d)continue;let s=u[n];if(s)h&&!a.durationKnown&&(s.endTime=p);else{let e=r.attr[n];s=new l(f,p,""),Nm(n)&&(c=e,e=Uint8Array.from(c.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer),s.value={key:n,data:e},s.type=Ov,s.id=t,this.id3Track.addCue(s),u[n]=s}}n[t]={cues:u,dateRange:r,durationKnown:h}}var c,d}}class Fv{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=e,this.config=e.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:e,levelDetails:t}=this;return void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const{levelDetails:e}=this;if(null===e)return null;const{holdBack:t,partHoldBack:n,targetduration:r}=e,{liveSyncDuration:s,liveSyncDurationCount:i,lowLatencyMode:a}=this.config,o=this.hls.userConfig;let l=a&&n||t;(o.liveSyncDuration||o.liveSyncDurationCount||0===l)&&(l=void 0!==s?s:i*r);const c=r;return l+Math.min(1*this.stallCount,c)}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency,n=this.levelDetails;if(null===e||null===t||null===n)return null;const r=n.edge,s=e-t-this.edgeStalled,i=r-n.totalduration,a=r-(this.config.lowLatencyMode&&n.partTarget||n.targetduration);return Math.min(Math.max(i,s),a)}get drift(){const{levelDetails:e}=this;return null===e?1:e.drift}get edgeStalled(){const{levelDetails:e}=this;if(null===e)return 0;const t=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e,levelDetails:t}=this;if(!e||!t)return 0;const n=e.buffered.length;return(n?e.buffered.end(n-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(Am.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(Am.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(Am.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(Am.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(Am.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(Am.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(Am.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(Am.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){this.levelDetails=t,t.advanced&&this.timeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(e,t){var n;t.details===Rm.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(n=this.levelDetails)&&n.live&&Pm.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:e,levelDetails:t}=this;if(!e||!t)return;this.currentTime=e.currentTime;const n=this.computeLatency();if(null===n)return;this._latency=n;const{lowLatencyMode:r,maxLiveSyncPlaybackRate:s}=this.config;if(!r||1===s)return;const i=this.targetLatency;if(null===i)return;const a=n-i,o=a<Math.min(this.maxLatency,i+t.targetduration);if(t.live&&o&&a>.05&&this.forwardBufferLength>1){const t=Math.min(2,Math.max(1,s)),n=Math.round(2/(1+Math.exp(-.75*a-this.edgeStalled))*20)/20;e.playbackRate=Math.min(t,Math.max(1,n))}else 1!==e.playbackRate&&0!==e.playbackRate&&(e.playbackRate=1)}estimateLiveEdge(){const{levelDetails:e}=this;return null===e?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return null===e?null:e-this.currentTime}}const Uv=["NONE","TYPE-0","TYPE-1",null];var Nv="",Bv="YES",jv="v2";class $v{constructor(e,t,n){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=n}addDirectives(e){const t=new self.URL(e);return void 0!==this.msn&&t.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class qv{constructor(e){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.unknownCodecs=e.unknownCodecs,this.codecSet=[e.videoCodec,e.audioCodec].filter((e=>e)).join(",").replace(/\.[^.,]+/g,"")}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get attrs(){return this._attrs[this._urlId]}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get uri(){return this.url[this._urlId]||""}get urlId(){return this._urlId}set urlId(e){const t=e%this.url.length;this._urlId!==t&&(this.fragmentError=0,this.loadError=0,this.details=void 0,this._urlId=t)}get audioGroupId(){var e;return null==(e=this.audioGroupIds)?void 0:e[this.urlId]}get textGroupId(){var e;return null==(e=this.textGroupIds)?void 0:e[this.urlId]}addFallback(e){this.url.push(e.url),this._attrs.push(e.attrs)}}function Kv(e,t){const n=t.startPTS;if(km(n)){let r,s=0;t.sn>e.sn?(s=n-e.start,r=e):(s=e.start-n,r=t),r.duration!==s&&(r.duration=s)}else if(t.sn>e.sn){e.cc===t.cc&&e.minEndPTS?t.start=e.start+(e.minEndPTS-e.start):t.start=e.start+e.duration}else t.start=Math.max(e.start-t.duration,0)}function Gv(e,t,n,r,s,i){r-n<=0&&(Pm.warn("Fragment should have a positive duration",t),r=n+t.duration,i=s+t.duration);let a=n,o=r;const l=t.startPTS,c=t.endPTS;if(km(l)){const e=Math.abs(l-n);km(t.deltaPTS)?t.deltaPTS=Math.max(e,t.deltaPTS):t.deltaPTS=e,a=Math.max(n,l),n=Math.min(n,l),s=Math.min(s,t.startDTS),o=Math.min(r,c),r=Math.max(r,c),i=Math.max(i,t.endDTS)}const d=n-t.start;0!==t.start&&(t.start=n),t.duration=r-t.start,t.startPTS=n,t.maxStartPTS=a,t.startDTS=s,t.endPTS=r,t.minEndPTS=o,t.endDTS=i;const u=t.sn;if(!e||u<e.startSN||u>e.endSN)return 0;let h;const f=u-e.startSN,p=e.fragments;for(p[f]=t,h=f;h>0;h--)Kv(p[h],p[h-1]);for(h=f;h<p.length-1;h++)Kv(p[h],p[h+1]);return e.fragmentHint&&Kv(p[p.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,d}function Hv(e,t){let n=null;const r=e.fragments;for(let e=r.length-1;e>=0;e--){const t=r[e].initSegment;if(t){n=t;break}}e.fragmentHint&&delete e.fragmentHint.endPTS;let s,i=0;if(function(e,t,n){const r=t.skippedSegments,s=Math.max(e.startSN,t.startSN)-t.startSN,i=(e.fragmentHint?1:0)+(r?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,a=t.startSN-e.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;for(let e=s;e<=i;e++){const s=l[a+e];let i=o[e];r&&!i&&e<r&&(i=t.fragments[e]=s),s&&i&&n(s,i)}}(e,t,((e,r)=>{e.relurl&&(i=e.cc-r.cc),km(e.startPTS)&&km(e.endPTS)&&(r.start=r.startPTS=e.startPTS,r.startDTS=e.startDTS,r.maxStartPTS=e.maxStartPTS,r.endPTS=e.endPTS,r.endDTS=e.endDTS,r.minEndPTS=e.minEndPTS,r.duration=e.endPTS-e.startPTS,r.duration&&(s=r),t.PTSKnown=t.alignedSliding=!0),r.elementaryStreams=e.elementaryStreams,r.loader=e.loader,r.stats=e.stats,r.urlId=e.urlId,e.initSegment&&(r.initSegment=e.initSegment,n=e.initSegment)})),n){(t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments).forEach((e=>{var t;e.initSegment&&e.initSegment.relurl!==(null==(t=n)?void 0:t.relurl)||(e.initSegment=n)}))}if(t.skippedSegments)if(t.deltaUpdateFailed=t.fragments.some((e=>!e)),t.deltaUpdateFailed){Pm.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let e=t.skippedSegments;e--;)t.fragments.shift();t.startSN=t.fragments[0].sn,t.startCC=t.fragments[0].cc}else t.canSkipDateRanges&&(t.dateRanges=function(e,t,n){const r=Im({},e);n&&n.forEach((e=>{delete r[e]}));return Object.keys(t).forEach((e=>{const n=new Bm(t[e].attr,r[e]);n.isValid?r[e]=n:Pm.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(t[e].attr)}"`)})),r}(e.dateRanges,t.dateRanges,t.recentlyRemovedDateranges));const a=t.fragments;if(i){Pm.warn("discontinuity sliding from playlist, take drift into account");for(let e=0;e<a.length;e++)a[e].cc+=i}t.skippedSegments&&(t.startCC=t.fragments[0].cc),function(e,t,n){if(e&&t){let r=0;for(let s=0,i=e.length;s<=i;s++){const i=e[s],a=t[s+r];i&&a&&i.index===a.index&&i.fragment.sn===a.fragment.sn?n(i,a):r--}}}(e.partList,t.partList,((e,t)=>{t.elementaryStreams=e.elementaryStreams,t.stats=e.stats})),s?Gv(t,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS):Vv(e,t),a.length&&(t.totalduration=t.edge-a[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;const o=t.advancedDateTime;if(t.advanced&&o){const e=t.edge;t.driftStart||(t.driftStartTime=o,t.driftStart=e),t.driftEndTime=o,t.driftEnd=e}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime}function Vv(e,t){const n=t.startSN+t.skippedSegments-e.startSN,r=e.fragments;n<0||n>=r.length||zv(t,r[n].start)}function zv(e,t){if(t){const n=e.fragments;for(let r=e.skippedSegments;r<n.length;r++)n[r].start+=t;e.fragmentHint&&(e.fragmentHint.start+=t)}}function Wv(e,t,n){var r;return null!=e&&e.details?Yv(null==(r=e.details)?void 0:r.partList,t,n):null}function Yv(e,t,n){if(e)for(let r=e.length;r--;){const s=e[r];if(s.index===n&&s.fragment.sn===t)return s}return null}function Qv(e){switch(e.details){case Rm.FRAG_LOAD_TIMEOUT:case Rm.KEY_LOAD_TIMEOUT:case Rm.LEVEL_LOAD_TIMEOUT:case Rm.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Xv(e,t){const n=Qv(t);return e.default[(n?"timeout":"error")+"Retry"]}function Jv(e,t){const n="linear"===e.backoff?1:Math.pow(2,t);return Math.min(n*e.retryDelayMs,e.maxRetryDelayMs)}function Zv(e){return Tm(Tm({},e),{errorRetry:null,timeoutRetry:null})}function eb(e,t,n,r){return!!e&&t<e.maxNumRetry&&(function(e){return 0===e&&!1===navigator.onLine||!!e&&(e<400||e>499)}(r)||!!n)}const tb=function(e,t){let n=0,r=e.length-1,s=null,i=null;for(;n<=r;){s=(n+r)/2|0,i=e[s];const a=t(i);if(a>0)n=s+1;else{if(!(a<0))return i;r=s-1}}return null};function nb(e,t,n=0,r=0){let s=null;if(e?s=t[e.sn-t[0].sn+1]||null:0===n&&0===t[0].start&&(s=t[0]),s&&0===rb(n,r,s))return s;const i=tb(t,rb.bind(null,n,r));return!i||i===e&&s?s:i}function rb(e=0,t=0,n){if(n.start<=e&&n.start+n.duration>e)return 0;const r=Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0));return n.start+n.duration-r<=e?1:n.start-r>e&&n.start?-1:0}function sb(e,t,n){const r=1e3*Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0));return(n.endProgramDateTime||0)-r>e}var ib=0,ab=2,ob=5,lb=0,cb=1,db=2;function ub(e,t,n){if(performance.now()-e.lastErrorPerfMs>3e5)return!0;const r=e.details;if(t.details===Rm.FRAG_GAP&&r&&t.frag){const e=t.frag.start,n=nb(null,r.fragments,e);if(n&&!n.gap)return!0}if(n&&e.errors.length<n.errors.length){const n=e.errors[e.errors.length-1];if(r&&n.frag&&t.frag&&Math.abs(n.frag.start-t.frag.start)>3*r.targetduration)return!0}return!1}class hb{constructor(e,t){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=Pm.log.bind(Pm,`${t}:`),this.warn=Pm.warn.bind(Pm,`${t}:`),this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){clearTimeout(this.timer),this.timer=-1}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t){const n=null==t?void 0:t.renditionReports;if(n){let r=-1;for(let s=0;s<n.length;s++){const i=n[s];let a;try{a=new self.URL(i.URI,t.url).href}catch(e){Pm.warn(`Could not construct new URL for Rendition Report: ${e}`),a=i.URI||""}if(a===e){r=s;break}a===e.substring(0,a.length)&&(r=s)}if(-1!==r){const e=n[r],s=parseInt(e["LAST-MSN"])||(null==t?void 0:t.lastPartSn);let i=parseInt(e["LAST-PART"])||(null==t?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const e=Math.min(t.age-t.partTarget,t.targetduration);i>=0&&e>t.partTarget&&(i+=1)}return new $v(s,i>=0?i:void 0,Nv)}}}loadPlaylist(e){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}shouldReloadPlaylist(e){return-1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(e)}playlistLoaded(e,t,n){const{details:r,stats:s}=t,i=self.performance.now(),a=s.loading.first?Math.max(0,i-s.loading.first):0;if(r.advancedDateTime=Date.now()-a,r.live||null!=n&&n.live){if(r.reloaded(n),n&&this.log(`live playlist ${e} ${r.advanced?"REFRESHED "+r.lastPartSn+"-"+r.lastPartIndex:"MISSED"}`),n&&r.fragments.length>0&&Hv(n,r),!this.canLoad||!r.live)return;let a,o,l;if(r.canBlockReload&&r.endSN&&r.advanced){const e=this.hls.config.lowLatencyMode,s=r.lastPartSn,i=r.endSN,c=r.lastPartIndex,d=s===i,u=e?0:c;-1!==c?(o=d?i+1:s,l=d?u:c+1):o=i+1;const h=r.age,f=h+r.ageHeader;let p=Math.min(f-r.partTarget,1.5*r.targetduration);if(p>0){if(n&&p>n.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${n.tuneInGoal} to: ${p} with playlist age: ${r.age}`),p=0;else{const e=Math.floor(p/r.targetduration);if(o+=e,void 0!==l){l+=Math.round(p%r.targetduration/r.partTarget)}this.log(`CDN Tune-in age: ${r.ageHeader}s last advanced ${h.toFixed(2)}s goal: ${p} skip sn ${e} to part ${l}`)}r.tuneInGoal=p}if(a=this.getDeliveryDirectives(r,t.deliveryDirectives,o,l),e||!d)return void this.loadPlaylist(a)}else r.canBlockReload&&(a=this.getDeliveryDirectives(r,t.deliveryDirectives,o,l));const c=this.hls.mainForwardBufferInfo,d=c?c.end-c.len:0,u=function(e,t=1/0){let n=1e3*e.targetduration;if(e.updated){const r=e.fragments,s=4;if(r.length&&n*s>t){const e=1e3*r[r.length-1].duration;e<n&&(n=e)}}else n/=2;return Math.round(n)}(r,1e3*(r.edge-d));r.updated&&i>this.requestScheduled+u&&(this.requestScheduled=s.loading.start),void 0!==o&&r.canBlockReload?this.requestScheduled=s.loading.first+u-(1e3*r.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+u<i?this.requestScheduled=i:this.requestScheduled-i<=0&&(this.requestScheduled+=u);let h=this.requestScheduled-i;h=Math.max(0,h),this.log(`reload live playlist ${e} in ${Math.round(h)} ms`),this.timer=self.setTimeout((()=>this.loadPlaylist(a)),h)}else this.clearTimer()}getDeliveryDirectives(e,t,n,r){let s=function(e,t){const{canSkipUntil:n,canSkipDateRanges:r,endSN:s}=e;return n&&(void 0!==t?t-s:0)<n?r?jv:Bv:Nv}(e,n);return null!=t&&t.skip&&e.deltaUpdateFailed&&(n=t.msn,r=t.part,s=Nv),new $v(n,r,s)}checkRetry(e){const t=e.details,n=Qv(e),r=e.errorAction,{action:s,retryCount:i=0,retryConfig:a}=r||{},o=!!r&&!!a&&(s===ob||!r.resolved&&s===ab);if(o){var l;if(this.requestScheduled=-1,i>=a.maxNumRetry)return!1;if(n&&null!=(l=e.context)&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${i+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const e=Jv(a,i);this.timer=self.setTimeout((()=>this.loadPlaylist()),e),this.warn(`Retrying playlist loading ${i+1}/${a.maxNumRetry} after "${t}" in ${e}ms`)}e.levelRetry=!0,r.resolved=!0}return o}}let fb;class pb extends hb{constructor(e,t){super(e,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(Am.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Am.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(Am.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(Am.FRAG_LOADED,this.onFragLoaded,this),e.on(Am.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(Am.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Am.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(Am.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(Am.FRAG_LOADED,this.onFragLoaded,this),e.off(Am.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}startLoad(){this._levels.forEach((e=>{e.loadError=0,e.fragmentError=0})),super.startLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[]}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const n=[],r={};let s;t.levels.forEach((e=>{var t;const i=e.attrs;-1!==(null==(t=e.audioCodec)?void 0:t.indexOf("mp4a.40.34"))&&(fb||(fb=/chrome|firefox/i.test(navigator.userAgent)),fb&&(e.audioCodec=void 0));const{AUDIO:a,CODECS:o,"FRAME-RATE":l,"PATHWAY-ID":c,RESOLUTION:d,SUBTITLES:u}=i,h=`${`${c||"."}-`}${e.bitrate}-${d}-${l}-${o}`;s=r[h],s?s.addFallback(e):(s=new qv(e),r[h]=s,n.push(s)),gb(s,"audio",a),gb(s,"text",u)})),this.filterAndSortMediaOptions(n,t)}filterAndSortMediaOptions(e,t){let n=[],r=[],s=!1,i=!1,a=!1,o=e.filter((({audioCodec:e,videoCodec:t,width:n,height:r,unknownCodecs:o})=>(s||(s=!(!n||!r)),i||(i=!!t),a||(a=!!e),!(null!=o&&o.length)&&(!e||tv(e,"audio"))&&(!t||tv(t,"video")))));if((s||i)&&a&&(o=o.filter((({videoCodec:e,width:t,height:n})=>!!e||!(!t||!n)))),0===o.length)return void Promise.resolve().then((()=>{if(this.hls){const e=new Error("no level with compatible codecs found in manifest");this.hls.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:e,reason:e.message})}}));t.audioTracks&&(n=t.audioTracks.filter((e=>!e.audioCodec||tv(e.audioCodec,"audio"))),mb(n)),t.subtitles&&(r=t.subtitles,mb(r));const l=o.slice(0);o.sort(((e,t)=>e.attrs["HDCP-LEVEL"]!==t.attrs["HDCP-LEVEL"]?(e.attrs["HDCP-LEVEL"]||"")>(t.attrs["HDCP-LEVEL"]||"")?1:-1:e.bitrate!==t.bitrate?e.bitrate-t.bitrate:e.attrs["FRAME-RATE"]!==t.attrs["FRAME-RATE"]?e.attrs.decimalFloatingPoint("FRAME-RATE")-t.attrs.decimalFloatingPoint("FRAME-RATE"):e.attrs.SCORE!==t.attrs.SCORE?e.attrs.decimalFloatingPoint("SCORE")-t.attrs.decimalFloatingPoint("SCORE"):s&&e.height!==t.height?e.height-t.height:0));let c=l[0];if(this.steering&&(o=this.steering.filterParsedLevels(o),o.length!==l.length))for(let e=0;e<l.length;e++)if(l[e].pathwayId===o[0].pathwayId){c=l[e];break}this._levels=o;for(let e=0;e<o.length;e++)if(o[e]===c){this._firstLevel=e,this.log(`manifest loaded, ${o.length} level(s) found, first bitrate: ${c.bitrate}`);break}const d=a&&!i,u={levels:o,audioTracks:n,subtitleTracks:r,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:a,video:i,altAudio:!d&&n.some((e=>!!e.url))};this.hls.trigger(Am.MANIFEST_PARSED,u),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(0===t.length)return;if(e<0||e>=t.length){const n=new Error("invalid level idx"),r=e<0;if(this.hls.trigger(Am.ERROR,{type:_m.OTHER_ERROR,details:Rm.LEVEL_SWITCH_ERROR,level:e,fatal:r,error:n,reason:n.message}),r)return;e=Math.min(e,t.length-1)}const n=this.currentLevelIndex,r=this.currentLevel,s=r?r.attrs["PATHWAY-ID"]:void 0,i=t[e],a=i.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=i,n===e&&i.details&&r&&s===a)return;this.log(`Switching to level ${e}${a?" with Pathway "+a:""} from level ${n}${s?" with Pathway "+s:""}`);const o=Im({},i,{level:e,maxBitrate:i.maxBitrate,attrs:i.attrs,uri:i.uri,urlId:i.urlId});delete o._attrs,delete o._urlId,this.hls.trigger(Am.LEVEL_SWITCHING,o);const l=i.details;if(!l||l.live){const e=this.switchParams(i.uri,null==r?void 0:r.details);this.loadPlaylist(e)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(void 0===this._startLevel){const e=this.hls.config.startLevel;return void 0!==e?e:this._firstLevel}return this._startLevel}set startLevel(e){this._startLevel=e}onError(e,t){!t.fatal&&t.context&&t.context.type===mv&&t.context.level===this.level&&this.checkRetry(t)}onFragLoaded(e,{frag:t}){if(void 0!==t&&t.type===bv){const e=this._levels[t.level];void 0!==e&&(e.loadError=0)}}onLevelLoaded(e,t){var n;const{level:r,details:s}=t,i=this._levels[r];var a;if(!i)return this.warn(`Invalid level index ${r}`),void(null!=(a=t.deliveryDirectives)&&a.skip&&(s.deltaUpdateFailed=!0));r===this.currentLevelIndex?(0===i.fragmentError&&(i.loadError=0),this.playlistLoaded(r,t,i.details)):null!=(n=t.deliveryDirectives)&&n.skip&&(s.deltaUpdateFailed=!0)}onAudioTrackSwitched(e,t){const n=this.currentLevel;if(!n)return;const r=this.hls.audioTracks[t.id].groupId;if(n.audioGroupIds&&n.audioGroupId!==r){let e=-1;for(let t=0;t<n.audioGroupIds.length;t++)if(n.audioGroupIds[t]===r){e=t;break}-1!==e&&e!==n.urlId&&(n.urlId=e,this.canLoad&&this.startLoad())}}loadPlaylist(e){super.loadPlaylist();const t=this.currentLevelIndex,n=this.currentLevel;if(n&&this.shouldLoadPlaylist(n)){const r=n.urlId;let s=n.uri;if(e)try{s=e.addDirectives(s)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: ${e}`)}const i=n.attrs["PATHWAY-ID"];this.log(`Loading level index ${t}${void 0!==(null==e?void 0:e.msn)?" at sn "+e.msn+" part "+e.part:""} with${i?" Pathway "+i:""} URI ${r+1}/${n.url.length} ${s}`),this.clearTimer(),this.hls.trigger(Am.LEVEL_LOADING,{url:s,level:t,id:r,deliveryDirectives:e||null})}}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}removeLevel(e,t){const n=(e,n)=>n!==t,r=this._levels.filter(((r,s)=>s!==e||(r.url.length>1&&void 0!==t?(r.url=r.url.filter(n),r.audioGroupIds&&(r.audioGroupIds=r.audioGroupIds.filter(n)),r.textGroupIds&&(r.textGroupIds=r.textGroupIds.filter(n)),r.urlId=0,!0):(this.steering&&this.steering.removeLevel(r),!1))));this.hls.trigger(Am.LEVELS_UPDATED,{levels:r})}onLevelsUpdated(e,{levels:t}){t.forEach(((e,t)=>{const{details:n}=e;null!=n&&n.fragments&&n.fragments.forEach((e=>{e.level=t}))})),this._levels=t}}function gb(e,t,n){n&&("audio"===t?(e.audioGroupIds||(e.audioGroupIds=[]),e.audioGroupIds[e.url.length-1]=n):"text"===t&&(e.textGroupIds||(e.textGroupIds=[]),e.textGroupIds[e.url.length-1]=n))}function mb(e){const t={};e.forEach((e=>{const n=e.groupId||"";e.id=t[n]=t[n]||0,t[n]++}))}var yb="NOT_LOADED",vb="APPENDING",bb="PARTIAL",wb="OK";class Sb{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(Am.BUFFER_APPENDED,this.onBufferAppended,this),e.on(Am.FRAG_BUFFERED,this.onFragBuffered,this),e.on(Am.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(Am.BUFFER_APPENDED,this.onBufferAppended,this),e.off(Am.FRAG_BUFFERED,this.onFragBuffered,this),e.off(Am.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const n=this.activePartLists[t];if(n)for(let t=n.length;t--;){const r=n[t];if(!r)break;const s=r.end;if(r.start<=e&&null!==s&&e<=s)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){const{fragments:n}=this,r=Object.keys(n);for(let s=r.length;s--;){const i=n[r[s]];if((null==i?void 0:i.body.type)===t&&i.buffered){const t=i.body;if(t.start<=e&&e<=t.end)return t}}return null}detectEvictedFragments(e,t,n,r){this.timeRanges&&(this.timeRanges[e]=t);const s=(null==r?void 0:r.fragment.sn)||-1;Object.keys(this.fragments).forEach((r=>{const i=this.fragments[r];if(!i)return;if(s>=i.body.sn)return;if(!i.buffered&&!i.loaded)return void(i.body.type===n&&this.removeFragment(i.body));const a=i.range[e];a&&a.time.some((e=>{const n=!this.isTimeBuffered(e.startPTS,e.endPTS,t);return n&&this.removeFragment(i.body),n}))}))}detectPartialFragments(e){const t=this.timeRanges,{frag:n,part:r}=e;if(!t||"initSegment"===n.sn)return;const s=Tb(n),i=this.fragments[s];if(!i||i.buffered&&n.gap)return;const a=!n.relurl;Object.keys(t).forEach((e=>{const s=n.elementaryStreams[e];if(!s)return;const o=t[e],l=a||!0===s.partial;i.range[e]=this.getBufferedTimes(n,r,l,o)})),i.loaded=null,Object.keys(i.range).length?(i.buffered=!0,i.body.endList&&(this.endListFragments[i.body.type]=i),Cb(i)||this.removeParts(n.sn-1,n.type)):this.removeFragment(i.body)}removeParts(e,t){const n=this.activePartLists[t];n&&(this.activePartLists[t]=n.filter((t=>t.fragment.sn>=e)))}fragBuffered(e,t){const n=Tb(e);let r=this.fragments[n];!r&&t&&(r=this.fragments[n]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),r&&(r.loaded=null,r.buffered=!0)}getBufferedTimes(e,t,n,r){const s={time:[],partial:n},i=e.start,a=e.end,o=e.minEndPTS||a,l=e.maxStartPTS||i;for(let e=0;e<r.length;e++){const t=r.start(e)-this.bufferPadding,n=r.end(e)+this.bufferPadding;if(l>=t&&o<=n){s.time.push({startPTS:Math.max(i,r.start(e)),endPTS:Math.min(a,r.end(e))});break}if(i<n&&a>t)s.partial=!0,s.time.push({startPTS:Math.max(i,r.start(e)),endPTS:Math.min(a,r.end(e))});else if(a<=t)break}return s}getPartialFragment(e){let t,n,r,s=null,i=0;const{bufferPadding:a,fragments:o}=this;return Object.keys(o).forEach((l=>{const c=o[l];c&&Cb(c)&&(n=c.body.start-a,r=c.body.end+a,e>=n&&e<=r&&(t=Math.min(e-n,r-e),i<=t&&(s=c.body,i=t)))})),s}isEndListAppended(e){const t=this.endListFragments[e];return void 0!==t&&(t.buffered||Cb(t))}getState(e){const t=Tb(e),n=this.fragments[t];return n?n.buffered?Cb(n)?bb:wb:vb:yb}isTimeBuffered(e,t,n){let r,s;for(let i=0;i<n.length;i++){if(r=n.start(i)-this.bufferPadding,s=n.end(i)+this.bufferPadding,e>=r&&t<=s)return!0;if(t<=r)return!1}return!1}onFragLoaded(e,t){const{frag:n,part:r}=t;if("initSegment"===n.sn||n.bitrateTest)return;const s=r?null:t,i=Tb(n);this.fragments[i]={body:n,appendedPTS:null,loaded:s,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:n,part:r,timeRanges:s}=t;if("initSegment"===n.sn)return;const i=n.type;if(r){let e=this.activePartLists[i];e||(this.activePartLists[i]=e=[]),e.push(r)}this.timeRanges=s,Object.keys(s).forEach((e=>{const t=s[e];this.detectEvictedFragments(e,t,i,r)}))}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=Tb(e);return!!this.fragments[t]}hasParts(e){var t;return!(null==(t=this.activePartLists[e])||!t.length)}removeFragmentsInRange(e,t,n,r,s){r&&!this.hasGaps||Object.keys(this.fragments).forEach((i=>{const a=this.fragments[i];if(!a)return;const o=a.body;o.type!==n||r&&!o.gap||o.start<t&&o.end>e&&(a.buffered||s)&&this.removeFragment(o)}))}removeFragment(e){const t=Tb(e);e.stats.loaded=0,e.clearElementaryStreamInfo();const n=this.activePartLists[e.type];if(n){const t=e.sn;this.activePartLists[e.type]=n.filter((e=>e.fragment.sn!==t))}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function Cb(e){var t,n,r;return e.buffered&&(e.body.gap||(null==(t=e.range.video)?void 0:t.partial)||(null==(n=e.range.audio)?void 0:n.partial)||(null==(r=e.range.audiovideo)?void 0:r.partial))}function Tb(e){return`${e.type}_${e.level}_${e.urlId}_${e.sn}`}const Eb=Math.pow(2,17);class Ib{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const n=e.url;if(!n)return Promise.reject(new _b({type:_m.NETWORK_ERROR,details:Rm.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error("Fragment does not have a "+(n?"part list":"url")),networkDetails:null}));this.abort();const r=this.config,s=r.fLoader,i=r.loader;return new Promise(((a,o)=>{if(this.loader&&this.loader.destroy(),e.gap){if(e.tagList.some((e=>"GAP"===e[0])))return void o(Ab(e));e.gap=!1}const l=this.loader=e.loader=s?new s(r):new i(r),c=kb(e),d=Zv(r.fragLoadPolicy.default),u={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===e.sn?1/0:Eb};e.stats=l.stats,l.load(c,u,{onSuccess:(t,n,r,s)=>{this.resetLoader(e,l);let i=t.data;r.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(i.slice(0,16)),i=i.slice(16)),a({frag:e,part:null,payload:i,networkDetails:s})},onError:(t,r,s,i)=>{this.resetLoader(e,l),o(new _b({type:_m.NETWORK_ERROR,details:Rm.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:Tm({url:n,data:void 0},t),error:new Error(`HTTP Error ${t.code} ${t.text}`),networkDetails:s,stats:i}))},onAbort:(t,n,r)=>{this.resetLoader(e,l),o(new _b({type:_m.NETWORK_ERROR,details:Rm.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:r,stats:t}))},onTimeout:(t,n,r)=>{this.resetLoader(e,l),o(new _b({type:_m.NETWORK_ERROR,details:Rm.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${u.timeout}ms`),networkDetails:r,stats:t}))},onProgress:(n,r,s,i)=>{t&&t({frag:e,part:null,payload:s,networkDetails:i})}})}))}loadPart(e,t,n){this.abort();const r=this.config,s=r.fLoader,i=r.loader;return new Promise(((a,o)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap)return void o(Ab(e,t));const l=this.loader=e.loader=s?new s(r):new i(r),c=kb(e,t),d=Zv(r.fragLoadPolicy.default),u={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Eb};t.stats=l.stats,l.load(c,u,{onSuccess:(r,s,i,o)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);const c={frag:e,part:t,payload:r.data,networkDetails:o};n(c),a(c)},onError:(n,r,s,i)=>{this.resetLoader(e,l),o(new _b({type:_m.NETWORK_ERROR,details:Rm.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:Tm({url:c.url,data:void 0},n),error:new Error(`HTTP Error ${n.code} ${n.text}`),networkDetails:s,stats:i}))},onAbort:(n,r,s)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),o(new _b({type:_m.NETWORK_ERROR,details:Rm.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:s,stats:n}))},onTimeout:(n,r,s)=>{this.resetLoader(e,l),o(new _b({type:_m.NETWORK_ERROR,details:Rm.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${u.timeout}ms`),networkDetails:s,stats:n}))}})}))}updateStatsFromPart(e,t){const n=e.stats,r=t.stats,s=r.total;if(n.loaded+=r.loaded,s){const r=Math.round(e.duration/t.duration),i=Math.min(Math.round(n.loaded/s),r),a=(r-i)*Math.round(n.loaded/i);n.total=n.loaded+a}else n.total=Math.max(n.loaded,n.total);const i=n.loading,a=r.loading;i.start?i.first+=a.first-a.start:(i.start=a.start,i.first=a.first),i.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function kb(e,t=null){const n=t||e,r={frag:e,part:t,responseType:"arraybuffer",url:n.url,headers:{},rangeStart:0,rangeEnd:0},s=n.byteRangeStartOffset,i=n.byteRangeEndOffset;if(km(s)&&km(i)){var a;let t=s,n=i;if("initSegment"===e.sn&&"AES-128"===(null==(a=e.decryptdata)?void 0:a.method)){const e=i-s;e%16&&(n=i+(16-e%16)),0!==s&&(r.resetIV=!0,t=s-16)}r.rangeStart=t,r.rangeEnd=n}return r}function Ab(e,t){const n=new Error(`GAP ${e.gap?"tag":"attribute"} found`),r={type:_m.MEDIA_ERROR,details:Rm.FRAG_GAP,fatal:!1,frag:e,error:n,networkDetails:null};return t&&(r.part=t),(t||e).stats.aborted=!0,new _b(r)}class _b extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class Rb{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const t in this.keyUriToKeyInfo){const n=this.keyUriToKeyInfo[t].loader;if(n){if(e&&e!==n.context.frag.type)return;n.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=Rm.KEY_LOAD_ERROR,n,r,s){return new _b({type:_m.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:s,error:n,networkDetails:r})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled){const{sn:n,cc:r}=e;for(let e=0;e<t.length;e++){const s=t[e];if(r<=s.cc&&("initSegment"===n||"initSegment"===s.sn||n<s.sn)){this.emeController.selectKeySystemFormat(s).then((e=>{s.setKeyFormat(e)}));break}}}}load(e){return!e.decryptdata&&e.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(e).then((t=>this.loadInternal(e,t))):this.loadInternal(e)}loadInternal(e,t){var n,r;t&&e.setKeyFormat(t);const s=e.decryptdata;if(!s){const n=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,Rm.KEY_LOAD_ERROR,n))}const i=s.uri;if(!i)return Promise.reject(this.createKeyLoadError(e,Rm.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${i}"`)));let a=this.keyUriToKeyInfo[i];if(null!=(n=a)&&n.decryptdata.key)return s.key=a.decryptdata.key,Promise.resolve({frag:e,keyInfo:a});var o;if(null!=(r=a)&&r.keyLoadPromise)switch(null==(o=a.mediaKeySessionContext)?void 0:o.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then((t=>(s.key=t.keyInfo.decryptdata.key,{frag:e,keyInfo:a})))}switch(a=this.keyUriToKeyInfo[i]={decryptdata:s,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},s.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===s.keyFormat?this.loadKeyHTTP(a,e):this.loadKeyEME(a,e);case"AES-128":return this.loadKeyHTTP(a,e);default:return Promise.reject(this.createKeyLoadError(e,Rm.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${s.method}"`)))}}loadKeyEME(e,t){const n={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const t=this.emeController.loadKey(n);if(t)return(e.keyLoadPromise=t.then((t=>(e.mediaKeySessionContext=t,n)))).catch((t=>{throw e.keyLoadPromise=null,t}))}return Promise.resolve(n)}loadKeyHTTP(e,t){const n=this.config,r=new(0,n.loader)(n);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise(((s,i)=>{const a={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},o=n.keyLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},c={onSuccess:(e,t,n,r)=>{const{frag:a,keyInfo:o,url:l}=n;if(!a.decryptdata||o!==this.keyUriToKeyInfo[l])return i(this.createKeyLoadError(a,Rm.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),r));o.decryptdata.key=a.decryptdata.key=new Uint8Array(e.data),a.keyLoader=null,o.loader=null,s({frag:a,keyInfo:o})},onError:(e,n,r,s)=>{this.resetLoader(n),i(this.createKeyLoadError(t,Rm.KEY_LOAD_ERROR,new Error(`HTTP Error ${e.code} loading key ${e.text}`),r,Tm({url:a.url,data:void 0},e)))},onTimeout:(e,n,r)=>{this.resetLoader(n),i(this.createKeyLoadError(t,Rm.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),r))},onAbort:(e,n,r)=>{this.resetLoader(n),i(this.createKeyLoadError(t,Rm.INTERNAL_ABORTED,new Error("key loading aborted"),r))}};r.load(a,l,c)}))}resetLoader(e){const{frag:t,keyInfo:n,url:r}=e,s=n.loader;t.keyLoader===s&&(t.keyLoader=null,n.loader=null),delete this.keyUriToKeyInfo[r],s&&s.destroy()}}const Ob={length:0,start:()=>0,end:()=>0};class Lb{static isBuffered(e,t){try{if(e){const n=Lb.getBuffered(e);for(let e=0;e<n.length;e++)if(t>=n.start(e)&&t<=n.end(e))return!0}}catch(e){}return!1}static bufferInfo(e,t,n){try{if(e){const r=Lb.getBuffered(e),s=[];let i;for(i=0;i<r.length;i++)s.push({start:r.start(i),end:r.end(i)});return this.bufferedInfo(s,t,n)}}catch(e){}return{len:0,start:t,end:t,nextStart:void 0}}static bufferedInfo(e,t,n){t=Math.max(0,t),e.sort((function(e,t){const n=e.start-t.start;return n||t.end-e.end}));let r=[];if(n)for(let t=0;t<e.length;t++){const s=r.length;if(s){const i=r[s-1].end;e[t].start-i<n?e[t].end>i&&(r[s-1].end=e[t].end):r.push(e[t])}else r.push(e[t])}else r=e;let s,i=0,a=t,o=t;for(let e=0;e<r.length;e++){const l=r[e].start,c=r[e].end;if(t+n>=l&&t<c)a=l,o=c,i=o-t;else if(t+n<l){s=l;break}}return{len:i,start:a||0,end:o||0,nextStart:s}}static getBuffered(e){try{return e.buffered}catch(e){return Pm.log("failed to get media.buffered",e),Ob}}}class Db{constructor(e,t,n,r=0,s=-1,i=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=e,this.sn=t,this.id=n,this.size=r,this.part=s,this.partial=i}}function xb(e,t){let n=null;for(let r=0,s=e.length;r<s;r++){const s=e[r];if(s&&s.cc===t){n=s;break}}return n}function Pb(e,t){if(e){const n=e.start+t;e.start=e.startPTS=n,e.endPTS=n+e.duration}}function Mb(e,t){const n=t.fragments;for(let t=0,r=n.length;t<r;t++)Pb(n[t],e);t.fragmentHint&&Pb(t.fragmentHint,e),t.alignedSliding=!0}function Fb(e,t,n){t&&(!function(e,t,n){if(function(e,t,n){return!(!t.details||!(n.endCC>n.startCC||e&&e.cc<n.startCC))}(e,n,t)){const e=function(e,t,n=0){const r=e.fragments,s=t.fragments;if(!s.length||!r.length)return void Pm.log("No fragments to align");const i=xb(r,s[0].cc);if(i&&(!i||i.startPTS))return i;Pm.log("No frag in previous level to align on")}(n.details,t);e&&km(e.start)&&(Pm.log(`Adjusting PTS using last level due to CC increase within current level ${t.url}`),Mb(e.start,t))}}(e,n,t),!n.alignedSliding&&t.details&&function(e,t){if(!t.fragments.length||!e.hasProgramDateTime||!t.hasProgramDateTime)return;const n=t.fragments[0].programDateTime,r=e.fragments[0].programDateTime,s=(r-n)/1e3+t.fragments[0].start;s&&km(s)&&(Pm.log(`Adjusting PTS using programDateTime delta ${r-n}ms, sliding:${s.toFixed(3)} ${e.url} `),Mb(s,e))}(n,t.details),n.alignedSliding||!t.details||n.skippedSegments||Vv(t.details,n))}function Ub(e,t){if(!e.hasProgramDateTime||!t.hasProgramDateTime)return;const n=e.fragments,r=t.fragments;if(!n.length||!r.length)return;const s=r[Math.round(r.length/2)-1],i=xb(n,s.cc)||n[Math.round(n.length/2)-1],a=s.programDateTime,o=i.programDateTime;if(null===a||null===o)return;Mb((o-a)/1e3-(i.start-s.start),e)}class Nb{constructor(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class Bb{constructor(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class jb{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),n=new Uint32Array(4);for(let e=0;e<4;e++)n[e]=t.getUint32(4*e);return n}initTable(){const e=this.sBox,t=this.invSBox,n=this.subMix,r=n[0],s=n[1],i=n[2],a=n[3],o=this.invSubMix,l=o[0],c=o[1],d=o[2],u=o[3],h=new Uint32Array(256);let f=0,p=0,g=0;for(g=0;g<256;g++)h[g]=g<128?g<<1:g<<1^283;for(g=0;g<256;g++){let n=p^p<<1^p<<2^p<<3^p<<4;n=n>>>8^255&n^99,e[f]=n,t[n]=f;const o=h[f],g=h[o],m=h[g];let y=257*h[n]^16843008*n;r[f]=y<<24|y>>>8,s[f]=y<<16|y>>>16,i[f]=y<<8|y>>>24,a[f]=y,y=16843009*m^65537*g^257*o^16843008*f,l[n]=y<<24|y>>>8,c[n]=y<<16|y>>>16,d[n]=y<<8|y>>>24,u[n]=y,f?(f=o^h[h[h[m^o]]],p^=h[h[p]]):f=p=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let n=!0,r=0;for(;r<t.length&&n;)n=t[r]===this.key[r],r++;if(n)return;this.key=t;const s=this.keySize=t.length;if(4!==s&&6!==s&&8!==s)throw new Error("Invalid aes key size="+s);const i=this.ksRows=4*(s+6+1);let a,o;const l=this.keySchedule=new Uint32Array(i),c=this.invKeySchedule=new Uint32Array(i),d=this.sBox,u=this.rcon,h=this.invSubMix,f=h[0],p=h[1],g=h[2],m=h[3];let y,v;for(a=0;a<i;a++)a<s?y=l[a]=t[a]:(v=y,a%s==0?(v=v<<8|v>>>24,v=d[v>>>24]<<24|d[v>>>16&255]<<16|d[v>>>8&255]<<8|d[255&v],v^=u[a/s|0]<<24):s>6&&a%s==4&&(v=d[v>>>24]<<24|d[v>>>16&255]<<16|d[v>>>8&255]<<8|d[255&v]),l[a]=y=(l[a-s]^v)>>>0);for(o=0;o<i;o++)a=i-o,v=3&o?l[a]:l[a-4],c[o]=o<4||a<=4?v:f[d[v>>>24]]^p[d[v>>>16&255]]^g[d[v>>>8&255]]^m[d[255&v]],c[o]=c[o]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,n){const r=this.keySize+6,s=this.invKeySchedule,i=this.invSBox,a=this.invSubMix,o=a[0],l=a[1],c=a[2],d=a[3],u=this.uint8ArrayToUint32Array_(n);let h=u[0],f=u[1],p=u[2],g=u[3];const m=new Int32Array(e),y=new Int32Array(m.length);let v,b,w,S,C,T,E,I,k,A,_,R,O,L;const D=this.networkToHostOrderSwap;for(;t<m.length;){for(k=D(m[t]),A=D(m[t+1]),_=D(m[t+2]),R=D(m[t+3]),C=k^s[0],T=R^s[1],E=_^s[2],I=A^s[3],O=4,L=1;L<r;L++)v=o[C>>>24]^l[T>>16&255]^c[E>>8&255]^d[255&I]^s[O],b=o[T>>>24]^l[E>>16&255]^c[I>>8&255]^d[255&C]^s[O+1],w=o[E>>>24]^l[I>>16&255]^c[C>>8&255]^d[255&T]^s[O+2],S=o[I>>>24]^l[C>>16&255]^c[T>>8&255]^d[255&E]^s[O+3],C=v,T=b,E=w,I=S,O+=4;v=i[C>>>24]<<24^i[T>>16&255]<<16^i[E>>8&255]<<8^i[255&I]^s[O],b=i[T>>>24]<<24^i[E>>16&255]<<16^i[I>>8&255]<<8^i[255&C]^s[O+1],w=i[E>>>24]<<24^i[I>>16&255]<<16^i[C>>8&255]<<8^i[255&T]^s[O+2],S=i[I>>>24]<<24^i[C>>16&255]<<16^i[T>>8&255]<<8^i[255&E]^s[O+3],y[t]=D(v^h),y[t+1]=D(S^f),y[t+2]=D(w^p),y[t+3]=D(b^g),h=k,f=A,p=_,g=R,t+=4}return y.buffer}}class $b{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const e=self.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(e){}null===this.subtle&&(this.useSoftware=!0)}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const n=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?function(e){const t=e.byteLength,n=t&&new DataView(e.buffer).getUint8(t-1);return n?oy(e,0,t-n):e}(n):n}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,n){return this.useSoftware?new Promise(((r,s)=>{this.softwareDecrypt(new Uint8Array(e),t,n);const i=this.flush();i?r(i.buffer):s(new Error("[softwareDecrypt] Failed to decrypt data"))})):this.webCryptoDecrypt(new Uint8Array(e),t,n)}softwareDecrypt(e,t,n){const{currentIV:r,currentResult:s,remainderData:i}=this;this.logOnce("JS AES decrypt"),i&&(e=Ny(i,e),this.remainderData=null);const a=this.getValidChunk(e);if(!a.length)return null;r&&(n=r);let o=this.softwareDecrypter;o||(o=this.softwareDecrypter=new jb),o.expandKey(t);const l=s;return this.currentResult=o.decrypt(a.buffer,0,n),this.currentIV=oy(a,-16).buffer,l||null}webCryptoDecrypt(e,t,n){const r=this.subtle;return this.key===t&&this.fastAesKey||(this.key=t,this.fastAesKey=new Bb(r,t)),this.fastAesKey.expandKey().then((t=>{if(!r)return Promise.reject(new Error("web crypto not initialized"));this.logOnce("WebCrypto AES decrypt");return new Nb(r,new Uint8Array(n)).decrypt(e.buffer,t)})).catch((r=>(Pm.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,n))))}onWebCryptoError(e,t,n){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,n);const r=this.flush();if(r)return r.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(e){let t=e;const n=e.length-e.length%16;return n!==e.length&&(t=oy(e,0,n),this.remainderData=oy(e,n)),t}logOnce(e){this.logEnabled&&(Pm.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const qb=function(e){let t="";const n=e.length;for(let r=0;r<n;r++)t+=`[${e.start(r).toFixed(3)}-${e.end(r).toFixed(3)}]`;return t},Kb="STOPPED",Gb="IDLE",Hb="KEY_LOADING",Vb="FRAG_LOADING",zb="FRAG_LOADING_WAITING_RETRY",Wb="WAITING_TRACK",Yb="PARSING",Qb="PARSED",Xb="ENDED",Jb="ERROR",Zb="WAITING_INIT_PTS",ew="WAITING_LEVEL";class tw extends class{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}{constructor(e,t,n,r,s){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=Kb,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=s,this.logPrefix=r,this.log=Pm.log.bind(Pm,`${r}:`),this.warn=Pm.warn.bind(Pm,`${r}:`),this.hls=e,this.fragmentLoader=new Ib(e.config),this.keyLoader=n,this.fragmentTracker=t,this.config=e.config,this.decrypter=new $b(e.config),e.on(Am.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;null!=e&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=Kb}_streamEnded(e,t){if(t.live||e.nextStart||!e.end||!this.media)return!1;const n=t.partList;if(null!=n&&n.length){const e=n[n.length-1];return Lb.isBuffered(this.media,e.start+e.duration/2)}const r=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(r)}getLevelDetails(){var e;if(this.levels&&null!==this.levelLastLoaded)return null==(e=this.levels[this.levelLastLoaded])?void 0:e.details}onMediaAttached(e,t){const n=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),n.addEventListener("seeking",this.onvseeking),n.addEventListener("ended",this.onvended);const r=this.config;this.levels&&r.autoStartLoad&&this.state===Kb&&this.startLoad(r.startPosition)}onMediaDetaching(){const e=this.media;null!=e&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&this.onvseeking&&this.onvended&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:e,fragCurrent:t,media:n,mediaBuffer:r,state:s}=this,i=n?n.currentTime:0,a=Lb.bufferInfo(r||n,i,e.maxBufferHole);if(this.log(`media seeking to ${km(i)?i.toFixed(3):i}, state: ${s}`),this.state===Xb)this.resetLoadingState();else if(t){const n=e.maxFragLookUpTolerance,r=t.start-n,s=t.start+t.duration+n;if(!a.len||s<a.start||r>a.end){const e=i>s;(i<r||e)&&(e&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}n&&(this.fragmentTracker.removeFragmentsInRange(i,1/0,this.playlistType,!0),this.lastCurrentTime=i),this.loadedmetadata||a.len||(this.nextLoadPosition=this.startPosition=i),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.stopLoad(),super.onHandlerDestroying()}onHandlerDestroyed(){this.state=Kb,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,n){this._loadFragForPlayback(e,t,n)}_loadFragForPlayback(e,t,n){this._doFragLoad(e,t,n,(t=>{if(this.fragContextChanged(e))return this.warn(`Fragment ${e.sn}${t.part?" p: "+t.part.index:""} of level ${e.level} was dropped during download.`),void this.fragmentTracker.removeFragment(e);e.stats.chunkCount++,this._handleFragmentLoadProgress(t)})).then((t=>{if(!t)return;const n=this.state;this.fragContextChanged(e)?(n===Vb||!this.fragCurrent&&n===Yb)&&(this.fragmentTracker.removeFragment(e),this.state=Gb):("payload"in t&&(this.log(`Loaded fragment ${e.sn} of level ${e.level}`),this.hls.trigger(Am.FRAG_LOADED,t)),this._handleFragmentLoadComplete(t))})).catch((t=>{this.state!==Kb&&this.state!==Jb&&(this.warn(t),this.resetFragmentLoading(e))}))}clearTrackerIfNeeded(e){var t;const{fragmentTracker:n}=this;if(n.getState(e)===vb){const t=e.type,r=this.getFwdBufferInfo(this.mediaBuffer,t),s=Math.max(e.duration,r?r.len:this.config.maxBufferLength);this.reduceMaxBufferLength(s)&&n.removeFragment(e)}else 0===(null==(t=this.mediaBuffer)?void 0:t.buffered.length)?n.removeAllFragments():n.hasParts(e.type)&&(n.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),n.getState(e)===bb&&n.removeFragment(e))}flushMainBuffer(e,t,n=null){if(!(e-t))return;const r={startOffset:e,endOffset:t,type:n};this.hls.trigger(Am.BUFFER_FLUSHING,r)}_loadInitSegment(e,t){this._doFragLoad(e,t).then((t=>{if(!t||this.fragContextChanged(e)||!this.levels)throw new Error("init load aborted");return t})).then((t=>{const{hls:n}=this,{payload:r}=t,s=e.decryptdata;if(r&&r.byteLength>0&&s&&s.key&&s.iv&&"AES-128"===s.method){const i=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),s.key.buffer,s.iv.buffer).catch((t=>{throw n.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.FRAG_DECRYPT_ERROR,fatal:!1,error:t,reason:t.message,frag:e}),t})).then((r=>{const s=self.performance.now();return n.trigger(Am.FRAG_DECRYPTED,{frag:e,payload:r,stats:{tstart:i,tdecrypt:s}}),t.payload=r,t}))}return t})).then((n=>{const{fragCurrent:r,hls:s,levels:i}=this;if(!i)throw new Error("init load aborted, missing levels");const a=e.stats;this.state=Gb,t.fragmentError=0,e.data=new Uint8Array(n.payload),a.parsing.start=a.buffering.start=self.performance.now(),a.parsing.end=a.buffering.end=self.performance.now(),n.frag===r&&s.trigger(Am.FRAG_BUFFERED,{stats:a,frag:r,part:null,id:e.type}),this.tick()})).catch((t=>{this.state!==Kb&&this.state!==Jb&&(this.warn(t),this.resetFragmentLoading(e))}))}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.level!==t.level||e.sn!==t.sn||e.urlId!==t.urlId}fragBufferedComplete(e,t){var n,r,s,i;const a=this.mediaBuffer?this.mediaBuffer:this.media;this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.playlistType===bv?"level":"track"} ${e.level} (frag:[${(null!=(n=e.startPTS)?n:NaN).toFixed(3)}-${(null!=(r=e.endPTS)?r:NaN).toFixed(3)}] > buffer:${a?qb(Lb.getBuffered(a)):"(detached)"})`),this.state=Gb,a&&(!this.loadedmetadata&&e.type==bv&&a.buffered.length&&(null==(s=this.fragCurrent)?void 0:s.sn)===(null==(i=this.fragPrevious)?void 0:i.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:n,part:r,partsLoaded:s}=e,i=!s||0===s.length||s.some((e=>!e)),a=new Db(n.level,n.sn,n.stats.chunkCount+1,0,r?r.index:-1,!i);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,n=null,r){var s;const i=null==t?void 0:t.details;if(!this.levels||!i)throw new Error(`frag load aborted, missing level${i?"":" detail"}s`);let a=null;if(!e.encrypted||null!=(s=e.decryptdata)&&s.key?!e.encrypted&&i.encryptedFragments.length&&this.keyLoader.loadClear(e,i.encryptedFragments):(this.log(`Loading key for ${e.sn} of [${i.startSN}-${i.endSN}], ${"[stream-controller]"===this.logPrefix?"level":"track"} ${e.level}`),this.state=Hb,this.fragCurrent=e,a=this.keyLoader.load(e).then((e=>{if(!this.fragContextChanged(e.frag))return this.hls.trigger(Am.KEY_LOADED,e),this.state===Hb&&(this.state=Gb),e})),this.hls.trigger(Am.KEY_LOADING,{frag:e}),null===this.fragCurrent&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))),n=Math.max(e.start,n||0),this.config.lowLatencyMode&&"initSegment"!==e.sn){const s=i.partList;if(s&&r){n>e.end&&i.fragmentHint&&(e=i.fragmentHint);const o=this.getNextPart(s,e,n);if(o>-1){const l=s[o];let c;return this.log(`Loading part sn: ${e.sn} p: ${l.index} cc: ${e.cc} of playlist [${i.startSN}-${i.endSN}] parts [0-${o}-${s.length-1}] ${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(n.toFixed(3))}`),this.nextLoadPosition=l.start+l.duration,this.state=Vb,c=a?a.then((n=>!n||this.fragContextChanged(n.frag)?null:this.doFragPartsLoad(e,l,t,r))).catch((e=>this.handleFragLoadError(e))):this.doFragPartsLoad(e,l,t,r).catch((e=>this.handleFragLoadError(e))),this.hls.trigger(Am.FRAG_LOADING,{frag:e,part:l,targetBufferTime:n}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):c}if(!e.url||this.loadedEndOfParts(s,n))return Promise.resolve(null)}}this.log(`Loading fragment ${e.sn} cc: ${e.cc} ${i?"of ["+i.startSN+"-"+i.endSN+"] ":""}${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(n.toFixed(3))}`),km(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=Vb;const o=this.config.progressive;let l;return l=o&&a?a.then((t=>!t||this.fragContextChanged(null==t?void 0:t.frag)?null:this.fragmentLoader.load(e,r))).catch((e=>this.handleFragLoadError(e))):Promise.all([this.fragmentLoader.load(e,o?r:void 0),a]).then((([e])=>(!o&&e&&r&&r(e),e))).catch((e=>this.handleFragLoadError(e))),this.hls.trigger(Am.FRAG_LOADING,{frag:e,targetBufferTime:n}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):l}doFragPartsLoad(e,t,n,r){return new Promise(((s,i)=>{var a;const o=[],l=null==(a=n.details)?void 0:a.partList,c=t=>{this.fragmentLoader.loadPart(e,t,r).then((r=>{o[t.index]=r;const i=r.part;this.hls.trigger(Am.FRAG_LOADED,r);const a=Wv(n,e.sn,t.index+1)||Yv(l,e.sn,t.index+1);if(!a)return s({frag:e,part:i,partsLoaded:o});c(a)})).catch(i)};c(t)}))}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===Rm.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(Am.ERROR,t)}else this.hls.trigger(Am.ERROR,{type:_m.OTHER_ERROR,details:Rm.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==Yb)return void(this.fragCurrent||this.state===Kb||this.state===Jb||(this.state=Gb));const{frag:n,part:r,level:s}=t,i=self.performance.now();n.stats.parsing.end=i,r&&(r.stats.parsing.end=i),this.updateLevelTiming(n,r,s,e.partial)}getCurrentContext(e){const{levels:t,fragCurrent:n}=this,{level:r,sn:s,part:i}=e;if(null==t||!t[r])return this.warn(`Levels object was unset while buffering fragment ${s} of level ${r}. The current chunk will not be buffered.`),null;const a=t[r],o=i>-1?Wv(a,s,i):null,l=o?o.fragment:function(e,t,n){if(null==e||!e.details)return null;const r=e.details;let s=r.fragments[t-r.startSN];return s||(s=r.fragmentHint,s&&s.sn===t?s:t<r.startSN&&n&&n.sn===t?n:null)}(a,s,n);return l?(n&&n!==l&&(l.stats=n.stats),{frag:l,part:o,level:a}):null}bufferFragmentData(e,t,n,r,s){var i;if(!e||this.state!==Yb)return;const{data1:a,data2:o}=e;let l=a;if(a&&o&&(l=Ny(a,o)),null==(i=l)||!i.length)return;const c={type:e.type,frag:t,part:n,chunkMeta:r,parent:t.type,data:l};if(this.hls.trigger(Am.BUFFER_APPENDING,c),e.dropped&&e.independent&&!n){if(s)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!Lb.isBuffered(t,t.currentTime))return void this.flushMainBuffer(0,e.start);const n=t.currentTime,r=Lb.bufferInfo(t,n,0),s=e.duration,i=Math.min(2*this.config.maxFragLookUpTolerance,.25*s),a=Math.max(Math.min(e.start-i,r.end-i),n+i);e.start-a>i&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){const n=this.getLoadPosition();return km(n)?this.getFwdBufferInfoAtPos(e,n,t):null}getFwdBufferInfoAtPos(e,t,n){const{config:{maxBufferHole:r}}=this,s=Lb.bufferInfo(e,t,r);if(0===s.len&&void 0!==s.nextStart){const i=this.fragmentTracker.getBufferedFrag(t,n);if(i&&s.nextStart<i.end)return Lb.bufferInfo(e,t,Math.max(s.nextStart,r))}return s}getMaxBufferLength(e){const{config:t}=this;let n;return n=e?Math.max(8*t.maxBufferSize/e,t.maxBufferLength):t.maxBufferLength,Math.min(n,t.maxMaxBufferLength)}reduceMaxBufferLength(e){const t=this.config,n=e||t.maxBufferLength;return t.maxMaxBufferLength>=n&&(t.maxMaxBufferLength/=2,this.warn(`Reduce max buffer length to ${t.maxMaxBufferLength}s`),!0)}getAppendedFrag(e,t=bv){const n=this.fragmentTracker.getAppendedFrag(e,bv);return n&&"fragment"in n?n.fragment:n}getNextFragment(e,t){const n=t.fragments,r=n.length;if(!r)return null;const{config:s}=this,i=n[0].start;let a;if(t.live){const i=s.initialLiveManifestSize;if(r<i)return this.warn(`Not enough fragments to start playback (have: ${r}, need: ${i})`),null;t.PTSKnown||this.startFragRequested||-1!==this.startPosition||(a=this.getInitialLiveFragment(t,n),this.startPosition=a?this.hls.liveSyncPosition||a.start:e)}else e<=i&&(a=n[0]);if(!a){const n=s.lowLatencyMode?t.partEnd:t.fragmentEnd;a=this.getFragmentAtPosition(e,n,t)}return this.mapToInitFragWhenRequired(a)}isLoopLoading(e,t){const n=this.fragmentTracker.getState(e);return(n===wb||n===bb&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,n,r,s){const i=e.gap,a=this.getNextFragment(this.nextLoadPosition,t);if(null===a)return a;if(e=a,i&&e&&!e.gap&&n.nextStart){const t=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,n.nextStart,r);if(null!==t&&n.len+t.len>=s)return this.log(`buffer full after gaps in "${r}" playlist starting at sn: ${e.sn}`),null}return e}mapToInitFragWhenRequired(e){return null==e||!e.initSegment||null!=e&&e.initSegment.data||this.bitrateTest?e:e.initSegment}getNextPart(e,t,n){let r=-1,s=!1,i=!0;for(let a=0,o=e.length;a<o;a++){const o=e[a];if(i=i&&!o.independent,r>-1&&n<o.start)break;const l=o.loaded;l?r=-1:(s||o.independent||i)&&o.fragment===t&&(r=a),s=l}return r}loadedEndOfParts(e,t){const n=e[e.length-1];return n&&t>n.start&&n.loaded}getInitialLiveFragment(e,t){const n=this.fragPrevious;let r=null;if(n){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${n.programDateTime}`),r=function(e,t,n){if(null===t||!Array.isArray(e)||!e.length||!km(t))return null;if(t<(e[0].programDateTime||0))return null;if(t>=(e[e.length-1].endProgramDateTime||0))return null;n=n||0;for(let r=0;r<e.length;++r){const s=e[r];if(sb(t,n,s))return s}return null}(t,n.endProgramDateTime,this.config.maxFragLookUpTolerance)),!r){const s=n.sn+1;if(s>=e.startSN&&s<=e.endSN){const i=t[s-e.startSN];n.cc===i.cc&&(r=i,this.log(`Live playlist, switching playlist, load frag with next SN: ${r.sn}`))}r||(r=function(e,t){return tb(e,(e=>e.cc<t?1:e.cc>t?-1:0))}(t,n.cc),r&&this.log(`Live playlist, switching playlist, load frag with same CC: ${r.sn}`))}}else{const t=this.hls.liveSyncPosition;null!==t&&(r=this.getFragmentAtPosition(t,this.bitrateTest?e.fragmentEnd:e.edge,e))}return r}getFragmentAtPosition(e,t,n){const{config:r}=this;let{fragPrevious:s}=this,{fragments:i,endSN:a}=n;const{fragmentHint:o}=n,l=r.maxFragLookUpTolerance,c=n.partList,d=!!(r.lowLatencyMode&&null!=c&&c.length&&o);let u;if(d&&o&&!this.bitrateTest&&(i=i.concat(o),a=o.sn),e<t){u=nb(s,i,e,e>t-l?0:l)}else u=i[i.length-1];if(u){const e=u.sn-n.startSN,t=this.fragmentTracker.getState(u);if((t===wb||t===bb&&u.gap)&&(s=u),s&&u.sn===s.sn&&(!d||c[0].fragment.sn>u.sn)){if(s&&u.level===s.level){const t=i[e+1];u=u.sn<a&&this.fragmentTracker.getState(t)!==wb?t:null}}}return u}synchronizeToLiveEdge(e){const{config:t,media:n}=this;if(!n)return;const r=this.hls.liveSyncPosition,s=n.currentTime,i=e.fragments[0].start,a=e.edge,o=s>=i-t.maxFragLookUpTolerance&&s<=a;if(null!==r&&n.duration>r&&(s<r||!o)){const i=void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!o&&n.readyState<4||s<a-i)&&(this.loadedmetadata||(this.nextLoadPosition=r),n.readyState&&(this.warn(`Playback: ${s.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${r.toFixed(3)}`),n.currentTime=r))}}alignPlaylists(e,t){const{levels:n,levelLastLoaded:r,fragPrevious:s}=this,i=null!==r?n[r]:null,a=e.fragments.length;if(!a)return this.warn("No fragments in live playlist"),0;const o=e.fragments[0].start,l=!t,c=e.alignedSliding&&km(o);if(l||!c&&!o){Fb(s,i,e);const n=e.fragments[0].start;return this.log(`Live playlist sliding: ${n.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} prev-sn: ${s?s.sn:"na"} fragments: ${a}`),n}return o}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,3*e.partTarget)}setStartPosition(e,t){let n=this.startPosition;if(n<t&&(n=-1),-1===n||-1===this.lastCurrentTime){const r=null!==this.startTimeOffset,s=r?this.startTimeOffset:e.startTimeOffset;null!==s&&km(s)?(n=t+s,s<0&&(n+=e.totalduration),n=Math.min(Math.max(t,n),t+e.totalduration),this.log(`Start time offset ${s} found in ${r?"multivariant":"media"} playlist, adjust startPosition to ${n}`),this.startPosition=n):e.live?n=this.hls.liveSyncPosition||t:this.startPosition=n=0,this.lastCurrentTime=n}this.nextLoadPosition=n}getLoadPosition(){const{media:e}=this;let t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}handleFragLoadAborted(e,t){this.transmuxer&&"initSegment"!==e.sn&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){this.fragCurrent&&(this.fragContextChanged(e)||this.state===zb)||(this.state=Gb)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const e=this.getCurrentContext(t.chunkMeta);e&&(t.frag=e.frag)}const n=t.frag;if(!n||n.type!==e||!this.levels)return;var r;if(this.fragContextChanged(n))return void this.warn(`Frag load error must match current frag to retry ${n.url} > ${null==(r=this.fragCurrent)?void 0:r.url}`);const s=t.details===Rm.FRAG_GAP;s&&this.fragmentTracker.fragBuffered(n,!0);const i=t.errorAction,{action:a,retryCount:o=0,retryConfig:l}=i||{};if(i&&a===ob&&l){var c;this.resetStartWhenNotLoaded(null!=(c=this.levelLastLoaded)?c:n.level);const r=Jv(l,o);this.warn(`Fragment ${n.sn} of ${e} ${n.level} errored with ${t.details}, retrying loading ${o+1}/${l.maxNumRetry} in ${r}ms`),i.resolved=!0,this.retryDate=self.performance.now()+r,this.state=zb}else l&&i?(this.resetFragmentErrors(e),o<l.maxNumRetry?s||(i.resolved=!0):Pm.warn(`${t.details} reached or exceeded max retry (${o})`)):(null==i?void 0:i.action)===ab?this.state=ew:this.state=Jb;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===Yb||this.state===Qb){const t=e.parent,n=this.getFwdBufferInfo(this.mediaBuffer,t),r=n&&n.len>.5;r&&this.reduceMaxBufferLength(n.len);const s=!r;return s&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${t} buffer`),e.frag&&(this.fragmentTracker.removeFragment(e.frag),this.nextLoadPosition=e.frag.start),this.resetLoadingState(),s}return!1}resetFragmentErrors(e){e===wv&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==Kb&&(this.state=Gb)}afterBufferFlushed(e,t,n){if(!e)return;const r=Lb.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,r,n),this.state===Xb&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=Gb}resetStartWhenNotLoaded(e){if(!this.loadedmetadata){this.startFragRequested=!1;const t=this.levels?this.levels[e].details:null;null!=t&&t.live?(this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){var t;this.warn(`The loading context changed while buffering fragment ${e.sn} of level ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(null!=(t=this.levelLastLoaded)?t:e.level),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,n,r){var s;const i=n.details;if(!i)return void this.warn("level.details undefined");if(Object.keys(e.elementaryStreams).reduce(((t,s)=>{const a=e.elementaryStreams[s];if(a){const o=a.endPTS-a.startPTS;if(o<=0)return this.warn(`Could not parse fragment ${e.sn} ${s} duration reliably (${o})`),t||!1;const l=r?0:Gv(i,e,a.startPTS,a.endPTS,a.startDTS,a.endDTS);return this.hls.trigger(Am.LEVEL_PTS_UPDATED,{details:i,level:n,drift:l,type:s,frag:e,start:a.startPTS,end:a.endPTS}),!0}return t}),!1))n.fragmentError=0;else if(null===(null==(s=this.transmuxer)?void 0:s.error)){const t=new Error(`Found no media in fragment ${e.sn} of level ${e.level} resetting transmuxer to fallback to playlist timing`);if(0===n.fragmentError&&(n.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)),this.warn(t.message),this.hls.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.FRAG_PARSING_ERROR,fatal:!1,error:t,frag:e,reason:`Found no media in msn ${e.sn} of level "${n.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=Qb,this.hls.trigger(Am.FRAG_PARSED,{frag:e,part:t})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(e){var t,n,r;"demuxerWorker"===e.event&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(null!=(t=null!=(n=this.levelLastLoaded)?n:null==(r=this.fragCurrent)?void 0:r.level)?t:0),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function nw(){return self.SourceBuffer||self.WebKitSourceBuffer}function rw(e="",t=9e4){return{type:e,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class sw{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,n,r){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,n){}demux(e,t){this.cachedData&&(e=Ny(this.cachedData,e),this.cachedData=null);let n,r=dy(e,0),s=r?r.length:0;const i=this._audioTrack,a=this._id3Track,o=r?(e=>{const t=gy(e);for(let e=0;e<t.length;e++){const n=t[e];if(fy(n))return wy(n)}})(r):void 0,l=e.length;for((null===this.basePTS||0===this.frameIndex&&km(o))&&(this.basePTS=iw(o,t,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),r&&r.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:Rv,duration:Number.POSITIVE_INFINITY});s<l;){if(this.canParse(e,s)){const t=this.appendFrame(i,e,s);t?(this.frameIndex++,this.lastPTS=t.sample.pts,s+=t.length,n=s):s=l}else hy(e,s)?(r=dy(e,s),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:Rv,duration:Number.POSITIVE_INFINITY}),s+=r.length,n=s):s++;if(s===l&&n!==l){const t=oy(e,n);this.cachedData?this.cachedData=Ny(this.cachedData,t):this.cachedData=t}}return{audioTrack:i,videoTrack:rw(),id3Track:a,textTrack:rw()}}demuxSampleAes(e,t,n){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:rw(),id3Track:this._id3Track,textTrack:rw()}}destroy(){}}const iw=(e,t,n)=>{if(km(e))return 90*e;return 9e4*t+(n?9e4*n.baseTime/n.timescale:0)};function aw(e,t){return 255===e[t]&&240==(246&e[t+1])}function ow(e,t){return 1&e[t+1]?7:9}function lw(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function cw(e,t){return t+1<e.length&&aw(e,t)}function dw(e,t){if(cw(e,t)){const n=ow(e,t);if(t+n>=e.length)return!1;const r=lw(e,t);if(r<=n)return!1;const s=t+r;return s===e.length||cw(e,s)}return!1}function uw(e,t,n,r,s){if(!e.samplerate){const i=function(e,t,n,r){let s,i,a,o;const l=navigator.userAgent.toLowerCase(),c=r,d=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=1+((192&t[n+2])>>>6);const u=(60&t[n+2])>>>2;if(!(u>d.length-1))return a=(1&t[n+2])<<2,a|=(192&t[n+3])>>>6,Pm.log(`manifest codec:${r}, ADTS type:${s}, samplingIndex:${u}`),/firefox/i.test(l)?u>=6?(s=5,o=new Array(4),i=u-3):(s=2,o=new Array(2),i=u):-1!==l.indexOf("android")?(s=2,o=new Array(2),i=u):(s=5,o=new Array(4),r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&u>=6?i=u-3:((r&&-1!==r.indexOf("mp4a.40.2")&&(u>=6&&1===a||/vivaldi/i.test(l))||!r&&1===a)&&(s=2,o=new Array(2)),i=u)),o[0]=s<<3,o[0]|=(14&u)>>1,o[1]|=(1&u)<<7,o[1]|=a<<3,5===s&&(o[1]|=(14&i)>>1,o[2]=(1&i)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:d[u],channelCount:a,codec:"mp4a.40."+s,manifestCodec:c};e.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ADTS sampling index:${u}`})}(t,n,r,s);if(!i)return;e.config=i.config,e.samplerate=i.samplerate,e.channelCount=i.channelCount,e.codec=i.codec,e.manifestCodec=i.manifestCodec,Pm.log(`parsed codec:${e.codec}, rate:${i.samplerate}, channels:${i.channelCount}`)}}function hw(e){return 9216e4/e}function fw(e,t,n,r,s){const i=r+s*hw(e.samplerate),a=function(e,t){const n=ow(e,t);if(t+n<=e.length){const r=lw(e,t)-n;if(r>0)return{headerLength:n,frameLength:r}}}(t,n);let o;if(a){const{frameLength:r,headerLength:s}=a,l=s+r,c=Math.max(0,n+l-t.length);c?(o=new Uint8Array(l-s),o.set(t.subarray(n+s,t.length),0)):o=t.subarray(n+s,n+l);const d={unit:o,pts:i};return c||e.samples.push(d),{sample:d,length:l,missing:c}}const l=t.length-n;o=new Uint8Array(l),o.set(t.subarray(n,t.length),0);return{sample:{unit:o,pts:i},length:l,missing:-1}}const pw=/\/emsg[-/]ID3/i;let gw=null;const mw=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],yw=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],vw=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],bw=[0,1,1,4];function ww(e,t,n,r,s){if(n+24>t.length)return;const i=Sw(t,n);if(i&&n+i.frameLength<=t.length){const a=r+s*(9e4*i.samplesPerFrame/i.sampleRate),o={unit:t.subarray(n,n+i.frameLength),pts:a,dts:a};return e.config=[],e.channelCount=i.channelCount,e.samplerate=i.sampleRate,e.samples.push(o),{sample:o,length:i.frameLength,missing:0}}}function Sw(e,t){const n=e[t+1]>>3&3,r=e[t+1]>>1&3,s=e[t+2]>>4&15,i=e[t+2]>>2&3;if(1!==n&&0!==s&&15!==s&&3!==i){const a=e[t+2]>>1&1,o=e[t+3]>>6,l=1e3*mw[14*(3===n?3-r:3===r?3:4)+s-1],c=yw[3*(3===n?0:2===n?1:2)+i],d=3===o?1:2,u=vw[n][r],h=bw[r],f=8*u*h,p=Math.floor(u*l/c+a)*h;if(null===gw){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);gw=e?parseInt(e[1]):0}return!!gw&&gw<=87&&2===r&&l>=224e3&&0===o&&(e[t+3]=128|e[t+3]),{sampleRate:c,channelCount:d,frameLength:p,samplesPerFrame:f}}}function Cw(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])}function Tw(e,t){return t+1<e.length&&Cw(e,t)}function Ew(e,t){if(t+1<e.length&&Cw(e,t)){const n=4,r=Sw(e,t);let s=n;null!=r&&r.frameLength&&(s=r.frameLength);const i=t+s;return i===e.length||Tw(e,i)}return!1}class Iw{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,n=e.byteLength-t,r=new Uint8Array(4),s=Math.min(4,t);if(0===s)throw new Error("no bytes available");r.set(e.subarray(n,n+s)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*s,this.bytesAvailable-=s}skipBits(e){let t;e=Math.min(e,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(t=(e-=this.bitsAvailable)>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const n=this.word>>>32-t;if(e>32&&Pm.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return t=e-t,t>0&&this.bitsAvailable?n<<t|this.readBits(t):n}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t,n=8,r=8;for(let s=0;s<e;s++)0!==r&&(t=this.readEG(),r=(n+t+256)%256),n=0===r?n:r}readSPS(){let e,t,n,r=0,s=0,i=0,a=0;const o=this.readUByte.bind(this),l=this.readBits.bind(this),c=this.readUEG.bind(this),d=this.readBoolean.bind(this),u=this.skipBits.bind(this),h=this.skipEG.bind(this),f=this.skipUEG.bind(this),p=this.skipScalingList.bind(this);o();const g=o();if(l(5),u(3),o(),f(),100===g||110===g||122===g||244===g||44===g||83===g||86===g||118===g||128===g){const e=c();if(3===e&&u(1),f(),f(),u(1),d())for(t=3!==e?8:12,n=0;n<t;n++)d()&&p(n<6?16:64)}f();const m=c();if(0===m)c();else if(1===m)for(u(1),h(),h(),e=c(),n=0;n<e;n++)h();f(),u(1);const y=c(),v=c(),b=l(1);0===b&&u(1),u(1),d()&&(r=c(),s=c(),i=c(),a=c());let w=[1,1];if(d()&&d()){switch(o()){case 1:w=[1,1];break;case 2:w=[12,11];break;case 3:w=[10,11];break;case 4:w=[16,11];break;case 5:w=[40,33];break;case 6:w=[24,11];break;case 7:w=[20,11];break;case 8:w=[32,11];break;case 9:w=[80,33];break;case 10:w=[18,11];break;case 11:w=[15,11];break;case 12:w=[64,33];break;case 13:w=[160,99];break;case 14:w=[4,3];break;case 15:w=[3,2];break;case 16:w=[2,1];break;case 255:w=[o()<<8|o(),o()<<8|o()]}}return{width:Math.ceil(16*(y+1)-2*r-2*s),height:(2-b)*(v+1)*16-(b?2:4)*(i+a),pixelRatio:w}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class kw{constructor(e,t,n){this.keyData=void 0,this.decrypter=void 0,this.keyData=n,this.decrypter=new $b(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(e,t,n){const r=e[t].unit;if(r.length<=16)return;const s=r.subarray(16,r.length-r.length%16),i=s.buffer.slice(s.byteOffset,s.byteOffset+s.length);this.decryptBuffer(i).then((s=>{const i=new Uint8Array(s);r.set(i,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,n)}))}decryptAacSamples(e,t,n){for(;;t++){if(t>=e.length)return void n();if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,n),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=16*Math.floor((e.length-48)/160)+16,n=new Int8Array(t);let r=0;for(let t=32;t<e.length-16;t+=160,r+=16)n.set(e.subarray(t,t+16),r);return n}getAvcDecryptedUnit(e,t){const n=new Uint8Array(t);let r=0;for(let t=32;t<e.length-16;t+=160,r+=16)e.set(n.subarray(r,r+16),t);return e}decryptAvcSample(e,t,n,r,s){const i=qy(s.data),a=this.getAvcEncryptedData(i);this.decryptBuffer(a.buffer).then((a=>{s.data=this.getAvcDecryptedUnit(i,a),this.decrypter.isSync()||this.decryptAvcSamples(e,t,n+1,r)}))}decryptAvcSamples(e,t,n,r){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,n=0){if(t>=e.length)return void r();const s=e[t].units;for(;!(n>=s.length);n++){const i=s[n];if(!(i.data.length<=48||1!==i.type&&5!==i.type||(this.decryptAvcSample(e,t,n,r,i),this.decrypter.isSync())))return}}}}const Aw=188;class _w{constructor(e,t,n){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=e,this.config=t,this.typeSupported=n}static probe(e){const t=_w.syncOffset(e);return t>0&&Pm.warn(`MPEG2-TS detected but first sync word found @ offset ${t}`),-1!==t}static syncOffset(e){const t=e.length;let n=Math.min(940,e.length-Aw)+1,r=0;for(;r<n;){let s=!1,i=-1,a=0;for(let o=r;o<t;o+=Aw){if(71!==e[o]){if(a)return-1;break}if(a++,-1===i&&(i=o,0!==i&&(n=Math.min(i+18612,e.length-Aw)+1)),s||(s=0===Ow(e,o)),s&&a>1&&(0===i&&a>2||o+Aw>n))return i}r++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:Ay[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,n,r){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=_w.createTrack("video"),this._audioTrack=_w.createTrack("audio",r),this._id3Track=_w.createTrack("id3"),this._txtTrack=_w.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=n,this._duration=r}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_avcTrack:t,_id3Track:n}=this;e&&(e.pesData=null),t&&(t.pesData=null),n&&(n.pesData=null),this.aacOverFlow=null,this.avcSample=null,this.remainderData=null}demux(e,t,n=!1,r=!1){let s;n||(this.sampleAes=null);const i=this._avcTrack,a=this._audioTrack,o=this._id3Track,l=this._txtTrack;let c=i.pid,d=i.pesData,u=a.pid,h=o.pid,f=a.pesData,p=o.pesData,g=null,m=this.pmtParsed,y=this._pmtId,v=e.length;if(this.remainderData&&(v=(e=Ny(this.remainderData,e)).length,this.remainderData=null),v<Aw&&!r)return this.remainderData=e,{audioTrack:a,videoTrack:i,id3Track:o,textTrack:l};const b=Math.max(0,_w.syncOffset(e));v-=(v-b)%Aw,v<e.byteLength&&!r&&(this.remainderData=new Uint8Array(e.buffer,v,e.buffer.byteLength-v));let w=0;for(let t=b;t<v;t+=Aw)if(71===e[t]){const r=!!(64&e[t+1]),v=Ow(e,t);let w;if((48&e[t+3])>>4>1){if(w=t+5+e[t+4],w===t+Aw)continue}else w=t+4;switch(v){case c:r&&(d&&(s=xw(d))&&this.parseAVCPES(i,l,s,!1),d={data:[],size:0}),d&&(d.data.push(e.subarray(w,t+Aw)),d.size+=t+Aw-w);break;case u:if(r){if(f&&(s=xw(f)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,s);break;case"mp3":this.parseMPEGPES(a,s)}f={data:[],size:0}}f&&(f.data.push(e.subarray(w,t+Aw)),f.size+=t+Aw-w);break;case h:r&&(p&&(s=xw(p))&&this.parseID3PES(o,s),p={data:[],size:0}),p&&(p.data.push(e.subarray(w,t+Aw)),p.size+=t+Aw-w);break;case 0:r&&(w+=e[w]+1),y=this._pmtId=Lw(e,w);break;case y:{r&&(w+=e[w]+1);const s=Dw(e,w,this.typeSupported,n);c=s.avc,c>0&&(i.pid=c),u=s.audio,u>0&&(a.pid=u,a.segmentCodec=s.segmentCodec),h=s.id3,h>0&&(o.pid=h),null===g||m||(Pm.warn(`MPEG-TS PMT found at ${t} after unknown PID '${g}'. Backtracking to sync byte @${b} to parse all TS packets.`),g=null,t=b-188),m=this.pmtParsed=!0;break}case 17:case 8191:break;default:g=v}}else w++;if(w>0){const e=new Error(`Found ${w} TS packet/s that do not start with 0x47`);this.observer.emit(Am.ERROR,Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message})}i.pesData=d,a.pesData=f,o.pesData=p;const S={audioTrack:a,videoTrack:i,id3Track:o,textTrack:l};return r&&this.extractRemainingSamples(S),S}flush(){const{remainderData:e}=this;let t;return this.remainderData=null,t=e?this.demux(e,-1,!1,!0):{videoTrack:this._avcTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:n,id3Track:r,textTrack:s}=e,i=n.pesData,a=t.pesData,o=r.pesData;let l;if(i&&(l=xw(i))?(this.parseAVCPES(n,s,l,!0),n.pesData=null):n.pesData=i,a&&(l=xw(a))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l)}t.pesData=null}else null!=a&&a.size&&Pm.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;o&&(l=xw(o))?(this.parseID3PES(r,l),r.pesData=null):r.pesData=o}demuxSampleAes(e,t,n){const r=this.demux(e,n,!0,!this.config.progressive),s=this.sampleAes=new kw(this.observer,this.config,t);return this.decrypt(r,s)}decrypt(e,t){return new Promise((n=>{const{audioTrack:r,videoTrack:s}=e;r.samples&&"aac"===r.segmentCodec?t.decryptAacSamples(r.samples,0,(()=>{s.samples?t.decryptAvcSamples(s.samples,0,0,(()=>{n(e)})):n(e)})):s.samples&&t.decryptAvcSamples(s.samples,0,0,(()=>{n(e)}))}))}destroy(){this._duration=0}parseAVCPES(e,t,n,r){const s=this.parseAVCNALu(e,n.data);let i,a=this.avcSample,o=!1;n.data=null,a&&s.length&&!e.audFound&&(Pw(a,e),a=this.avcSample=Rw(!1,n.pts,n.dts,"")),s.forEach((r=>{var s;switch(r.type){case 1:{let t=!1;i=!0;const s=r.data;if(o&&s.length>4){const e=new Iw(s).readSliceType();2!==e&&4!==e&&7!==e&&9!==e||(t=!0)}var l;if(t)null!=(l=a)&&l.frame&&!a.key&&(Pw(a,e),a=this.avcSample=null);a||(a=this.avcSample=Rw(!0,n.pts,n.dts,"")),a.frame=!0,a.key=t;break}case 5:i=!0,null!=(s=a)&&s.frame&&!a.key&&(Pw(a,e),a=this.avcSample=null),a||(a=this.avcSample=Rw(!0,n.pts,n.dts,"")),a.key=!0,a.frame=!0;break;case 6:i=!0,$y(r.data,1,n.pts,t.samples);break;case 7:if(i=!0,o=!0,!e.sps){const t=r.data,n=new Iw(t).readSPS();e.width=n.width,e.height=n.height,e.pixelRatio=n.pixelRatio,e.sps=[t],e.duration=this._duration;const s=t.subarray(1,4);let i="avc1.";for(let e=0;e<3;e++){let t=s[e].toString(16);t.length<2&&(t="0"+t),i+=t}e.codec=i}break;case 8:i=!0,e.pps||(e.pps=[r.data]);break;case 9:i=!1,e.audFound=!0,a&&Pw(a,e),a=this.avcSample=Rw(!1,n.pts,n.dts,"");break;case 12:i=!0;break;default:i=!1,a&&(a.debug+="unknown NAL "+r.type+" ")}if(a&&i){a.units.push(r)}})),r&&a&&(Pw(a,e),this.avcSample=null)}getLastNalUnit(e){var t;let n,r=this.avcSample;if(r&&0!==r.units.length||(r=e[e.length-1]),null!=(t=r)&&t.units){const e=r.units;n=e[e.length-1]}return n}parseAVCNALu(e,t){const n=t.byteLength;let r=e.naluState||0;const s=r,i=[];let a,o,l,c=0,d=-1,u=0;for(-1===r&&(d=0,u=31&t[0],r=0,c=1);c<n;)if(a=t[c++],r)if(1!==r)if(a)if(1===a){if(d>=0){const e={data:t.subarray(d,c-r-1),type:u};i.push(e)}else{const n=this.getLastNalUnit(e.samples);if(n&&(s&&c<=4-s&&n.state&&(n.data=n.data.subarray(0,n.data.byteLength-s)),o=c-r-1,o>0)){const e=new Uint8Array(n.data.byteLength+o);e.set(n.data,0),e.set(t.subarray(0,o),n.data.byteLength),n.data=e,n.state=0}}c<n?(l=31&t[c],d=c,u=l,r=0):r=-1}else r=0;else r=3;else r=a?0:2;else r=a?0:1;if(d>=0&&r>=0){const e={data:t.subarray(d,n),type:u,state:r};i.push(e)}if(0===i.length){const n=this.getLastNalUnit(e.samples);if(n){const e=new Uint8Array(n.data.byteLength+t.byteLength);e.set(n.data,0),e.set(t,n.data.byteLength),n.data=e}}return e.naluState=r,i}parseAACPES(e,t){let n=0;const r=this.aacOverFlow;let s,i,a,o=t.data;if(r){this.aacOverFlow=null;const t=r.missing,s=r.sample.unit.byteLength;if(-1===t){const e=new Uint8Array(s+o.byteLength);e.set(r.sample.unit,0),e.set(o,s),o=e}else{const i=s-t;r.sample.unit.set(o.subarray(0,t),i),e.samples.push(r.sample),n=r.missing}}for(s=n,i=o.length;s<i-1&&!cw(o,s);s++);if(s!==n){let e;const t=s<i-1;e=t?`AAC PES did not start with ADTS header,offset:${s}`:"No ADTS header found in AAC PES";const n=new Error(e);if(Pm.warn(`parsing error: ${e}`),this.observer.emit(Am.ERROR,Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:n,reason:e}),!t)return}if(uw(e,this.observer,o,s,this.audioCodec),void 0!==t.pts)a=t.pts;else{if(!r)return void Pm.warn("[tsdemuxer]: AAC PES unknown PTS");{const t=hw(e.samplerate);a=r.sample.pts+t}}let l,c=0;for(;s<i;){if(l=fw(e,o,s,a,c),s+=l.length,l.missing){this.aacOverFlow=l;break}for(c++;s<i-1&&!cw(o,s);s++);}}parseMPEGPES(e,t){const n=t.data,r=n.length;let s=0,i=0;const a=t.pts;if(void 0!==a)for(;i<r;)if(Tw(n,i)){const t=ww(e,n,i,a,s);if(!t)break;i+=t.length,s++}else i++;else Pm.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseID3PES(e,t){if(void 0===t.pts)return void Pm.warn("[tsdemuxer]: ID3 PES unknown PTS");const n=Im({},t,{type:this._avcTrack?Lv:Rv,duration:Number.POSITIVE_INFINITY});e.samples.push(n)}}function Rw(e,t,n,r){return{key:e,frame:!1,pts:t,dts:n,units:[],debug:r,length:0}}function Ow(e,t){return((31&e[t+1])<<8)+e[t+2]}function Lw(e,t){return(31&e[t+10])<<8|e[t+11]}function Dw(e,t,n,r){const s={audio:-1,avc:-1,id3:-1,segmentCodec:"aac"},i=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<i;){const i=Ow(e,t);switch(e[t]){case 207:if(!r){Pm.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:-1===s.audio&&(s.audio=i);break;case 21:-1===s.id3&&(s.id3=i);break;case 219:if(!r){Pm.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:-1===s.avc&&(s.avc=i);break;case 3:case 4:!0!==n.mpeg&&!0!==n.mp3?Pm.log("MPEG audio found, not supported in this browser"):-1===s.audio&&(s.audio=i,s.segmentCodec="mp3");break;case 36:Pm.warn("Unsupported HEVC stream type found")}t+=5+((15&e[t+3])<<8|e[t+4])}return s}function xw(e){let t,n,r,s,i,a=0;const o=e.data;if(!e||0===e.size)return null;for(;o[0].length<19&&o.length>1;){const e=new Uint8Array(o[0].length+o[1].length);e.set(o[0]),e.set(o[1],o[0].length),o[0]=e,o.splice(1,1)}t=o[0];if(1===(t[0]<<16)+(t[1]<<8)+t[2]){if(n=(t[4]<<8)+t[5],n&&n>e.size-6)return null;const l=t[7];192&l&&(s=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2,64&l?(i=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2,s-i>54e5&&(Pm.warn(`${Math.round((s-i)/9e4)}s delta between PTS and DTS, align them`),s=i)):i=s),r=t[8];let c=r+9;if(e.size<=c)return null;e.size-=c;const d=new Uint8Array(e.size);for(let e=0,n=o.length;e<n;e++){t=o[e];let n=t.byteLength;if(c){if(c>n){c-=n;continue}t=t.subarray(c),n-=c,c=0}d.set(t,a),a+=n}return n&&(n-=r+3),{data:d,pts:s,dts:i,len:n}}return null}function Pw(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){const n=t.samples,r=n.length;if(!r)return void t.dropped++;{const t=n[r-1];e.pts=t.pts,e.dts=t.dts}}t.samples.push(e)}e.debug.length&&Pm.log(e.pts+"/"+e.dts+":"+e.debug)}class Mw{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const Fw=Math.pow(2,32)-1;class Uw{static init(){let e;for(e in Uw.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},Uw.types)Uw.types.hasOwnProperty(e)&&(Uw.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),n=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);Uw.HDLR_TYPES={video:t,audio:n};const r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);Uw.STTS=Uw.STSC=Uw.STCO=s,Uw.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),Uw.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),Uw.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),Uw.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const i=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);Uw.FTYP=Uw.box(Uw.types.ftyp,i,o,i,a),Uw.DINF=Uw.box(Uw.types.dinf,Uw.box(Uw.types.dref,r))}static box(e,...t){let n=8,r=t.length;const s=r;for(;r--;)n+=t[r].byteLength;const i=new Uint8Array(n);for(i[0]=n>>24&255,i[1]=n>>16&255,i[2]=n>>8&255,i[3]=255&n,i.set(e,4),r=0,n=8;r<s;r++)i.set(t[r],n),n+=t[r].byteLength;return i}static hdlr(e){return Uw.box(Uw.types.hdlr,Uw.HDLR_TYPES[e])}static mdat(e){return Uw.box(Uw.types.mdat,e)}static mdhd(e,t){t*=e;const n=Math.floor(t/(Fw+1)),r=Math.floor(t%(Fw+1));return Uw.box(Uw.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,n>>24,n>>16&255,n>>8&255,255&n,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(e){return Uw.box(Uw.types.mdia,Uw.mdhd(e.timescale,e.duration),Uw.hdlr(e.type),Uw.minf(e))}static mfhd(e){return Uw.box(Uw.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?Uw.box(Uw.types.minf,Uw.box(Uw.types.smhd,Uw.SMHD),Uw.DINF,Uw.stbl(e)):Uw.box(Uw.types.minf,Uw.box(Uw.types.vmhd,Uw.VMHD),Uw.DINF,Uw.stbl(e))}static moof(e,t,n){return Uw.box(Uw.types.moof,Uw.mfhd(e),Uw.traf(n,t))}static moov(e){let t=e.length;const n=[];for(;t--;)n[t]=Uw.trak(e[t]);return Uw.box.apply(null,[Uw.types.moov,Uw.mvhd(e[0].timescale,e[0].duration)].concat(n).concat(Uw.mvex(e)))}static mvex(e){let t=e.length;const n=[];for(;t--;)n[t]=Uw.trex(e[t]);return Uw.box.apply(null,[Uw.types.mvex,...n])}static mvhd(e,t){t*=e;const n=Math.floor(t/(Fw+1)),r=Math.floor(t%(Fw+1)),s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,n>>24,n>>16&255,n>>8&255,255&n,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return Uw.box(Uw.types.mvhd,s)}static sdtp(e){const t=e.samples||[],n=new Uint8Array(4+t.length);let r,s;for(r=0;r<t.length;r++)s=t[r].flags,n[r+4]=s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy;return Uw.box(Uw.types.sdtp,n)}static stbl(e){return Uw.box(Uw.types.stbl,Uw.stsd(e),Uw.box(Uw.types.stts,Uw.STTS),Uw.box(Uw.types.stsc,Uw.STSC),Uw.box(Uw.types.stsz,Uw.STSZ),Uw.box(Uw.types.stco,Uw.STCO))}static avc1(e){let t,n,r,s=[],i=[];for(t=0;t<e.sps.length;t++)n=e.sps[t],r=n.byteLength,s.push(r>>>8&255),s.push(255&r),s=s.concat(Array.prototype.slice.call(n));for(t=0;t<e.pps.length;t++)n=e.pps[t],r=n.byteLength,i.push(r>>>8&255),i.push(255&r),i=i.concat(Array.prototype.slice.call(n));const a=Uw.box(Uw.types.avcC,new Uint8Array([1,s[3],s[4],s[5],255,224|e.sps.length].concat(s).concat([e.pps.length]).concat(i))),o=e.width,l=e.height,c=e.pixelRatio[0],d=e.pixelRatio[1];return Uw.box(Uw.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,Uw.box(Uw.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),Uw.box(Uw.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,255&c,d>>24,d>>16&255,d>>8&255,255&d])))}static esds(e){const t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static mp4a(e){const t=e.samplerate;return Uw.box(Uw.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0]),Uw.box(Uw.types.esds,Uw.esds(e)))}static mp3(e){const t=e.samplerate;return Uw.box(Uw.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0]))}static stsd(e){return"audio"===e.type?"mp3"===e.segmentCodec&&"mp3"===e.codec?Uw.box(Uw.types.stsd,Uw.STSD,Uw.mp3(e)):Uw.box(Uw.types.stsd,Uw.STSD,Uw.mp4a(e)):Uw.box(Uw.types.stsd,Uw.STSD,Uw.avc1(e))}static tkhd(e){const t=e.id,n=e.duration*e.timescale,r=e.width,s=e.height,i=Math.floor(n/(Fw+1)),a=Math.floor(n%(Fw+1));return Uw.box(Uw.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,a>>24,a>>16&255,a>>8&255,255&a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,s>>8&255,255&s,0,0]))}static traf(e,t){const n=Uw.sdtp(e),r=e.id,s=Math.floor(t/(Fw+1)),i=Math.floor(t%(Fw+1));return Uw.box(Uw.types.traf,Uw.box(Uw.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),Uw.box(Uw.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,i>>24,i>>16&255,i>>8&255,255&i])),Uw.trun(e,n.length+16+20+8+16+8+8),n)}static trak(e){return e.duration=e.duration||4294967295,Uw.box(Uw.types.trak,Uw.tkhd(e),Uw.mdia(e))}static trex(e){const t=e.id;return Uw.box(Uw.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const n=e.samples||[],r=n.length,s=12+16*r,i=new Uint8Array(s);let a,o,l,c,d,u;for(t+=8+s,i.set(["video"===e.type?1:0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,255&r,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),a=0;a<r;a++)o=n[a],l=o.duration,c=o.size,d=o.flags,u=o.cts,i.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,c>>>24&255,c>>>16&255,c>>>8&255,255&c,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,61440&d.degradPrio,15&d.degradPrio,u>>>24&255,u>>>16&255,u>>>8&255,255&u],12+16*a);return Uw.box(Uw.types.trun,i)}static initSegment(e){Uw.types||Uw.init();const t=Uw.moov(e),n=new Uint8Array(Uw.FTYP.byteLength+t.byteLength);return n.set(Uw.FTYP),n.set(t,Uw.FTYP.byteLength),n}}Uw.types=void 0,Uw.HDLR_TYPES=void 0,Uw.STTS=void 0,Uw.STSC=void 0,Uw.STCO=void 0,Uw.STSZ=void 0,Uw.VMHD=void 0,Uw.SMHD=void 0,Uw.STSD=void 0,Uw.FTYP=void 0,Uw.DINF=void 0;function Nw(e,t,n=1,r=!1){const s=e*t*n;return r?Math.round(s):s}function Bw(e,t=!1){return Nw(e,1e3,1/9e4,t)}let jw,$w=null,qw=null;class Kw{constructor(e,t,n,r=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=e,this.config=t,this.typeSupported=n,this.ISGenerated=!1,null===$w){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);$w=e?parseInt(e[1]):0}if(null===qw){const e=navigator.userAgent.match(/Safari\/(\d+)/i);qw=e?parseInt(e[1]):0}}destroy(){}resetTimeStamp(e){Pm.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){Pm.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){Pm.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1}getVideoStartPts(e){let t=!1;const n=e.reduce(((e,n)=>{const r=n.pts-e;return r<-4294967296?(t=!0,Gw(e,n.pts)):r>0?e:n.pts}),e[0].pts);return t&&Pm.debug("PTS rollover detected"),n}remux(e,t,n,r,s,i,a,o){let l,c,d,u,h,f,p=s,g=s;const m=e.pid>-1,y=t.pid>-1,v=t.samples.length,b=e.samples.length>0,w=a&&v>0||v>1;if((!m||b)&&(!y||w)||this.ISGenerated||a){this.ISGenerated||(d=this.generateIS(e,t,s,i));const n=this.isVideoContiguous;let r,a=-1;if(w&&(a=function(e){for(let t=0;t<e.length;t++)if(e[t].key)return t;return-1}(t.samples),!n&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,a>0){Pm.warn(`[mp4-remuxer]: Dropped ${a} out of ${v} video samples due to a missing keyframe`);const e=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(a),t.dropped+=a,g+=(t.samples[0].pts-e)/t.inputTimeScale,r=g}else-1===a&&(Pm.warn(`[mp4-remuxer]: No keyframe found out of ${v} video samples`),f=!1);if(this.ISGenerated){if(b&&w){const n=this.getVideoStartPts(t.samples),r=(Gw(e.samples[0].pts,n)-n)/t.inputTimeScale;p+=Math.max(0,r),g+=Math.max(0,-r)}if(b){if(e.samplerate||(Pm.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(e,t,s,i)),c=this.remuxAudio(e,p,this.isAudioContiguous,i,y||w||o===wv?g:void 0),w){const r=c?c.endPTS-c.startPTS:0;t.inputTimeScale||(Pm.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(e,t,s,i)),l=this.remuxVideo(t,g,n,r)}}else w&&(l=this.remuxVideo(t,g,n,0));l&&(l.firstKeyFrame=a,l.independent=-1!==a,l.firstKeyFramePTS=r)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(n.samples.length&&(h=Hw(n,s,this._initPTS,this._initDTS)),r.samples.length&&(u=Vw(r,s,this._initPTS))),{audio:c,video:l,initSegment:d,independent:f,text:u,id3:h}}generateIS(e,t,n,r){const s=e.samples,i=t.samples,a=this.typeSupported,o={},l=this._initPTS;let c,d,u,h=!l||r,f="audio/mp4";if(h&&(c=d=1/0),e.config&&s.length){if(e.timescale=e.samplerate,"mp3"===e.segmentCodec)a.mpeg?(f="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");o.audio={id:"audio",container:f,codec:e.codec,initSegment:"mp3"===e.segmentCodec&&a.mpeg?new Uint8Array(0):Uw.initSegment([e]),metadata:{channelCount:e.channelCount}},h&&(u=e.inputTimeScale,l&&u===l.timescale?h=!1:c=d=s[0].pts-Math.round(u*n))}if(t.sps&&t.pps&&i.length&&(t.timescale=t.inputTimeScale,o.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:Uw.initSegment([t]),metadata:{width:t.width,height:t.height}},h))if(u=t.inputTimeScale,l&&u===l.timescale)h=!1;else{const e=this.getVideoStartPts(i),t=Math.round(u*n);d=Math.min(d,Gw(i[0].dts,e)-t),c=Math.min(c,e-t)}if(Object.keys(o).length)return this.ISGenerated=!0,h?(this._initPTS={baseTime:c,timescale:u},this._initDTS={baseTime:d,timescale:u}):c=u=void 0,{tracks:o,initPTS:c,timescale:u}}remuxVideo(e,t,n,r){const s=e.inputTimeScale,i=e.samples,a=[],o=i.length,l=this._initPTS;let c,d,u=this.nextAvcDts,h=8,f=this.videoSampleDuration,p=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,m=!1;if(!n||null===u){u=t*s-(i[0].pts-Gw(i[0].dts,i[0].pts))}const y=l.baseTime*s/l.timescale;for(let e=0;e<o;e++){const t=i[e];t.pts=Gw(t.pts-y,u),t.dts=Gw(t.dts-y,u),t.dts<i[e>0?e-1:e].dts&&(m=!0)}m&&i.sort((function(e,t){const n=e.dts-t.dts,r=e.pts-t.pts;return n||r})),c=i[0].dts,d=i[i.length-1].dts;const v=d-c,b=v?Math.round(v/(o-1)):f||e.inputTimeScale/30;if(n){const e=c-u,t=e>b,n=e<-1;if((t||n)&&(t?Pm.warn(`AVC: ${Bw(e,!0)} ms (${e}dts) hole between fragments detected, filling it`):Pm.warn(`AVC: ${Bw(-e,!0)} ms (${e}dts) overlapping between fragments detected`),!n||u>=i[0].pts)){c=u;const t=i[0].pts-e;i[0].dts=c,i[0].pts=t,Pm.log(`Video: First PTS/DTS adjusted: ${Bw(t,!0)}/${Bw(c,!0)}, delta: ${Bw(e,!0)} ms`)}}c=Math.max(0,c);let w=0,S=0;for(let e=0;e<o;e++){const t=i[e],n=t.units,r=n.length;let s=0;for(let e=0;e<r;e++)s+=n[e].data.length;S+=s,w+=r,t.length=s,t.dts=Math.max(t.dts,c),p=Math.min(t.pts,p),g=Math.max(t.pts,g)}d=i[o-1].dts;const C=S+4*w+8;let T;try{T=new Uint8Array(C)}catch(e){return void this.observer.emit(Am.ERROR,Am.ERROR,{type:_m.MUX_ERROR,details:Rm.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:C,reason:`fail allocating video mdat ${C}`})}const E=new DataView(T.buffer);E.setUint32(0,C),T.set(Uw.types.mdat,4);let I=!1,k=Number.POSITIVE_INFINITY,A=Number.POSITIVE_INFINITY,_=Number.NEGATIVE_INFINITY,R=Number.NEGATIVE_INFINITY;for(let e=0;e<o;e++){const t=i[e],n=t.units;let l,c=0;for(let e=0,t=n.length;e<t;e++){const t=n[e],r=t.data,s=t.data.byteLength;E.setUint32(h,s),h+=4,T.set(r,h),h+=s,c+=4+s}if(e<o-1)f=i[e+1].dts-t.dts,l=i[e+1].pts-t.pts;else{const n=this.config,a=e>0?t.dts-i[e-1].dts:b;if(l=e>0?t.pts-i[e-1].pts:b,n.stretchShortVideoTrack&&null!==this.nextAudioPts){const e=Math.floor(n.maxBufferHole*s),i=(r?p+r*s:this.nextAudioPts)-t.pts;i>e?(f=i-a,f<0?f=a:I=!0,Pm.log(`[mp4-remuxer]: It is approximately ${i/90} ms to the next segment; using duration ${f/90} ms for the last video frame.`)):f=a}else f=a}const d=Math.round(t.pts-t.dts);k=Math.min(k,f),_=Math.max(_,f),A=Math.min(A,l),R=Math.max(R,l),a.push(new zw(t.key,f,c,d))}if(a.length)if($w){if($w<70){const e=a[0].flags;e.dependsOn=2,e.isNonSync=0}}else if(qw&&R-A<_-k&&b/_<.025&&0===a[0].cts){Pm.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let e=c;for(let t=0,n=a.length;t<n;t++){const r=e+a[t].duration,s=e+a[t].cts;if(t<n-1){const e=r+a[t+1].cts;a[t].duration=e-s}else a[t].duration=t?a[t-1].duration:b;a[t].cts=0,e=r}}f=I||!f?b:f,this.nextAvcDts=u=d+f,this.videoSampleDuration=f,this.isVideoContiguous=!0;const O={data1:Uw.moof(e.sequenceNumber++,c,Im({},e,{samples:a})),data2:T,startPTS:p/s,endPTS:(g+f)/s,startDTS:c/s,endDTS:u/s,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,O}remuxAudio(e,t,n,r,s){const i=e.inputTimeScale,a=i/(e.samplerate?e.samplerate:i),o="aac"===e.segmentCodec?1024:1152,l=o*a,c=this._initPTS,d="mp3"===e.segmentCodec&&this.typeSupported.mpeg,u=[],h=void 0!==s;let f=e.samples,p=d?0:8,g=this.nextAudioPts||-1;const m=t*i,y=c.baseTime*i/c.timescale;if(this.isAudioContiguous=n=n||f.length&&g>0&&(r&&Math.abs(m-g)<9e3||Math.abs(Gw(f[0].pts-y,m)-g)<20*l),f.forEach((function(e){e.pts=Gw(e.pts-y,m)})),!n||g<0){if(f=f.filter((e=>e.pts>=0)),!f.length)return;g=0===s?0:r&&!h?Math.max(0,m):f[0].pts}if("aac"===e.segmentCodec){const t=this.config.maxAudioFramesDrift;for(let n=0,r=g;n<f.length;n++){const s=f[n],a=s.pts,o=a-r,c=Math.abs(1e3*o/i);if(o<=-t*l&&h)0===n&&(Pm.warn(`Audio frame @ ${(a/i).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*o/i)} ms.`),this.nextAudioPts=g=r=a);else if(o>=t*l&&c<1e4&&h){let t=Math.round(o/l);r=a-t*l,r<0&&(t--,r+=l),0===n&&(this.nextAudioPts=g=r),Pm.warn(`[mp4-remuxer]: Injecting ${t} audio frame @ ${(r/i).toFixed(3)}s due to ${Math.round(1e3*o/i)} ms gap.`);for(let i=0;i<t;i++){const t=Math.max(r,0);let i=Mw.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);i||(Pm.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),i=s.unit.subarray()),f.splice(n,0,{unit:i,pts:t}),r+=l,n++}}s.pts=r,r+=l}}let v,b=null,w=null,S=0,C=f.length;for(;C--;)S+=f[C].unit.byteLength;for(let t=0,r=f.length;t<r;t++){const r=f[t],s=r.unit;let i=r.pts;if(null!==w){u[t-1].duration=Math.round((i-w)/a)}else{if(n&&"aac"===e.segmentCodec&&(i=g),b=i,!(S>0))return;S+=p;try{v=new Uint8Array(S)}catch(e){return void this.observer.emit(Am.ERROR,Am.ERROR,{type:_m.MUX_ERROR,details:Rm.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:S,reason:`fail allocating audio mdat ${S}`})}if(!d){new DataView(v.buffer).setUint32(0,S),v.set(Uw.types.mdat,4)}}v.set(s,p);const l=s.byteLength;p+=l,u.push(new zw(!0,o,l,0)),w=i}const T=u.length;if(!T)return;const E=u[u.length-1];this.nextAudioPts=g=w+a*E.duration;const I=d?new Uint8Array(0):Uw.moof(e.sequenceNumber++,b/a,Im({},e,{samples:u}));e.samples=[];const k=b/i,A=g/i,_={data1:I,data2:v,startPTS:k,endPTS:A,startDTS:k,endDTS:A,type:"audio",hasAudio:!0,hasVideo:!1,nb:T};return this.isAudioContiguous=!0,_}remuxEmptyAudio(e,t,n,r){const s=e.inputTimeScale,i=s/(e.samplerate?e.samplerate:s),a=this.nextAudioPts,o=this._initDTS,l=9e4*o.baseTime/o.timescale,c=(null!==a?a:r.startDTS*s)+l,d=r.endDTS*s+l,u=1024*i,h=Math.ceil((d-c)/u),f=Mw.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(Pm.warn("[mp4-remuxer]: remux empty Audio"),!f)return void Pm.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");const p=[];for(let e=0;e<h;e++){const t=c+e*u;p.push({unit:f,pts:t,dts:t})}return e.samples=p,this.remuxAudio(e,t,n,!1)}}function Gw(e,t){let n;if(null===t)return e;for(n=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=n;return e}function Hw(e,t,n,r){const s=e.samples.length;if(!s)return;const i=e.inputTimeScale;for(let a=0;a<s;a++){const s=e.samples[a];s.pts=Gw(s.pts-n.baseTime*i/n.timescale,t*i)/i,s.dts=Gw(s.dts-r.baseTime*i/r.timescale,t*i)/i}const a=e.samples;return e.samples=[],{samples:a}}function Vw(e,t,n){const r=e.samples.length;if(!r)return;const s=e.inputTimeScale;for(let i=0;i<r;i++){const r=e.samples[i];r.pts=Gw(r.pts-n.baseTime*s/n.timescale,t*s)/s}e.samples.sort(((e,t)=>e.pts-t.pts));const i=e.samples;return e.samples=[],{samples:i}}class zw{constructor(e,t,n,r){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=n,this.cts=r,this.flags=new Ww(e)}}class Ww{constructor(e){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=e?2:1,this.isNonSync=e?0:1}}function Yw(e,t){const n=null==e?void 0:e.codec;return n&&n.length>4?n:"hvc1"===n||"hev1"===n?"hvc1.1.6.L120.90":"av01"===n?"av01.0.04M.08":"avc1"===n||t===qm?"avc1.42e01e":"mp4a.40.5"}try{jw=self.performance.now.bind(self.performance)}catch(e){Pm.debug("Unable to use Performance API on this environment"),jw="undefined"!=typeof self&&self.Date.now}const Qw=[{demux:class{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,n,r){const s=this.videoTrack=rw("video",1),i=this.audioTrack=rw("audio",1),a=this.txtTrack=rw("text",1);if(this.id3Track=rw("id3",1),this.timeOffset=0,null==e||!e.byteLength)return;const o=My(e);if(o.video){const{id:e,timescale:t,codec:n}=o.video;s.id=e,s.timescale=a.timescale=t,s.codec=n}if(o.audio){const{id:e,timescale:t,codec:n}=o.audio;i.id=e,i.timescale=t,i.codec=n}a.id=Ay.text,s.sampleDuration=0,s.duration=i.duration=r}resetContiguity(){this.remainderData=null}static probe(e){return xy(e=e.length>16384?e.subarray(0,16384):e,["moof"]).length>0}demux(e,t){this.timeOffset=t;let n=e;const r=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(n=Ny(this.remainderData,e));const t=function(e){const t={valid:null,remainder:null},n=xy(e,["moof"]);if(!n)return t;if(n.length<2)return t.remainder=e,t;const r=n[n.length-1];return t.valid=oy(e,0,r.byteOffset-8),t.remainder=oy(e,r.byteOffset-8),t}(n);this.remainderData=t.remainder,r.samples=t.valid||new Uint8Array}else r.samples=n;const i=this.extractID3Track(r,t);return s.samples=By(t,r),{videoTrack:r,audioTrack:this.audioTrack,id3Track:i,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,n=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const r=this.extractID3Track(t,this.timeOffset);return n.samples=By(e,t),{videoTrack:t,audioTrack:rw(),id3Track:r,textTrack:rw()}}extractID3Track(e,t){const n=this.id3Track;if(e.samples.length){const r=xy(e.samples,["emsg"]);r&&r.forEach((e=>{const r=function(e){const t=e[0];let n="",r="",s=0,i=0,a=0,o=0,l=0,c=0;if(0===t){for(;"\0"!==_y(e.subarray(c,c+1));)n+=_y(e.subarray(c,c+1)),c+=1;for(n+=_y(e.subarray(c,c+1)),c+=1;"\0"!==_y(e.subarray(c,c+1));)r+=_y(e.subarray(c,c+1)),c+=1;r+=_y(e.subarray(c,c+1)),c+=1,s=Oy(e,12),i=Oy(e,16),o=Oy(e,20),l=Oy(e,24),c=28}else if(1===t){c+=4,s=Oy(e,c),c+=4;const t=Oy(e,c);c+=4;const i=Oy(e,c);for(c+=4,a=2**32*t+i,Number.isSafeInteger(a)||(a=Number.MAX_SAFE_INTEGER,Pm.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=Oy(e,c),c+=4,l=Oy(e,c),c+=4;"\0"!==_y(e.subarray(c,c+1));)n+=_y(e.subarray(c,c+1)),c+=1;for(n+=_y(e.subarray(c,c+1)),c+=1;"\0"!==_y(e.subarray(c,c+1));)r+=_y(e.subarray(c,c+1)),c+=1;r+=_y(e.subarray(c,c+1)),c+=1}return{schemeIdUri:n,value:r,timeScale:s,presentationTime:a,presentationTimeDelta:i,eventDuration:o,id:l,payload:e.subarray(c,e.byteLength)}}(e);if(pw.test(r.schemeIdUri)){const e=km(r.presentationTime)?r.presentationTime/r.timeScale:t+r.presentationTimeDelta/r.timeScale;let s=4294967295===r.eventDuration?Number.POSITIVE_INFINITY:r.eventDuration/r.timeScale;s<=.001&&(s=Number.POSITIVE_INFINITY);const i=r.payload;n.samples.push({data:i,len:i.byteLength,dts:e,pts:e,type:Lv,duration:s})}}))}return n}demuxSampleAes(e,t,n){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}},remux:class{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,t,n,r){this.audioCodec=t,this.videoCodec=n,this.generateInitSegment(function(e,t){if(!e||!t)return e;const n=t.keyId;n&&t.isCommonEncryption&&xy(e,["moov","trak"]).forEach((e=>{const t=xy(e,["mdia","minf","stbl","stsd"])[0].subarray(8);let r=xy(t,["enca"]);const s=r.length>0;s||(r=xy(t,["encv"])),r.forEach((e=>{xy(s?e.subarray(28):e.subarray(78),["sinf"]).forEach((e=>{const t=Fy(e);if(t){const e=t.subarray(8,24);e.some((e=>0!==e))||(Pm.log(`[eme] Patching keyId in 'enc${s?"a":"v"}>sinf>>tenc' box: ${Ey(e)} -> ${Ey(n)}`),t.set(n,8))}}))}))}));return e}(e,r)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:n}=this;if(null==e||!e.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const r=this.initData=My(e);t||(t=Yw(r.audio,$m)),n||(n=Yw(r.video,qm));const s={};r.audio&&r.video?s.audiovideo={container:"video/mp4",codec:t+","+n,initSegment:e,id:"main"}:r.audio?s.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:r.video?s.video={container:"video/mp4",codec:n,initSegment:e,id:"main"}:Pm.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=s}remux(e,t,n,r,s,i){var a,o;let{initPTS:l,lastEndTime:c}=this;const d={audio:void 0,video:void 0,text:r,id3:n,initSegment:void 0};km(c)||(c=this.lastEndTime=s||0);const u=t.samples;if(null==u||!u.length)return d;const h={initPTS:void 0,timescale:1};let f=this.initData;if(null!=(a=f)&&a.length||(this.generateInitSegment(u),f=this.initData),null==(o=f)||!o.length)return Pm.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),d;this.emitInitSegment&&(h.tracks=this.initTracks,this.emitInitSegment=!1);const p=function(e,t){let n=0,r=0,s=0;const i=xy(e,["moof","traf"]);for(let e=0;e<i.length;e++){const a=i[e],o=xy(a,["tfhd"])[0],l=t[Oy(o,4)];if(!l)continue;const c=l.default,d=Oy(o,0)|(null==c?void 0:c.flags);let u=null==c?void 0:c.duration;8&d&&(u=Oy(o,2&d?12:8));const h=l.timescale||9e4,f=xy(a,["trun"]);for(let e=0;e<f.length;e++)n=Uy(f[e]),!n&&u&&(n=u*Oy(f[e],4)),l.type===qm?r+=n/h:l.type===$m&&(s+=n/h)}if(0===r&&0===s){let t=0;const n=xy(e,["sidx"]);for(let e=0;e<n.length;e++){const r=Py(n[e]);null!=r&&r.references&&(t+=r.references.reduce(((e,t)=>e+t.info.duration||0),0))}return t}return r||s}(u,f),g=function(e,t){return xy(t,["moof","traf"]).reduce(((t,n)=>{const r=xy(n,["tfdt"])[0],s=r[0],i=xy(n,["tfhd"]).reduce(((t,n)=>{const i=Oy(n,4),a=e[i];if(a){let e=Oy(r,4);if(1===s){if(e===Iy)return Pm.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),t;e*=Iy+1,e+=Oy(r,8)}const n=e/(a.timescale||9e4);if(isFinite(n)&&(null===t||n<t))return n}return t}),null);return null!==i&&isFinite(i)&&(null===t||i<t)?i:t}),null)}(f,u),m=null===g?s:g;(function(e,t,n,r){if(null===e)return!0;const s=Math.max(r,1),i=t-e.baseTime/e.timescale;return Math.abs(i-n)>s}(l,m,s,p)||h.timescale!==l.timescale&&i)&&(h.initPTS=m-s,l&&1===l.timescale&&Pm.warn("Adjusting initPTS by "+(h.initPTS-l.baseTime)),this.initPTS=l={baseTime:h.initPTS,timescale:1});const y=e?m-l.baseTime/l.timescale:c,v=y+p;!function(e,t,n){xy(t,["moof","traf"]).forEach((t=>{xy(t,["tfhd"]).forEach((r=>{const s=Oy(r,4),i=e[s];if(!i)return;const a=i.timescale||9e4;xy(t,["tfdt"]).forEach((e=>{const t=e[0];let r=Oy(e,4);if(0===t)r-=n*a,r=Math.max(r,0),Dy(e,4,r);else{r*=Math.pow(2,32),r+=Oy(e,8),r-=n*a,r=Math.max(r,0);const t=Math.floor(r/(Iy+1)),s=Math.floor(r%(Iy+1));Dy(e,4,t),Dy(e,8,s)}}))}))}))}(f,u,l.baseTime/l.timescale),p>0?this.lastEndTime=v:(Pm.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const b=!!f.audio,w=!!f.video;let S="";b&&(S+="audio"),w&&(S+="video");const C={data1:u,startPTS:y,startDTS:y,endPTS:v,endDTS:v,type:S,hasAudio:b,hasVideo:w,nb:1,dropped:0};return d.audio="audio"===C.type?C:void 0,d.video="audio"!==C.type?C:void 0,d.initSegment=h,d.id3=Hw(n,s,l,l),r.samples.length&&(d.text=Vw(r,s,l)),d}}},{demux:_w,remux:Kw},{demux:class extends sw{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,n,r){super.resetInitSegment(e,t,n,r),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;let t=(dy(e,0)||[]).length;for(let n=e.length;t<n;t++)if(dw(e,t))return Pm.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return function(e,t){return t+5<e.length}(e,t)&&aw(e,t)&&lw(e,t)<=e.length-t}(e,t)}appendFrame(e,t,n){uw(e,this.observer,t,n,e.manifestCodec);const r=fw(e,t,n,this.basePTS,this.frameIndex);if(r&&0===r.missing)return r}},remux:Kw},{demux:class extends sw{resetInitSegment(e,t,n,r){super.resetInitSegment(e,t,n,r),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;let t=(dy(e,0)||[]).length;for(let n=e.length;t<n;t++)if(Ew(e,t))return Pm.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return Cw(e,t)&&4<=e.length-t}(e,t)}appendFrame(e,t,n){if(null!==this.basePTS)return ww(e,t,n,this.basePTS,this.frameIndex)}},remux:Kw}];class Xw{constructor(e,t,n,r,s){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=n,this.vendor=r,this.id=s}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,n,r){const s=n.transmuxing;s.executeStart=jw();let i=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:o}=this;r&&(this.currentTransmuxState=r);const{contiguous:l,discontinuity:c,trackSwitch:d,accurateTimeOffset:u,timeOffset:h,initSegmentChange:f}=r||a,{audioCodec:p,videoCodec:g,defaultInitPts:m,duration:y,initSegmentData:v}=o,b=function(e,t){let n=null;e.byteLength>0&&null!=t&&null!=t.key&&null!==t.iv&&null!=t.method&&(n=t);return n}(i,t);if(b&&"AES-128"===b.method){const e=this.getDecrypter();if(!e.isSync())return this.decryptionPromise=e.webCryptoDecrypt(i,b.key.buffer,b.iv.buffer).then((e=>{const t=this.push(e,null,n);return this.decryptionPromise=null,t})),this.decryptionPromise;{let t=e.softwareDecrypt(i,b.key.buffer,b.iv.buffer);if(n.part>-1&&(t=e.flush()),!t)return s.executeEnd=jw(),Jw(n);i=new Uint8Array(t)}}const w=this.needsProbing(c,d);if(w){const e=this.configureTransmuxer(i);if(e)return Pm.warn(`[transmuxer] ${e.message}`),this.observer.emit(Am.ERROR,Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message}),s.executeEnd=jw(),Jw(n)}(c||d||f||w)&&this.resetInitSegment(v,p,g,y,t),(c||f||w)&&this.resetInitialTimestamp(m),l||this.resetContiguity();const S=this.transmux(i,b,h,u,n),C=this.currentTransmuxState;return C.contiguous=!0,C.discontinuity=!1,C.trackSwitch=!1,s.executeEnd=jw(),S}flush(e){const t=e.transmuxing;t.executeStart=jw();const{decrypter:n,currentTransmuxState:r,decryptionPromise:s}=this;if(s)return s.then((()=>this.flush(e)));const i=[],{timeOffset:a}=r;if(n){const t=n.flush();t&&i.push(this.push(t,null,e))}const{demuxer:o,remuxer:l}=this;if(!o||!l)return t.executeEnd=jw(),[Jw(e)];const c=o.flush(a);return Zw(c)?c.then((t=>(this.flushRemux(i,t,e),i))):(this.flushRemux(i,c,e),i)}flushRemux(e,t,n){const{audioTrack:r,videoTrack:s,id3Track:i,textTrack:a}=t,{accurateTimeOffset:o,timeOffset:l}=this.currentTransmuxState;Pm.log(`[transmuxer.ts]: Flushed fragment ${n.sn}${n.part>-1?" p: "+n.part:""} of level ${n.level}`);const c=this.remuxer.remux(r,s,i,a,l,o,!0,this.id);e.push({remuxResult:c,chunkMeta:n}),n.transmuxing.executeEnd=jw()}resetInitialTimestamp(e){const{demuxer:t,remuxer:n}=this;t&&n&&(t.resetTimeStamp(e),n.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;e&&t&&(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,n,r,s){const{demuxer:i,remuxer:a}=this;i&&a&&(i.resetInitSegment(e,t,n,r),a.resetInitSegment(e,t,n,s))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,n,r,s){let i;return i=t&&"SAMPLE-AES"===t.method?this.transmuxSampleAes(e,t,n,r,s):this.transmuxUnencrypted(e,n,r,s),i}transmuxUnencrypted(e,t,n,r){const{audioTrack:s,videoTrack:i,id3Track:a,textTrack:o}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(s,i,a,o,t,n,!1,this.id),chunkMeta:r}}transmuxSampleAes(e,t,n,r,s){return this.demuxer.demuxSampleAes(e,t,n).then((e=>({remuxResult:this.remuxer.remux(e.audioTrack,e.videoTrack,e.id3Track,e.textTrack,n,r,!1,this.id),chunkMeta:s})))}configureTransmuxer(e){const{config:t,observer:n,typeSupported:r,vendor:s}=this;let i;for(let t=0,n=Qw.length;t<n;t++)if(Qw[t].demux.probe(e)){i=Qw[t];break}if(!i)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,o=this.remuxer,l=i.remux,c=i.demux;o&&o instanceof l||(this.remuxer=new l(n,t,r,s)),a&&a instanceof c||(this.demuxer=new c(n,t,r),this.probe=c.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new $b(this.config)),e}}const Jw=e=>({remuxResult:{},chunkMeta:e});function Zw(e){return"then"in e&&e.then instanceof Function}class eS{constructor(e,t,n,r,s){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=n,this.duration=r,this.defaultInitPts=s||null}}class tS{constructor(e,t,n,r,s,i){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=n,this.trackSwitch=r,this.timeOffset=s,this.initSegmentChange=i}}var nS={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function i(e,t,r,i,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,i||e,a),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,i=r.length,a=new Array(i);s<i;s++)a[s]=r[s].fn;return a},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,i,a){var o=n?n+e:e;if(!this._events[o])return!1;var l,c,d=this._events[o],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,r),!0;case 4:return d.fn.call(d.context,t,r,s),!0;case 5:return d.fn.call(d.context,t,r,s,i),!0;case 6:return d.fn.call(d.context,t,r,s,i,a),!0}for(c=1,l=new Array(u-1);c<u;c++)l[c-1]=arguments[c];d.fn.apply(d.context,l)}else{var h,f=d.length;for(c=0;c<f;c++)switch(d[c].once&&this.removeListener(e,d[c].fn,void 0,!0),u){case 1:d[c].fn.call(d[c].context);break;case 2:d[c].fn.call(d[c].context,t);break;case 3:d[c].fn.call(d[c].context,t,r);break;case 4:d[c].fn.call(d[c].context,t,r,s);break;default:if(!l)for(h=1,l=new Array(u-1);h<u;h++)l[h-1]=arguments[h];d[c].fn.apply(d[c].context,l)}}return!0},o.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,s){var i=n?n+e:e;if(!this._events[i])return this;if(!t)return a(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||a(this,i);else{for(var l=0,c=[],d=o.length;l<d;l++)(o[l].fn!==t||s&&!o[l].once||r&&o[l].context!==r)&&c.push(o[l]);c.length?this._events[i]=1===c.length?c[0]:c:a(this,i)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(nS);var rS=bm(nS.exports);const sS=Jy()||{isTypeSupported:()=>!1};class iS{constructor(e,t,n,r){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const s=e.config;this.hls=e,this.id=t,this.useWorker=!!s.enableWorker,this.onTransmuxComplete=n,this.onFlush=r;const i=(e,t)=>{(t=t||{}).frag=this.frag,t.id=this.id,e===Am.ERROR&&(this.error=t.error),this.hls.trigger(e,t)};this.observer=new rS,this.observer.on(Am.FRAG_DECRYPTED,i),this.observer.on(Am.ERROR,i);const a={mp4:sS.isTypeSupported("video/mp4"),mpeg:sS.isTypeSupported("audio/mpeg"),mp3:sS.isTypeSupported('audio/mp4; codecs="mp3"')},o=navigator.vendor;if(this.useWorker&&"undefined"!=typeof Worker){if(s.workerPath||"function"==typeof __HLS_WORKER_BUNDLE__){try{s.workerPath?(Pm.log(`loading Web Worker ${s.workerPath} for "${t}"`),this.workerContext=function(e){const t=new self.URL(e,self.location.href).href;return{worker:new self.Worker(t),scriptURL:t}}(s.workerPath)):(Pm.log(`injecting Web Worker for "${t}"`),this.workerContext=function(){const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e);return{worker:new self.Worker(t),objectURL:t}}()),this.onwmsg=e=>this.onWorkerMessage(e);const{worker:e}=this.workerContext;e.addEventListener("message",this.onwmsg),e.onerror=e=>{const n=new Error(`${e.message}  (${e.filename}:${e.lineno})`);s.enableWorker=!1,Pm.warn(`Error in "${t}" Web Worker, fallback to inline`),this.hls.trigger(Am.ERROR,{type:_m.OTHER_ERROR,details:Rm.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:n})},e.postMessage({cmd:"init",typeSupported:a,vendor:o,id:t,config:JSON.stringify(s)})}catch(e){Pm.warn(`Error setting up "${t}" Web Worker, fallback to inline`,e),this.resetWorker(),this.error=null,this.transmuxer=new Xw(this.observer,a,s,o,t)}return}}this.transmuxer=new Xw(this.observer,a,s,o,t)}resetWorker(){if(this.workerContext){const{worker:e,objectURL:t}=this.workerContext;t&&self.URL.revokeObjectURL(t),e.removeEventListener("message",this.onwmsg),e.onerror=null,e.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(e,t,n,r,s,i,a,o,l,c){var d,u;l.transmuxing.start=self.performance.now();const{transmuxer:h}=this,f=i?i.start:s.start,p=s.decryptdata,g=this.frag,m=!(g&&s.cc===g.cc),y=!(g&&l.level===g.level),v=g?l.sn-g.sn:-1,b=this.part?l.part-this.part.index:-1,w=0===v&&l.id>1&&l.id===(null==g?void 0:g.stats.chunkCount),S=!y&&(1===v||0===v&&(1===b||w&&b<=0)),C=self.performance.now();(y||v||0===s.stats.parsing.start)&&(s.stats.parsing.start=C),!i||!b&&S||(i.stats.parsing.start=C);const T=!(g&&(null==(d=s.initSegment)?void 0:d.url)===(null==(u=g.initSegment)?void 0:u.url)),E=new tS(m,S,o,y,f,T);if(!S||m||T){Pm.log(`[transmuxer-interface, ${s.type}]: Starting new transmux session for sn: ${l.sn} p: ${l.part} level: ${l.level} id: ${l.id}\n        discontinuity: ${m}\n        trackSwitch: ${y}\n        contiguous: ${S}\n        accurateTimeOffset: ${o}\n        timeOffset: ${f}\n        initSegmentChange: ${T}`);const e=new eS(n,r,t,a,c);this.configureTransmuxer(e)}if(this.frag=s,this.part=i,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:e,decryptdata:p,chunkMeta:l,state:E},e instanceof ArrayBuffer?[e]:[]);else if(h){const t=h.push(e,p,l,E);Zw(t)?(h.async=!0,t.then((e=>{this.handleTransmuxComplete(e)})).catch((e=>{this.transmuxerError(e,l,"transmuxer-interface push error")}))):(h.async=!1,this.handleTransmuxComplete(t))}}flush(e){e.transmuxing.start=self.performance.now();const{transmuxer:t}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:e});else if(t){let n=t.flush(e);Zw(n)||t.async?(Zw(n)||(n=Promise.resolve(n)),n.then((t=>{this.handleFlushResult(t,e)})).catch((t=>{this.transmuxerError(t,e,"transmuxer-interface flush error")}))):this.handleFlushResult(n,e)}}transmuxerError(e,t,n){this.hls&&(this.error=e,this.hls.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.FRAG_PARSING_ERROR,chunkMeta:t,fatal:!1,error:e,err:e,reason:n}))}handleFlushResult(e,t){e.forEach((e=>{this.handleTransmuxComplete(e)})),this.onFlush(t)}onWorkerMessage(e){const t=e.data,n=this.hls;switch(t.event){case"init":{var r;const e=null==(r=this.workerContext)?void 0:r.objectURL;e&&self.URL.revokeObjectURL(e);break}case"transmuxComplete":this.handleTransmuxComplete(t.data);break;case"flush":this.onFlush(t.data);break;case"workerLog":Pm[t.data.logType]&&Pm[t.data.logType](t.data.message);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,n.trigger(t.event,t.data)}}configureTransmuxer(e){const{transmuxer:t}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:e}):t&&t.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}class aS{constructor(e,t,n,r){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=n,this.hls=r}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(e,t){const{config:n,media:r,stalled:s}=this;if(null===r)return;const{currentTime:i,seeking:a}=r,o=this.seeking&&!a,l=!this.seeking&&a;if(this.seeking=a,i!==e){if(this.moved=!0,null!==s){if(this.stallReported){const e=self.performance.now()-s;Pm.warn(`playback not stuck anymore @${i}, after ${Math.round(e)}ms`),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if(l||o)return void(this.stalled=null);if(r.paused&&!a||r.ended||0===r.playbackRate||!Lb.getBuffered(r).length)return;const c=Lb.bufferInfo(r,i,0),d=c.len>0,u=c.nextStart||0;if(!d&&!u)return;if(a){const e=c.len>2,n=!u||t&&t.start<=i||u-i>2&&!this.fragmentTracker.getPartialFragment(i);if(e||n)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var h;const e=Math.max(u,c.start||0)-i,t=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,n=(null==t||null==(h=t.details)?void 0:h.live)?2*t.details.targetduration:2,r=this.fragmentTracker.getPartialFragment(i);if(e>0&&(e<=n||r))return void this._trySkipBufferHole(r)}const f=self.performance.now();if(null===s)return void(this.stalled=f);const p=f-s;if(!a&&p>=250&&(this._reportStall(c),!this.media))return;const g=Lb.bufferInfo(r,i,n.maxBufferHole);this._tryFixBufferStall(g,p)}_tryFixBufferStall(e,t){const{config:n,fragmentTracker:r,media:s}=this;if(null===s)return;const i=s.currentTime,a=r.getPartialFragment(i);if(a){if(this._trySkipBufferHole(a)||!this.media)return}(e.len>n.maxBufferHole||e.nextStart&&e.nextStart-i<n.maxBufferHole)&&t>1e3*n.highBufferWatchdogPeriod&&(Pm.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(e){const{hls:t,media:n,stallReported:r}=this;if(!r&&n){this.stallReported=!0;const r=new Error(`Playback stalling at @${n.currentTime} due to low buffer (${JSON.stringify(e)})`);Pm.warn(r.message),t.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:e.len})}}_trySkipBufferHole(e){const{config:t,hls:n,media:r}=this;if(null===r)return 0;const s=r.currentTime,i=Lb.bufferInfo(r,s,0),a=s<i.start?i.start:i.nextStart;if(a){const o=i.len<=t.maxBufferHole,l=i.len>0&&i.len<1&&r.readyState<3,c=a-s;if(c>0&&(o||l)){if(c>t.maxBufferHole){const{fragmentTracker:t}=this;let n=!1;if(0===s){const e=t.getAppendedFrag(0,bv);e&&a<e.end&&(n=!0)}if(!n){const n=e||t.getAppendedFrag(s,bv);if(n){let e=!1,r=n.end;for(;r<a;){const n=t.getPartialFragment(r);if(!n){e=!0;break}r+=n.duration}if(e)return 0}}}const i=Math.max(a+.05,s+.1);if(Pm.warn(`skipping hole, adjusting currentTime from ${s} to ${i}`),this.moved=!0,this.stalled=null,r.currentTime=i,e&&!e.gap){const t=new Error(`fragment loaded with buffer holes, seeking from ${s} to ${i}`);n.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:t,reason:t.message,frag:e})}return i}}return 0}_tryNudgeBuffer(){const{config:e,hls:t,media:n,nudgeRetry:r}=this;if(null===n)return;const s=n.currentTime;if(this.nudgeRetry++,r<e.nudgeMaxRetry){const i=s+(r+1)*e.nudgeOffset,a=new Error(`Nudging 'currentTime' from ${s} to ${i}`);Pm.warn(a.message),n.currentTime=i,t.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.BUFFER_NUDGE_ON_STALL,error:a,fatal:!1})}else{const n=new Error(`Playhead still not moving while enough data buffered @${s} after ${e.nudgeMaxRetry} nudges`);Pm.error(n.message),t.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.BUFFER_STALLED_ERROR,error:n,fatal:!0})}}}class oS extends tw{constructor(e,t,n){super(e,t,n,"[stream-controller]",bv),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Am.LEVEL_LOADING,this.onLevelLoading,this),e.on(Am.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Am.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(Am.ERROR,this.onError,this),e.on(Am.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(Am.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(Am.BUFFER_CREATED,this.onBufferCreated,this),e.on(Am.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(Am.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(Am.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Am.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Am.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(Am.ERROR,this.onError,this),e.off(Am.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(Am.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(Am.BUFFER_CREATED,this.onBufferCreated,this),e.off(Am.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(Am.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(Am.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),this.onMediaDetaching()}startLoad(e){if(this.levels){const{lastCurrentTime:t,hls:n}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let e=n.startLevel;-1===e&&(n.config.testBandwidth&&this.levels.length>1?(e=0,this.bitrateTest=!0):e=n.nextAutoLevel),this.level=n.nextLoadLevel=e,this.loadedmetadata=!1}t>0&&-1===e&&(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t),this.state=Gb,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=Kb}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case ew:{var e;const{levels:t,level:n}=this,r=null==t||null==(e=t[n])?void 0:e.details;if(r&&(!r.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(r))break;this.state=Gb;break}if(this.hls.nextLoadLevel!==this.level){this.state=Gb;break}break}case zb:{var t;const e=self.performance.now(),n=this.retryDate;(!n||e>=n||null!=(t=this.media)&&t.seeking)&&(this.resetStartWhenNotLoaded(this.level),this.state=Gb)}}this.state===Gb&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:n,media:r}=this,{config:s,nextLoadLevel:i}=e;if(null===t||!r&&(this.startFragRequested||!s.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;if(null==n||!n[i])return;const a=n[i],o=this.getMainFwdBufferInfo();if(null===o)return;const l=this.getLevelDetails();if(l&&this._streamEnded(o,l)){const e={};return this.altAudio&&(e.type="video"),this.hls.trigger(Am.BUFFER_EOS,e),void(this.state=Xb)}e.loadLevel!==i&&-1===e.manualLevel&&this.log(`Adapting to level ${i} from level ${this.level}`),this.level=e.nextLoadLevel=i;const c=a.details;if(!c||this.state===ew||c.live&&this.levelLastLoaded!==i)return this.level=i,void(this.state=ew);const d=o.len,u=this.getMaxBufferLength(a.maxBitrate);if(d>=u)return;this.backtrackFragment&&this.backtrackFragment.start>o.end&&(this.backtrackFragment=null);const h=this.backtrackFragment?this.backtrackFragment.start:o.end;let f=this.getNextFragment(h,c);if(this.couldBacktrack&&!this.fragPrevious&&f&&"initSegment"!==f.sn&&this.fragmentTracker.getState(f)!==wb){var p;const e=(null!=(p=this.backtrackFragment)?p:f).sn-c.startSN,t=c.fragments[e-1];t&&f.cc===t.cc&&(f=t,this.fragmentTracker.removeFragment(t))}else this.backtrackFragment&&o.len&&(this.backtrackFragment=null);if(f&&this.isLoopLoading(f,h)){if(!f.gap){const e=this.audioOnly&&!this.altAudio?$m:qm,t=(e===qm?this.videoBuffer:this.mediaBuffer)||this.media;t&&this.afterBufferFlushed(t,e,bv)}f=this.getNextFragmentLoopLoading(f,c,o,bv,u)}f&&(!f.initSegment||f.initSegment.data||this.bitrateTest||(f=f.initSegment),this.loadFragment(f,a,h))}loadFragment(e,t,n){const r=this.fragmentTracker.getState(e);this.fragCurrent=e,r===yb||r===bb?"initSegment"===e.sn?this._loadInitSegment(e,t):this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):(this.startFragRequested=!0,super.loadFragment(e,t,n)):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,bv)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(null!=t&&t.readyState){let n;const r=this.getAppendedFrag(t.currentTime);r&&r.start>1&&this.flushMainBuffer(0,r.start-1);const s=this.getLevelDetails();if(null!=s&&s.live){const e=this.getMainFwdBufferInfo();if(!e||e.len<2*s.targetduration)return}if(!t.paused&&e){const t=e[this.hls.nextLoadLevel],r=this.fragLastKbps;n=r&&this.fragCurrent?this.fragCurrent.duration*t.maxBitrate/(1e3*r)+1:0}else n=0;const i=this.getBufferedFrag(t.currentTime+n);if(i){const e=this.followingBufferedFrag(i);if(e){this.abortCurrentFrag();const t=e.maxStartPTS?e.maxStartPTS:e.start,n=e.duration,r=Math.max(i.end,t+Math.min(Math.max(n-this.config.maxFragLookUpTolerance,.5*n),.75*n));this.flushMainBuffer(r,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case Hb:case Vb:case zb:case Yb:case Qb:this.state=Gb}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const n=t.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),n.addEventListener("playing",this.onvplaying),n.addEventListener("seeked",this.onvseeked),this.gapController=new aS(this.config,n,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:e}=this;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const e=this.media,t=e?e.currentTime:null;km(t)&&this.log(`Media seeked to ${t.toFixed(3)}`);const n=this.getMainFwdBufferInfo();null!==n&&0!==n.len?this.tick():this.warn(`Main forward buffer length on "seeked" event ${n?n.len:"empty"})`)}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(Am.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=0,this.levels=this.fragPlaying=this.backtrackFragment=null,this.altAudio=this.audioOnly=!1}onManifestParsed(e,t){let n,r=!1,s=!1;t.levels.forEach((e=>{n=e.audioCodec,n&&(-1!==n.indexOf("mp4a.40.2")&&(r=!0),-1!==n.indexOf("mp4a.40.5")&&(s=!0))})),this.audioCodecSwitch=r&&s&&!function(){var e;const t=nw();return"function"==typeof(null==t||null==(e=t.prototype)?void 0:e.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:n}=this;if(!n||this.state!==Gb)return;const r=n[t.level];(!r.details||r.details.live&&this.levelLastLoaded!==t.level||this.waitForCdnTuneIn(r.details))&&(this.state=ew)}onLevelLoaded(e,t){var n;const{levels:r}=this,s=t.level,i=t.details,a=i.totalduration;if(!r)return void this.warn(`Levels were reset while loading level ${s}`);this.log(`Level ${s} loaded [${i.startSN},${i.endSN}]${i.lastPartSn?`[part-${i.lastPartSn}-${i.lastPartIndex}]`:""}, cc [${i.startCC}, ${i.endCC}] duration:${a}`);const o=r[s],l=this.fragCurrent;!l||this.state!==Vb&&this.state!==zb||l.level===t.level&&l.urlId===o.urlId||!l.loader||this.abortCurrentFrag();let c=0;if(i.live||null!=(n=o.details)&&n.live){if(i.fragments[0]||(i.deltaUpdateFailed=!0),i.deltaUpdateFailed)return;c=this.alignPlaylists(i,o.details)}if(o.details=i,this.levelLastLoaded=s,this.hls.trigger(Am.LEVEL_UPDATED,{details:i,level:s}),this.state===ew){if(this.waitForCdnTuneIn(i))return;this.state=Gb}this.startFragRequested?i.live&&this.synchronizeToLiveEdge(i):this.setStartPosition(i,c),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:n,part:r,payload:s}=e,{levels:i}=this;if(!i)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${n.sn} of level ${n.level} will not be buffered`);const a=i[n.level],o=a.details;if(!o)return this.warn(`Dropping fragment ${n.sn} of level ${n.level} after level details were reset`),void this.fragmentTracker.removeFragment(n);const l=a.videoCodec,c=o.PTSKnown||!o.live,d=null==(t=n.initSegment)?void 0:t.data,u=this._getAudioCodec(a),h=this.transmuxer=this.transmuxer||new iS(this.hls,bv,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=r?r.index:-1,p=-1!==f,g=new Db(n.level,n.sn,n.stats.chunkCount,s.byteLength,f,p),m=this.initPTS[n.cc];h.push(s,d,u,l,n,r,o.totalduration,c,g,m)}onAudioTrackSwitching(e,t){const n=this.altAudio;if(!!!t.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const e=this.fragCurrent;e&&(this.log("Switching to main audio track, cancel main fragment load"),e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const e=this.hls;n&&(e.trigger(Am.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),e.trigger(Am.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const n=t.id,r=!!this.hls.audioTracks[n].url;if(r){const e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=e)}this.altAudio=r,this.tick()}onBufferCreated(e,t){const n=t.tracks;let r,s,i=!1;for(const e in n){const t=n[e];if("main"===t.id){if(s=e,r=t,"video"===e){const t=n[e];t&&(this.videoBuffer=t.buffer)}}else i=!0}i&&r?(this.log(`Alternate track found, use ${s}.buffered to schedule main fragment loading`),this.mediaBuffer=r.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:n,part:r}=t;if(n&&n.type!==bv)return;if(this.fragContextChanged(n))return this.warn(`Fragment ${n.sn}${r?" p: "+r.index:""} of level ${n.level} finished buffering, but was aborted. state: ${this.state}`),void(this.state===Qb&&(this.state=Gb));const s=r?r.stats:n.stats;this.fragLastKbps=Math.round(8*s.total/(s.buffering.end-s.loading.first)),"initSegment"!==n.sn&&(this.fragPrevious=n),this.fragBufferedComplete(n,r)}onError(e,t){var n;if(t.fatal)this.state=Jb;else switch(t.details){case Rm.FRAG_GAP:case Rm.FRAG_PARSING_ERROR:case Rm.FRAG_DECRYPT_ERROR:case Rm.FRAG_LOAD_ERROR:case Rm.FRAG_LOAD_TIMEOUT:case Rm.KEY_LOAD_ERROR:case Rm.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(bv,t);break;case Rm.LEVEL_LOAD_ERROR:case Rm.LEVEL_LOAD_TIMEOUT:case Rm.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==ew||(null==(n=t.context)?void 0:n.type)!==mv||(this.state=Gb);break;case Rm.BUFFER_FULL_ERROR:if(!t.parent||"main"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case Rm.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}checkBuffer(){const{media:e,gapController:t}=this;if(e&&t&&e.readyState){if(this.loadedmetadata||!Lb.getBuffered(e).length){const e=this.state!==Gb?this.fragCurrent:null;t.poll(this.lastCurrentTime,e)}this.lastCurrentTime=e.currentTime}}onFragLoadEmergencyAborted(){this.state=Gb,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==$m||this.audioOnly&&!this.altAudio){const e=(t===qm?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(e,t,bv)}}onLevelsUpdated(e,t){this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let n=this.startPosition;if(n>=0&&t<n){if(e.seeking)return void this.log(`could not seek to ${n}, already seeking at ${t}`);const r=Lb.getBuffered(e),s=(r.length?r.start(0):0)-n;s>0&&(s<this.config.maxBufferHole||s<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${s} to match buffer start`),n+=s,this.startPosition=n),this.log(`seek to target start position ${n} from current time ${t}`),e.currentTime=n}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then((n=>{const{hls:r}=this;if(!n||this.fragContextChanged(e))return;t.fragmentError=0,this.state=Gb,this.startFragRequested=!1,this.bitrateTest=!1;const s=e.stats;s.parsing.start=s.parsing.end=s.buffering.start=s.buffering.end=self.performance.now(),r.trigger(Am.FRAG_LOADED,n),e.bitrateTest=!1}))}_handleTransmuxComplete(e){var t;const n="main",{hls:r}=this,{remuxResult:s,chunkMeta:i}=e,a=this.getCurrentContext(i);if(!a)return void this.resetWhenMissingContext(i);const{frag:o,part:l,level:c}=a,{video:d,text:u,id3:h,initSegment:f}=s,{details:p}=c,g=this.altAudio?void 0:s.audio;if(this.fragContextChanged(o))this.fragmentTracker.removeFragment(o);else{if(this.state=Yb,f){if(null!=f&&f.tracks){const e=o.initSegment||o;this._bufferInitSegment(c,f.tracks,e,i),r.trigger(Am.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:n,tracks:f.tracks})}const e=f.initPTS,t=f.timescale;km(e)&&(this.initPTS[o.cc]={baseTime:e,timescale:t},r.trigger(Am.INIT_PTS_FOUND,{frag:o,id:n,initPTS:e,timescale:t}))}if(d&&p&&"initSegment"!==o.sn){const e=p.fragments[o.sn-1-p.startSN],t=o.sn===p.startSN,n=!e||o.cc>e.cc;if(!1!==s.independent){const{startPTS:e,endPTS:r,startDTS:s,endDTS:a}=d;if(l)l.elementaryStreams[d.type]={startPTS:e,endPTS:r,startDTS:s,endDTS:a};else if(d.firstKeyFrame&&d.independent&&1===i.id&&!n&&(this.couldBacktrack=!0),d.dropped&&d.independent){const s=this.getMainFwdBufferInfo(),i=(s?s.end:this.getLoadPosition())+this.config.maxBufferHole,l=d.firstKeyFramePTS?d.firstKeyFramePTS:e;if(!t&&i<l-this.config.maxBufferHole&&!n)return void this.backtrack(o);n&&(o.gap=!0),o.setElementaryStreamInfo(d.type,o.start,r,o.start,a,!0)}o.setElementaryStreamInfo(d.type,e,r,s,a),this.backtrackFragment&&(this.backtrackFragment=o),this.bufferFragmentData(d,o,l,i,t||n)}else{if(!t&&!n)return void this.backtrack(o);o.gap=!0}}if(g){const{startPTS:e,endPTS:t,startDTS:n,endDTS:r}=g;l&&(l.elementaryStreams[$m]={startPTS:e,endPTS:t,startDTS:n,endDTS:r}),o.setElementaryStreamInfo($m,e,t,n,r),this.bufferFragmentData(g,o,l,i)}if(p&&null!=h&&null!=(t=h.samples)&&t.length){const e={id:n,frag:o,details:p,samples:h.samples};r.trigger(Am.FRAG_PARSING_METADATA,e)}if(p&&u){const e={id:n,frag:o,details:p,samples:u.samples};r.trigger(Am.FRAG_PARSING_USERDATA,e)}}}_bufferInitSegment(e,t,n,r){if(this.state!==Yb)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;const{audio:s,video:i,audiovideo:a}=t;if(s){let t=e.audioCodec;const n=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(t&&(t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),1!==s.metadata.channelCount&&-1===n.indexOf("firefox")&&(t="mp4a.40.5")),-1!==n.indexOf("android")&&"audio/mpeg"!==s.container&&(t="mp4a.40.2",this.log(`Android: force audio codec to ${t}`)),e.audioCodec&&e.audioCodec!==t&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${t}"`),s.levelCodec=t,s.id="main",this.log(`Init audio buffer, container:${s.container}, codecs[selected/level/parsed]=[${t||""}/${e.audioCodec||""}/${s.codec}]`)}i&&(i.levelCodec=e.videoCodec,i.id="main",this.log(`Init video buffer, container:${i.container}, codecs[level/parsed]=[${e.videoCodec||""}/${i.codec}]`)),a&&this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.attrs.CODECS||""}/${a.codec}]`),this.hls.trigger(Am.BUFFER_CODECS,t),Object.keys(t).forEach((e=>{const s=t[e].initSegment;null!=s&&s.byteLength&&this.hls.trigger(Am.BUFFER_APPENDING,{type:e,data:s,frag:n,part:null,chunkMeta:r,parent:n.type})})),this.tick()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,bv)}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=Gb}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&!1===e.seeking){const n=e.currentTime;if(Lb.isBuffered(e,n)?t=this.getAppendedFrag(n):Lb.isBuffered(e,n+.1)&&(t=this.getAppendedFrag(n+.1)),t){this.backtrackFragment=null;const e=this.fragPlaying,n=t.level;e&&t.sn===e.sn&&e.level===n&&t.urlId===e.urlId||(this.fragPlaying=t,this.hls.trigger(Am.FRAG_CHANGED,{frag:t}),e&&e.level===n||this.hls.trigger(Am.LEVEL_SWITCHED,{level:n}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){const e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}get currentProgramDateTime(){const e=this.media;if(e){const t=e.currentTime,n=this.currentFrag;if(n&&km(t)&&km(n.programDateTime)){const e=n.programDateTime+1e3*(t-n.start);return new Date(e)}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class lS{constructor(e,t=0,n=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=n}sample(e,t){const n=Math.pow(this.alpha_,e);this.estimate_=t*(1-n)+n*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class cS{constructor(e,t,n,r=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=n,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new lS(e),this.fast_=new lS(t),this.defaultTTFB_=r,this.ttfb_=new lS(e)}update(e,t){const{slow_:n,fast_:r,ttfb_:s}=this;n.halfLife!==e&&(this.slow_=new lS(e,n.getEstimate(),n.getTotalWeight())),r.halfLife!==t&&(this.fast_=new lS(t,r.getEstimate(),r.getTotalWeight())),s.halfLife!==e&&(this.ttfb_=new lS(e,s.getEstimate(),s.getTotalWeight()))}sample(e,t){const n=(e=Math.max(e,this.minDelayMs_))/1e3,r=8*t/n;this.fast_.sample(n,r),this.slow_.sample(n,r)}sampleTTFB(e){const t=e/1e3,n=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(n,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}class dS{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let n;return e.length?(n=1===e.length?e[0]:function(e,t){const n=new Uint8Array(t);let r=0;for(let t=0;t<e.length;t++){const s=e[t];n.set(s,r),r+=s.length}return n}(e,t),this.reset(),n):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}function uS(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!hS(e[n].attrs,t[n].attrs))return!1;return!0}function hS(e,t){const n=e["STABLE-RENDITION-ID"];return n?n===t["STABLE-RENDITION-ID"]:!["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED"].some((n=>e[n]!==t[n]))}class fS{constructor(e){this.buffered=void 0;const t=(t,n,r)=>{if((n>>>=0)>r-1)throw new DOMException(`Failed to execute '${t}' on 'TimeRanges': The index provided (${n}) is greater than the maximum bound (${r})`);return e[n][t]};this.buffered={get length(){return e.length},end:n=>t("end",n,e.length),start:n=>t("start",n,e.length)}}}function pS(e){const t=[];for(let n=0;n<e.length;n++){const r=e[n];"subtitles"!==r.kind&&"captions"!==r.kind||!r.label||t.push(e[n])}return t}class gS{constructor(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}append(e,t){const n=this.queues[t];n.push(e),1===n.length&&this.buffers[t]&&this.executeNext(t)}insertAbort(e,t){this.queues[t].unshift(e),this.executeNext(t)}appendBlocker(e){let t;const n=new Promise((e=>{t=e})),r={execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(r,e),n}executeNext(e){const{buffers:t,queues:n}=this,r=t[e],s=n[e];if(s.length){const t=s[0];try{t.execute()}catch(n){Pm.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),t.onError(n),null!=r&&r.updating||(s.shift(),this.executeNext(e))}}}shiftAndExecuteNext(e){this.queues[e].shift(),this.executeNext(e)}current(e){return this.queues[e][0]}}const mS=Jy(),yS=/([ha]vc.)(?:\.[^.,]+)+/;const vS={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},bS=function(e){let t=e;return vS.hasOwnProperty(e)&&(t=vS[e]),String.fromCharCode(t)},wS=15,SS=100,CS={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},TS={17:2,18:4,21:6,22:8,23:10,19:13,20:15},ES={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},IS={25:2,26:4,29:6,30:8,31:10,27:13,28:15},kS=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class AS{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const n="function"==typeof t?t():t;Pm.log(`${this.time} [${e}] ${n}`)}}}const _S=function(e){const t=[];for(let n=0;n<e.length;n++)t.push(e[n].toString(16));return t};class RS{constructor(e,t,n,r,s){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=e||"white",this.underline=t||!1,this.italics=n||!1,this.background=r||"black",this.flash=s||!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let n=0;n<t.length;n++){const r=t[n];e.hasOwnProperty(r)&&(this[r]=e[r])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class OS{constructor(e,t,n,r,s,i){this.uchar=void 0,this.penState=void 0,this.uchar=e||" ",this.penState=new RS(t,n,r,s,i)}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class LS{constructor(e){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(let e=0;e<SS;e++)this.chars.push(new OS);this.logger=e,this.pos=0,this.currPenState=new RS}equals(e){let t=!0;for(let n=0;n<SS;n++)if(!this.chars[n].equals(e.chars[n])){t=!1;break}return t}copy(e){for(let t=0;t<SS;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<SS;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>SS&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=SS)}moveCursor(e){const t=this.pos+e;if(e>1)for(let e=this.pos+1;e<t+1;e++)this.chars[e].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=bS(e);this.pos>=SS?this.logger.log(0,(()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!")):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){let t;for(t=e;t<SS;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let n=0;n<SS;n++){const r=this.chars[n].uchar;" "!==r&&(t=!1),e.push(r)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e);this.chars[this.pos].setPenState(this.currPenState)}}class DS{constructor(e){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(let t=0;t<wS;t++)this.rows.push(new LS(e));this.logger=e,this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}reset(){for(let e=0;e<wS;e++)this.rows[e].clear();this.currRow=14}equals(e){let t=!0;for(let n=0;n<wS;n++)if(!this.rows[n].equals(e.rows[n])){t=!1;break}return t}copy(e){for(let t=0;t<wS;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<wS;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e);this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,(()=>"pacData = "+JSON.stringify(e)));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let e=0;e<wS;e++)this.rows[e].clear();const e=this.currRow+1-this.nrRollUpRows,n=this.lastOutputScreen;if(n){const r=n.rows[e].cueStartTime,s=this.logger.time;if(r&&null!==s&&r<s)for(let r=0;r<this.nrRollUpRows;r++)this.rows[t-this.nrRollUpRows+r+1].copy(n.rows[e+r])}}this.currRow=t;const n=this.rows[this.currRow];if(null!==e.indent){const t=e.indent,r=Math.max(t-1,0);n.setCursor(e.indent),e.color=n.chars[r].penState.foreground}const r={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(r)}setBkgData(e){this.logger.log(2,(()=>"bkgData = "+JSON.stringify(e))),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,(()=>this.getDisplayText()));const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let n="",r=-1;for(let n=0;n<wS;n++){const s=this.rows[n].getTextString();s&&(r=n+1,e?t.push("Row "+r+": '"+s+"'"):t.push(s.trim()))}return t.length>0&&(n=e?"["+t.join(" | ")+"]":t.join("\n")),n}getTextAndFormat(){return this.rows}}class xS{constructor(e,t,n){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new DS(n),this.nonDisplayedMemory=new DS(n),this.lastOutputScreen=new DS(n),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=n}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,(()=>"MODE="+e)),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,(()=>t+": "+this.writeScreen.getDisplayText(!0))),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,(()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0))),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,(()=>"DISP: "+this.displayedMemory.getDisplayText()))}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{const n=Math.floor(e/2)-16,r=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=r[n]}this.logger.log(2,"MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;null!==t&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class PS{constructor(e,t,n){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;const r=new AS;this.channels=[null,new xS(e,t,r),new xS(e+1,n,r)],this.cmdHistory={a:null,b:null},this.logger=r}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){let n,r,s,i=!1;this.logger.time=e;for(let e=0;e<t.length;e+=2)if(r=127&t[e],s=127&t[e+1],0!==r||0!==s){if(this.logger.log(3,"["+_S([t[e],t[e+1]])+"] -> ("+_S([r,s])+")"),n=this.parseCmd(r,s),n||(n=this.parseMidrow(r,s)),n||(n=this.parsePAC(r,s)),n||(n=this.parseBackgroundAttributes(r,s)),!n&&(i=this.parseChars(r,s),i)){const e=this.currentChannel;if(e&&e>0){this.channels[e].insertChars(i)}else this.logger.log(2,"No channel found yet. TEXT-MODE?")}n||i||this.logger.log(2,"Couldn't parse cleaned data "+_S([r,s])+" orig: "+_S([t[e],t[e+1]]))}}parseCmd(e,t){const{cmdHistory:n}=this;if(!((20===e||28===e||21===e||29===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=33&&t<=35))return!1;if(FS(e,t,n))return MS(null,null,n),this.logger.log(3,"Repeated command ("+_S([e,t])+") is dropped"),!0;const r=20===e||21===e||23===e?1:2,s=this.channels[r];return 20===e||21===e||28===e||29===e?32===t?s.ccRCL():33===t?s.ccBS():34===t?s.ccAOF():35===t?s.ccAON():36===t?s.ccDER():37===t?s.ccRU(2):38===t?s.ccRU(3):39===t?s.ccRU(4):40===t?s.ccFON():41===t?s.ccRDC():42===t?s.ccTR():43===t?s.ccRTD():44===t?s.ccEDM():45===t?s.ccCR():46===t?s.ccENM():47===t&&s.ccEOC():s.ccTO(t-32),MS(e,t,n),this.currentChannel=r,!0}parseMidrow(e,t){let n=0;if((17===e||25===e)&&t>=32&&t<=47){if(n=17===e?1:2,n!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const r=this.channels[n];return!!r&&(r.ccMIDROW(t),this.logger.log(3,"MIDROW ("+_S([e,t])+")"),!0)}return!1}parsePAC(e,t){let n;const r=this.cmdHistory;if(!((e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127)&&!((16===e||24===e)&&t>=64&&t<=95))return!1;if(FS(e,t,r))return MS(null,null,r),!0;const s=e<=23?1:2;n=t>=64&&t<=95?1===s?CS[e]:ES[e]:1===s?TS[e]:IS[e];const i=this.channels[s];return!!i&&(i.setPAC(this.interpretPAC(n,t)),MS(e,t,r),this.currentChannel=s,!0)}interpretPAC(e,t){let n;const r={color:null,italics:!1,indent:null,underline:!1,row:e};return n=t>95?t-96:t-64,r.underline=1==(1&n),n<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(n/2)]:n<=15?(r.italics=!0,r.color="white"):r.indent=4*Math.floor((n-16)/2),r}parseChars(e,t){let n,r=null,s=null;if(e>=25?(n=2,s=e-8):(n=1,s=e),s>=17&&s<=19){let e;e=17===s?t+80:18===s?t+112:t+144,this.logger.log(2,"Special char '"+bS(e)+"' in channel "+n),r=[e]}else e>=32&&e<=127&&(r=0===t?[e]:[e,t]);if(r){const n=_S(r);this.logger.log(3,"Char codes =  "+n.join(",")),MS(e,t,this.cmdHistory)}return r}parseBackgroundAttributes(e,t){if(!((16===e||24===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=45&&t<=47))return!1;let n;const r={};16===e||24===e?(n=Math.floor((t-32)/2),r.background=kS[n],t%2==1&&(r.background=r.background+"_semi")):45===t?r.background="transparent":(r.foreground="black",47===t&&(r.underline=!0));const s=e<=23?1:2;return this.channels[s].setBkgData(r),MS(e,t,this.cmdHistory),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}this.cmdHistory={a:null,b:null}}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const n=this.channels[t];n&&n.cueSplitAtTime(e)}}}function MS(e,t,n){n.a=e,n.b=t}function FS(e,t,n){return n.a===e&&n.b===t}class US{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,n){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=n,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var NS=function(){if("undefined"!=typeof self&&self.VTTCue)return self.VTTCue;const e=["","lr","rl"],t=["start","middle","end","left","right"];function n(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;const n=t.toLowerCase();return!!~e.indexOf(n)&&n}function r(e){return n(t,e)}function s(e,...t){let n=1;for(;n<arguments.length;n++){const t=arguments[n];for(const n in t)e[n]=t[n]}return e}function i(t,i,a){const o=this,l={enumerable:!0};o.hasBeenReset=!1;let c="",d=!1,u=t,h=i,f=a,p=null,g="",m=!0,y="auto",v="start",b=50,w="middle",S=50,C="middle";Object.defineProperty(o,"id",s({},l,{get:function(){return c},set:function(e){c=""+e}})),Object.defineProperty(o,"pauseOnExit",s({},l,{get:function(){return d},set:function(e){d=!!e}})),Object.defineProperty(o,"startTime",s({},l,{get:function(){return u},set:function(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");u=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",s({},l,{get:function(){return h},set:function(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");h=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",s({},l,{get:function(){return f},set:function(e){f=""+e,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",s({},l,{get:function(){return p},set:function(e){p=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",s({},l,{get:function(){return g},set:function(t){const r=function(t){return n(e,t)}(t);if(!1===r)throw new SyntaxError("An invalid or illegal string was specified.");g=r,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",s({},l,{get:function(){return m},set:function(e){m=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",s({},l,{get:function(){return y},set:function(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");y=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",s({},l,{get:function(){return v},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");v=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",s({},l,{get:function(){return b},set:function(e){if(e<0||e>100)throw new Error("Position must be between 0 and 100.");b=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",s({},l,{get:function(){return w},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");w=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",s({},l,{get:function(){return S},set:function(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100.");S=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",s({},l,{get:function(){return C},set:function(e){const t=r(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");C=t,this.hasBeenReset=!0}})),o.displayState=void 0}return i.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},i}();class BS{decode(e,t){if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function jS(e){function t(e,t,n,r){return 3600*(0|e)+60*(0|t)+(0|n)+parseFloat(r||0)}const n=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return n?parseFloat(n[2])>59?t(n[2],n[3],0,n[4]):t(n[1],n[2],n[3],n[4]):null}class $S{constructor(){this.values=Object.create(null)}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,n){return n?this.has(e)?this.values[e]:t[n]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,n){for(let r=0;r<n.length;++r)if(t===n[r]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const n=parseFloat(t);if(n>=0&&n<=100)return this.set(e,n),!0}return!1}}function qS(e,t,n,r){const s=r?e.split(r):[e];for(const e in s){if("string"!=typeof s[e])continue;const r=s[e].split(n);if(2!==r.length)continue;t(r[0],r[1])}}const KS=new NS(0,0,""),GS="middle"===KS.align?"middle":"center";function HS(e,t,n){const r=e;function s(){const t=jS(e);if(null===t)throw new Error("Malformed timestamp: "+r);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t}function i(){e=e.replace(/^\s+/,"")}if(i(),t.startTime=s(),i(),"--\x3e"!==e.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+r);e=e.slice(3),i(),t.endTime=s(),i(),function(e,t){const r=new $S;qS(e,(function(e,t){let s;switch(e){case"region":for(let s=n.length-1;s>=0;s--)if(n[s].id===t){r.set(e,n[s].region);break}break;case"vertical":r.alt(e,t,["rl","lr"]);break;case"line":s=t.split(","),r.integer(e,s[0]),r.percent(e,s[0])&&r.set("snapToLines",!1),r.alt(e,s[0],["auto"]),2===s.length&&r.alt("lineAlign",s[1],["start",GS,"end"]);break;case"position":s=t.split(","),r.percent(e,s[0]),2===s.length&&r.alt("positionAlign",s[1],["start",GS,"end","line-left","line-right","auto"]);break;case"size":r.percent(e,t);break;case"align":r.alt(e,t,["start",GS,"end","left","right"])}}),/:/,/\s/),t.region=r.get("region",null),t.vertical=r.get("vertical","");let s=r.get("line","auto");"auto"===s&&-1===KS.line&&(s=-1),t.line=s,t.lineAlign=r.get("lineAlign","start"),t.snapToLines=r.get("snapToLines",!0),t.size=r.get("size",100),t.align=r.get("align",GS);let i=r.get("position","auto");"auto"===i&&50===KS.position&&(i="start"===t.align||"left"===t.align?0:"end"===t.align||"right"===t.align?100:50),t.position=i}(e,t)}function VS(e){return e.replace(/<br(?: \/)?>/gi,"\n")}class zS{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new BS,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;function n(){let e=t.buffer,n=0;for(e=VS(e);n<e.length&&"\r"!==e[n]&&"\n"!==e[n];)++n;const r=e.slice(0,n);return"\r"===e[n]&&++n,"\n"===e[n]&&++n,t.buffer=e.slice(n),r}e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));try{let e="";if("INITIAL"===t.state){if(!/\r\n|\n/.test(t.buffer))return this;e=n();const r=e.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(null==r||!r[0])throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let r=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(r?r=!1:e=n(),t.state){case"HEADER":/:/.test(e)?qS(e,(function(e,t){}),/:/):e||(t.state="ID");continue;case"NOTE":e||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){t.state="NOTE";break}if(!e)continue;if(t.cue=new NS(0,0,""),t.state="CUE",-1===e.indexOf("--\x3e")){t.cue.id=e;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{HS(e,t.cue,t.regionList)}catch(e){t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const n=-1!==e.indexOf("--\x3e");if(!e||n&&(r=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(null===t.cue)continue;t.cue.text&&(t.cue.text+="\n"),t.cue.text+=e}continue;case"BADCUE":e||(t.state="ID")}}}catch(e){"CUETEXT"===t.state&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state="INITIAL"===t.state?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||"HEADER"===e.state)&&(e.buffer+="\n\n",e.parse()),"INITIAL"===e.state||"BADWEBVTT"===e.state)throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const WS=/\r\n|\n\r|\n|\r/g,YS=function(e,t,n=0){return e.slice(n,n+t.length)===t},QS=function(e){let t=5381,n=e.length;for(;n;)t=33*t^e.charCodeAt(--n);return(t>>>0).toString()};function XS(e,t,n){return QS(e.toString())+QS(t.toString())+QS(n)}function JS(e,t,n,r,s,i,a){const o=new zS,l=Sy(new Uint8Array(e)).trim().replace(WS,"\n").split("\n"),c=[],d=t?function(e,t=1){return Nw(e,9e4,1/t)}(t.baseTime,t.timescale):0;let u,h="00:00.000",f=0,p=0,g=!0;o.oncue=function(e){const i=n[r];let a=n.ccOffset;const o=(f-d)/9e4;if(null!=i&&i.new&&(void 0!==p?a=n.ccOffset=i.start:function(e,t,n){let r=e[t],s=e[r.prevCC];if(!s||!s.new&&r.new)return e.ccOffset=e.presentationOffset=r.start,void(r.new=!1);for(;null!=(i=s)&&i.new;){var i;e.ccOffset+=r.start-s.start,r.new=!1,r=s,s=e[r.prevCC]}e.presentationOffset=n}(n,r,o)),o){if(!t)return void(u=new Error("Missing initPTS for VTT MPEGTS"));a=o-n.presentationOffset}const l=e.endTime-e.startTime,h=Gw(9e4*(e.startTime+a-p),9e4*s)/9e4;e.startTime=Math.max(h,0),e.endTime=Math.max(h+l,0);const g=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(g)),e.id||(e.id=XS(e.startTime,e.endTime,g)),e.endTime>0&&c.push(e)},o.onparsingerror=function(e){u=e},o.onflush=function(){u?a(u):i(c)},l.forEach((e=>{if(g){if(YS(e,"X-TIMESTAMP-MAP=")){g=!1,e.slice(16).split(",").forEach((e=>{YS(e,"LOCAL:")?h=e.slice(6):YS(e,"MPEGTS:")&&(f=parseInt(e.slice(7)))}));try{p=function(e){let t=parseInt(e.slice(-3));const n=parseInt(e.slice(-6,-4)),r=parseInt(e.slice(-9,-7)),s=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!(km(t)&&km(n)&&km(r)&&km(s)))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*n,t+=6e4*r,t+=36e5*s,t}(h)/1e3}catch(e){u=e}return}""===e&&(g=!1)}o.parse(e+"\n")})),o.flush()}const ZS="stpp.ttml.im1t",eC=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,tC=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,nC={left:"start",center:"center",right:"end",start:"start",end:"end"};function rC(e,t,n,r){const s=xy(new Uint8Array(e),["mdat"]);if(0===s.length)return void r(new Error("Could not parse IMSC1 mdat"));const i=s.map((e=>Sy(e))),a=function(e,t,n=1,r=!1){return Nw(e,t,1/n,r)}(t.baseTime,1,t.timescale);try{i.forEach((e=>n(function(e,t){const n=new DOMParser,r=n.parseFromString(e,"text/xml").getElementsByTagName("tt")[0];if(!r)throw new Error("Invalid ttml");const s={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},i=Object.keys(s).reduce(((e,t)=>(e[t]=r.getAttribute(`ttp:${t}`)||s[t],e)),{}),a="preserve"!==r.getAttribute("xml:space"),o=iC(sC(r,"styling","style")),l=iC(sC(r,"layout","region")),c=sC(r,"body","[begin]");return[].map.call(c,(e=>{const n=aC(e,a);if(!n||!e.hasAttribute("begin"))return null;const r=cC(e.getAttribute("begin"),i),s=cC(e.getAttribute("dur"),i);let c=cC(e.getAttribute("end"),i);if(null===r)throw lC(e);if(null===c){if(null===s)throw lC(e);c=r+s}const d=new NS(r-t,c-t,n);d.id=XS(d.startTime,d.endTime,d.text);const u=function(e,t,n){const r="http://www.w3.org/ns/ttml#styling";let s=null;const i=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=null!=e&&e.hasAttribute("style")?e.getAttribute("style"):null;a&&n.hasOwnProperty(a)&&(s=n[a]);return i.reduce(((n,i)=>{const a=oC(t,r,i)||oC(e,r,i)||oC(s,r,i);return a&&(n[i]=a),n}),{})}(l[e.getAttribute("region")],o[e.getAttribute("style")],o),{textAlign:h}=u;if(h){const e=nC[h];e&&(d.lineAlign=e),d.align=h}return Im(d,u),d})).filter((e=>null!==e))}(e,a))))}catch(e){r(e)}}function sC(e,t,n){const r=e.getElementsByTagName(t)[0];return r?[].slice.call(r.querySelectorAll(n)):[]}function iC(e){return e.reduce(((e,t)=>{const n=t.getAttribute("xml:id");return n&&(e[n]=t),e}),{})}function aC(e,t){return[].slice.call(e.childNodes).reduce(((e,n,r)=>{var s;return"br"===n.nodeName&&r?e+"\n":null!=(s=n.childNodes)&&s.length?aC(n,t):t?e+n.textContent.trim().replace(/\s+/g," "):e+n.textContent}),"")}function oC(e,t,n){return e&&e.hasAttributeNS(t,n)?e.getAttributeNS(t,n):null}function lC(e){return new Error(`Could not parse ttml timestamp ${e}`)}function cC(e,t){if(!e)return null;let n=jS(e);return null===n&&(eC.test(e)?n=function(e,t){const n=eC.exec(e),r=(0|n[4])+(0|n[5])/t.subFrameRate;return 3600*(0|n[1])+60*(0|n[2])+(0|n[3])+r/t.frameRate}(e,t):tC.test(e)&&(n=function(e,t){const n=tC.exec(e),r=Number(n[1]);switch(n[2]){case"h":return 3600*r;case"m":return 60*r;case"ms":return 1e3*r;case"f":return r/t.frameRate;case"t":return r/t.tickRate}return r}(e,t))),n}function dC(e,t){return!!e&&e.label===t.name&&!(e.textTrack1||e.textTrack2)}class uC{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(Am.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(Am.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Am.BUFFER_CODECS,this.onBufferCodecs,this),e.on(Am.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(Am.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(Am.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Am.BUFFER_CODECS,this.onBufferCodecs,this),e.off(Am.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const n=this.hls.levels[t.droppedLevel];this.isLevelAllowed(n)&&this.restrictedLevels.push({bitrate:n.bitrate,height:n.height,width:n.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null}onManifestParsed(e,t){const n=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,n.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){const e=this.hls.levels;if(e.length){const t=this.hls;t.autoLevelCapping=this.getMaxLevel(e.length-1),t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const n=t.filter(((t,n)=>this.isLevelAllowed(t)&&n<=e));return this.clientRect=null,uC.getMaxLevelByMediaSize(n,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const n=e.getBoundingClientRect();t.width=n.width,t.height=n.height,t.width||t.height||(t.width=n.right-n.left||e.width||0,t.height=n.bottom-n.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch(e){}return e}isLevelAllowed(e){return!this.restrictedLevels.some((t=>e.bitrate===t.bitrate&&e.width===t.width&&e.height===t.height))}static getMaxLevelByMediaSize(e,t,n){if(null==e||!e.length)return-1;let r=e.length-1;for(let a=0;a<e.length;a+=1){const o=e[a];if((o.width>=t||o.height>=n)&&(s=o,!(i=e[a+1])||s.width!==i.width||s.height!==i.height)){r=a;break}}var s,i;return r}}const hC="[eme]";class fC{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=fC.CDMCleanupPromise?[fC.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=Pm.debug.bind(Pm,hC),this.log=Pm.log.bind(Pm,hC),this.warn=Pm.warn.bind(Pm,hC),this.error=Pm.error.bind(Pm,hC),this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(Am.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(Am.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(Am.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(Am.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(Am.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(Am.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:n}=this.config,r=t[e];if(r)return r.licenseUrl;if(e===Xm.WIDEVINE&&n)return n;throw new Error(`no license server URL configured for key-system "${e}"`)}getServerCertificateUrl(e){const{drmSystems:t}=this.config,n=t[e];if(n)return n.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,n=(e,t,n)=>!!e&&n.indexOf(e)===t,r=t.map((e=>e.audioCodec)).filter(n),s=t.map((e=>e.videoCodec)).filter(n);return r.length+s.length===0&&s.push("avc1.42e01e"),new Promise(((t,n)=>{const i=e=>{const a=e.shift();this.getMediaKeysPromise(a,r,s).then((e=>t({keySystem:a,mediaKeys:e}))).catch((t=>{e.length?i(e):n(t instanceof pC?t:new pC({type:_m.KEY_SYSTEM_ERROR,details:Rm.KEY_SYSTEM_NO_ACCESS,error:t,fatal:!0},t.message))}))};i(e)}))}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:n}=this.config;if("function"!=typeof n){let e=`Configured requestMediaKeySystemAccess is not a function ${n}`;return null===ay&&"http:"===self.location.protocol&&(e=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(e))}return n(e,t)}getMediaKeysPromise(e,t,n){const r=function(e,t,n,r){let s;switch(e){case Xm.FAIRPLAY:s=["cenc","sinf"];break;case Xm.WIDEVINE:case Xm.PLAYREADY:s=["cenc"];break;case Xm.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${e}`)}return function(e,t,n,r){return[{initDataTypes:e,persistentState:r.persistentState||"not-allowed",distinctiveIdentifier:r.distinctiveIdentifier||"not-allowed",sessionTypes:r.sessionTypes||[r.sessionType||"temporary"],audioCapabilities:t.map((e=>({contentType:`audio/mp4; codecs="${e}"`,robustness:r.audioRobustness||"",encryptionScheme:r.audioEncryptionScheme||null}))),videoCapabilities:n.map((e=>({contentType:`video/mp4; codecs="${e}"`,robustness:r.videoRobustness||"",encryptionScheme:r.videoEncryptionScheme||null})))}]}(s,t,n,r)}(e,t,n,this.config.drmSystemOptions),s=this.keySystemAccessPromises[e];let i=null==s?void 0:s.keySystemAccess;if(!i){this.log(`Requesting encrypted media "${e}" key-system access with config: ${JSON.stringify(r)}`),i=this.requestMediaKeySystemAccess(e,r);const t=this.keySystemAccessPromises[e]={keySystemAccess:i};return i.catch((t=>{this.log(`Failed to obtain access to key-system "${e}": ${t}`)})),i.then((n=>{this.log(`Access for key-system "${n.keySystem}" obtained`);const r=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),t.mediaKeys=n.createMediaKeys().then((t=>(this.log(`Media-keys created for "${e}"`),r.then((n=>n?this.setMediaKeysServerCertificate(t,e,n):t))))),t.mediaKeys.catch((t=>{this.error(`Failed to create media-keys for "${e}"}: ${t}`)})),t.mediaKeys}))}return i.then((()=>s.mediaKeys))}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:n}){this.log(`Creating key-system session "${t}" keyId: ${Ey(e.keyId||[])}`);const r=n.createSession(),s={decryptdata:e,keySystem:t,mediaKeys:n,mediaKeysSession:r,keyStatus:"status-pending"};return this.mediaKeySessions.push(s),s}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const n=this.createMediaKeySessionContext(e),r=this.getKeyIdString(t),s="cenc";this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(n,s,t.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(null===e.keyId)throw new Error("keyId is null");return Ey(e.keyId)}updateKeySession(e,t){var n;const r=e.mediaKeysSession;return this.log(`Updating key-session "${r.sessionId}" for keyID ${Ey((null==(n=e.decryptdata)?void 0:n.keyId)||[])}\n      } (data length: ${t?t.byteLength:t})`),r.update(t)}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise(((t,n)=>{const r=iy(this.config),s=e.map(ny).filter((e=>!!e&&-1!==r.indexOf(e)));return this.getKeySystemSelectionPromise(s).then((({keySystem:e})=>{const r=sy(e);r?t(r):n(new Error(`Unable to find format for key-system "${e}"`))})).catch(n)}))}loadKey(e){const t=e.keyInfo.decryptdata,n=this.getKeyIdString(t),r=`(keyId: ${n} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${r}`);let s=this.keyIdToKeySessionPromise[n];return s||(s=this.keyIdToKeySessionPromise[n]=this.getKeySystemForKeyPromise(t).then((({keySystem:n,mediaKeys:s})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${r}`),this.attemptSetMediaKeys(n,s).then((()=>{this.throwIfDestroyed();const e=this.createMediaKeySessionContext({keySystem:n,mediaKeys:s,decryptdata:t});return this.generateRequestWithPreferredKeySession(e,"cenc",t.pssh,"playlist-key")}))))),s.catch((e=>this.handleError(e)))),s}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof pC?this.hls.trigger(Am.ERROR,e.data):this.hls.trigger(Am.ERROR,{type:_m.KEY_SYSTEM_ERROR,details:Rm.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),n=this.keyIdToKeySessionPromise[t];if(!n){const t=ny(e.keyFormat),n=t?[t]:iy(this.config);return this.attemptKeySystemAccess(n)}return n}getKeySystemSelectionPromise(e){if(e.length||(e=iy(this.config)),0===e.length)throw new pC({type:_m.KEY_SYSTEM_ERROR,details:Rm.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}_onMediaEncrypted(e){const{initDataType:t,initData:n}=e;if(this.debug(`"${e.type}" event: init data type: "${t}"`),null===n)return;let r,s;if("sinf"===t&&this.config.drmSystems[Xm.FAIRPLAY]){const e=_y(new Uint8Array(n));try{const t=Wm(JSON.parse(e).sinf),n=Fy(new Uint8Array(t));if(!n)return;r=n.subarray(8,24),s=Xm.FAIRPLAY}catch(e){return void this.warn('Failed to parse sinf "encrypted" event message initData')}}else{const e=function(e){if(!(e instanceof ArrayBuffer)||e.byteLength<32)return null;const t={version:0,systemId:"",kids:null,data:null},n=new DataView(e),r=n.getUint32(0);if(e.byteLength!==r&&r>44)return null;if(1886614376!==n.getUint32(4))return null;if(t.version=n.getUint32(8)>>>24,t.version>1)return null;t.systemId=Ey(new Uint8Array(e,12,16));const s=n.getUint32(28);if(0===t.version){if(r-32<s)return null;t.data=new Uint8Array(e,32,s)}else if(1===t.version){t.kids=[];for(let n=0;n<s;n++)t.kids.push(new Uint8Array(e,32+16*n,16))}return t}(n);if(null===e)return;0===e.version&&e.systemId===ry&&e.data&&(r=e.data.subarray(8,24)),s=function(e){if(e===ry)return Xm.WIDEVINE}(e.systemId)}if(!s||!r)return;const i=Ey(r),{keyIdToKeySessionPromise:a,mediaKeySessions:o}=this;let l=a[i];for(let e=0;e<o.length;e++){const s=o[e],c=s.decryptdata;if(c.pssh||!c.keyId)continue;const d=Ey(c.keyId);if(i===d||-1!==c.uri.replace(/-/g,"").indexOf(i)){l=a[d],delete a[d],c.pssh=new Uint8Array(n),c.keyId=r,l=a[i]=l.then((()=>this.generateRequestWithPreferredKeySession(s,t,n,"encrypted-event-key-match")));break}}l||(l=a[i]=this.getKeySystemSelectionPromise([s]).then((({keySystem:e,mediaKeys:s})=>{var a;this.throwIfDestroyed();const o=new Hy("ISO-23001-7",i,null!=(a=sy(e))?a:"");return o.pssh=new Uint8Array(n),o.keyId=r,this.attemptSetMediaKeys(e,s).then((()=>{this.throwIfDestroyed();const r=this.createMediaKeySessionContext({decryptdata:o,keySystem:e,mediaKeys:s});return this.generateRequestWithPreferredKeySession(r,t,n,"encrypted-event-no-match")}))}))),l.catch((e=>this.handleError(e)))}_onWaitingForKey(e){this.log(`"${e.type}" event`)}attemptSetMediaKeys(e,t){const n=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const r=Promise.all(n).then((()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)}));return this.setMediaKeysQueue.push(r),r.then((()=>{this.log(`Media-keys set for "${e}"`),n.push(r),this.setMediaKeysQueue=this.setMediaKeysQueue.filter((e=>-1===n.indexOf(e)))}))}generateRequestWithPreferredKeySession(e,t,n,r){var s,i;const a=null==(s=this.config.drmSystems)||null==(i=s[e.keySystem])?void 0:i.generateRequest;if(a)try{const r=a.call(this.hls,t,n,e);if(!r)throw new Error("Invalid response from configured generateRequest filter");t=r.initDataType,n=e.decryptdata.pssh=r.initData?new Uint8Array(r.initData):null}catch(e){var o;if(this.warn(e.message),null!=(o=this.hls)&&o.config.debug)throw e}if(null===n)return this.log(`Skipping key-session request for "${r}" (no initData)`),Promise.resolve(e);const l=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${r}": ${l} (init data type: ${t} length: ${n?n.byteLength:null})`);const c=new rS;e.mediaKeysSession.onmessage=t=>{const n=e.mediaKeysSession;if(!n)return void c.emit("error",new Error("invalid state"));const{messageType:r,message:s}=t;this.log(`"${r}" message event for session "${n.sessionId}" message size: ${s.byteLength}`),"license-request"===r||"license-renewal"===r?this.renewLicense(e,s).catch((e=>{this.handleError(e),c.emit("error",e)})):"license-release"===r?e.keySystem===Xm.FAIRPLAY&&(this.updateKeySession(e,Qm("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${r}"`)},e.mediaKeysSession.onkeystatuseschange=t=>{if(!e.mediaKeysSession)return void c.emit("error",new Error("invalid state"));this.onKeyStatusChange(e);const n=e.keyStatus;c.emit("keyStatus",n),"expired"===n&&(this.warn(`${e.keySystem} expired for key ${l}`),this.renewKeySession(e))};const d=new Promise(((e,t)=>{c.on("error",t),c.on("keyStatus",(n=>{n.startsWith("usable")?e():"output-restricted"===n?t(new pC({type:_m.KEY_SYSTEM_ERROR,details:Rm.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===n?t(new pC({type:_m.KEY_SYSTEM_ERROR,details:Rm.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${n}"`)):"expired"===n?t(new Error("key expired while generating request")):this.warn(`unhandled key status change "${n}"`)}))}));return e.mediaKeysSession.generateRequest(t,n).then((()=>{var t;this.log(`Request generated for key-session "${null==(t=e.mediaKeysSession)?void 0:t.sessionId}" keyId: ${l}`)})).catch((e=>{throw new pC({type:_m.KEY_SYSTEM_ERROR,details:Rm.KEY_SYSTEM_NO_SESSION,error:e,fatal:!1},`Error generating key-session request: ${e}`)})).then((()=>d)).catch((t=>{throw c.removeAllListeners(),this.removeSession(e),t})).then((()=>(c.removeAllListeners(),e)))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach(((t,n)=>{this.log(`key status change "${t}" for keyStatuses keyId: ${Ey("buffer"in n?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n))} session keyId: ${Ey(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t}))}fetchServerCertificate(e){const t=this.config,n=new(0,t.loader)(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching serverCertificate for "${e}"`),new Promise(((s,i)=>{const a={responseType:"arraybuffer",url:r},o=t.certLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},c={onSuccess:(e,t,n,r)=>{s(e.data)},onError:(t,n,s,o)=>{i(new pC({type:_m.KEY_SYSTEM_ERROR,details:Rm.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:Tm({url:a.url,data:void 0},t)},`"${e}" certificate request failed (${r}). Status: ${t.code} (${t.text})`))},onTimeout:(t,n,s)=>{i(new pC({type:_m.KEY_SYSTEM_ERROR,details:Rm.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:{url:a.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(e,t,n)=>{i(new Error("aborted"))}};n.load(a,l,c)}))):Promise.resolve()}setMediaKeysServerCertificate(e,t,n){return new Promise(((r,s)=>{e.setServerCertificate(n).then((s=>{this.log(`setServerCertificate ${s?"success":"not supported by CDM"} (${null==n?void 0:n.byteLength}) on "${t}"`),r(e)})).catch((e=>{s(new pC({type:_m.KEY_SYSTEM_ERROR,details:Rm.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:e,fatal:!0},e.message))}))}))}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then((t=>this.updateKeySession(e,new Uint8Array(t)).catch((e=>{throw new pC({type:_m.KEY_SYSTEM_ERROR,details:Rm.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:e,fatal:!0},e.message)}))))}setupLicenseXHR(e,t,n,r){const s=this.config.licenseXhrSetup;return s?Promise.resolve().then((()=>{if(!n.decryptdata)throw new Error("Key removed");return s.call(this.hls,e,t,n,r)})).catch((i=>{if(!n.decryptdata)throw i;return e.open("POST",t,!0),s.call(this.hls,e,t,n,r)})).then((n=>{e.readyState||e.open("POST",t,!0);return{xhr:e,licenseChallenge:n||r}})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:r}))}requestLicense(e,t){const n=this.config.keyLoadPolicy.default;return new Promise(((r,s)=>{const i=this.getLicenseServerUrl(e.keySystem);this.log(`Sending license request to URL: ${i}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return s(new Error("invalid state"));if(4===a.readyState)if(200===a.status){this._requestLicenseFailureCount=0;let t=a.response;this.log(`License received ${t instanceof ArrayBuffer?t.byteLength:t}`);const n=this.config.licenseResponseCallback;if(n)try{t=n.call(this.hls,a,i,e)}catch(e){this.error(e)}r(t)}else{const o=n.errorRetry,l=o?o.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)s(new pC({type:_m.KEY_SYSTEM_ERROR,details:Rm.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:a,response:{url:i,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${i}). Status: ${a.status} (${a.statusText})`));else{const n=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${n} attempts left`),this.requestLicense(e,t).then(r,s)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,i,e,t).then((({xhr:e,licenseChallenge:t})=>{e.send(t)}))}))}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const n=t.media;this.media=n,n.addEventListener("encrypted",this.onMediaEncrypted),n.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media,t=this.mediaKeySessions;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},Hy.clearKeyUriToKeyIdMap();const n=t.length;fC.CDMCleanupPromise=Promise.all(t.map((e=>this.removeSession(e))).concat(null==e?void 0:e.setMediaKeys(null).catch((t=>{this.log(`Could not clear media keys: ${t}. media.src: ${null==e?void 0:e.src}`)})))).then((()=>{n&&(this.log("finished closing key sessions and clearing media keys"),t.length=0)})).catch((t=>{this.log(`Could not close sessions and clear media keys: ${t}. media.src: ${null==e?void 0:e.src}`)}))}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(t&&this.config.emeEnabled&&!this.keyFormatPromise){const e=t.reduce(((e,t)=>(-1===e.indexOf(t.keyFormat)&&e.push(t.keyFormat),e)),[]);this.log(`Selecting key-system from session-keys ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:n}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),t.onmessage=null,t.onkeystatuseschange=null,n&&n.readyState!==XMLHttpRequest.DONE&&n.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const r=this.mediaKeySessions.indexOf(e);return r>-1&&this.mediaKeySessions.splice(r,1),t.remove().catch((e=>{this.log(`Could not remove session: ${e}`)})).then((()=>t.close())).catch((e=>{this.log(`Could not close session: ${e}`)}))}}}fC.CDMCleanupPromise=void 0;class pC extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}var gC="m",mC="a",yC="v",vC="av",bC="i",wC="tt";class SC{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=e=>{try{this.apply(e,{ot:gC,su:!this.initialized})}catch(e){Pm.warn("Could not generate manifest CMCD data.",e)}},this.applyFragmentData=e=>{try{const t=e.frag,n=this.hls.levels[t.level],r=this.getObjectType(t),s={d:1e3*t.duration,ot:r};r!==yC&&r!==mC&&r!=vC||(s.br=n.bitrate/1e3,s.tb=this.getTopBandwidth(r)/1e3,s.bl=this.getBufferLength(r)),this.apply(e,s)}catch(e){Pm.warn("Could not generate segment CMCD data.",e)}},this.hls=e;const t=this.config=e.config,{cmcd:n}=t;null!=n&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=n.sessionId||SC.uuid(),this.cid=n.contentId,this.useHeaders=!0===n.useHeaders,this.registerListeners())}registerListeners(){const e=this.hls;e.on(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Am.MEDIA_DETACHED,this.onMediaDetached,this),e.on(Am.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Am.MEDIA_DETACHED,this.onMediaDetached,this),e.off(Am.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var n,r;this.audioBuffer=null==(n=t.tracks.audio)?void 0:n.buffer,this.videoBuffer=null==(r=t.tracks.video)?void 0:r.buffer}createData(){var e;return{v:1,sf:"h",sid:this.sid,cid:this.cid,pr:null==(e=this.media)?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){Im(t,this.createData());const n=t.ot===bC||t.ot===yC||t.ot===vC;if(this.starved&&n&&(t.bs=!0,t.su=!0,this.starved=!1),null==t.su&&(t.su=this.buffering),this.useHeaders){const n=SC.toHeaders(t);if(!Object.keys(n).length)return;e.headers||(e.headers={}),Im(e.headers,n)}else{const n=SC.toQuery(t);if(!n)return;e.url=SC.appendQueryToUri(e.url,n)}}getObjectType(e){const{type:t}=e;return"subtitle"===t?wC:"initSegment"===e.sn?bC:"audio"===t?mC:"main"===t?this.hls.audioTracks.length?yC:vC:void 0}getTopBandwidth(e){let t,n=0;const r=this.hls;if(e===mC)t=r.audioTracks;else{const e=r.maxAutoLevel,n=e>-1?e+1:r.levels.length;t=r.levels.slice(0,n)}for(const e of t)e.bitrate>n&&(n=e.bitrate);return n>0?n:NaN}getBufferLength(e){const t=this.hls.media,n=e===mC?this.audioBuffer:this.videoBuffer;if(!n||!t)return NaN;return 1e3*Lb.bufferInfo(n,t.currentTime,this.config.maxBufferHole).len}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,n=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new n(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,n,r){t(e),this.loader.load(e,n,r)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,n=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new n(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,n,r){t(e),this.loader.load(e,n,r)}}}static uuid(){const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}static serialize(e){const t=[],n=e=>!Number.isNaN(e)&&null!=e&&""!==e&&!1!==e,r=e=>Math.round(e),s=e=>100*r(e/100),i={br:r,d:r,bl:s,dl:s,mtp:s,nor:e=>encodeURIComponent(e),rtp:s,tb:r},a=Object.keys(e||{}).sort();for(const r of a){let s=e[r];if(!n(s))continue;if("v"===r&&1===s)continue;if("pr"==r&&1===s)continue;const a=i[r];a&&(s=a(s));const o=typeof s;let l;l="ot"===r||"sf"===r||"st"===r?`${r}=${s}`:"boolean"===o?r:"number"===o?`${r}=${s}`:`${r}=${JSON.stringify(s)}`,t.push(l)}return t.join(",")}static toHeaders(e){const t=Object.keys(e),n={},r=["Object","Request","Session","Status"],s=[{},{},{},{}],i={br:0,d:0,ot:0,tb:0,bl:1,dl:1,mtp:1,nor:1,nrr:1,su:1,cid:2,pr:2,sf:2,sid:2,st:2,v:2,bs:3,rtp:3};for(const n of t){s[null!=i[n]?i[n]:1][n]=e[n]}for(let e=0;e<s.length;e++){const t=SC.serialize(s[e]);t&&(n[`CMCD-${r[e]}`]=t)}return n}static toQuery(e){return`CMCD=${encodeURIComponent(SC.serialize(e))}`}static appendQueryToUri(e,t){if(!t)return e;const n=e.includes("?")?"&":"?";return`${e}${n}${t}`}}function CC(e,t,n,r){e&&Object.keys(t).forEach((s=>{const i=e.filter((e=>e.groupId===s)).map((e=>{const i=Im({},e);return i.details=void 0,i.attrs=new Um(i.attrs),i.url=i.attrs.URI=TC(e.url,e.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",n),i.groupId=i.attrs["GROUP-ID"]=t[s],i.attrs["PATHWAY-ID"]=r,i}));e.push(...i)}))}function TC(e,t,n,r){const{HOST:s,PARAMS:i,[n]:a}=r;let o;t&&(o=null==a?void 0:a[t],o&&(e=o));const l=new self.URL(e);return s&&!o&&(l.host=s),i&&Object.keys(i).sort().forEach((e=>{e&&l.searchParams.set(e,i[e])})),l.href}const EC=/^age:\s*[\d.]+\s*$/im;class IC{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new jm,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,n){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=n,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e)return;const n=this.loader=new self.XMLHttpRequest,r=this.stats;r.loading.first=0,r.loaded=0,r.aborted=!1;const s=this.xhrSetup;s?Promise.resolve().then((()=>{if(!this.stats.aborted)return s(n,t.url)})).catch((e=>(n.open("GET",t.url,!0),s(n,t.url)))).then((()=>{this.stats.aborted||this.openAndSendXhr(n,t,e)})).catch((e=>{this.callbacks.onError({code:n.status,text:e.message},t,n,r)})):this.openAndSendXhr(n,t,e)}openAndSendXhr(e,t,n){e.readyState||e.open("GET",t.url,!0);const r=this.context.headers,{maxTimeToFirstByteMs:s,maxLoadTimeMs:i}=n.loadPolicy;if(r)for(const t in r)e.setRequestHeader(t,r[t]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),n.timeout=s&&km(s)?s:i,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),n.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:n}=this;if(!e||!t)return;const r=t.readyState,s=this.config;if(!n.aborted&&r>=2&&(0===n.loading.first&&(n.loading.first=Math.max(self.performance.now(),n.loading.start),s.timeout!==s.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),s.timeout=s.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.loadPolicy.maxLoadTimeMs-(n.loading.first-n.loading.start)))),4===r)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const r=t.status,i="text"!==t.responseType;if(r>=200&&r<300&&(i&&t.response||null!==t.responseText)){n.loading.end=Math.max(self.performance.now(),n.loading.first);const s=i?t.response:t.responseText,a="arraybuffer"===t.responseType?s.byteLength:s.length;if(n.loaded=n.total=a,n.bwEstimate=8e3*n.total/(n.loading.end-n.loading.first),!this.callbacks)return;const o=this.callbacks.onProgress;if(o&&o(n,e,s,t),!this.callbacks)return;const l={url:t.responseURL,data:s,code:r};this.callbacks.onSuccess(l,n,e,t)}else{const i=s.loadPolicy.errorRetry;eb(i,n.retry,!1,r)?this.retry(i):(Pm.error(`${r} while loading ${e.url}`),this.callbacks.onError({code:r,text:t.statusText},e,t,n))}}}loadtimeout(){var e;const t=null==(e=this.config)?void 0:e.loadPolicy.timeoutRetry;if(eb(t,this.stats.retry,!0))this.retry(t);else{Pm.warn(`timeout while loading ${this.context.url}`);const e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:n}=this;this.retryDelay=Jv(e,n.retry),n.retry++,Pm.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t.url}, retrying ${n.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&EC.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const kC=/(\d+)-(\d+)\/(\d+)/;class AC{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||_C,this.controller=new self.AbortController,this.stats=new jm}destroy(){this.loader=this.callbacks=null,this.abortInternal()}abortInternal(){const e=this.response;null!=e&&e.ok||(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,n){const r=this.stats;if(r.loading.start)throw new Error("Loader can only be used once.");r.loading.start=self.performance.now();const s=function(e,t){const n={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(Im({},e.headers))};e.rangeEnd&&n.headers.set("Range","bytes="+e.rangeStart+"-"+String(e.rangeEnd-1));return n}(e,this.controller.signal),i=n.onProgress,a="arraybuffer"===e.responseType,o=a?"byteLength":"length",{maxTimeToFirstByteMs:l,maxLoadTimeMs:c}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=n,this.request=this.fetchSetup(e,s),self.clearTimeout(this.requestTimeout),t.timeout=l&&km(l)?l:c,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),n.onTimeout(r,e,this.response)}),t.timeout),self.fetch(this.request).then((s=>{this.response=this.loader=s;const o=Math.max(self.performance.now(),r.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=c,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),n.onTimeout(r,e,this.response)}),c-(o-r.loading.start)),!s.ok){const{status:e,statusText:t}=s;throw new RC(t||"fetch, bad network response",e,s)}return r.loading.first=o,r.total=function(e){const t=e.get("Content-Range");if(t){const e=function(e){const t=kC.exec(e);if(t)return parseInt(t[2])-parseInt(t[1])+1}(t);if(km(e))return e}const n=e.get("Content-Length");if(n)return parseInt(n)}(s.headers)||r.total,i&&km(t.highWaterMark)?this.loadProgressively(s,r,e,t.highWaterMark,i):a?s.arrayBuffer():"json"===e.responseType?s.json():s.text()})).then((s=>{const{response:a}=this;self.clearTimeout(this.requestTimeout),r.loading.end=Math.max(self.performance.now(),r.loading.first);const l=s[o];l&&(r.loaded=r.total=l);const c={url:a.url,data:s,code:a.status};i&&!km(t.highWaterMark)&&i(r,e,s,a),n.onSuccess(c,r,e,a)})).catch((t=>{if(self.clearTimeout(this.requestTimeout),r.aborted)return;const s=t&&t.code||0,i=t?t.message:null;n.onError({code:s,text:i},e,t?t.details:null,r)}))}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,n,r=0,s){const i=new dS,a=e.body.getReader(),o=()=>a.read().then((a=>{if(a.done)return i.dataLength&&s(t,n,i.flush(),e),Promise.resolve(new ArrayBuffer(0));const l=a.value,c=l.length;return t.loaded+=c,c<r||i.dataLength?(i.push(l),i.dataLength>=r&&s(t,n,i.flush(),e)):s(t,n,l,e),o()})).catch((()=>Promise.reject()));return o()}}function _C(e,t){return new self.Request(e.url,t)}class RC extends Error{constructor(e,t,n){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=n}}const OC=/\s/,LC={newCue(e,t,n,r){const s=[];let i,a,o,l,c;const d=self.VTTCue||self.TextTrackCue;for(let h=0;h<r.rows.length;h++)if(i=r.rows[h],o=!0,l=0,c="",!i.isEmpty()){var u;for(let e=0;e<i.chars.length;e++)OC.test(i.chars[e].uchar)&&o?l++:(c+=i.chars[e].uchar,o=!1);i.cueStartTime=t,t===n&&(n+=1e-4),l>=16?l--:l++;const r=VS(c.trim()),f=XS(t,n,r);null!=e&&null!=(u=e.cues)&&u.getCueById(f)||(a=new d(t,n,r),a.id=f,a.line=h+1,a.align="left",a.position=10+Math.min(80,10*Math.floor(8*l/32)),s.push(a))}return e&&s.length&&(s.sort(((e,t)=>"auto"===e.line||"auto"===t.line?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line)),s.forEach((t=>kv(e,t)))),s}},DC=Tm(Tm({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:IC,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:class{constructor(e){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=-1,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=e;const t=e.config;this.bwEstimator=new cS(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate),this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(Am.FRAG_LOADING,this.onFragLoading,this),e.on(Am.FRAG_LOADED,this.onFragLoaded,this),e.on(Am.FRAG_BUFFERED,this.onFragBuffered,this),e.on(Am.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(Am.LEVEL_LOADED,this.onLevelLoaded,this)}unregisterListeners(){const{hls:e}=this;e.off(Am.FRAG_LOADING,this.onFragLoading,this),e.off(Am.FRAG_LOADED,this.onFragLoaded,this),e.off(Am.FRAG_BUFFERED,this.onFragBuffered,this),e.off(Am.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(Am.LEVEL_LOADED,this.onLevelLoaded,this)}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null}onFragLoading(e,t){var n;const r=t.frag;this.ignoreFragment(r)||(this.fragCurrent=r,this.partCurrent=null!=(n=t.part)?n:null,this.clearTimer(),this.timer=self.setInterval(this.onCheck,100))}onLevelSwitching(e,t){this.clearTimer()}getTimeToLoadFrag(e,t,n,r){return e+n/t+(r?this.lastLevelLoadSec:0)}onLevelLoaded(e,t){const n=this.hls.config,{total:r,bwEstimate:s}=t.stats;km(r)&&km(s)&&(this.lastLevelLoadSec=8*r/s),t.details.live?this.bwEstimator.update(n.abrEwmaSlowLive,n.abrEwmaFastLive):this.bwEstimator.update(n.abrEwmaSlowVoD,n.abrEwmaFastVoD)}_abandonRulesCheck(){const{fragCurrent:e,partCurrent:t,hls:n}=this,{autoLevelEnabled:r,media:s}=n;if(!e||!s)return;const i=performance.now(),a=t?t.stats:e.stats,o=t?t.duration:e.duration,l=i-a.loading.start;if(a.aborted||a.loaded&&a.loaded===a.total||0===e.level)return this.clearTimer(),void(this._nextAutoLevel=-1);if(!r||s.paused||!s.playbackRate||!s.readyState)return;const c=n.mainForwardBufferInfo;if(null===c)return;const d=this.bwEstimator.getEstimateTTFB(),u=Math.abs(s.playbackRate);if(l<=Math.max(d,o/(2*u)*1e3))return;const h=c.len/u;if(h>=2*o/u)return;const f=a.loading.first?a.loading.first-a.loading.start:-1,p=a.loaded&&f>-1,g=this.bwEstimator.getEstimate(),{levels:m,minAutoLevel:y}=n,v=m[e.level],b=a.total||Math.max(a.loaded,Math.round(o*v.maxBitrate/8));let w=l-f;w<1&&p&&(w=Math.min(l,8*a.loaded/g));const S=p?1e3*a.loaded/w:0,C=S?(b-a.loaded)/S:8*b/g+d/1e3;if(C<=h)return;const T=S?8*S:g;let E,I=Number.POSITIVE_INFINITY;for(E=e.level-1;E>y;E--){const e=m[E].maxBitrate;if(I=this.getTimeToLoadFrag(d/1e3,T,o*e,!m[E].details),I<h)break}I>=C||I>10*o||(n.nextLoadLevel=E,p?this.bwEstimator.sample(l-Math.min(d,f),a.loaded):this.bwEstimator.sampleTTFB(l),this.clearTimer(),Pm.warn(`[abr] Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} is loading too slowly;\n      Time to underbuffer: ${h.toFixed(3)} s\n      Estimated load time for current fragment: ${C.toFixed(3)} s\n      Estimated load time for down switch fragment: ${I.toFixed(3)} s\n      TTFB estimate: ${f}\n      Current BW estimate: ${km(g)?(g/1024).toFixed(3):"Unknown"} Kb/s\n      New BW estimate: ${(this.bwEstimator.getEstimate()/1024).toFixed(3)} Kb/s\n      Aborting and switching to level ${E}`),e.loader&&(this.fragCurrent=this.partCurrent=null,e.abortRequests()),n.trigger(Am.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:t,stats:a}))}onFragLoaded(e,{frag:t,part:n}){const r=n?n.stats:t.stats;if(t.type===bv&&this.bwEstimator.sampleTTFB(r.loading.first-r.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),this.lastLoadedFragLevel=t.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){const e=n?n.duration:t.duration,s=this.hls.levels[t.level],i=(s.loaded?s.loaded.bytes:0)+r.loaded,a=(s.loaded?s.loaded.duration:0)+e;s.loaded={bytes:i,duration:a},s.realBitrate=Math.round(8*i/a)}if(t.bitrateTest){const e={stats:r,frag:t,part:n,id:t.type};this.onFragBuffered(Am.FRAG_BUFFERED,e),t.bitrateTest=!1}}}onFragBuffered(e,t){const{frag:n,part:r}=t,s=null!=r&&r.stats.loaded?r.stats:n.stats;if(s.aborted)return;if(this.ignoreFragment(n))return;const i=s.parsing.end-s.loading.start-Math.min(s.loading.first-s.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(i,s.loaded),s.bwEstimate=this.bwEstimator.getEstimate(),n.bitrateTest?this.bitrateTestDelay=i/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==bv||"initSegment"===e.sn}clearTimer(){self.clearInterval(this.timer)}get nextAutoLevel(){const e=this._nextAutoLevel,t=this.bwEstimator;if(-1!==e&&!t.canEstimate())return e;let n=this.getNextABRAutoLevel();if(-1!==e){const t=this.hls.levels;if(t.length>Math.max(e,n)&&t[e].loadError<=t[n].loadError)return e}return-1!==e&&(n=Math.min(e,n)),n}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:n}=this,{maxAutoLevel:r,config:s,minAutoLevel:i,media:a}=n,o=t?t.duration:e?e.duration:0,l=a&&0!==a.playbackRate?Math.abs(a.playbackRate):1,c=this.bwEstimator?this.bwEstimator.getEstimate():s.abrEwmaDefaultEstimate,d=n.mainForwardBufferInfo,u=(d?d.len:0)/l;let h=this.findBestLevel(c,i,r,u,s.abrBandWidthFactor,s.abrBandWidthUpFactor);if(h>=0)return h;Pm.trace(`[abr] ${u?"rebuffering expected":"buffer is empty"}, finding optimal quality level`);let f=o?Math.min(o,s.maxStarvationDelay):s.maxStarvationDelay,p=s.abrBandWidthFactor,g=s.abrBandWidthUpFactor;if(!u){const e=this.bitrateTestDelay;if(e){f=(o?Math.min(o,s.maxLoadingDelay):s.maxLoadingDelay)-e,Pm.trace(`[abr] bitrate test took ${Math.round(1e3*e)}ms, set first fragment max fetchDuration to ${Math.round(1e3*f)} ms`),p=g=1}}return h=this.findBestLevel(c,i,r,u+f,p,g),Math.max(h,0)}findBestLevel(e,t,n,r,s,i){var a;const{fragCurrent:o,partCurrent:l,lastLoadedFragLevel:c}=this,{levels:d}=this.hls,u=d[c],h=!(null==u||null==(a=u.details)||!a.live),f=null==u?void 0:u.codecSet,p=l?l.duration:o?o.duration:0,g=this.bwEstimator.getEstimateTTFB()/1e3;let m=t,y=-1;for(let a=n;a>=t;a--){const t=d[a];if(!t||f&&t.codecSet!==f){t&&(m=Math.min(a,m),y=Math.max(a,y));continue}-1!==y&&Pm.trace(`[abr] Skipped level(s) ${m}-${y} with CODECS:"${d[y].attrs.CODECS}"; not compatible with "${u.attrs.CODECS}"`);const n=t.details,o=(l?null==n?void 0:n.partTarget:null==n?void 0:n.averagetargetduration)||p;let v;v=a<=c?s*e:i*e;const b=d[a].maxBitrate,w=this.getTimeToLoadFrag(g,v,b*o,void 0===n);if(Pm.trace(`[abr] level:${a} adjustedbw-bitrate:${Math.round(v-b)} avgDuration:${o.toFixed(1)} maxFetchDuration:${r.toFixed(1)} fetchDuration:${w.toFixed(1)}`),v>b&&(0===w||!km(w)||h&&!this.bitrateTestDelay||w<r))return a}return-1}set nextAutoLevel(e){this._nextAutoLevel=e}},bufferController:class{constructor(e){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=()=>{const{media:e,mediaSource:t}=this;Pm.log("[buffer-controller]: Media source opened"),e&&(e.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(Am.MEDIA_ATTACHED,{media:e})),t&&t.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{Pm.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=()=>{Pm.log("[buffer-controller]: Media source ended")},this._onMediaEmptied=()=>{const{media:e,_objectUrl:t}=this;e&&e.src!==t&&Pm.error(`Media element src was set while attaching MediaSource (${t} > ${e.src})`)},this.hls=e,this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null}registerListeners(){const{hls:e}=this;e.on(Am.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Am.BUFFER_RESET,this.onBufferReset,this),e.on(Am.BUFFER_APPENDING,this.onBufferAppending,this),e.on(Am.BUFFER_CODECS,this.onBufferCodecs,this),e.on(Am.BUFFER_EOS,this.onBufferEos,this),e.on(Am.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(Am.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(Am.FRAG_PARSED,this.onFragParsed,this),e.on(Am.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:e}=this;e.off(Am.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Am.BUFFER_RESET,this.onBufferReset,this),e.off(Am.BUFFER_APPENDING,this.onBufferAppending,this),e.off(Am.BUFFER_CODECS,this.onBufferCodecs,this),e.off(Am.BUFFER_EOS,this.onBufferEos,this),e.off(Am.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(Am.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(Am.FRAG_PARSED,this.onFragParsed,this),e.off(Am.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new gS(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){let n=2;(t.audio&&!t.video||!t.altAudio)&&(n=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=n,Pm.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(e,t){const n=this.media=t.media;if(n&&mS){const e=this.mediaSource=new mS;e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),n.src=self.URL.createObjectURL(e),this._objectUrl=n.src,n.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:e,mediaSource:t,_objectUrl:n}=this;if(t){if(Pm.log("[buffer-controller]: media source detaching"),"open"===t.readyState)try{t.endOfStream()}catch(e){Pm.warn(`[buffer-controller]: onMediaDetaching: ${e.message} while calling endOfStream`)}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),e&&(e.removeEventListener("emptied",this._onMediaEmptied),n&&self.URL.revokeObjectURL(n),e.src===n?(e.removeAttribute("src"),e.load()):Pm.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(Am.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach((e=>{const t=this.sourceBuffer[e];try{t&&(this.removeBufferListeners(e),this.mediaSource&&this.mediaSource.removeSourceBuffer(t),this.sourceBuffer[e]=void 0)}catch(t){Pm.warn(`[buffer-controller]: Failed to reset the ${e} buffer`,t)}})),this._initSourceBuffer()}onBufferCodecs(e,t){const n=this.getSourceBufferTypes().length;Object.keys(t).forEach((e=>{if(n){const n=this.tracks[e];if(n&&"function"==typeof n.buffer.changeType){const{id:r,codec:s,levelCodec:i,container:a,metadata:o}=t[e],l=(n.levelCodec||n.codec).replace(yS,"$1"),c=(i||s).replace(yS,"$1");if(l!==c){const t=`${a};codecs=${i||s}`;this.appendChangeType(e,t),Pm.log(`[buffer-controller]: switching codec ${l} to ${c}`),this.tracks[e]={buffer:n.buffer,codec:s,container:a,levelCodec:i,metadata:o,id:r}}}}else this.pendingTracks[e]=t[e]})),n||(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks())}appendChangeType(e,t){const{operationQueue:n}=this,r={execute:()=>{const r=this.sourceBuffer[e];r&&(Pm.log(`[buffer-controller]: changing ${e} sourceBuffer type to ${t}`),r.changeType(t)),n.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:t=>{Pm.warn(`[buffer-controller]: Failed to change ${e} SourceBuffer type`,t)}};n.append(r,e)}onBufferAppending(e,t){const{hls:n,operationQueue:r,tracks:s}=this,{data:i,type:a,frag:o,part:l,chunkMeta:c}=t,d=c.buffering[a],u=self.performance.now();d.start=u;const h=o.stats.buffering,f=l?l.stats.buffering:null;0===h.start&&(h.start=u),f&&0===f.start&&(f.start=u);const p=s.audio;let g=!1;"audio"===a&&"audio/mpeg"===(null==p?void 0:p.container)&&(g=!this.lastMpegAudioChunk||1===c.id||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const m=o.start,y={execute:()=>{if(d.executeStart=self.performance.now(),g){const e=this.sourceBuffer[a];if(e){const t=m-e.timestampOffset;Math.abs(t)>=.1&&(Pm.log(`[buffer-controller]: Updating audio SourceBuffer timestampOffset to ${m} (delta: ${t}) sn: ${o.sn})`),e.timestampOffset=m)}}this.appendExecutor(i,a)},onStart:()=>{},onComplete:()=>{const e=self.performance.now();d.executeEnd=d.end=e,0===h.first&&(h.first=e),f&&0===f.first&&(f.first=e);const{sourceBuffer:t}=this,n={};for(const e in t)n[e]=Lb.getBuffered(t[e]);this.appendError=0,this.hls.trigger(Am.BUFFER_APPENDED,{type:a,frag:o,part:l,chunkMeta:c,parent:o.type,timeRanges:n})},onError:e=>{Pm.error(`[buffer-controller]: Error encountered while trying to append to the ${a} SourceBuffer`,e);const t={type:_m.MEDIA_ERROR,parent:o.type,details:Rm.BUFFER_APPEND_ERROR,frag:o,part:l,chunkMeta:c,error:e,err:e,fatal:!1};e.code===DOMException.QUOTA_EXCEEDED_ERR?t.details=Rm.BUFFER_FULL_ERROR:(this.appendError++,t.details=Rm.BUFFER_APPEND_ERROR,this.appendError>n.config.appendErrorMaxRetry&&(Pm.error(`[buffer-controller]: Failed ${n.config.appendErrorMaxRetry} times to append segment in sourceBuffer`),t.fatal=!0)),n.trigger(Am.ERROR,t)}};r.append(y,a)}onBufferFlushing(e,t){const{operationQueue:n}=this,r=e=>({execute:this.removeExecutor.bind(this,e,t.startOffset,t.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(Am.BUFFER_FLUSHED,{type:e})},onError:t=>{Pm.warn(`[buffer-controller]: Failed to remove from ${e} SourceBuffer`,t)}});t.type?n.append(r(t.type),t.type):this.getSourceBufferTypes().forEach((e=>{n.append(r(e),e)}))}onFragParsed(e,t){const{frag:n,part:r}=t,s=[],i=r?r.elementaryStreams:n.elementaryStreams;i[Km]?s.push("audiovideo"):(i[$m]&&s.push("audio"),i[qm]&&s.push("video"));0===s.length&&Pm.warn(`Fragments must have at least one ElementaryStreamType set. type: ${n.type} level: ${n.level} sn: ${n.sn}`),this.blockBuffers((()=>{const e=self.performance.now();n.stats.buffering.end=e,r&&(r.stats.buffering.end=e);const t=r?r.stats:n.stats;this.hls.trigger(Am.FRAG_BUFFERED,{frag:n,part:r,stats:t,id:n.type})}),s)}onFragChanged(e,t){this.flushBackBuffer()}onBufferEos(e,t){this.getSourceBufferTypes().reduce(((e,n)=>{const r=this.sourceBuffer[n];return!r||t.type&&t.type!==n||(r.ending=!0,r.ended||(r.ended=!0,Pm.log(`[buffer-controller]: ${n} sourceBuffer now EOS`))),e&&!(r&&!r.ended)}),!0)&&(Pm.log("[buffer-controller]: Queueing mediaSource.endOfStream()"),this.blockBuffers((()=>{this.getSourceBufferTypes().forEach((e=>{const t=this.sourceBuffer[e];t&&(t.ending=!1)}));const{mediaSource:e}=this;e&&"open"===e.readyState?(Pm.log("[buffer-controller]: Calling mediaSource.endOfStream()"),e.endOfStream()):e&&Pm.info(`[buffer-controller]: Could not call mediaSource.endOfStream(). mediaSource.readyState: ${e.readyState}`)})))}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}flushBackBuffer(){const{hls:e,details:t,media:n,sourceBuffer:r}=this;if(!n||null===t)return;const s=this.getSourceBufferTypes();if(!s.length)return;const i=t.live&&null!==e.config.liveBackBufferLength?e.config.liveBackBufferLength:e.config.backBufferLength;if(!km(i)||i<0)return;const a=n.currentTime,o=t.levelTargetDuration,l=Math.max(i,o),c=Math.floor(a/o)*o-l;s.forEach((n=>{const s=r[n];if(s){const r=Lb.getBuffered(s);if(r.length>0&&c>r.start(0)){if(e.trigger(Am.BACK_BUFFER_REACHED,{bufferEnd:c}),t.live)e.trigger(Am.LIVE_BACK_BUFFER_REACHED,{bufferEnd:c});else if(s.ended&&r.end(r.length-1)-a<2*o)return void Pm.info(`[buffer-controller]: Cannot flush ${n} back buffer while SourceBuffer is in ended state`);e.trigger(Am.BUFFER_FLUSHING,{startOffset:0,endOffset:c,type:n})}}}))}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;const{details:e,hls:t,media:n,mediaSource:r}=this,s=e.fragments[0].start+e.totalduration,i=n.duration,a=km(r.duration)?r.duration:0;e.live&&t.config.liveDurationInfinity?(Pm.log("[buffer-controller]: Media Source duration is set to Infinity"),r.duration=1/0,this.updateSeekableRange(e)):(s>a&&s>i||!km(i))&&(Pm.log(`[buffer-controller]: Updating Media Source duration to ${s.toFixed(3)}`),r.duration=s)}updateSeekableRange(e){const t=this.mediaSource,n=e.fragments;if(n.length&&e.live&&null!=t&&t.setLiveSeekableRange){const r=Math.max(0,n[0].start),s=Math.max(r,r+e.totalduration);t.setLiveSeekableRange(r,s)}}checkPendingTracks(){const{bufferCodecEventsExpected:e,operationQueue:t,pendingTracks:n}=this,r=Object.keys(n).length;if(r&&!e||2===r){this.createSourceBuffers(n),this.pendingTracks={};const e=this.getSourceBufferTypes();if(e.length)this.hls.trigger(Am.BUFFER_CREATED,{tracks:this.tracks}),e.forEach((e=>{t.executeNext(e)}));else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}}createSourceBuffers(e){const{sourceBuffer:t,mediaSource:n}=this;if(!n)throw Error("createSourceBuffers called when mediaSource was null");for(const r in e)if(!t[r]){const s=e[r];if(!s)throw Error(`source buffer exists for track ${r}, however track does not`);const i=s.levelCodec||s.codec,a=`${s.container};codecs=${i}`;Pm.log(`[buffer-controller]: creating sourceBuffer(${a})`);try{const e=t[r]=n.addSourceBuffer(a),o=r;this.addBufferListener(o,"updatestart",this._onSBUpdateStart),this.addBufferListener(o,"updateend",this._onSBUpdateEnd),this.addBufferListener(o,"error",this._onSBUpdateError),this.tracks[r]={buffer:e,codec:i,container:s.container,levelCodec:s.levelCodec,metadata:s.metadata,id:s.id}}catch(e){Pm.error(`[buffer-controller]: error while trying to add sourceBuffer: ${e.message}`),this.hls.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,mimeType:a})}}}_onSBUpdateStart(e){const{operationQueue:t}=this;t.current(e).onStart()}_onSBUpdateEnd(e){const{operationQueue:t}=this;t.current(e).onComplete(),t.shiftAndExecuteNext(e)}_onSBUpdateError(e,t){const n=new Error(`${e} SourceBuffer error`);Pm.error(`[buffer-controller]: ${n}`,t),this.hls.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.BUFFER_APPENDING_ERROR,error:n,fatal:!1});const r=this.operationQueue.current(e);r&&r.onError(t)}removeExecutor(e,t,n){const{media:r,mediaSource:s,operationQueue:i,sourceBuffer:a}=this,o=a[e];if(!r||!s||!o)return Pm.warn(`[buffer-controller]: Attempting to remove from the ${e} SourceBuffer, but it does not exist`),void i.shiftAndExecuteNext(e);const l=km(r.duration)?r.duration:1/0,c=km(s.duration)?s.duration:1/0,d=Math.max(0,t),u=Math.min(n,l,c);u>d&&!o.ending?(o.ended=!1,Pm.log(`[buffer-controller]: Removing [${d},${u}] from the ${e} SourceBuffer`),o.remove(d,u)):i.shiftAndExecuteNext(e)}appendExecutor(e,t){const{operationQueue:n,sourceBuffer:r}=this,s=r[t];if(!s)return Pm.warn(`[buffer-controller]: Attempting to append to the ${t} SourceBuffer, but it does not exist`),void n.shiftAndExecuteNext(t);s.ended=!1,s.appendBuffer(e)}blockBuffers(e,t=this.getSourceBufferTypes()){if(!t.length)return Pm.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(e);const{operationQueue:n}=this,r=t.map((e=>n.appendBlocker(e)));Promise.all(r).then((()=>{e(),t.forEach((e=>{const t=this.sourceBuffer[e];null!=t&&t.updating||n.shiftAndExecuteNext(e)}))}))}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(e,t,n){const r=this.sourceBuffer[e];if(!r)return;const s=n.bind(this,e);this.listeners[e].push({event:t,listener:s}),r.addEventListener(t,s)}removeBufferListeners(e){const t=this.sourceBuffer[e];t&&this.listeners[e].forEach((e=>{t.removeEventListener(e.event,e.listener)}))}},capLevelController:uC,errorController:class{constructor(e){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=e,this.log=Pm.log.bind(Pm,"[info]:"),this.warn=Pm.warn.bind(Pm,"[warning]:"),this.error=Pm.error.bind(Pm,"[error]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(Am.ERROR,this.onError,this),e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(Am.ERROR,this.onError,this),e.off(Am.ERROR,this.onErrorOut,this),e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){this.playlistError=0}stopLoad(){}getVariantLevelIndex(e){return(null==e?void 0:e.type)===bv?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var n,r;if(t.fatal)return;const s=this.hls,i=t.context;switch(t.details){case Rm.FRAG_LOAD_ERROR:case Rm.FRAG_LOAD_TIMEOUT:case Rm.KEY_LOAD_ERROR:case Rm.KEY_LOAD_TIMEOUT:return void(t.errorAction=this.getFragRetryOrSwitchAction(t));case Rm.FRAG_PARSING_ERROR:if(null!=(n=t.frag)&&n.gap)return void(t.errorAction={action:ib,flags:lb});case Rm.FRAG_GAP:case Rm.FRAG_DECRYPT_ERROR:return t.errorAction=this.getFragRetryOrSwitchAction(t),void(t.errorAction.action=ab);case Rm.LEVEL_EMPTY_ERROR:case Rm.LEVEL_PARSING_ERROR:{var a,o;const e=t.parent===bv?t.level:s.loadLevel;t.details===Rm.LEVEL_EMPTY_ERROR&&null!=(a=t.context)&&null!=(o=a.levelDetails)&&o.live?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,e):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e))}return;case Rm.LEVEL_LOAD_ERROR:case Rm.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==i?void 0:i.level)&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,i.level)));case Rm.AUDIO_TRACK_LOAD_ERROR:case Rm.AUDIO_TRACK_LOAD_TIMEOUT:case Rm.SUBTITLE_LOAD_ERROR:case Rm.SUBTITLE_TRACK_LOAD_TIMEOUT:if(i){const e=s.levels[s.loadLevel];if(e&&(i.type===yv&&i.groupId===e.audioGroupId||i.type===vv&&i.groupId===e.textGroupId))return t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.loadLevel),t.errorAction.action=ab,void(t.errorAction.flags=cb)}return;case Rm.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const e=s.levels[s.loadLevel],n=null==e?void 0:e.attrs["HDCP-LEVEL"];n&&(t.errorAction={action:ab,flags:db,hdcpLevel:n})}return;case Rm.BUFFER_ADD_CODEC_ERROR:case Rm.REMUX_ALLOC_ERROR:return void(t.errorAction=this.getLevelSwitchAction(t,null!=(r=t.level)?r:s.loadLevel));case Rm.INTERNAL_EXCEPTION:case Rm.BUFFER_APPENDING_ERROR:case Rm.BUFFER_APPEND_ERROR:case Rm.BUFFER_FULL_ERROR:case Rm.LEVEL_SWITCH_ERROR:case Rm.BUFFER_STALLED_ERROR:case Rm.BUFFER_SEEK_OVER_HOLE:case Rm.BUFFER_NUDGE_ON_STALL:return void(t.errorAction={action:ib,flags:lb})}if(t.type===_m.KEY_SYSTEM_ERROR){const e=this.getVariantLevelIndex(t.frag);return t.levelRetry=!1,void(t.errorAction=this.getLevelSwitchAction(t,e))}}getPlaylistRetryOrSwitchAction(e,t){var n;const r=Xv(this.hls.config.playlistLoadPolicy,e),s=this.playlistError++,i=null==(n=e.response)?void 0:n.code;if(eb(r,s,Qv(e),i))return{action:ob,flags:lb,retryConfig:r,retryCount:s};const a=this.getLevelSwitchAction(e,t);return r&&(a.retryConfig=r,a.retryCount=s),a}getFragRetryOrSwitchAction(e){const t=this.hls,n=this.getVariantLevelIndex(e.frag),r=t.levels[n],{fragLoadPolicy:s,keyLoadPolicy:i}=t.config,a=Xv(e.details.startsWith("key")?i:s,e),o=t.levels.reduce(((e,t)=>e+t.fragmentError),0);if(r){var l;e.details!==Rm.FRAG_GAP&&r.fragmentError++;const t=null==(l=e.response)?void 0:l.code;if(eb(a,o,Qv(e),t))return{action:ob,flags:lb,retryConfig:a,retryCount:o}}const c=this.getLevelSwitchAction(e,n);return a&&(c.retryConfig=a,c.retryCount=o),c}getLevelSwitchAction(e,t){const n=this.hls;null==t&&(t=n.loadLevel);const r=this.hls.levels[t];if(r&&(r.loadError++,n.autoLevelEnabled)){var s,i;let t=-1;const{levels:a,loadLevel:o,minAutoLevel:l,maxAutoLevel:c}=n,d=null==(s=e.frag)?void 0:s.type,{type:u,groupId:h}=null!=(i=e.context)?i:{};for(let n=a.length;n--;){const s=(n+o)%a.length;if(s!==o&&s>=l&&s<=c&&0===a[s].loadError){const n=a[s];if(e.details===Rm.FRAG_GAP&&e.frag){const t=a[s].details;if(t){const n=nb(e.frag,t.fragments,e.frag.start);if(null!=n&&n.gap)continue}}else{if(u===yv&&h===n.audioGroupId||u===vv&&h===n.textGroupId)continue;if(d===wv&&r.audioGroupId===n.audioGroupId||d===Sv&&r.textGroupId===n.textGroupId)continue}t=s;break}}if(t>-1&&n.loadLevel!==t)return e.levelRetry=!0,this.playlistError=0,{action:ab,flags:lb,nextAutoLevel:t}}return{action:ab,flags:cb}}onErrorOut(e,t){var n;switch(null==(n=t.errorAction)?void 0:n.action){case ib:break;case ab:this.sendAlternateToPenaltyBox(t),t.errorAction.resolved||t.details===Rm.FRAG_GAP||(t.fatal=!0)}t.fatal&&this.hls.stopLoad()}sendAlternateToPenaltyBox(e){const t=this.hls,n=e.errorAction;if(!n)return;const{flags:r,hdcpLevel:s,nextAutoLevel:i}=n;switch(r){case lb:this.switchLevel(e,i);break;case cb:n.resolved||(n.resolved=this.redundantFailover(e));break;case db:s&&(t.maxHdcpLevel=Uv[Uv.indexOf(s)-1],n.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`)}n.resolved||this.switchLevel(e,i)}switchLevel(e,t){void 0!==t&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}redundantFailover(e){const{hls:t,penalizedRenditions:n}=this,r=e.parent===bv?e.level:t.loadLevel,s=t.levels[r],i=s.url.length,a=e.frag?e.frag.urlId:s.urlId;s.urlId!==a||e.frag&&!s.details||this.penalizeRendition(s,e);for(let o=1;o<i;o++){const l=(a+o)%i,c=n[l];if(!c||ub(c,e,n[a]))return this.warn(`Switching to Redundant Stream ${l+1}/${i}: "${s.url[l]}" after ${e.details}`),this.playlistError=0,t.levels.forEach((e=>{e.urlId=l})),t.nextLoadLevel=r,!0}return!1}penalizeRendition(e,t){const{penalizedRenditions:n}=this,r=n[e.urlId]||{lastErrorPerfMs:0,errors:[],details:void 0};r.lastErrorPerfMs=performance.now(),r.errors.push(t),r.details=e.details,n[e.urlId]=r}},fpsController:class{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(Am.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(Am.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const n=this.hls.config;if(n.capLevelOnFPSDrop){const e=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=e,e&&"function"==typeof e.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),n.fpsDroppedMonitoringPeriod)}}checkFPS(e,t,n){const r=performance.now();if(t){if(this.lastTime){const e=r-this.lastTime,s=n-this.lastDroppedFrames,i=t-this.lastDecodedFrames,a=1e3*s/e,o=this.hls;if(o.trigger(Am.FPS_DROP,{currentDropped:s,currentDecoded:i,totalDroppedFrames:n}),a>0&&s>o.config.fpsDroppedMonitoringThreshold*i){let e=o.currentLevel;Pm.warn("drop FPS ratio greater than max allowed value for currentLevel: "+e),e>0&&(-1===o.autoLevelCapping||o.autoLevelCapping>=e)&&(e-=1,o.trigger(Am.FPS_DROP_LEVEL_CAPPING,{level:e,droppedLevel:o.currentLevel}),o.autoLevelCapping=e,this.streamController.nextLevelSwitch())}}this.lastTime=r,this.lastDroppedFrames=n,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}},stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:ay,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:LC,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:class extends tw{constructor(e,t,n){super(e,t,n,"[subtitle-stream-controller]",Sv),this.levels=[],this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),this.mainDetails=null}_registerListeners(){const{hls:e}=this;e.on(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Am.ERROR,this.onError,this),e.on(Am.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(Am.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(Am.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(Am.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(Am.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(Am.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Am.ERROR,this.onError,this),e.off(Am.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(Am.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(Am.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(Am.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(Am.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(Am.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(e){this.stopLoad(),this.state=Gb,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:n,success:r}=t;if(this.fragPrevious=n,this.state=Gb,!r)return;const s=this.tracksBuffered[this.currentTrackId];if(!s)return;let i;const a=n.start;for(let e=0;e<s.length;e++)if(a>=s[e].start&&a<=s[e].end){i=s[e];break}const o=n.start+n.duration;i?i.end=o:(i={start:a,end:o},s.push(i)),this.fragmentTracker.fragBuffered(n)}onBufferFlushing(e,t){const{startOffset:n,endOffset:r}=t;if(0===n&&r!==Number.POSITIVE_INFINITY){const e=r-1;if(e<=0)return;t.endOffsetSubtitles=Math.max(0,e),this.tracksBuffered.forEach((t=>{for(let n=0;n<t.length;)if(t[n].end<=e)t.shift();else{if(!(t[n].start<e))break;t[n].start=e,n++}})),this.fragmentTracker.removeFragmentsInRange(n,e,Sv)}}onFragBuffered(e,t){var n;this.loadedmetadata||t.frag.type!==bv||null!=(n=this.media)&&n.buffered.length&&(this.loadedmetadata=!0)}onError(e,t){const n=t.frag;(null==n?void 0:n.type)===Sv&&(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==Kb&&(this.state=Gb))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){uS(this.levels,t)?this.levels=t.map((e=>new qv(e))):(this.tracksBuffered=[],this.levels=t.map((e=>{const t=new qv(e);return this.tracksBuffered[t.id]=[],t})),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,Sv),this.fragPrevious=null,this.mediaBuffer=null)}onSubtitleTrackSwitch(e,t){if(this.currentTrackId=t.id,!this.levels.length||-1===this.currentTrackId)return void this.clearInterval();const n=this.levels[this.currentTrackId];null!=n&&n.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,n&&this.setInterval(500)}onSubtitleTrackLoaded(e,t){var n;const{details:r,id:s}=t,{currentTrackId:i,levels:a}=this;if(!a.length)return;const o=a[i];if(s>=a.length||s!==i||!o)return;this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(r.live||null!=(n=o.details)&&n.live){const e=this.mainDetails;if(r.deltaUpdateFailed||!e)return;const t=e.fragments[0];o.details?(l=this.alignPlaylists(r,o.details),0===l&&t&&(l=t.start,zv(r,l))):r.hasProgramDateTime&&e.hasProgramDateTime?(Ub(r,e),l=r.fragments[0].start):t&&(l=t.start,zv(r,l))}if(o.details=r,this.levelLastLoaded=s,this.startFragRequested||!this.mainDetails&&r.live||this.setStartPosition(o.details,l),this.tick(),r.live&&!this.fragCurrent&&this.media&&this.state===Gb){nb(null,r.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0)}}_handleFragmentLoadComplete(e){const{frag:t,payload:n}=e,r=t.decryptdata,s=this.hls;if(!this.fragContextChanged(t)&&n&&n.byteLength>0&&r&&r.key&&r.iv&&"AES-128"===r.method){const e=performance.now();this.decrypter.decrypt(new Uint8Array(n),r.key.buffer,r.iv.buffer).catch((e=>{throw s.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e})).then((n=>{const r=performance.now();s.trigger(Am.FRAG_DECRYPTED,{frag:t,payload:n,stats:{tstart:e,tdecrypt:r}})})).catch((e=>{this.warn(`${e.name}: ${e.message}`),this.state=Gb}))}}doTick(){if(this.media){if(this.state===Gb){const{currentTrackId:e,levels:t}=this,n=t[e];if(!t.length||!n||!n.details)return;const{config:r}=this,s=this.getLoadPosition(),i=Lb.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],s,r.maxBufferHole),{end:a,len:o}=i,l=this.getFwdBufferInfo(this.media,bv),c=n.details;if(o>this.getMaxBufferLength(null==l?void 0:l.len)+c.levelTargetDuration)return;const d=c.fragments,u=d.length,h=c.edge;let f=null;const p=this.fragPrevious;if(a<h){const e=r.maxFragLookUpTolerance,t=a>h-e?0:e;f=nb(p,d,Math.max(d[0].start,a),t),!f&&p&&p.start<d[0].start&&(f=d[0])}else f=d[u-1];if(!f)return;if(f=this.mapToInitFragWhenRequired(f),"initSegment"!==f.sn){const e=d[f.sn-c.startSN-1];e&&e.cc===f.cc&&this.fragmentTracker.getState(e)===yb&&(f=e)}this.fragmentTracker.getState(f)===yb&&this.loadFragment(f,n,a)}}else this.state=Gb}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.max(t,e):t}loadFragment(e,t,n){this.fragCurrent=e,"initSegment"===e.sn?this._loadInitSegment(e,t):(this.startFragRequested=!0,super.loadFragment(e,t,n))}get mediaBufferTimeRanges(){return new fS(this.tracksBuffered[this.currentTrackId]||[])}},subtitleTrackController:class extends hb{constructor(e){super(e,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.trackChangeListener=()=>this.onTextTracksChanged(),this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes(this.trackId)}registerListeners(){const{hls:e}=this;e.on(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Am.LEVEL_LOADING,this.onLevelLoading,this),e.on(Am.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(Am.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(Am.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Am.LEVEL_LOADING,this.onLevelLoading,this),e.off(Am.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(Am.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(Am.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,e)}onMediaDetaching(){if(!this.media)return;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId);pS(this.media.textTracks).forEach((e=>{Av(e)})),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:n,details:r}=t,{trackId:s}=this,i=this.tracksInGroup[s];if(!i)return void this.warn(`Invalid subtitle track id ${n}`);const a=i.details;i.details=t.details,this.log(`subtitle track ${n} loaded [${r.startSN}-${r.endSN}]`),n===this.trackId&&this.playlistLoaded(n,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(null==t||!t.textGroupIds)return;const n=t.textGroupIds[t.urlId],r=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;if(this.groupId!==n){const e=this.tracks.filter((e=>!n||e.groupId===n));this.tracksInGroup=e;const t=this.findTrackId(null==r?void 0:r.name)||this.findTrackId();this.groupId=n||null;const s={subtitleTracks:e};this.log(`Updating subtitle tracks, ${e.length} track(s) found in "${n}" group-id`),this.hls.trigger(Am.SUBTITLE_TRACKS_UPDATED,s),-1!==t&&this.setSubtitleTrack(t,r)}else this.shouldReloadPlaylist(r)&&this.setSubtitleTrack(this.trackId,r)}findTrackId(e){const t=this.tracksInGroup;for(let n=0;n<t.length;n++){const r=t[n];if((!this.selectDefaultTrack||r.default)&&(!e||e===r.name))return r.id}return-1}onError(e,t){!t.fatal&&t.context&&t.context.type===vv&&t.context.id===this.trackId&&t.context.groupId===this.groupId&&this.checkRetry(t)}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1;const t=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(e,t)}loadPlaylist(e){super.loadPlaylist();const t=this.tracksInGroup[this.trackId];if(this.shouldLoadPlaylist(t)){const n=t.id,r=t.groupId;let s=t.url;if(e)try{s=e.addDirectives(s)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: ${e}`)}this.log(`Loading subtitle playlist for id ${n}`),this.hls.trigger(Am.SUBTITLE_TRACK_LOADING,{url:s,id:n,groupId:r,deliveryDirectives:e||null})}}toggleTrackModes(e){const{media:t,trackId:n}=this;if(!t)return;const r=pS(t.textTracks),s=r.filter((e=>e.groupId===this.groupId));if(-1===e)[].slice.call(r).forEach((e=>{e.mode="disabled"}));else{const e=s[n];e&&(e.mode="disabled")}const i=s[e];i&&(i.mode=this.subtitleDisplay?"showing":"hidden")}setSubtitleTrack(e,t){var n;const r=this.tracksInGroup;if(!this.media)return void(this.queuedDefaultTrack=e);if(this.trackId!==e&&this.toggleTrackModes(e),this.trackId===e&&(-1===e||null!=(n=r[e])&&n.details)||e<-1||e>=r.length)return;this.clearTimer();const s=r[e];if(this.log(`Switching to subtitle-track ${e}`+(s?` "${s.name}" lang:${s.lang} group:${s.groupId}`:"")),this.trackId=e,s){const{id:e,groupId:n="",name:r,type:i,url:a}=s;this.hls.trigger(Am.SUBTITLE_TRACK_SWITCH,{id:e,groupId:n,name:r,type:i,url:a});const o=this.switchParams(s.url,null==t?void 0:t.details);this.loadPlaylist(o)}else this.hls.trigger(Am.SUBTITLE_TRACK_SWITCH,{id:e})}onTextTracksChanged(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=-1;const t=pS(this.media.textTracks);for(let n=0;n<t.length;n++)if("hidden"===t[n].mode)e=n;else if("showing"===t[n].mode){e=n;break}this.subtitleTrack!==e&&(this.subtitleTrack=e)}},timelineController:class{constructor(e){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){const e=new US(this,"textTrack1"),t=new US(this,"textTrack2"),n=new US(this,"textTrack3"),r=new US(this,"textTrack4");this.cea608Parser1=new PS(1,e,t),this.cea608Parser2=new PS(3,n,r)}e.on(Am.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(Am.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(Am.FRAG_LOADING,this.onFragLoading,this),e.on(Am.FRAG_LOADED,this.onFragLoaded,this),e.on(Am.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(Am.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(Am.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(Am.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(Am.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(Am.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(Am.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(Am.FRAG_LOADING,this.onFragLoading,this),e.off(Am.FRAG_LOADED,this.onFragLoaded,this),e.off(Am.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(Am.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(Am.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(Am.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(Am.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null}addCues(e,t,n,r,s){let i=!1;for(let e=s.length;e--;){const r=s[e],d=(a=r[0],o=r[1],l=t,c=n,Math.min(o,c)-Math.max(a,l));if(d>=0&&(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],n),i=!0,d/(n-t)>.5))return}var a,o,l,c;if(i||s.push([t,n]),this.config.renderTextTracksNatively){const s=this.captionsTracks[e];this.Cues.newCue(s,t,n,r)}else{const s=this.Cues.newCue(null,t,n,r);this.hls.trigger(Am.CUES_PARSED,{type:"captions",cues:s,track:e})}}onInitPtsFound(e,{frag:t,id:n,initPTS:r,timescale:s}){const{unparsedVttFrags:i}=this;"main"===n&&(this.initPTS[t.cc]={baseTime:r,timescale:s}),i.length&&(this.unparsedVttFrags=[],i.forEach((e=>{this.onFragLoaded(Am.FRAG_LOADED,e)})))}getExistingTrack(e){const{media:t}=this;if(t)for(let n=0;n<t.textTracks.length;n++){const r=t.textTracks[n];if(r[e])return r}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:n,media:r}=this,{label:s,languageCode:i}=t[e],a=this.getExistingTrack(e);if(a)n[e]=a,Av(n[e]),Iv(n[e],r);else{const t=this.createTextTrack("captions",s,i);t&&(t[e]=!0,n[e]=t)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const n={_id:e,label:t.label,kind:"captions",default:!!t.media&&!!t.media.default,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(Am.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}createTextTrack(e,t,n){const r=this.media;if(r)return r.addTextTrack(e,t,n)}onMediaAttaching(e,t){this.media=t.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:e}=this;Object.keys(e).forEach((t=>{Av(e[t]),delete e[t]})),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let e=0;e<t.length;e++)Av(t[e])}onSubtitleTracksUpdated(e,t){const n=t.subtitleTracks||[],r=n.some((e=>e.textCodec===ZS));if(this.config.enableWebVTT||r&&this.config.enableIMSC1){if(uS(this.tracks,n))return void(this.tracks=n);if(this.textTracks=[],this.tracks=n,this.config.renderTextTracksNatively){const e=this.media?this.media.textTracks:null;this.tracks.forEach(((t,n)=>{let r;if(e&&n<e.length){let n=null;for(let r=0;r<e.length;r++)if(dC(e[r],t)){n=e[r];break}n&&(r=n)}if(r)Av(r);else{const e=this._captionsOrSubtitlesFromCharacteristics(t);r=this.createTextTrack(e,t.name,t.lang),r&&(r.mode="disabled")}r&&(r.groupId=t.groupId,this.textTracks.push(r))}))}else if(this.tracks.length){const e=this.tracks.map((e=>({label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e})));this.hls.trigger(Am.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:e})}}}_captionsOrSubtitlesFromCharacteristics(e){if(e.attrs.CHARACTERISTICS){const t=/transcribes-spoken-dialog/gi.test(e.attrs.CHARACTERISTICS),n=/describes-music-and-sound/gi.test(e.attrs.CHARACTERISTICS);if(t&&n)return"captions"}return"subtitles"}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach((e=>{const t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(!t)return;const n=`textTrack${t[1]}`,r=this.captionsProperties[n];r&&(r.label=e.name,e.lang&&(r.languageCode=e.lang),r.media=e)}))}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return null==t?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){const{cea608Parser1:n,cea608Parser2:r,lastSn:s,lastPartIndex:i}=this;if(this.enabled&&n&&r&&t.frag.type===bv){var a,o;const e=t.frag.sn,l=null!=(a=null==t||null==(o=t.part)?void 0:o.index)?a:-1;e===s+1||e===s&&l===i+1||(n.reset(),r.reset()),this.lastSn=e,this.lastPartIndex=l}}onFragLoaded(e,t){const{frag:n,payload:r}=t;if(n.type===Sv)if(r.byteLength){const e=n.decryptdata,s="stats"in t;if(null==e||!e.encrypted||s){const e=this.tracks[n.level],s=this.vttCCs;s[n.cc]||(s[n.cc]={start:n.start,prevCC:this.prevCC,new:!0},this.prevCC=n.cc),e&&e.textCodec===ZS?this._parseIMSC1(n,r):this._parseVTTs(t)}}else this.hls.trigger(Am.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const n=this.hls;rC(t,this.initPTS[e.cc],(t=>{this._appendCues(t,e.level),n.trigger(Am.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})}),(t=>{Pm.log(`Failed to parse IMSC1: ${t}`),n.trigger(Am.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})}))}_parseVTTs(e){var t;const{frag:n,payload:r}=e,{initPTS:s,unparsedVttFrags:i}=this,a=s.length-1;if(!s[n.cc]&&-1===a)return void i.push(e);const o=this.hls;JS(null!=(t=n.initSegment)&&t.data?Ny(n.initSegment.data,new Uint8Array(r)):r,this.initPTS[n.cc],this.vttCCs,n.cc,n.start,(e=>{this._appendCues(e,n.level),o.trigger(Am.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:n})}),(t=>{const s="Missing initPTS for VTT MPEGTS"===t.message;s?i.push(e):this._fallbackToIMSC1(n,r),Pm.log(`Failed to parse VTT cue: ${t}`),s&&a>n.cc||o.trigger(Am.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:t})}))}_fallbackToIMSC1(e,t){const n=this.tracks[e.level];n.textCodec||rC(t,this.initPTS[e.cc],(()=>{n.textCodec=ZS,this._parseIMSC1(e,t)}),(()=>{n.textCodec="wvtt"}))}_appendCues(e,t){const n=this.hls;if(this.config.renderTextTracksNatively){const n=this.textTracks[t];if(!n||"disabled"===n.mode)return;e.forEach((e=>kv(n,e)))}else{const r=this.tracks[t];if(!r)return;const s=r.default?"default":"subtitles"+t;n.trigger(Am.CUES_PARSED,{type:"subtitles",cues:e,track:s})}}onFragDecrypted(e,t){const{frag:n}=t;n.type===Sv&&this.onFragLoaded(Am.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){const{cea608Parser1:n,cea608Parser2:r}=this;if(!this.enabled||!n||!r)return;const{frag:s,samples:i}=t;if(s.type!==bv||"NONE"!==this.closedCaptionsForLevel(s))for(let e=0;e<i.length;e++){const t=i[e].bytes;if(t){const s=this.extractCea608Data(t);n.addData(i[e].pts,s[0]),r.addData(i[e].pts,s[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:n,endOffsetSubtitles:r,type:s}){const{media:i}=this;if(i&&!(i.currentTime<n)){if(!s||"video"===s){const{captionsTracks:e}=this;Object.keys(e).forEach((r=>_v(e[r],t,n)))}if(this.config.renderTextTracksNatively&&0===t&&void 0!==r){const{textTracks:e}=this;Object.keys(e).forEach((n=>_v(e[n],t,r)))}}}extractCea608Data(e){const t=[[],[]],n=31&e[0];let r=2;for(let s=0;s<n;s++){const n=e[r++],s=127&e[r++],i=127&e[r++];if(0===s&&0===i)continue;if(0!=(4&n)){const e=3&n;0!==e&&1!==e||(t[e].push(s),t[e].push(i))}}return t}},audioStreamController:class extends tw{constructor(e,t,n){super(e,t,n,"[audio-stream-controller]",wv),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:e}=this;e.on(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.LEVEL_LOADED,this.onLevelLoaded,this),e.on(Am.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(Am.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(Am.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(Am.ERROR,this.onError,this),e.on(Am.BUFFER_RESET,this.onBufferReset,this),e.on(Am.BUFFER_CREATED,this.onBufferCreated,this),e.on(Am.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(Am.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(Am.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(Am.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(Am.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.LEVEL_LOADED,this.onLevelLoaded,this),e.off(Am.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(Am.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(Am.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(Am.ERROR,this.onError,this),e.off(Am.BUFFER_RESET,this.onBufferReset,this),e.off(Am.BUFFER_CREATED,this.onBufferCreated,this),e.off(Am.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(Am.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(Am.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(e,{frag:t,id:n,initPTS:r,timescale:s}){if("main"===n){const e=t.cc;this.initPTS[t.cc]={baseTime:r,timescale:s},this.log(`InitPTS for cc: ${e} found from main: ${r}`),this.videoTrackCC=e,this.state===Zb&&this.tick()}}startLoad(e){if(!this.levels)return this.startPosition=e,void(this.state=Kb);const t=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),t>0&&-1===e?(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t,this.state=Gb):(this.loadedmetadata=!1,this.state=Wb),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}doTick(){switch(this.state){case Gb:this.doTickIdle();break;case Wb:{var e;const{levels:t,trackId:n}=this,r=null==t||null==(e=t[n])?void 0:e.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=Zb}break}case zb:{var t;const e=performance.now(),n=this.retryDate;(!n||e>=n||null!=(t=this.media)&&t.seeking)&&(this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.trackId),this.state=Gb);break}case Zb:{const e=this.waitingData;if(e){const{frag:t,part:n,cache:r,complete:s}=e;if(void 0!==this.initPTS[t.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=Vb;const e={frag:t,part:n,payload:r.flush(),networkDetails:null};this._handleFragmentLoadProgress(e),s&&super._handleFragmentLoadComplete(e)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${t.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const e=this.getLoadPosition(),n=Lb.bufferInfo(this.mediaBuffer,e,this.config.maxBufferHole);rb(n.end,this.config.maxFragLookUpTolerance,t)<0&&(this.log(`Waiting fragment cc (${t.cc}) @ ${t.start} cancelled because another fragment at ${n.end} is needed`),this.clearWaitingFragment())}}else this.state=Gb}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=Gb)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;null!=e&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){const{hls:e,levels:t,media:n,trackId:r}=this,s=e.config;if(null==t||!t[r])return;if(!n&&(this.startFragRequested||!s.startFragPrefetch))return;const i=t[r],a=i.details;if(!a||a.live&&this.levelLastLoaded!==r||this.waitForCdnTuneIn(a))return void(this.state=Wb);const o=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&o&&(this.bufferFlushed=!1,this.afterBufferFlushed(o,$m,wv));const l=this.getFwdBufferInfo(o,wv);if(null===l)return;const{bufferedTrack:c,switchingTrack:d}=this;if(!d&&this._streamEnded(l,a))return e.trigger(Am.BUFFER_EOS,{type:"audio"}),void(this.state=Xb);const u=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,bv),h=l.len,f=this.getMaxBufferLength(null==u?void 0:u.len);if(h>=f&&!d)return;const p=a.fragments[0].start;let g=l.end;if(d&&n){const e=this.getLoadPosition();c&&d.attrs!==c.attrs&&(g=e),a.PTSKnown&&e<p&&(l.end>p||l.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),n.currentTime=p+.05)}let m=this.getNextFragment(g,a),y=!1;if(m&&this.isLoopLoading(m,g)&&(y=!!m.gap,m=this.getNextFragmentLoopLoading(m,a,l,bv,f)),!m)return void(this.bufferFlushed=!0);const v=u&&m.start>u.end+a.targetduration;if(v||(null==u||!u.len)&&l.len){const e=this.getAppendedFrag(m.start,bv);if(null===e)return;if(y||(y=!!e.gap||!!v&&0===u.len),v&&!y||y&&l.nextStart&&l.nextStart<e.end)return}this.loadFragment(m,i,g)}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.min(Math.max(t,e),this.config.maxMaxBufferLength):t}onMediaDetaching(){this.videoBuffer=null,super.onMediaDetaching()}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map((e=>new qv(e)))}onAudioTrackSwitching(e,t){const n=!!t.url;this.trackId=t.id;const{fragCurrent:r}=this;r&&(r.abortRequests(),this.removeUnbufferedFrags(r.start)),this.resetLoadingState(),n?this.setInterval(100):this.resetTransmuxer(),n?(this.switchingTrack=t,this.state=Gb):(this.switchingTrack=null,this.bufferedTrack=t,this.state=Kb),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(e,t){this.mainDetails=t.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(Am.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(e,t){var n;if(null==this.mainDetails)return void(this.cachedTrackLoadedData=t);const{levels:r}=this,{details:s,id:i}=t;if(!r)return void this.warn(`Audio tracks were reset while loading level ${i}`);this.log(`Track ${i} loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`);const a=r[i];let o=0;if(s.live||null!=(n=a.details)&&n.live){const e=this.mainDetails;if(s.fragments[0]||(s.deltaUpdateFailed=!0),s.deltaUpdateFailed||!e)return;!a.details&&s.hasProgramDateTime&&e.hasProgramDateTime?(Ub(s,e),o=s.fragments[0].start):o=this.alignPlaylists(s,a.details)}a.details=s,this.levelLastLoaded=i,this.startFragRequested||!this.mainDetails&&s.live||this.setStartPosition(a.details,o),this.state!==Wb||this.waitForCdnTuneIn(s)||(this.state=Gb),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:n,part:r,payload:s}=e,{config:i,trackId:a,levels:o}=this;if(!o)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${n.sn} of level ${n.level} will not be buffered`);const l=o[a];if(!l)return void this.warn("Audio track is undefined on fragment load progress");const c=l.details;if(!c)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(n.start);const d=i.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let u=this.transmuxer;u||(u=this.transmuxer=new iS(this.hls,wv,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const h=this.initPTS[n.cc],f=null==(t=n.initSegment)?void 0:t.data;if(void 0!==h){const e=!1,t=r?r.index:-1,i=-1!==t,a=new Db(n.level,n.sn,n.stats.chunkCount,s.byteLength,t,i);u.push(s,f,d,"",n,r,c.totalduration,e,a,h)}else{this.log(`Unknown video PTS for cc ${n.cc}, waiting for video PTS before demuxing audio frag ${n.sn} of [${c.startSN} ,${c.endSN}],track ${a}`);const{cache:e}=this.waitingData=this.waitingData||{frag:n,part:r,cache:new dS,complete:!1};e.push(new Uint8Array(s)),this.waitingVideoCC=this.videoTrackCC,this.state=Zb}}_handleFragmentLoadComplete(e){this.waitingData?this.waitingData.complete=!0:super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(e,t){const n=t.tracks.audio;n&&(this.mediaBuffer=n.buffer||null),t.tracks.video&&(this.videoBuffer=t.tracks.video.buffer||null)}onFragBuffered(e,t){const{frag:n,part:r}=t;if(n.type===wv)if(this.fragContextChanged(n))this.warn(`Fragment ${n.sn}${r?" p: "+r.index:""} of level ${n.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);else{if("initSegment"!==n.sn){this.fragPrevious=n;const e=this.switchingTrack;e&&(this.bufferedTrack=e,this.switchingTrack=null,this.hls.trigger(Am.AUDIO_TRACK_SWITCHED,Tm({},e)))}this.fragBufferedComplete(n,r)}else if(!this.loadedmetadata&&n.type===bv){const e=this.videoBuffer||this.media;if(e){Lb.getBuffered(e).length&&(this.loadedmetadata=!0)}}}onError(e,t){var n;if(t.fatal)this.state=Jb;else switch(t.details){case Rm.FRAG_GAP:case Rm.FRAG_PARSING_ERROR:case Rm.FRAG_DECRYPT_ERROR:case Rm.FRAG_LOAD_ERROR:case Rm.FRAG_LOAD_TIMEOUT:case Rm.KEY_LOAD_ERROR:case Rm.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(wv,t);break;case Rm.AUDIO_TRACK_LOAD_ERROR:case Rm.AUDIO_TRACK_LOAD_TIMEOUT:case Rm.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==Wb||(null==(n=t.context)?void 0:n.type)!==yv||(this.state=Gb);break;case Rm.BUFFER_FULL_ERROR:if(!t.parent||"audio"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case Rm.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}onBufferFlushed(e,{type:t}){t===$m&&(this.bufferFlushed=!0,this.state===Xb&&(this.state=Gb))}_handleTransmuxComplete(e){var t;const n="audio",{hls:r}=this,{remuxResult:s,chunkMeta:i}=e,a=this.getCurrentContext(i);if(!a)return void this.resetWhenMissingContext(i);const{frag:o,part:l,level:c}=a,{details:d}=c,{audio:u,text:h,id3:f,initSegment:p}=s;if(!this.fragContextChanged(o)&&d){if(this.state=Yb,this.switchingTrack&&u&&this.completeAudioSwitch(this.switchingTrack),null!=p&&p.tracks){const e=o.initSegment||o;this._bufferInitSegment(p.tracks,e,i),r.trigger(Am.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:n,tracks:p.tracks})}if(u){const{startPTS:e,endPTS:t,startDTS:n,endDTS:r}=u;l&&(l.elementaryStreams[$m]={startPTS:e,endPTS:t,startDTS:n,endDTS:r}),o.setElementaryStreamInfo($m,e,t,n,r),this.bufferFragmentData(u,o,l,i)}if(null!=f&&null!=(t=f.samples)&&t.length){const e=Im({id:n,frag:o,details:d},f);r.trigger(Am.FRAG_PARSING_METADATA,e)}if(h){const e=Im({id:n,frag:o,details:d},h);r.trigger(Am.FRAG_PARSING_USERDATA,e)}}else this.fragmentTracker.removeFragment(o)}_bufferInitSegment(e,t,n){if(this.state!==Yb)return;e.video&&delete e.video;const r=e.audio;if(!r)return;r.levelCodec=r.codec,r.id="audio",this.log(`Init audio buffer, container:${r.container}, codecs[parsed]=[${r.codec}]`),this.hls.trigger(Am.BUFFER_CODECS,e);const s=r.initSegment;if(null!=s&&s.byteLength){const e={type:"audio",frag:t,part:null,chunkMeta:n,parent:t.type,data:s};this.hls.trigger(Am.BUFFER_APPENDING,e)}this.tick()}loadFragment(e,t,n){const r=this.fragmentTracker.getState(e);var s;(this.fragCurrent=e,this.switchingTrack||r===yb||r===bb)?"initSegment"===e.sn?this._loadInitSegment(e,t):null!=(s=t.details)&&s.live&&!this.initPTS[e.cc]?(this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=Zb):(this.startFragRequested=!0,super.loadFragment(e,t,n)):this.clearTrackerIfNeeded(e)}completeAudioSwitch(e){const{hls:t,media:n,bufferedTrack:r}=this,s=null==r?void 0:r.attrs,i=e.attrs;n&&s&&(s.CHANNELS!==i.CHANNELS||s.NAME!==i.NAME||s.LANGUAGE!==i.LANGUAGE)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio")),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(Am.AUDIO_TRACK_SWITCHED,Tm({},e))}},audioTrackController:class extends hb{constructor(e){super(e,"[audio-track-controller]"),this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Am.LEVEL_LOADING,this.onLevelLoading,this),e.on(Am.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(Am.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(Am.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Am.LEVEL_LOADING,this.onLevelLoading,this),e.off(Am.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(Am.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(Am.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:n,groupId:r,details:s}=t,i=this.tracksInGroup[n];if(!i||i.groupId!==r)return void this.warn(`Track with id:${n} and group:${r} not found in active group ${i.groupId}`);const a=i.details;i.details=t.details,this.log(`audio-track ${n} "${i.name}" lang:${i.lang} group:${r} loaded [${s.startSN}-${s.endSN}]`),n===this.trackId&&this.playlistLoaded(n,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(null==t||!t.audioGroupIds)return;const n=t.audioGroupIds[t.urlId];if(this.groupId!==n){this.groupId=n||null;const e=this.tracks.filter((e=>!n||e.groupId===n));this.selectDefaultTrack&&!e.some((e=>e.default))&&(this.selectDefaultTrack=!1),this.tracksInGroup=e;const t={audioTracks:e};this.log(`Updating audio tracks, ${e.length} track(s) found in group:${n}`),this.hls.trigger(Am.AUDIO_TRACKS_UPDATED,t),this.selectInitialTrack()}else this.shouldReloadPlaylist(this.currentTrack)&&this.setAudioTrack(this.trackId)}onError(e,t){!t.fatal&&t.context&&t.context.type===yv&&t.context.id===this.trackId&&t.context.groupId===this.groupId&&(this.requestScheduled=-1,this.checkRetry(t))}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length)return void this.warn("Invalid id passed to audio-track controller");this.clearTimer();const n=this.currentTrack;t[this.trackId];const r=t[e],{groupId:s,name:i}=r;if(this.log(`Switching to audio-track ${e} "${i}" lang:${r.lang} group:${s}`),this.trackId=e,this.currentTrack=r,this.selectDefaultTrack=!1,this.hls.trigger(Am.AUDIO_TRACK_SWITCHING,Tm({},r)),r.details&&!r.details.live)return;const a=this.switchParams(r.url,null==n?void 0:n.details);this.loadPlaylist(a)}selectInitialTrack(){const e=this.tracksInGroup,t=this.findTrackId(this.currentTrack)|this.findTrackId(null);if(-1!==t)this.setAudioTrack(t);else{const t=new Error(`No track found for running audio group-ID: ${this.groupId} track count: ${e.length}`);this.warn(t.message),this.hls.trigger(Am.ERROR,{type:_m.MEDIA_ERROR,details:Rm.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:t})}}findTrackId(e){const t=this.tracksInGroup;for(let n=0;n<t.length;n++){const r=t[n];if(!this.selectDefaultTrack||r.default){if(!e||void 0!==e.attrs["STABLE-RENDITION-ID"]&&e.attrs["STABLE-RENDITION-ID"]===r.attrs["STABLE-RENDITION-ID"])return r.id;if(e.name===r.name&&e.lang===r.lang)return r.id}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.tracksInGroup[this.trackId];if(this.shouldLoadPlaylist(t)){const n=t.id,r=t.groupId;let s=t.url;if(e)try{s=e.addDirectives(s)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: ${e}`)}this.log(`loading audio-track playlist ${n} "${t.name}" lang:${t.lang} group:${r}`),this.clearTimer(),this.hls.trigger(Am.AUDIO_TRACK_LOADING,{url:s,id:n,groupId:r,deliveryDirectives:e||null})}}},emeController:fC,cmcdController:SC,contentSteeringController:class{constructor(e){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.log=Pm.log.bind(Pm,"[content-steering]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Am.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.on(Am.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(Am.MANIFEST_LOADING,this.onManifestLoading,this),e.off(Am.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(Am.MANIFEST_PARSED,this.onManifestParsed,this),e.off(Am.ERROR,this.onError,this))}startLoad(){if(this.started=!0,self.clearTimeout(this.reloadTimer),this.enabled&&this.uri)if(this.updated){const e=Math.max(1e3*this.timeToLoad-(performance.now()-this.updated),0);this.scheduleRefresh(this.uri,e)}else this.loadSteeringManifest(this.uri)}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),self.clearTimeout(this.reloadTimer)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter((t=>t!==e)))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:n}=t;null!==n&&(this.pathwayId=n.pathwayId,this.uri=n.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:n}=t;if((null==n?void 0:n.action)===ab&&n.flags===cb){let e=this.pathwayPriority;const t=this.pathwayId;this.penalizedPathways[t]||(this.penalizedPathways[t]=performance.now()),!e&&this.levels&&(e=this.levels.reduce(((e,t)=>(-1===e.indexOf(t.pathwayId)&&e.push(t.pathwayId),e)),[])),e&&e.length>1&&(this.updatePathwayPriority(e),n.resolved=this.pathwayId!==t)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(0===t.length){const n=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${n}"`),t=this.getLevelsForPathway(n),this.pathwayId=n}return t.length!==e.length?(this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t):e}getLevelsForPathway(e){return null===this.levels?[]:this.levels.filter((t=>e===t.pathwayId))}updatePathwayPriority(e){let t;this.pathwayPriority=e;const n=this.penalizedPathways,r=performance.now();Object.keys(n).forEach((e=>{r-n[e]>3e5&&delete n[e]}));for(let r=0;r<e.length;r++){const s=e[r];if(n[s])continue;if(s===this.pathwayId)return;const i=this.hls.nextLoadLevel,a=this.hls.levels[i];if(t=this.getLevelsForPathway(s),t.length>0){this.log(`Setting Pathway to "${s}"`),this.pathwayId=s,this.hls.trigger(Am.LEVELS_UPDATED,{levels:t});const e=this.hls.levels[i];a&&e&&this.levels&&(e.attrs["STABLE-VARIANT-ID"]!==a.attrs["STABLE-VARIANT-ID"]&&e.bitrate!==a.bitrate&&this.log(`Unstable Pathways change from bitrate ${a.bitrate} to ${e.bitrate}`),this.hls.nextLoadLevel=i);break}}}clonePathways(e){const t=this.levels;if(!t)return;const n={},r={};e.forEach((e=>{const{ID:s,"BASE-ID":i,"URI-REPLACEMENT":a}=e;if(t.some((e=>e.pathwayId===s)))return;const o=this.getLevelsForPathway(i).map((e=>{const t=Im({},e);t.details=void 0,t.url=TC(e.uri,e.attrs["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",a);const i=new Um(e.attrs);i["PATHWAY-ID"]=s;const o=i.AUDIO&&`${i.AUDIO}_clone_${s}`,l=i.SUBTITLES&&`${i.SUBTITLES}_clone_${s}`;o&&(n[i.AUDIO]=o,i.AUDIO=o),l&&(r[i.SUBTITLES]=l,i.SUBTITLES=l),t.attrs=i;const c=new qv(t);return gb(c,"audio",o),gb(c,"text",l),c}));t.push(...o),CC(this.audioTracks,n,a,s),CC(this.subtitleTracks,r,a,s)}))}loadSteeringManifest(e){const t=this.hls.config,n=t.loader;let r;this.loader&&this.loader.destroy(),this.loader=new n(t);try{r=new self.URL(e)}catch(t){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest URI: ${e}`)}if("data:"!==r.protocol){const e=0|(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate);r.searchParams.set("_HLS_pathway",this.pathwayId),r.searchParams.set("_HLS_throughput",""+e)}const s={responseType:"json",url:r.href},i=t.steeringManifestLoadPolicy.default,a=i.errorRetry||i.timeoutRetry||{},o={loadPolicy:i,timeout:i.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(e,t,n,s)=>{this.log(`Loaded steering manifest: "${r}"`);const i=e.data;if(1!==i.VERSION)return void this.log(`Steering VERSION ${i.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=i.TTL;const{"RELOAD-URI":a,"PATHWAY-CLONES":o,"PATHWAY-PRIORITY":l}=i;if(a)try{this.uri=new self.URL(a,r).href}catch(e){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest RELOAD-URI: ${a}`)}this.scheduleRefresh(this.uri||n.url),o&&this.clonePathways(o),l&&this.updatePathwayPriority(l)},onError:(e,t,n,r)=>{if(this.log(`Error loading steering manifest: ${e.code} ${e.text} (${t.url})`),this.stopLoad(),410===e.code)return this.enabled=!1,void this.log(`Steering manifest ${t.url} no longer available`);let s=1e3*this.timeToLoad;if(429!==e.code)this.scheduleRefresh(this.uri||t.url,s);else{const e=this.loader;if("function"==typeof(null==e?void 0:e.getResponseHeader)){const t=e.getResponseHeader("Retry-After");t&&(s=1e3*parseFloat(t))}this.log(`Steering manifest ${t.url} rate limited`)}},onTimeout:(e,t,n)=>{this.log(`Timeout loading steering manifest (${t.url})`),this.scheduleRefresh(this.uri||t.url)}};this.log(`Requesting steering manifest: ${r}`),this.loader.load(s,o,l)}scheduleRefresh(e,t=1e3*this.timeToLoad){self.clearTimeout(this.reloadTimer),this.reloadTimer=self.setTimeout((()=>{this.loadSteeringManifest(e)}),t)}}});function xC(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(xC):Object.keys(e).reduce(((t,n)=>(t[n]=xC(e[n]),t)),{}):e}function PC(e){const t=e.loader;if(t!==AC&&t!==IC)Pm.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1;else{(function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1})()&&(e.loader=AC,e.progressive=!0,e.enableSoftwareAES=!0,Pm.log("[config]: Progressive streaming enabled, using FetchLoader"))}}class MC{static get version(){return"1.4.10"}static isSupported(){return function(){const e=Jy();if(!e)return!1;const t=nw(),n=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),r=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove;return!!n&&!!r}()}static get Events(){return Am}static get ErrorTypes(){return _m}static get ErrorDetails(){return Rm}static get DefaultConfig(){return MC.defaultConfig?MC.defaultConfig:DC}static set DefaultConfig(e){MC.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new rS,this._autoLevelCapping=void 0,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,function(e,t){if(self.console&&!0===e||"object"==typeof e){xm(e,"debug","log","info","warn","error");try{Dm.log(`Debug logs enabled for "${t}" in hls.js version 1.4.10`)}catch(e){Dm=Lm}}else Dm=Lm}(e.debug||!1,"Hls instance");const t=this.config=function(e,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const n=xC(e),r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach((e=>{const s=`${"level"===e?"playlist":e}LoadPolicy`,i=void 0===t[s],a=[];r.forEach((r=>{const o=`${e}Loading${r}`,l=t[o];if(void 0!==l&&i){a.push(o);const e=n[s].default;switch(t[s]={default:e},r){case"TimeOut":e.maxLoadTimeMs=l,e.maxTimeToFirstByteMs=l;break;case"MaxRetry":e.errorRetry.maxNumRetry=l,e.timeoutRetry.maxNumRetry=l;break;case"RetryDelay":e.errorRetry.retryDelayMs=l,e.timeoutRetry.retryDelayMs=l;break;case"MaxRetryTimeout":e.errorRetry.maxRetryDelayMs=l,e.timeoutRetry.maxRetryDelayMs=l}}})),a.length&&Pm.warn(`hls.js config: "${a.join('", "')}" setting(s) are deprecated, use "${s}": ${JSON.stringify(t[s])}`)})),Tm(Tm({},n),t)}(MC.DefaultConfig,e);this.userConfig=e,this._autoLevelCapping=-1,t.progressive&&PC(t);const{abrController:n,bufferController:r,capLevelController:s,errorController:i,fpsController:a}=t,o=new i(this),l=this.abrController=new n(this),c=this.bufferController=new r(this),d=this.capLevelController=new s(this),u=new a(this),h=new Ev(this),f=new Mv(this),p=t.contentSteeringController,g=p?new p(this):null,m=this.levelController=new pb(this,g),y=new Sb(this),v=new Rb(this.config),b=this.streamController=new oS(this,y,v);d.setStreamController(b),u.setStreamController(b);const w=[h,m,b];g&&w.splice(1,0,g),this.networkControllers=w;const S=[l,c,d,u,f,y];this.audioTrackController=this.createController(t.audioTrackController,w);const C=t.audioStreamController;C&&w.push(new C(this,y,v)),this.subtitleTrackController=this.createController(t.subtitleTrackController,w);const T=t.subtitleStreamController;T&&w.push(new T(this,y,v)),this.createController(t.timelineController,S),v.emeController=this.emeController=this.createController(t.emeController,S),this.cmcdController=this.createController(t.cmcdController,S),this.latencyController=this.createController(Fv,S),this.coreComponents=S,w.push(o);const E=o.onErrorOut;"function"==typeof E&&this.on(Am.ERROR,E,o)}createController(e,t){if(e){const n=new e(this);return t&&t.push(n),n}return null}on(e,t,n=this){this._emitter.on(e,t,n)}once(e,t,n=this){this._emitter.once(e,t,n)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,n=this,r){this._emitter.off(e,t,n,r)}listeners(e){return this._emitter.listeners(e)}emit(e,t,n){return this._emitter.emit(e,t,n)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(t){Pm.error("An internal error happened while handling event "+e+'. Error message: "'+t.message+'". Here is a stacktrace:',t),this.trigger(Am.ERROR,{type:_m.OTHER_ERROR,details:Rm.INTERNAL_EXCEPTION,fatal:!1,event:e,error:t})}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){Pm.log("destroy"),this.trigger(Am.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach((e=>e.destroy())),this.networkControllers.length=0,this.coreComponents.forEach((e=>e.destroy())),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){Pm.log("attachMedia"),this._media=e,this.trigger(Am.MEDIA_ATTACHING,{media:e})}detachMedia(){Pm.log("detachMedia"),this.trigger(Am.MEDIA_DETACHING,void 0),this._media=null}loadSource(e){this.stopLoad();const t=this.media,n=this.url,r=this.url=Sm.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});Pm.log(`loadSource:${r}`),t&&n&&(n!==r||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(Am.MANIFEST_LOADING,{url:e})}startLoad(e=-1){Pm.log(`startLoad(${e})`),this.networkControllers.forEach((t=>{t.startLoad(e)}))}stopLoad(){Pm.log("stopLoad"),this.networkControllers.forEach((e=>{e.stopLoad()}))}swapAudioCodec(){Pm.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){Pm.log("recoverMediaError");const e=this._media;this.detachMedia(),e&&this.attachMedia(e)}removeLevel(e,t=0){this.levelController.removeLevel(e,t)}get levels(){const e=this.levelController.levels;return e||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){Pm.log(`set currentLevel:${e}`),this.loadLevel=e,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){Pm.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){Pm.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){Pm.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){return this.levelController.startLevel}set startLevel(e){Pm.log(`set startLevel:${e}`),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(Pm.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e)}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){Uv.indexOf(e)>-1&&(this._maxHdcpLevel=e)}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const n=e.length;for(let r=0;r<n;r++)if(e[r].maxBitrate>=t)return r;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:n}=this;let r;if(r=-1===t&&e&&e.length?e.length-1:t,n)for(let t=r;t--;){const r=e[t].attrs["HDCP-LEVEL"];if(r&&r<=n)return t}return r}get nextAutoLevel(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)}set nextAutoLevel(e){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,e)}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}MC.defaultConfig=void 0;const FC={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};function UC(e){const t=new Uint8Array(e);let n="";return t.forEach((e=>{n+=String.fromCharCode(e)})),U(n)}function NC(e){const t=e.substring("-----BEGIN PRIVATE KEY-----".length,e.length-"-----END PRIVATE KEY-----".length),n=function(e){const t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let t=0,r=e.length;t<r;t+=1)n[t]=e.charCodeAt(t);return t}(G(t));return crypto.subtle.importKey("pkcs8",n,FC,!1,["sign"])}async function BC({bufferCurrentUsage:e,getActiveStreams:t,updateUsage:n,dispose:r}){const s=e();if(s.length)try{const n=(new Date).toISOString(),i=await async function({timestamp:e,streams:t}){const n=t.map((e=>Object.keys(e).sort().map((t=>`${t}=${e[t]}`)).join("&"))).join(";"),r=Ro.v4(),s=`nonceStr=${r}&timestamp=${e}&data=${n}==`,i=(new TextEncoder).encode(s),a=await NC("-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDHo80SecH7FuF2\nhFYnb+l26/VN8UMLXAQFLnxciNTEwkGVFMpdezlH8rU2HtUJL4RETogbAOLVY0XM\njs6sPn8G1nALmh9qeDpUtVqFOVtBHxEZ910TLOtQiunjqJKO5nWdqZ71EC3OFluR\niGQkO84BiIFbv37ub7xl3S8XarbtKoLcyVpkDHi+1wx1pgCAn6gtBUgckPL5NR8j\nLseabl3HAXQfhTCKo4tmOFM2Dxwl1IUMmIJrJg/aIU/U0tj/1Eoo7mG0JcNWX19l\nW3EecCbi0ncCJOrkUdwlBrcjaMayaX/ubEwyUeTGiLdyc4L3GRLHjyK8xgVNXRMH\nbZWJ2a5NAgMBAAECggEASxuE+35zTFO/XydKgmvIGcWL9FbgMlXb7Vcf0nBoG945\nbiz0NVc2paraIhJXc608xbYF3qLmtAE1MVBI0ORyRdBHNxY024l/6H6SH60Ed+uI\nM4ysp5ourY6Vj+DLwpdRiI9YDjqYAQDIUmhNxJP7XPhOMoZI6st+xZQBM34ic/bv\nAMSJm9OZphSp3+qXVkFZztr2mxD2EZSJJLYxi8BCdgM2qhazalbcJ6zDKHCZWVWm\n8RRxDGldyMb/237JxETzP40tAlzOZDmBAbUgEnurDJ93RVDIE3rbZUshwgeQd18a\nem096mWgvB1AIKYgsTAR3pw+V19YWAjq/glP6fz8wQKBgQD/oQq+ukKF0PRgBeM5\ngeTjSwsdGppQLmf5ndujvoiz/TpdjDEPu6R8kigQr1rG2t4K/yfdZoI8RdmJD1al\n3Q7N9hofooSy4rj6E3txzWZCHJjHad2cnCp/O26HiReGAl7wTcfTmNdiFHhZQzm5\nJBkvWAiwuvQMNfEbnXxw6/vIDwKBgQDH7fX8gsc77JLvAWgp1MaQN/sbqVb6JeT1\nFQfR8E/WFCSmzQBtNzd5KgYuCeelwr/8DyYytvN2BzCYZXp73gI1jF3YlW5jVn74\nOY6TwQ095digwo6Z0yuxopdIOApKgAkL9PRKgNrqAf3NAyMua6lOGifzjDojC3KU\nfylQmxMn4wKBgHp2B9O/H0dEBw5JQ8W0+JX6yWQz7mEjGiR2/1W+XXb8hQ1zr709\nw1r6Gb+EghRpnZ3fBpYGGbYOMFx8wKHM+N6qW3F0ReX8v2juFGE8aRSa5oYBrWzt\nU16Idjbv8hj84cZ1PJmdyvDtpYn9rpWHOZl4rxEbPvbqkIsOMyNVqdT5AoGAOSge\nmwIIU2le2FVeohbibXiToWTYKMuMmURZ5/r72AgKMmWJKbAPe+Q3wBG01/7FRBpQ\noU8Ma0HC8s6QJbliiEyIx9JwrJWd1vkdecBHONrtA4ibm/5zD2WcOllLF+FitLhi\n3qnX6+6F0IaFGFBPJrTzlv0P4dTz/OAdv52V7GECgYEA2TttOKBAqWllgOaZOkql\nLVMJVmgR7s6tLi1+cEP8ZcapV9aRbRzTAKXm4f8AEhtlG9F9kCOvHYCYGi6JaiWJ\nZkHjeex3T+eE6Di6y5Bm/Ift5jtVhJ4jCVwHOKTMej79NPUFTJfv8hCo29haBDv6\nRXFrv+T21KCcw8k3sJeJWWQ=\n-----END PRIVATE KEY-----");return{signature:UC(await crypto.subtle.sign(FC,a,i)),nonceStr:r}}({timestamp:n,streams:s});if(!i||!i.signature)throw new Error("Signature is undefined");const a={signature:i.signature,nonceStr:i.nonceStr,timestamp:n,streams:s},o=ve();return await o.http.post("/api/v3/user-event/video-streaming",a),t().length||e().length||r(),!0}catch(e){return s.forEach((e=>n(e))),!1}}class jC{constructor(){this._unsyncedData=[],this._syncBuffer=[],this._activeStreams=[],this._startInterval(),this._syncInterval=null}registerStream(e){this._activeStreams.push(e)}getActiveStreams(){return this._activeStreams}unregisterStream(e){this._activeStreams=this._activeStreams.filter((t=>t!==e))}updateUsage(e){this._unsyncedData.push(e)}bufferCurrentUsage(){const e=this._unsyncedData;return this._unsyncedData=[],e}dispose(){this._syncInterval&&clearInterval(this._syncInterval)}_startInterval(){this._syncInterval=setInterval((()=>{BC({bufferCurrentUsage:this.bufferCurrentUsage.bind(this),getActiveStreams:this.getActiveStreams.bind(this),updateUsage:this.updateUsage.bind(this),dispose:this.dispose.bind(this)})}),2e4)}}let $C=null;class qC{constructor(e,t){this.player=e,this.resolution=t,this._startTime=null,this._usageCollector=$C||($C=new jC,$C),this._usageCollector.registerStream(e.id),this._sessionId=String(Ro.v4()),this._controller=new AbortController,this._observer=new MutationObserver((t=>{t.forEach((t=>{t.removedNodes.forEach((t=>{t===e&&this._unregisterEvents()}))}))}))}_resetStartTime(){this._startTime=Date.now()}_shouldUpdateCollector(){return!!this._startTime&&Date.now()-this._startTime>2e4}_sendUsageToCollector(){if(!this._startTime)return;const e=Date.now(),t=e-this._startTime,n=Math.round(t/1e3);n&&this._usageCollector.updateUsage({streamId:this.player.id,sessionId:this._sessionId,startTime:this._startTime?new Date(this._startTime).toISOString():null,endTime:new Date(e).toISOString(),watchSeconds:n,resolution:this.resolution})}registerEvents(){this.player.addEventListener("play",(()=>{this._startTime||this._resetStartTime()}),{signal:this._controller.signal}),this.player.addEventListener("playing",(()=>{this._startTime||this._resetStartTime()}),{signal:this._controller.signal}),this.player.addEventListener("timeupdate",(()=>{this._shouldUpdateCollector()&&(this._sendUsageToCollector(),this._resetStartTime())}),{signal:this._controller.signal}),this.player.addEventListener("pause",(()=>{this._sendUsageToCollector(),this._startTime=null}),{signal:this._controller.signal}),this.player.addEventListener("ended",(()=>{this._sendUsageToCollector(),this._startTime=null}),{signal:this._controller.signal})}_unregisterEvents(){this._usageCollector.unregisterStream(this.player.id),this._controller.abort(),this._observer.disconnect()}}var KC=Object.freeze({__proto__:null,getPlayer:async e=>{const{streamId:t}=e;if(!document)throw new Error("This method can be invoked within the browser enviornment only");if(!MC.isSupported())throw new Error("This browswer does not support hls, unable to play stream");const{data:n}=await sm(t),{watcherUrl:r,status:s,recordings:i=[],resolution:a}=n;if(!r.hls)throw new Error("This stream does not support hls. Unable to play");const o=document.createElement("video");o.id=t,o.controls=!0;const l=new MC;if(l.attachMedia(o),"recorded"!==s){let{url:e}=r.hls;e=e.replace("http:","https:"),l.loadSource(e)}else{const e=i.find((e=>!!e.mp4));if(!e||!e.mp4)throw new Error("No playable recording available");o.src=e.mp4.url}return new qC(o,a).registerEvents(),o}});const GC=e=>{const t=(e=>{var t;const n=ve(),r=new Date,s=r.getTime()+31536e6,i=new Date(s).toISOString();let a=null===(t=Se(["storyTarget","get",e.targetId]))||void 0===t?void 0:t.data;return a||(a={targetType:e.targetType,targetId:e.targetId,lastStoryExpiresAt:i,targetPublicId:e.targetId,targetUpdatedAt:r.toISOString()},Uo({storyTargets:[a]})),{stories:[Object.assign({createdAt:r.toISOString(),updatedAt:r.toISOString(),flagCount:0,hashFlag:null,reactions:{},reactionsCount:0,storyId:e.referenceId,path:"",creatorId:n.userId||"",creatorPublicId:n.userId||"",targetPublicId:e.targetId,comments:[],commentsCount:0,isDeleted:!1,hasFlaggedComment:!1,mentionedUsers:[],impression:0,reach:0,expiresAt:new Date(s).toISOString()},e)],categories:[],communityUsers:[],comments:[],files:[],users:[],communities:[]}})(e);return Uo(t),t},HC=({payload:e,formData:t,isVideo:n=!1},r)=>{if(t){const s=t.getAll("files")[0]||void 0;if(!s)return;const i=new FileReader;i.readAsDataURL(s),i.onload=()=>r(GC(n?Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{fileId:void 0,videoFileId:{original:void 0},fileData:null==i?void 0:i.result})}):Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{fileId:void 0,fileData:null==i?void 0:i.result})})))}return r(GC(Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{fileData:null})})))},VC=async e=>{const t=ve();t.log("post/createStory",e);const n=await t.http.post("/api/v4/stories",e),r=Eg(n.data);t.cache&&Uo(r),Ce(["story-sync-state",e.targetId],"synced"),Je("local.story.created",r);const s=t.cache&&Date.now();return{data:r.stories.length>0?r.stories[0]:void 0,cachedAt:s}},zC=async({targetId:e,targetType:t})=>{var n,r;if(!Se(["storyTarget","get",e])){let s={targetId:e,targetType:t};if("community"===t){const t=await fp(e);s=Object.assign(Object.assign({},s),{targetPublicId:t.data.communityId,targetUpdatedAt:null!==(n=t.data.updatedAt)&&void 0!==n?n:(new Date).toISOString()})}if("user"===t){const t=await th(e);s=Object.assign(Object.assign({},s),{targetPublicId:t.data.userPublicId,targetUpdatedAt:null!==(r=t.data.updatedAt)&&void 0!==r?r:(new Date).toISOString()})}Ce(["storyTarget","get",e],s)}},WC=e=>e?Se(["story","get",e]):{data:void 0,cachedAt:void 0},YC=async(e,t=!1)=>{var n,r,s;const i=ve();let a;if(i.log("story/deleteStory",e),i.cache&&(a=WC(e),null==a?void 0:a.data)){const{data:i}=a;if(Je("local.story.deleted",{categories:[],comments:[],communities:[],communityUsers:[],files:[],users:[],stories:[Object.assign(Object.assign({},i),{isDeleted:!0})]}),"synced"!==i.syncState){t?Ie(["story","get",e]):Ce(["story","get",e],Object.assign(Object.assign({},a.data),{isDeleted:!0}));const r=null===(n=we(["story","get"]))||void 0===n?void 0:n.filter((e=>"synced"!==e.data.syncState&&e.data.targetId===i.targetId&&!0!==e.data.isDeleted));if(r&&r.length>0){const e=r.reduce(((e,t)=>{const n=new Date(t.data.expiresAt||0);return n>e?n:e}),new Date(0));Ce(["story-expire",a.data.targetId],e.toISOString())}else Ie(["story-expire",a.data.targetId]);return!0}const o=null===(r=Se(["storyTarget","get",i.targetId]))||void 0===r?void 0:r.data,l=null===(s=we(["story","get"]))||void 0===s?void 0:s.filter((e=>"synced"===e.data.syncState&&e.data.targetId===i.targetId&&!0!==e.data.isDeleted));let c;l&&l.length>0&&(c=null==l?void 0:l.reduce(((e,t)=>{const n=new Date(t.data.expiresAt||0);return n>e?n:e}),new Date(0))),o&&Ce(["storyTarget","get",i.targetId],Object.assign(Object.assign({},o),{lastStoryExpiresAt:c}))}return(await i.http.delete(`/api/v4/stories/${e}`,{params:{permanent:t}})).data.success},QC=e=>{const t=ve(),n=[Xe(t,"onStoryUpdated","story.updated",(async t=>{const n=Eg(t);Uo(n),e(n.stories)}))];return()=>{n.forEach((e=>e()))}},XC=e=>{const t=ve(),n=[Xe(t,"onStoryUpdated","local.story.updated",(async t=>{Uo(t),e(t.stories)}))];return()=>{n.forEach((e=>e()))}},JC=e=>{const t=ve(),n=[Xe(t,"onStoryReactionAdded","story.reactionAdded",(async t=>{const{reactions:n}=t,r=Bo(t,["reactions"]),s=Eg(r),i=Dh("story.reactionAdded",Object.assign(Object.assign({},s),{reactions:n}));Uo(i),e(i.stories)}))];return()=>{n.forEach((e=>e()))}},ZC=e=>{const t=ve(),n=[Xe(t,"onStoryReactionAdded","local.story.reactionAdded",(async t=>{Uo({stories:[t.story]}),e([t.story])}))];return()=>{n.forEach((e=>e()))}},eT=e=>{const t=ve(),n=[Xe(t,"onStoryReactionRemoved","story.reactionRemoved",(async t=>{const{reactions:n}=t,r=Bo(t,["reactions"]),s=Eg(r),i=Dh("story.reactionRemoved",Object.assign(Object.assign({},s),{reactions:n}));Uo(i),e(i.stories)}))];return()=>{n.forEach((e=>e()))}},tT=e=>{const t=ve(),n=[Xe(t,"onStoryReactionRemoved","local.story.reactionRemoved",(async t=>{Uo({stories:[t.story]}),e([t.story])}))];return()=>{n.forEach((e=>e()))}},nT=e=>{e.forEach((e=>{const t=Se(["story-expire",e.targetId]),n=new Date(e.expiresAt||0);n<new Date((null==t?void 0:t.data)||0)||Ce(["story-expire",e.targetId],n.toISOString())}))},rT=e=>{e.forEach((e=>{Ce(["story-reference",e.storyId],e.referenceId)}))},sT=async({targetType:e,targetId:t,options:n})=>{const r=ve();r.log("story/getActiveStoriesByTarget");const s=r.cache&&Date.now(),i=await r.http.get("/api/v4/stories",{params:{targetType:e,targetId:t,options:{sortBy:(null==n?void 0:n.sortBy)||"createdAt",orderBy:(null==n?void 0:n.orderBy)||"desc"}}}),a=Eg(i.data);return r.cache&&(Uo(a),nT(a.stories),rT(a.stories)),{data:a.stories,cachedAt:s,paging:{next:void 0,previous:void 0}}},iT=e=>{const t=ve(),n=[Xe(t,"onStoryCreated","story.created",(async t=>{const n=Eg(t,!0);Uo(n),e(n.stories)}))];return()=>{n.forEach((e=>e()))}},aT=e=>{const t=ve(),n=[Xe(t,"onStoryCreated","local.story.created",(async t=>{Uo(t),e(t.stories)}))];return()=>{n.forEach((e=>e()))}},oT=e=>{const t=ve(),n=[Xe(t,"onStoryDeleted","story.deleted",(async t=>{const n=Eg(t);Uo(n),e(n.stories)}))];return()=>{n.forEach((e=>e()))}},lT=e=>{const t=ve(),n=[Xe(t,"onStoryDeleted","local.story.deleted",(async t=>{Uo(t),e(t.stories)}))];return()=>{n.forEach((e=>e()))}},cT=e=>{const t=ve();return Xe(t,"onStoryError","local.story.error",(async t=>{Uo(t),e(t.stories)}))},dT=e=>t=>e((e=>t(e[0]))),uT=async e=>{const t=ve();t.log("story/getTargetsByTargetIds",e);const n=await t.http.get("/api/v4/stories/seen",{params:{targets:e}}),{data:r}=n;return t.cache&&Uo(n.data),{data:r.storyTargets,cachedAt:Date.now()}};class hT extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.paginationController=r}saveToMainDB(e){const t=ve(),n=t.cache&&Date.now(),r=Eg(e);t.cache&&(Uo(r,{cachedAt:n}),nT(r.stories),rT(r.stories))}getStoryReferenceIds(e){return(null==e?void 0:e.referenceId)?e.referenceId:e.storyId}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.stories.map(this.getStoryReferenceIds)});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.stories.map(this.getStoryReferenceIds)])]}))}}reactor(e){return e=>{var t;const n=null===(t=Se(this.cacheKey))||void 0===t?void 0:t.data;if(!n)return;const r=e.map((({referenceId:e})=>e));n.data=[...new Set([...r,...n.data])],Ce(this.cacheKey,n),this.notifyChange({origin:"event",loading:!1})}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}class fT extends Bu{async getRequest(e){const{data:t}=await this.http.get("/api/v4/stories-by-targets",{params:Object.assign({},e)});return t}}class pT extends ju{constructor(e,t){const n=Pu(e),r=["story-target-ids","collection",n],s=new fT(e);super(s,n,r,t),this.query=e,this.queryStreamController=new hT(this.query,this.cacheKey,this.notifyChange.bind(this),s),this.paginationController=s,this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}persistModel(e){this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}notifyChange({origin:e,loading:t,error:n}){var r;const s=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!s)return;let i=s.data.map((e=>Se(["story","get",e]))).filter(Boolean).map((e=>yl.story(e.data)));(this.shouldNotify(i)||"event"!==e)&&(i=this.applyFilter(i),this.callback({onNextPage:void 0,data:i,hasNextPage:!1,loading:t,error:n}))}applyFilter(e){var t,n;const r=e;return"asc"===((null===(n=null===(t=this.query)||void 0===t?void 0:t.options)||void 0===n?void 0:n.orderBy)||"desc")?r.sort(Fe):r.sort(Ne)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:iT,action:"onCreate"},{fn:QC,action:"onUpdate"},{fn:oT,action:"onDelete"},{fn:cT,action:"onError"}])}}const gT=(e,t)=>{var n,r;const s=null===(n=Se(e))||void 0===n?void 0:n.data,i=null!==(r=null==s?void 0:s.data)&&void 0!==r?r:[];Ce(e,Object.assign(Object.assign({},s),{data:[...new Set([...i,...t])]}))};class mT extends Uu{constructor(e,t,n,r,s){super(e,t),this.notifyChange=n,this.paginationController=r,this.preparePayload=s}saveToMainDB(e){const t=ve(),n=t.cache&&Date.now(),r=this.preparePayload(e);t.cache&&Uo(r,{cachedAt:n})}appendToQueryStream(e,t,n=!1){n?Ce(this.cacheKey,{data:e.storyTargets.map((({targetId:e})=>e))}):gT(this.cacheKey,e.storyTargets.map((({targetId:e})=>e)))}reactor(e){return t=>{"onCreate"===e&&"seen"!==this.query.seenState&&gT(this.cacheKey,t.map((({targetId:e})=>e))),this.notifyChange({origin:"event",loading:!1})}}subscribeRTE(e){return e.map((e=>e.fn(this.reactor(e.action))))}}class yT extends Mu{constructor(){super(...arguments),this.smartFilterState="unseen"}async getRequest(e,t){var n;const{limit:r=10,seenState:s="unseen"}=e,i=await this.createRequest({seenState:"smart"===s?this.smartFilterState:s,limit:r,token:t});if(null===(n=i.paging)||void 0===n?void 0:n.next)return i;if("smart"!==s)return i;if("seen"===this.smartFilterState)return i;this.smartFilterState="seen";const a=await this.createRequest({seenState:this.smartFilterState,limit:r});return l=a,{categories:(o=i).categories.concat(l.categories),communities:o.communities.concat(l.communities),communityUsers:o.communityUsers.concat(l.communityUsers),files:o.files.concat(l.files),storyTargets:o.storyTargets.concat(l.storyTargets),users:o.users.concat(l.users),paging:l.paging};var o,l}async createRequest(e){const{data:t}=await this.http.get("/api/v5/me/global-story-targets",{params:e});return n=t,r=e.seenState,Object.assign(Object.assign({},n),{storyTargets:n.storyTargets.map((e=>Object.assign(Object.assign({},e),{localFilter:r})))||[]});var n,r}}class vT extends ju{constructor(e,t){const n=Pu(e),r=["story-global-feed","collection",n],s=new yT(e);super(s,n,r,t),this.query=e,this.queryStreamController=new mT(this.query,this.cacheKey,this.notifyChange.bind(this),s,(e=>{const t=Bo(Uh(Object.assign(Object.assign({},e),{feeds:[]})),["feeds"]);return Object.assign(Object.assign({},e),t)})),this.paginationController=s,this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}persistModel(e){this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}notifyChange({origin:e,loading:t,error:n}){var r;const s=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!s)return;const i=s.data,a=we(["storyTarget"]);a&&(null==a?void 0:a.length)>0&&(null==a||a.forEach((({key:e})=>{s.data.includes(e[2])||i.push(e[2])})));let o=i.map((e=>Se(["storyTarget","get",e]))).filter(Boolean).map((e=>yl.storyTarget(e.data)));(this.shouldNotify(o)||"event"!==e)&&(o=this.applyFilter(o).filter((({localSortingDate:e})=>!!e)).map((e=>Bo(e,["localFilter","localLastExpires","localLastSeen","localSortingDate"]))),this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:o,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n}))}applyFilter(e){if("smart"!==this.query.seenState)return e.filter((({hasUnseen:e})=>"all"===this.query.seenState||("seen"===this.query.seenState&&!e||"unseen"===this.query.seenState&&e))).sort(Ue);const t=e.reduce(((e,t)=>("unseen"===t.localFilter?e.unseen.push(t):"seen"===t.localFilter?e.seen.push(t):e.unknown.push(t),e)),{unseen:[],seen:[],unknown:[]}),n=t.unknown.sort(Ue)||[],r=t.unseen.sort(Ue)||[],s=t.seen.sort(Ue)||[];return n.concat(r,s)}startSubscription(){return this.queryStreamController.subscribeRTE([{fn:iT,action:"onCreate"},{fn:QC,action:"onUpdate"},{fn:oT,action:"onDelete"},{fn:aT,action:"onCreate"},{fn:XC,action:"onUpdate"},{fn:lT,action:"onDelete"},{fn:cT,action:"onError"}])}}var bT=Object.freeze({__proto__:null,createImageStory:async(e,t,n,r={},s="fit",i=[])=>{if(!n.getAll("files").length)throw new Error("The formData object must have a `files` key.");let a={data:{text:"",fileId:void 0,fileData:null,imageDisplayMode:s},syncState:"syncing",referenceId:Oo(),dataType:"image",items:i,targetType:e,targetId:t,metadata:r};const o=new Date;Ce(["story-sync-state",t],"syncing"),Ce(["story-expire",t],new Date(o.setFullYear(o.getFullYear()+1))),HC({payload:a,formData:n},(e=>{Je("local.story.created",e)}));try{const{data:r}=await bh(n);if(0===r.length)throw new Error("Failed to upload image");const{fileId:s}=r[0];a=Object.assign(Object.assign({},a),{data:Object.assign(Object.assign({},a.data),{fileId:s})}),zC({targetId:t,targetType:e}),HC({payload:a,formData:n},(e=>{Je("local.story.created",e)}));const i=await VC(a);return i.data?Object.assign(Object.assign({},i),{data:yl.story(i.data)}):i}catch(e){throw Ce(["story-sync-state",t],"error"),HC({payload:Object.assign(Object.assign({},a),{syncState:"error"}),formData:n},(e=>{Je("local.story.error",e)})),e}},createVideoStory:async(e,t,n,r={},s=[])=>{if(!n.getAll("files").length)throw new Error("The formData object must have a `files` key.");let i={data:{text:"",fileId:void 0,fileData:null},syncState:"syncing",referenceId:Oo(),dataType:"video",items:s,targetType:e,targetId:t,metadata:r};const a=new Date;Ce(["story-sync-state",t],"syncing"),Ce(["story-expire",t],new Date(a.setFullYear(a.getFullYear()+1))),zC({targetId:t,targetType:e}),HC({payload:i,formData:n,isVideo:!0},(e=>{Je("local.story.created",e)}));try{const{data:e}=await vh(n,c.STORY);if(0===e.length)throw new Error("Failed to upload video");const{fileId:t}=e[0];i=Object.assign(Object.assign({},i),{data:Object.assign(Object.assign({},i.data),{fileId:t,videoFileId:{original:t}})}),HC({payload:i,formData:n,isVideo:!0},(e=>{Je("local.story.created",e)}));const r=await VC(i);return r.data?Object.assign(Object.assign({},r),{data:yl.story(r.data)}):r}catch(e){throw Ce(["story-sync-state",t],"error"),HC({payload:Object.assign(Object.assign({},i),{syncState:"error"}),formData:n,isVideo:!0},(e=>{Je("local.story.error",e)})),e}},hardDeleteStory:async e=>await YC(e,!0),softDeleteStory:async e=>await YC(e),getActiveStoriesByTarget:(e,t)=>{const{log:n,cache:r}=ve(),s=[],i=["story-target","collection",e],a=Date.now();n(`getActiveStoriesByTarget(tmpid: ${a}) > listen`),r||console.log(g);const o=t=>{var n,r;const s=(null===(n=e.options)||void 0===n?void 0:n.sortBy)||"createdAt",i=(null===(r=e.options)||void 0===r?void 0:r.orderBy)||"desc";return 0===t.length?[]:"createdAt"===s?"asc"===i?t.sort(Fe):t.sort(Ne):"asc"===i?t.sort(Be):t.sort(je)},l=e=>{var n;const r=e.data.map((e=>{const t=WC(e);if(null==t?void 0:t.data)return yl.story(t.data)})).filter(Boolean).filter((e=>!!e&&!e.isDeleted)),s=[];if(r.length>0){const e=r.reduce(((e,t)=>{if(!t)return e;const{syncState:n}=t;if(!n)return e;let r=e.get(n);return r||(r=[]),r.push(t),e.set(n,r),e}),new Map);if(e.has("error")){const t=o(e.get("error")||[]);s.push(...t)}if(e.has("syncing")){const t=o(e.get("syncing")||[]);s.push(...t)}if(e.has("synced")){const t=o(e.get("synced")||[]);s.push(...t)}}t({onNextPage:()=>!1,data:s||r,hasNextPage:!!(null===(n=e.params)||void 0===n?void 0:n.page),loading:e.loading||!1})},c=(t,n,r=!1,s=!1,a=!1)=>{var o;const c=Se(i),d={loading:s,error:a,params:{page:void 0},data:(null==c?void 0:c.data)||[]};if(t)if("onDelete"===n){const e=t.map((({referenceId:e})=>e));d.data=d.data.filter((t=>!e.includes(t)))||[]}else d.data=r?t.map(de("story")):[...new Set([...d.data,...t.map(de("story"))])];const u=null===(o=we(["story","get"]))||void 0===o?void 0:o.filter((t=>t.data.targetId===e.targetId&&"synced"!==t.data.syncState)).map((e=>de("story")(e.data)));u&&(null==u?void 0:u.length)>0&&u.forEach((e=>{d.data.includes(e)||d.data.push(e)})),Ce(i,d.data),l(d)},d=e=>t=>{c(t,e)};return(t=>{const n=ie(sT,e);oe(n,(({data:e,error:n,loading:r})=>{c(e,"fetch",t,r,n)}))})(!0),s.push(iT(d("onCreate")),QC(d("onUpdate")),oT(d("onDelete")),JC(d("onReactionAdded")),eT(d("onReactionRemoved")),cT(d("onError")),aT(d("onCreate")),XC(d("onUpdate")),lT(d("onDelete")),ZC(d("onReactionAdded")),tT(d("onReactionRemoved")),(e=>{const t=ve();return Xe(t,"onStoryLocalDataUpdated","local.story.reload",(t=>{e(t)}))})((e=>{const t=Se(i);if(!t)return;if(0===e.referenceIds.length||0===(null==t?void 0:t.data.length))return;if(!(null==t?void 0:t.data.find((t=>e.referenceIds.includes(t)))))return;const n={loading:!1,error:!1,params:{page:void 0},data:(null==t?void 0:t.data)||[]};l(n)})),(()=>Ie(i))),()=>{n(`getActiveStoriesByTarget(tmpid: ${a}) > dispose`),s.forEach((e=>e()))}},getStoryByStoryId:(e,t)=>zu(e,(e=>{(null==e?void 0:e.data)?t(Object.assign(Object.assign({},e),{data:yl.story(e.data)})):t(e)}),"storyId",Ig,[dT(QC),dT(oT),dT(JC),dT(eT),dT(cT),dT(XC),dT(lT),dT(ZC),dT(tT)]),getTargetById:(e,t)=>zu(e,(e=>{(null==e?void 0:e.data)?t(Object.assign(Object.assign({},e),{data:yl.storyTarget(e.data[0])})):t(e)}),"query",(e=>uT([e])),[]),getTargetsByTargetIds:(e,t)=>{const{log:n,cache:r}=ve(),s=[],i=["storyTargets","collection",e],a=Date.now();n(`getTargetsByTargetIds(tmpid: ${a}) > listen`),r||console.log(g);const o=(e,n=!1,r=!1,s=!1)=>{const a=Se(i),o={loading:r,error:s,params:{page:void 0},data:[]};e&&(o.data=n?e.map(de("storyTarget")):[...new Set([...(null==a?void 0:a.data)||[],...e.map(de("storyTarget"))])]),Ce(i,o.data),(e=>{var n;const r=e.data.map((e=>{const t=Se(["storyTarget","get",e]);if(null==t?void 0:t.data)return yl.storyTarget(t.data)})).filter(Boolean);t({onNextPage:void 0,data:r,hasNextPage:!!(null===(n=e.params)||void 0===n?void 0:n.page),loading:e.loading||!1})})(o)};return(t=>{const n=ie(uT,e);oe(n,(({data:e,error:n,loading:r})=>{o(e,t,r,n)}))})(!0),s.push((()=>Ie(i))),()=>{n(`getTargetsByTargetIds(tmpid: ${a}) > dispose`),s.forEach((e=>e()))}},getStoriesByTargetIds:(e,t,n)=>{const{log:r,cache:s,userId:i}=ve();s||console.log(g);const a=Date.now();r(`getStoriesByTargetIds(tmpid: ${a}) > listen`);const o=new pT(e,t),l=o.startSubscription(),c=o.getCacheKey();return l.push((()=>{Ie(c)})),()=>{r(`getStoriesByTargetIds(tmpid: ${a}) > dispose`),l.forEach((e=>e()))}},getGlobalStoryTargets:(e,t,n)=>{const{log:r,cache:s,userId:i}=ve();s||console.log(g);const a=Date.now();r(`getGlobalStoryTarget(tmpid: ${a}) > listen`);const o=new vT(e,t),l=o.startSubscription(),c=o.getCacheKey();return l.push((()=>{Ie(c)})),()=>{r(`getGlobalStoryTarget(tmpid: ${a}) > dispose`),l.forEach((e=>e()))}}});const wT=e=>Object.assign(Object.assign({},e),{endAt:e.endAt?e.endAt:null}),ST=e=>Object.assign({},e);var CT=Object.freeze({__proto__:null,getNetworkAds:async()=>{const e=ve(),{data:t}=await e.http.get("/api/v1/ads/me"),n=t.ads.map(wT),r=t.advertisers.map(ST);return Uo({ads:n,advertisers:r,files:t.files}),Ce(["ad","setting"],t.settings),{ads:n.map(yl.ad),settings:t.settings}}});const TT=async()=>{const e=ve();e.log("notificationTray/getNotificationTraySeen",{});const{data:t}=await e.http.get("api/v1/notification-tray/tray/seen"),n=e.cache&&Date.now();if(e.cache){const n=["notificationTraySeen","get",e.userId];Ce(n,{userId:e.userId,lastTraySeenAt:t.lastTraySeenAt,lastTrayOccuredAt:t.lastTrayOccurredAt})}return{data:{userId:e.userId,lastTraySeenAt:t.lastTraySeenAt,lastTrayOccurredAt:t.lastTrayOccurredAt,isSeen:t.lastTraySeenAt>t.lastTrayOccurredAt},cachedAt:n}};TT.locally=()=>{var e;const t=ve();if(t.log("notificationTray/getNotificationTraySeen.locally",{}),!t.cache)return;const{data:n,cachedAt:r}=null!==(e=Se(["notificationTraySeen","get"]))&&void 0!==e?e:{};return n?{data:n,cachedAt:r}:void 0};const ET=e=>{const t=ve(),n=[Xe(t,"onNotificationTraySeenUpdated","local.notificationTraySeen.updated",(t=>e(t)))];return()=>{n.forEach((e=>e()))}};class IT extends Mu{async getRequest(e,t){const{limit:n=f}=e,r=Bo(e,["limit"]),s=t?{token:t}:{limit:n},{data:i}=await this.http.get("/api/v1/notification-tray",{params:Object.assign(Object.assign({},r),{options:s})});return i}}class kT extends Uu{constructor(e,t,n,r){super(e,t),this.notifyChange=n,this.preparePayload=r}async saveToMainDB(e){const t=await this.preparePayload(e),n=ve(),r=n.cache&&Date.now();n.cache&&Uo(t,{cachedAt:r})}appendToQueryStream(e,t,n=!1){var r,s;if(n)Ce(this.cacheKey,{data:e.notificationTrayItems.map(de("notificationTrayItem"))});else{const t=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data,n=null!==(s=null==t?void 0:t.data)&&void 0!==s?s:[];Ce(this.cacheKey,Object.assign(Object.assign({},t),{data:[...new Set([...n,...e.notificationTrayItems.map(de("notificationTrayItem"))])]}))}}}const AT=e=>{const t=e.users.map(zl);return Object.assign(Object.assign({},e),{users:t})};class _T extends ju{constructor(e,t){const n=Pu(e),r=["notificationTrayItem","collection",n];super(new IT(e),n,r,t),this.query=e,this.queryStreamController=new kT(this.query,this.cacheKey,this.notifyChange.bind(this),AT),this.callback=t.bind(this),this.loadPage({initial:!0})}setup(){var e;(null===(e=Se(this.cacheKey))||void 0===e?void 0:e.data)||Ce(this.cacheKey,{data:[],params:{}})}async persistModel(e){await this.queryStreamController.saveToMainDB(e)}persistQueryStream({response:e,direction:t,refresh:n}){this.queryStreamController.appendToQueryStream(e,t,n)}startSubscription(){return[]}notifyChange({origin:e,loading:t,error:n}){var r,s;const i=null===(r=Se(this.cacheKey))||void 0===r?void 0:r.data;if(!i)return;const a=(null!==(s=i.data.map((e=>Se(["notificationTrayItem","get",e]))).filter(sl).map((({data:e})=>e)))&&void 0!==s?s:[]).map(yl.notificationTray);(this.shouldNotify(a)||"event"!==e)&&this.callback({onNextPage:()=>this.loadPage({direction:"next"}),data:a,hasNextPage:!!this.paginationController.getNextToken(),loading:t,error:n})}}var RT=Object.freeze({__proto__:null,getNotificationTraySeen:e=>{const{userId:t}=Ke();return zu(t,e,"userId",TT,[ET],{callbackDataSelector:e=>{let t=!0;return(null==e?void 0:e.lastTrayOccurredAt)&&(t=!!e.lastTraySeenAt&&jl(e.lastTraySeenAt)>jl(e.lastTrayOccurredAt)),{lastTrayOccurredAt:null==e?void 0:e.lastTrayOccurredAt,lastTraySeenAt:null==e?void 0:e.lastTraySeenAt,isSeen:t}}})},getNotificationTrayItems:(e,t,n)=>{const{log:r,cache:s}=ve();s||console.log(g);const i=Date.now();r(`getNotificationTrayItems(tmpid: ${i}) > listen`);const a=new _T(e,t),o=a.startSubscription(),l=a.getCacheKey();return o.push((()=>Ie(l))),()=>{r(`getNotificationTrayItems(tmpid: ${i}) > dispose`),o.forEach((e=>e()))}},markItemsSeen:async e=>{const t=ve();t.log("notificationTray/markItemsSeen",{});const{data:n}=await t.http.post("api/v1/notification-tray/items/seen",{trayItems:e.map((e=>({id:e.id,lastSeenAt:e.lastSeenAt})))}),r=n.trayItems.map((e=>{var n;const r=null===(n=Se(["notificationTrayItem","get",e.id]))||void 0===n?void 0:n.data;if(!r)return;const s=Object.assign(Object.assign({},r),{lastSeenAt:e.lastSeenAt});if(t.cache){const e=Date.now();Ce(["notificationTrayItem","get"],s,{cachedAt:e})}return s})).filter(Boolean);Je("local.notificationTrayItem.updated",{notificationTrayItems:r})},markTraySeen:async e=>{var t;const n=ve();n.log("notificationTray/markTraySeen",{});const{data:r}=await n.http.post("api/v1/notification-tray/tray/seen",{lastSeenAt:e}),s=null===(t=Se(["notificationTraySeen","get"]))||void 0===t?void 0:t.data,i={userId:n.userId,lastTraySeenAt:r.lastSeenAt},a=Object.assign(Object.assign({},s),i),o=n.cache&&Date.now();return n.cache&&Ce(["notificationTraySeen","get",n.userId],a,{cachedAt:o}),Je("local.notificationTraySeen.updated",i),{data:r,cachedAt:o}},onNotificationTraySeenUpdated:ET});return e.API_REGIONS=At,e.AdRepository=CT,e.CategoryRepository=yg,e.ChannelRepository=dp,e.Client=hu,e.CommentRepository=Fg,e.CommunityPostSettingMaps=o,e.CommunityPostSettings=a,e.CommunityRepository=pg,e.ContentFeedType=c,e.DefaultCommunityPostSetting=l,e.FeedRepository=wg,e.FileRepository=wh,e.FileType=t,e.LiveStreamPlayer=KC,e.MessageContentType=d,e.MessageRepository=qf,e.PollRepository=vm,e.PostContentType=u,e.PostRepository=rm,e.ReactionRepository=gf,e.StoryRepository=bT,e.StreamRepository=pm,e.SubChannelRepository=Yf,e.UserRepository=mh,e.VERSION=h,e.VideoResolution=n,e.VideoSize=s,e.VideoTranscodingStatus=r,e.backupCache=async(e="amitySdk",t=(e=>e.offline))=>{const{log:n,cache:r,userId:s}=ve();if(!r)return!1;n("cache/api/backupCache",{storageKey:e});const i=Object.fromEntries(Object.entries(r.data).filter((([e,n])=>t(n))));return!!Object.keys(i).length&&(localStorage&&await localStorage.setItem(`${e}#${s}`,JSON.stringify(i)),!0)},e.createQuery=ie,e.createReport=async(e,t)=>{const n=ve();return n.log("report/createReport",{referenceType:e,referenceId:t}),"user"===e?(async({client:e,referenceId:t})=>{const{data:n}=await e.http.post(`/api/v4/me/flags/${encodeURIComponent(t)}`);if(e.cache){const e=await Fc(n);Uo(e)}return Je("user.flagged",n),!!n})({client:n,referenceId:t}):"message"===e?(async({client:e,referenceId:t})=>{const{data:n}=await e.http.post(`/api/v5/messages/${encodeURIComponent(t)}/flags`);if(e.cache){const e=await xl(n);Uo(e)}return Je("message.flagged",n),!!n})({client:n,referenceId:t}):"post"===e?(async({client:e,referenceId:t})=>{const{data:n}=await e.http.post(`/api/v3/posts/${encodeURIComponent(t)}/flag`);if(e.cache){const e=await $h(n);Uo(e)}return Je("post.flagged",n),!!n})({client:n,referenceId:t}):"comment"===e&&(async({client:e,referenceId:t})=>{const{data:n}=await e.http.post(`/api/v3/comments/${encodeURIComponent(t)}/flag`);if(e.cache){const e=await mf(n);Uo(e)}return Je("comment.flagged",n),!!n})({client:n,referenceId:t})},e.createUserToken=async(e,t,n)=>{const r=await Do(),s=xo(),i=mr(Rt("http",t)),{data:a}=await i.post("/api/v5/sessions",Object.assign(Object.assign({},n),{deviceId:r,deviceInfo:Object.assign(Object.assign({},s),{model:"token management API on TS-SDK"})}),{headers:{"X-API-Key":e}});return{accessToken:a.accessToken}},e.deleteReport=async(e,t)=>{const n=ve();return n.log("report/deleteReport",{referenceType:e,referenceId:t}),"user"===e?(async({client:e,referenceId:t})=>{const{data:n}=await e.http.delete(`/api/v4/me/flags/${encodeURIComponent(t)}`);if(e.cache){const e=await Fc(n);Uo(e)}return Je("user.unflagged",n),!!n})({client:n,referenceId:t}):"message"===e?(async({client:e,referenceId:t})=>{const{data:n}=await e.http.delete(`/api/v5/messages/${encodeURIComponent(t)}/flags`);if(e.cache){const e=await xl(n);Uo(e)}return Je("message.unflagged",n),!!n})({client:n,referenceId:t}):"post"===e?(async({client:e,referenceId:t})=>{const{data:n}=await e.http.delete(`/api/v3/posts/${encodeURIComponent(t)}/unflag`);if(e.cache){const e=await $h(n);Uo(e)}return Je("post.unflagged",n),!!n})({client:n,referenceId:t}):"comment"===e&&(async({client:e,referenceId:t})=>{const{data:n}=await e.http.delete(`/api/v3/comments/${encodeURIComponent(t)}/unflag`);if(e.cache){const e=await mf(n);Uo(e)}return Je("comment.unflagged",n),!!n})({client:n,referenceId:t})},e.disableCache=()=>{const e=ve();e.cache&&(e.log("cache/api/disableCache"),delete e.cache)},e.dropFromCache=Ie,e.enableCache=(e={},t)=>{const n=ve();n.cache||(n.log("cache/api/enableCache"),n.cache={data:e,persistIf:t})},e.filterByChannelMembership=Re,e.filterByCommunityMembership=Le,e.filterByFeedType=Oe,e.filterByPostDataTypes=De,e.filterByPropEquality=ke,e.filterByPropInclusion=(e,t,n)=>void 0!==n?e.filter((e=>n.includes(e[t]))):e,e.filterByPropIntersection=_e,e.filterBySearchTerm=xe,e.filterByStringComparePartially=Ae,e.getChannelTopic=e=>`${e.path}/#`,e.getCommentTopic=({path:e})=>e,e.getCommunityStoriesTopic=({targetId:e,targetType:t})=>{const n=Ke();return`${st(n)}/social/${t}/${e}/story/#`},e.getCommunityTopic=({path:t},n=e.SubscriptionLevels.COMMUNITY)=>rt(t,n),e.getLiveStreamTopic=ft,e.getMarkedMessageTopic=at,e.getMarkerUserFeedTopic=ot,e.getMessageTopic=e=>e.path,e.getMyFollowersTopic=()=>{const e=Ke();return`${st(e)}/membership/${e._id}/+/+`},e.getMyFollowingsTopic=()=>{const e=Ke();return`${st(e)}/membership/+/${e._id}/+`},e.getNetworkTopic=lt,e.getPostTopic=({path:t},n=e.SubscriptionLevels.POST)=>"comment"===n?`${t}/comment/+`:t,e.getRole=Ch,e.getSmartFeedChannelTopic=ct,e.getSmartFeedMessageTopic=ut,e.getSmartFeedSubChannelTopic=dt,e.getStoryTopic=({targetId:e,targetType:t,storyId:n})=>{const r=Ke();return`${st(r)}/social/${t}/${e}/story/${n}/#`},e.getSubChannelTopic=e=>`${e.path}/#`,e.getUserTopic=it,e.isAfterBefore=Y,e.isAfterBeforeRaw=Q,e.isCachable=re,e.isFetcher=ee,e.isFresh=se,e.isLocal=e=>re(e)&&-1===(null==e?void 0:e.cachedAt),e.isMutator=te,e.isOffline=ne,e.isPaged=X,e.isReportedByMe=async(e,t)=>{const n=ve();return n.log("report/isReportedByMe",{referenceType:e,referenceId:t}),"user"===e?(async({client:e,referenceId:t})=>{var n;const{data:r}=await e.http.get(`/api/v3/users/${t}/isflagbyme`),{result:s,isFlagByMe:i}=null!=r?r:{};return null!==(n=null!=s?s:i)&&void 0!==n&&n})({client:n,referenceId:t}):"message"===e?(async({client:e,referenceId:t})=>{var n;const{data:r}=await e.http.get(`/api/v5/messages/${encodeURIComponent(t)}/flags`),{result:s,isFlagByMe:i}=null!=r?r:{};return null!==(n=null!=s?s:i)&&void 0!==n&&n})({client:n,referenceId:t}):"post"===e?(async({client:e,referenceId:t})=>{var n;const{data:r}=await e.http.get(`/api/v3/posts/${t}/isflagbyme`),{result:s,isFlagByMe:i}=null!=r?r:{};return null!==(n=null!=s?s:i)&&void 0!==n&&n})({client:n,referenceId:t}):"comment"===e&&(async({client:e,referenceId:t})=>{var n;const{data:r}=await e.http.get(`/api/v3/comments/${t}/isflagbyme`),{result:s,isFlagByMe:i}=null!=r?r:{};return null!==(n=null!=s?s:i)&&void 0!==n&&n})({client:n,referenceId:t})},e.isSkip=W,e.mergeInCache=Te,e.notificationTray=RT,e.onChannelMarkerFetched=ru,e.onFeedMarkerFetched=e=>{const t=ve();return Xe(t,"feedMarker/onFeedMarkerFetched","local.feedMarker.fetched",(t=>{e(t.feedMarkers[0])}))},e.onFeedMarkerUpdated=kd,e.onMessageMarked=lu,e.onMessageMarkerFetched=ou,e.onSubChannelMarkerFetched=su,e.onSubChannelMarkerUpdated=iu,e.onUserMarkerFetched=au,e.onUserMarkerFetchedLegacy=e=>{const t=ve();return Xe(t,"userMarker/onUserMarkerFetched","local.userMarker.fetched",(t=>{e(t.userMarkers[0])}))},e.pullFromCache=Se,e.pushToCache=Ce,e.queryCache=we,e.queryOptions=ae,e.queryRoles=Sh,e.restoreCache=async(e="amitySdk")=>{var t;const n=ve();if(!n.cache)return!1;n.log("cache/api/restoreCache",{storageKey:e});const r=localStorage&&null!==(t=await localStorage.getItem(`${e}#${n.userId}`))&&void 0!==t?t:"{}";let s={};try{s=JSON.parse(r)}catch(e){}return n.cache.data=Object.assign(Object.assign({},s),n.cache.data),!0},e.runQuery=oe,e.sortByChannelSegment=({channelSegment:e},{channelSegment:t})=>e-t,e.sortByDisplayName=Pe,e.sortByFirstCreated=Fe,e.sortByFirstUpdated=Be,e.sortByLastActivity=$e,e.sortByLastCreated=Ne,e.sortByLastUpdated=je,e.sortByLocalSortingDate=Ue,e.sortByName=Me,e.sortBySegmentNumber=({segmentNumber:e},{segmentNumber:t})=>e-t,e.subscribeTopic=ht,e.toPage=Z,e.toPageRaw=e=>{if(!e)return;const t=JSON.parse(z(e));return Q(t)?t:void 0},e.toToken=J,e.upsertInCache=Ee,e.wipeCache=async(e="amitySdk")=>{const{log:t,cache:n,userId:r}=ve();return!!n&&(t("cache/api/wipeCache",{storageKey:e}),n.data={},localStorage&&await localStorage.setItem(`${e}#${r}`,"{}"),!0)},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
